/*! For license information please see 5276.9dbdb99b.js.LICENSE.txt */
(self.webpackChunkblog=self.webpackChunkblog||[]).push([[5276],{4945:(e,t,n)=>{"use strict";function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}n.r(t),n.d(t,{AbrController:()=>Dn,AttrList:()=>_,AudioStreamController:()=>bi,AudioTrackController:()=>_i,BasePlaylistController:()=>yn,BaseSegment:()=>F,BaseStreamController:()=>gr,BufferController:()=>ki,CMCDController:()=>ua,CapLevelController:()=>Ds,ChunkMetadata:()=>Hn,ContentSteeringController:()=>da,DateRange:()=>R,EMEController:()=>ks,ErrorActionFlags:()=>gn,ErrorController:()=>vn,ErrorDetails:()=>x,ErrorTypes:()=>E,Events:()=>y,FPSController:()=>Ps,Fragment:()=>O,Hls:()=>La,HlsSkip:()=>Vt,HlsUrlParameters:()=>Wt,KeySystemFormats:()=>Y,KeySystems:()=>q,Level:()=>Jt,LevelDetails:()=>Q,LevelKey:()=>Ke,LoadStats:()=>D,MetadataSchema:()=>Ut,NetworkErrorAction:()=>pn,Part:()=>U,PlaylistLevelType:()=>_t,SubtitleStreamController:()=>Mi,SubtitleTrackController:()=>Di,TimelineController:()=>_s,default:()=>La,getMediaSource:()=>tt,isMSESupported:()=>Ma,isSupported:()=>Ra});var i,s,a,o,l,c={exports:{}};i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,a=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,c.exports=l={buildAbsoluteURL:function(e,t,n){if(n=n||{},e=e.trim(),!(t=t.trim())){if(!n.alwaysNormalize)return e;var r=l.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");return r.path=l.normalizePath(r.path),l.buildURLFromParts(r)}var i=l.parseURL(t);if(!i)throw new Error("Error trying to parse relative URL.");if(i.scheme)return n.alwaysNormalize?(i.path=l.normalizePath(i.path),l.buildURLFromParts(i)):t;var a=l.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var o=s.exec(a.path);a.netLoc=o[1],a.path=o[2]}a.netLoc&&!a.path&&(a.path="/");var c={scheme:a.scheme,netLoc:i.netLoc,path:null,params:i.params,query:i.query,fragment:i.fragment};if(!i.netLoc&&(c.netLoc=a.netLoc,"/"!==i.path[0]))if(i.path){var h=a.path,u=h.substring(0,h.lastIndexOf("/")+1)+i.path;c.path=l.normalizePath(u)}else c.path=a.path,i.params||(c.params=a.params,i.query||(c.query=a.query));return null===c.path&&(c.path=n.alwaysNormalize?l.normalizePath(i.path):i.path),l.buildURLFromParts(c)},parseURL:function(e){var t=i.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(a,"");e.length!==(e=e.replace(o,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}};var h=c.exports;function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){A(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function f(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function A(e,t,n){return(t=f(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(){return m=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},m.apply(this,arguments)}const p=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},g=Number.isSafeInteger||function(e){return"number"==typeof e&&Math.abs(e)<=v},v=Number.MAX_SAFE_INTEGER||9007199254740991;let y=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",e}({}),E=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),x=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.UNKNOWN="unknown",e}({});const C=function(){},w={trace:C,debug:C,log:C,warn:C,info:C,error:C};let I=w;function b(e,...t){t.forEach((function(t){I[t]=e[t]?e[t].bind(e):function(e){const t=self.console[e];return t?t.bind(self.console,`[${e}] >`):C}(t)}))}const S=I,B=/^(\d+)x(\d+)$/,T=/(.+?)=(".*?"|.*?)(?:,|$)/g;class _{constructor(e){"string"==typeof e&&(e=_.parseAttrList(e)),m(this,e)}get clientAttrs(){return Object.keys(this).filter((e=>"X-"===e.substring(0,2)))}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const n=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)n[e]=parseInt(t.slice(2*e,2*e+2),16);return n}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const n=this[e];return n?parseFloat(n):t}enumeratedString(e){return this[e]}bool(e){return"YES"===this[e]}decimalResolution(e){const t=B.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const n={};for(T.lastIndex=0;null!==(t=T.exec(e));){let e=t[2];0===e.indexOf('"')&&e.lastIndexOf('"')===e.length-1&&(e=e.slice(1,-1));n[t[1].trim()]=e}return n}}function M(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e}class R{constructor(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){const n=t.attr;for(const t in n)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==n[t]){S.warn(`DATERANGE tag attribute: "${t}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=t;break}e=m(new _({}),n,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const e=new Date(this.attr["END-DATE"]);p(e.getTime())&&(this._endDate=e)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const e=this.duration;return null!==e?new Date(this._startDate.getTime()+1e3*e):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(p(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&p(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class D{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var P="audio",L="video",k="audiovideo";class F{constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[P]:null,[L]:null,[k]:null},this.baseurl=e}setByteRange(e,t){const n=e.split("@",2);let r;r=1===n.length?(null==t?void 0:t.byteRangeEndOffset)||0:parseInt(n[1]),this._byteRange=[r,parseInt(n[0])+r]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=h.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class O extends F{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new D,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const e=Object.keys(this.levelkeys);if(1===e.length)return this._decryptdata=this.levelkeys[e[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!p(this.programDateTime))return null;const e=p(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;if(null!=(e=this._decryptdata)&&e.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),t=e.length;if(t>1||1===t&&this.levelkeys[e[0]].encrypted)return!0}return!1}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;null==(e=this.loader)||e.abort(),null==(t=this.keyLoader)||t.abort()}setElementaryStreamInfo(e,t,n,r,i,s=!1){const{elementaryStreams:a}=this,o=a[e];o?(o.startPTS=Math.min(o.startPTS,t),o.endPTS=Math.max(o.endPTS,n),o.startDTS=Math.min(o.startDTS,r),o.endDTS=Math.max(o.endDTS,i)):a[e]={startPTS:t,endPTS:n,startDTS:r,endDTS:i,partial:s}}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[P]=null,e[L]=null,e[k]=null}}class U extends F{constructor(e,t,n,r,i){super(n),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new D,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=r;const s=e.enumeratedString("BYTERANGE");s&&this.setByteRange(s,i),i&&(this.fragOffset=i.fragOffset+i.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}class Q{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);const t=this.lastPartSn-e.lastPartSn,n=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!n||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||0===t&&n>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&p(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const e=this.driftEndTime-this.driftStartTime;if(e>0){return 1e3*(this.driftEnd-this.driftStart)/e}return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function N(e){return Uint8Array.from(atob(e),(e=>e.charCodeAt(0)))}function z(e){const t=e.split(":");let n=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),r=e[e.length-1].split(",");if(2===r.length){const t="base64"===r[0],i=r[1];t?(e.splice(-1,1),n=N(i)):n=function(e){const t=G(e).subarray(0,16),n=new Uint8Array(16);return n.set(t,16-t.length),n}(i)}}return n}function G(e){return Uint8Array.from(unescape(encodeURIComponent(e)),(e=>e.charCodeAt(0)))}const H="undefined"!=typeof self?self:void 0;var q={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Y={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function j(e){switch(e){case Y.FAIRPLAY:return q.FAIRPLAY;case Y.PLAYREADY:return q.PLAYREADY;case Y.WIDEVINE:return q.WIDEVINE;case Y.CLEARKEY:return q.CLEARKEY}}var V="1077efecc0b24d02ace33c1e52e2fb4b",K="e2719d58a985b3c9781ab030af78d30e",W="9a04f07998404286ab92e65be0885f95",J="edef8ba979d64acea3c827dcd51d21ed";function X(e){return e===J?q.WIDEVINE:e===W?q.PLAYREADY:e===V||e===K?q.CLEARKEY:void 0}function $(e){switch(e){case q.FAIRPLAY:return Y.FAIRPLAY;case q.PLAYREADY:return Y.PLAYREADY;case q.WIDEVINE:return Y.WIDEVINE;case q.CLEARKEY:return Y.CLEARKEY}}function Z(e){const{drmSystems:t,widevineLicenseUrl:n}=e,r=t?[q.FAIRPLAY,q.WIDEVINE,q.PLAYREADY,q.CLEARKEY].filter((e=>!!t[e])):[];return!r[q.WIDEVINE]&&n&&r.push(q.WIDEVINE),r}const ee=null!=H&&null!=(te=H.navigator)&&te.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;var te;function ne(e){const t=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),n=String.fromCharCode.apply(null,Array.from(t)),r=n.substring(n.indexOf("<"),n.length),i=(new DOMParser).parseFromString(r,"text/xml").getElementsByTagName("KID")[0];if(i){const e=i.childNodes[0]?i.childNodes[0].nodeValue:i.getAttribute("VALUE");if(e){const t=N(e).subarray(0,16);return function(e){const t=function(e,t,n){const r=e[t];e[t]=e[n],e[n]=r};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}(t),t}}return null}function re(e,t,n){return Uint8Array.prototype.slice?e.slice(t,n):new Uint8Array(Array.prototype.slice.call(e,t,n))}const ie=(e,t)=>t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,se=(e,t)=>t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,ae=(e,t)=>{const n=t;let r=0;for(;ie(e,t);){r+=10;r+=oe(e,t+6),se(e,t+10)&&(r+=10),t+=r}if(r>0)return e.subarray(n,n+r)},oe=(e,t)=>{let n=0;return n=(127&e[t])<<21,n|=(127&e[t+1])<<14,n|=(127&e[t+2])<<7,n|=127&e[t+3],n},le=(e,t)=>ie(e,t)&&oe(e,t+6)+10<=e.length-t,ce=e=>{const t=de(e);for(let n=0;n<t.length;n++){const e=t[n];if(he(e))return ge(e)}},he=e=>e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info,ue=e=>{const t=String.fromCharCode(e[0],e[1],e[2],e[3]),n=oe(e,4);return{type:t,size:n,data:e.subarray(10,10+n)}},de=e=>{let t=0;const n=[];for(;ie(e,t);){const r=oe(e,t+6);t+=10;const i=t+r;for(;t+8<i;){const r=ue(e.subarray(t)),i=fe(r);i&&n.push(i),t+=r.size+10}se(e,t)&&(t+=10)}return n},fe=e=>"PRIV"===e.type?Ae(e):"W"===e.type[0]?pe(e):me(e),Ae=e=>{if(e.size<2)return;const t=ve(e.data,!0),n=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:n.buffer}},me=e=>{if(e.size<2)return;if("TXXX"===e.type){let t=1;const n=ve(e.data.subarray(t),!0);t+=n.length+1;const r=ve(e.data.subarray(t));return{key:e.type,info:n,data:r}}const t=ve(e.data.subarray(1));return{key:e.type,data:t}},pe=e=>{if("WXXX"===e.type){if(e.size<2)return;let t=1;const n=ve(e.data.subarray(t),!0);t+=n.length+1;const r=ve(e.data.subarray(t));return{key:e.type,info:n,data:r}}const t=ve(e.data);return{key:e.type,data:t}},ge=e=>{if(8===e.data.byteLength){const t=new Uint8Array(e.data),n=1&t[3];let r=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return r/=45,n&&(r+=47721858.84),Math.round(r)}},ve=(e,t=!1)=>{const n=Ee();if(n){const r=n.decode(e);if(t){const e=r.indexOf("\0");return-1!==e?r.substring(0,e):r}return r.replace(/\0/g,"")}const r=e.length;let i,s,a,o="",l=0;for(;l<r;){if(i=e[l++],0===i&&t)return o;if(0!==i&&3!==i)switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(i);break;case 12:case 13:s=e[l++],o+=String.fromCharCode((31&i)<<6|63&s);break;case 14:s=e[l++],a=e[l++],o+=String.fromCharCode((15&i)<<12|(63&s)<<6|63&a)}}return o};let ye;function Ee(){if(!navigator.userAgent.includes("PlayStation 4"))return ye||void 0===self.TextDecoder||(ye=new self.TextDecoder("utf-8")),ye}const xe=function(e){let t="";for(let n=0;n<e.length;n++){let r=e[n].toString(16);r.length<2&&(r="0"+r),t+=r}return t},Ce=Math.pow(2,32)-1,we=[].push,Ie={video:1,audio:2,id3:3,text:4};function be(e){return String.fromCharCode.apply(null,e)}function Se(e,t){const n=e[t]<<8|e[t+1];return n<0?65536+n:n}function Be(e,t){const n=_e(e,t);return n<0?4294967296+n:n}function Te(e,t){let n=Be(e,t);return n*=Math.pow(2,32),n+=Be(e,t+4),n}function _e(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function Me(e,t,n){e[t]=n>>24,e[t+1]=n>>16&255,e[t+2]=n>>8&255,e[t+3]=255&n}function Re(e,t){const n=[];if(!t.length)return n;const r=e.byteLength;for(let i=0;i<r;){const s=Be(e,i),a=s>1?i+s:r;if(be(e.subarray(i+4,i+8))===t[0])if(1===t.length)n.push(e.subarray(i+8,a));else{const r=Re(e.subarray(i+8,a),t.slice(1));r.length&&we.apply(n,r)}i=a}return n}function De(e){const t=[],n=e[0];let r=8;const i=Be(e,r);r+=4;let s=0,a=0;0===n?(s=Be(e,r),a=Be(e,r+4),r+=8):(s=Te(e,r),a=Te(e,r+8),r+=16),r+=2;let o=e.length+a;const l=Se(e,r);r+=2;for(let c=0;c<l;c++){let n=r;const s=Be(e,n);n+=4;const a=2147483647&s;if(1===(2147483648&s)>>>31)return S.warn("SIDX has hierarchical references (not supported)"),null;const l=Be(e,n);n+=4,t.push({referenceSize:a,subsegmentDuration:l,info:{duration:l/i,start:o,end:o+a-1}}),o+=a,n+=4,r=n}return{earliestPresentationTime:s,timescale:i,version:n,referencesCount:l,references:t}}function Pe(e){const t=[],n=Re(e,["moov","trak"]);for(let r=0;r<n.length;r++){const e=n[r],i=Re(e,["tkhd"])[0];if(i){let n=i[0];const r=Be(i,0===n?12:20),s=Re(e,["mdia","mdhd"])[0];if(s){n=s[0];const i=Be(s,0===n?12:20),a=Re(e,["mdia","hdlr"])[0];if(a){const n=be(a.subarray(8,12)),s={soun:P,vide:L}[n];if(s){const n=Le(Re(e,["mdia","minf","stbl","stsd"])[0]);t[r]={timescale:i,type:s},t[s]=d({timescale:i,id:r},n)}}}}}return Re(e,["moov","mvex","trex"]).forEach((e=>{const n=Be(e,4),r=t[n];r&&(r.default={duration:Be(e,12),flags:Be(e,20)})})),t}function Le(e){const t=e.subarray(8),n=t.subarray(86),r=be(t.subarray(4,8));let i=r;const s="enca"===r||"encv"===r;if(s){const e=Re(t,[r])[0];Re(e.subarray("enca"===r?28:78),["sinf"]).forEach((e=>{const t=Re(e,["schm"])[0];if(t){const n=be(t.subarray(4,8));if("cbcs"===n||"cenc"===n){const t=Re(e,["frma"])[0];t&&(i=be(t))}}}))}switch(i){case"avc1":case"avc2":case"avc3":case"avc4":{const e=Re(n,["avcC"])[0];i+="."+Fe(e[1])+Fe(e[2])+Fe(e[3]);break}case"mp4a":{const e=Re(t,[r])[0],n=Re(e.subarray(28),["esds"])[0];if(n&&n.length>12){let e=4;if(3!==n[e++])break;e=ke(n,e),e+=2;const t=n[e++];if(128&t&&(e+=2),64&t&&(e+=n[e++]),4!==n[e++])break;e=ke(n,e);const r=n[e++];if(64!==r)break;if(i+="."+Fe(r),e+=12,5!==n[e++])break;e=ke(n,e);const s=n[e++];let a=(248&s)>>3;31===a&&(a+=1+((7&s)<<3)+((224&n[e])>>5)),i+="."+a}break}case"hvc1":case"hev1":{const e=Re(n,["hvcC"])[0],t=e[1],r=["","A","B","C"][t>>6],s=31&t,a=Be(e,2),o=(32&t)>>5?"H":"L",l=e[12],c=e.subarray(6,12);i+="."+r+s,i+="."+a.toString(16).toUpperCase(),i+="."+o+l;let h="";for(let n=c.length;n--;){const e=c[n];if(e||h){h="."+e.toString(16).toUpperCase()+h}}i+=h;break}case"dvh1":case"dvhe":{const e=Re(n,["dvcC"])[0],t=e[2]>>1&127,r=e[2]<<5&32|e[3]>>3&31;i+="."+Oe(t)+"."+Oe(r);break}case"vp09":{const e=Re(n,["vpcC"])[0],t=e[4],r=e[5],s=e[6]>>4&15;i+="."+Oe(t)+"."+Oe(r)+"."+Oe(s);break}case"av01":{const e=Re(n,["av1C"])[0],t=e[1]>>>5,r=31&e[1],s=e[2]>>>7?"H":"M",a=(64&e[2])>>6,o=(32&e[2])>>5,l=2===t&&a?o?12:10:a?10:8,c=(16&e[2])>>4,h=(8&e[2])>>3,u=(4&e[2])>>2,d=3&e[2],f=1,A=1,m=1,p=0;i+="."+t+"."+Oe(r)+s+"."+Oe(l)+"."+c+"."+h+u+d+"."+Oe(f)+"."+Oe(A)+"."+Oe(m)+"."+p;break}}return{codec:i,encrypted:s}}function ke(e,t){const n=t+5;for(;128&e[t++]&&t<n;);return t}function Fe(e){return("0"+e.toString(16).toUpperCase()).slice(-2)}function Oe(e){return(e<10?"0":"")+e}function Ue(e){const t=Re(e,["schm"])[0];if(t){const n=be(t.subarray(4,8));if("cbcs"===n||"cenc"===n)return Re(e,["schi","tenc"])[0]}return null}function Qe(e){const t=Be(e,0);let n=8;1&t&&(n+=4),4&t&&(n+=4);let r=0;const i=Be(e,4);for(let s=0;s<i;s++){if(256&t){r+=Be(e,n),n+=4}512&t&&(n+=4),1024&t&&(n+=4),2048&t&&(n+=4)}return r}function Ne(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function ze(e,t){const n=[],r=t.samples,i=t.timescale,s=t.id;let a=!1;return Re(r,["moof"]).map((o=>{const l=o.byteOffset-8;Re(o,["traf"]).map((o=>{const c=Re(o,["tfdt"]).map((e=>{const t=e[0];let n=Be(e,4);return 1===t&&(n*=Math.pow(2,32),n+=Be(e,8)),n/i}))[0];return void 0!==c&&(e=c),Re(o,["tfhd"]).map((c=>{const h=Be(c,4),u=16777215&Be(c,0);let d=0;const f=!!(16&u);let A=0;const m=!!(32&u);let p=8;h===s&&(!!(1&u)&&(p+=8),!!(2&u)&&(p+=4),!!(8&u)&&(d=Be(c,p),p+=4),f&&(A=Be(c,p),p+=4),m&&(p+=4),"video"===t.type&&(a=function(e){if(!e)return!1;const t=e.indexOf("."),n=t<0?e:e.substring(0,t);return"hvc1"===n||"hev1"===n||"dvh1"===n||"dvhe"===n}(t.codec)),Re(o,["trun"]).map((s=>{const o=s[0],c=16777215&Be(s,0),h=!!(1&c);let u=0;const f=!!(4&c),m=!!(256&c);let p=0;const g=!!(512&c);let v=0;const y=!!(1024&c),E=!!(2048&c);let x=0;const C=Be(s,4);let w=8;h&&(u=Be(s,w),w+=4),f&&(w+=4);let I=u+l;for(let l=0;l<C;l++){if(m?(p=Be(s,w),w+=4):p=d,g?(v=Be(s,w),w+=4):v=A,y&&(w+=4),E&&(x=0===o?Be(s,w):_e(s,w),w+=4),t.type===L){let t=0;for(;t<v;){const s=Be(r,I);if(I+=4,Ge(a,r[I])){He(r.subarray(I,I+s),a?2:1,e+x/i,n)}I+=s,t+=s+4}}e+=p/i}})))}))}))})),n}function Ge(e,t){if(e){const e=t>>1&63;return 39===e||40===e}return 6===(31&t)}function He(e,t,n,r){const i=qe(e);let s=0;s+=t;let a=0,o=0,l=0;for(;s<i.length;){a=0;do{if(s>=i.length)break;l=i[s++],a+=l}while(255===l);o=0;do{if(s>=i.length)break;l=i[s++],o+=l}while(255===l);const e=i.length-s;let t=s;if(o<e)s+=o;else if(o>e){S.error(`Malformed SEI payload. ${o} is too small, only ${e} bytes left to parse.`);break}if(4===a){if(181===i[t++]){const e=Se(i,t);if(t+=2,49===e){const e=Be(i,t);if(t+=4,1195456820===e){const e=i[t++];if(3===e){const s=i[t++],o=64&s,l=o?2+3*(31&s):0,c=new Uint8Array(l);if(o){c[0]=s;for(let e=1;e<l;e++)c[e]=i[t++]}r.push({type:e,payloadType:a,pts:n,bytes:c})}}}}}else if(5===a&&o>16){const e=[];for(let n=0;n<16;n++){const r=i[t++].toString(16);e.push(1==r.length?"0"+r:r),3!==n&&5!==n&&7!==n&&9!==n||e.push("-")}const s=o-16,l=new Uint8Array(s);for(let n=0;n<s;n++)l[n]=i[t++];r.push({payloadType:a,pts:n,uuid:e.join(""),userData:ve(l),userDataBytes:l})}}}function qe(e){const t=e.byteLength,n=[];let r=1;for(;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(n.push(r+2),r+=2):r++;if(0===n.length)return e;const i=t-n.length,s=new Uint8Array(i);let a=0;for(r=0;r<i;a++,r++)a===n[0]&&(a++,n.shift()),s[r]=e[a];return s}function Ye(e,t,n){if(16!==e.byteLength)throw new RangeError("Invalid system id");let r,i,s;if(t){r=1,i=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){const n=t[e];if(16!==n.byteLength)throw new RangeError("Invalid key");i.set(n,16*e)}}else r=0,i=new Uint8Array;r>0?(s=new Uint8Array(4),t.length>0&&new DataView(s.buffer).setUint32(0,t.length,!1)):s=new Uint8Array;const a=new Uint8Array(4);return n&&n.byteLength>0&&new DataView(a.buffer).setUint32(0,n.byteLength,!1),function(e,...t){const n=t.length;let r=8,i=n;for(;i--;)r+=t[i].byteLength;const s=new Uint8Array(r);for(s[0]=r>>24&255,s[1]=r>>16&255,s[2]=r>>8&255,s[3]=255&r,s.set(e,4),i=0,r=8;i<n;i++)s.set(t[i],r),r+=t[i].byteLength;return s}([112,115,115,104],new Uint8Array([r,0,0,0]),e,s,i,a,n||new Uint8Array)}function je(e){const t=e.getUint32(0),n=e.byteOffset,r=e.byteLength;if(r<t)return{offset:n,size:r};if(1886614376!==e.getUint32(4))return{offset:n,size:t};const i=e.getUint32(8)>>>24;if(0!==i&&1!==i)return{offset:n,size:t};const s=e.buffer,a=xe(new Uint8Array(s,n+12,16)),o=e.getUint32(28);let l=null,c=null;if(0===i){if(t-32<o||o<22)return{offset:n,size:t};c=new Uint8Array(s,n+32,o)}else if(1===i){if(!o||r<n+32+16*o+16)return{offset:n,size:t};l=[];for(let e=0;e<o;e++)l.push(new Uint8Array(s,n+32+16*e,16))}return{version:i,systemId:a,kids:l,data:c,offset:n,size:t}}let Ve={};class Ke{static clearKeyUriToKeyIdMap(){Ve={}}constructor(e,t,n,r=[1],i=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=n,this.keyFormatVersions=r,this.iv=i,this.encrypted=!!e&&"NONE"!==e,this.isCommonEncryption=this.encrypted&&"AES-128"!==e}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case Y.FAIRPLAY:case Y.WIDEVINE:case Y.PLAYREADY:case Y.CLEARKEY:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof e&&("AES-128"!==this.method||this.iv||S.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const t=function(e){const t=new Uint8Array(16);for(let n=12;n<16;n++)t[n]=e>>8*(15-n)&255;return t}(e);return new Ke(this.method,this.uri,"identity",this.keyFormatVersions,t)}const t=z(this.uri);if(t)switch(this.keyFormat){case Y.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case Y.PLAYREADY:{const e=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Ye(e,null,t),this.keyId=ne(t);break}default:{let e=t.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=Ve[this.uri];if(!e){const t=Object.keys(Ve).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16);new DataView(e.buffer,12,4).setUint32(0,t),Ve[this.uri]=e}this.keyId=e}return this}}const We=/\{\$([a-zA-Z0-9-_]+)\}/g;function Je(e){return We.test(e)}function Xe(e,t,n){if(null!==e.variableList||e.hasVariableRefs)for(let r=n.length;r--;){const i=n[r],s=t[i];s&&(t[i]=$e(e,s))}}function $e(e,t){if(null!==e.variableList||e.hasVariableRefs){const n=e.variableList;return t.replace(We,(t=>{const r=t.substring(2,t.length-1),i=null==n?void 0:n[r];return void 0===i?(e.playlistParsingError||(e.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${r}"`)),t):i}))}return t}function Ze(e,t,n){let r,i,s=e.variableList;if(s||(e.variableList=s={}),"QUERYPARAM"in t){r=t.QUERYPARAM;try{const e=new self.URL(n).searchParams;if(!e.has(r))throw new Error(`"${r}" does not match any query parameter in URI: "${n}"`);i=e.get(r)}catch(a){e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${a.message}`))}}else r=t.NAME,i=t.VALUE;r in s?e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${r}"`)):s[r]=i||""}function et(e,t,n){const r=t.IMPORT;if(n&&r in n){let t=e.variableList;t||(e.variableList=t={}),t[r]=n[r]}else e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${r}"`))}function tt(e=!0){if("undefined"==typeof self)return;return(e||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}const nt={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function rt(e,t,n=!0){return!e.split(",").some((e=>!it(e,t,n)))}function it(e,t,n=!0){var r;const i=tt(n);return null!=(r=null==i?void 0:i.isTypeSupported(st(e,t)))&&r}function st(e,t){return`${t}/mp4;codecs="${e}"`}function at(e){if(e){const t=e.substring(0,4);return nt.video[t]}return 2}function ot(e){return e.split(",").reduce(((e,t)=>{const n=nt.video[t];return n?(2*n+e)/(e?3:2):(nt.audio[t]+e)/(e?2:1)}),0)}const lt={};const ct=/flac|opus/i;function ht(e,t=!0){return e.replace(ct,(e=>function(e,t=!0){if(lt[e])return lt[e];const n={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[e];for(let r=0;r<n.length;r++)if(it(n[r],"audio",t))return lt[e]=n[r],n[r];return e}(e.toLowerCase(),t)))}function ut(e,t){return e&&"mp4a"!==e?e:t?t.split(",")[0]:t}const dt=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,ft=/#EXT-X-MEDIA:(.*)/g,At=/^#EXT(?:INF|-X-TARGETDURATION):/m,mt=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),pt=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class gt{static findGroup(e,t){for(let n=0;n<e.length;n++){const r=e[n];if(r.id===t)return r}}static resolve(e,t){return h.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return At.test(e)}static parseMasterPlaylist(e,t){const n={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:Je(e)},r=[];let i;for(dt.lastIndex=0;null!=(i=dt.exec(e));)if(i[1]){var s;const e=new _(i[1]);Xe(n,e,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const a=$e(n,i[2]),o={attrs:e,bitrate:e.decimalInteger("BANDWIDTH")||e.decimalInteger("AVERAGE-BANDWIDTH"),name:e.NAME,url:gt.resolve(a,t)},l=e.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),Et(e.CODECS,o),null!=(s=o.unknownCodecs)&&s.length||r.push(o),n.levels.push(o)}else if(i[3]){const e=i[3],r=i[4];switch(e){case"SESSION-DATA":{const e=new _(r);Xe(n,e,["DATA-ID","LANGUAGE","VALUE","URI"]);const t=e["DATA-ID"];t&&(null===n.sessionData&&(n.sessionData={}),n.sessionData[t]=e);break}case"SESSION-KEY":{const e=vt(r,t,n);e.encrypted&&e.isSupported()?(null===n.sessionKeys&&(n.sessionKeys=[]),n.sessionKeys.push(e)):S.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${r}"`);break}case"DEFINE":{const e=new _(r);Xe(n,e,["NAME","VALUE","QUERYPARAM"]),Ze(n,e,t)}break;case"CONTENT-STEERING":{const e=new _(r);Xe(n,e,["SERVER-URI","PATHWAY-ID"]),n.contentSteering={uri:gt.resolve(e["SERVER-URI"],t),pathwayId:e["PATHWAY-ID"]||"."};break}case"START":n.startTimeOffset=yt(r)}}const a=r.length>0&&r.length<n.levels.length;return n.levels=a?r:n.levels,0===n.levels.length&&(n.playlistParsingError=new Error("no levels found in manifest")),n}static parseMasterPlaylistMedia(e,t,n){let r;const i={},s=n.levels,a={AUDIO:s.map((e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec}))),SUBTITLES:s.map((e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec}))),"CLOSED-CAPTIONS":[]};let o=0;for(ft.lastIndex=0;null!==(r=ft.exec(e));){const e=new _(r[1]),s=e.TYPE;if(s){const r=a[s],l=i[s]||[];i[s]=l,Xe(n,e,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const c=e.LANGUAGE,h=e["ASSOC-LANGUAGE"],u=e.CHANNELS,d=e.CHARACTERISTICS,f=e["INSTREAM-ID"],A={attrs:e,bitrate:0,id:o++,groupId:e["GROUP-ID"]||"",name:e.NAME||c||"",type:s,default:e.bool("DEFAULT"),autoselect:e.bool("AUTOSELECT"),forced:e.bool("FORCED"),lang:c,url:e.URI?gt.resolve(e.URI,t):""};if(h&&(A.assocLang=h),u&&(A.channels=u),d&&(A.characteristics=d),f&&(A.instreamId=f),null!=r&&r.length){const e=gt.findGroup(r,A.groupId)||r[0];xt(A,e,"audioCodec"),xt(A,e,"textCodec")}l.push(A)}}return i}static parseLevelPlaylist(e,t,n,r,i,s){const a=new Q(t),o=a.fragments;let l,c,h,u=null,d=0,f=0,A=0,g=0,v=null,y=new O(r,t),E=-1,x=!1,C=null;for(mt.lastIndex=0,a.m3u8=e,a.hasVariableRefs=Je(e);null!==(l=mt.exec(e));){x&&(x=!1,y=new O(r,t),y.start=A,y.sn=d,y.cc=g,y.level=n,u&&(y.initSegment=u,y.rawProgramDateTime=u.rawProgramDateTime,u.rawProgramDateTime=null,C&&(y.setByteRange(C),C=null)));const e=l[1];if(e){y.duration=parseFloat(e);const t=(" "+l[2]).slice(1);y.title=t||null,y.tagList.push(t?["INF",e,t]:["INF",e])}else if(l[3]){if(p(y.duration)){y.start=A,h&&It(y,h,a),y.sn=d,y.level=n,y.cc=g,o.push(y);const e=(" "+l[3]).slice(1);y.relurl=$e(a,e),Ct(y,v),v=y,A+=y.duration,d++,f=0,x=!0}}else if(l[4]){const e=(" "+l[4]).slice(1);v?y.setByteRange(e,v):y.setByteRange(e)}else if(l[5])y.rawProgramDateTime=(" "+l[5]).slice(1),y.tagList.push(["PROGRAM-DATE-TIME",y.rawProgramDateTime]),-1===E&&(E=o.length);else{if(l=l[0].match(pt),!l){S.warn("No matches on slow regex match for level playlist!");continue}for(c=1;c<l.length&&void 0===l[c];c++);const e=(" "+l[c]).slice(1),i=(" "+l[c+1]).slice(1),A=l[c+2]?(" "+l[c+2]).slice(1):"";switch(e){case"PLAYLIST-TYPE":a.type=i.toUpperCase();break;case"MEDIA-SEQUENCE":d=a.startSN=parseInt(i);break;case"SKIP":{const e=new _(i);Xe(a,e,["RECENTLY-REMOVED-DATERANGES"]);const t=e.decimalInteger("SKIPPED-SEGMENTS");if(p(t)){a.skippedSegments=t;for(let e=t;e--;)o.unshift(null);d+=t}const n=e.enumeratedString("RECENTLY-REMOVED-DATERANGES");n&&(a.recentlyRemovedDateranges=n.split("\t"));break}case"TARGETDURATION":a.targetduration=Math.max(parseInt(i),1);break;case"VERSION":a.version=parseInt(i);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":a.live=!1;break;case"#":(i||A)&&y.tagList.push(A?[i,A]:[i]);break;case"DISCONTINUITY":g++,y.tagList.push(["DIS"]);break;case"GAP":y.gap=!0,y.tagList.push([e]);break;case"BITRATE":y.tagList.push([e,i]);break;case"DATERANGE":{const e=new _(i);Xe(a,e,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),Xe(a,e,e.clientAttrs);const t=new R(e,a.dateRanges[e.ID]);t.isValid||a.skippedSegments?a.dateRanges[t.id]=t:S.warn(`Ignoring invalid DATERANGE tag: "${i}"`),y.tagList.push(["EXT-X-DATERANGE",i]);break}case"DEFINE":{const e=new _(i);Xe(a,e,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in e?et(a,e,s):Ze(a,e,t)}break;case"DISCONTINUITY-SEQUENCE":g=parseInt(i);break;case"KEY":{const e=vt(i,t,a);if(e.isSupported()){if("NONE"===e.method){h=void 0;break}h||(h={}),h[e.keyFormat]&&(h=m({},h)),h[e.keyFormat]=e}else S.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${i}"`);break}case"START":a.startTimeOffset=yt(i);break;case"MAP":{const e=new _(i);if(Xe(a,e,["BYTERANGE","URI"]),y.duration){const i=new O(r,t);wt(i,e,n,h),u=i,y.initSegment=u,u.rawProgramDateTime&&!y.rawProgramDateTime&&(y.rawProgramDateTime=u.rawProgramDateTime)}else{const t=y.byteRangeEndOffset;if(t){const e=y.byteRangeStartOffset;C=`${t-e}@${e}`}else C=null;wt(y,e,n,h),u=y,x=!0}break}case"SERVER-CONTROL":{const e=new _(i);a.canBlockReload=e.bool("CAN-BLOCK-RELOAD"),a.canSkipUntil=e.optionalFloat("CAN-SKIP-UNTIL",0),a.canSkipDateRanges=a.canSkipUntil>0&&e.bool("CAN-SKIP-DATERANGES"),a.partHoldBack=e.optionalFloat("PART-HOLD-BACK",0),a.holdBack=e.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const e=new _(i);a.partTarget=e.decimalFloatingPoint("PART-TARGET");break}case"PART":{let e=a.partList;e||(e=a.partList=[]);const n=f>0?e[e.length-1]:void 0,r=f++,s=new _(i);Xe(a,s,["BYTERANGE","URI"]);const o=new U(s,y,t,r,n);e.push(o),y.duration+=o.duration;break}case"PRELOAD-HINT":{const e=new _(i);Xe(a,e,["URI"]),a.preloadHint=e;break}case"RENDITION-REPORT":{const e=new _(i);Xe(a,e,["URI"]),a.renditionReports=a.renditionReports||[],a.renditionReports.push(e);break}default:S.warn(`line parsed but not handled: ${l}`)}}}v&&!v.relurl?(o.pop(),A-=v.duration,a.partList&&(a.fragmentHint=v)):a.partList&&(Ct(y,v),y.cc=g,a.fragmentHint=y,h&&It(y,h,a));const w=o.length,I=o[0],b=o[w-1];if(A+=a.skippedSegments*a.targetduration,A>0&&w&&b){a.averagetargetduration=A/w;const e=b.sn;a.endSN="initSegment"!==e?e:0,a.live||(b.endList=!0),I&&(a.startCC=I.cc)}else a.endSN=0,a.startCC=0;return a.fragmentHint&&(A+=a.fragmentHint.duration),a.totalduration=A,a.endCC=g,E>0&&function(e,t){let n=e[t];for(let r=t;r--;){const t=e[r];if(!t)return;t.programDateTime=n.programDateTime-1e3*t.duration,n=t}}(o,E),a}}function vt(e,t,n){var r,i;const s=new _(e);Xe(n,s,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const a=null!=(r=s.METHOD)?r:"",o=s.URI,l=s.hexadecimalInteger("IV"),c=s.KEYFORMATVERSIONS,h=null!=(i=s.KEYFORMAT)?i:"identity";o&&s.IV&&!l&&S.error(`Invalid IV: ${s.IV}`);const u=o?gt.resolve(o,t):"",d=(c||"1").split("/").map(Number).filter(Number.isFinite);return new Ke(a,u,h,d,l)}function yt(e){const t=new _(e).decimalFloatingPoint("TIME-OFFSET");return p(t)?t:null}function Et(e,t){let n=(e||"").split(/[ ,]+/).filter((e=>e));["video","audio","text"].forEach((e=>{const r=n.filter((t=>function(e,t){const n=nt[t];return!!n&&!!n[e.slice(0,4)]}(t,e)));r.length&&(t[`${e}Codec`]=r.join(","),n=n.filter((e=>-1===r.indexOf(e))))})),t.unknownCodecs=n}function xt(e,t,n){const r=t[n];r&&(e[n]=r)}function Ct(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),p(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}function wt(e,t,n,r){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=n,e.sn="initSegment",r&&(e.levelkeys=r),e.initSegment=null}function It(e,t,n){e.levelkeys=t;const{encryptedFragments:r}=n;r.length&&r[r.length-1].levelkeys===t||!Object.keys(t).some((e=>t[e].isCommonEncryption))||r.push(e)}var bt="manifest",St="level",Bt="audioTrack",Tt="subtitleTrack",_t={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function Mt(e){const{type:t}=e;switch(t){case Bt:return _t.AUDIO;case Tt:return _t.SUBTITLE;default:return _t.MAIN}}function Rt(e,t){let n=e.url;return void 0!==n&&0!==n.indexOf("data:")||(n=t.url),n}class Dt{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,n=t.pLoader,r=t.loader,i=new(n||r)(t);return this.loaders[e.type]=i,i}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:n}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:bt,url:n,deliveryDirectives:null})}onLevelLoading(e,t){const{id:n,level:r,pathwayId:i,url:s,deliveryDirectives:a}=t;this.load({id:n,level:r,pathwayId:i,responseType:"text",type:St,url:s,deliveryDirectives:a})}onAudioTrackLoading(e,t){const{id:n,groupId:r,url:i,deliveryDirectives:s}=t;this.load({id:n,groupId:r,level:null,responseType:"text",type:Bt,url:i,deliveryDirectives:s})}onSubtitleTrackLoading(e,t){const{id:n,groupId:r,url:i,deliveryDirectives:s}=t;this.load({id:n,groupId:r,level:null,responseType:"text",type:Tt,url:i,deliveryDirectives:s})}load(e){var t;const n=this.hls.config;let r,i=this.getInternalLoader(e);if(i){const t=i.context;if(t&&t.url===e.url&&t.level===e.level)return void S.trace("[playlist-loader]: playlist request ongoing");S.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),i.abort()}if(r=e.type===bt?n.manifestLoadPolicy.default:m({},n.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),i=this.createInternalLoader(e),p(null==(t=e.deliveryDirectives)?void 0:t.part)){let t;if(e.type===St&&null!==e.level?t=this.hls.levels[e.level].details:e.type===Bt&&null!==e.id?t=this.hls.audioTracks[e.id].details:e.type===Tt&&null!==e.id&&(t=this.hls.subtitleTracks[e.id].details),t){const e=t.partTarget,n=t.targetduration;if(e&&n){const t=1e3*Math.max(3*e,.8*n);r=m({},r,{maxTimeToFirstByteMs:Math.min(t,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(t,r.maxTimeToFirstByteMs)})}}}const s=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:s.maxNumRetry||0,retryDelay:s.retryDelayMs||0,maxRetryDelay:s.maxRetryDelayMs||0},o={onSuccess:(e,t,n,r)=>{const i=this.getInternalLoader(n);this.resetInternalLoader(n.type);const s=e.data;0===s.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),gt.isMediaPlaylist(s)?this.handleTrackOrLevelPlaylist(e,t,n,r||null,i):this.handleMasterPlaylist(e,t,n,r)):this.handleManifestParsingError(e,n,new Error("no EXTM3U delimiter"),r||null,t)},onError:(e,t,n,r)=>{this.handleNetworkError(t,n,!1,e,r)},onTimeout:(e,t,n)=>{this.handleNetworkError(t,n,!0,void 0,e)}};i.load(e,a,o)}handleMasterPlaylist(e,t,n,r){const i=this.hls,s=e.data,a=Rt(e,n),o=gt.parseMasterPlaylist(s,a);if(o.playlistParsingError)return void this.handleManifestParsingError(e,n,o.playlistParsingError,r,t);const{contentSteering:l,levels:c,sessionData:h,sessionKeys:u,startTimeOffset:d,variableList:f}=o;this.variableList=f;const{AUDIO:A=[],SUBTITLES:m,"CLOSED-CAPTIONS":p}=gt.parseMasterPlaylistMedia(s,a,o);if(A.length){A.some((e=>!e.url))||!c[0].audioCodec||c[0].attrs.AUDIO||(S.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),A.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new _({}),bitrate:0,url:""}))}i.trigger(y.MANIFEST_LOADED,{levels:c,audioTracks:A,subtitles:m,captions:p,contentSteering:l,url:a,stats:t,networkDetails:r,sessionData:h,sessionKeys:u,startTimeOffset:d,variableList:f})}handleTrackOrLevelPlaylist(e,t,n,r,i){const s=this.hls,{id:a,level:o,type:l}=n,c=Rt(e,n),h=p(o)?o:p(a)?a:0,u=Mt(n),d=gt.parseLevelPlaylist(e.data,c,h,u,0,this.variableList);if(l===bt){const e={attrs:new _({}),bitrate:0,details:d,name:"",url:c};s.trigger(y.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:c,stats:t,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),n.levelDetails=d,this.handlePlaylistLoaded(d,e,t,n,r,i)}handleManifestParsingError(e,t,n,r,i){this.hls.trigger(y.ERROR,{type:E.NETWORK_ERROR,details:x.MANIFEST_PARSING_ERROR,fatal:t.type===bt,url:e.url,err:n,error:n,reason:n.message,response:e,context:t,networkDetails:r,stats:i})}handleNetworkError(e,t,n=!1,r,i){let s=`A network ${n?"timeout":"error"+(r?" (status "+r.code+")":"")} occurred while loading ${e.type}`;e.type===St?s+=`: ${e.level} id: ${e.id}`:e.type!==Bt&&e.type!==Tt||(s+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(s);S.warn(`[playlist-loader]: ${s}`);let o=x.UNKNOWN,l=!1;const c=this.getInternalLoader(e);switch(e.type){case bt:o=n?x.MANIFEST_LOAD_TIMEOUT:x.MANIFEST_LOAD_ERROR,l=!0;break;case St:o=n?x.LEVEL_LOAD_TIMEOUT:x.LEVEL_LOAD_ERROR,l=!1;break;case Bt:o=n?x.AUDIO_TRACK_LOAD_TIMEOUT:x.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case Tt:o=n?x.SUBTITLE_TRACK_LOAD_TIMEOUT:x.SUBTITLE_LOAD_ERROR,l=!1}c&&this.resetInternalLoader(e.type);const h={type:E.NETWORK_ERROR,details:o,fatal:l,url:e.url,loader:c,context:e,error:a,networkDetails:t,stats:i};if(r){const n=(null==t?void 0:t.url)||e.url;h.response=d({url:n,data:void 0},r)}this.hls.trigger(y.ERROR,h)}handlePlaylistLoaded(e,t,n,r,i,s){const a=this.hls,{type:o,level:l,id:c,groupId:h,deliveryDirectives:u}=r,d=Rt(t,r),f=Mt(r),A="number"==typeof r.level&&f===_t.MAIN?l:void 0;if(!e.fragments.length){const e=new Error("No Segments found in Playlist");return void a.trigger(y.ERROR,{type:E.NETWORK_ERROR,details:x.LEVEL_EMPTY_ERROR,fatal:!1,url:d,error:e,reason:e.message,response:t,context:r,level:A,parent:f,networkDetails:i,stats:n})}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const m=e.playlistParsingError;if(m)a.trigger(y.ERROR,{type:E.NETWORK_ERROR,details:x.LEVEL_PARSING_ERROR,fatal:!1,url:d,error:m,reason:m.message,response:t,context:r,level:A,parent:f,networkDetails:i,stats:n});else switch(e.live&&s&&(s.getCacheAge&&(e.ageHeader=s.getCacheAge()||0),s.getCacheAge&&!isNaN(e.ageHeader)||(e.ageHeader=0)),o){case bt:case St:a.trigger(y.LEVEL_LOADED,{details:e,level:A||0,id:c||0,stats:n,networkDetails:i,deliveryDirectives:u});break;case Bt:a.trigger(y.AUDIO_TRACK_LOADED,{details:e,id:c||0,groupId:h||"",stats:n,networkDetails:i,deliveryDirectives:u});break;case Tt:a.trigger(y.SUBTITLE_TRACK_LOADED,{details:e,id:c||0,groupId:h||"",stats:n,networkDetails:i,deliveryDirectives:u})}}}function Pt(e,t){let n;try{n=new Event("addtrack")}catch(r){n=document.createEvent("Event"),n.initEvent("addtrack",!1,!1)}n.track=e,t.dispatchEvent(n)}function Lt(e,t){const n=e.mode;if("disabled"===n&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(r){S.debug(`[texttrack-utils]: ${r}`);try{const n=new self.TextTrackCue(t.startTime,t.endTime,t.text);n.id=t.id,e.addCue(n)}catch(i){S.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${i}`)}}"disabled"===n&&(e.mode=n)}function kt(e){const t=e.mode;if("disabled"===t&&(e.mode="hidden"),e.cues)for(let n=e.cues.length;n--;)e.removeCue(e.cues[n]);"disabled"===t&&(e.mode=t)}function Ft(e,t,n,r){const i=e.mode;if("disabled"===i&&(e.mode="hidden"),e.cues&&e.cues.length>0){const i=function(e,t,n){const r=[],i=function(e,t){if(t<e[0].startTime)return 0;const n=e.length-1;if(t>e[n].endTime)return-1;let r=0,i=n;for(;r<=i;){const s=Math.floor((i+r)/2);if(t<e[s].startTime)i=s-1;else{if(!(t>e[s].startTime&&r<n))return s;r=s+1}}return e[r].startTime-t<t-e[i].startTime?r:i}(e,t);if(i>-1)for(let s=i,a=e.length;s<a;s++){const i=e[s];if(i.startTime>=t&&i.endTime<=n)r.push(i);else if(i.startTime>n)return r}return r}(e.cues,t,n);for(let t=0;t<i.length;t++)r&&!r(i[t])||e.removeCue(i[t])}"disabled"===i&&(e.mode=i)}function Ot(e){const t=[];for(let n=0;n<e.length;n++){const r=e[n];"subtitles"!==r.kind&&"captions"!==r.kind||!r.label||t.push(e[n])}return t}var Ut={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};function Qt(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function Nt(e,t,n,r,i){let s=new e(t,n,"");try{s.value=r,i&&(s.type=i)}catch(a){s=new e(t,n,JSON.stringify(i?d({type:i},r):r))}return s}const zt=(()=>{const e=Qt();try{e&&new e(0,Number.POSITIVE_INFINITY,"")}catch(t){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function Gt(e,t){return e.getTime()/1e3-t}class Ht{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(kt(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const n=e[t];if("metadata"===n.kind&&"id3"===n.label)return Pt(n,this.media),n}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:n,enableID3MetadataCues:r}}}=this;if(!n&&!r)return;const{samples:i}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const s=Qt();if(s)for(let a=0;a<i.length;a++){const e=i[a].type;if(e===Ut.emsg&&!n||!r)continue;const t=de(i[a].data);if(t){const n=i[a].pts;let r=n+i[a].duration;r>zt&&(r=zt);r-n<=0&&(r=n+.25);for(let i=0;i<t.length;i++){const a=t[i];if(!he(a)){this.updateId3CueEnds(n,e);const t=Nt(s,n,r,a,e);t&&this.id3Track.addCue(t)}}}}}updateId3CueEnds(e,t){var n;const r=null==(n=this.id3Track)?void 0:n.cues;if(r)for(let i=r.length;i--;){const n=r[i];n.type===t&&n.startTime<e&&n.endTime===zt&&(n.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:n,type:r}){const{id3Track:i,hls:s}=this;if(!s)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:o}}=s;if(i&&(a||o)){let e;e="audio"===r?e=>e.type===Ut.audioId3&&o:"video"===r?e=>e.type===Ut.emsg&&a:e=>e.type===Ut.audioId3&&o||e.type===Ut.emsg&&a,Ft(i,t,n,e)}}onLevelUpdated(e,{details:t}){if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:n,id3Track:r}=this,{dateRanges:i}=t,s=Object.keys(i);if(r){const e=Object.keys(n).filter((e=>!s.includes(e)));for(let t=e.length;t--;){const i=e[t];Object.keys(n[i].cues).forEach((e=>{r.removeCue(n[i].cues[e])})),delete n[i]}}const a=t.fragments[t.fragments.length-1];if(0===s.length||!p(null==a?void 0:a.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=a.programDateTime/1e3-a.start,l=Qt();for(let u=0;u<s.length;u++){const e=s[u],t=i[e],r=Gt(t.startDate,o),a=n[e],d=(null==a?void 0:a.cues)||{};let f=(null==a?void 0:a.durationKnown)||!1,A=zt;const m=t.endDate;if(m)A=Gt(m,o),f=!0;else if(t.endOnNext&&!f){const e=s.reduce(((e,n)=>{if(n!==t.id){const r=i[n];if(r.class===t.class&&r.startDate>t.startDate&&(!e||t.startDate<e.startDate))return r}return e}),null);e&&(A=Gt(e.startDate,o),f=!0)}const p=Object.keys(t.attr);for(let n=0;n<p.length;n++){const i=p[n];if("ID"===(h=i)||"CLASS"===h||"START-DATE"===h||"DURATION"===h||"END-DATE"===h||"END-ON-NEXT"===h)continue;const s=d[i];if(s)f&&!a.durationKnown&&(s.endTime=A);else if(l){let n=t.attr[i];M(i)&&(c=n,n=Uint8Array.from(c.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer);const s=Nt(l,r,A,{key:i,data:n},Ut.dateRange);s&&(s.id=e,this.id3Track.addCue(s),d[i]=s)}}n[e]={cues:d,dateRange:t,durationKnown:f}}var c,h}}class qt{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(null===e)return null;const{holdBack:t,partHoldBack:n,targetduration:r}=e,{liveSyncDuration:i,liveSyncDurationCount:s,lowLatencyMode:a}=this.config,o=this.hls.userConfig;let l=a&&n||t;(o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==i?i:s*r);const c=r;return l+Math.min(1*this.stallCount,c)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,n=this.levelDetails;if(null===e||null===t||null===n)return null;const r=n.edge,i=e-t-this.edgeStalled,s=r-n.totalduration,a=r-(this.config.lowLatencyMode&&n.partTarget||n.targetduration);return Math.min(Math.max(s,i),a)}get drift(){const{levelDetails:e}=this;return null===e?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(null===e)return 0;const t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const n=e.buffered.length;return(n?e.buffered.end(n-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(y.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(y.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){var n;t.details===x.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(n=this.levelDetails)&&n.live&&S.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const n=this.computeLatency();if(null===n)return;this._latency=n;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:i}=this.config;if(!r||1===i||!t.live)return;const s=this.targetLatency;if(null===s)return;const a=n-s;if(a<Math.min(this.maxLatency,s+t.targetduration)&&a>.05&&this.forwardBufferLength>1){const t=Math.min(2,Math.max(1,i)),n=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20;e.playbackRate=Math.min(t,Math.max(1,n))}else 1!==e.playbackRate&&0!==e.playbackRate&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return null===e?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}const Yt=["NONE","TYPE-0","TYPE-1",null];const jt=["SDR","PQ","HLG"];var Vt={No:"",Yes:"YES",v2:"v2"};function Kt(e){const{canSkipUntil:t,canSkipDateRanges:n,age:r}=e;return t&&r<t/2?n?Vt.v2:Vt.Yes:Vt.No}class Wt{constructor(e,t,n){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=n}addDirectives(e){const t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Jt{constructor(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter((e=>!!e)).map((e=>e.substring(0,4))).join(","),this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return Xt(this._audioGroups,e)}hasSubtitleGroup(e){return Xt(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t)if("audio"===e){let e=this._audioGroups;e||(e=this._audioGroups=[]),-1===e.indexOf(t)&&e.push(t)}else if("text"===e){let e=this._subtitleGroups;e||(e=this._subtitleGroups=[]),-1===e.indexOf(t)&&e.push(t)}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return null==(e=this.audioGroups)?void 0:e[0]}get textGroupId(){var e;return null==(e=this.subtitleGroups)?void 0:e[0]}addFallback(){}}function Xt(e,t){return!(!t||!e)&&-1!==e.indexOf(t)}function $t(e,t){const n=t.startPTS;if(p(n)){let r,i=0;t.sn>e.sn?(i=n-e.start,r=e):(i=e.start-n,r=t),r.duration!==i&&(r.duration=i)}else if(t.sn>e.sn){e.cc===t.cc&&e.minEndPTS?t.start=e.start+(e.minEndPTS-e.start):t.start=e.start+e.duration}else t.start=Math.max(e.start-t.duration,0)}function Zt(e,t,n,r,i,s){r-n<=0&&(S.warn("Fragment should have a positive duration",t),r=n+t.duration,s=i+t.duration);let a=n,o=r;const l=t.startPTS,c=t.endPTS;if(p(l)){const e=Math.abs(l-n);p(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,a=Math.max(n,l),n=Math.min(n,l),i=Math.min(i,t.startDTS),o=Math.min(r,c),r=Math.max(r,c),s=Math.max(s,t.endDTS)}const h=n-t.start;0!==t.start&&(t.start=n),t.duration=r-t.start,t.startPTS=n,t.maxStartPTS=a,t.startDTS=i,t.endPTS=r,t.minEndPTS=o,t.endDTS=s;const u=t.sn;if(!e||u<e.startSN||u>e.endSN)return 0;let d;const f=u-e.startSN,A=e.fragments;for(A[f]=t,d=f;d>0;d--)$t(A[d],A[d-1]);for(d=f;d<A.length-1;d++)$t(A[d],A[d+1]);return e.fragmentHint&&$t(A[A.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,h}function en(e,t){let n=null;const r=e.fragments;for(let o=r.length-1;o>=0;o--){const e=r[o].initSegment;if(e){n=e;break}}let i;e.fragmentHint&&delete e.fragmentHint.endPTS,function(e,t,n){const r=t.skippedSegments,i=Math.max(e.startSN,t.startSN)-t.startSN,s=(e.fragmentHint?1:0)+(r?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,a=t.startSN-e.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let c=i;c<=s;c++){const e=l[a+c];let i=o[c];r&&!i&&c<r&&(i=t.fragments[c]=e),e&&i&&n(e,i,c,o)}}(e,t,((e,r,s,a)=>{if(t.skippedSegments&&r.cc!==e.cc){const t=e.cc-r.cc;for(let e=s;e<a.length;e++)a[e].cc+=t}p(e.startPTS)&&p(e.endPTS)&&(r.start=r.startPTS=e.startPTS,r.startDTS=e.startDTS,r.maxStartPTS=e.maxStartPTS,r.endPTS=e.endPTS,r.endDTS=e.endDTS,r.minEndPTS=e.minEndPTS,r.duration=e.endPTS-e.startPTS,r.duration&&(i=r),t.PTSKnown=t.alignedSliding=!0),r.elementaryStreams=e.elementaryStreams,r.loader=e.loader,r.stats=e.stats,e.initSegment&&(r.initSegment=e.initSegment,n=e.initSegment)}));const s=t.fragments;if(n){(t.fragmentHint?s.concat(t.fragmentHint):s).forEach((e=>{var t;!e||e.initSegment&&e.initSegment.relurl!==(null==(t=n)?void 0:t.relurl)||(e.initSegment=n)}))}if(t.skippedSegments){if(t.deltaUpdateFailed=s.some((e=>!e)),t.deltaUpdateFailed){S.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let e=t.skippedSegments;e--;)s.shift();t.startSN=s[0].sn}else t.canSkipDateRanges&&(t.dateRanges=function(e,t,n){const r=m({},e);n&&n.forEach((e=>{delete r[e]}));return Object.keys(t).forEach((e=>{const n=new R(t[e].attr,r[e]);n.isValid?r[e]=n:S.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(t[e].attr)}"`)})),r}(e.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));t.startCC=t.fragments[0].cc,t.endCC=s[s.length-1].cc}!function(e,t,n){if(e&&t){let r=0;for(let i=0,s=e.length;i<=s;i++){const s=e[i],a=t[i+r];s&&a&&s.index===a.index&&s.fragment.sn===a.fragment.sn?n(s,a):r--}}}(e.partList,t.partList,((e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats})),i?Zt(t,i,i.startPTS,i.endPTS,i.startDTS,i.endDTS):tn(e,t),s.length&&(t.totalduration=t.edge-s[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;const a=t.advancedDateTime;if(t.advanced&&a){const e=t.edge;t.driftStart||(t.driftStartTime=a,t.driftStart=e),t.driftEndTime=a,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}function tn(e,t){const n=t.startSN+t.skippedSegments-e.startSN,r=e.fragments;n<0||n>=r.length||nn(t,r[n].start)}function nn(e,t){if(t){const n=e.fragments;for(let r=e.skippedSegments;r<n.length;r++)n[r].start+=t;e.fragmentHint&&(e.fragmentHint.start+=t)}}function rn(e,t,n){var r;return null!=e&&e.details?sn(null==(r=e.details)?void 0:r.partList,t,n):null}function sn(e,t,n){if(e)for(let r=e.length;r--;){const i=e[r];if(i.index===n&&i.fragment.sn===t)return i}return null}function an(e){e.forEach(((e,t)=>{const{details:n}=e;null!=n&&n.fragments&&n.fragments.forEach((e=>{e.level=t}))}))}function on(e){switch(e.details){case x.FRAG_LOAD_TIMEOUT:case x.KEY_LOAD_TIMEOUT:case x.LEVEL_LOAD_TIMEOUT:case x.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function ln(e,t){const n=on(t);return e.default[(n?"timeout":"error")+"Retry"]}function cn(e,t){const n="linear"===e.backoff?1:Math.pow(2,t);return Math.min(n*e.retryDelayMs,e.maxRetryDelayMs)}function hn(e){return d(d({},e),{errorRetry:null,timeoutRetry:null})}function un(e,t,n,r){if(!e)return!1;const i=null==r?void 0:r.code,s=t<e.maxNumRetry&&(function(e){return 0===e&&!1===navigator.onLine||!!e&&(e<400||e>499)}(i)||!!n);return e.shouldRetry?e.shouldRetry(e,t,n,r,s):s}const dn=function(e,t){let n=0,r=e.length-1,i=null,s=null;for(;n<=r;){i=(n+r)/2|0,s=e[i];const a=t(s);if(a>0)n=i+1;else{if(!(a<0))return s;r=i-1}}return null};function fn(e,t,n=0,r=0,i=.005){let s=null;if(e){s=t[e.sn-t[0].sn+1]||null;const r=e.endDTS-n;r>0&&r<15e-7&&(n+=15e-7)}else 0===n&&0===t[0].start&&(s=t[0]);if(s&&((!e||e.level===s.level)&&0===An(n,r,s)||function(e,t,n){if(t&&0===t.start&&t.level<e.level&&(t.endPTS||0)>0){const r=t.tagList.reduce(((e,t)=>("INF"===t[0]&&(e+=parseFloat(t[1])),e)),n);return e.start<=r}return!1}(s,e,Math.min(i,r))))return s;const a=dn(t,An.bind(null,n,r));return!a||a===e&&s?s:a}function An(e=0,t=0,n){if(n.start<=e&&n.start+n.duration>e)return 0;const r=Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return n.start+n.duration-r<=e?1:n.start-r>e&&n.start?-1:0}function mn(e,t,n){const r=1e3*Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return(n.endProgramDateTime||0)-r>e}var pn={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},gn={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class vn{constructor(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=S.log.bind(S,"[info]:"),this.warn=S.warn.bind(S,"[warning]:"),this.error=S.error.bind(S,"[error]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(y.ERROR,this.onError,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(y.ERROR,this.onError,this),e.off(y.ERROR,this.onErrorOut,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(null==e?void 0:e.type)===_t.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var n,r;if(t.fatal)return;const i=this.hls,s=t.context;switch(t.details){case x.FRAG_LOAD_ERROR:case x.FRAG_LOAD_TIMEOUT:case x.KEY_LOAD_ERROR:case x.KEY_LOAD_TIMEOUT:return void(t.errorAction=this.getFragRetryOrSwitchAction(t));case x.FRAG_PARSING_ERROR:if(null!=(n=t.frag)&&n.gap)return void(t.errorAction={action:pn.DoNothing,flags:gn.None});case x.FRAG_GAP:case x.FRAG_DECRYPT_ERROR:return t.errorAction=this.getFragRetryOrSwitchAction(t),void(t.errorAction.action=pn.SendAlternateToPenaltyBox);case x.LEVEL_EMPTY_ERROR:case x.LEVEL_PARSING_ERROR:{var a,o;const e=t.parent===_t.MAIN?t.level:i.loadLevel;t.details===x.LEVEL_EMPTY_ERROR&&null!=(a=t.context)&&null!=(o=a.levelDetails)&&o.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,e):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e))}return;case x.LEVEL_LOAD_ERROR:case x.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==s?void 0:s.level)&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.level)));case x.AUDIO_TRACK_LOAD_ERROR:case x.AUDIO_TRACK_LOAD_TIMEOUT:case x.SUBTITLE_LOAD_ERROR:case x.SUBTITLE_TRACK_LOAD_TIMEOUT:if(s){const e=i.levels[i.loadLevel];if(e&&(s.type===Bt&&e.hasAudioGroup(s.groupId)||s.type===Tt&&e.hasSubtitleGroup(s.groupId)))return t.errorAction=this.getPlaylistRetryOrSwitchAction(t,i.loadLevel),t.errorAction.action=pn.SendAlternateToPenaltyBox,void(t.errorAction.flags=gn.MoveAllAlternatesMatchingHost)}return;case x.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const e=i.levels[i.loadLevel],n=null==e?void 0:e.attrs["HDCP-LEVEL"];n?t.errorAction={action:pn.SendAlternateToPenaltyBox,flags:gn.MoveAllAlternatesMatchingHDCP,hdcpLevel:n}:this.keySystemError(t)}return;case x.BUFFER_ADD_CODEC_ERROR:case x.REMUX_ALLOC_ERROR:case x.BUFFER_APPEND_ERROR:return void(t.errorAction=this.getLevelSwitchAction(t,null!=(r=t.level)?r:i.loadLevel));case x.INTERNAL_EXCEPTION:case x.BUFFER_APPENDING_ERROR:case x.BUFFER_FULL_ERROR:case x.LEVEL_SWITCH_ERROR:case x.BUFFER_STALLED_ERROR:case x.BUFFER_SEEK_OVER_HOLE:case x.BUFFER_NUDGE_ON_STALL:return void(t.errorAction={action:pn.DoNothing,flags:gn.None})}t.type===E.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const n=ln(this.hls.config.playlistLoadPolicy,e),r=this.playlistError++;if(un(n,r,on(e),e.response))return{action:pn.RetryRequest,flags:gn.None,retryConfig:n,retryCount:r};const i=this.getLevelSwitchAction(e,t);return n&&(i.retryConfig=n,i.retryCount=r),i}getFragRetryOrSwitchAction(e){const t=this.hls,n=this.getVariantLevelIndex(e.frag),r=t.levels[n],{fragLoadPolicy:i,keyLoadPolicy:s}=t.config,a=ln(e.details.startsWith("key")?s:i,e),o=t.levels.reduce(((e,t)=>e+t.fragmentError),0);if(r){e.details!==x.FRAG_GAP&&r.fragmentError++;if(un(a,o,on(e),e.response))return{action:pn.RetryRequest,flags:gn.None,retryConfig:a,retryCount:o}}const l=this.getLevelSwitchAction(e,n);return a&&(l.retryConfig=a,l.retryCount=o),l}getLevelSwitchAction(e,t){const n=this.hls;null==t&&(t=n.loadLevel);const r=this.hls.levels[t];if(r){var i,s;const t=e.details;r.loadError++,t===x.BUFFER_APPEND_ERROR&&r.fragmentError++;let l=-1;const{levels:c,loadLevel:h,minAutoLevel:u,maxAutoLevel:d}=n;n.autoLevelEnabled||(n.loadLevel=-1);const f=null==(i=e.frag)?void 0:i.type,A=(f===_t.AUDIO&&t===x.FRAG_PARSING_ERROR||"audio"===e.sourceBufferName&&(t===x.BUFFER_ADD_CODEC_ERROR||t===x.BUFFER_APPEND_ERROR))&&c.some((({audioCodec:e})=>r.audioCodec!==e)),m="video"===e.sourceBufferName&&(t===x.BUFFER_ADD_CODEC_ERROR||t===x.BUFFER_APPEND_ERROR)&&c.some((({codecSet:e,audioCodec:t})=>r.codecSet!==e&&r.audioCodec===t)),{type:p,groupId:g}=null!=(s=e.context)?s:{};for(let n=c.length;n--;){const i=(n+h)%c.length;if(i!==h&&i>=u&&i<=d&&0===c[i].loadError){var a,o;const n=c[i];if(t===x.FRAG_GAP&&f===_t.MAIN&&e.frag){const t=c[i].details;if(t){const n=fn(e.frag,t.fragments,e.frag.start);if(null!=n&&n.gap)continue}}else{if(p===Bt&&n.hasAudioGroup(g)||p===Tt&&n.hasSubtitleGroup(g))continue;if(f===_t.AUDIO&&null!=(a=r.audioGroups)&&a.some((e=>n.hasAudioGroup(e)))||f===_t.SUBTITLE&&null!=(o=r.subtitleGroups)&&o.some((e=>n.hasSubtitleGroup(e)))||A&&r.audioCodec===n.audioCodec||!A&&r.audioCodec!==n.audioCodec||m&&r.codecSet===n.codecSet)continue}l=i;break}}if(l>-1&&n.loadLevel!==l)return e.levelRetry=!0,this.playlistError=0,{action:pn.SendAlternateToPenaltyBox,flags:gn.None,nextAutoLevel:l}}return{action:pn.SendAlternateToPenaltyBox,flags:gn.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var n;switch(null==(n=t.errorAction)?void 0:n.action){case pn.DoNothing:break;case pn.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),t.errorAction.resolved||t.details===x.FRAG_GAP?/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):t.fatal=!0;case pn.RetryRequest:}t.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(e){const t=this.hls,n=e.errorAction;if(!n)return;const{flags:r,hdcpLevel:i,nextAutoLevel:s}=n;switch(r){case gn.None:this.switchLevel(e,s);break;case gn.MoveAllAlternatesMatchingHDCP:i&&(t.maxHdcpLevel=Yt[Yt.indexOf(i)-1],n.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`)}n.resolved||this.switchLevel(e,s)}switchLevel(e,t){void 0!==t&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}class yn{constructor(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=S.log.bind(S,`${t}:`),this.warn=S.warn.bind(S,`${t}:`),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,n){const r=null==t?void 0:t.renditionReports;if(r){let s=-1;for(let n=0;n<r.length;n++){const a=r[n];let o;try{o=new self.URL(a.URI,t.url).href}catch(i){S.warn(`Could not construct new URL for Rendition Report: ${i}`),o=a.URI||""}if(o===e){s=n;break}o===e.substring(0,o.length)&&(s=n)}if(-1!==s){const e=r[s],i=parseInt(e["LAST-MSN"])||(null==t?void 0:t.lastPartSn);let a=parseInt(e["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const e=Math.min(t.age-t.partTarget,t.targetduration);a>=0&&e>t.partTarget&&(a+=1)}const o=n&&Kt(n);return new Wt(i,a>=0?a:void 0,o)}}}loadPlaylist(e){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}shouldReloadPlaylist(e){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(e)}playlistLoaded(e,t,n){const{details:r,stats:i}=t,s=self.performance.now(),a=i.loading.first?Math.max(0,s-i.loading.first):0;if(r.advancedDateTime=Date.now()-a,r.live||null!=n&&n.live){if(r.reloaded(n),n&&this.log(`live playlist ${e} ${r.advanced?"REFRESHED "+r.lastPartSn+"-"+r.lastPartIndex:r.updated?"UPDATED":"MISSED"}`),n&&r.fragments.length>0&&en(n,r),!this.canLoad||!r.live)return;let a,o,l;if(r.canBlockReload&&r.endSN&&r.advanced){const e=this.hls.config.lowLatencyMode,i=r.lastPartSn,s=r.endSN,c=r.lastPartIndex,h=i===s;-1!==c?(o=h?s+1:i,l=h?e?0:c:c+1):o=s+1;const u=r.age,d=u+r.ageHeader;let f=Math.min(d-r.partTarget,1.5*r.targetduration);if(f>0){if(n&&f>n.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${n.tuneInGoal} to: ${f} with playlist age: ${r.age}`),f=0;else{const e=Math.floor(f/r.targetduration);if(o+=e,void 0!==l){l+=Math.round(f%r.targetduration/r.partTarget)}this.log(`CDN Tune-in age: ${r.ageHeader}s last advanced ${u.toFixed(2)}s goal: ${f} skip sn ${e} to part ${l}`)}r.tuneInGoal=f}if(a=this.getDeliveryDirectives(r,t.deliveryDirectives,o,l),e||!h)return void this.loadPlaylist(a)}else(r.canBlockReload||r.canSkipUntil)&&(a=this.getDeliveryDirectives(r,t.deliveryDirectives,o,l));const c=this.hls.mainForwardBufferInfo,h=c?c.end-c.len:0,u=function(e,t=1/0){let n=1e3*e.targetduration;if(e.updated){const r=e.fragments,i=4;if(r.length&&n*i>t){const e=1e3*r[r.length-1].duration;e<n&&(n=e)}}else n/=2;return Math.round(n)}(r,1e3*(r.edge-h));r.updated&&s>this.requestScheduled+u&&(this.requestScheduled=i.loading.start),void 0!==o&&r.canBlockReload?this.requestScheduled=i.loading.first+u-(1e3*r.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+u<s?this.requestScheduled=s:this.requestScheduled-s<=0&&(this.requestScheduled+=u);let d=this.requestScheduled-s;d=Math.max(0,d),this.log(`reload live playlist ${e} in ${Math.round(d)} ms`),this.timer=self.setTimeout((()=>this.loadPlaylist(a)),d)}else this.clearTimer()}getDeliveryDirectives(e,t,n,r){let i=Kt(e);return null!=t&&t.skip&&e.deltaUpdateFailed&&(n=t.msn,r=t.part,i=Vt.No),new Wt(n,r,i)}checkRetry(e){const t=e.details,n=on(e),r=e.errorAction,{action:i,retryCount:s=0,retryConfig:a}=r||{},o=!!r&&!!a&&(i===pn.RetryRequest||!r.resolved&&i===pn.SendAlternateToPenaltyBox);if(o){var l;if(this.requestScheduled=-1,s>=a.maxNumRetry)return!1;if(n&&null!=(l=e.context)&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${s+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const e=cn(a,s);this.timer=self.setTimeout((()=>this.loadPlaylist()),e),this.warn(`Retrying playlist loading ${s+1}/${a.maxNumRetry} after "${t}" in ${e}ms`)}e.levelRetry=!0,r.resolved=!0}return o}}class En{constructor(e,t=0,n=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=n}sample(e,t){const n=Math.pow(this.alpha_,e);this.estimate_=t*(1-n)+n*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class xn{constructor(e,t,n,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=n,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new En(e),this.fast_=new En(t),this.defaultTTFB_=r,this.ttfb_=new En(e)}update(e,t){const{slow_:n,fast_:r,ttfb_:i}=this;n.halfLife!==e&&(this.slow_=new En(e,n.getEstimate(),n.getTotalWeight())),r.halfLife!==t&&(this.fast_=new En(t,r.getEstimate(),r.getTotalWeight())),i.halfLife!==e&&(this.ttfb_=new En(e,i.getEstimate(),i.getTotalWeight()))}sample(e,t){const n=(e=Math.max(e,this.minDelayMs_))/1e3,r=8*t/n;this.fast_.sample(n,r),this.slow_.sample(n,r)}sampleTTFB(e){const t=e/1e3,n=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(n,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const Cn={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},wn={};function In(e,t,n,r,i,s){const a=e.audioCodec?e.audioGroups:null,o=null==s?void 0:s.audioCodec,l=null==s?void 0:s.channels,c=l?parseInt(l):o?1/0:2;let h=null;if(null!=a&&a.length)try{h=1===a.length&&a[0]?t.groups[a[0]].channels:a.reduce(((e,n)=>{if(n){const r=t.groups[n];if(!r)throw new Error(`Audio track group ${n} not found`);Object.keys(r.channels).forEach((t=>{e[t]=(e[t]||0)+r.channels[t]}))}return e}),{2:0})}catch(u){return!0}return void 0!==e.videoCodec&&(e.width>1920&&e.height>1088||e.height>1920&&e.width>1088||e.frameRate>Math.max(r,30)||"SDR"!==e.videoRange&&e.videoRange!==n||e.bitrate>Math.max(i,8e6))||!!h&&p(c)&&Object.keys(h).some((e=>parseInt(e)>c))}function bn(e,t,n){const r=e.videoCodec,i=e.audioCodec;if(!r||!i||!n)return Promise.resolve(Cn);const s={width:e.width,height:e.height,bitrate:Math.ceil(Math.max(.9*e.bitrate,e.averageBitrate)),framerate:e.frameRate||30},a=e.videoRange;"SDR"!==a&&(s.transferFunction=a.toLowerCase());const o=r.split(",").map((e=>({type:"media-source",video:d(d({},s),{},{contentType:st(e,"video")})})));return i&&e.audioGroups&&e.audioGroups.forEach((e=>{var n;e&&(null==(n=t.groups[e])||n.tracks.forEach((t=>{if(t.groupId===e){const e=t.channels||"",n=parseFloat(e);p(n)&&n>2&&o.push.apply(o,i.split(",").map((e=>({type:"media-source",audio:{contentType:st(e,"audio"),channels:""+n}}))))}})))})),Promise.all(o.map((e=>{const t=function(e){const{audio:t,video:n}=e,r=n||t;if(r){const e=r.contentType.split('"')[1];if(n)return`r${n.height}x${n.width}f${Math.ceil(n.framerate)}${n.transferFunction||"sd"}_${e}_${Math.ceil(n.bitrate/1e5)}`;if(t)return`c${t.channels}${t.spatialRendering?"s":"n"}_${e}`}return""}(e);return wn[t]||(wn[t]=n.decodingInfo(e))}))).then((e=>({supported:!e.some((e=>!e.supported)),configurations:o,decodingInfoResults:e}))).catch((e=>({supported:!1,configurations:o,decodingInfoResults:[],error:e})))}function Sn(e,t){let n=!1,r=[];return e&&(n="SDR"!==e,r=[e]),t&&(r=t.allowedVideoRanges||jt.slice(0),n=void 0!==t.preferHDR?t.preferHDR:function(){if("function"==typeof matchMedia){const e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(e.media!==t.media)return!0===e.matches}return!1}(),r=n?r.filter((e=>"SDR"!==e)):["SDR"]),{preferHDR:n,allowedVideoRanges:r}}function Bn(e,t){S.log(`[abr] start candidates with "${e}" ignored because ${t}`)}function Tn(e,t,n){if("attrs"in e){const n=t.indexOf(e);if(-1!==n)return n}for(let r=0;r<t.length;r++){if(_n(e,t[r],n))return r}return-1}function _n(e,t,n){const{groupId:r,name:i,lang:s,assocLang:a,default:o}=e,l=e.forced;return(void 0===r||t.groupId===r)&&(void 0===i||t.name===i)&&(void 0===s||t.lang===s)&&(void 0===s||t.assocLang===a)&&(void 0===o||t.default===o)&&(void 0===l||t.forced===l)&&(!("characteristics"in e)||function(e,t=""){const n=e.split(","),r=t.split(",");return n.length===r.length&&!n.some((e=>-1===r.indexOf(e)))}(e.characteristics||"",t.characteristics))&&(void 0===n||n(e,t))}function Mn(e,t){const{audioCodec:n,channels:r}=e;return!(void 0!==n&&(t.audioCodec||"").substring(0,4)!==n.substring(0,4)||void 0!==r&&r!==(t.channels||"2"))}function Rn(e,t,n){for(let r=t;r>-1;r--)if(n(e[r]))return r;for(let r=t+1;r<e.length;r++)if(n(e[r]))return r;return-1}class Dn{constructor(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:e,partCurrent:t,hls:n}=this,{autoLevelEnabled:r,media:i}=n;if(!e||!i)return;const s=performance.now(),a=t?t.stats:e.stats,o=t?t.duration:e.duration,l=s-a.loading.start,c=n.minAutoLevel;if(a.aborted||a.loaded&&a.loaded===a.total||e.level<=c)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!r||i.paused||!i.playbackRate||!i.readyState)return;const h=n.mainForwardBufferInfo;if(null===h)return;const u=this.bwEstimator.getEstimateTTFB(),d=Math.abs(i.playbackRate);if(l<=Math.max(u,o/(2*d)*1e3))return;const f=h.len/d,A=a.loading.first?a.loading.first-a.loading.start:-1,m=a.loaded&&A>-1,g=this.getBwEstimate(),v=n.levels,E=v[e.level],x=a.total||Math.max(a.loaded,Math.round(o*E.averageBitrate/8));let C=m?l-A:l;C<1&&m&&(C=Math.min(l,8*a.loaded/g));const w=m?1e3*a.loaded/C:0,I=w?(x-a.loaded)/w:8*x/g+u/1e3;if(I<=f)return;const b=w?8*w:g;let B,T=Number.POSITIVE_INFINITY;for(B=e.level-1;B>c;B--){const e=v[B].maxBitrate;if(T=this.getTimeToLoadFrag(u/1e3,b,o*e,!v[B].details),T<f)break}if(T>=I)return;if(T>10*o)return;n.nextLoadLevel=n.nextAutoLevel=B,m?this.bwEstimator.sample(l-Math.min(u,A),a.loaded):this.bwEstimator.sampleTTFB(l);const _=v[B].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>_&&this.resetEstimator(_),this.clearTimer(),S.warn(`[abr] Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} is loading too slowly;\n      Time to underbuffer: ${f.toFixed(3)} s\n      Estimated load time for current fragment: ${I.toFixed(3)} s\n      Estimated load time for down switch fragment: ${T.toFixed(3)} s\n      TTFB estimate: ${0|A} ms\n      Current BW estimate: ${p(g)?0|g:"Unknown"} bps\n      New BW estimate: ${0|this.getBwEstimate()} bps\n      Switching to level ${B} @ ${0|_} bps`),n.trigger(y.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:a})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(S.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new xn(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(y.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const n=t.frag;if(!this.ignoreFragment(n)){var r;if(!n.bitrateTest)this.fragCurrent=n,this.partCurrent=null!=(r=t.part)?r:null;this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case x.BUFFER_ADD_CODEC_ERROR:case x.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case x.FRAG_LOAD_TIMEOUT:{const e=t.frag,{fragCurrent:n,partCurrent:r}=this;if(e&&n&&e.sn===n.sn&&e.level===n.level){const t=performance.now(),n=r?r.stats:e.stats,i=t-n.loading.start,s=n.loading.first?n.loading.first-n.loading.start:-1;if(n.loaded&&s>-1){const e=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(i-Math.min(e,s),n.loaded)}else this.bwEstimator.sampleTTFB(i)}break}}}getTimeToLoadFrag(e,t,n,r){return e+n/t+(r?this.lastLevelLoadSec:0)}onLevelLoaded(e,t){const n=this.hls.config,{loading:r}=t.stats,i=r.end-r.start;p(i)&&(this.lastLevelLoadSec=i/1e3),t.details.live?this.bwEstimator.update(n.abrEwmaSlowLive,n.abrEwmaFastLive):this.bwEstimator.update(n.abrEwmaSlowVoD,n.abrEwmaFastVoD)}onFragLoaded(e,{frag:t,part:n}){const r=n?n.stats:t.stats;if(t.type===_t.MAIN&&this.bwEstimator.sampleTTFB(r.loading.first-r.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const e=n?n.duration:t.duration,i=this.hls.levels[t.level],s=(i.loaded?i.loaded.bytes:0)+r.loaded,a=(i.loaded?i.loaded.duration:0)+e;i.loaded={bytes:s,duration:a},i.realBitrate=Math.round(8*s/a)}if(t.bitrateTest){const e={stats:r,frag:t,part:n,id:t.type};this.onFragBuffered(y.FRAG_BUFFERED,e),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:n,part:r}=t,i=null!=r&&r.stats.loaded?r.stats:n.stats;if(i.aborted)return;if(this.ignoreFragment(n))return;const s=i.parsing.end-i.loading.start-Math.min(i.loading.first-i.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(s,i.loaded),i.bwEstimate=this.getBwEstimate(),n.bitrateTest?this.bitrateTestDelay=s/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==_t.MAIN||"initSegment"===e.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,n=this.getBwEstimate(),r=this.hls.config.maxStarvationDelay,i=this.findBestLevel(n,t,e,0,r,1,1);if(i>-1)return i;const s=this.hls.firstLevel,a=Math.min(Math.max(s,t),e);return S.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${s} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,t=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(!(-1===e||t&&n&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return e;const r=t&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==e){const t=this.hls.levels;if(t.length>Math.max(e,r)&&t[e].loadError<=t[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:n}=this,{maxAutoLevel:r,config:i,minAutoLevel:s}=n,a=t?t.duration:e?e.duration:0,o=this.getBwEstimate(),l=this.getStarvationDelay();let c=i.abrBandWidthFactor,h=i.abrBandWidthUpFactor;if(l){const e=this.findBestLevel(o,s,r,l,0,c,h);if(e>=0)return e}let u=a?Math.min(a,i.maxStarvationDelay):i.maxStarvationDelay;if(!l){const e=this.bitrateTestDelay;if(e){u=(a?Math.min(a,i.maxLoadingDelay):i.maxLoadingDelay)-e,S.info(`[abr] bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*u)} ms`),c=h=1}}const d=this.findBestLevel(o,s,r,l,u,c,h);if(S.info(`[abr] ${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${d}`),d>-1)return d;const f=n.levels[s],A=n.levels[n.loadLevel];return(null==f?void 0:f.bitrate)<(null==A?void 0:A.bitrate)?s:n.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const n=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1,r=e.mainForwardBufferInfo;return(r?r.len:0)/n}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,n,r,i,s,a){var o;const l=r+i,c=this.lastLoadedFragLevel,h=-1===c?this.hls.firstLevel:c,{fragCurrent:u,partCurrent:d}=this,{levels:f,allAudioTracks:A,loadLevel:m,config:g}=this.hls;if(1===f.length)return 0;const v=f[h],y=!(null==v||null==(o=v.details)||!o.live),E=-1===m||-1===c;let x,C="SDR",w=(null==v?void 0:v.frameRate)||0;const{audioPreference:I,videoPreference:b}=g,B=this.audioTracksByGroup||(this.audioTracksByGroup=function(e){return e.reduce(((e,t)=>{let n=e.groups[t.groupId];n||(n=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),n.tracks.push(t);const r=t.channels||"2";return n.channels[r]=(n.channels[r]||0)+1,n.hasDefault=n.hasDefault||t.default,n.hasAutoSelect=n.hasAutoSelect||t.autoselect,n.hasDefault&&(e.hasDefaultAudio=!0),n.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e}),{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}(A));if(E){if(-1!==this.firstSelection)return this.firstSelection;const r=this.codecTiers||(this.codecTiers=function(e,t,n,r){return e.slice(n,r+1).reduce(((e,n)=>{if(!n.codecSet)return e;const r=n.audioGroups;let i=e[n.codecSet];i||(e[n.codecSet]=i={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!r,fragmentError:0}),i.minBitrate=Math.min(i.minBitrate,n.bitrate);const s=Math.min(n.height,n.width);return i.minHeight=Math.min(i.minHeight,s),i.minFramerate=Math.min(i.minFramerate,n.frameRate),i.maxScore=Math.max(i.maxScore,n.score),i.fragmentError+=n.fragmentError,i.videoRanges[n.videoRange]=(i.videoRanges[n.videoRange]||0)+1,r&&r.forEach((e=>{if(!e)return;const n=t.groups[e];n&&(i.hasDefaultAudio=i.hasDefaultAudio||t.hasDefaultAudio?n.hasDefault:n.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(n.channels).forEach((e=>{i.channels[e]=(i.channels[e]||0)+n.channels[e]})))})),e}),{})}(f,B,t,n)),i=function(e,t,n,r,i){const s=Object.keys(e),a=null==r?void 0:r.channels,o=null==r?void 0:r.audioCodec,l=a&&2===parseInt(a);let c=!0,h=!1,u=1/0,d=1/0,f=1/0,A=0,m=[];const{preferHDR:g,allowedVideoRanges:v}=Sn(t,i);for(let p=s.length;p--;){const t=e[s[p]];c=t.channels[2]>0,u=Math.min(u,t.minHeight),d=Math.min(d,t.minFramerate),f=Math.min(f,t.minBitrate);const n=v.filter((e=>t.videoRanges[e]>0));n.length>0&&(h=!0,m=n)}u=p(u)?u:0,d=p(d)?d:0;const y=Math.max(1080,u),E=Math.max(30,d);return f=p(f)?f:n,n=Math.max(f,n),h||(t=void 0,m=[]),{codecSet:s.reduce(((t,r)=>{const i=e[r];if(r===t)return t;if(i.minBitrate>n)return Bn(r,`min bitrate of ${i.minBitrate} > current estimate of ${n}`),t;if(!i.hasDefaultAudio)return Bn(r,"no renditions with default or auto-select sound found"),t;if(o&&r.indexOf(o.substring(0,4))%5!=0)return Bn(r,`audio codec preference "${o}" not found`),t;if(a&&!l){if(!i.channels[a])return Bn(r,`no renditions with ${a} channel sound found (channels options: ${Object.keys(i.channels)})`),t}else if((!o||l)&&c&&0===i.channels[2])return Bn(r,"no renditions with stereo sound found"),t;return i.minHeight>y?(Bn(r,`min resolution of ${i.minHeight} > maximum of ${y}`),t):i.minFramerate>E?(Bn(r,`min framerate of ${i.minFramerate} > maximum of ${E}`),t):m.some((e=>i.videoRanges[e]>0))?i.maxScore<A?(Bn(r,`max score of ${i.maxScore} < selected max of ${A}`),t):t&&(ot(r)>=ot(t)||i.fragmentError>e[t].fragmentError)?t:(A=i.maxScore,r):(Bn(r,`no variants with VIDEO-RANGE of ${JSON.stringify(m)} found`),t)}),void 0),videoRanges:m,preferHDR:g,minFramerate:d,minBitrate:f}}(r,C,e,I,b),{codecSet:s,videoRanges:a,minFramerate:o,minBitrate:l,preferHDR:c}=i;x=s,C=c?a[a.length-1]:a[0],w=o,e=Math.max(e,l),S.log(`[abr] picked start tier ${JSON.stringify(i)}`)}else x=null==v?void 0:v.codecSet,C=null==v?void 0:v.videoRange;const T=d?d.duration:u?u.duration:0,_=this.bwEstimator.getEstimateTTFB()/1e3,M=[];for(let D=n;D>=t;D--){var R;const t=f[D],o=D>h;if(!t)continue;if(g.useMediaCapabilities&&!t.supportedResult&&!t.supportedPromise){const n=navigator.mediaCapabilities;"function"==typeof(null==n?void 0:n.decodingInfo)&&In(t,B,C,w,e,I)?(t.supportedPromise=bn(t,B,n),t.supportedPromise.then((e=>{if(!this.hls)return;t.supportedResult=e;const n=this.hls.levels,r=n.indexOf(t);e.error?S.warn(`[abr] MediaCapabilities decodingInfo error: "${e.error}" for level ${r} ${JSON.stringify(e)}`):e.supported||(S.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${r} ${JSON.stringify(e)}`),r>-1&&n.length>1&&(S.log(`[abr] Removing unsupported level ${r}`),this.hls.removeLevel(r)))}))):t.supportedResult=Cn}if(x&&t.codecSet!==x||C&&t.videoRange!==C||o&&w>t.frameRate||!o&&w>0&&w<t.frameRate||t.supportedResult&&(null==(R=t.supportedResult.decodingInfoResults)||!R[0].smooth)){M.push(D);continue}const u=t.details,A=(d?null==u?void 0:u.partTarget:null==u?void 0:u.averagetargetduration)||T;let b;b=o?a*e:s*e;const P=T&&r>=2*T&&0===i?f[D].averageBitrate:f[D].maxBitrate,L=this.getTimeToLoadFrag(_,b,P*A,void 0===u);if(b>=P&&(D===c||0===t.loadError&&0===t.fragmentError)&&(L<=_||!p(L)||y&&!this.bitrateTestDelay||L<l)){const e=this.forcedAutoLevel;return D===m||-1!==e&&e===m||(M.length&&S.trace(`[abr] Skipped level(s) ${M.join(",")} of ${n} max with CODECS and VIDEO-RANGE:"${f[M[0]].codecs}" ${f[M[0]].videoRange}; not compatible with "${v.codecs}" ${C}`),S.info(`[abr] switch candidate:${h}->${D} adjustedbw(${Math.round(b)})-bitrate=${Math.round(b-P)} ttfb:${_.toFixed(1)} avgDuration:${A.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${L.toFixed(1)} firstSelection:${E} codecSet:${x} videoRange:${C} hls.loadLevel:${m}`)),E&&(this.firstSelection=D),D}}return-1}set nextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:n}=this.hls,r=Math.min(Math.max(e,n),t);this._nextAutoLevel!==r&&(this.nextAutoLevelKey="",this._nextAutoLevel=r)}}class Pn{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var Ln="NOT_LOADED",kn="APPENDING",Fn="PARTIAL",On="OK";class Un{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(y.BUFFER_APPENDED,this.onBufferAppended,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.BUFFER_APPENDED,this.onBufferAppended,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const n=this.activePartLists[t];if(n)for(let r=n.length;r--;){const t=n[r];if(!t)break;const i=t.end;if(t.start<=e&&null!==i&&e<=i)return t}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:n}=this,r=Object.keys(n);for(let i=r.length;i--;){const s=n[r[i]];if((null==s?void 0:s.body.type)===t&&s.buffered){const t=s.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,n,r){this.timeRanges&&(this.timeRanges[e]=t);const i=(null==r?void 0:r.fragment.sn)||-1;Object.keys(this.fragments).forEach((r=>{const s=this.fragments[r];if(!s)return;if(i>=s.body.sn)return;if(!s.buffered&&!s.loaded)return void(s.body.type===n&&this.removeFragment(s.body));const a=s.range[e];a&&a.time.some((e=>{const n=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return n&&this.removeFragment(s.body),n}))}))}detectPartialFragments(e){const t=this.timeRanges,{frag:n,part:r}=e;if(!t||"initSegment"===n.sn)return;const i=Nn(n),s=this.fragments[i];if(!s||s.buffered&&n.gap)return;const a=!n.relurl;if(Object.keys(t).forEach((e=>{const i=n.elementaryStreams[e];if(!i)return;const o=t[e],l=a||!0===i.partial;s.range[e]=this.getBufferedTimes(n,r,l,o)})),s.loaded=null,Object.keys(s.range).length){s.buffered=!0;(s.body.endList=n.endList||s.body.endList)&&(this.endListFragments[s.body.type]=s),Qn(s)||this.removeParts(n.sn-1,n.type)}else this.removeFragment(s.body)}removeParts(e,t){const n=this.activePartLists[t];n&&(this.activePartLists[t]=n.filter((t=>t.fragment.sn>=e)))}fragBuffered(e,t){const n=Nn(e);let r=this.fragments[n];!r&&t&&(r=this.fragments[n]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,r.buffered=!0)}getBufferedTimes(e,t,n,r){const i={time:[],partial:n},s=e.start,a=e.end,o=e.minEndPTS||a,l=e.maxStartPTS||s;for(let c=0;c<r.length;c++){const e=r.start(c)-this.bufferPadding,t=r.end(c)+this.bufferPadding;if(l>=e&&o<=t){i.time.push({startPTS:Math.max(s,r.start(c)),endPTS:Math.min(a,r.end(c))});break}if(s<t&&a>e){const e=Math.max(s,r.start(c)),t=Math.min(a,r.end(c));t>e&&(i.partial=!0,i.time.push({startPTS:e,endPTS:t}))}else if(a<=e)break}return i}getPartialFragment(e){let t,n,r,i=null,s=0;const{bufferPadding:a,fragments:o}=this;return Object.keys(o).forEach((l=>{const c=o[l];c&&Qn(c)&&(n=c.body.start-a,r=c.body.end+a,e>=n&&e<=r&&(t=Math.min(e-n,r-e),s<=t&&(i=c.body,s=t)))})),i}isEndListAppended(e){const t=this.endListFragments[e];return void 0!==t&&(t.buffered||Qn(t))}getState(e){const t=Nn(e),n=this.fragments[t];return n?n.buffered?Qn(n)?Fn:On:kn:Ln}isTimeBuffered(e,t,n){let r,i;for(let s=0;s<n.length;s++){if(r=n.start(s)-this.bufferPadding,i=n.end(s)+this.bufferPadding,e>=r&&t<=i)return!0;if(t<=r)return!1}return!1}onFragLoaded(e,t){const{frag:n,part:r}=t;if("initSegment"===n.sn||n.bitrateTest)return;const i=r?null:t,s=Nn(n);this.fragments[s]={body:n,appendedPTS:null,loaded:i,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:n,part:r,timeRanges:i}=t;if("initSegment"===n.sn)return;const s=n.type;if(r){let e=this.activePartLists[s];e||(this.activePartLists[s]=e=[]),e.push(r)}this.timeRanges=i,Object.keys(i).forEach((e=>{const t=i[e];this.detectEvictedFragments(e,t,s,r)}))}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=Nn(e);return!!this.fragments[t]}hasParts(e){var t;return!(null==(t=this.activePartLists[e])||!t.length)}removeFragmentsInRange(e,t,n,r,i){r&&!this.hasGaps||Object.keys(this.fragments).forEach((s=>{const a=this.fragments[s];if(!a)return;const o=a.body;o.type!==n||r&&!o.gap||o.start<t&&o.end>e&&(a.buffered||i)&&this.removeFragment(o)}))}removeFragment(e){const t=Nn(e);e.stats.loaded=0,e.clearElementaryStreamInfo();const n=this.activePartLists[e.type];if(n){const t=e.sn;this.activePartLists[e.type]=n.filter((e=>e.fragment.sn!==t))}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function Qn(e){var t,n,r;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(n=e.range.audio)?void 0:n.partial)||(null==(r=e.range.audiovideo)?void 0:r.partial))}function Nn(e){return`${e.type}_${e.level}_${e.sn}`}const zn={length:0,start:()=>0,end:()=>0};class Gn{static isBuffered(e,t){try{if(e){const n=Gn.getBuffered(e);for(let e=0;e<n.length;e++)if(t>=n.start(e)&&t<=n.end(e))return!0}}catch(n){}return!1}static bufferInfo(e,t,n){try{if(e){const r=Gn.getBuffered(e),i=[];let s;for(s=0;s<r.length;s++)i.push({start:r.start(s),end:r.end(s)});return this.bufferedInfo(i,t,n)}}catch(r){}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,n){t=Math.max(0,t),e.sort((function(e,t){const n=e.start-t.start;return n||t.end-e.end}));let r=[];if(n)for(let l=0;l<e.length;l++){const t=r.length;if(t){const i=r[t-1].end;e[l].start-i<n?e[l].end>i&&(r[t-1].end=e[l].end):r.push(e[l])}else r.push(e[l])}else r=e;let i,s=0,a=t,o=t;for(let l=0;l<r.length;l++){const e=r[l].start,c=r[l].end;if(t+n>=e&&t<c)a=e,o=c,s=o-t;else if(t+n<e){i=e;break}}return{len:s,start:a||0,end:o||0,nextStart:i}}static getBuffered(e){try{return e.buffered}catch(t){return S.log("failed to get media.buffered",t),zn}}}class Hn{constructor(e,t,n,r=0,i=-1,s=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=e,this.sn=t,this.id=n,this.size=r,this.part=i,this.partial=s}}function qn(e,t){for(let r=0,i=e.length;r<i;r++){var n;if((null==(n=e[r])?void 0:n.cc)===t)return e[r]}return null}function Yn(e,t){if(e){const n=e.start+t;e.start=e.startPTS=n,e.endPTS=n+e.duration}}function jn(e,t){const n=t.fragments;for(let r=0,i=n.length;r<i;r++)Yn(n[r],e);t.fragmentHint&&Yn(t.fragmentHint,e),t.alignedSliding=!0}function Vn(e,t,n){t&&(!function(e,t,n){if(function(e,t,n){return!(!t||!(n.endCC>n.startCC||e&&e.cc<n.startCC))}(e,n,t)){const e=function(e,t){const n=e.fragments,r=t.fragments;if(!r.length||!n.length)return void S.log("No fragments to align");const i=qn(n,r[0].cc);if(i&&(!i||i.startPTS))return i;S.log("No frag in previous level to align on")}(n,t);e&&p(e.start)&&(S.log(`Adjusting PTS using last level due to CC increase within current level ${t.url}`),jn(e.start,t))}}(e,n,t),!n.alignedSliding&&t&&Kn(n,t),n.alignedSliding||!t||n.skippedSegments||tn(t,n))}function Kn(e,t){if(!e.hasProgramDateTime||!t.hasProgramDateTime)return;const n=e.fragments,r=t.fragments;if(!n.length||!r.length)return;let i,s;const a=Math.min(t.endCC,e.endCC);t.startCC<a&&e.startCC<a&&(i=qn(r,a),s=qn(n,a)),i&&s||(i=r[Math.floor(r.length/2)],s=qn(n,i.cc)||n[Math.floor(n.length/2)]);const o=i.programDateTime,l=s.programDateTime;if(!o||!l)return;jn((l-o)/1e3-(s.start-i.start),e)}const Wn=Math.pow(2,17);class Jn{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const n=e.url;if(!n)return Promise.reject(new Zn({type:E.NETWORK_ERROR,details:x.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a "+(n?"part list":"url")),networkDetails:null}));this.abort();const r=this.config,i=r.fLoader,s=r.loader;return new Promise(((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap){if(e.tagList.some((e=>"GAP"===e[0])))return void o($n(e));e.gap=!1}const l=this.loader=e.loader=i?new i(r):new s(r),c=Xn(e),h=hn(r.fragLoadPolicy.default),u={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:Wn};e.stats=l.stats,l.load(c,u,{onSuccess:(t,n,r,i)=>{this.resetLoader(e,l);let s=t.data;r.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(s.slice(0,16)),s=s.slice(16)),a({frag:e,part:null,payload:s,networkDetails:i})},onError:(t,r,i,s)=>{this.resetLoader(e,l),o(new Zn({type:E.NETWORK_ERROR,details:x.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:d({url:n,data:void 0},t),error:new Error(`HTTP Error ${t.code} ${t.text}`),networkDetails:i,stats:s}))},onAbort:(t,n,r)=>{this.resetLoader(e,l),o(new Zn({type:E.NETWORK_ERROR,details:x.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:r,stats:t}))},onTimeout:(t,n,r)=>{this.resetLoader(e,l),o(new Zn({type:E.NETWORK_ERROR,details:x.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:r,stats:t}))},onProgress:(n,r,i,s)=>{t&&t({frag:e,part:null,payload:i,networkDetails:s})}})}))}loadPart(e,t,n){this.abort();const r=this.config,i=r.fLoader,s=r.loader;return new Promise(((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap)return void o($n(e,t));const l=this.loader=e.loader=i?new i(r):new s(r),c=Xn(e,t),h=hn(r.fragLoadPolicy.default),u={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Wn};t.stats=l.stats,l.load(c,u,{onSuccess:(r,i,s,o)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const c={frag:e,part:t,payload:r.data,networkDetails:o};n(c),a(c)},onError:(n,r,i,s)=>{this.resetLoader(e,l),o(new Zn({type:E.NETWORK_ERROR,details:x.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:d({url:c.url,data:void 0},n),error:new Error(`HTTP Error ${n.code} ${n.text}`),networkDetails:i,stats:s}))},onAbort:(n,r,i)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),o(new Zn({type:E.NETWORK_ERROR,details:x.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:i,stats:n}))},onTimeout:(n,r,i)=>{this.resetLoader(e,l),o(new Zn({type:E.NETWORK_ERROR,details:x.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:i,stats:n}))}})}))}updateStatsFromPart(e,t){const n=e.stats,r=t.stats,i=r.total;if(n.loaded+=r.loaded,i){const r=Math.round(e.duration/t.duration),s=Math.min(Math.round(n.loaded/i),r),a=(r-s)*Math.round(n.loaded/s);n.total=n.loaded+a}else n.total=Math.max(n.loaded,n.total);const s=n.loading,a=r.loading;s.start?s.first+=a.first-a.start:(s.start=a.start,s.first=a.first),s.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function Xn(e,t=null){const n=t||e,r={frag:e,part:t,responseType:"arraybuffer",url:n.url,headers:{},rangeStart:0,rangeEnd:0},i=n.byteRangeStartOffset,s=n.byteRangeEndOffset;if(p(i)&&p(s)){var a;let t=i,n=s;if("initSegment"===e.sn&&"AES-128"===(null==(a=e.decryptdata)?void 0:a.method)){const e=s-i;e%16&&(n=s+(16-e%16)),0!==i&&(r.resetIV=!0,t=i-16)}r.rangeStart=t,r.rangeEnd=n}return r}function $n(e,t){const n=new Error(`GAP ${e.gap?"tag":"attribute"} found`),r={type:E.MEDIA_ERROR,details:x.FRAG_GAP,fatal:!1,frag:e,error:n,networkDetails:null};return t&&(r.part=t),(t||e).stats.aborted=!0,new Zn(r)}class Zn extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class er{constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class tr{constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class nr{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),n=new Uint32Array(4);for(let r=0;r<4;r++)n[r]=t.getUint32(4*r);return n}initTable(){const e=this.sBox,t=this.invSBox,n=this.subMix,r=n[0],i=n[1],s=n[2],a=n[3],o=this.invSubMix,l=o[0],c=o[1],h=o[2],u=o[3],d=new Uint32Array(256);let f=0,A=0,m=0;for(m=0;m<256;m++)d[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){let n=A^A<<1^A<<2^A<<3^A<<4;n=n>>>8^255&n^99,e[f]=n,t[n]=f;const o=d[f],m=d[o],p=d[m];let g=257*d[n]^16843008*n;r[f]=g<<24|g>>>8,i[f]=g<<16|g>>>16,s[f]=g<<8|g>>>24,a[f]=g,g=16843009*p^65537*m^257*o^16843008*f,l[n]=g<<24|g>>>8,c[n]=g<<16|g>>>16,h[n]=g<<8|g>>>24,u[n]=g,f?(f=o^d[d[d[p^o]]],A^=d[d[A]]):f=A=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let n=!0,r=0;for(;r<t.length&&n;)n=t[r]===this.key[r],r++;if(n)return;this.key=t;const i=this.keySize=t.length;if(4!==i&&6!==i&&8!==i)throw new Error("Invalid aes key size="+i);const s=this.ksRows=4*(i+6+1);let a,o;const l=this.keySchedule=new Uint32Array(s),c=this.invKeySchedule=new Uint32Array(s),h=this.sBox,u=this.rcon,d=this.invSubMix,f=d[0],A=d[1],m=d[2],p=d[3];let g,v;for(a=0;a<s;a++)a<i?g=l[a]=t[a]:(v=g,a%i==0?(v=v<<8|v>>>24,v=h[v>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[255&v],v^=u[a/i|0]<<24):i>6&&a%i==4&&(v=h[v>>>24]<<24|h[v>>>16&255]<<16|h[v>>>8&255]<<8|h[255&v]),l[a]=g=(l[a-i]^v)>>>0);for(o=0;o<s;o++)a=s-o,v=3&o?l[a]:l[a-4],c[o]=o<4||a<=4?v:f[h[v>>>24]]^A[h[v>>>16&255]]^m[h[v>>>8&255]]^p[h[255&v]],c[o]=c[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,n){const r=this.keySize+6,i=this.invKeySchedule,s=this.invSBox,a=this.invSubMix,o=a[0],l=a[1],c=a[2],h=a[3],u=this.uint8ArrayToUint32Array_(n);let d=u[0],f=u[1],A=u[2],m=u[3];const p=new Int32Array(e),g=new Int32Array(p.length);let v,y,E,x,C,w,I,b,S,B,T,_,M,R;const D=this.networkToHostOrderSwap;for(;t<p.length;){for(S=D(p[t]),B=D(p[t+1]),T=D(p[t+2]),_=D(p[t+3]),C=S^i[0],w=_^i[1],I=T^i[2],b=B^i[3],M=4,R=1;R<r;R++)v=o[C>>>24]^l[w>>16&255]^c[I>>8&255]^h[255&b]^i[M],y=o[w>>>24]^l[I>>16&255]^c[b>>8&255]^h[255&C]^i[M+1],E=o[I>>>24]^l[b>>16&255]^c[C>>8&255]^h[255&w]^i[M+2],x=o[b>>>24]^l[C>>16&255]^c[w>>8&255]^h[255&I]^i[M+3],C=v,w=y,I=E,b=x,M+=4;v=s[C>>>24]<<24^s[w>>16&255]<<16^s[I>>8&255]<<8^s[255&b]^i[M],y=s[w>>>24]<<24^s[I>>16&255]<<16^s[b>>8&255]<<8^s[255&C]^i[M+1],E=s[I>>>24]<<24^s[b>>16&255]<<16^s[C>>8&255]<<8^s[255&w]^i[M+2],x=s[b>>>24]<<24^s[C>>16&255]<<16^s[w>>8&255]<<8^s[255&I]^i[M+3],g[t]=D(v^d),g[t+1]=D(x^f),g[t+2]=D(E^A),g[t+3]=D(y^m),d=S,f=B,A=T,m=_,t+=4}return g.buffer}}class rr{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(n){}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const n=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?function(e){const t=e.byteLength,n=t&&new DataView(e.buffer).getUint8(t-1);return n?re(e,0,t-n):e}(n):n}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,n){return this.useSoftware?new Promise(((r,i)=>{this.softwareDecrypt(new Uint8Array(e),t,n);const s=this.flush();s?r(s.buffer):i(new Error("[softwareDecrypt] Failed to decrypt data"))})):this.webCryptoDecrypt(new Uint8Array(e),t,n)}softwareDecrypt(e,t,n){const{currentIV:r,currentResult:i,remainderData:s}=this;this.logOnce("JS AES decrypt"),s&&(e=Ne(s,e),this.remainderData=null);const a=this.getValidChunk(e);if(!a.length)return null;r&&(n=r);let o=this.softwareDecrypter;o||(o=this.softwareDecrypter=new nr),o.expandKey(t);const l=i;return this.currentResult=o.decrypt(a.buffer,0,n),this.currentIV=re(a,-16).buffer,l||null}webCryptoDecrypt(e,t,n){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,n));this.key=t,this.fastAesKey=new tr(this.subtle,t)}return this.fastAesKey.expandKey().then((t=>{if(!this.subtle)return Promise.reject(new Error("web crypto not initialized"));this.logOnce("WebCrypto AES decrypt");return new er(this.subtle,new Uint8Array(n)).decrypt(e.buffer,t)})).catch((r=>(S.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,n))))}onWebCryptoError(e,t,n){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,n);const r=this.flush();if(r)return r.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(e){let t=e;const n=e.length-e.length%16;return n!==e.length&&(t=re(e,0,n),this.remainderData=re(e,n)),t}logOnce(e){this.logEnabled&&(S.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const ir=function(e){let t="";const n=e.length;for(let r=0;r<n;r++)t+=`[${e.start(r).toFixed(3)}-${e.end(r).toFixed(3)}]`;return t},sr="STOPPED",ar="IDLE",or="KEY_LOADING",lr="FRAG_LOADING",cr="FRAG_LOADING_WAITING_RETRY",hr="WAITING_TRACK",ur="PARSING",dr="PARSED",fr="ENDED",Ar="ERROR",mr="WAITING_INIT_PTS",pr="WAITING_LEVEL";class gr extends Pn{constructor(e,t,n,r,i){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=sr,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=i,this.logPrefix=r,this.log=S.log.bind(S,`${r}:`),this.warn=S.warn.bind(S,`${r}:`),this.hls=e,this.fragmentLoader=new Jn(e.config),this.keyLoader=n,this.fragmentTracker=t,this.config=e.config,this.decrypter=new rr(e.config),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;null!=e&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=sr}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}_streamEnded(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;const n=t.partList;if(null!=n&&n.length){const e=n[n.length-1];return Gn.isBuffered(this.media,e.start+e.duration/2)}const r=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(r)}getLevelDetails(){var e;if(this.levels&&null!==this.levelLastLoaded)return null==(e=this.levelLastLoaded)?void 0:e.details}onMediaAttached(e,t){const n=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),n.addEventListener("seeking",this.onvseeking),n.addEventListener("ended",this.onvended);const r=this.config;this.levels&&r.autoStartLoad&&this.state===sr&&this.startLoad(r.startPosition)}onMediaDetaching(){const e=this.media;null!=e&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:n,mediaBuffer:r,state:i}=this,s=n?n.currentTime:0,a=Gn.bufferInfo(r||n,s,e.maxBufferHole);if(this.log(`media seeking to ${p(s)?s.toFixed(3):s}, state: ${i}`),this.state===fr)this.resetLoadingState();else if(t){const n=e.maxFragLookUpTolerance,r=t.start-n,i=t.start+t.duration+n;if(!a.len||i<a.start||r>a.end){const e=s>i;(s<r||e)&&(e&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}n&&(this.fragmentTracker.removeFragmentsInRange(s,1/0,this.playlistType,!0),this.lastCurrentTime=s),this.loadedmetadata||a.len||(this.nextLoadPosition=this.startPosition=s),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=sr,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,n){this._loadFragForPlayback(e,t,n)}_loadFragForPlayback(e,t,n){this._doFragLoad(e,t,n,(t=>{if(this.fragContextChanged(e))return this.warn(`Fragment ${e.sn}${t.part?" p: "+t.part.index:""} of level ${e.level} was dropped during download.`),void this.fragmentTracker.removeFragment(e);e.stats.chunkCount++,this._handleFragmentLoadProgress(t)})).then((t=>{if(!t)return;const n=this.state;this.fragContextChanged(e)?(n===lr||!this.fragCurrent&&n===ur)&&(this.fragmentTracker.removeFragment(e),this.state=ar):("payload"in t&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(y.FRAG_LOADED,t)),this._handleFragmentLoadComplete(t))})).catch((t=>{this.state!==sr&&this.state!==Ar&&(this.warn(`Frag error: ${(null==t?void 0:t.message)||t}`),this.resetFragmentLoading(e))}))}clearTrackerIfNeeded(e){var t;const{fragmentTracker:n}=this;if(n.getState(e)===kn){const t=e.type,r=this.getFwdBufferInfo(this.mediaBuffer,t),i=Math.max(e.duration,r?r.len:this.config.maxBufferLength),s=this.backtrackFragment;(1===(s?e.sn-s.sn:0)||this.reduceMaxBufferLength(i,e.duration))&&n.removeFragment(e)}else 0===(null==(t=this.mediaBuffer)?void 0:t.buffered.length)?n.removeAllFragments():n.hasParts(e.type)&&(n.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),n.getState(e)===Fn&&n.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}flushMainBuffer(e,t,n=null){if(!(e-t))return;const r={startOffset:e,endOffset:t,type:n};this.hls.trigger(y.BUFFER_FLUSHING,r)}_loadInitSegment(e,t){this._doFragLoad(e,t).then((t=>{if(!t||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return t})).then((t=>{const{hls:n}=this,{payload:r}=t,i=e.decryptdata;if(r&&r.byteLength>0&&null!=i&&i.key&&i.iv&&"AES-128"===i.method){const s=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),i.key.buffer,i.iv.buffer).catch((t=>{throw n.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t})).then((r=>{const i=self.performance.now();return n.trigger(y.FRAG_DECRYPTED,{frag:e,payload:r,stats:{tstart:s,tdecrypt:i}}),t.payload=r,this.completeInitSegmentLoad(t)}))}return this.completeInitSegmentLoad(t)})).catch((t=>{this.state!==sr&&this.state!==Ar&&(this.warn(t),this.resetFragmentLoading(e))}))}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const n=e.frag.stats;this.state=ar,e.frag.data=new Uint8Array(e.payload),n.parsing.start=n.buffering.start=self.performance.now(),n.parsing.end=n.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){var n,r,i,s;const a=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.playlistType===_t.MAIN?"level":"track"} ${e.level} (frag:[${(null!=(n=e.startPTS)?n:NaN).toFixed(3)}-${(null!=(r=e.endPTS)?r:NaN).toFixed(3)}] > buffer:${a?ir(Gn.getBuffered(a)):"(detached)"})`),"initSegment"!==e.sn){var o;if(e.type!==_t.SUBTITLE){const t=e.elementaryStreams;if(!Object.keys(t).some((e=>!!t[e])))return void(this.state=ar)}const t=null==(o=this.levels)?void 0:o[e.level];null!=t&&t.fragmentError&&(this.log(`Resetting level fragment error count of ${t.fragmentError} on frag buffered`),t.fragmentError=0)}this.state=ar,a&&(!this.loadedmetadata&&e.type==_t.MAIN&&a.buffered.length&&(null==(i=this.fragCurrent)?void 0:i.sn)===(null==(s=this.fragPrevious)?void 0:s.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:n,part:r,partsLoaded:i}=e,s=!i||0===i.length||i.some((e=>!e)),a=new Hn(n.level,n.sn,n.stats.chunkCount+1,0,r?r.index:-1,!s);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,n=null,r){var i;const s=null==t?void 0:t.details;if(!this.levels||!s)throw new Error(`frag load aborted, missing level${s?"":" detail"}s`);let a=null;if(!e.encrypted||null!=(i=e.decryptdata)&&i.key?!e.encrypted&&s.encryptedFragments.length&&this.keyLoader.loadClear(e,s.encryptedFragments):(this.log(`Loading key for ${e.sn} of [${s.startSN}-${s.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${e.level}`),this.state=or,this.fragCurrent=e,a=this.keyLoader.load(e).then((e=>{if(!this.fragContextChanged(e.frag))return this.hls.trigger(y.KEY_LOADED,e),this.state===or&&(this.state=ar),e})),this.hls.trigger(y.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))),n=Math.max(e.start,n||0),this.config.lowLatencyMode&&"initSegment"!==e.sn){const i=s.partList;if(i&&r){n>e.end&&s.fragmentHint&&(e=s.fragmentHint);const o=this.getNextPart(i,e,n);if(o>-1){const l=i[o];let c;return this.log(`Loading part sn: ${e.sn} p: ${l.index} cc: ${e.cc} of playlist [${s.startSN}-${s.endSN}] parts [0-${o}-${i.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(n.toFixed(3))}`),this.nextLoadPosition=l.start+l.duration,this.state=lr,c=a?a.then((n=>!n||this.fragContextChanged(n.frag)?null:this.doFragPartsLoad(e,l,t,r))).catch((e=>this.handleFragLoadError(e))):this.doFragPartsLoad(e,l,t,r).catch((e=>this.handleFragLoadError(e))),this.hls.trigger(y.FRAG_LOADING,{frag:e,part:l,targetBufferTime:n}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):c}if(!e.url||this.loadedEndOfParts(i,n))return Promise.resolve(null)}}this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${s?"of ["+s.startSN+"-"+s.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(n.toFixed(3))}`),p(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=lr;const o=this.config.progressive;let l;return l=o&&a?a.then((t=>!t||this.fragContextChanged(null==t?void 0:t.frag)?null:this.fragmentLoader.load(e,r))).catch((e=>this.handleFragLoadError(e))):Promise.all([this.fragmentLoader.load(e,o?r:void 0),a]).then((([e])=>(!o&&e&&r&&r(e),e))).catch((e=>this.handleFragLoadError(e))),this.hls.trigger(y.FRAG_LOADING,{frag:e,targetBufferTime:n}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):l}doFragPartsLoad(e,t,n,r){return new Promise(((i,s)=>{var a;const o=[],l=null==(a=n.details)?void 0:a.partList,c=t=>{this.fragmentLoader.loadPart(e,t,r).then((r=>{o[t.index]=r;const s=r.part;this.hls.trigger(y.FRAG_LOADED,r);const a=rn(n,e.sn,t.index+1)||sn(l,e.sn,t.index+1);if(!a)return i({frag:e,part:s,partsLoaded:o});c(a)})).catch(s)};c(t)}))}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===x.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(y.ERROR,t)}else this.hls.trigger(y.ERROR,{type:E.OTHER_ERROR,details:x.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==ur)return void(this.fragCurrent||this.state===sr||this.state===Ar||(this.state=ar));const{frag:n,part:r,level:i}=t,s=self.performance.now();n.stats.parsing.end=s,r&&(r.stats.parsing.end=s),this.updateLevelTiming(n,r,i,e.partial)}getCurrentContext(e){const{levels:t,fragCurrent:n}=this,{level:r,sn:i,part:s}=e;if(null==t||!t[r])return this.warn(`Levels object was unset while buffering fragment ${i} of level ${r}. The current chunk will not be buffered.`),null;const a=t[r],o=s>-1?rn(a,i,s):null,l=o?o.fragment:function(e,t,n){if(null==e||!e.details)return null;const r=e.details;let i=r.fragments[t-r.startSN];return i||(i=r.fragmentHint,i&&i.sn===t?i:t<r.startSN&&n&&n.sn===t?n:null)}(a,i,n);return l?(n&&n!==l&&(l.stats=n.stats),{frag:l,part:o,level:a}):null}bufferFragmentData(e,t,n,r,i){var s;if(!e||this.state!==ur)return;const{data1:a,data2:o}=e;let l=a;if(a&&o&&(l=Ne(a,o)),null==(s=l)||!s.length)return;const c={type:e.type,frag:t,part:n,chunkMeta:r,parent:t.type,data:l};if(this.hls.trigger(y.BUFFER_APPENDING,c),e.dropped&&e.independent&&!n){if(i)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!Gn.isBuffered(t,t.currentTime))return void this.flushMainBuffer(0,e.start);const n=t.currentTime,r=Gn.bufferInfo(t,n,0),i=e.duration,s=Math.min(2*this.config.maxFragLookUpTolerance,.25*i),a=Math.max(Math.min(e.start-s,r.end-s),n+s);e.start-a>s&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){const n=this.getLoadPosition();return p(n)?this.getFwdBufferInfoAtPos(e,n,t):null}getFwdBufferInfoAtPos(e,t,n){const{config:{maxBufferHole:r}}=this,i=Gn.bufferInfo(e,t,r);if(0===i.len&&void 0!==i.nextStart){const s=this.fragmentTracker.getBufferedFrag(t,n);if(s&&i.nextStart<s.end)return Gn.bufferInfo(e,t,Math.max(i.nextStart,r))}return i}getMaxBufferLength(e){const{config:t}=this;let n;return n=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(n,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const n=this.config,r=Math.max(Math.min(e-t,n.maxBufferLength),t),i=Math.max(e-3*t,n.maxMaxBufferLength/2,r);return i>=r&&(n.maxMaxBufferLength=i,this.warn(`Reduce max buffer length to ${i}s`),!0)}getAppendedFrag(e,t=_t.MAIN){const n=this.fragmentTracker.getAppendedFrag(e,_t.MAIN);return n&&"fragment"in n?n.fragment:n}getNextFragment(e,t){const n=t.fragments,r=n.length;if(!r)return null;const{config:i}=this,s=n[0].start;let a;if(t.live){const o=i.initialLiveManifestSize;if(r<o)return this.warn(`Not enough fragments to start playback (have: ${r}, need: ${o})`),null;(!t.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||e<s)&&(a=this.getInitialLiveFragment(t,n),this.startPosition=this.nextLoadPosition=a?this.hls.liveSyncPosition||a.start:e)}else e<=s&&(a=n[0]);if(!a){const n=i.lowLatencyMode?t.partEnd:t.fragmentEnd;a=this.getFragmentAtPosition(e,n,t)}return this.mapToInitFragWhenRequired(a)}isLoopLoading(e,t){const n=this.fragmentTracker.getState(e);return(n===On||n===Fn&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,n,r,i){const s=e.gap,a=this.getNextFragment(this.nextLoadPosition,t);if(null===a)return a;if(e=a,s&&e&&!e.gap&&n.nextStart){const t=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,n.nextStart,r);if(null!==t&&n.len+t.len>=i)return this.log(`buffer full after gaps in "${r}" playlist starting at sn: ${e.sn}`),null}return e}mapToInitFragWhenRequired(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment}getNextPart(e,t,n){let r=-1,i=!1,s=!0;for(let a=0,o=e.length;a<o;a++){const o=e[a];if(s=s&&!o.independent,r>-1&&n<o.start)break;const l=o.loaded;l?r=-1:(i||o.independent||s)&&o.fragment===t&&(r=a),i=l}return r}loadedEndOfParts(e,t){const n=e[e.length-1];return n&&t>n.start&&n.loaded}getInitialLiveFragment(e,t){const n=this.fragPrevious;let r=null;if(n){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${n.programDateTime}`),r=function(e,t,n){if(null===t||!Array.isArray(e)||!e.length||!p(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;n=n||0;for(let r=0;r<e.length;++r){const i=e[r];if(mn(t,n,i))return i}return null}(t,n.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){const i=n.sn+1;if(i>=e.startSN&&i<=e.endSN){const s=t[i-e.startSN];n.cc===s.cc&&(r=s,this.log(`Live playlist, switching playlist, load frag with next SN: ${r.sn}`))}r||(r=function(e,t){return dn(e,(e=>e.cc<t?1:e.cc>t?-1:0))}(t,n.cc),r&&this.log(`Live playlist, switching playlist, load frag with same CC: ${r.sn}`))}}else{const t=this.hls.liveSyncPosition;null!==t&&(r=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return r}getFragmentAtPosition(e,t,n){const{config:r}=this;let{fragPrevious:i}=this,{fragments:s,endSN:a}=n;const{fragmentHint:o}=n,{maxFragLookUpTolerance:l}=r,c=n.partList,h=!!(r.lowLatencyMode&&null!=c&&c.length&&o);let u;if(h&&o&&!this.bitrateTest&&(s=s.concat(o),a=o.sn),e<t){u=fn(i,s,e,e>t-l?0:l)}else u=s[s.length-1];if(u){const e=u.sn-n.startSN,t=this.fragmentTracker.getState(u);if((t===On||t===Fn&&u.gap)&&(i=u),i&&u.sn===i.sn&&(!h||c[0].fragment.sn>u.sn)){if(i&&u.level===i.level){const t=s[e+1];u=u.sn<a&&this.fragmentTracker.getState(t)!==On?t:null}}}return u}synchronizeToLiveEdge(e){const{config:t,media:n}=this;if(!n)return;const r=this.hls.liveSyncPosition,i=n.currentTime,s=e.fragments[0].start,a=e.edge,o=i>=s-t.maxFragLookUpTolerance&&i<=a;if(null!==r&&n.duration>r&&(i<r||!o)){const s=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!o&&n.readyState<4||i<a-s)&&(this.loadedmetadata||(this.nextLoadPosition=r),n.readyState&&(this.warn(`Playback: ${i.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${r.toFixed(3)}`),n.currentTime=r))}}alignPlaylists(e,t,n){const r=e.fragments.length;if(!r)return this.warn("No fragments in live playlist"),0;const i=e.fragments[0].start,s=!t,a=e.alignedSliding&&p(i);if(s||!a&&!i){const{fragPrevious:i}=this;Vn(i,n,e);const s=e.fragments[0].start;return this.log(`Live playlist sliding: ${s.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${i?i.sn:"na"} fragments: ${r}`),s}return i}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){let n=this.startPosition;if(n<t&&(n=-1),-1===n||-1===this.lastCurrentTime){const r=null!==this.startTimeOffset,i=r?this.startTimeOffset:e.startTimeOffset;null!==i&&p(i)?(n=t+i,i<0&&(n+=e.totalduration),n=Math.min(Math.max(t,n),t+e.totalduration),this.log(`Start time offset ${i} found in ${r?"multivariant":"media"} playlist, adjust startPosition to ${n}`),this.startPosition=n):e.live?n=this.hls.liveSyncPosition||t:this.startPosition=n=0,this.lastCurrentTime=n}this.nextLoadPosition=n}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===cr)||(this.state=ar)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const e=this.getCurrentContext(t.chunkMeta);e&&(t.frag=e.frag)}const n=t.frag;if(!n||n.type!==e||!this.levels)return;var r;if(this.fragContextChanged(n))return void this.warn(`Frag load error must match current frag to retry ${n.url} > ${null==(r=this.fragCurrent)?void 0:r.url}`);const i=t.details===x.FRAG_GAP;i&&this.fragmentTracker.fragBuffered(n,!0);const s=t.errorAction,{action:a,retryCount:o=0,retryConfig:l}=s||{};if(s&&a===pn.RetryRequest&&l){this.resetStartWhenNotLoaded(this.levelLastLoaded);const r=cn(l,o);this.warn(`Fragment ${n.sn} of ${e} ${n.level} errored with ${t.details}, retrying loading ${o+1}/${l.maxNumRetry} in ${r}ms`),s.resolved=!0,this.retryDate=self.performance.now()+r,this.state=cr}else if(l&&s){if(this.resetFragmentErrors(e),!(o<l.maxNumRetry))return void S.warn(`${t.details} reached or exceeded max retry (${o})`);i||a===pn.RemoveAlternatePermanently||(s.resolved=!0)}else(null==s?void 0:s.action)===pn.SendAlternateToPenaltyBox?this.state=pr:this.state=Ar;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===ur||this.state===dr){const t=e.frag,n=e.parent,r=this.getFwdBufferInfo(this.mediaBuffer,n),i=r&&r.len>.5;i&&this.reduceMaxBufferLength(r.len,(null==t?void 0:t.duration)||10);const s=!i;return s&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${n} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),s}return!1}resetFragmentErrors(e){e===_t.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==sr&&(this.state=ar)}afterBufferFlushed(e,t,n){if(!e)return;const r=Gn.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,r,n),this.state===fr&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=ar}resetStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=e?e.details:null;null!=t&&t.live?(this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of level ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,n,r){var i;const s=n.details;if(!s)return void this.warn("level.details undefined");if(!Object.keys(e.elementaryStreams).reduce(((t,i)=>{const a=e.elementaryStreams[i];if(a){const o=a.endPTS-a.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${e.sn} ${i} duration reliably (${o})`),t||!1;const l=r?0:Zt(s,e,a.startPTS,a.endPTS,a.startDTS,a.endDTS);return this.hls.trigger(y.LEVEL_PTS_UPDATED,{details:s,level:n,drift:l,type:i,frag:e,start:a.startPTS,end:a.endPTS}),!0}return t}),!1)&&null===(null==(i=this.transmuxer)?void 0:i.error)){const t=new Error(`Found no media in fragment ${e.sn} of level ${e.level} resetting transmuxer to fallback to playlist timing`);if(0===n.fragmentError&&(n.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(t.message),this.hls.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.FRAG_PARSING_ERROR,fatal:!1,error:t,frag:e,reason:`Found no media in msn ${e.sn} of level "${n.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=dr,this.hls.trigger(y.FRAG_PARSED,{frag:e,part:t})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(e){"demuxerWorker"===e.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}class vr{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let n;return e.length?(n=1===e.length?e[0]:function(e,t){const n=new Uint8Array(t);let r=0;for(let i=0;i<e.length;i++){const t=e[i];n.set(t,r),r+=t.length}return n}(e,t),this.reset(),n):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}function yr(e="",t=9e4){return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class Er{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,n,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,n){}demux(e,t){this.cachedData&&(e=Ne(this.cachedData,e),this.cachedData=null);let n,r=ae(e,0),i=r?r.length:0;const s=this._audioTrack,a=this._id3Track,o=r?ce(r):void 0,l=e.length;for((null===this.basePTS||0===this.frameIndex&&p(o))&&(this.basePTS=xr(o,t,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:Ut.audioId3,duration:Number.POSITIVE_INFINITY});i<l;){if(this.canParse(e,i)){const t=this.appendFrame(s,e,i);t?(this.frameIndex++,this.lastPTS=t.sample.pts,i+=t.length,n=i):i=l}else le(e,i)?(r=ae(e,i),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:Ut.audioId3,duration:Number.POSITIVE_INFINITY}),i+=r.length,n=i):i++;if(i===l&&n!==l){const t=re(e,n);this.cachedData?this.cachedData=Ne(this.cachedData,t):this.cachedData=t}}return{audioTrack:s,videoTrack:yr(),id3Track:a,textTrack:yr()}}demuxSampleAes(e,t,n){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:yr(),id3Track:this._id3Track,textTrack:yr()}}destroy(){}}const xr=(e,t,n)=>{if(p(e))return 90*e;return 9e4*t+(n?9e4*n.baseTime/n.timescale:0)};function Cr(e,t){return 255===e[t]&&240==(246&e[t+1])}function wr(e,t){return 1&e[t+1]?7:9}function Ir(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function br(e,t){return t+1<e.length&&Cr(e,t)}function Sr(e,t){if(br(e,t)){const n=wr(e,t);if(t+n>=e.length)return!1;const r=Ir(e,t);if(r<=n)return!1;const i=t+r;return i===e.length||br(e,i)}return!1}function Br(e,t,n,r,i){if(!e.samplerate){const s=function(e,t,n,r){let i,s,a,o;const l=navigator.userAgent.toLowerCase(),c=r,h=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];i=1+((192&t[n+2])>>>6);const u=(60&t[n+2])>>>2;if(!(u>h.length-1))return a=(1&t[n+2])<<2,a|=(192&t[n+3])>>>6,S.log(`manifest codec:${r}, ADTS type:${i}, samplingIndex:${u}`),/firefox/i.test(l)?u>=6?(i=5,o=new Array(4),s=u-3):(i=2,o=new Array(2),s=u):-1!==l.indexOf("android")?(i=2,o=new Array(2),s=u):(i=5,o=new Array(4),r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&u>=6?s=u-3:((r&&-1!==r.indexOf("mp4a.40.2")&&(u>=6&&1===a||/vivaldi/i.test(l))||!r&&1===a)&&(i=2,o=new Array(2)),s=u)),o[0]=i<<3,o[0]|=(14&u)>>1,o[1]|=(1&u)<<7,o[1]|=a<<3,5===i&&(o[1]|=(14&s)>>1,o[2]=(1&s)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:h[u],channelCount:a,codec:"mp4a.40."+i,manifestCodec:c};{const t=new Error(`invalid ADTS sampling index:${u}`);e.emit(y.ERROR,y.ERROR,{type:E.MEDIA_ERROR,details:x.FRAG_PARSING_ERROR,fatal:!0,error:t,reason:t.message})}}(t,n,r,i);if(!s)return;e.config=s.config,e.samplerate=s.samplerate,e.channelCount=s.channelCount,e.codec=s.codec,e.manifestCodec=s.manifestCodec,S.log(`parsed codec:${e.codec}, rate:${s.samplerate}, channels:${s.channelCount}`)}}function Tr(e){return 9216e4/e}function _r(e,t,n,r,i){const s=r+i*Tr(e.samplerate),a=function(e,t){const n=wr(e,t);if(t+n<=e.length){const r=Ir(e,t)-n;if(r>0)return{headerLength:n,frameLength:r}}}(t,n);let o;if(a){const{frameLength:r,headerLength:i}=a,l=i+r,c=Math.max(0,n+l-t.length);c?(o=new Uint8Array(l-i),o.set(t.subarray(n+i,t.length),0)):o=t.subarray(n+i,n+l);const h={unit:o,pts:s};return c||e.samples.push(h),{sample:h,length:l,missing:c}}const l=t.length-n;o=new Uint8Array(l),o.set(t.subarray(n,t.length),0);return{sample:{unit:o,pts:s},length:l,missing:-1}}let Mr=null;const Rr=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],Dr=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Pr=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Lr=[0,1,1,4];function kr(e,t,n,r,i){if(n+24>t.length)return;const s=Fr(t,n);if(s&&n+s.frameLength<=t.length){const a=r+i*(9e4*s.samplesPerFrame/s.sampleRate),o={unit:t.subarray(n,n+s.frameLength),pts:a,dts:a};return e.config=[],e.channelCount=s.channelCount,e.samplerate=s.sampleRate,e.samples.push(o),{sample:o,length:s.frameLength,missing:0}}}function Fr(e,t){const n=e[t+1]>>3&3,r=e[t+1]>>1&3,i=e[t+2]>>4&15,s=e[t+2]>>2&3;if(1!==n&&0!==i&&15!==i&&3!==s){const a=e[t+2]>>1&1,o=e[t+3]>>6,l=1e3*Rr[14*(3===n?3-r:3===r?3:4)+i-1],c=Dr[3*(3===n?0:2===n?1:2)+s],h=3===o?1:2,u=Pr[n][r],d=Lr[r],f=8*u*d,A=Math.floor(u*l/c+a)*d;if(null===Mr){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Mr=e?parseInt(e[1]):0}return!!Mr&&Mr<=87&&2===r&&l>=224e3&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:c,channelCount:h,frameLength:A,samplesPerFrame:f}}}function Or(e,t){return!(255!==e[t]||224&~e[t+1]||!(6&e[t+1]))}function Ur(e,t){return t+1<e.length&&Or(e,t)}function Qr(e,t){if(t+1<e.length&&Or(e,t)){const n=4,r=Fr(e,t);let i=n;null!=r&&r.frameLength&&(i=r.frameLength);const s=t+i;return s===e.length||Ur(e,s)}return!1}const Nr=/\/emsg[-/]ID3/i;const zr=(e,t)=>{let n=0,r=5;t+=r;const i=new Uint32Array(1),s=new Uint32Array(1),a=new Uint8Array(1);for(;r>0;){a[0]=e[t];const o=Math.min(r,8),l=8-o;s[0]=4278190080>>>24+l<<l,i[0]=(a[0]&s[0])>>l,n=n?n<<o|i[0]:i[0],t+=1,r-=o}return n};class Gr extends Er{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,n){const r=Hr(e,t,n,this.basePTS,this.frameIndex);if(-1!==r){return{sample:e.samples[e.samples.length-1],length:r,missing:0}}}static probe(e){if(!e)return!1;const t=ae(e,0);if(!t)return!1;const n=t.length;return 11===e[n]&&119===e[n+1]&&void 0!==ce(t)&&zr(e,n)<16}}function Hr(e,t,n,r,i){if(n+8>t.length)return-1;if(11!==t[n]||119!==t[n+1])return-1;const s=t[n+4]>>6;if(s>=3)return-1;const a=[48e3,44100,32e3][s],o=63&t[n+4],l=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*o+s];if(n+l>t.length)return-1;const c=t[n+6]>>5;let h=0;2===c?h+=2:(1&c&&1!==c&&(h+=2),4&c&&(h+=2));const u=(t[n+6]<<8|t[n+7])>>12-h&1,d=[2,1,2,3,3,4,4,5][c]+u,f=t[n+5]>>3,A=7&t[n+5],m=new Uint8Array([s<<6|f<<1|A>>2,(3&A)<<6|c<<3|u<<2|o>>4,o<<4&224]),p=r+i*(1536/a*9e4),g=t.subarray(n,n+l);return e.config=m,e.channelCount=d,e.samplerate=a,e.samples.push({unit:g,pts:p}),l}class qr{constructor(){this.VideoSample=null}createVideoSample(e,t,n,r){return{key:e,frame:!1,pts:t,dts:n,units:[],debug:r,length:0}}getLastNalUnit(e){var t;let n,r=this.VideoSample;if(r&&0!==r.units.length||(r=e[e.length-1]),null!=(t=r)&&t.units){const e=r.units;n=e[e.length-1]}return n}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){const n=t.samples,r=n.length;if(!r)return void t.dropped++;{const t=n[r-1];e.pts=t.pts,e.dts=t.dts}}t.samples.push(e)}e.debug.length&&S.log(e.pts+"/"+e.dts+":"+e.debug)}}class Yr{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,n=e.byteLength-t,r=new Uint8Array(4),i=Math.min(4,t);if(0===i)throw new Error("no bytes available");r.set(e.subarray(n,n+i)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*i,this.bytesAvailable-=i}skipBits(e){let t;e=Math.min(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const n=this.word>>>32-t;if(e>32&&S.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return t=e-t,t>0&&this.bitsAvailable?n<<t|this.readBits(t):n}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,n=8,r=8;for(let i=0;i<e;i++)0!==r&&(t=this.readEG(),r=(n+t+256)%256),n=0===r?n:r}readSPS(){let e,t,n,r=0,i=0,s=0,a=0;const o=this.readUByte.bind(this),l=this.readBits.bind(this),c=this.readUEG.bind(this),h=this.readBoolean.bind(this),u=this.skipBits.bind(this),d=this.skipEG.bind(this),f=this.skipUEG.bind(this),A=this.skipScalingList.bind(this);o();const m=o();if(l(5),u(3),o(),f(),100===m||110===m||122===m||244===m||44===m||83===m||86===m||118===m||128===m){const e=c();if(3===e&&u(1),f(),f(),u(1),h())for(t=3!==e?8:12,n=0;n<t;n++)h()&&A(n<6?16:64)}f();const p=c();if(0===p)c();else if(1===p)for(u(1),d(),d(),e=c(),n=0;n<e;n++)d();f(),u(1);const g=c(),v=c(),y=l(1);0===y&&u(1),u(1),h()&&(r=c(),i=c(),s=c(),a=c());let E=[1,1];if(h()&&h()){switch(o()){case 1:E=[1,1];break;case 2:E=[12,11];break;case 3:E=[10,11];break;case 4:E=[16,11];break;case 5:E=[40,33];break;case 6:E=[24,11];break;case 7:E=[20,11];break;case 8:E=[32,11];break;case 9:E=[80,33];break;case 10:E=[18,11];break;case 11:E=[15,11];break;case 12:E=[64,33];break;case 13:E=[160,99];break;case 14:E=[4,3];break;case 15:E=[3,2];break;case 16:E=[2,1];break;case 255:E=[o()<<8|o(),o()<<8|o()]}}return{width:Math.ceil(16*(g+1)-2*r-2*i),height:(2-y)*(v+1)*16-(y?2:4)*(s+a),pixelRatio:E}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class jr extends qr{parseAVCPES(e,t,n,r,i){const s=this.parseAVCNALu(e,n.data);let a,o=this.VideoSample,l=!1;n.data=null,o&&s.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts,"")),s.forEach((r=>{var s;switch(r.type){case 1:{let t=!1;a=!0;const i=r.data;if(l&&i.length>4){const e=new Yr(i).readSliceType();2!==e&&4!==e&&7!==e&&9!==e||(t=!0)}var c;if(t)null!=(c=o)&&c.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null);o||(o=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts,"")),o.frame=!0,o.key=t;break}case 5:a=!0,null!=(s=o)&&s.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts,"")),o.key=!0,o.frame=!0;break;case 6:a=!0,He(r.data,1,n.pts,t.samples);break;case 7:{var h,u;a=!0,l=!0;const t=r.data,n=new Yr(t).readSPS();if(!e.sps||e.width!==n.width||e.height!==n.height||(null==(h=e.pixelRatio)?void 0:h[0])!==n.pixelRatio[0]||(null==(u=e.pixelRatio)?void 0:u[1])!==n.pixelRatio[1]){e.width=n.width,e.height=n.height,e.pixelRatio=n.pixelRatio,e.sps=[t],e.duration=i;const r=t.subarray(1,4);let s="avc1.";for(let e=0;e<3;e++){let t=r[e].toString(16);t.length<2&&(t="0"+t),s+=t}e.codec=s}break}case 8:a=!0,e.pps=[r.data];break;case 9:a=!0,e.audFound=!0,o&&this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts,"");break;case 12:a=!0;break;default:a=!1,o&&(o.debug+="unknown NAL "+r.type+" ")}if(o&&a){o.units.push(r)}})),r&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}parseAVCNALu(e,t){const n=t.byteLength;let r=e.naluState||0;const i=r,s=[];let a,o,l,c=0,h=-1,u=0;for(-1===r&&(h=0,u=31&t[0],r=0,c=1);c<n;)if(a=t[c++],r)if(1!==r)if(a)if(1===a){if(o=c-r-1,h>=0){const e={data:t.subarray(h,o),type:u};s.push(e)}else{const n=this.getLastNalUnit(e.samples);n&&(i&&c<=4-i&&n.state&&(n.data=n.data.subarray(0,n.data.byteLength-i)),o>0&&(n.data=Ne(n.data,t.subarray(0,o)),n.state=0))}c<n?(l=31&t[c],h=c,u=l,r=0):r=-1}else r=0;else r=3;else r=a?0:2;else r=a?0:1;if(h>=0&&r>=0){const e={data:t.subarray(h,n),type:u,state:r};s.push(e)}if(0===s.length){const n=this.getLastNalUnit(e.samples);n&&(n.data=Ne(n.data,t))}return e.naluState=r,s}}class Vr{constructor(e,t,n){this.keyData=void 0,this.decrypter=void 0,this.keyData=n,this.decrypter=new rr(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(e,t,n){const r=e[t].unit;if(r.length<=16)return;const i=r.subarray(16,r.length-r.length%16),s=i.buffer.slice(i.byteOffset,i.byteOffset+i.length);this.decryptBuffer(s).then((i=>{const s=new Uint8Array(i);r.set(s,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,n)}))}decryptAacSamples(e,t,n){for(;;t++){if(t>=e.length)return void n();if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,n),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=16*Math.floor((e.length-48)/160)+16,n=new Int8Array(t);let r=0;for(let i=32;i<e.length-16;i+=160,r+=16)n.set(e.subarray(i,i+16),r);return n}getAvcDecryptedUnit(e,t){const n=new Uint8Array(t);let r=0;for(let i=32;i<e.length-16;i+=160,r+=16)e.set(n.subarray(r,r+16),i);return e}decryptAvcSample(e,t,n,r,i){const s=qe(i.data),a=this.getAvcEncryptedData(s);this.decryptBuffer(a.buffer).then((a=>{i.data=this.getAvcDecryptedUnit(s,a),this.decrypter.isSync()||this.decryptAvcSamples(e,t,n+1,r)}))}decryptAvcSamples(e,t,n,r){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,n=0){if(t>=e.length)return void r();const i=e[t].units;for(;!(n>=i.length);n++){const s=i[n];if(!(s.data.length<=48||1!==s.type&&5!==s.type||(this.decryptAvcSample(e,t,n,r,s),this.decrypter.isSync())))return}}}}const Kr=188;class Wr{constructor(e,t,n){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=n,this.videoParser=new jr}static probe(e){const t=Wr.syncOffset(e);return t>0&&S.warn(`MPEG2-TS detected but first sync word found @ offset ${t}`),-1!==t}static syncOffset(e){const t=e.length;let n=Math.min(940,t-Kr)+1,r=0;for(;r<n;){let i=!1,s=-1,a=0;for(let o=r;o<t;o+=Kr){if(71!==e[o]||t-o!==Kr&&71!==e[o+Kr]){if(a)return-1;break}if(a++,-1===s&&(s=o,0!==s&&(n=Math.min(s+18612,e.length-Kr)+1)),i||(i=0===Jr(e,o)),i&&a>1&&(0===s&&a>2||o+Kr>n))return s}r++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:Ie[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,n,r){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=Wr.createTrack("video"),this._audioTrack=Wr.createTrack("audio",r),this._id3Track=Wr.createTrack("id3"),this._txtTrack=Wr.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=n,this._duration=r}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:n}=this;e&&(e.pesData=null),t&&(t.pesData=null),n&&(n.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,n=!1,r=!1){let i;n||(this.sampleAes=null);const s=this._videoTrack,a=this._audioTrack,o=this._id3Track,l=this._txtTrack;let c=s.pid,h=s.pesData,u=a.pid,d=o.pid,f=a.pesData,A=o.pesData,m=null,p=this.pmtParsed,g=this._pmtId,v=e.length;if(this.remainderData&&(v=(e=Ne(this.remainderData,e)).length,this.remainderData=null),v<Kr&&!r)return this.remainderData=e,{audioTrack:a,videoTrack:s,id3Track:o,textTrack:l};const y=Math.max(0,Wr.syncOffset(e));v-=(v-y)%Kr,v<e.byteLength&&!r&&(this.remainderData=new Uint8Array(e.buffer,v,e.buffer.byteLength-v));let E=0;for(let C=y;C<v;C+=Kr)if(71===e[C]){const t=!!(64&e[C+1]),r=Jr(e,C);let v;if((48&e[C+3])>>4>1){if(v=C+5+e[C+4],v===C+Kr)continue}else v=C+4;switch(r){case c:t&&(h&&(i=ti(h))&&this.videoParser.parseAVCPES(s,l,i,!1,this._duration),h={data:[],size:0}),h&&(h.data.push(e.subarray(v,C+Kr)),h.size+=C+Kr-v);break;case u:if(t){if(f&&(i=ti(f)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,i);break;case"mp3":this.parseMPEGPES(a,i);break;case"ac3":this.parseAC3PES(a,i)}f={data:[],size:0}}f&&(f.data.push(e.subarray(v,C+Kr)),f.size+=C+Kr-v);break;case d:t&&(A&&(i=ti(A))&&this.parseID3PES(o,i),A={data:[],size:0}),A&&(A.data.push(e.subarray(v,C+Kr)),A.size+=C+Kr-v);break;case 0:t&&(v+=e[v]+1),g=this._pmtId=Xr(e,v);break;case g:{t&&(v+=e[v]+1);const r=$r(e,v,this.typeSupported,n,this.observer);c=r.videoPid,c>0&&(s.pid=c,s.segmentCodec=r.segmentVideoCodec),u=r.audioPid,u>0&&(a.pid=u,a.segmentCodec=r.segmentAudioCodec),d=r.id3Pid,d>0&&(o.pid=d),null===m||p||(S.warn(`MPEG-TS PMT found at ${C} after unknown PID '${m}'. Backtracking to sync byte @${y} to parse all TS packets.`),m=null,C=y-188),p=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=r}}else E++;E>0&&Zr(this.observer,new Error(`Found ${E} TS packet/s that do not start with 0x47`)),s.pesData=h,a.pesData=f,o.pesData=A;const x={audioTrack:a,videoTrack:s,id3Track:o,textTrack:l};return r&&this.extractRemainingSamples(x),x}flush(){const{remainderData:e}=this;let t;return this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:n,id3Track:r,textTrack:i}=e,s=n.pesData,a=t.pesData,o=r.pesData;let l;if(s&&(l=ti(s))?(this.videoParser.parseAVCPES(n,i,l,!0,this._duration),n.pesData=null):n.pesData=s,a&&(l=ti(a))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l)}t.pesData=null}else null!=a&&a.size&&S.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;o&&(l=ti(o))?(this.parseID3PES(r,l),r.pesData=null):r.pesData=o}demuxSampleAes(e,t,n){const r=this.demux(e,n,!0,!this.config.progressive),i=this.sampleAes=new Vr(this.observer,this.config,t);return this.decrypt(r,i)}decrypt(e,t){return new Promise((n=>{const{audioTrack:r,videoTrack:i}=e;r.samples&&"aac"===r.segmentCodec?t.decryptAacSamples(r.samples,0,(()=>{i.samples?t.decryptAvcSamples(i.samples,0,0,(()=>{n(e)})):n(e)})):i.samples&&t.decryptAvcSamples(i.samples,0,0,(()=>{n(e)}))}))}destroy(){this._duration=0}parseAACPES(e,t){let n=0;const r=this.aacOverFlow;let i,s,a,o=t.data;if(r){this.aacOverFlow=null;const t=r.missing,i=r.sample.unit.byteLength;if(-1===t)o=Ne(r.sample.unit,o);else{const s=i-t;r.sample.unit.set(o.subarray(0,t),s),e.samples.push(r.sample),n=r.missing}}for(i=n,s=o.length;i<s-1&&!br(o,i);i++);if(i!==n){let e;const t=i<s-1;if(e=t?`AAC PES did not start with ADTS header,offset:${i}`:"No ADTS header found in AAC PES",Zr(this.observer,new Error(e),t),!t)return}if(Br(e,this.observer,o,i,this.audioCodec),void 0!==t.pts)a=t.pts;else{if(!r)return void S.warn("[tsdemuxer]: AAC PES unknown PTS");{const t=Tr(e.samplerate);a=r.sample.pts+t}}let l,c=0;for(;i<s;){if(l=_r(e,o,i,a,c),i+=l.length,l.missing){this.aacOverFlow=l;break}for(c++;i<s-1&&!br(o,i);i++);}}parseMPEGPES(e,t){const n=t.data,r=n.length;let i=0,s=0;const a=t.pts;if(void 0!==a)for(;s<r;)if(Ur(n,s)){const t=kr(e,n,s,a,i);if(!t)break;s+=t.length,i++}else s++;else S.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseAC3PES(e,t){{const n=t.data,r=t.pts;if(void 0===r)return void S.warn("[tsdemuxer]: AC3 PES unknown PTS");const i=n.length;let s,a=0,o=0;for(;o<i&&(s=Hr(e,n,o,r,a++))>0;)o+=s}}parseID3PES(e,t){if(void 0===t.pts)return void S.warn("[tsdemuxer]: ID3 PES unknown PTS");const n=m({},t,{type:this._videoTrack?Ut.emsg:Ut.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(n)}}function Jr(e,t){return((31&e[t+1])<<8)+e[t+2]}function Xr(e,t){return(31&e[t+10])<<8|e[t+11]}function $r(e,t,n,r,i){const s={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<a;){const a=Jr(e,t),o=(15&e[t+3])<<8|e[t+4];switch(e[t]){case 207:if(!r){ei("ADTS AAC");break}case 15:-1===s.audioPid&&(s.audioPid=a);break;case 21:-1===s.id3Pid&&(s.id3Pid=a);break;case 219:if(!r){ei("H.264");break}case 27:-1===s.videoPid&&(s.videoPid=a,s.segmentVideoCodec="avc");break;case 3:case 4:n.mpeg||n.mp3?-1===s.audioPid&&(s.audioPid=a,s.segmentAudioCodec="mp3"):S.log("MPEG audio found, not supported in this browser");break;case 193:if(!r){ei("AC-3");break}case 129:n.ac3?-1===s.audioPid&&(s.audioPid=a,s.segmentAudioCodec="ac3"):S.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===s.audioPid&&o>0){let r=t+5,i=o;for(;i>2;){if(106===e[r])!0!==n.ac3?S.log("AC-3 audio found, not supported in this browser for now"):(s.audioPid=a,s.segmentAudioCodec="ac3");const t=e[r+1]+2;r+=t,i-=t}}break;case 194:case 135:return Zr(i,new Error("Unsupported EC-3 in M2TS found")),s;case 36:return Zr(i,new Error("Unsupported HEVC in M2TS found")),s}t+=o+5}return s}function Zr(e,t,n){S.warn(`parsing error: ${t.message}`),e.emit(y.ERROR,y.ERROR,{type:E.MEDIA_ERROR,details:x.FRAG_PARSING_ERROR,fatal:!1,levelRetry:n,error:t,reason:t.message})}function ei(e){S.log(`${e} with AES-128-CBC encryption found in unencrypted stream`)}function ti(e){let t,n,r,i,s,a=0;const o=e.data;if(!e||0===e.size)return null;for(;o[0].length<19&&o.length>1;)o[0]=Ne(o[0],o[1]),o.splice(1,1);t=o[0];if(1===(t[0]<<16)+(t[1]<<8)+t[2]){if(n=(t[4]<<8)+t[5],n&&n>e.size-6)return null;const l=t[7];192&l&&(i=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2,64&l?(s=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2,i-s>54e5&&(S.warn(`${Math.round((i-s)/9e4)}s delta between PTS and DTS, align them`),i=s)):s=i),r=t[8];let c=r+9;if(e.size<=c)return null;e.size-=c;const h=new Uint8Array(e.size);for(let e=0,n=o.length;e<n;e++){t=o[e];let n=t.byteLength;if(c){if(c>n){c-=n;continue}t=t.subarray(c),n-=c,c=0}h.set(t,a),a+=n}return n&&(n-=r+3),{data:h,pts:i,dts:s,len:n}}return null}class ni{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const ri=Math.pow(2,32)-1;class ii{static init(){let e;for(e in ii.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},ii.types)ii.types.hasOwnProperty(e)&&(ii.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);ii.HDLR_TYPES={video:t,audio:n};const r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),i=new Uint8Array([0,0,0,0,0,0,0,0]);ii.STTS=ii.STSC=ii.STCO=i,ii.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),ii.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),ii.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),ii.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const s=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);ii.FTYP=ii.box(ii.types.ftyp,s,o,s,a),ii.DINF=ii.box(ii.types.dinf,ii.box(ii.types.dref,r))}static box(e,...t){let n=8,r=t.length;const i=r;for(;r--;)n+=t[r].byteLength;const s=new Uint8Array(n);for(s[0]=n>>24&255,s[1]=n>>16&255,s[2]=n>>8&255,s[3]=255&n,s.set(e,4),r=0,n=8;r<i;r++)s.set(t[r],n),n+=t[r].byteLength;return s}static hdlr(e){return ii.box(ii.types.hdlr,ii.HDLR_TYPES[e])}static mdat(e){return ii.box(ii.types.mdat,e)}static mdhd(e,t){t*=e;const n=Math.floor(t/(ri+1)),r=Math.floor(t%(ri+1));return ii.box(ii.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,n>>24,n>>16&255,n>>8&255,255&n,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(e){return ii.box(ii.types.mdia,ii.mdhd(e.timescale,e.duration),ii.hdlr(e.type),ii.minf(e))}static mfhd(e){return ii.box(ii.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?ii.box(ii.types.minf,ii.box(ii.types.smhd,ii.SMHD),ii.DINF,ii.stbl(e)):ii.box(ii.types.minf,ii.box(ii.types.vmhd,ii.VMHD),ii.DINF,ii.stbl(e))}static moof(e,t,n){return ii.box(ii.types.moof,ii.mfhd(e),ii.traf(n,t))}static moov(e){let t=e.length;const n=[];for(;t--;)n[t]=ii.trak(e[t]);return ii.box.apply(null,[ii.types.moov,ii.mvhd(e[0].timescale,e[0].duration)].concat(n).concat(ii.mvex(e)))}static mvex(e){let t=e.length;const n=[];for(;t--;)n[t]=ii.trex(e[t]);return ii.box.apply(null,[ii.types.mvex,...n])}static mvhd(e,t){t*=e;const n=Math.floor(t/(ri+1)),r=Math.floor(t%(ri+1)),i=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,n>>24,n>>16&255,n>>8&255,255&n,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return ii.box(ii.types.mvhd,i)}static sdtp(e){const t=e.samples||[],n=new Uint8Array(4+t.length);let r,i;for(r=0;r<t.length;r++)i=t[r].flags,n[r+4]=i.dependsOn<<4|i.isDependedOn<<2|i.hasRedundancy;return ii.box(ii.types.sdtp,n)}static stbl(e){return ii.box(ii.types.stbl,ii.stsd(e),ii.box(ii.types.stts,ii.STTS),ii.box(ii.types.stsc,ii.STSC),ii.box(ii.types.stsz,ii.STSZ),ii.box(ii.types.stco,ii.STCO))}static avc1(e){let t,n,r,i=[],s=[];for(t=0;t<e.sps.length;t++)n=e.sps[t],r=n.byteLength,i.push(r>>>8&255),i.push(255&r),i=i.concat(Array.prototype.slice.call(n));for(t=0;t<e.pps.length;t++)n=e.pps[t],r=n.byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(n));const a=ii.box(ii.types.avcC,new Uint8Array([1,i[3],i[4],i[5],255,224|e.sps.length].concat(i).concat([e.pps.length]).concat(s))),o=e.width,l=e.height,c=e.pixelRatio[0],h=e.pixelRatio[1];return ii.box(ii.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,ii.box(ii.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),ii.box(ii.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,h>>24,h>>16&255,h>>8&255,255&h])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static audioStsd(e){const t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static mp4a(e){return ii.box(ii.types.mp4a,ii.audioStsd(e),ii.box(ii.types.esds,ii.esds(e)))}static mp3(e){return ii.box(ii.types[".mp3"],ii.audioStsd(e))}static ac3(e){return ii.box(ii.types["ac-3"],ii.audioStsd(e),ii.box(ii.types.dac3,e.config))}static stsd(e){return"audio"===e.type?"mp3"===e.segmentCodec&&"mp3"===e.codec?ii.box(ii.types.stsd,ii.STSD,ii.mp3(e)):"ac3"===e.segmentCodec?ii.box(ii.types.stsd,ii.STSD,ii.ac3(e)):ii.box(ii.types.stsd,ii.STSD,ii.mp4a(e)):ii.box(ii.types.stsd,ii.STSD,ii.avc1(e))}static tkhd(e){const t=e.id,n=e.duration*e.timescale,r=e.width,i=e.height,s=Math.floor(n/(ri+1)),a=Math.floor(n%(ri+1));return ii.box(ii.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,i>>8&255,255&i,0,0]))}static traf(e,t){const n=ii.sdtp(e),r=e.id,i=Math.floor(t/(ri+1)),s=Math.floor(t%(ri+1));return ii.box(ii.types.traf,ii.box(ii.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),ii.box(ii.types.tfdt,new Uint8Array([1,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,s>>24,s>>16&255,s>>8&255,255&s])),ii.trun(e,n.length+16+20+8+16+8+8),n)}static trak(e){return e.duration=e.duration||4294967295,ii.box(ii.types.trak,ii.tkhd(e),ii.mdia(e))}static trex(e){const t=e.id;return ii.box(ii.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const n=e.samples||[],r=n.length,i=12+16*r,s=new Uint8Array(i);let a,o,l,c,h,u;for(t+=8+i,s.set(["video"===e.type?1:0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),a=0;a<r;a++)o=n[a],l=o.duration,c=o.size,h=o.flags,u=o.cts,s.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,c>>>24&255,c>>>16&255,c>>>8&255,255&c,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,61440&h.degradPrio,15&h.degradPrio,u>>>24&255,u>>>16&255,u>>>8&255,255&u],12+16*a);return ii.box(ii.types.trun,s)}static initSegment(e){ii.types||ii.init();const t=ii.moov(e);return Ne(ii.FTYP,t)}}ii.types=void 0,ii.HDLR_TYPES=void 0,ii.STTS=void 0,ii.STSC=void 0,ii.STCO=void 0,ii.STSZ=void 0,ii.VMHD=void 0,ii.SMHD=void 0,ii.STSD=void 0,ii.FTYP=void 0,ii.DINF=void 0;function si(e,t,n=1,r=!1){const i=e*t*n;return r?Math.round(i):i}function ai(e,t=!1){return si(e,1e3,1/9e4,t)}let oi,li=null,ci=null;class hi{constructor(e,t,n,r=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=n,this.ISGenerated=!1,null===li){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);li=e?parseInt(e[1]):0}if(null===ci){const e=navigator.userAgent.match(/Safari\/(\d+)/i);ci=e?parseInt(e[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){S.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){S.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){S.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const n=e[0].pts,r=e.reduce(((e,r)=>{let i=r.pts,s=i-e;return s<-4294967296&&(t=!0,i=ui(i,n),s=i-e),s>0?e:i}),n);return t&&S.debug("PTS rollover detected"),r}remux(e,t,n,r,i,s,a,o){let l,c,h,u,d,f,A=i,m=i;const p=e.pid>-1,g=t.pid>-1,v=t.samples.length,y=e.samples.length>0,E=a&&v>0||v>1;if((!p||y)&&(!g||E)||this.ISGenerated||a){if(this.ISGenerated){var x,C,w,I;const e=this.videoTrackConfig;!e||t.width===e.width&&t.height===e.height&&(null==(x=t.pixelRatio)?void 0:x[0])===(null==(C=e.pixelRatio)?void 0:C[0])&&(null==(w=t.pixelRatio)?void 0:w[1])===(null==(I=e.pixelRatio)?void 0:I[1])||this.resetInitSegment()}else h=this.generateIS(e,t,i,s);const n=this.isVideoContiguous;let r,a=-1;if(E&&(a=function(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}(t.samples),!n&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,a>0){S.warn(`[mp4-remuxer]: Dropped ${a} out of ${v} video samples due to a missing keyframe`);const e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(a),t.dropped+=a,m+=(t.samples[0].pts-e)/t.inputTimeScale,r=m}else-1===a&&(S.warn(`[mp4-remuxer]: No keyframe found out of ${v} video samples`),f=!1);if(this.ISGenerated){if(y&&E){const n=this.getVideoStartPts(t.samples),r=(ui(e.samples[0].pts,n)-n)/t.inputTimeScale;A+=Math.max(0,r),m+=Math.max(0,-r)}if(y){if(e.samplerate||(S.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),h=this.generateIS(e,t,i,s)),c=this.remuxAudio(e,A,this.isAudioContiguous,s,g||E||o===_t.AUDIO?m:void 0),E){const r=c?c.endPTS-c.startPTS:0;t.inputTimeScale||(S.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),h=this.generateIS(e,t,i,s)),l=this.remuxVideo(t,m,n,r)}}else E&&(l=this.remuxVideo(t,m,n,0));l&&(l.firstKeyFrame=a,l.independent=-1!==a,l.firstKeyFramePTS=r)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(n.samples.length&&(d=di(n,i,this._initPTS,this._initDTS)),r.samples.length&&(u=fi(r,i,this._initPTS))),{audio:c,video:l,initSegment:h,independent:f,text:u,id3:d}}generateIS(e,t,n,r){const i=e.samples,s=t.samples,a=this.typeSupported,o={},l=this._initPTS;let c,h,u,d=!l||r,f="audio/mp4";if(d&&(c=h=1/0),e.config&&i.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(f="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3"}o.audio={id:"audio",container:f,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&a.mpeg?new Uint8Array(0):ii.initSegment([e]),metadata:{channelCount:e.channelCount}},d&&(u=e.inputTimeScale,l&&u===l.timescale?d=!1:c=h=i[0].pts-Math.round(u*n))}if(t.sps&&t.pps&&s.length){if(t.timescale=t.inputTimeScale,o.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:ii.initSegment([t]),metadata:{width:t.width,height:t.height}},d)if(u=t.inputTimeScale,l&&u===l.timescale)d=!1;else{const e=this.getVideoStartPts(s),t=Math.round(u*n);h=Math.min(h,ui(s[0].dts,e)-t),c=Math.min(c,e-t)}this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(o).length)return this.ISGenerated=!0,d?(this._initPTS={baseTime:c,timescale:u},this._initDTS={baseTime:h,timescale:u}):c=u=void 0,{tracks:o,initPTS:c,timescale:u}}remuxVideo(e,t,n,r){const i=e.inputTimeScale,s=e.samples,a=[],o=s.length,l=this._initPTS;let c,h,u=this.nextAvcDts,d=8,f=this.videoSampleDuration,A=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,g=!1;if(!n||null===u){const e=t*i,r=s[0].pts-ui(s[0].dts,s[0].pts);li&&null!==u&&Math.abs(e-r-u)<15e3?n=!0:u=e-r}const v=l.baseTime*i/l.timescale;for(let m=0;m<o;m++){const e=s[m];e.pts=ui(e.pts-v,u),e.dts=ui(e.dts-v,u),e.dts<s[m>0?m-1:m].dts&&(g=!0)}g&&s.sort((function(e,t){const n=e.dts-t.dts,r=e.pts-t.pts;return n||r})),c=s[0].dts,h=s[s.length-1].dts;const C=h-c,w=C?Math.round(C/(o-1)):f||e.inputTimeScale/30;if(n){const e=c-u,n=e>w,r=e<-1;if((n||r)&&(n?S.warn(`AVC: ${ai(e,!0)} ms (${e}dts) hole between fragments detected at ${t.toFixed(3)}`):S.warn(`AVC: ${ai(-e,!0)} ms (${e}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!r||u>=s[0].pts||li)){c=u;const t=s[0].pts-e;if(n)s[0].dts=c,s[0].pts=t;else for(let n=0;n<s.length&&!(s[n].dts>t);n++)s[n].dts-=e,s[n].pts-=e;S.log(`Video: Initial PTS/DTS adjusted: ${ai(t,!0)}/${ai(c,!0)}, delta: ${ai(e,!0)} ms`)}}c=Math.max(0,c);let I=0,b=0,B=c;for(let m=0;m<o;m++){const e=s[m],t=e.units,n=t.length;let r=0;for(let i=0;i<n;i++)r+=t[i].data.length;b+=r,I+=n,e.length=r,e.dts<B?(e.dts=B,B+=w/4|0||1):B=e.dts,A=Math.min(e.pts,A),p=Math.max(e.pts,p)}h=s[o-1].dts;const T=b+4*I+8;let _;try{_=new Uint8Array(T)}catch(O){return void this.observer.emit(y.ERROR,y.ERROR,{type:E.MUX_ERROR,details:x.REMUX_ALLOC_ERROR,fatal:!1,error:O,bytes:T,reason:`fail allocating video mdat ${T}`})}const M=new DataView(_.buffer);M.setUint32(0,T),_.set(ii.types.mdat,4);let R=!1,D=Number.POSITIVE_INFINITY,P=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY,k=Number.NEGATIVE_INFINITY;for(let m=0;m<o;m++){const e=s[m],t=e.units;let n,l=0;for(let r=0,i=t.length;r<i;r++){const e=t[r],n=e.data,i=e.data.byteLength;M.setUint32(d,i),d+=4,_.set(n,d),d+=i,l+=4+i}if(m<o-1)f=s[m+1].dts-e.dts,n=s[m+1].pts-e.pts;else{const t=this.config,a=m>0?e.dts-s[m-1].dts:w;if(n=m>0?e.pts-s[m-1].pts:w,t.stretchShortVideoTrack&&null!==this.nextAudioPts){const n=Math.floor(t.maxBufferHole*i),s=(r?A+r*i:this.nextAudioPts)-e.pts;s>n?(f=s-a,f<0?f=a:R=!0,S.log(`[mp4-remuxer]: It is approximately ${s/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=a}else f=a}const c=Math.round(e.pts-e.dts);D=Math.min(D,f),L=Math.max(L,f),P=Math.min(P,n),k=Math.max(k,n),a.push(new Ai(e.key,f,l,c))}if(a.length)if(li){if(li<70){const e=a[0].flags;e.dependsOn=2,e.isNonSync=0}}else if(ci&&k-P<L-D&&w/L<.025&&0===a[0].cts){S.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let e=c;for(let t=0,n=a.length;t<n;t++){const r=e+a[t].duration,i=e+a[t].cts;if(t<n-1){const e=r+a[t+1].cts;a[t].duration=e-i}else a[t].duration=t?a[t-1].duration:w;a[t].cts=0,e=r}}f=R||!f?w:f,this.nextAvcDts=u=h+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const F={data1:ii.moof(e.sequenceNumber++,c,m({},e,{samples:a})),data2:_,startPTS:A/i,endPTS:(p+f)/i,startDTS:c/i,endDTS:u/i,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,F}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(e,t,n,r,i){const s=e.inputTimeScale,a=s/(e.samplerate?e.samplerate:s),o=this.getSamplesPerFrame(e),l=o*a,c=this._initPTS,h="mp3"===e.segmentCodec&&this.typeSupported.mpeg,u=[],d=void 0!==i;let f=e.samples,A=h?0:8,p=this.nextAudioPts||-1;const g=t*s,v=c.baseTime*s/c.timescale;if(this.isAudioContiguous=n=n||f.length&&p>0&&(r&&Math.abs(g-p)<9e3||Math.abs(ui(f[0].pts-v,g)-p)<20*l),f.forEach((function(e){e.pts=ui(e.pts-v,g)})),!n||p<0){if(f=f.filter((e=>e.pts>=0)),!f.length)return;p=0===i?0:r&&!d?Math.max(0,g):f[0].pts}if("aac"===e.segmentCodec){const t=this.config.maxAudioFramesDrift;for(let n=0,r=p;n<f.length;n++){const i=f[n],a=i.pts,o=a-r,c=Math.abs(1e3*o/s);if(o<=-t*l&&d)0===n&&(S.warn(`Audio frame @ ${(a/s).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*o/s)} ms.`),this.nextAudioPts=p=r=a);else if(o>=t*l&&c<1e4&&d){let t=Math.round(o/l);r=a-t*l,r<0&&(t--,r+=l),0===n&&(this.nextAudioPts=p=r),S.warn(`[mp4-remuxer]: Injecting ${t} audio frame @ ${(r/s).toFixed(3)}s due to ${Math.round(1e3*o/s)} ms gap.`);for(let s=0;s<t;s++){const t=Math.max(r,0);let s=ni.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);s||(S.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),s=i.unit.subarray()),f.splice(n,0,{unit:s,pts:t}),r+=l,n++}}i.pts=r,r+=l}}let C,w=null,I=null,b=0,B=f.length;for(;B--;)b+=f[B].unit.byteLength;for(let m=0,S=f.length;m<S;m++){const t=f[m],r=t.unit;let i=t.pts;if(null!==I){u[m-1].duration=Math.round((i-I)/a)}else{if(n&&"aac"===e.segmentCodec&&(i=p),w=i,!(b>0))return;b+=A;try{C=new Uint8Array(b)}catch(L){return void this.observer.emit(y.ERROR,y.ERROR,{type:E.MUX_ERROR,details:x.REMUX_ALLOC_ERROR,fatal:!1,error:L,bytes:b,reason:`fail allocating audio mdat ${b}`})}if(!h){new DataView(C.buffer).setUint32(0,b),C.set(ii.types.mdat,4)}}C.set(r,A);const s=r.byteLength;A+=s,u.push(new Ai(!0,o,s,0)),I=i}const T=u.length;if(!T)return;const _=u[u.length-1];this.nextAudioPts=p=I+a*_.duration;const M=h?new Uint8Array(0):ii.moof(e.sequenceNumber++,w/a,m({},e,{samples:u}));e.samples=[];const R=w/s,D=p/s,P={data1:M,data2:C,startPTS:R,endPTS:D,startDTS:R,endDTS:D,type:"audio",hasAudio:!0,hasVideo:!1,nb:T};return this.isAudioContiguous=!0,P}remuxEmptyAudio(e,t,n,r){const i=e.inputTimeScale,s=i/(e.samplerate?e.samplerate:i),a=this.nextAudioPts,o=this._initDTS,l=9e4*o.baseTime/o.timescale,c=(null!==a?a:r.startDTS*i)+l,h=r.endDTS*i+l,u=1024*s,d=Math.ceil((h-c)/u),f=ni.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(S.warn("[mp4-remuxer]: remux empty Audio"),!f)return void S.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");const A=[];for(let m=0;m<d;m++){const e=c+m*u;A.push({unit:f,pts:e,dts:e})}return e.samples=A,this.remuxAudio(e,t,n,!1)}}function ui(e,t){let n;if(null===t)return e;for(n=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=n;return e}function di(e,t,n,r){const i=e.samples.length;if(!i)return;const s=e.inputTimeScale;for(let o=0;o<i;o++){const i=e.samples[o];i.pts=ui(i.pts-n.baseTime*s/n.timescale,t*s)/s,i.dts=ui(i.dts-r.baseTime*s/r.timescale,t*s)/s}const a=e.samples;return e.samples=[],{samples:a}}function fi(e,t,n){const r=e.samples.length;if(!r)return;const i=e.inputTimeScale;for(let a=0;a<r;a++){const r=e.samples[a];r.pts=ui(r.pts-n.baseTime*i/n.timescale,t*i)/i}e.samples.sort(((e,t)=>e.pts-t.pts));const s=e.samples;return e.samples=[],{samples:s}}class Ai{constructor(e,t,n,r){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=n,this.cts=r,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}function mi(e,t){const n=null==e?void 0:e.codec;if(n&&n.length>4)return n;if(t===P){if("ec-3"===n||"ac-3"===n||"alac"===n)return n;if("fLaC"===n||"Opus"===n){return ht(n,!1)}const e="mp4a.40.5";return S.info(`Parsed audio codec "${n}" or audio object type not handled. Using "${e}"`),e}return S.warn(`Unhandled video codec "${n}"`),"hvc1"===n||"hev1"===n?"hvc1.1.6.L120.90":"av01"===n?"av01.0.04M.08":"avc1.42e01e"}try{oi=self.performance.now.bind(self.performance)}catch(ka){S.debug("Unable to use Performance API on this environment"),oi=null==H?void 0:H.Date.now}const pi=[{demux:class{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,n,r){const i=this.videoTrack=yr("video",1),s=this.audioTrack=yr("audio",1),a=this.txtTrack=yr("text",1);if(this.id3Track=yr("id3",1),this.timeOffset=0,null==e||!e.byteLength)return;const o=Pe(e);if(o.video){const{id:e,timescale:t,codec:n}=o.video;i.id=e,i.timescale=a.timescale=t,i.codec=n}if(o.audio){const{id:e,timescale:t,codec:n}=o.audio;s.id=e,s.timescale=t,s.codec=n}a.id=Ie.text,i.sampleDuration=0,i.duration=s.duration=r}resetContiguity(){this.remainderData=null}static probe(e){return function(e){const t=e.byteLength;for(let n=0;n<t;){const r=Be(e,n);if(r>8&&109===e[n+4]&&111===e[n+5]&&111===e[n+6]&&102===e[n+7])return!0;n=r>1?n+r:t}return!1}(e)}demux(e,t){this.timeOffset=t;let n=e;const r=this.videoTrack,i=this.txtTrack;if(this.config.progressive){this.remainderData&&(n=Ne(this.remainderData,e));const t=function(e){const t={valid:null,remainder:null},n=Re(e,["moof"]);if(n.length<2)return t.remainder=e,t;const r=n[n.length-1];return t.valid=re(e,0,r.byteOffset-8),t.remainder=re(e,r.byteOffset-8),t}(n);this.remainderData=t.remainder,r.samples=t.valid||new Uint8Array}else r.samples=n;const s=this.extractID3Track(r,t);return i.samples=ze(t,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:s,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,n=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const r=this.extractID3Track(t,this.timeOffset);return n.samples=ze(e,t),{videoTrack:t,audioTrack:yr(),id3Track:r,textTrack:yr()}}extractID3Track(e,t){const n=this.id3Track;if(e.samples.length){const r=Re(e.samples,["emsg"]);r&&r.forEach((e=>{const r=function(e){const t=e[0];let n="",r="",i=0,s=0,a=0,o=0,l=0,c=0;if(0===t){for(;"\0"!==be(e.subarray(c,c+1));)n+=be(e.subarray(c,c+1)),c+=1;for(n+=be(e.subarray(c,c+1)),c+=1;"\0"!==be(e.subarray(c,c+1));)r+=be(e.subarray(c,c+1)),c+=1;r+=be(e.subarray(c,c+1)),c+=1,i=Be(e,12),s=Be(e,16),o=Be(e,20),l=Be(e,24),c=28}else if(1===t){c+=4,i=Be(e,c),c+=4;const t=Be(e,c);c+=4;const s=Be(e,c);for(c+=4,a=2**32*t+s,g(a)||(a=Number.MAX_SAFE_INTEGER,S.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=Be(e,c),c+=4,l=Be(e,c),c+=4;"\0"!==be(e.subarray(c,c+1));)n+=be(e.subarray(c,c+1)),c+=1;for(n+=be(e.subarray(c,c+1)),c+=1;"\0"!==be(e.subarray(c,c+1));)r+=be(e.subarray(c,c+1)),c+=1;r+=be(e.subarray(c,c+1)),c+=1}return{schemeIdUri:n,value:r,timeScale:i,presentationTime:a,presentationTimeDelta:s,eventDuration:o,id:l,payload:e.subarray(c,e.byteLength)}}(e);if(Nr.test(r.schemeIdUri)){const e=p(r.presentationTime)?r.presentationTime/r.timeScale:t+r.presentationTimeDelta/r.timeScale;let i=4294967295===r.eventDuration?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;i<=.001&&(i=Number.POSITIVE_INFINITY);const s=r.payload;n.samples.push({data:s,len:s.byteLength,dts:e,pts:e,type:Ut.emsg,duration:i})}}))}return n}demuxSampleAes(e,t,n){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}},remux:class{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,n,r){this.audioCodec=t,this.videoCodec=n,this.generateInitSegment(function(e,t){if(!e||!t)return e;const n=t.keyId;n&&t.isCommonEncryption&&Re(e,["moov","trak"]).forEach((e=>{const t=Re(e,["mdia","minf","stbl","stsd"])[0].subarray(8);let r=Re(t,["enca"]);const i=r.length>0;i||(r=Re(t,["encv"])),r.forEach((e=>{Re(i?e.subarray(28):e.subarray(78),["sinf"]).forEach((e=>{const t=Ue(e);if(t){const e=t.subarray(8,24);e.some((e=>0!==e))||(S.log(`[eme] Patching keyId in 'enc${i?"a":"v"}>sinf>>tenc' box: ${xe(e)} -> ${xe(n)}`),t.set(n,8))}}))}))}));return e}(e,r)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:n}=this;if(null==e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const r=this.initData=Pe(e);r.audio&&(t=mi(r.audio,P)),r.video&&(n=mi(r.video,L));const i={};r.audio&&r.video?i.audiovideo={container:"video/mp4",codec:t+","+n,initSegment:e,id:"main"}:r.audio?i.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:r.video?i.video={container:"video/mp4",codec:n,initSegment:e,id:"main"}:S.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=i}remux(e,t,n,r,i,s){var a,o;let{initPTS:l,lastEndTime:c}=this;const h={audio:void 0,video:void 0,text:r,id3:n,initSegment:void 0};p(c)||(c=this.lastEndTime=i||0);const u=t.samples;if(null==u||!u.length)return h;const d={initPTS:void 0,timescale:1};let f=this.initData;if(null!=(a=f)&&a.length||(this.generateInitSegment(u),f=this.initData),null==(o=f)||!o.length)return S.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),h;this.emitInitSegment&&(d.tracks=this.initTracks,this.emitInitSegment=!1);const A=function(e,t){let n=0,r=0,i=0;const s=Re(e,["moof","traf"]);for(let a=0;a<s.length;a++){const e=s[a],o=Re(e,["tfhd"])[0],l=t[Be(o,4)];if(!l)continue;const c=l.default,h=Be(o,0)|(null==c?void 0:c.flags);let u=null==c?void 0:c.duration;8&h&&(u=Be(o,2&h?12:8));const d=l.timescale||9e4,f=Re(e,["trun"]);for(let t=0;t<f.length;t++)n=Qe(f[t]),!n&&u&&(n=u*Be(f[t],4)),l.type===L?r+=n/d:l.type===P&&(i+=n/d)}if(0===r&&0===i){let t=1/0,n=0,r=0;const i=Re(e,["sidx"]);for(let e=0;e<i.length;e++){const s=De(i[e]);if(null!=s&&s.references){t=Math.min(t,s.earliestPresentationTime/s.timescale);const e=s.references.reduce(((e,t)=>e+t.info.duration||0),0);n=Math.max(n,e+s.earliestPresentationTime/s.timescale),r=n-t}}if(r&&p(r))return r}return r||i}(u,f),m=function(e,t){return Re(t,["moof","traf"]).reduce(((t,n)=>{const r=Re(n,["tfdt"])[0],i=r[0],s=Re(n,["tfhd"]).reduce(((t,n)=>{const s=Be(n,4),a=e[s];if(a){let e=Be(r,4);if(1===i){if(e===Ce)return S.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),t;e*=Ce+1,e+=Be(r,8)}const n=e/(a.timescale||9e4);if(p(n)&&(null===t||n<t))return n}return t}),null);return null!==s&&p(s)&&(null===t||s<t)?s:t}),null)}(f,u),g=null===m?i:m;(function(e,t,n,r){if(null===e)return!0;const i=Math.max(r,1),s=t-e.baseTime/e.timescale;return Math.abs(s-n)>i}(l,g,i,A)||d.timescale!==l.timescale&&s)&&(d.initPTS=g-i,l&&1===l.timescale&&S.warn("Adjusting initPTS by "+(d.initPTS-l.baseTime)),this.initPTS=l={baseTime:d.initPTS,timescale:1});const v=e?g-l.baseTime/l.timescale:c,y=v+A;!function(e,t,n){Re(t,["moof","traf"]).forEach((t=>{Re(t,["tfhd"]).forEach((r=>{const i=Be(r,4),s=e[i];if(!s)return;const a=s.timescale||9e4;Re(t,["tfdt"]).forEach((e=>{const t=e[0],r=n*a;if(r){let n=Be(e,4);if(0===t)n-=r,n=Math.max(n,0),Me(e,4,n);else{n*=Math.pow(2,32),n+=Be(e,8),n-=r,n=Math.max(n,0);const t=Math.floor(n/(Ce+1)),i=Math.floor(n%(Ce+1));Me(e,4,t),Me(e,8,i)}}}))}))}))}(f,u,l.baseTime/l.timescale),A>0?this.lastEndTime=y:(S.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const E=!!f.audio,x=!!f.video;let C="";E&&(C+="audio"),x&&(C+="video");const w={data1:u,startPTS:v,startDTS:v,endPTS:y,endDTS:y,type:C,hasAudio:E,hasVideo:x,nb:1,dropped:0};return h.audio="audio"===w.type?w:void 0,h.video="audio"!==w.type?w:void 0,h.initSegment=d,h.id3=di(n,i,l,l),r.samples.length&&(h.text=fi(r,i,l)),h}}},{demux:Wr,remux:hi},{demux:class extends Er{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=ae(e,0);let n=(null==t?void 0:t.length)||0;if(Qr(e,n))return!1;for(let r=e.length;n<r;n++)if(Sr(e,n))return S.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return function(e,t){return t+5<e.length}(e,t)&&Cr(e,t)&&Ir(e,t)<=e.length-t}(e,t)}appendFrame(e,t,n){Br(e,this.observer,t,n,e.manifestCodec);const r=_r(e,t,n,this.basePTS,this.frameIndex);if(r&&0===r.missing)return r}},remux:hi},{demux:class extends Er{resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=ae(e,0);let n=(null==t?void 0:t.length)||0;if(t&&11===e[n]&&119===e[n+1]&&void 0!==ce(t)&&zr(e,n)<=16)return!1;for(let r=e.length;n<r;n++)if(Qr(e,n))return S.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return Or(e,t)&&4<=e.length-t}(e,t)}appendFrame(e,t,n){if(null!==this.basePTS)return kr(e,t,n,this.basePTS,this.frameIndex)}},remux:hi}];pi.splice(2,0,{demux:Gr,remux:hi});class gi{constructor(e,t,n,r,i){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=n,this.vendor=r,this.id=i}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,n,r){const i=n.transmuxing;i.executeStart=oi();let s=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:o}=this;r&&(this.currentTransmuxState=r);const{contiguous:l,discontinuity:c,trackSwitch:h,accurateTimeOffset:u,timeOffset:d,initSegmentChange:f}=r||a,{audioCodec:A,videoCodec:m,defaultInitPts:p,duration:g,initSegmentData:v}=o,C=function(e,t){let n=null;e.byteLength>0&&null!=(null==t?void 0:t.key)&&null!==t.iv&&null!=t.method&&(n=t);return n}(s,t);if(C&&"AES-128"===C.method){const e=this.getDecrypter();if(!e.isSync())return this.decryptionPromise=e.webCryptoDecrypt(s,C.key.buffer,C.iv.buffer).then((e=>{const t=this.push(e,null,n);return this.decryptionPromise=null,t})),this.decryptionPromise;{let t=e.softwareDecrypt(s,C.key.buffer,C.iv.buffer);if(n.part>-1&&(t=e.flush()),!t)return i.executeEnd=oi(),vi(n);s=new Uint8Array(t)}}const w=this.needsProbing(c,h);if(w){const e=this.configureTransmuxer(s);if(e)return S.warn(`[transmuxer] ${e.message}`),this.observer.emit(y.ERROR,y.ERROR,{type:E.MEDIA_ERROR,details:x.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),i.executeEnd=oi(),vi(n)}(c||h||f||w)&&this.resetInitSegment(v,A,m,g,t),(c||f||w)&&this.resetInitialTimestamp(p),l||this.resetContiguity();const I=this.transmux(s,C,d,u,n),b=this.currentTransmuxState;return b.contiguous=!0,b.discontinuity=!1,b.trackSwitch=!1,i.executeEnd=oi(),I}flush(e){const t=e.transmuxing;t.executeStart=oi();const{decrypter:n,currentTransmuxState:r,decryptionPromise:i}=this;if(i)return i.then((()=>this.flush(e)));const s=[],{timeOffset:a}=r;if(n){const t=n.flush();t&&s.push(this.push(t,null,e))}const{demuxer:o,remuxer:l}=this;if(!o||!l)return t.executeEnd=oi(),[vi(e)];const c=o.flush(a);return yi(c)?c.then((t=>(this.flushRemux(s,t,e),s))):(this.flushRemux(s,c,e),s)}flushRemux(e,t,n){const{audioTrack:r,videoTrack:i,id3Track:s,textTrack:a}=t,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;S.log(`[transmuxer.ts]: Flushed fragment ${n.sn}${n.part>-1?" p: "+n.part:""} of level ${n.level}`);const c=this.remuxer.remux(r,i,s,a,l,o,!0,this.id);e.push({remuxResult:c,chunkMeta:n}),n.transmuxing.executeEnd=oi()}resetInitialTimestamp(e){const{demuxer:t,remuxer:n}=this;t&&n&&(t.resetTimeStamp(e),n.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,n,r,i){const{demuxer:s,remuxer:a}=this;s&&a&&(s.resetInitSegment(e,t,n,r),a.resetInitSegment(e,t,n,i))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,n,r,i){let s;return s=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,n,r,i):this.transmuxUnencrypted(e,n,r,i),s}transmuxUnencrypted(e,t,n,r){const{audioTrack:i,videoTrack:s,id3Track:a,textTrack:o}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(i,s,a,o,t,n,!1,this.id),chunkMeta:r}}transmuxSampleAes(e,t,n,r,i){return this.demuxer.demuxSampleAes(e,t,n).then((e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,n,r,!1,this.id),chunkMeta:i})))}configureTransmuxer(e){const{config:t,observer:n,typeSupported:r,vendor:i}=this;let s;for(let u=0,d=pi.length;u<d;u++){var a;if(null!=(a=pi[u].demux)&&a.probe(e)){s=pi[u];break}}if(!s)return new Error("Failed to find demuxer by probing fragment data");const o=this.demuxer,l=this.remuxer,c=s.remux,h=s.demux;l&&l instanceof c||(this.remuxer=new c(n,t,r,i)),o&&o instanceof h||(this.demuxer=new h(n,t,r),this.probe=h.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new rr(this.config)),e}}const vi=e=>({remuxResult:{},chunkMeta:e});function yi(e){return"then"in e&&e.then instanceof Function}class Ei{constructor(e,t,n,r,i){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=n,this.duration=r,this.defaultInitPts=i||null}}class xi{constructor(e,t,n,r,i,s){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=n,this.trackSwitch=r,this.timeOffset=i,this.initSegmentChange=s}}var Ci={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,r,s,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new i(r,s||e,a),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,s=r.length,a=new Array(s);i<s;i++)a[i]=r[i].fn;return a},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,i,s,a){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,h=this._events[o],u=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),u){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,r),!0;case 4:return h.fn.call(h.context,t,r,i),!0;case 5:return h.fn.call(h.context,t,r,i,s),!0;case 6:return h.fn.call(h.context,t,r,i,s,a),!0}for(c=1,l=new Array(u-1);c<u;c++)l[c-1]=arguments[c];h.fn.apply(h.context,l)}else{var d,f=h.length;for(c=0;c<f;c++)switch(h[c].once&&this.removeListener(e,h[c].fn,void 0,!0),u){case 1:h[c].fn.call(h[c].context);break;case 2:h[c].fn.call(h[c].context,t);break;case 3:h[c].fn.call(h[c].context,t,r);break;case 4:h[c].fn.call(h[c].context,t,r,i);break;default:if(!l)for(d=1,l=new Array(u-1);d<u;d++)l[d-1]=arguments[d];h[c].fn.apply(h[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,i){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return a(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||i&&!o.once||r&&o.context!==r||a(this,s);else{for(var l=0,c=[],h=o.length;l<h;l++)(o[l].fn!==t||i&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[s]=1===c.length?c[0]:c:a(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(Ci);var wi=r(Ci.exports);class Ii{constructor(e,t,n,r){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const i=e.config;this.hls=e,this.id=t,this.useWorker=!!i.enableWorker,this.onTransmuxComplete=n,this.onFlush=r;const s=(e,t)=>{(t=t||{}).frag=this.frag,t.id=this.id,e===y.ERROR&&(this.error=t.error),this.hls.trigger(e,t)};this.observer=new wi,this.observer.on(y.FRAG_DECRYPTED,s),this.observer.on(y.ERROR,s);const a=tt(i.preferManagedMediaSource)||{isTypeSupported:()=>!1},o={mpeg:a.isTypeSupported("audio/mpeg"),mp3:a.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:a.isTypeSupported('audio/mp4; codecs="ac-3"')};if(this.useWorker&&"undefined"!=typeof Worker){if(i.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__){try{i.workerPath?(S.log(`loading Web Worker ${i.workerPath} for "${t}"`),this.workerContext=function(e){const t=new self.URL(e,self.location.href).href;return{worker:new self.Worker(t),scriptURL:t}}(i.workerPath)):(S.log(`injecting Web Worker for "${t}"`),this.workerContext=function(){const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e);return{worker:new self.Worker(t),objectURL:t}}()),this.onwmsg=e=>this.onWorkerMessage(e);const{worker:e}=this.workerContext;e.addEventListener("message",this.onwmsg),e.onerror=e=>{const n=new Error(`${e.message}  (${e.filename}:${e.lineno})`);i.enableWorker=!1,S.warn(`Error in "${t}" Web Worker, fallback to inline`),this.hls.trigger(y.ERROR,{type:E.OTHER_ERROR,details:x.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:n})},e.postMessage({cmd:"init",typeSupported:o,vendor:"",id:t,config:JSON.stringify(i)})}catch(ka){S.warn(`Error setting up "${t}" Web Worker, fallback to inline`,ka),this.resetWorker(),this.error=null,this.transmuxer=new gi(this.observer,o,i,"",t)}return}}this.transmuxer=new gi(this.observer,o,i,"",t)}resetWorker(){if(this.workerContext){const{worker:e,objectURL:t}=this.workerContext;t&&self.URL.revokeObjectURL(t),e.removeEventListener("message",this.onwmsg),e.onerror=null,e.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(e,t,n,r,i,s,a,o,l,c){var h,u;l.transmuxing.start=self.performance.now();const{transmuxer:d}=this,f=s?s.start:i.start,A=i.decryptdata,m=this.frag,p=!(m&&i.cc===m.cc),g=!(m&&l.level===m.level),v=m?l.sn-m.sn:-1,y=this.part?l.part-this.part.index:-1,E=0===v&&l.id>1&&l.id===(null==m?void 0:m.stats.chunkCount),x=!g&&(1===v||0===v&&(1===y||E&&y<=0)),C=self.performance.now();(g||v||0===i.stats.parsing.start)&&(i.stats.parsing.start=C),!s||!y&&x||(s.stats.parsing.start=C);const w=!(m&&(null==(h=i.initSegment)?void 0:h.url)===(null==(u=m.initSegment)?void 0:u.url)),I=new xi(p,x,o,g,f,w);if(!x||p||w){S.log(`[transmuxer-interface, ${i.type}]: Starting new transmux session for sn: ${l.sn} p: ${l.part} level: ${l.level} id: ${l.id}\n        discontinuity: ${p}\n        trackSwitch: ${g}\n        contiguous: ${x}\n        accurateTimeOffset: ${o}\n        timeOffset: ${f}\n        initSegmentChange: ${w}`);const e=new Ei(n,r,t,a,c);this.configureTransmuxer(e)}if(this.frag=i,this.part=s,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:A,chunkMeta:l,state:I},e instanceof ArrayBuffer?[e]:[]);else if(d){const t=d.push(e,A,l,I);yi(t)?(d.async=!0,t.then((e=>{this.handleTransmuxComplete(e)})).catch((e=>{this.transmuxerError(e,l,"transmuxer-interface push error")}))):(d.async=!1,this.handleTransmuxComplete(t))}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(t){let n=t.flush(e);yi(n)||t.async?(yi(n)||(n=Promise.resolve(n)),n.then((t=>{this.handleFlushResult(t,e)})).catch((t=>{this.transmuxerError(t,e,"transmuxer-interface flush error")}))):this.handleFlushResult(n,e)}}transmuxerError(e,t,n){this.hls&&(this.error=e,this.hls.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,fatal:!1,error:e,err:e,reason:n}))}handleFlushResult(e,t){e.forEach((e=>{this.handleTransmuxComplete(e)})),this.onFlush(t)}onWorkerMessage(e){const t=e.data;if(null==t||!t.event)return void S.warn("worker message received with no "+(t?"event name":"data"));const n=this.hls;if(this.hls)switch(t.event){case"init":{var r;const e=null==(r=this.workerContext)?void 0:r.objectURL;e&&self.URL.revokeObjectURL(e);break}case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;case"workerLog":S[t.data.logType]&&S[t.data.logType](t.data.message);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,n.trigger(t.event,t.data)}}configureTransmuxer(e){const{transmuxer:t}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}class bi extends gr{constructor(e,t,n){super(e,t,n,"[audio-stream-controller]",_t.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(y.ERROR,this.onError,this),e.on(y.BUFFER_RESET,this.onBufferReset,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(y.ERROR,this.onError,this),e.off(y.BUFFER_RESET,this.onBufferReset,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(e,{frag:t,id:n,initPTS:r,timescale:i}){if("main"===n){const e=t.cc;this.initPTS[t.cc]={baseTime:r,timescale:i},this.log(`InitPTS for cc: ${e} found from main: ${r}`),this.videoTrackCC=e,this.state===mr&&this.tick()}}startLoad(e){if(!this.levels)return this.startPosition=e,void(this.state=sr);const t=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),t>0&&-1===e?(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t,this.state=ar):(this.loadedmetadata=!1,this.state=hr),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}doTick(){switch(this.state){case ar:this.doTickIdle();break;case hr:{var e;const{levels:t,trackId:n}=this,r=null==t||null==(e=t[n])?void 0:e.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=mr}break}case cr:{var t;const e=performance.now(),n=this.retryDate;if(!n||e>=n||null!=(t=this.media)&&t.seeking){const{levels:e,trackId:t}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==e?void 0:e[t])||null),this.state=ar}break}case mr:{const e=this.waitingData;if(e){const{frag:t,part:n,cache:r,complete:i}=e;if(void 0!==this.initPTS[t.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=lr;const e={frag:t,part:n,payload:r.flush(),networkDetails:null};this._handleFragmentLoadProgress(e),i&&super._handleFragmentLoadComplete(e)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${t.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const e=this.getLoadPosition(),n=Gn.bufferInfo(this.mediaBuffer,e,this.config.maxBufferHole);An(n.end,this.config.maxFragLookUpTolerance,t)<0&&(this.log(`Waiting fragment cc (${t.cc}) @ ${t.start} cancelled because another fragment at ${n.end} is needed`),this.clearWaitingFragment())}}else this.state=ar}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=ar)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;null!=e&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){const{hls:e,levels:t,media:n,trackId:r}=this,i=e.config;if(!this.buffering||!n&&(this.startFragRequested||!i.startFragPrefetch)||null==t||!t[r])return;const s=t[r],a=s.details;if(!a||a.live&&this.levelLastLoaded!==s||this.waitForCdnTuneIn(a))return void(this.state=hr);const o=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&o&&(this.bufferFlushed=!1,this.afterBufferFlushed(o,P,_t.AUDIO));const l=this.getFwdBufferInfo(o,_t.AUDIO);if(null===l)return;if(!this.switchingTrack&&this._streamEnded(l,a))return e.trigger(y.BUFFER_EOS,{type:"audio"}),void(this.state=fr);const c=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,_t.MAIN),h=l.len,u=this.getMaxBufferLength(null==c?void 0:c.len),d=a.fragments,f=d[0].start,A=this.getLoadPosition(),m=this.flushing?A:l.end;if(this.switchingTrack&&n){const e=A;a.PTSKnown&&e<f&&(l.end>f||l.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),n.currentTime=f+.05)}if(h>=u&&!this.switchingTrack&&m<d[d.length-1].start)return;let p=this.getNextFragment(m,a),g=!1;if(p&&this.isLoopLoading(p,m)&&(g=!!p.gap,p=this.getNextFragmentLoopLoading(p,a,l,_t.MAIN,u)),!p)return void(this.bufferFlushed=!0);const v=c&&p.start>c.end+a.targetduration;if(v||(null==c||!c.len)&&l.len){const e=this.getAppendedFrag(p.start,_t.MAIN);if(null===e)return;if(g||(g=!!e.gap||!!v&&0===c.len),v&&!g||g&&l.nextStart&&l.nextStart<e.end)return}this.loadFragment(p,s,m)}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map((e=>new Jt(e)))}onAudioTrackSwitching(e,t){const n=!!t.url;this.trackId=t.id;const{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),n?this.setInterval(100):this.resetTransmuxer(),n?(this.switchingTrack=t,this.state=ar,this.flushAudioIfNeeded(t)):(this.switchingTrack=null,this.bufferedTrack=t,this.state=sr),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(e,t){this.mainDetails=t.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(y.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(e,t){var n;if(null==this.mainDetails)return void(this.cachedTrackLoadedData=t);const{levels:r}=this,{details:i,id:s}=t;if(!r)return void this.warn(`Audio tracks were reset while loading level ${s}`);this.log(`Audio track ${s} loaded [${i.startSN},${i.endSN}]${i.lastPartSn?`[part-${i.lastPartSn}-${i.lastPartIndex}]`:""},duration:${i.totalduration}`);const a=r[s];let o=0;if(i.live||null!=(n=a.details)&&n.live){this.checkLiveUpdate(i);const e=this.mainDetails;if(i.deltaUpdateFailed||!e)return;var l;if(!a.details&&i.hasProgramDateTime&&e.hasProgramDateTime)Kn(i,e),o=i.fragments[0].start;else o=this.alignPlaylists(i,a.details,null==(l=this.levelLastLoaded)?void 0:l.details)}a.details=i,this.levelLastLoaded=a,this.startFragRequested||!this.mainDetails&&i.live||this.setStartPosition(this.mainDetails||i,o),this.state!==hr||this.waitForCdnTuneIn(i)||(this.state=ar),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:n,part:r,payload:i}=e,{config:s,trackId:a,levels:o}=this;if(!o)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);const l=o[a];if(!l)return void this.warn("Audio track is undefined on fragment load progress");const c=l.details;if(!c)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(n.start);const h=s.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let u=this.transmuxer;u||(u=this.transmuxer=new Ii(this.hls,_t.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const d=this.initPTS[n.cc],f=null==(t=n.initSegment)?void 0:t.data;if(void 0!==d){const e=!1,t=r?r.index:-1,s=-1!==t,a=new Hn(n.level,n.sn,n.stats.chunkCount,i.byteLength,t,s);u.push(i,f,h,"",n,r,c.totalduration,e,a,d)}else{this.log(`Unknown video PTS for cc ${n.cc}, waiting for video PTS before demuxing audio frag ${n.sn} of [${c.startSN} ,${c.endSN}],track ${a}`);const{cache:e}=this.waitingData=this.waitingData||{frag:n,part:r,cache:new vr,complete:!1};e.push(new Uint8Array(i)),this.waitingVideoCC=this.videoTrackCC,this.state=mr}}_handleFragmentLoadComplete(e){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(e,t){const n=t.tracks.audio;n&&(this.mediaBuffer=n.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)}onFragBuffered(e,t){const{frag:n,part:r}=t;if(n.type===_t.AUDIO)if(this.fragContextChanged(n))this.warn(`Fragment ${n.sn}${r?" p: "+r.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if("initSegment"!==n.sn){this.fragPrevious=n;const e=this.switchingTrack;e&&(this.bufferedTrack=e,this.switchingTrack=null,this.hls.trigger(y.AUDIO_TRACK_SWITCHED,d({},e)))}this.fragBufferedComplete(n,r)}else if(!this.loadedmetadata&&n.type===_t.MAIN){const e=this.videoBuffer||this.media;if(e){Gn.getBuffered(e).length&&(this.loadedmetadata=!0)}}}onError(e,t){var n;if(t.fatal)this.state=Ar;else switch(t.details){case x.FRAG_GAP:case x.FRAG_PARSING_ERROR:case x.FRAG_DECRYPT_ERROR:case x.FRAG_LOAD_ERROR:case x.FRAG_LOAD_TIMEOUT:case x.KEY_LOAD_ERROR:case x.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(_t.AUDIO,t);break;case x.AUDIO_TRACK_LOAD_ERROR:case x.AUDIO_TRACK_LOAD_TIMEOUT:case x.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==hr||(null==(n=t.context)?void 0:n.type)!==Bt||(this.state=ar);break;case x.BUFFER_APPEND_ERROR:case x.BUFFER_FULL_ERROR:if(!t.parent||"audio"!==t.parent)return;if(t.details===x.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case x.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onBufferFlushing(e,{type:t}){t!==L&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==L){this.flushing=!1,this.bufferFlushed=!0,this.state===fr&&(this.state=ar);const e=this.mediaBuffer||this.media;e&&(this.afterBufferFlushed(e,t,_t.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const n="audio",{hls:r}=this,{remuxResult:i,chunkMeta:s}=e,a=this.getCurrentContext(s);if(!a)return void this.resetWhenMissingContext(s);const{frag:o,part:l,level:c}=a,{details:h}=c,{audio:u,text:d,id3:f,initSegment:A}=i;if(!this.fragContextChanged(o)&&h){if(this.state=ur,this.switchingTrack&&u&&this.completeAudioSwitch(this.switchingTrack),null!=A&&A.tracks){const e=o.initSegment||o;this._bufferInitSegment(c,A.tracks,e,s),r.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:n,tracks:A.tracks})}if(u){const{startPTS:e,endPTS:t,startDTS:n,endDTS:r}=u;l&&(l.elementaryStreams[P]={startPTS:e,endPTS:t,startDTS:n,endDTS:r}),o.setElementaryStreamInfo(P,e,t,n,r),this.bufferFragmentData(u,o,l,s)}if(null!=f&&null!=(t=f.samples)&&t.length){const e=m({id:n,frag:o,details:h},f);r.trigger(y.FRAG_PARSING_METADATA,e)}if(d){const e=m({id:n,frag:o,details:h},d);r.trigger(y.FRAG_PARSING_USERDATA,e)}}else this.fragmentTracker.removeFragment(o)}_bufferInitSegment(e,t,n,r){if(this.state!==ur)return;t.video&&delete t.video;const i=t.audio;if(!i)return;i.id="audio";const s=e.audioCodec;this.log(`Init audio buffer, container:${i.container}, codecs[level/parsed]=[${s}/${i.codec}]`),s&&1===s.split(",").length&&(i.levelCodec=s),this.hls.trigger(y.BUFFER_CODECS,t);const a=i.initSegment;if(null!=a&&a.byteLength){const e={type:"audio",frag:n,part:null,chunkMeta:r,parent:n.type,data:a};this.hls.trigger(y.BUFFER_APPENDING,e)}this.tickImmediate()}loadFragment(e,t,n){const r=this.fragmentTracker.getState(e);var i;if(this.fragCurrent=e,this.switchingTrack||r===Ln||r===Fn)if("initSegment"===e.sn)this._loadInitSegment(e,t);else if(null!=(i=t.details)&&i.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=mr;const n=this.mainDetails;n&&n.fragments[0].start!==t.details.fragments[0].start&&Kn(t.details,n)}else this.startFragRequested=!0,super.loadFragment(e,t,n);else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:n,assocLang:r,characteristics:i,audioCodec:s,channels:a}=this.bufferedTrack;_n({name:t,lang:n,assocLang:r,characteristics:i,audioCodec:s,channels:a},e,Mn)||(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(y.AUDIO_TRACK_SWITCHED,d({},e))}}function Si(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Bi(e[n].attrs,t[n].attrs))return!1;return!0}function Bi(e,t,n){const r=e["STABLE-RENDITION-ID"];return r&&!n?r===t["STABLE-RENDITION-ID"]:!(n||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some((n=>e[n]!==t[n]))}function Ti(e,t){return t.label.toLowerCase()===e.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(e.lang||"").toLowerCase())}class _i extends yn{constructor(e){super(e,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(y.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:n,groupId:r,details:i}=t,s=this.tracksInGroup[n];if(!s||s.groupId!==r)return void this.warn(`Audio track with id:${n} and group:${r} not found in active group ${null==s?void 0:s.groupId}`);const a=s.details;s.details=t.details,this.log(`Audio track ${n} "${s.name}" lang:${s.lang} group:${r} loaded [${i.startSN}-${i.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const n=t.audioGroups||null,r=this.groupIds;let i=this.currentTrack;if(!n||(null==r?void 0:r.length)!==(null==n?void 0:n.length)||null!=n&&n.some((e=>-1===(null==r?void 0:r.indexOf(e))))){this.groupIds=n,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter((e=>!n||-1!==n.indexOf(e.groupId)));if(e.length)this.selectDefaultTrack&&!e.some((e=>e.default))&&(this.selectDefaultTrack=!1),e.forEach(((e,t)=>{e.id=t}));else if(!i&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.audioPreference;if(!i&&t){const n=Tn(t,e,Mn);if(n>-1)i=e[n];else{const e=Tn(t,this.tracks);i=this.tracks[e]}}let r=this.findTrackId(i);-1===r&&i&&(r=this.findTrackId(null));const a={audioTracks:e};this.log(`Updating audio tracks, ${e.length} track(s) found in group(s): ${null==n?void 0:n.join(",")}`),this.hls.trigger(y.AUDIO_TRACKS_UPDATED,a);const o=this.trackId;if(-1!==r&&-1===o)this.setAudioTrack(r);else if(e.length&&-1===o){var s;const t=new Error(`No audio track selected for current audio group-ID(s): ${null==(s=this.groupIds)?void 0:s.join(",")} track count: ${e.length}`);this.warn(t.message),this.hls.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:t})}}else this.shouldReloadPlaylist(i)&&this.setAudioTrack(this.trackId)}onError(e,t){!t.fatal&&t.context&&(t.context.type!==Bt||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||(this.requestScheduled=-1,this.checkRetry(t)))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const n=this.allAudioTracks;if(this.selectDefaultTrack=!1,n.length){const r=this.currentTrack;if(r&&_n(e,r,Mn))return r;const i=Tn(e,this.tracksInGroup,Mn);if(i>-1){const e=this.tracksInGroup[i];return this.setAudioTrack(i),e}if(r){let r=t.loadLevel;-1===r&&(r=t.firstAutoLevel);const i=function(e,t,n,r,i){const s=t[r],a=t.reduce(((e,t,n)=>{const r=t.uri;return(e[r]||(e[r]=[])).push(n),e}),{})[s.uri];a.length>1&&(r=Math.max.apply(Math,a));const o=s.videoRange,l=s.frameRate,c=s.codecSet.substring(0,4),h=Rn(t,r,(t=>{if(t.videoRange!==o||t.frameRate!==l||t.codecSet.substring(0,4)!==c)return!1;const r=t.audioGroups,s=n.filter((e=>!r||-1!==r.indexOf(e.groupId)));return Tn(e,s,i)>-1}));return h>-1?h:Rn(t,r,(t=>{const r=t.audioGroups,s=n.filter((e=>!r||-1!==r.indexOf(e.groupId)));return Tn(e,s,i)>-1}))}(e,t.levels,n,r,Mn);if(-1===i)return null;t.nextLoadLevel=i}if(e.channels||e.audioCodec){const t=Tn(e,n);if(t>-1)return n[t]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length)return void this.warn(`Invalid audio track id: ${e}`);this.clearTimer(),this.selectDefaultTrack=!1;const n=this.currentTrack,r=t[e],i=r.details&&!r.details.live;if(e===this.trackId&&r===n&&i)return;if(this.log(`Switching to audio-track ${e} "${r.name}" lang:${r.lang} group:${r.groupId} channels:${r.channels}`),this.trackId=e,this.currentTrack=r,this.hls.trigger(y.AUDIO_TRACK_SWITCHING,d({},r)),i)return;const s=this.switchParams(r.url,null==n?void 0:n.details,r.details);this.loadPlaylist(s)}findTrackId(e){const t=this.tracksInGroup;for(let n=0;n<t.length;n++){const r=t[n];if((!this.selectDefaultTrack||r.default)&&(!e||_n(e,r,Mn)))return n}if(e){const{name:n,lang:r,assocLang:i,characteristics:s,audioCodec:a,channels:o}=e;for(let e=0;e<t.length;e++){if(_n({name:n,lang:r,assocLang:i,characteristics:s,audioCodec:a,channels:o},t[e],Mn))return e}for(let l=0;l<t.length;l++){const n=t[l];if(Bi(e.attrs,n.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return l}for(let l=0;l<t.length;l++){const n=t[l];if(Bi(e.attrs,n.attrs,["LANGUAGE"]))return l}}return-1}loadPlaylist(e){const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){super.loadPlaylist();const r=t.id,i=t.groupId;let s=t.url;if(e)try{s=e.addDirectives(s)}catch(n){this.warn(`Could not construct new URL with HLS Delivery Directives: ${n}`)}this.log(`loading audio-track playlist ${r} "${t.name}" lang:${t.lang} group:${i}`),this.clearTimer(),this.hls.trigger(y.AUDIO_TRACK_LOADING,{url:s,id:r,groupId:i,deliveryDirectives:e||null})}}}class Mi extends gr{constructor(e,t,n){super(e,t,n,"[subtitle-stream-controller]",_t.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.ERROR,this.onError,this),e.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.ERROR,this.onError,this),e.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(e){this.stopLoad(),this.state=ar,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:n,success:r}=t;if(this.fragPrevious=n,this.state=ar,!r)return;const i=this.tracksBuffered[this.currentTrackId];if(!i)return;let s;const a=n.start;for(let l=0;l<i.length;l++)if(a>=i[l].start&&a<=i[l].end){s=i[l];break}const o=n.start+n.duration;s?s.end=o:(s={start:a,end:o},i.push(s)),this.fragmentTracker.fragBuffered(n),this.fragBufferedComplete(n,null)}onBufferFlushing(e,t){const{startOffset:n,endOffset:r}=t;if(0===n&&r!==Number.POSITIVE_INFINITY){const e=r-1;if(e<=0)return;t.endOffsetSubtitles=Math.max(0,e),this.tracksBuffered.forEach((t=>{for(let n=0;n<t.length;)if(t[n].end<=e)t.shift();else{if(!(t[n].start<e))break;t[n].start=e,n++}})),this.fragmentTracker.removeFragmentsInRange(n,e,_t.SUBTITLE)}}onFragBuffered(e,t){var n;this.loadedmetadata||t.frag.type!==_t.MAIN||null!=(n=this.media)&&n.buffered.length&&(this.loadedmetadata=!0)}onError(e,t){const n=t.frag;(null==n?void 0:n.type)===_t.SUBTITLE&&(t.details===x.FRAG_GAP&&this.fragmentTracker.fragBuffered(n,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==sr&&(this.state=ar))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){this.levels&&Si(this.levels,t)?this.levels=t.map((e=>new Jt(e))):(this.tracksBuffered=[],this.levels=t.map((e=>{const t=new Jt(e);return this.tracksBuffered[t.id]=[],t})),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,_t.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(e,t){var n;if(this.currentTrackId=t.id,null==(n=this.levels)||!n.length||-1===this.currentTrackId)return void this.clearInterval();const r=this.levels[this.currentTrackId];null!=r&&r.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,r&&this.setInterval(500)}onSubtitleTrackLoaded(e,t){var n;const{currentTrackId:r,levels:i}=this,{details:s,id:a}=t;if(!i)return void this.warn(`Subtitle tracks were reset while loading level ${a}`);const o=i[a];if(a>=i.length||!o)return;this.log(`Subtitle track ${a} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(s.live||null!=(n=o.details)&&n.live){const e=this.mainDetails;if(s.deltaUpdateFailed||!e)return;const t=e.fragments[0];var c;if(o.details)l=this.alignPlaylists(s,o.details,null==(c=this.levelLastLoaded)?void 0:c.details),0===l&&t&&(l=t.start,nn(s,l));else s.hasProgramDateTime&&e.hasProgramDateTime?(Kn(s,e),l=s.fragments[0].start):t&&(l=t.start,nn(s,l))}if(o.details=s,this.levelLastLoaded=o,a===r&&(this.startFragRequested||!this.mainDetails&&s.live||this.setStartPosition(this.mainDetails||s,l),this.tick(),s.live&&!this.fragCurrent&&this.media&&this.state===ar)){fn(null,s.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0)}}_handleFragmentLoadComplete(e){const{frag:t,payload:n}=e,r=t.decryptdata,i=this.hls;if(!this.fragContextChanged(t)&&n&&n.byteLength>0&&null!=r&&r.key&&r.iv&&"AES-128"===r.method){const e=performance.now();this.decrypter.decrypt(new Uint8Array(n),r.key.buffer,r.iv.buffer).catch((e=>{throw i.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e})).then((n=>{const r=performance.now();i.trigger(y.FRAG_DECRYPTED,{frag:t,payload:n,stats:{tstart:e,tdecrypt:r}})})).catch((e=>{this.warn(`${e.name}: ${e.message}`),this.state=ar}))}}doTick(){if(this.media){if(this.state===ar){const{currentTrackId:e,levels:t}=this,n=null==t?void 0:t[e];if(!n||!t.length||!n.details)return;const{config:r}=this,i=this.getLoadPosition(),s=Gn.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],i,r.maxBufferHole),{end:a,len:o}=s,l=this.getFwdBufferInfo(this.media,_t.MAIN),c=n.details;if(o>this.getMaxBufferLength(null==l?void 0:l.len)+c.levelTargetDuration)return;const h=c.fragments,u=h.length,d=c.edge;let f=null;const A=this.fragPrevious;if(a<d){const e=r.maxFragLookUpTolerance,t=a>d-e?0:e;f=fn(A,h,Math.max(h[0].start,a),t),!f&&A&&A.start<h[0].start&&(f=h[0])}else f=h[u-1];if(!f)return;if(f=this.mapToInitFragWhenRequired(f),"initSegment"!==f.sn){const e=h[f.sn-c.startSN-1];e&&e.cc===f.cc&&this.fragmentTracker.getState(e)===Ln&&(f=e)}this.fragmentTracker.getState(f)===Ln&&this.loadFragment(f,n,a)}}else this.state=ar}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.max(t,e):t}loadFragment(e,t,n){this.fragCurrent=e,"initSegment"===e.sn?this._loadInitSegment(e,t):(this.startFragRequested=!0,super.loadFragment(e,t,n))}get mediaBufferTimeRanges(){return new Ri(this.tracksBuffered[this.currentTrackId]||[])}}class Ri{constructor(e){this.buffered=void 0;const t=(t,n,r)=>{if((n>>>=0)>r-1)throw new DOMException(`Failed to execute '${t}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${r})`);return e[n][t]};this.buffered={get length(){return e.length},end:n=>t("end",n,e.length),start:n=>t("start",n,e.length)}}}class Di extends yn{constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const t=Ot(this.media.textTracks);for(let r=0;r<t.length;r++)if("hidden"===t[r].mode)e=t[r];else if("showing"===t[r].mode){e=t[r];break}const n=this.findTrackForTextTrack(e);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(y.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);Ot(this.media.textTracks).forEach((e=>{kt(e)})),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:n,groupId:r,details:i}=t,s=this.tracksInGroup[n];if(!s||s.groupId!==r)return void this.warn(`Subtitle track with id:${n} and group:${r} not found in active group ${null==s?void 0:s.groupId}`);const a=s.details;s.details=t.details,this.log(`Subtitle track ${n} "${s.name}" lang:${s.lang} group:${r} loaded [${i.startSN}-${i.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const n=t.subtitleGroups||null,r=this.groupIds;let i=this.currentTrack;if(!n||(null==r?void 0:r.length)!==(null==n?void 0:n.length)||null!=n&&n.some((e=>-1===(null==r?void 0:r.indexOf(e))))){this.groupIds=n,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter((e=>!n||-1!==n.indexOf(e.groupId)));if(e.length)this.selectDefaultTrack&&!e.some((e=>e.default))&&(this.selectDefaultTrack=!1),e.forEach(((e,t)=>{e.id=t}));else if(!i&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.subtitlePreference;if(!i&&t){this.selectDefaultTrack=!1;const n=Tn(t,e);if(n>-1)i=e[n];else{const e=Tn(t,this.tracks);i=this.tracks[e]}}let r=this.findTrackId(i);-1===r&&i&&(r=this.findTrackId(null));const s={subtitleTracks:e};this.log(`Updating subtitle tracks, ${e.length} track(s) found in "${null==n?void 0:n.join(",")}" group-id`),this.hls.trigger(y.SUBTITLE_TRACKS_UPDATED,s),-1!==r&&-1===this.trackId&&this.setSubtitleTrack(r)}else this.shouldReloadPlaylist(i)&&this.setSubtitleTrack(this.trackId)}findTrackId(e){const t=this.tracksInGroup,n=this.selectDefaultTrack;for(let r=0;r<t.length;r++){const i=t[r];if((!n||i.default)&&(n||e)&&(!e||_n(i,e)))return r}if(e){for(let n=0;n<t.length;n++){const r=t[n];if(Bi(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const r=t[n];if(Bi(e.attrs,r.attrs,["LANGUAGE"]))return n}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let n=0;n<t.length;n++){if(Ti(t[n],e))return n}}return-1}onError(e,t){!t.fatal&&t.context&&(t.context.type!==Tt||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const n=this.currentTrack;if(n&&_n(e,n))return n;const r=Tn(e,this.tracksInGroup);if(r>-1){const e=this.tracksInGroup[r];return this.setSubtitleTrack(r),e}if(n)return null;{const n=Tn(e,t);if(n>-1)return t[n]}}}return null}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){const r=t.id,i=t.groupId;let s=t.url;if(e)try{s=e.addDirectives(s)}catch(n){this.warn(`Could not construct new URL with HLS Delivery Directives: ${n}`)}this.log(`Loading subtitle playlist for id ${r}`),this.hls.trigger(y.SUBTITLE_TRACK_LOADING,{url:s,id:r,groupId:i,deliveryDirectives:e||null})}}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=Ot(e.textTracks),n=this.currentTrack;let r;if(n&&(r=t.filter((e=>Ti(n,e)))[0],r||this.warn(`Unable to find subtitle TextTrack with name "${n.name}" and language "${n.lang}"`)),[].slice.call(t).forEach((e=>{"disabled"!==e.mode&&e!==r&&(e.mode="disabled")})),r){const e=this.subtitleDisplay?"showing":"hidden";r.mode!==e&&(r.mode=e)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=e);if(e<-1||e>=t.length||!p(e))return void this.warn(`Invalid subtitle track id: ${e}`);this.clearTimer(),this.selectDefaultTrack=!1;const n=this.currentTrack,r=t[e]||null;if(this.trackId=e,this.currentTrack=r,this.toggleTrackModes(),!r)return void this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:e});const i=!!r.details&&!r.details.live;if(e===this.trackId&&r===n&&i)return;this.log(`Switching to subtitle-track ${e}`+(r?` "${r.name}" lang:${r.lang} group:${r.groupId}`:""));const{id:s,groupId:a="",name:o,type:l,url:c}=r;this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:s,groupId:a,name:o,type:l,url:c});const h=this.switchParams(r.url,null==n?void 0:n.details,r.details);this.loadPlaylist(h)}}class Pi{constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t,n){const r=this.queues[t];r.push(e),1!==r.length||n||this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const n=new Promise((e=>{t=e})),r={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(r,e),n}executeNext(e){const t=this.queues[e];if(t.length){const r=t[0];try{r.execute()}catch(n){S.warn(`[buffer-operation-queue]: Exception executing "${e}" SourceBuffer operation: ${n}`),r.onError(n);const t=this.buffers[e];null!=t&&t.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}const Li=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class ki{constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=e=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=e=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:e,mediaSource:t}=this;this.log("Media source opened"),e&&(e.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(y.MEDIA_ATTACHED,{media:e,mediaSource:t})),t&&t.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:e,_objectUrl:t}=this;e!==t&&S.error(`Media element src was set while attaching MediaSource (${t} > ${e})`)},this.hls=e;const t="[buffer-controller]";var n;this.appendSource=(n=tt(e.config.preferManagedMediaSource),"undefined"!=typeof self&&n===self.ManagedMediaSource),this.log=S.log.bind(S,t),this.warn=S.warn.bind(S,t),this.error=S.error.bind(S,t),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.BUFFER_RESET,this.onBufferReset,this),e.on(y.BUFFER_APPENDING,this.onBufferAppending,this),e.on(y.BUFFER_CODECS,this.onBufferCodecs,this),e.on(y.BUFFER_EOS,this.onBufferEos,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(y.FRAG_PARSED,this.onFragParsed,this),e.on(y.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.BUFFER_RESET,this.onBufferReset,this),e.off(y.BUFFER_APPENDING,this.onBufferAppending,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.BUFFER_EOS,this.onBufferEos,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(y.FRAG_PARSED,this.onFragParsed,this),e.off(y.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new Pi(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){let n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=n,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(e,t){const n=this.media=t.media,r=tt(this.appendSource);if(n&&r){var i;const e=this.mediaSource=new r;this.log(`created media source: ${null==(i=e.constructor)?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming));const t=this._objectUrl=self.URL.createObjectURL(e);if(this.appendSource)try{n.removeAttribute("src");const r=self.ManagedMediaSource;n.disableRemotePlayback=n.disableRemotePlayback||r&&e instanceof r,Fi(n),function(e,t){const n=self.document.createElement("source");n.type="video/mp4",n.src=t,e.appendChild(n)}(n,t),n.load()}catch(s){n.src=t}else n.src=t;n.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:n}=this;if(t){if(this.log("media source detaching"),"open"===t.readyState)try{t.endOfStream()}catch(ka){this.warn(`onMediaDetaching: ${ka.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.removeEventListener("startstreaming",this._onStartStreaming),t.removeEventListener("endstreaming",this._onEndStreaming)),e&&(e.removeEventListener("emptied",this._onMediaEmptied),n&&self.URL.revokeObjectURL(n),this.mediaSrc===n?(e.removeAttribute("src"),this.appendSource&&Fi(e),e.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(y.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((e=>{this.resetBuffer(e)})),this._initSourceBuffer(),this.hls.resumeBuffering()}resetBuffer(e){const t=this.sourceBuffer[e];try{var n;if(t)this.removeBufferListeners(e),this.sourceBuffer[e]=void 0,null!=(n=this.mediaSource)&&n.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(t)}catch(ka){this.warn(`onBufferReset ${e}`,ka)}}onBufferCodecs(e,t){const n=this.getSourceBufferTypes().length,r=Object.keys(t);if(r.forEach((e=>{if(n){const n=this.tracks[e];if(n&&"function"==typeof n.buffer.changeType){var r;const{id:i,codec:s,levelCodec:a,container:o,metadata:l}=t[e],c=ut(n.codec,n.levelCodec),h=null==c?void 0:c.replace(Li,"$1");let u=ut(s,a);const d=null==(r=u)?void 0:r.replace(Li,"$1");if(u&&h!==d){"audio"===e.slice(0,5)&&(u=ht(u,this.appendSource));const t=`${o};codecs=${u}`;this.appendChangeType(e,t),this.log(`switching codec ${c} to ${u}`),this.tracks[e]={buffer:n.buffer,codec:s,container:o,levelCodec:a,metadata:l,id:i}}}}else this.pendingTracks[e]=t[e]})),n)return;const i=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==i&&(this.log(`${i} bufferCodec event(s) expected ${r.join(",")}`),this.bufferCodecEventsExpected=i),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}appendChangeType(e,t){const{operationQueue:n}=this,r={execute:()=>{const r=this.sourceBuffer[e];r&&(this.log(`changing ${e} sourceBuffer type to ${t}`),r.changeType(t)),n.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{this.warn(`Failed to change ${e} SourceBuffer type`,t)}};n.append(r,e,!!this.pendingTracks[e])}onBufferAppending(e,t){const{hls:n,operationQueue:r,tracks:i}=this,{data:s,type:a,frag:o,part:l,chunkMeta:c}=t,h=c.buffering[a],u=self.performance.now();h.start=u;const d=o.stats.buffering,f=l?l.stats.buffering:null;0===d.start&&(d.start=u),f&&0===f.start&&(f.start=u);const A=i.audio;let m=!1;"audio"===a&&"audio/mpeg"===(null==A?void 0:A.container)&&(m=!this.lastMpegAudioChunk||1===c.id||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const p=o.start,g={execute:()=>{if(h.executeStart=self.performance.now(),m){const e=this.sourceBuffer[a];if(e){const t=p-e.timestampOffset;Math.abs(t)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${p} (delta: ${t}) sn: ${o.sn})`),e.timestampOffset=p)}}this.appendExecutor(s,a)},onStart:()=>{},onComplete:()=>{const e=self.performance.now();h.executeEnd=h.end=e,0===d.first&&(d.first=e),f&&0===f.first&&(f.first=e);const{sourceBuffer:t}=this,n={};for(const r in t)n[r]=Gn.getBuffered(t[r]);this.appendErrors[a]=0,"audio"===a||"video"===a?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(y.BUFFER_APPENDED,{type:a,frag:o,part:l,chunkMeta:c,parent:o.type,timeRanges:n})},onError:e=>{const t={type:E.MEDIA_ERROR,parent:o.type,details:x.BUFFER_APPEND_ERROR,sourceBufferName:a,frag:o,part:l,chunkMeta:c,error:e,err:e,fatal:!1};if(e.code===DOMException.QUOTA_EXCEEDED_ERR)t.details=x.BUFFER_FULL_ERROR;else{const e=++this.appendErrors[a];t.details=x.BUFFER_APPEND_ERROR,this.warn(`Failed ${e}/${n.config.appendErrorMaxRetry} times to append segment in "${a}" sourceBuffer`),e>=n.config.appendErrorMaxRetry&&(t.fatal=!0)}n.trigger(y.ERROR,t)}};r.append(g,a,!!this.pendingTracks[a])}onBufferFlushing(e,t){const{operationQueue:n}=this,r=e=>({execute:this.removeExecutor.bind(this,e,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(y.BUFFER_FLUSHED,{type:e})},onError:t=>{this.warn(`Failed to remove from ${e} SourceBuffer`,t)}});t.type?n.append(r(t.type),t.type):this.getSourceBufferTypes().forEach((e=>{n.append(r(e),e)}))}onFragParsed(e,t){const{frag:n,part:r}=t,i=[],s=r?r.elementaryStreams:n.elementaryStreams;s[k]?i.push("audiovideo"):(s[P]&&i.push("audio"),s[L]&&i.push("video"));0===i.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${n.type} level: ${n.level} sn: ${n.sn}`),this.blockBuffers((()=>{const e=self.performance.now();n.stats.buffering.end=e,r&&(r.stats.buffering.end=e);const t=r?r.stats:n.stats;this.hls.trigger(y.FRAG_BUFFERED,{frag:n,part:r,stats:t,id:n.type})}),i)}onFragChanged(e,t){this.trimBuffers()}onBufferEos(e,t){this.getSourceBufferTypes().reduce(((e,n)=>{const r=this.sourceBuffer[n];return!r||t.type&&t.type!==n||(r.ending=!0,r.ended||(r.ended=!0,this.log(`${n} sourceBuffer now EOS`))),e&&!(r&&!r.ended)}),!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers((()=>{this.getSourceBufferTypes().forEach((e=>{const t=this.sourceBuffer[e];t&&(t.ending=!1)}));const{mediaSource:e}=this;e&&"open"===e.readyState?(this.log("Calling mediaSource.endOfStream()"),e.endOfStream()):e&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${e.readyState}`)})))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:e,details:t,media:n}=this;if(!n||null===t)return;if(!this.getSourceBufferTypes().length)return;const r=e.config,i=n.currentTime,s=t.levelTargetDuration,a=t.live&&null!==r.liveBackBufferLength?r.liveBackBufferLength:r.backBufferLength;if(p(a)&&a>0){const e=Math.max(a,s),t=Math.floor(i/s)*s-e;this.flushBackBuffer(i,s,t)}if(p(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){const e=Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),t=Math.max(e,s),n=Math.floor(i/s)*s+t;this.flushFrontBuffer(i,s,n)}}flushBackBuffer(e,t,n){const{details:r,sourceBuffer:i}=this;this.getSourceBufferTypes().forEach((s=>{const a=i[s];if(a){const i=Gn.getBuffered(a);if(i.length>0&&n>i.start(0)){if(this.hls.trigger(y.BACK_BUFFER_REACHED,{bufferEnd:n}),null!=r&&r.live)this.hls.trigger(y.LIVE_BACK_BUFFER_REACHED,{bufferEnd:n});else if(a.ended&&i.end(i.length-1)-e<2*t)return void this.log(`Cannot flush ${s} back buffer while SourceBuffer is in ended state`);this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:n,type:s})}}}))}flushFrontBuffer(e,t,n){const{sourceBuffer:r}=this;this.getSourceBufferTypes().forEach((i=>{const s=r[i];if(s){const r=Gn.getBuffered(s),a=r.length;if(a<2)return;const o=r.start(a-1),l=r.end(a-1);if(n>o||e>=o&&e<=l)return;if(s.ended&&e-l<2*t)return void this.log(`Cannot flush ${i} front buffer while SourceBuffer is in ended state`);this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:o,endOffset:1/0,type:i})}}))}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;const{details:e,hls:t,media:n,mediaSource:r}=this,i=e.fragments[0].start+e.totalduration,s=n.duration,a=p(r.duration)?r.duration:0;e.live&&t.config.liveDurationInfinity?(r.duration=1/0,this.updateSeekableRange(e)):(i>a&&i>s||!p(s))&&(this.log(`Updating Media Source duration to ${i.toFixed(3)}`),r.duration=i)}updateSeekableRange(e){const t=this.mediaSource,n=e.fragments;if(n.length&&e.live&&null!=t&&t.setLiveSeekableRange){const r=Math.max(0,n[0].start),i=Math.max(r,r+e.totalduration);this.log(`Media Source duration is set to ${t.duration}. Setting seekable range to ${r}-${i}.`),t.setLiveSeekableRange(r,i)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:n}=this,r=Object.keys(n).length;if(r&&(!e||2===r||"audiovideo"in n)){this.createSourceBuffers(n),this.pendingTracks={};const e=this.getSourceBufferTypes();if(e.length)this.hls.trigger(y.BUFFER_CREATED,{tracks:this.tracks}),e.forEach((e=>{t.executeNext(e)}));else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:n}=this;if(!n)throw Error("createSourceBuffers called when mediaSource was null");for(const i in e)if(!t[i]){var r;const s=e[i];if(!s)throw Error(`source buffer exists for track ${i}, however track does not`);let a=-1===(null==(r=s.levelCodec)?void 0:r.indexOf(","))?s.levelCodec:s.codec;a&&"audio"===i.slice(0,5)&&(a=ht(a,this.appendSource));const o=`${s.container};codecs=${a}`;this.log(`creating sourceBuffer(${o})`);try{const e=t[i]=n.addSourceBuffer(o),r=i;this.addBufferListener(r,"updatestart",this._onSBUpdateStart),this.addBufferListener(r,"updateend",this._onSBUpdateEnd),this.addBufferListener(r,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(r,"bufferedchange",((e,t)=>{const n=t.removedRanges;null!=n&&n.length&&this.hls.trigger(y.BUFFER_FLUSHED,{type:i})})),this.tracks[i]={buffer:e,codec:a,container:s.container,levelCodec:s.levelCodec,metadata:s.metadata,id:s.id}}catch(ka){this.error(`error while trying to add sourceBuffer: ${ka.message}`),this.hls.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:ka,sourceBufferName:i,mimeType:o})}}}get mediaSrc(){var e,t;const n=(null==(e=this.media)||null==(t=e.querySelector)?void 0:t.call(e,"source"))||this.media;return null==n?void 0:n.src}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){var t;if("closed"===(null==(t=this.mediaSource)?void 0:t.readyState))return void this.resetBuffer(e);const{operationQueue:n}=this;n.current(e).onComplete(),n.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){var n;const r=new Error(`${e} SourceBuffer error. MediaSource readyState: ${null==(n=this.mediaSource)?void 0:n.readyState}`);this.error(`${r}`,t),this.hls.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:r,fatal:!1});const i=this.operationQueue.current(e);i&&i.onError(r)}removeExecutor(e,t,n){const{media:r,mediaSource:i,operationQueue:s,sourceBuffer:a}=this,o=a[e];if(!r||!i||!o)return this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),void s.shiftAndExecuteNext(e);const l=p(r.duration)?r.duration:1/0,c=p(i.duration)?i.duration:1/0,h=Math.max(0,t),u=Math.min(n,l,c);u>h&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${h},${u}] from the ${e} SourceBuffer`),o.remove(h,u)):s.shiftAndExecuteNext(e)}appendExecutor(e,t){const n=this.sourceBuffer[t];if(n)n.ended=!1,n.appendBuffer(e);else if(!this.pendingTracks[t])throw new Error(`Attempting to append to the ${t} SourceBuffer, but it does not exist`)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(e);const{operationQueue:n}=this,r=t.map((e=>n.appendBlocker(e)));Promise.all(r).then((()=>{e(),t.forEach((e=>{const t=this.sourceBuffer[e];null!=t&&t.updating||n.shiftAndExecuteNext(e)}))}))}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,n){const r=this.sourceBuffer[e];if(!r)return;const i=n.bind(this,e);this.listeners[e].push({event:t,listener:i}),r.addEventListener(t,i)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach((e=>{t.removeEventListener(e.event,e.listener)}))}}function Fi(e){const t=e.querySelectorAll("source");[].slice.call(t).forEach((t=>{e.removeChild(t)}))}const Oi={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Ui=e=>String.fromCharCode(Oi[e]||e),Qi=15,Ni=100,zi={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Gi={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Hi={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},qi={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Yi=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class ji{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const n="function"==typeof t?t():t;S.log(`${this.time} [${e}] ${n}`)}}}const Vi=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].toString(16));return t};class Ki{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let n=0;n<t.length;n++){const r=t[n];e.hasOwnProperty(r)&&(this[r]=e[r])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Wi{constructor(){this.uchar=" ",this.penState=new Ki}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class Ji{constructor(e){this.chars=[],this.pos=0,this.currPenState=new Ki,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<Ni;t++)this.chars.push(new Wi);this.logger=e}equals(e){for(let t=0;t<Ni;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<Ni;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<Ni;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Ni&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Ni)}moveCursor(e){const t=this.pos+e;if(e>1)for(let n=this.pos+1;n<t+1;n++)this.chars[n].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=Ui(e);this.pos>=Ni?this.logger.log(0,(()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!")):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<Ni;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let n=0;n<Ni;n++){const r=this.chars[n].uchar;" "!==r&&(t=!1),e.push(r)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e);this.chars[this.pos].setPenState(this.currPenState)}}class Xi{constructor(e){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Qi;t++)this.rows.push(new Ji(e));this.logger=e}reset(){for(let e=0;e<Qi;e++)this.rows[e].clear();this.currRow=14}equals(e){let t=!0;for(let n=0;n<Qi;n++)if(!this.rows[n].equals(e.rows[n])){t=!1;break}return t}copy(e){for(let t=0;t<Qi;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Qi;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e);this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,(()=>"pacData = "+JSON.stringify(e)));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let t=0;t<Qi;t++)this.rows[t].clear();const e=this.currRow+1-this.nrRollUpRows,n=this.lastOutputScreen;if(n){const r=n.rows[e].cueStartTime,i=this.logger.time;if(null!==r&&null!==i&&r<i)for(let s=0;s<this.nrRollUpRows;s++)this.rows[t-this.nrRollUpRows+s+1].copy(n.rows[e+s])}}this.currRow=t;const n=this.rows[this.currRow];if(null!==e.indent){const t=e.indent,r=Math.max(t-1,0);n.setCursor(e.indent),e.color=n.chars[r].penState.foreground}const r={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(r)}setBkgData(e){this.logger.log(2,(()=>"bkgData = "+JSON.stringify(e))),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,(()=>this.getDisplayText()));const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let n="",r=-1;for(let i=0;i<Qi;i++){const n=this.rows[i].getTextString();n&&(r=i+1,e?t.push("Row "+r+": '"+n+"'"):t.push(n.trim()))}return t.length>0&&(n=e?"["+t.join(" | ")+"]":t.join("\n")),n}getTextAndFormat(){return this.rows}}class $i{constructor(e,t,n){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Xi(n),this.nonDisplayedMemory=new Xi(n),this.lastOutputScreen=new Xi(n),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=n}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,(()=>"MODE="+e)),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let n=0;n<e.length;n++)this.writeScreen.insertChar(e[n]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,(()=>t+": "+this.writeScreen.getDisplayText(!0))),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,(()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0))),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,(()=>"DISP: "+this.displayedMemory.getDisplayText()))}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{const n=Math.floor(e/2)-16,r=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=r[n]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;null!==t&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class Zi{constructor(e,t,n){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;const r=this.logger=new ji;this.channels=[null,new $i(e,t,r),new $i(e+1,n,r)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let n=0;n<t.length;n+=2){const e=127&t[n],r=127&t[n+1];let i=!1,s=null;if(0===e&&0===r)continue;this.logger.log(3,(()=>"["+Vi([t[n],t[n+1]])+"] -> ("+Vi([e,r])+")"));const a=this.cmdHistory;if(e>=16&&e<=31){if(ts(e,r,a)){es(null,null,a),this.logger.log(3,(()=>"Repeated command ("+Vi([e,r])+") is dropped"));continue}es(e,r,this.cmdHistory),i=this.parseCmd(e,r),i||(i=this.parseMidrow(e,r)),i||(i=this.parsePAC(e,r)),i||(i=this.parseBackgroundAttributes(e,r))}else es(null,null,a);if(!i&&(s=this.parseChars(e,r),s)){const e=this.currentChannel;if(e&&e>0){this.channels[e].insertChars(s)}else this.logger.log(2,"No channel found yet. TEXT-MODE?")}i||s||this.logger.log(2,(()=>"Couldn't parse cleaned data "+Vi([e,r])+" orig: "+Vi([t[n],t[n+1]])))}}parseCmd(e,t){if(!((20===e||28===e||21===e||29===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=33&&t<=35))return!1;const n=20===e||21===e||23===e?1:2,r=this.channels[n];return 20===e||21===e||28===e||29===e?32===t?r.ccRCL():33===t?r.ccBS():34===t?r.ccAOF():35===t?r.ccAON():36===t?r.ccDER():37===t?r.ccRU(2):38===t?r.ccRU(3):39===t?r.ccRU(4):40===t?r.ccFON():41===t?r.ccRDC():42===t?r.ccTR():43===t?r.ccRTD():44===t?r.ccEDM():45===t?r.ccCR():46===t?r.ccENM():47===t&&r.ccEOC():r.ccTO(t-32),this.currentChannel=n,!0}parseMidrow(e,t){let n=0;if((17===e||25===e)&&t>=32&&t<=47){if(n=17===e?1:2,n!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const r=this.channels[n];return!!r&&(r.ccMIDROW(t),this.logger.log(3,(()=>"MIDROW ("+Vi([e,t])+")")),!0)}return!1}parsePAC(e,t){let n;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127)&&!((16===e||24===e)&&t>=64&&t<=95))return!1;const r=e<=23?1:2;n=t>=64&&t<=95?1===r?zi[e]:Hi[e]:1===r?Gi[e]:qi[e];const i=this.channels[r];return!!i&&(i.setPAC(this.interpretPAC(n,t)),this.currentChannel=r,!0)}interpretPAC(e,t){let n;const r={color:null,italics:!1,indent:null,underline:!1,row:e};return n=t>95?t-96:t-64,r.underline=!(1&~n),n<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(n/2)]:n<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((n-16)/2),r}parseChars(e,t){let n,r=null,i=null;if(e>=25?(n=2,i=e-8):(n=1,i=e),i>=17&&i<=19){let e;e=17===i?t+80:18===i?t+112:t+144,this.logger.log(2,(()=>"Special char '"+Ui(e)+"' in channel "+n)),r=[e]}else e>=32&&e<=127&&(r=0===t?[e]:[e,t]);return r&&this.logger.log(3,(()=>"Char codes =  "+Vi(r).join(","))),r}parseBackgroundAttributes(e,t){if(!((16===e||24===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=45&&t<=47))return!1;let n;const r={};16===e||24===e?(n=Math.floor((t-32)/2),r.background=Yi[n],t%2==1&&(r.background=r.background+"_semi")):45===t?r.background="transparent":(r.foreground="black",47===t&&(r.underline=!0));const i=e<=23?1:2;return this.channels[i].setBkgData(r),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}es(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const n=this.channels[t];n&&n.cueSplitAtTime(e)}}}function es(e,t,n){n.a=e,n.b=t}function ts(e,t,n){return n.a===e&&n.b===t}class ns{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,n){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=n,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var rs=function(){if(null!=H&&H.VTTCue)return self.VTTCue;const e=["","lr","rl"],t=["start","middle","end","left","right"];function n(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;const n=t.toLowerCase();return!!~e.indexOf(n)&&n}function r(e){return n(t,e)}function i(e,...t){let n=1;for(;n<arguments.length;n++){const t=arguments[n];for(const n in t)e[n]=t[n]}return e}function s(t,s,a){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let c="",h=!1,u=t,d=s,f=a,A=null,m="",p=!0,g="auto",v="start",y=50,E="middle",x=50,C="middle";Object.defineProperty(o,"id",i({},l,{get:function(){return c},set:function(e){c=""+e}})),Object.defineProperty(o,"pauseOnExit",i({},l,{get:function(){return h},set:function(e){h=!!e}})),Object.defineProperty(o,"startTime",i({},l,{get:function(){return u},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");u=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",i({},l,{get:function(){return d},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");d=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",i({},l,{get:function(){return f},set:function(e){f=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",i({},l,{get:function(){return A},set:function(e){A=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",i({},l,{get:function(){return m},set:function(t){const r=function(t){return n(e,t)}(t);if(!1===r)throw new SyntaxError("An invalid or illegal string was specified.");m=r,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",i({},l,{get:function(){return p},set:function(e){p=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",i({},l,{get:function(){return g},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");g=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",i({},l,{get:function(){return v},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");v=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",i({},l,{get:function(){return y},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");y=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",i({},l,{get:function(){return E},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");E=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",i({},l,{get:function(){return x},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");x=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",i({},l,{get:function(){return C},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");C=t,this.hasBeenReset=!0}})),o.displayState=void 0}return s.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},s}();class is{decode(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function ss(e){function t(e,t,n,r){return 3600*(0|e)+60*(0|t)+(0|n)+parseFloat(r||0)}const n=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return n?parseFloat(n[2])>59?t(n[2],n[3],0,n[4]):t(n[1],n[2],n[3],n[4]):null}class as{constructor(){this.values=Object.create(null)}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,n){return n?this.has(e)?this.values[e]:t[n]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,n){for(let r=0;r<n.length;++r)if(t===n[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const n=parseFloat(t);if(n>=0&&n<=100)return this.set(e,n),!0}return!1}}function os(e,t,n,r){const i=r?e.split(r):[e];for(const s in i){if("string"!=typeof i[s])continue;const e=i[s].split(n);if(2!==e.length)continue;t(e[0],e[1])}}const ls=new rs(0,0,""),cs="middle"===ls.align?"middle":"center";function hs(e,t,n){const r=e;function i(){const t=ss(e);if(null===t)throw new Error("Malformed timestamp: "+r);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function s(){e=e.replace(/^\s+/,"")}if(s(),t.startTime=i(),s(),"--\x3e"!==e.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);e=e.slice(3),s(),t.endTime=i(),s(),function(e,t){const r=new as;os(e,(function(e,t){let i;switch(e){case"region":for(let i=n.length-1;i>=0;i--)if(n[i].id===t){r.set(e,n[i].region);break}break;case"vertical":r.alt(e,t,["rl","lr"]);break;case"line":i=t.split(","),r.integer(e,i[0]),r.percent(e,i[0])&&r.set("snapToLines",!1),r.alt(e,i[0],["auto"]),2===i.length&&r.alt("lineAlign",i[1],["start",cs,"end"]);break;case"position":i=t.split(","),r.percent(e,i[0]),2===i.length&&r.alt("positionAlign",i[1],["start",cs,"end","line-left","line-right","auto"]);break;case"size":r.percent(e,t);break;case"align":r.alt(e,t,["start",cs,"end","left","right"])}}),/:/,/\s/),t.region=r.get("region",null),t.vertical=r.get("vertical","");let i=r.get("line","auto");"auto"===i&&-1===ls.line&&(i=-1),t.line=i,t.lineAlign=r.get("lineAlign","start"),t.snapToLines=r.get("snapToLines",!0),t.size=r.get("size",100),t.align=r.get("align",cs);let s=r.get("position","auto");"auto"===s&&50===ls.position&&(s="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=s}(e,t)}function us(e){return e.replace(/<br(?: \/)?>/gi,"\n")}class ds{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new is,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;function n(){let e=t.buffer,n=0;for(e=us(e);n<e.length&&"\r"!==e[n]&&"\n"!==e[n];)++n;const r=e.slice(0,n);return"\r"===e[n]&&++n,"\n"===e[n]&&++n,t.buffer=e.slice(n),r}e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));try{let e="";if("INITIAL"===t.state){if(!/\r\n|\n/.test(t.buffer))return this;e=n();const r=e.match(/^(\xef\xbb\xbf)?WEBVTT([ \t].*)?$/);if(null==r||!r[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let i=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(i?i=!1:e=n(),t.state){case"HEADER":/:/.test(e)?os(e,(function(e,t){}),/:/):e||(t.state="ID");continue;case"NOTE":e||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){t.state="NOTE";break}if(!e)continue;if(t.cue=new rs(0,0,""),t.state="CUE",-1===e.indexOf("--\x3e")){t.cue.id=e;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{hs(e,t.cue,t.regionList)}catch(r){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const n=-1!==e.indexOf("--\x3e");if(!e||n&&(i=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(null===t.cue)continue;t.cue.text&&(t.cue.text+="\n"),t.cue.text+=e}continue;case"BADCUE":e||(t.state="ID")}}}catch(r){"CUETEXT"===t.state&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state="INITIAL"===t.state?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const fs=/\r\n|\n\r|\n|\r/g,As=function(e,t,n=0){return e.slice(n,n+t.length)===t},ms=function(e){let t=5381,n=e.length;for(;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString()};function ps(e,t,n){return ms(e.toString())+ms(t.toString())+ms(n)}function gs(e,t,n,r,i,s,a){const o=new ds,l=ve(new Uint8Array(e)).trim().replace(fs,"\n").split("\n"),c=[],h=t?function(e,t=1){return si(e,9e4,1/t)}(t.baseTime,t.timescale):0;let u,d="00:00.000",f=0,A=0,m=!0;o.oncue=function(e){const s=n[r];let a=n.ccOffset;const o=(f-h)/9e4;if(null!=s&&s.new&&(void 0!==A?a=n.ccOffset=s.start:function(e,t,n){let r=e[t],i=e[r.prevCC];if(!i||!i.new&&r.new)return e.ccOffset=e.presentationOffset=r.start,void(r.new=!1);for(;null!=(s=i)&&s.new;){var s;e.ccOffset+=r.start-i.start,r.new=!1,r=i,i=e[r.prevCC]}e.presentationOffset=n}(n,r,o)),o){if(!t)return void(u=new Error("Missing initPTS for VTT MPEGTS"));a=o-n.presentationOffset}const l=e.endTime-e.startTime,d=ui(9e4*(e.startTime+a-A),9e4*i)/9e4;e.startTime=Math.max(d,0),e.endTime=Math.max(d+l,0);const m=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(m)),e.id||(e.id=ps(e.startTime,e.endTime,m)),e.endTime>0&&c.push(e)},o.onparsingerror=function(e){u=e},o.onflush=function(){u?a(u):s(c)},l.forEach((e=>{if(m){if(As(e,"X-TIMESTAMP-MAP=")){m=!1,e.slice(16).split(",").forEach((e=>{As(e,"LOCAL:")?d=e.slice(6):As(e,"MPEGTS:")&&(f=parseInt(e.slice(7)))}));try{A=function(e){let t=parseInt(e.slice(-3));const n=parseInt(e.slice(-6,-4)),r=parseInt(e.slice(-9,-7)),i=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(p(t)&&p(n)&&p(r)&&p(i)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*n,t+=6e4*r,t+=36e5*i,t}(d)/1e3}catch(t){u=t}return}""===e&&(m=!1)}o.parse(e+"\n")})),o.flush()}const vs="stpp.ttml.im1t",ys=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Es=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,xs={left:"start",center:"center",right:"end",start:"start",end:"end"};function Cs(e,t,n,r){const i=Re(new Uint8Array(e),["mdat"]);if(0===i.length)return void r(new Error("Could not parse IMSC1 mdat"));const s=i.map((e=>ve(e))),a=function(e,t,n=1,r=!1){return si(e,t,1/n,r)}(t.baseTime,1,t.timescale);try{s.forEach((e=>n(function(e,t){const n=(new DOMParser).parseFromString(e,"text/xml"),r=n.getElementsByTagName("tt")[0];if(!r)throw new Error("Invalid ttml");const i={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},s=Object.keys(i).reduce(((e,t)=>(e[t]=r.getAttribute(`ttp:${t}`)||i[t],e)),{}),a="preserve"!==r.getAttribute("xml:space"),o=Is(ws(r,"styling","style")),l=Is(ws(r,"layout","region")),c=ws(r,"body","[begin]");return[].map.call(c,(e=>{const n=bs(e,a);if(!n||!e.hasAttribute("begin"))return null;const r=Ts(e.getAttribute("begin"),s),i=Ts(e.getAttribute("dur"),s);let c=Ts(e.getAttribute("end"),s);if(null===r)throw Bs(e);if(null===c){if(null===i)throw Bs(e);c=r+i}const h=new rs(r-t,c-t,n);h.id=ps(h.startTime,h.endTime,h.text);const u=function(e,t,n){const r="http://www.w3.org/ns/ttml#styling";let i=null;const s=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;a&&n.hasOwnProperty(a)&&(i=n[a]);return s.reduce(((n,s)=>{const a=Ss(t,r,s)||Ss(e,r,s)||Ss(i,r,s);return a&&(n[s]=a),n}),{})}(l[e.getAttribute("region")],o[e.getAttribute("style")],o),{textAlign:d}=u;if(d){const e=xs[d];e&&(h.lineAlign=e),h.align=d}return m(h,u),h})).filter((e=>null!==e))}(e,a))))}catch(o){r(o)}}function ws(e,t,n){const r=e.getElementsByTagName(t)[0];return r?[].slice.call(r.querySelectorAll(n)):[]}function Is(e){return e.reduce(((e,t)=>{const n=t.getAttribute("xml:id");return n&&(e[n]=t),e}),{})}function bs(e,t){return[].slice.call(e.childNodes).reduce(((e,n,r)=>{var i;return"br"===n.nodeName&&r?e+"\n":null!=(i=n.childNodes)&&i.length?bs(n,t):t?e+n.textContent.trim().replace(/\s+/g," "):e+n.textContent}),"")}function Ss(e,t,n){return e&&e.hasAttributeNS(t,n)?e.getAttributeNS(t,n):null}function Bs(e){return new Error(`Could not parse ttml timestamp ${e}`)}function Ts(e,t){if(!e)return null;let n=ss(e);return null===n&&(ys.test(e)?n=function(e,t){const n=ys.exec(e),r=(0|n[4])+(0|n[5])/t.subFrameRate;return 3600*(0|n[1])+60*(0|n[2])+(0|n[3])+r/t.frameRate}(e,t):Es.test(e)&&(n=function(e,t){const n=Es.exec(e),r=Number(n[1]);switch(n[2]){case"h":return 3600*r;case"m":return 60*r;case"ms":return 1e3*r;case"f":return r/t.frameRate;case"t":return r/t.tickRate}return r}(e,t))),n}class _s{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this),e.on(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(y.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this),e.off(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(y.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const e=new ns(this,"textTrack1"),t=new ns(this,"textTrack2"),n=new ns(this,"textTrack3"),r=new ns(this,"textTrack4");this.cea608Parser1=new Zi(1,e,t),this.cea608Parser2=new Zi(3,n,r)}}addCues(e,t,n,r,i){let s=!1;for(let h=i.length;h--;){const e=i[h],r=(a=e[0],o=e[1],l=t,c=n,Math.min(o,c)-Math.max(a,l));if(r>=0&&(e[0]=Math.min(e[0],t),e[1]=Math.max(e[1],n),s=!0,r/(n-t)>.5))return}var a,o,l,c;if(s||i.push([t,n]),this.config.renderTextTracksNatively){const i=this.captionsTracks[e];this.Cues.newCue(i,t,n,r)}else{const i=this.Cues.newCue(null,t,n,r);this.hls.trigger(y.CUES_PARSED,{type:"captions",cues:i,track:e})}}onInitPtsFound(e,{frag:t,id:n,initPTS:r,timescale:i}){const{unparsedVttFrags:s}=this;"main"===n&&(this.initPTS[t.cc]={baseTime:r,timescale:i}),s.length&&(this.unparsedVttFrags=[],s.forEach((e=>{this.onFragLoaded(y.FRAG_LOADED,e)})))}getExistingTrack(e,t){const{media:n}=this;if(n)for(let r=0;r<n.textTracks.length;r++){const i=n.textTracks[r];if(Rs(i,{name:e,lang:t,attrs:{}}))return i}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:n,media:r}=this,{label:i,languageCode:s}=t[e],a=this.getExistingTrack(i,s);if(a)n[e]=a,kt(n[e]),Pt(n[e],r);else{const t=this.createTextTrack("captions",i,s);t&&(t[e]=!0,n[e]=t)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const n={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,n){const r=this.media;if(r)return r.addTextTrack(e,t,n)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:e}=this;Object.keys(e).forEach((t=>{kt(e[t]),delete e[t]})),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let n=0;n<t.length;n++)kt(t[n])}onSubtitleTracksUpdated(e,t){const n=t.subtitleTracks||[],r=n.some((e=>e.textCodec===vs));if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(Si(this.tracks,n))return void(this.tracks=n);if(this.textTracks=[],this.tracks=n,this.config.renderTextTracksNatively){const e=this.media,t=e?Ot(e.textTracks):null;if(this.tracks.forEach(((e,n)=>{let r;if(t){let n=null;for(let r=0;r<t.length;r++)if(t[r]&&Rs(t[r],e)){n=t[r],t[r]=null;break}n&&(r=n)}if(r)kt(r);else{const t=Ms(e);r=this.createTextTrack(t,e.name,e.lang),r&&(r.mode="disabled")}r&&this.textTracks.push(r)})),null!=t&&t.length){const e=t.filter((e=>null!==e)).map((e=>e.label));e.length&&S.warn(`Media element contains unused subtitle tracks: ${e.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const e=this.tracks.map((e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e})));this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach((e=>{const t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(!t)return;const n=`textTrack${t[1]}`,r=this.captionsProperties[n];r&&(r.label=e.name,e.lang&&(r.languageCode=e.lang),r.media=e)}))}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return null==t?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===_t.MAIN){var n,r;const{cea608Parser1:e,cea608Parser2:i,lastSn:s}=this,{cc:a,sn:o}=t.frag,l=null!=(n=null==(r=t.part)?void 0:r.index)?n:-1;e&&i&&(o!==s+1||o===s&&l!==this.lastPartIndex+1||a!==this.lastCc)&&(e.reset(),i.reset()),this.lastCc=a,this.lastSn=o,this.lastPartIndex=l}}onFragLoaded(e,t){const{frag:n,payload:r}=t;if(n.type===_t.SUBTITLE)if(r.byteLength){const e=n.decryptdata,i="stats"in t;if(null==e||!e.encrypted||i){const e=this.tracks[n.level],i=this.vttCCs;i[n.cc]||(i[n.cc]={start:n.start,prevCC:this.prevCC,new:!0},this.prevCC=n.cc),e&&e.textCodec===vs?this._parseIMSC1(n,r):this._parseVTTs(t)}}else this.hls.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const n=this.hls;Cs(t,this.initPTS[e.cc],(t=>{this._appendCues(t,e.level),n.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})}),(t=>{S.log(`Failed to parse IMSC1: ${t}`),n.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})}))}_parseVTTs(e){var t;const{frag:n,payload:r}=e,{initPTS:i,unparsedVttFrags:s}=this,a=i.length-1;if(!i[n.cc]&&-1===a)return void s.push(e);const o=this.hls;gs(null!=(t=n.initSegment)&&t.data?Ne(n.initSegment.data,new Uint8Array(r)):r,this.initPTS[n.cc],this.vttCCs,n.cc,n.start,(e=>{this._appendCues(e,n.level),o.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:n})}),(t=>{const i="Missing initPTS for VTT MPEGTS"===t.message;i?s.push(e):this._fallbackToIMSC1(n,r),S.log(`Failed to parse VTT cue: ${t}`),i&&a>n.cc||o.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:t})}))}_fallbackToIMSC1(e,t){const n=this.tracks[e.level];n.textCodec||Cs(t,this.initPTS[e.cc],(()=>{n.textCodec=vs,this._parseIMSC1(e,t)}),(()=>{n.textCodec="wvtt"}))}_appendCues(e,t){const n=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||"disabled"===n.mode)return;e.forEach((e=>Lt(n,e)))}else{const r=this.tracks[t];if(!r)return;const i=r.default?"default":"subtitles"+t;n.trigger(y.CUES_PARSED,{type:"subtitles",cues:e,track:i})}}onFragDecrypted(e,t){const{frag:n}=t;n.type===_t.SUBTITLE&&this.onFragLoaded(y.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){this.initCea608Parsers();const{cea608Parser1:n,cea608Parser2:r}=this;if(!this.enabled||!n||!r)return;const{frag:i,samples:s}=t;if(i.type!==_t.MAIN||"NONE"!==this.closedCaptionsForLevel(i))for(let a=0;a<s.length;a++){const e=s[a].bytes;if(e){const t=this.extractCea608Data(e);n.addData(s[a].pts,t[0]),r.addData(s[a].pts,t[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:n,endOffsetSubtitles:r,type:i}){const{media:s}=this;if(s&&!(s.currentTime<n)){if(!i||"video"===i){const{captionsTracks:e}=this;Object.keys(e).forEach((r=>Ft(e[r],t,n)))}if(this.config.renderTextTracksNatively&&0===t&&void 0!==r){const{textTracks:e}=this;Object.keys(e).forEach((n=>Ft(e[n],t,r)))}}}extractCea608Data(e){const t=[[],[]],n=31&e[0];let r=2;for(let i=0;i<n;i++){const n=e[r++],i=127&e[r++],s=127&e[r++];if(0===i&&0===s)continue;if(!!(4&n)){const e=3&n;0!==e&&1!==e||(t[e].push(i),t[e].push(s))}}return t}}function Ms(e){return e.characteristics&&/transcribes-spoken-dialog/gi.test(e.characteristics)&&/describes-music-and-sound/gi.test(e.characteristics)?"captions":"subtitles"}function Rs(e,t){return!!e&&e.kind===Ms(t)&&Ti(t,e)}class Ds{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.BUFFER_CODECS,this.onBufferCodecs,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const n=this.hls.levels[t.droppedLevel];this.isLevelAllowed(n)&&this.restrictedLevels.push({bitrate:n.bitrate,height:n.height,width:n.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const n=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,n.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&p(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);const e=this.hls.levels;if(e.length){const t=this.hls,n=this.getMaxLevel(e.length-1);n!==this.autoLevelCapping&&S.log(`Setting autoLevelCapping to ${n}: ${e[n].height}p@${e[n].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=n,t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const n=t.filter(((t,n)=>this.isLevelAllowed(t)&&n<=e));return this.clientRect=null,Ds.getMaxLevelByMediaSize(n,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const n=e.getBoundingClientRect();t.width=n.width,t.height=n.height,t.width||t.height||(t.width=n.right-n.left||e.width||0,t.height=n.bottom-n.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(t){}return e}isLevelAllowed(e){return!this.restrictedLevels.some((t=>e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height))}static getMaxLevelByMediaSize(e,t,n){if(null==e||!e.length)return-1;let r=e.length-1;const i=Math.max(t,n);for(let o=0;o<e.length;o+=1){const t=e[o];if((t.width>=i||t.height>=i)&&(s=t,!(a=e[o+1])||s.width!==a.width||s.height!==a.height)){r=o;break}}var s,a;return r}}class Ps{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const n=this.hls.config;if(n.capLevelOnFPSDrop){const e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&"function"==typeof e.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),n.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,n){const r=performance.now();if(t){if(this.lastTime){const e=r-this.lastTime,i=n-this.lastDroppedFrames,s=t-this.lastDecodedFrames,a=1e3*i/e,o=this.hls;if(o.trigger(y.FPS_DROP,{currentDropped:i,currentDecoded:s,totalDroppedFrames:n}),a>0&&i>o.config.fpsDroppedMonitoringThreshold*s){let e=o.currentLevel;S.warn("drop FPS ratio greater than max allowed value for currentLevel: "+e),e>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=e)&&(e-=1,o.trigger(y.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:o.currentLevel}),o.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=n,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}const Ls="[eme]";class ks{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=ks.CDMCleanupPromise?[ks.CDMCleanupPromise]:[],this.debug=S.debug.bind(S,Ls),this.log=S.log.bind(S,Ls),this.warn=S.warn.bind(S,Ls),this.error=S.error.bind(S,Ls),this.onMediaEncrypted=e=>{const{initDataType:t,initData:n}=e,r=`"${e.type}" event: init data type: "${t}"`;if(this.debug(r),null!==n){if(!this.keyFormatPromise){let e=Object.keys(this.keySystemAccessPromises);e.length||(e=Z(this.config));const t=e.map($).filter((e=>!!e));this.keyFormatPromise=this.getKeyFormatPromise(t)}this.keyFormatPromise.then((i=>{const s=j(i);let a,o;if("sinf"===t){if(s!==q.FAIRPLAY)return void this.warn(`Ignoring unexpected "${e.type}" event with init data type: "${t}" for selected key-system ${s}`);const i=be(new Uint8Array(n));try{const e=Ue(N(JSON.parse(i).sinf));if(!e)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");a=e.subarray(8,24),o=q.FAIRPLAY}catch(d){return void this.warn(`${r} Failed to parse sinf: ${d}`)}}else{if(s!==q.WIDEVINE&&s!==q.PLAYREADY)return void this.warn(`Ignoring unexpected "${e.type}" event with init data type: "${t}" for selected key-system ${s}`);const i=function(e){const t=[];if(e instanceof ArrayBuffer){const n=e.byteLength;let r=0;for(;r+32<n;){const n=je(new DataView(e,r));t.push(n),r+=n.size}}return t}(n),l=i.filter((e=>!!e.systemId&&X(e.systemId)===s));l.length>1&&this.warn(`${r} Using first of ${l.length} pssh found for selected key-system ${s}`);const c=l[0];if(!c)return void(0===i.length||i.some((e=>!e.systemId))?this.warn(`${r} contains incomplete or invalid pssh data`):this.log(`ignoring ${r} for ${i.map((e=>X(e.systemId))).join(",")} pssh data in favor of playlist keys`));if(o=X(c.systemId),0===c.version&&c.data)if(o===q.WIDEVINE){const e=c.data.length-22;a=c.data.subarray(e,e+16)}else o===q.PLAYREADY&&(a=ne(c.data))}if(!o||!a)return void this.log(`Unable to handle ${r} with key-system ${s}`);const l=xe(a),{keyIdToKeySessionPromise:c,mediaKeySessions:h}=this;let u=c[l];for(let e=0;e<h.length;e++){const r=h[e],i=r.decryptdata;if(!i.keyId)continue;const s=xe(i.keyId);if(l===s||-1!==i.uri.replace(/-/g,"").indexOf(l)){if(u=c[s],i.pssh)break;delete c[s],i.pssh=new Uint8Array(n),i.keyId=a,u=c[l]=u.then((()=>this.generateRequestWithPreferredKeySession(r,t,n,"encrypted-event-key-match"))),u.catch((e=>this.handleError(e)));break}}if(!u){if(o!==s)return void this.log(`Ignoring "${r}" with ${o} init data for selected key-system ${s}`);u=c[l]=this.getKeySystemSelectionPromise([o]).then((({keySystem:e,mediaKeys:r})=>{var i;this.throwIfDestroyed();const s=new Ke("ISO-23001-7",l,null!=(i=$(e))?i:"");return s.pssh=new Uint8Array(n),s.keyId=a,this.attemptSetMediaKeys(e,r).then((()=>{this.throwIfDestroyed();const i=this.createMediaKeySessionContext({decryptdata:s,keySystem:e,mediaKeys:r});return this.generateRequestWithPreferredKeySession(i,t,n,"encrypted-event-no-match")}))})),u.catch((e=>this.handleError(e)))}}))}},this.onWaitingForKey=e=>{this.log(`"${e.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(y.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(y.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:n}=this.config,r=t[e];return r?r.licenseUrl:e===q.WIDEVINE&&n?n:void 0}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(void 0===t)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,n=t[e];if(n)return n.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,n=(e,t,n)=>!!e&&n.indexOf(e)===t,r=t.map((e=>e.audioCodec)).filter(n),i=t.map((e=>e.videoCodec)).filter(n);return r.length+i.length===0&&i.push("avc1.42e01e"),new Promise(((t,n)=>{const s=e=>{const a=e.shift();this.getMediaKeysPromise(a,r,i).then((e=>t({keySystem:a,mediaKeys:e}))).catch((t=>{e.length?s(e):n(t instanceof Fs?t:new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))}))};s(e)}))}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:n}=this.config;if("function"!=typeof n){let e=`Configured requestMediaKeySystemAccess is not a function ${n}`;return null===ee&&"http:"===self.location.protocol&&(e=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(e))}return n(e,t)}getMediaKeysPromise(e,t,n){const r=function(e,t,n,r){let i;switch(e){case q.FAIRPLAY:i=["cenc","sinf"];break;case q.WIDEVINE:case q.PLAYREADY:i=["cenc"];break;case q.CLEARKEY:i=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${e}`)}return function(e,t,n,r){return[{initDataTypes:e,persistentState:r.persistentState||"optional",distinctiveIdentifier:r.distinctiveIdentifier||"optional",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:t.map((e=>({contentType:`audio/mp4; codecs="${e}"`,robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null}))),videoCapabilities:n.map((e=>({contentType:`video/mp4; codecs="${e}"`,robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null})))}]}(i,t,n,r)}(e,t,n,this.config.drmSystemOptions),i=this.keySystemAccessPromises[e];let s=null==i?void 0:i.keySystemAccess;if(!s){this.log(`Requesting encrypted media "${e}" key-system access with config: ${JSON.stringify(r)}`),s=this.requestMediaKeySystemAccess(e,r);const t=this.keySystemAccessPromises[e]={keySystemAccess:s};return s.catch((t=>{this.log(`Failed to obtain access to key-system "${e}": ${t}`)})),s.then((n=>{this.log(`Access for key-system "${n.keySystem}" obtained`);const r=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),t.mediaKeys=n.createMediaKeys().then((t=>(this.log(`Media-keys created for "${e}"`),r.then((n=>n?this.setMediaKeysServerCertificate(t,e,n):t))))),t.mediaKeys.catch((t=>{this.error(`Failed to create media-keys for "${e}"}: ${t}`)})),t.mediaKeys}))}return s.then((()=>i.mediaKeys))}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:n}){this.log(`Creating key-system session "${t}" keyId: ${xe(e.keyId||[])}`);const r=n.createSession(),i={decryptdata:e,keySystem:t,mediaKeys:n,mediaKeysSession:r,keyStatus:"status-pending"};return this.mediaKeySessions.push(i),i}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const n=this.createMediaKeySessionContext(e),r=this.getKeyIdString(t),i="cenc";this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(n,i,t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return xe(e.keyId)}updateKeySession(e,t){var n;const r=e.mediaKeysSession;return this.log(`Updating key-session "${r.sessionId}" for keyID ${xe((null==(n=e.decryptdata)?void 0:n.keyId)||[])}\n      } (data length: ${t?t.byteLength:t})`),r.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise(((t,n)=>{const r=Z(this.config),i=e.map(j).filter((e=>!!e&&-1!==r.indexOf(e)));return this.getKeySystemSelectionPromise(i).then((({keySystem:e})=>{const r=$(e);r?t(r):n(new Error(`Unable to find format for key-system "${e}"`))})).catch(n)}))}loadKey(e){const t=e.keyInfo.decryptdata,n=this.getKeyIdString(t),r=`(keyId: ${n} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${r}`);let i=this.keyIdToKeySessionPromise[n];return i||(i=this.keyIdToKeySessionPromise[n]=this.getKeySystemForKeyPromise(t).then((({keySystem:n,mediaKeys:i})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${r}`),this.attemptSetMediaKeys(n,i).then((()=>{this.throwIfDestroyed();const e=this.createMediaKeySessionContext({keySystem:n,mediaKeys:i,decryptdata:t});return this.generateRequestWithPreferredKeySession(e,"cenc",t.pssh,"playlist-key")}))))),i.catch((e=>this.handleError(e)))),i}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof Fs?this.hls.trigger(y.ERROR,e.data):this.hls.trigger(y.ERROR,{type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),n=this.keyIdToKeySessionPromise[t];if(!n){const t=j(e.keyFormat),n=t?[t]:Z(this.config);return this.attemptKeySystemAccess(n)}return n}getKeySystemSelectionPromise(e){if(e.length||(e=Z(this.config)),0===e.length)throw new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){const n=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const r=Promise.all(n).then((()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)}));return this.setMediaKeysQueue.push(r),r.then((()=>{this.log(`Media-keys set for "${e}"`),n.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter((e=>-1===n.indexOf(e)))}))}generateRequestWithPreferredKeySession(e,t,n,r){var i,s;const a=null==(i=this.config.drmSystems)||null==(s=i[e.keySystem])?void 0:s.generateRequest;if(a)try{const r=a.call(this.hls,t,n,e);if(!r)throw new Error("Invalid response from configured generateRequest filter");t=r.initDataType,n=e.decryptdata.pssh=r.initData?new Uint8Array(r.initData):null}catch(f){var o;if(this.warn(f.message),null!=(o=this.hls)&&o.config.debug)throw f}if(null===n)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(e);const l=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${r}": ${l} (init data type: ${t} length: ${n?n.byteLength:null})`);const c=new wi,h=e._onmessage=t=>{const n=e.mediaKeysSession;if(!n)return void c.emit("error",new Error("invalid state"));const{messageType:r,message:i}=t;this.log(`"${r}" message event for session "${n.sessionId}" message size: ${i.byteLength}`),"license-request"===r||"license-renewal"===r?this.renewLicense(e,i).catch((e=>{this.handleError(e),c.emit("error",e)})):"license-release"===r?e.keySystem===q.FAIRPLAY&&(this.updateKeySession(e,G("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${r}"`)},u=e._onkeystatuseschange=t=>{if(!e.mediaKeysSession)return void c.emit("error",new Error("invalid state"));this.onKeyStatusChange(e);const n=e.keyStatus;c.emit("keyStatus",n),"expired"===n&&(this.warn(`${e.keySystem} expired for key ${l}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",h),e.mediaKeysSession.addEventListener("keystatuseschange",u);const d=new Promise(((e,t)=>{c.on("error",t),c.on("keyStatus",(n=>{n.startsWith("usable")?e():"output-restricted"===n?t(new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===n?t(new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${n}"`)):"expired"===n?t(new Error("key expired while generating request")):this.warn(`unhandled key status change "${n}"`)}))}));return e.mediaKeysSession.generateRequest(t,n).then((()=>{var t;this.log(`Request generated for key-session "${null==(t=e.mediaKeysSession)?void 0:t.sessionId}" keyId: ${l}`)})).catch((e=>{throw new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},`Error generating key-session request: ${e}`)})).then((()=>d)).catch((t=>{throw c.removeAllListeners(),this.removeSession(e),t})).then((()=>(c.removeAllListeners(),e)))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach(((t,n)=>{this.log(`key status change "${t}" for keyStatuses keyId: ${xe("buffer"in n?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n))} session keyId: ${xe(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t}))}fetchServerCertificate(e){const t=this.config,n=new(0,t.loader)(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise(((i,s)=>{const a={responseType:"arraybuffer",url:r},o=t.certLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(e,t,n,r)=>{i(e.data)},onError:(t,n,i,o)=>{s(new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:i,response:d({url:a.url,data:void 0},t)},`"${e}" certificate request failed (${r}). Status: ${t.code} (${t.text})`))},onTimeout:(t,n,i)=>{s(new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:i,response:{url:a.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(e,t,n)=>{s(new Error("aborted"))}};n.load(a,l,c)}))):Promise.resolve()}setMediaKeysServerCertificate(e,t,n){return new Promise(((r,i)=>{e.setServerCertificate(n).then((i=>{this.log(`setServerCertificate ${i?"success":"not supported by CDM"} (${null==n?void 0:n.byteLength}) on "${t}"`),r(e)})).catch((e=>{i(new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))}))}))}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then((t=>this.updateKeySession(e,new Uint8Array(t)).catch((e=>{throw new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)}))))}unpackPlayReadyKeyMessage(e,t){const n=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!n.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const r=(new DOMParser).parseFromString(n,"application/xml"),i=r.querySelectorAll("HttpHeader");if(i.length>0){let t;for(let n=0,r=i.length;n<r;n++){var s,a;t=i[n];const r=null==(s=t.querySelector("name"))?void 0:s.textContent,o=null==(a=t.querySelector("value"))?void 0:a.textContent;r&&o&&e.setRequestHeader(r,o)}}const o=r.querySelector("Challenge"),l=null==o?void 0:o.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return G(atob(l))}setupLicenseXHR(e,t,n,r){const i=this.config.licenseXhrSetup;return i?Promise.resolve().then((()=>{if(!n.decryptdata)throw new Error("Key removed");return i.call(this.hls,e,t,n,r)})).catch((s=>{if(!n.decryptdata)throw s;return e.open("POST",t,!0),i.call(this.hls,e,t,n,r)})).then((n=>{e.readyState||e.open("POST",t,!0);return{xhr:e,licenseChallenge:n||r}})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:r}))}requestLicense(e,t){const n=this.config.keyLoadPolicy.default;return new Promise(((r,i)=>{const s=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${s}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return i(new Error("invalid state"));if(4===a.readyState)if(200===a.status){this._requestLicenseFailureCount=0;let t=a.response;this.log(`License received ${t instanceof ArrayBuffer?t.byteLength:t}`);const n=this.config.licenseResponseCallback;if(n)try{t=n.call(this.hls,a,s,e)}catch(o){this.error(o)}r(t)}else{const o=n.errorRetry,l=o?o.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)i(new Fs({type:E.KEY_SYSTEM_ERROR,details:x.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:s,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${s}). Status: ${a.status} (${a.statusText})`));else{const n=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${n} attempts left`),this.requestLicense(e,t).then(r,i)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,s,e,t).then((({xhr:t,licenseChallenge:n})=>{e.keySystem==q.PLAYREADY&&(n=this.unpackPlayReadyKeyMessage(t,n)),t.send(n)}))}))}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const n=t.media;this.media=n,n.removeEventListener("encrypted",this.onMediaEncrypted),n.removeEventListener("waitingforkey",this.onWaitingForKey),n.addEventListener("encrypted",this.onMediaEncrypted),n.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media,t=this.mediaKeySessions;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Ke.clearKeyUriToKeyIdMap();const n=t.length;ks.CDMCleanupPromise=Promise.all(t.map((e=>this.removeSession(e))).concat(null==e?void 0:e.setMediaKeys(null).catch((e=>{this.log(`Could not clear media keys: ${e}`)})))).then((()=>{n&&(this.log("finished closing key sessions and clearing media keys"),t.length=0)})).catch((e=>{this.log(`Could not close sessions and clear media keys: ${e}`)}))}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(t&&this.config.emeEnabled&&!this.keyFormatPromise){const e=t.reduce(((e,t)=>(-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e)),[]);this.log(`Selecting key-system from session-keys ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:n}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),n&&n.readyState!==XMLHttpRequest.DONE&&n.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(e);return r>-1&&this.mediaKeySessions.splice(r,1),t.remove().catch((e=>{this.log(`Could not remove session: ${e}`)})).then((()=>t.close())).catch((e=>{this.log(`Could not close session: ${e}`)}))}}}ks.CDMCleanupPromise=void 0;class Fs extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}var Os,Us,Qs;!function(e){e.MANIFEST="m",e.AUDIO="a",e.VIDEO="v",e.MUXED="av",e.INIT="i",e.CAPTION="c",e.TIMED_TEXT="tt",e.KEY="k",e.OTHER="o"}(Os||(Os={})),function(e){e.DASH="d",e.HLS="h",e.SMOOTH="s",e.OTHER="o"}(Us||(Us={})),function(e){e.OBJECT="CMCD-Object",e.REQUEST="CMCD-Request",e.SESSION="CMCD-Session",e.STATUS="CMCD-Status"}(Qs||(Qs={}));const Ns={[Qs.OBJECT]:["br","d","ot","tb"],[Qs.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[Qs.SESSION]:["cid","pr","sf","sid","st","v"],[Qs.STATUS]:["bs","rtp"]};class zs{constructor(e,t){this.value=void 0,this.params=void 0,Array.isArray(e)&&(e=e.map((e=>e instanceof zs?e:new zs(e)))),this.value=e,this.params=t}}class Gs{constructor(e){this.description=void 0,this.description=e}}function Hs(e,t,n,r){return new Error(`failed to ${e} "${i=t,Array.isArray(i)?JSON.stringify(i):i instanceof Map?"Map{}":i instanceof Set?"Set{}":"object"==typeof i?JSON.stringify(i):String(i)}" as ${n}`,{cause:r});var i}const qs="Bare Item";const Ys=/[\x00-\x1f\x7f]+/;function js(e,t,n){return Hs("serialize",e,t,n)}function Vs(e){if(!1===ArrayBuffer.isView(e))throw js(e,"Byte Sequence");return`:${t=e,btoa(String.fromCharCode(...t))}:`;var t}function Ks(e){if(function(e){return e<-999999999999999||999999999999999<e}(e))throw js(e,"Integer");return e.toString()}function Ws(e,t){if(e<0)return-Ws(-e,t);const n=Math.pow(10,t);if(Math.abs(e*n%1-.5)<Number.EPSILON){const t=Math.floor(e*n);return(t%2==0?t:t+1)/n}return Math.round(e*n)/n}function Js(e){const t=Ws(e,3);if(Math.floor(Math.abs(t)).toString().length>12)throw js(e,"Decimal");const n=t.toString();return n.includes(".")?n:`${n}.0`}function Xs(e){const t=(n=e).description||n.toString().slice(7,-1);var n;if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t))throw js(t,"Token");return t}function $s(e){switch(typeof e){case"number":if(!p(e))throw js(e,qs);return Number.isInteger(e)?Ks(e):Js(e);case"string":return function(e){if(Ys.test(e))throw js(e,"String");return`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}(e);case"symbol":return Xs(e);case"boolean":return function(e){if("boolean"!=typeof e)throw js(e,"Boolean");return e?"?1":"?0"}(e);case"object":if(e instanceof Date)return function(e){return`@${Ks(e.getTime()/1e3)}`}(e);if(e instanceof Uint8Array)return Vs(e);if(e instanceof Gs)return Xs(e);default:throw js(e,qs)}}function Zs(e){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(e))throw js(e,"Key");return e}function ea(e){return null==e?"":Object.entries(e).map((([e,t])=>!0===t?`;${Zs(e)}`:`;${Zs(e)}=${$s(t)}`)).join("")}function ta(e){return e instanceof zs?`${$s(e.value)}${ea(e.params)}`:$s(e)}function na(e,t={whitespace:!0}){if("object"!=typeof e)throw js(e,"Dict");const n=e instanceof Map?e.entries():Object.entries(e),r=null!=t&&t.whitespace?" ":"";return Array.from(n).map((([e,t])=>{t instanceof zs==!1&&(t=new zs(t));let n=Zs(e);var r;return!0===t.value?n+=ea(t.params):(n+="=",Array.isArray(t.value)?n+=`(${(r=t).value.map(ta).join(" ")})${ea(r.params)}`:n+=ta(t)),n})).join(`,${r}`)}const ra=e=>Math.round(e),ia=e=>100*ra(e/100),sa={br:ra,d:ra,bl:ia,dl:ia,mtp:ia,nor:(e,t)=>(null!=t&&t.baseUrl&&(e=function(e,t){const n=new URL(e),r=new URL(t);if(n.origin!==r.origin)return e;const i=n.pathname.split("/").slice(1),s=r.pathname.split("/").slice(1,-1);for(;i[0]===s[0];)i.shift(),s.shift();for(;s.length;)s.shift(),i.unshift("..");return i.join("/")}(e,t.baseUrl)),encodeURIComponent(e)),rtp:ia,tb:ra};function aa(e,t){const n={};if(null==e||"object"!=typeof e)return n;const r=Object.keys(e).sort(),i=m({},sa,null==t?void 0:t.formatters),s=null==t?void 0:t.filter;return r.forEach((r=>{if(null!=s&&s(r))return;let a=e[r];const o=i[r];o&&(a=o(a,t)),"v"===r&&1===a||"pr"==r&&1===a||(e=>"number"==typeof e?p(e):null!=e&&""!==e&&!1!==e)(a)&&((e=>"ot"===e||"sf"===e||"st"===e)(r)&&"string"==typeof a&&(a=new Gs(a)),n[r]=a)})),n}function oa(e,t={}){return e?function(e,t){return na(e,t)}(aa(e,t),m({whitespace:!1},t)):""}function la(e,t,n){return m(e,function(e,t={}){if(!e)return{};const n=Object.entries(e),r=Object.entries(Ns).concat(Object.entries((null==t?void 0:t.customHeaderMap)||{})),i=n.reduce(((e,t)=>{var n;const[i,s]=t,a=(null==(n=r.find((e=>e[1].includes(i))))?void 0:n[0])||Qs.REQUEST;return null!=e[a]||(e[a]={}),e[a][i]=s,e}),{});return Object.entries(i).reduce(((e,[n,r])=>(e[n]=oa(r,t),e)),{})}(t,n))}const ca=/CMCD=[^&#]+/;function ha(e,t,n){const r=function(e,t={}){if(!e)return"";const n=oa(e,t);return`CMCD=${encodeURIComponent(n)}`}(t,n);if(!r)return e;if(ca.test(e))return e.replace(ca,r);const i=e.includes("?")?"&":"?";return`${e}${i}${r}`}class ua{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=e=>{try{this.apply(e,{ot:Os.MANIFEST,su:!this.initialized})}catch(t){S.warn("Could not generate manifest CMCD data.",t)}},this.applyFragmentData=e=>{try{const t=e.frag,n=this.hls.levels[t.level],r=this.getObjectType(t),i={d:1e3*t.duration,ot:r};r!==Os.VIDEO&&r!==Os.AUDIO&&r!=Os.MUXED||(i.br=n.bitrate/1e3,i.tb=this.getTopBandwidth(r)/1e3,i.bl=this.getBufferLength(r)),this.apply(e,i)}catch(t){S.warn("Could not generate segment CMCD data.",t)}},this.hls=e;const t=this.config=e.config,{cmcd:n}=t;null!=n&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=n.sessionId||function(){try{return crypto.randomUUID()}catch(e){try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch(e){let t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)}))}}}(),this.cid=n.contentId,this.useHeaders=!0===n.useHeaders,this.includeKeys=n.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHED,this.onMediaDetached,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHED,this.onMediaDetached,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var n,r;this.audioBuffer=null==(n=t.tracks.audio)?void 0:n.buffer,this.videoBuffer=null==(r=t.tracks.video)?void 0:r.buffer}createData(){var e;return{v:1,sf:Us.HLS,sid:this.sid,cid:this.cid,pr:null==(e=this.media)?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){m(t,this.createData());const n=t.ot===Os.INIT||t.ot===Os.VIDEO||t.ot===Os.MUXED;this.starved&&n&&(t.bs=!0,t.su=!0,this.starved=!1),null==t.su&&(t.su=this.buffering);const{includeKeys:r}=this;r&&(t=Object.keys(t).reduce(((e,n)=>(r.includes(n)&&(e[n]=t[n]),e)),{})),this.useHeaders?(e.headers||(e.headers={}),la(e.headers,t)):e.url=ha(e.url,t)}getObjectType(e){const{type:t}=e;return"subtitle"===t?Os.TIMED_TEXT:"initSegment"===e.sn?Os.INIT:"audio"===t?Os.AUDIO:"main"===t?this.hls.audioTracks.length?Os.VIDEO:Os.MUXED:void 0}getTopBandwidth(e){let t,n=0;const r=this.hls;if(e===Os.AUDIO)t=r.audioTracks;else{const e=r.maxAutoLevel,n=e>-1?e+1:r.levels.length;t=r.levels.slice(0,n)}for(const i of t)i.bitrate>n&&(n=i.bitrate);return n>0?n:NaN}getBufferLength(e){const t=this.hls.media,n=e===Os.AUDIO?this.audioBuffer:this.videoBuffer;if(!n||!t)return NaN;return 1e3*Gn.bufferInfo(n,t.currentTime,this.config.maxBufferHole).len}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,n=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new n(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,r){t(e),this.loader.load(e,n,r)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,n=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new n(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,r){t(e),this.loader.load(e,n,r)}}}}class da{constructor(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=S.log.bind(S,"[content-steering]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=1e3*this.timeToLoad-(performance.now()-this.updated);if(e>0)return void this.scheduleRefresh(this.uri,e)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter((t=>t!==e)))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:n}=t;null!==n&&(this.pathwayId=n.pathwayId,this.uri=n.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:n}=t;if((null==n?void 0:n.action)===pn.SendAlternateToPenaltyBox&&n.flags===gn.MoveAllAlternatesMatchingHost){const e=this.levels;let r=this.pathwayPriority,i=this.pathwayId;if(t.context){const{groupId:n,pathwayId:r,type:s}=t.context;n&&e?i=this.getPathwayForGroupId(n,s,i):r&&(i=r)}i in this.penalizedPathways||(this.penalizedPathways[i]=performance.now()),!r&&e&&(r=e.reduce(((e,t)=>(-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e)),[])),r&&r.length>1&&(this.updatePathwayPriority(r),n.resolved=this.pathwayId!==i),n.resolved||S.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${i} levels: ${e?e.length:e} priorities: ${JSON.stringify(r)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(0===t.length){const n=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${n}"`),t=this.getLevelsForPathway(n),this.pathwayId=n}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return null===this.levels?[]:this.levels.filter((t=>e===t.pathwayId))}updatePathwayPriority(e){let t;this.pathwayPriority=e;const n=this.penalizedPathways,r=performance.now();Object.keys(n).forEach((e=>{r-n[e]>3e5&&delete n[e]}));for(let i=0;i<e.length;i++){const r=e[i];if(r in n)continue;if(r===this.pathwayId)return;const s=this.hls.nextLoadLevel,a=this.hls.levels[s];if(t=this.getLevelsForPathway(r),t.length>0){this.log(`Setting Pathway to "${r}"`),this.pathwayId=r,an(t),this.hls.trigger(y.LEVELS_UPDATED,{levels:t});const e=this.hls.levels[s];a&&e&&this.levels&&(e.attrs["STABLE-VARIANT-ID"]!==a.attrs["STABLE-VARIANT-ID"]&&e.bitrate!==a.bitrate&&this.log(`Unstable Pathways change from bitrate ${a.bitrate} to ${e.bitrate}`),this.hls.nextLoadLevel=s);break}}}getPathwayForGroupId(e,t,n){const r=this.getLevelsForPathway(n).concat(this.levels||[]);for(let i=0;i<r.length;i++)if(t===Bt&&r[i].hasAudioGroup(e)||t===Tt&&r[i].hasSubtitleGroup(e))return r[i].pathwayId;return n}clonePathways(e){const t=this.levels;if(!t)return;const n={},r={};e.forEach((e=>{const{ID:i,"BASE-ID":s,"URI-REPLACEMENT":a}=e;if(t.some((e=>e.pathwayId===i)))return;const o=this.getLevelsForPathway(s).map((e=>{const t=new _(e.attrs);t["PATHWAY-ID"]=i;const s=t.AUDIO&&`${t.AUDIO}_clone_${i}`,o=t.SUBTITLES&&`${t.SUBTITLES}_clone_${i}`;s&&(n[t.AUDIO]=s,t.AUDIO=s),o&&(r[t.SUBTITLES]=o,t.SUBTITLES=o);const l=Aa(e.uri,t["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",a),c=new Jt({attrs:t,audioCodec:e.audioCodec,bitrate:e.bitrate,height:e.height,name:e.name,url:l,videoCodec:e.videoCodec,width:e.width});if(e.audioGroups)for(let n=1;n<e.audioGroups.length;n++)c.addGroupId("audio",`${e.audioGroups[n]}_clone_${i}`);if(e.subtitleGroups)for(let n=1;n<e.subtitleGroups.length;n++)c.addGroupId("text",`${e.subtitleGroups[n]}_clone_${i}`);return c}));t.push(...o),fa(this.audioTracks,n,a,i),fa(this.subtitleTracks,r,a,i)}))}loadSteeringManifest(e){const t=this.hls.config,n=t.loader;let r;this.loader&&this.loader.destroy(),this.loader=new n(t);try{r=new self.URL(e)}catch(c){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${e}`)}if("data:"!==r.protocol){const e=0|(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate);r.searchParams.set("_HLS_pathway",this.pathwayId),r.searchParams.set("_HLS_throughput",""+e)}const i={responseType:"json",url:r.href},s=t.steeringManifestLoadPolicy.default,a=s.errorRetry||s.timeoutRetry||{},o={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(e,t,n,i)=>{this.log(`Loaded steering manifest: "${r}"`);const s=e.data;if(1!==s.VERSION)return void this.log(`Steering VERSION ${s.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=s.TTL;const{"RELOAD-URI":a,"PATHWAY-CLONES":o,"PATHWAY-PRIORITY":l}=s;if(a)try{this.uri=new self.URL(a,r).href}catch(c){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${a}`)}this.scheduleRefresh(this.uri||n.url),o&&this.clonePathways(o);const h={steeringManifest:s,url:r.toString()};this.hls.trigger(y.STEERING_MANIFEST_LOADED,h),l&&this.updatePathwayPriority(l)},onError:(e,t,n,r)=>{if(this.log(`Error loading steering manifest: ${e.code} ${e.text} (${t.url})`),this.stopLoad(),410===e.code)return this.enabled=!1,void this.log(`Steering manifest ${t.url} no longer available`);let i=1e3*this.timeToLoad;if(429!==e.code)this.scheduleRefresh(this.uri||t.url,i);else{const e=this.loader;if("function"==typeof(null==e?void 0:e.getResponseHeader)){const t=e.getResponseHeader("Retry-After");t&&(i=1e3*parseFloat(t))}this.log(`Steering manifest ${t.url} rate limited`)}},onTimeout:(e,t,n)=>{this.log(`Timeout loading steering manifest (${t.url})`),this.scheduleRefresh(this.uri||t.url)}};this.log(`Requesting steering manifest: ${r}`),this.loader.load(i,o,l)}scheduleRefresh(e,t=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout((()=>{var t;const n=null==(t=this.hls)?void 0:t.media;!n||n.ended?this.scheduleRefresh(e,1e3*this.timeToLoad):this.loadSteeringManifest(e)}),t)}}function fa(e,t,n,r){e&&Object.keys(t).forEach((i=>{const s=e.filter((e=>e.groupId===i)).map((e=>{const s=m({},e);return s.details=void 0,s.attrs=new _(s.attrs),s.url=s.attrs.URI=Aa(e.url,e.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",n),s.groupId=s.attrs["GROUP-ID"]=t[i],s.attrs["PATHWAY-ID"]=r,s}));e.push(...s)}))}function Aa(e,t,n,r){const{HOST:i,PARAMS:s,[n]:a}=r;let o;t&&(o=null==a?void 0:a[t],o&&(e=o));const l=new self.URL(e);return i&&!o&&(l.host=i),s&&Object.keys(s).sort().forEach((e=>{e&&l.searchParams.set(e,s[e])})),l.href}const ma=/^age:\s*[\d.]+\s*$/im;class pa{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new D,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,n){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=n,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const n=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0,r.aborted=!1;const i=this.xhrSetup;i?Promise.resolve().then((()=>{if(this.loader===n&&!this.stats.aborted)return i(n,t.url)})).catch((e=>{if(this.loader===n&&!this.stats.aborted)return n.open("GET",t.url,!0),i(n,t.url)})).then((()=>{this.loader!==n||this.stats.aborted||this.openAndSendXhr(n,t,e)})).catch((e=>{this.callbacks.onError({code:n.status,text:e.message},t,n,r)})):this.openAndSendXhr(n,t,e)}openAndSendXhr(e,t,n){e.readyState||e.open("GET",t.url,!0);const r=t.headers,{maxTimeToFirstByteMs:i,maxLoadTimeMs:s}=n.loadPolicy;if(r)for(const a in r)e.setRequestHeader(a,r[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),n.timeout=i&&p(i)?i:s,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:n}=this;if(!e||!t)return;const r=t.readyState,i=this.config;if(!n.aborted&&r>=2&&(0===n.loading.first&&(n.loading.first=Math.max(self.performance.now(),n.loading.start),i.timeout!==i.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),i.timeout=i.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.loadPolicy.maxLoadTimeMs-(n.loading.first-n.loading.start)))),4===r)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const r=t.status,s="text"===t.responseType?t.responseText:null;if(r>=200&&r<300){const i=null!=s?s:t.response;if(null!=i){n.loading.end=Math.max(self.performance.now(),n.loading.first);const s="arraybuffer"===t.responseType?i.byteLength:i.length;if(n.loaded=n.total=s,n.bwEstimate=8e3*n.total/(n.loading.end-n.loading.first),!this.callbacks)return;const a=this.callbacks.onProgress;if(a&&a(n,e,i,t),!this.callbacks)return;const o={url:t.responseURL,data:i,code:r};return void this.callbacks.onSuccess(o,n,e,t)}}const a=i.loadPolicy.errorRetry;un(a,n.retry,!1,{url:e.url,data:void 0,code:r})?this.retry(a):(S.error(`${r} while loading ${e.url}`),this.callbacks.onError({code:r,text:t.statusText},e,t,n))}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry;if(un(e,this.stats.retry,!0))this.retry(e);else{var t;S.warn(`timeout while loading ${null==(t=this.context)?void 0:t.url}`);const e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:n}=this;this.retryDelay=cn(e,n.retry),n.retry++,S.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==t?void 0:t.url}, retrying ${n.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&ma.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const ga=/(\d+)-(\d+)\/(\d+)/;class va{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||ya,this.controller=new self.AbortController,this.stats=new D}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,n){const r=this.stats;if(r.loading.start)throw new Error("Loader can only be used once.");r.loading.start=self.performance.now();const i=function(e,t){const n={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(m({},e.headers))};e.rangeEnd&&n.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1));return n}(e,this.controller.signal),s=n.onProgress,a="arraybuffer"===e.responseType,o=a?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:c}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=n,this.request=this.fetchSetup(e,i),self.clearTimeout(this.requestTimeout),t.timeout=l&&p(l)?l:c,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),n.onTimeout(r,e,this.response)}),t.timeout),self.fetch(this.request).then((i=>{this.response=this.loader=i;const o=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=c,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),n.onTimeout(r,e,this.response)}),c-(o-r.loading.start)),!i.ok){const{status:e,statusText:t}=i;throw new Ea(t||"fetch, bad network response",e,i)}return r.loading.first=o,r.total=function(e){const t=e.get("Content-Range");if(t){const e=function(e){const t=ga.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}(t);if(p(e))return e}const n=e.get("Content-Length");if(n)return parseInt(n)}(i.headers)||r.total,s&&p(t.highWaterMark)?this.loadProgressively(i,r,e,t.highWaterMark,s):a?i.arrayBuffer():"json"===e.responseType?i.json():i.text()})).then((i=>{const a=this.response;if(!a)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);const l=i[o];l&&(r.loaded=r.total=l);const c={url:a.url,data:i,code:a.status};s&&!p(t.highWaterMark)&&s(r,e,i,a),n.onSuccess(c,r,e,a)})).catch((t=>{if(self.clearTimeout(this.requestTimeout),r.aborted)return;const i=t&&t.code||0,s=t?t.message:null;n.onError({code:i,text:s},e,t?t.details:null,r)}))}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,n,r=0,i){const s=new vr,a=e.body.getReader(),o=()=>a.read().then((a=>{if(a.done)return s.dataLength&&i(t,n,s.flush(),e),Promise.resolve(new ArrayBuffer(0));const l=a.value,c=l.length;return t.loaded+=c,c<r||s.dataLength?(s.push(l),s.dataLength>=r&&i(t,n,s.flush(),e)):i(t,n,l,e),o()})).catch((()=>Promise.reject()));return o()}}function ya(e,t){return new self.Request(e.url,t)}class Ea extends Error{constructor(e,t,n){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=n}}const xa=/\s/,Ca=d(d({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:pa,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Dn,bufferController:ki,capLevelController:Ds,errorController:vn,fpsController:Ps,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:ee,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:{newCue(e,t,n,r){const i=[];let s,a,o,l,c;const h=self.VTTCue||self.TextTrackCue;for(let d=0;d<r.rows.length;d++)if(s=r.rows[d],o=!0,l=0,c="",!s.isEmpty()){var u;for(let e=0;e<s.chars.length;e++)xa.test(s.chars[e].uchar)&&o?l++:(c+=s.chars[e].uchar,o=!1);s.cueStartTime=t,t===n&&(n+=1e-4),l>=16?l--:l++;const r=us(c.trim()),f=ps(t,n,r);null!=e&&null!=(u=e.cues)&&u.getCueById(f)||(a=new h(t,n,r),a.id=f,a.line=d+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),i.push(a))}return e&&i.length&&(i.sort(((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line)),i.forEach((t=>Lt(e,t)))),i}},enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:Mi,subtitleTrackController:Di,timelineController:_s,audioStreamController:bi,audioTrackController:_i,emeController:ks,cmcdController:ua,contentSteeringController:da});function wa(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(wa):Object.keys(e).reduce(((t,n)=>(t[n]=wa(e[n]),t)),{}):e}function Ia(e){const t=e.loader;if(t!==va&&t!==pa)S.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1;else{(function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1})()&&(e.loader=va,e.progressive=!0,e.enableSoftwareAES=!0,S.log("[config]: Progressive streaming enabled, using FetchLoader"))}}let ba;class Sa extends yn{constructor(e,t){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach((e=>{e.loadError=0,e.fragmentError=0})),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const n=this.hls.config.preferManagedMediaSource,r=[],i={},s={};let a=!1,o=!1,l=!1;t.levels.forEach((e=>{var t,c;const h=e.attrs;let{audioCodec:u,videoCodec:d}=e;-1!==(null==(t=u)?void 0:t.indexOf("mp4a.40.34"))&&(ba||(ba=/chrome|firefox/i.test(navigator.userAgent)),ba&&(e.audioCodec=u=void 0)),u&&(e.audioCodec=u=ht(u,n)),0===(null==(c=d)?void 0:c.indexOf("avc1"))&&(d=e.videoCodec=function(e){const t=e.split(",");for(let n=0;n<t.length;n++){const e=t[n].split(".");if(e.length>2){let r=e.shift()+".";r+=parseInt(e.shift()).toString(16),r+=("000"+parseInt(e.shift()).toString(16)).slice(-4),t[n]=r}}return t.join(",")}(d));const{width:f,height:A,unknownCodecs:m}=e;if(a||(a=!(!f||!A)),o||(o=!!d),l||(l=!!u),null!=m&&m.length||u&&!rt(u,"audio",n)||d&&!rt(d,"video",n))return;const{CODECS:p,"FRAME-RATE":g,"HDCP-LEVEL":v,"PATHWAY-ID":y,RESOLUTION:E,"VIDEO-RANGE":x}=h,C=`${`${y||"."}-`}${e.bitrate}-${E}-${g}-${p}-${x}-${v}`;if(i[C])if(i[C].uri===e.url||e.attrs["PATHWAY-ID"])i[C].addGroupId("audio",h.AUDIO),i[C].addGroupId("text",h.SUBTITLES);else{const t=s[C]+=1;e.attrs["PATHWAY-ID"]=new Array(t+1).join(".");const n=new Jt(e);i[C]=n,r.push(n)}else{const t=new Jt(e);i[C]=t,s[C]=1,r.push(t)}})),this.filterAndSortMediaOptions(r,t,a,o,l)}filterAndSortMediaOptions(e,t,n,r,i){let s=[],a=[],o=e;if((n||r)&&i&&(o=o.filter((({videoCodec:e,videoRange:t,width:n,height:r})=>{return(!!e||!(!n||!r))&&(!!(i=t)&&jt.indexOf(i)>-1);var i}))),0===o.length)return void Promise.resolve().then((()=>{if(this.hls){t.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(t.levels[0].attrs)}`);const e=new Error("no level with compatible codecs found in manifest");this.hls.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:e,reason:e.message})}}));if(t.audioTracks){const{preferManagedMediaSource:e}=this.hls.config;s=t.audioTracks.filter((t=>!t.audioCodec||rt(t.audioCodec,"audio",e))),Ba(s)}t.subtitles&&(a=t.subtitles,Ba(a));const l=o.slice(0);o.sort(((e,t)=>{if(e.attrs["HDCP-LEVEL"]!==t.attrs["HDCP-LEVEL"])return(e.attrs["HDCP-LEVEL"]||"")>(t.attrs["HDCP-LEVEL"]||"")?1:-1;if(n&&e.height!==t.height)return e.height-t.height;if(e.frameRate!==t.frameRate)return e.frameRate-t.frameRate;if(e.videoRange!==t.videoRange)return jt.indexOf(e.videoRange)-jt.indexOf(t.videoRange);if(e.videoCodec!==t.videoCodec){const n=at(e.videoCodec),r=at(t.videoCodec);if(n!==r)return r-n}if(e.uri===t.uri&&e.codecSet!==t.codecSet){const n=ot(e.codecSet),r=ot(t.codecSet);if(n!==r)return r-n}return e.averageBitrate!==t.averageBitrate?e.averageBitrate-t.averageBitrate:0}));let c=l[0];if(this.steering&&(o=this.steering.filterParsedLevels(o),o.length!==l.length))for(let f=0;f<l.length;f++)if(l[f].pathwayId===o[0].pathwayId){c=l[f];break}this._levels=o;for(let f=0;f<o.length;f++)if(o[f]===c){var h;this._firstLevel=f;const e=c.bitrate,t=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${o.length} level(s) found, first bitrate: ${e}`),void 0===(null==(h=this.hls.userConfig)?void 0:h.abrEwmaDefaultEstimate)){const n=Math.min(e,this.hls.config.abrEwmaDefaultEstimateMax);n>t&&t===Ca.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=n)}break}const u=i&&!r,d={levels:o,audioTracks:s,subtitleTracks:a,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:i,video:r,altAudio:!u&&s.some((e=>!!e.url))};this.hls.trigger(y.MANIFEST_PARSED,d),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(0===t.length)return;if(e<0||e>=t.length){const n=new Error("invalid level idx"),r=e<0;if(this.hls.trigger(y.ERROR,{type:E.OTHER_ERROR,details:x.LEVEL_SWITCH_ERROR,level:e,fatal:r,error:n,reason:n.message}),r)return;e=Math.min(e,t.length-1)}const n=this.currentLevelIndex,r=this.currentLevel,i=r?r.attrs["PATHWAY-ID"]:void 0,s=t[e],a=s.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=s,n===e&&s.details&&r&&i===a)return;this.log(`Switching to level ${e} (${s.height?s.height+"p ":""}${s.videoRange?s.videoRange+" ":""}${s.codecSet?s.codecSet+" ":""}@${s.bitrate})${a?" with Pathway "+a:""} from level ${n}${i?" with Pathway "+i:""}`);const o={level:e,attrs:s.attrs,details:s.details,bitrate:s.bitrate,averageBitrate:s.averageBitrate,maxBitrate:s.maxBitrate,realBitrate:s.realBitrate,width:s.width,height:s.height,codecSet:s.codecSet,audioCodec:s.audioCodec,videoCodec:s.videoCodec,audioGroups:s.audioGroups,subtitleGroups:s.subtitleGroups,loaded:s.loaded,loadError:s.loadError,fragmentError:s.fragmentError,name:s.name,id:s.id,uri:s.uri,url:s.url,urlId:0,audioGroupIds:s.audioGroupIds,textGroupIds:s.textGroupIds};this.hls.trigger(y.LEVEL_SWITCHING,o);const l=s.details;if(!l||l.live){const e=this.switchParams(s.uri,null==r?void 0:r.details,l);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){const e=this.hls.config.startLevel;return void 0!==e?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){!t.fatal&&t.context&&t.context.type===St&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(void 0!==t&&t.type===_t.MAIN){const e=t.elementaryStreams;if(!Object.keys(e).some((t=>!!e[t])))return;const n=this._levels[t.level];null!=n&&n.loadError&&(this.log(`Resetting level error count of ${n.loadError} on frag buffered`),n.loadError=0)}}onLevelLoaded(e,t){var n;const{level:r,details:i}=t,s=this._levels[r];var a;if(!s)return this.warn(`Invalid level index ${r}`),void(null!=(a=t.deliveryDirectives)&&a.skip&&(i.deltaUpdateFailed=!0));r===this.currentLevelIndex?(0===s.fragmentError&&(s.loadError=0),this.playlistLoaded(r,t,s.details)):null!=(n=t.deliveryDirectives)&&n.skip&&(i.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist();const t=this.currentLevelIndex,n=this.currentLevel;if(n&&this.shouldLoadPlaylist(n)){let i=n.uri;if(e)try{i=e.addDirectives(i)}catch(r){this.warn(`Could not construct new URL with HLS Delivery Directives: ${r}`)}const s=n.attrs["PATHWAY-ID"];this.log(`Loading level index ${t}${void 0!==(null==e?void 0:e.msn)?" at sn "+e.msn+" part "+e.part:""} with${s?" Pathway "+s:""} ${i}`),this.clearTimer(),this.hls.trigger(y.LEVEL_LOADING,{url:i,level:t,pathwayId:n.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;const n=this._levels.filter(((t,n)=>n!==e||(this.steering&&this.steering.removeLevel(t),t===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,t.details&&t.details.fragments.forEach((e=>e.level=-1))),!1)));an(n),this._levels=n,this.currentLevelIndex>-1&&null!=(t=this.currentLevel)&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(y.LEVELS_UPDATED,{levels:n})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:n}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(y.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:n}))}}function Ba(e){const t={};e.forEach((e=>{const n=e.groupId||"";e.id=t[n]=t[n]||0,t[n]++}))}class Ta{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const n in this.keyUriToKeyInfo){const r=this.keyUriToKeyInfo[n].loader;if(r){var t;if(e&&e!==(null==(t=r.context)?void 0:t.frag.type))return;r.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=x.KEY_LOAD_ERROR,n,r,i){return new Zn({type:E.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:i,error:n,networkDetails:r})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:n,cc:r}=e;for(let e=0;e<t.length;e++){const i=t[e];if(r<=i.cc&&("initSegment"===n||"initSegment"===i.sn||n<i.sn)){this.emeController.selectKeySystemFormat(i).then((e=>{i.setKeyFormat(e)}));break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then((t=>this.loadInternal(e,t))):this.loadInternal(e)}loadInternal(e,t){var n,r;t&&e.setKeyFormat(t);const i=e.decryptdata;if(!i){const n=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,x.KEY_LOAD_ERROR,n))}const s=i.uri;if(!s)return Promise.reject(this.createKeyLoadError(e,x.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${s}"`)));let a=this.keyUriToKeyInfo[s];if(null!=(n=a)&&n.decryptdata.key)return i.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});var o;if(null!=(r=a)&&r.keyLoadPromise)switch(null==(o=a.mediaKeySessionContext)?void 0:o.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then((t=>(i.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:a})))}switch(a=this.keyUriToKeyInfo[s]={decryptdata:i,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},i.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===i.keyFormat?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,x.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${i.method}"`)))}}loadKeyEME(e,t){const n={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const t=this.emeController.loadKey(n);if(t)return(e.keyLoadPromise=t.then((t=>(e.mediaKeySessionContext=t,n)))).catch((t=>{throw e.keyLoadPromise=null,t}))}return Promise.resolve(n)}loadKeyHTTP(e,t){const n=this.config,r=new(0,n.loader)(n);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise(((i,s)=>{const a={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},o=n.keyLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(e,t,n,r)=>{const{frag:a,keyInfo:o,url:l}=n;if(!a.decryptdata||o!==this.keyUriToKeyInfo[l])return s(this.createKeyLoadError(a,x.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),r));o.decryptdata.key=a.decryptdata.key=new Uint8Array(e.data),a.keyLoader=null,o.loader=null,i({frag:a,keyInfo:o})},onError:(e,n,r,i)=>{this.resetLoader(n),s(this.createKeyLoadError(t,x.KEY_LOAD_ERROR,new Error(`HTTP Error ${e.code} loading key ${e.text}`),r,d({url:a.url,data:void 0},e)))},onTimeout:(e,n,r)=>{this.resetLoader(n),s(this.createKeyLoadError(t,x.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),r))},onAbort:(e,n,r)=>{this.resetLoader(n),s(this.createKeyLoadError(t,x.INTERNAL_ABORTED,new Error("key loading aborted"),r))}};r.load(a,l,c)}))}resetLoader(e){const{frag:t,keyInfo:n,url:r}=e,i=n.loader;t.keyLoader===i&&(t.keyLoader=null,n.loader=null),delete this.keyUriToKeyInfo[r],i&&i.destroy()}}function _a(){return self.SourceBuffer||self.WebKitSourceBuffer}function Ma(){if(!tt())return!1;const e=_a();return!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove}function Ra(){if(!Ma())return!1;const e=tt();return"function"==typeof(null==e?void 0:e.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some((t=>e.isTypeSupported(st(t,"video"))))||["mp4a.40.2","fLaC"].some((t=>e.isTypeSupported(st(t,"audio")))))}class Da{constructor(e,t,n,r){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=n,this.hls=r}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(e,t){const{config:n,media:r,stalled:i}=this;if(null===r)return;const{currentTime:s,seeking:a}=r,o=this.seeking&&!a,l=!this.seeking&&a;if(this.seeking=a,s!==e){if(this.moved=!0,a||(this.nudgeRetry=0),null!==i){if(this.stallReported){const e=self.performance.now()-i;S.warn(`playback not stuck anymore @${s}, after ${Math.round(e)}ms`),this.stallReported=!1}this.stalled=null}return}if(l||o)return void(this.stalled=null);if(r.paused&&!a||r.ended||0===r.playbackRate||!Gn.getBuffered(r).length)return void(this.nudgeRetry=0);const c=Gn.bufferInfo(r,s,0),h=c.nextStart||0;if(a){const e=c.len>2,n=!h||t&&t.start<=s||h-s>2&&!this.fragmentTracker.getPartialFragment(s);if(e||n)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var u;if(!(c.len>0)&&!h)return;const e=Math.max(h,c.start||0)-s,t=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,n=(null==t||null==(u=t.details)?void 0:u.live)?2*t.details.targetduration:2,i=this.fragmentTracker.getPartialFragment(s);if(e>0&&(e<=n||i))return void(r.paused||this._trySkipBufferHole(i))}const d=self.performance.now();if(null===i)return void(this.stalled=d);const f=d-i;if(!a&&f>=250&&(this._reportStall(c),!this.media))return;const A=Gn.bufferInfo(r,s,n.maxBufferHole);this._tryFixBufferStall(A,f)}_tryFixBufferStall(e,t){const{config:n,fragmentTracker:r,media:i}=this;if(null===i)return;const s=i.currentTime,a=r.getPartialFragment(s);if(a){if(this._trySkipBufferHole(a)||!this.media)return}(e.len>n.maxBufferHole||e.nextStart&&e.nextStart-s<n.maxBufferHole)&&t>1e3*n.highBufferWatchdogPeriod&&(S.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:n,stallReported:r}=this;if(!r&&n){this.stallReported=!0;const r=new Error(`Playback stalling at @${n.currentTime} due to low buffer (${JSON.stringify(e)})`);S.warn(r.message),t.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len})}}_trySkipBufferHole(e){const{config:t,hls:n,media:r}=this;if(null===r)return 0;const i=r.currentTime,s=Gn.bufferInfo(r,i,0),a=i<s.start?s.start:s.nextStart;if(a){const o=s.len<=t.maxBufferHole,l=s.len>0&&s.len<1&&r.readyState<3,c=a-i;if(c>0&&(o||l)){if(c>t.maxBufferHole){const{fragmentTracker:t}=this;let n=!1;if(0===i){const e=t.getAppendedFrag(0,_t.MAIN);e&&a<e.end&&(n=!0)}if(!n){const n=e||t.getAppendedFrag(i,_t.MAIN);if(n){let e=!1,r=n.end;for(;r<a;){const n=t.getPartialFragment(r);if(!n){e=!0;break}r+=n.duration}if(e)return 0}}}const s=Math.max(a+.05,i+.1);if(S.warn(`skipping hole, adjusting currentTime from ${i} to ${s}`),this.moved=!0,this.stalled=null,r.currentTime=s,e&&!e.gap){const t=new Error(`fragment loaded with buffer holes, seeking from ${i} to ${s}`);n.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:t,reason:t.message,frag:e})}return s}}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:n,nudgeRetry:r}=this;if(null===n)return;const i=n.currentTime;if(this.nudgeRetry++,r<e.nudgeMaxRetry){const s=i+(r+1)*e.nudgeOffset,a=new Error(`Nudging 'currentTime' from ${i} to ${s}`);S.warn(a.message),n.currentTime=s,t.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.BUFFER_NUDGE_ON_STALL,error:a,fatal:!1})}else{const n=new Error(`Playhead still not moving while enough data buffered @${i} after ${e.nudgeMaxRetry} nudges`);S.error(n.message),t.trigger(y.ERROR,{type:E.MEDIA_ERROR,details:x.BUFFER_STALLED_ERROR,error:n,fatal:!0})}}}class Pa extends gr{constructor(e,t,n){super(e,t,n,"[stream-controller]",_t.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(y.ERROR,this.onError,this),e.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this),e.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(y.ERROR,this.onError,this),e.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this),e.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:n}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let e=n.startLevel;-1===e&&(n.config.testBandwidth&&this.levels.length>1?(e=0,this.bitrateTest=!0):e=n.firstAutoLevel),n.nextLoadLevel=e,this.level=n.loadLevel,this.loadedmetadata=!1}t>0&&-1===e&&(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t),this.state=ar,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=sr}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case pr:{const{levels:e,level:t}=this,n=null==e?void 0:e[t],r=null==n?void 0:n.details;if(r&&(!r.live||this.levelLastLoaded===n)){if(this.waitForCdnTuneIn(r))break;this.state=ar;break}if(this.hls.nextLoadLevel!==this.level){this.state=ar;break}break}case cr:{var e;const t=self.performance.now(),n=this.retryDate;if(!n||t>=n||null!=(e=this.media)&&e.seeking){const{levels:e,level:t}=this,n=null==e?void 0:e[t];this.resetStartWhenNotLoaded(n||null),this.state=ar}}}this.state===ar&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:n,media:r}=this;if(null===t||!r&&(this.startFragRequested||!e.config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;const i=this.buffering?e.nextLoadLevel:e.loadLevel;if(null==n||!n[i])return;const s=n[i],a=this.getMainFwdBufferInfo();if(null===a)return;const o=this.getLevelDetails();if(o&&this._streamEnded(a,o)){const e={};return this.altAudio&&(e.type="video"),this.hls.trigger(y.BUFFER_EOS,e),void(this.state=fr)}if(!this.buffering)return;e.loadLevel!==i&&-1===e.manualLevel&&this.log(`Adapting to level ${i} from level ${this.level}`),this.level=e.nextLoadLevel=i;const l=s.details;if(!l||this.state===pr||l.live&&this.levelLastLoaded!==s)return this.level=i,void(this.state=pr);const c=a.len,h=this.getMaxBufferLength(s.maxBitrate);if(c>=h)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const u=this.backtrackFragment?this.backtrackFragment.start:a.end;let d=this.getNextFragment(u,l);if(this.couldBacktrack&&!this.fragPrevious&&d&&"initSegment"!==d.sn&&this.fragmentTracker.getState(d)!==On){var f;const e=(null!=(f=this.backtrackFragment)?f:d).sn-l.startSN,t=l.fragments[e-1];t&&d.cc===t.cc&&(d=t,this.fragmentTracker.removeFragment(t))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(d&&this.isLoopLoading(d,u)){if(!d.gap){const e=this.audioOnly&&!this.altAudio?P:L,t=(e===L?this.videoBuffer:this.mediaBuffer)||this.media;t&&this.afterBufferFlushed(t,e,_t.MAIN)}d=this.getNextFragmentLoopLoading(d,l,a,_t.MAIN,h)}d&&(!d.initSegment||d.initSegment.data||this.bitrateTest||(d=d.initSegment),this.loadFragment(d,s,u))}loadFragment(e,t,n){const r=this.fragmentTracker.getState(e);this.fragCurrent=e,r===Ln||r===Fn?"initSegment"===e.sn?this._loadInitSegment(e,t):this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,super.loadFragment(e,t,n)):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,_t.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(null!=t&&t.readyState){let n;const r=this.getAppendedFrag(t.currentTime);r&&r.start>1&&this.flushMainBuffer(0,r.start-1);const i=this.getLevelDetails();if(null!=i&&i.live){const e=this.getMainFwdBufferInfo();if(!e||e.len<2*i.targetduration)return}if(!t.paused&&e){const t=e[this.hls.nextLoadLevel],r=this.fragLastKbps;n=r&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*r)+1:0}else n=0;const s=this.getBufferedFrag(t.currentTime+n);if(s){const e=this.followingBufferedFrag(s);if(e){this.abortCurrentFrag();const t=e.maxStartPTS?e.maxStartPTS:e.start,n=e.duration,r=Math.max(s.end,t+Math.min(Math.max(n-this.config.maxFragLookUpTolerance,n*(this.couldBacktrack?.5:.125)),n*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(r,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case or:case lr:case cr:case ur:case dr:this.state=ar}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const n=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),n.addEventListener("playing",this.onvplaying),n.addEventListener("seeked",this.onvseeked),this.gapController=new Da(this.config,n,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;p(t)&&this.log(`Media seeked to ${t.toFixed(3)}`);const n=this.getMainFwdBufferInfo();null!==n&&0!==n.len?this.tick():this.warn(`Main forward buffer length on "seeked" event ${n?n.len:"empty"})`)}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(y.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(e,t){let n=!1,r=!1;t.levels.forEach((e=>{const t=e.audioCodec;t&&(n=n||-1!==t.indexOf("mp4a.40.2"),r=r||-1!==t.indexOf("mp4a.40.5"))})),this.audioCodecSwitch=n&&r&&!function(){var e;const t=_a();return"function"==typeof(null==t||null==(e=t.prototype)?void 0:e.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:n}=this;if(!n||this.state!==ar)return;const r=n[t.level];(!r.details||r.details.live&&this.levelLastLoaded!==r||this.waitForCdnTuneIn(r.details))&&(this.state=pr)}onLevelLoaded(e,t){var n;const{levels:r}=this,i=t.level,s=t.details,a=s.totalduration;if(!r)return void this.warn(`Levels were reset while loading level ${i}`);this.log(`Level ${i} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""}, cc [${s.startCC}, ${s.endCC}] duration:${a}`);const o=r[i],l=this.fragCurrent;!l||this.state!==lr&&this.state!==cr||l.level!==t.level&&l.loader&&this.abortCurrentFrag();let c=0;if(s.live||null!=(n=o.details)&&n.live){var h;if(this.checkLiveUpdate(s),s.deltaUpdateFailed)return;c=this.alignPlaylists(s,o.details,null==(h=this.levelLastLoaded)?void 0:h.details)}if(o.details=s,this.levelLastLoaded=o,this.hls.trigger(y.LEVEL_UPDATED,{details:s,level:i}),this.state===pr){if(this.waitForCdnTuneIn(s))return;this.state=ar}this.startFragRequested?s.live&&this.synchronizeToLiveEdge(s):this.setStartPosition(s,c),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:n,part:r,payload:i}=e,{levels:s}=this;if(!s)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);const a=s[n.level],o=a.details;if(!o)return this.warn(`Dropping fragment ${n.sn} of level ${n.level} after level details were reset`),void this.fragmentTracker.removeFragment(n);const l=a.videoCodec,c=o.PTSKnown||!o.live,h=null==(t=n.initSegment)?void 0:t.data,u=this._getAudioCodec(a),d=this.transmuxer=this.transmuxer||new Ii(this.hls,_t.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=r?r.index:-1,A=-1!==f,m=new Hn(n.level,n.sn,n.stats.chunkCount,i.byteLength,f,A),p=this.initPTS[n.cc];d.push(i,h,u,l,n,r,o.totalduration,c,m,p)}onAudioTrackSwitching(e,t){const n=this.altAudio;if(!!!t.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const e=this.fragCurrent;e&&(this.log("Switching to main audio track, cancel main fragment load"),e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const e=this.hls;n&&(e.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),e.trigger(y.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const n=t.id,r=!!this.hls.audioTracks[n].url;if(r){const e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=e)}this.altAudio=r,this.tick()}onBufferCreated(e,t){const n=t.tracks;let r,i,s=!1;for(const a in n){const e=n[a];if("main"===e.id){if(i=a,r=e,"video"===a){const e=n[a];e&&(this.videoBuffer=e.buffer)}}else s=!0}s&&r?(this.log(`Alternate track found, use ${i}.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:n,part:r}=t;if(n&&n.type!==_t.MAIN)return;if(this.fragContextChanged(n))return this.warn(`Fragment ${n.sn}${r?" p: "+r.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===dr&&(this.state=ar));const i=r?r.stats:n.stats;this.fragLastKbps=Math.round(8*i.total/(i.buffering.end-i.loading.first)),"initSegment"!==n.sn&&(this.fragPrevious=n),this.fragBufferedComplete(n,r)}onError(e,t){var n;if(t.fatal)this.state=Ar;else switch(t.details){case x.FRAG_GAP:case x.FRAG_PARSING_ERROR:case x.FRAG_DECRYPT_ERROR:case x.FRAG_LOAD_ERROR:case x.FRAG_LOAD_TIMEOUT:case x.KEY_LOAD_ERROR:case x.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(_t.MAIN,t);break;case x.LEVEL_LOAD_ERROR:case x.LEVEL_LOAD_TIMEOUT:case x.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==pr||(null==(n=t.context)?void 0:n.type)!==St||(this.state=ar);break;case x.BUFFER_APPEND_ERROR:case x.BUFFER_FULL_ERROR:if(!t.parent||"main"!==t.parent)return;if(t.details===x.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case x.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}checkBuffer(){const{media:e,gapController:t}=this;if(e&&t&&e.readyState){if(this.loadedmetadata||!Gn.getBuffered(e).length){const e=this.state!==ar?this.fragCurrent:null;t.poll(this.lastCurrentTime,e)}this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state=ar,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==P||this.audioOnly&&!this.altAudio){const e=(t===L?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(e,t,_t.MAIN),this.tick()}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let n=this.startPosition;if(n>=0&&t<n){if(e.seeking)return void this.log(`could not seek to ${n}, already seeking at ${t}`);const r=Gn.getBuffered(e),i=(r.length?r.start(0):0)-n;i>0&&(i<this.config.maxBufferHole||i<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${i} to match buffer start`),n+=i,this.startPosition=n),this.log(`seek to target start position ${n} from current time ${t}`),e.currentTime=n}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then((n=>{const{hls:r}=this;if(!n||this.fragContextChanged(e))return;t.fragmentError=0,this.state=ar,this.startFragRequested=!1,this.bitrateTest=!1;const i=e.stats;i.parsing.start=i.parsing.end=i.buffering.start=i.buffering.end=self.performance.now(),r.trigger(y.FRAG_LOADED,n),e.bitrateTest=!1}))}_handleTransmuxComplete(e){var t;const n="main",{hls:r}=this,{remuxResult:i,chunkMeta:s}=e,a=this.getCurrentContext(s);if(!a)return void this.resetWhenMissingContext(s);const{frag:o,part:l,level:c}=a,{video:h,text:u,id3:d,initSegment:f}=i,{details:A}=c,m=this.altAudio?void 0:i.audio;if(this.fragContextChanged(o))this.fragmentTracker.removeFragment(o);else{if(this.state=ur,f){if(null!=f&&f.tracks){const e=o.initSegment||o;this._bufferInitSegment(c,f.tracks,e,s),r.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:n,tracks:f.tracks})}const e=f.initPTS,t=f.timescale;p(e)&&(this.initPTS[o.cc]={baseTime:e,timescale:t},r.trigger(y.INIT_PTS_FOUND,{frag:o,id:n,initPTS:e,timescale:t}))}if(h&&A&&"initSegment"!==o.sn){const e=A.fragments[o.sn-1-A.startSN],t=o.sn===A.startSN,n=!e||o.cc>e.cc;if(!1!==i.independent){const{startPTS:e,endPTS:r,startDTS:i,endDTS:a}=h;if(l)l.elementaryStreams[h.type]={startPTS:e,endPTS:r,startDTS:i,endDTS:a};else if(h.firstKeyFrame&&h.independent&&1===s.id&&!n&&(this.couldBacktrack=!0),h.dropped&&h.independent){const i=this.getMainFwdBufferInfo(),s=(i?i.end:this.getLoadPosition())+this.config.maxBufferHole,l=h.firstKeyFramePTS?h.firstKeyFramePTS:e;if(!t&&s<l-this.config.maxBufferHole&&!n)return void this.backtrack(o);n&&(o.gap=!0),o.setElementaryStreamInfo(h.type,o.start,r,o.start,a,!0)}else t&&e>2&&(o.gap=!0);o.setElementaryStreamInfo(h.type,e,r,i,a),this.backtrackFragment&&(this.backtrackFragment=o),this.bufferFragmentData(h,o,l,s,t||n)}else{if(!t&&!n)return void this.backtrack(o);o.gap=!0}}if(m){const{startPTS:e,endPTS:t,startDTS:n,endDTS:r}=m;l&&(l.elementaryStreams[P]={startPTS:e,endPTS:t,startDTS:n,endDTS:r}),o.setElementaryStreamInfo(P,e,t,n,r),this.bufferFragmentData(m,o,l,s)}if(A&&null!=d&&null!=(t=d.samples)&&t.length){const e={id:n,frag:o,details:A,samples:d.samples};r.trigger(y.FRAG_PARSING_METADATA,e)}if(A&&u){const e={id:n,frag:o,details:A,samples:u.samples};r.trigger(y.FRAG_PARSING_USERDATA,e)}}}_bufferInitSegment(e,t,n,r){if(this.state!==ur)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:i,video:s,audiovideo:a}=t;if(i){let t=e.audioCodec;const n=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){t&&(t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");const e=i.metadata;e&&"channelCount"in e&&1!==(e.channelCount||1)&&-1===n.indexOf("firefox")&&(t="mp4a.40.5")}t&&-1!==t.indexOf("mp4a.40.5")&&-1!==n.indexOf("android")&&"audio/mpeg"!==i.container&&(t="mp4a.40.2",this.log(`Android: force audio codec to ${t}`)),e.audioCodec&&e.audioCodec!==t&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${t}"`),i.levelCodec=t,i.id="main",this.log(`Init audio buffer, container:${i.container}, codecs[selected/level/parsed]=[${t||""}/${e.audioCodec||""}/${i.codec}]`)}s&&(s.levelCodec=e.videoCodec,s.id="main",this.log(`Init video buffer, container:${s.container}, codecs[level/parsed]=[${e.videoCodec||""}/${s.codec}]`)),a&&this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),this.hls.trigger(y.BUFFER_CODECS,t),Object.keys(t).forEach((e=>{const i=t[e].initSegment;null!=i&&i.byteLength&&this.hls.trigger(y.BUFFER_APPENDING,{type:e,data:i,frag:n,part:null,chunkMeta:r,parent:n.type})})),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,_t.MAIN)}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=ar}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&!1===e.seeking){const n=e.currentTime;if(Gn.isBuffered(e,n)?t=this.getAppendedFrag(n):Gn.isBuffered(e,n+.1)&&(t=this.getAppendedFrag(n+.1)),t){this.backtrackFragment=null;const e=this.fragPlaying,n=t.level;e&&t.sn===e.sn&&e.level===n||(this.fragPlaying=t,this.hls.trigger(y.FRAG_CHANGED,{frag:t}),e&&e.level===n||this.hls.trigger(y.LEVEL_SWITCHED,{level:n}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){const e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}get currentProgramDateTime(){const e=this.media;if(e){const t=e.currentTime,n=this.currentFrag;if(n&&p(t)&&p(n.programDateTime)){const e=n.programDateTime+1e3*(t-n.start);return new Date(e)}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class La{static get version(){return"1.5.20"}static isMSESupported(){return Ma()}static isSupported(){return Ra()}static getMediaSource(){return tt()}static get Events(){return y}static get ErrorTypes(){return E}static get ErrorDetails(){return x}static get DefaultConfig(){return La.defaultConfig?La.defaultConfig:Ca}static set DefaultConfig(e){La.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new wi,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,function(e,t){if("object"==typeof console&&!0===e||"object"==typeof e){b(e,"debug","log","info","warn","error");try{I.log(`Debug logs enabled for "${t}" in hls.js version 1.5.20`)}catch(n){I=w}}else I=w}(e.debug||!1,"Hls instance");const t=this.config=function(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const n=wa(e),r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach((e=>{const i=`${"level"===e?"playlist":e}LoadPolicy`,s=void 0===t[i],a=[];r.forEach((r=>{const o=`${e}Loading${r}`,l=t[o];if(void 0!==l&&s){a.push(o);const e=n[i].default;switch(t[i]={default:e},r){case"TimeOut":e.maxLoadTimeMs=l,e.maxTimeToFirstByteMs=l;break;case"MaxRetry":e.errorRetry.maxNumRetry=l,e.timeoutRetry.maxNumRetry=l;break;case"RetryDelay":e.errorRetry.retryDelayMs=l,e.timeoutRetry.retryDelayMs=l;break;case"MaxRetryTimeout":e.errorRetry.maxRetryDelayMs=l,e.timeoutRetry.maxRetryDelayMs=l}}})),a.length&&S.warn(`hls.js config: "${a.join('", "')}" setting(s) are deprecated, use "${i}": ${JSON.stringify(t[i])}`)})),d(d({},n),t)}(La.DefaultConfig,e);this.userConfig=e,t.progressive&&Ia(t);const{abrController:n,bufferController:r,capLevelController:i,errorController:s,fpsController:a}=t,o=new s(this),l=this.abrController=new n(this),c=this.bufferController=new r(this),h=this.capLevelController=new i(this),u=new a(this),f=new Dt(this),A=new Ht(this),m=t.contentSteeringController,p=m?new m(this):null,g=this.levelController=new Sa(this,p),v=new Un(this),E=new Ta(this.config),x=this.streamController=new Pa(this,v,E);h.setStreamController(x),u.setStreamController(x);const C=[f,g,x];p&&C.splice(1,0,p),this.networkControllers=C;const B=[l,c,h,u,A,v];this.audioTrackController=this.createController(t.audioTrackController,C);const T=t.audioStreamController;T&&C.push(new T(this,v,E)),this.subtitleTrackController=this.createController(t.subtitleTrackController,C);const _=t.subtitleStreamController;_&&C.push(new _(this,v,E)),this.createController(t.timelineController,B),E.emeController=this.emeController=this.createController(t.emeController,B),this.cmcdController=this.createController(t.cmcdController,B),this.latencyController=this.createController(qt,B),this.coreComponents=B,C.push(o);const M=o.onErrorOut;"function"==typeof M&&this.on(y.ERROR,M,o)}createController(e,t){if(e){const n=new e(this);return t&&t.push(n),n}return null}on(e,t,n=this){this._emitter.on(e,t,n)}once(e,t,n=this){this._emitter.once(e,t,n)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,n=this,r){this._emitter.off(e,t,n,r)}listeners(e){return this._emitter.listeners(e)}emit(e,t,n){return this._emitter.emit(e,t,n)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(n){if(S.error("An internal error happened while handling event "+e+'. Error message: "'+n.message+'". Here is a stacktrace:',n),!this.triggeringException){this.triggeringException=!0;const t=e===y.ERROR;this.trigger(y.ERROR,{type:E.OTHER_ERROR,details:x.INTERNAL_EXCEPTION,fatal:t,event:e,error:n}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){S.log("destroy"),this.trigger(y.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((e=>e.destroy())),this.networkControllers.length=0,this.coreComponents.forEach((e=>e.destroy())),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){S.log("attachMedia"),this._media=e,this.trigger(y.MEDIA_ATTACHING,{media:e})}detachMedia(){S.log("detachMedia"),this.trigger(y.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,n=this.url,r=this.url=h.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,S.log(`loadSource:${r}`),t&&n&&(n!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(y.MANIFEST_LOADING,{url:e})}startLoad(e=-1){S.log(`startLoad(${e})`),this.started=!0,this.resumeBuffering();for(let t=0;t<this.networkControllers.length&&(this.networkControllers[t].startLoad(e),this.started&&this.networkControllers);t++);}stopLoad(){S.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!this.started&&this.networkControllers);e++);}resumeBuffering(){S.log("resume buffering"),this.networkControllers.forEach((e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){S.log("pause buffering"),this.networkControllers.forEach((e=>{e.pauseBuffering&&e.pauseBuffering()}))}swapAudioCodec(){S.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){S.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e){this.levelController.removeLevel(e)}get levels(){const e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){S.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){S.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){S.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){S.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return-1===e&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){S.log(`set startLevel:${e}`),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(S.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){(function(e){return Yt.indexOf(e)>-1})(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const n=e.length;for(let r=0;r<n;r++)if(e[r].maxBitrate>=t)return r;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:n}=this;let r;if(r=-1===t&&null!=e&&e.length?e.length-1:t,n)for(let i=r;i--;){const t=e[i].attrs["HDCP-LEVEL"];if(t&&t<=n)return i}return r}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(e){var t;return null==(t=this.audioTrackController)?void 0:t.setAudioOption(e)}setSubtitleOption(e){var t;return null==(t=this.subtitleTrackController)||t.setSubtitleOption(e),null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}La.defaultConfig=void 0},5276:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AccumulativeShadows:()=>my,AdaptiveDpr:()=>tx,AdaptiveEvents:()=>nx,ArcballControls:()=>ac,AsciiRenderer:()=>dl,BBAnchor:()=>Up,Backdrop:()=>Cy,BakeShadows:()=>WE,Billboard:()=>fr,Bounds:()=>wv,Box:()=>Kg,Bvh:()=>Bp,CameraControls:()=>Ih,CameraShake:()=>Tv,Capsule:()=>uv,CatmullRomLine:()=>$r,Caustics:()=>_y,Center:()=>Hp,Circle:()=>Wg,Clone:()=>Na,Cloud:()=>rE,CloudInstance:()=>nE,Clouds:()=>tE,ComputedAttribute:()=>La,Cone:()=>Jg,ContactShadows:()=>dy,CubeCamera:()=>wl,CubeTexture:()=>lu,CubicBezierLine:()=>Xr,CurveModifier:()=>yg,CycleRaycast:()=>y,Cylinder:()=>Xg,Decal:()=>Xa,Detailed:()=>VE,DetectGPU:()=>Uf,DeviceOrientationControls:()=>Ml,Dodecahedron:()=>lv,DragControls:()=>We,Edges:()=>pa,Effects:()=>ra,Environment:()=>cy,EnvironmentCube:()=>ay,EnvironmentMap:()=>sy,EnvironmentPortal:()=>oy,Example:()=>qp,Extrude:()=>cv,FaceControls:()=>VC,FaceLandmarker:()=>GC,FaceLandmarkerDefaults:()=>zC,Facemesh:()=>FC,FacemeshDatas:()=>QC,FacemeshEye:()=>UC,FacemeshEyeDefaults:()=>OC,Fbo:()=>yl,Fbx:()=>fd,FirstPersonControls:()=>Bc,Fisheye:()=>dx,Float:()=>_v,FlyControls:()=>kl,GizmoHelper:()=>zh,GizmoViewcube:()=>tu,GizmoViewport:()=>iu,Gltf:()=>hl,GradientTexture:()=>sa,GradientType:()=>ia,Grid:()=>au,Helper:()=>mf,Html:()=>v,Hud:()=>Mh,Icosahedron:()=>av,Image:()=>ma,Instance:()=>ig,InstancedAttribute:()=>cg,Instances:()=>sg,IsObject:()=>oa,KeyboardControls:()=>Gn,Ktx2:()=>rf,Lathe:()=>hv,Lightformer:()=>Qy,Line:()=>Kr,Loader:()=>_,MapControls:()=>ql,MarchingCube:()=>ja,MarchingCubes:()=>Ya,MarchingPlane:()=>Va,Mask:()=>hx,MatcapTexture:()=>fE,Merged:()=>ag,MeshDiscardMaterial:()=>Qg,MeshDistortMaterial:()=>xg,MeshPortalMaterial:()=>mx,MeshReflectorMaterial:()=>Bg,MeshRefractionMaterial:()=>kg,MeshTransmissionMaterial:()=>Ug,MeshWobbleMaterial:()=>wg,MotionPathControls:()=>Th,MultiMaterial:()=>Ng,NormalTexture:()=>gE,Octahedron:()=>ov,OrbitControls:()=>Yl,OrthographicCamera:()=>El,Outlines:()=>va,PerformanceMonitor:()=>ix,PerspectiveCamera:()=>xl,PivotControls:()=>RC,Plane:()=>Zg,Point:()=>QE,PointMaterial:()=>Hg,PointMaterialImpl:()=>Gg,PointerLockControls:()=>Cc,Points:()=>zE,PointsBuffer:()=>NE,Polyhedron:()=>sv,PositionMesh:()=>Jp,PositionPoint:()=>DE,PositionalAudio:()=>Zr,Preload:()=>KE,PresentationControls:()=>Qn,Progress:()=>B,QuadraticBezierLine:()=>Jr,RandomizedLight:()=>py,RenderCubeTexture:()=>lx,RenderTexture:()=>ax,Resize:()=>gv,Ring:()=>iv,RoundedBox:()=>Av,Sampler:()=>Pa,ScreenQuad:()=>pv,ScreenSizer:()=>xr,ScreenSpace:()=>Ar,ScreenVideoTexture:()=>DC,Scroll:()=>Un,ScrollControls:()=>kn,Segment:()=>jE,SegmentObject:()=>qE,Segments:()=>HE,Select:()=>ur,Shadow:()=>wy,ShadowAlpha:()=>BE,Shape:()=>dv,Sky:()=>qy,SoftShadows:()=>jg,Sparkles:()=>cE,Sphere:()=>$g,Splat:()=>gl,SpotLight:()=>Uy,SpotLightShadow:()=>Oy,SpriteAnimator:()=>fg,Stage:()=>Ey,Stars:()=>Vy,Stats:()=>yf,StatsGl:()=>Cf,Svg:()=>Za,Tetrahedron:()=>rv,Text:()=>ws,Text3D:()=>Fs,Texture:()=>ca,Torus:()=>tv,TorusKnot:()=>nv,TrackballControls:()=>Wl,Trail:()=>Ta,TrailTexture:()=>Gp,TransformControls:()=>dc,Tube:()=>ev,VideoTexture:()=>cf,View:()=>Nx,WebcamVideoTexture:()=>PC,Wireframe:()=>SE,accumulativeContext:()=>fy,calcPosFromAngles:()=>Hy,calculateScaleFactor:()=>yr,checkIfFrameIsEmpty:()=>df,createInstances:()=>lg,getFirstFrame:()=>uf,isWebGL2Available:()=>na,meshBounds:()=>ex,shaderMaterial:()=>aa,useAnimations:()=>_p,useAspect:()=>If,useBVH:()=>Sp,useBounds:()=>Iv,useBoxProjectedEnv:()=>kp,useCamera:()=>bf,useContextBridge:()=>Tp,useCubeCamera:()=>Cl,useCubeTexture:()=>ou,useCursor:()=>E,useDepthBuffer:()=>wf,useDetectGPU:()=>Of,useEnvironment:()=>Xv,useFBO:()=>vl,useFBX:()=>dd,useFaceControls:()=>KC,useFaceLandmarker:()=>HC,useFont:()=>Ls,useGLTF:()=>cl,useGizmoContext:()=>Dh,useHelper:()=>Af,useIntersect:()=>Mp,useKTX2:()=>nf,useKeyboardControls:()=>Hn,useMask:()=>ux,useMatcapTexture:()=>dE,useMotion:()=>Sh,useNormalTexture:()=>pE,usePerformanceMonitor:()=>sx,useProgress:()=>S,useScroll:()=>Ln,useSelect:()=>dr,useSpriteAnimator:()=>ug,useSpriteLoader:()=>ff,useSurfaceSampler:()=>Da,useTexture:()=>la,useTrail:()=>Ba,useTrailTexture:()=>zp,useVideoTexture:()=>lf});var r=n(8168),i=n(6540),s=n(5338),a=n(4922),o=n(2111);const l=new a.Pq0,c=new a.Pq0,h=new a.Pq0,u=new a.I9Y;function d(e,t,n){const r=l.setFromMatrixPosition(e.matrixWorld);r.project(t);const i=n.width/2,s=n.height/2;return[r.x*i+i,-r.y*s+s]}const f=e=>Math.abs(e)<1e-10?0:e;function A(e,t,n=""){let r="matrix3d(";for(let i=0;16!==i;i++)r+=f(t[i]*e.elements[i])+(15!==i?",":")");return n+r}const m=(p=[1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1],e=>A(e,p));var p;const g=(e,t)=>A(e,(e=>[1/e,1/e,1/e,1,-1/e,-1/e,-1/e,-1,1/e,1/e,1/e,1,1,1,1,1])(t),"translate(-50%,-50%)");const v=i.forwardRef((({children:e,eps:t=.001,style:n,className:A,prepend:p,center:v,fullscreen:y,portal:E,distanceFactor:x,sprite:C=!1,transform:w=!1,occlude:I,onOcclude:b,castShadow:S,receiveShadow:B,material:T,geometry:_,zIndexRange:M=[16777271,0],calculatePosition:R=d,as:D="div",wrapperClass:P,pointerEvents:L="auto",...k},F)=>{const{gl:O,camera:U,scene:Q,size:N,raycaster:z,events:G,viewport:H}=(0,o.A)(),[q]=i.useState((()=>document.createElement(D))),Y=i.useRef(null),j=i.useRef(null),V=i.useRef(0),K=i.useRef([0,0]),W=i.useRef(null),J=i.useRef(null),X=(null==E?void 0:E.current)||G.connected||O.domElement.parentNode,$=i.useRef(null),Z=i.useRef(!1),ee=i.useMemo((()=>I&&"blending"!==I||Array.isArray(I)&&I.length&&function(e){return e&&"object"==typeof e&&"current"in e}(I[0])),[I]);i.useLayoutEffect((()=>{const e=O.domElement;I&&"blending"===I?(e.style.zIndex=`${Math.floor(M[0]/2)}`,e.style.position="absolute",e.style.pointerEvents="none"):(e.style.zIndex=null,e.style.position=null,e.style.pointerEvents=null)}),[I]),i.useLayoutEffect((()=>{if(j.current){const e=Y.current=s.createRoot(q);if(Q.updateMatrixWorld(),w)q.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const e=R(j.current,U,N);q.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${e[0]}px,${e[1]}px,0);transform-origin:0 0;`}return X&&(p?X.prepend(q):X.appendChild(q)),()=>{X&&X.removeChild(q),e.unmount()}}}),[X,w]),i.useLayoutEffect((()=>{P&&(q.className=P)}),[P]);const te=i.useMemo((()=>w?{position:"absolute",top:0,left:0,width:N.width,height:N.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:v?"translate3d(-50%,-50%,0)":"none",...y&&{top:-N.height/2,left:-N.width/2,width:N.width,height:N.height},...n}),[n,v,y,N,w]),ne=i.useMemo((()=>({position:"absolute",pointerEvents:L})),[L]);i.useLayoutEffect((()=>{var t,r;(Z.current=!1,w)?null==(t=Y.current)||t.render(i.createElement("div",{ref:W,style:te},i.createElement("div",{ref:J,style:ne},i.createElement("div",{ref:F,className:A,style:n,children:e})))):null==(r=Y.current)||r.render(i.createElement("div",{ref:F,style:te,className:A,children:e}))}));const re=i.useRef(!0);(0,o.C)((e=>{if(j.current){U.updateMatrixWorld(),j.current.updateWorldMatrix(!0,!1);const e=w?K.current:R(j.current,U,N);if(w||Math.abs(V.current-U.zoom)>t||Math.abs(K.current[0]-e[0])>t||Math.abs(K.current[1]-e[1])>t){const t=function(e,t){const n=l.setFromMatrixPosition(e.matrixWorld),r=c.setFromMatrixPosition(t.matrixWorld),i=n.sub(r),s=t.getWorldDirection(h);return i.angleTo(s)>Math.PI/2}(j.current,U);let n=!1;ee&&(Array.isArray(I)?n=I.map((e=>e.current)):"blending"!==I&&(n=[Q]));const r=re.current;if(n){const e=function(e,t,n,r){const i=l.setFromMatrixPosition(e.matrixWorld),s=i.clone();s.project(t),u.set(s.x,s.y),n.setFromCamera(u,t);const a=n.intersectObjects(r,!0);if(a.length){const e=a[0].distance;return i.distanceTo(n.ray.origin)<e}return!0}(j.current,U,z,n);re.current=e&&!t}else re.current=!t;r!==re.current&&(b?b(!re.current):q.style.display=re.current?"block":"none");const i=Math.floor(M[0]/2),s=I?ee?[M[0],i]:[i-1,0]:M;if(q.style.zIndex=`${function(e,t,n){if(t instanceof a.ubm||t instanceof a.qUd){const r=l.setFromMatrixPosition(e.matrixWorld),i=c.setFromMatrixPosition(t.matrixWorld),s=r.distanceTo(i),a=(n[1]-n[0])/(t.far-t.near),o=n[1]-a*t.far;return Math.round(a*s+o)}}(j.current,U,s)}`,w){const[e,t]=[N.width/2,N.height/2],n=U.projectionMatrix.elements[5]*t,{isOrthographicCamera:r,top:i,left:s,bottom:a,right:o}=U,l=m(U.matrixWorldInverse),c=r?`scale(${n})translate(${f(-(o+s)/2)}px,${f((i+a)/2)}px)`:`translateZ(${n}px)`;let h=j.current.matrixWorld;C&&(h=U.matrixWorldInverse.clone().transpose().copyPosition(h).scale(j.current.scale),h.elements[3]=h.elements[7]=h.elements[11]=0,h.elements[15]=1),q.style.width=N.width+"px",q.style.height=N.height+"px",q.style.perspective=r?"":`${n}px`,W.current&&J.current&&(W.current.style.transform=`${c}${l}translate(${e}px,${t}px)`,J.current.style.transform=g(h,1/((x||10)/400)))}else{const t=void 0===x?1:function(e,t){if(t instanceof a.qUd)return t.zoom;if(t instanceof a.ubm){const n=l.setFromMatrixPosition(e.matrixWorld),r=c.setFromMatrixPosition(t.matrixWorld),i=t.fov*Math.PI/180,s=n.distanceTo(r);return 1/(2*Math.tan(i/2)*s)}return 1}(j.current,U)*x;q.style.transform=`translate3d(${e[0]}px,${e[1]}px,0) scale(${t})`}K.current=e,V.current=U.zoom}}if(!ee&&$.current&&!Z.current)if(w){if(W.current){const e=W.current.children[0];if(null!=e&&e.clientWidth&&null!=e&&e.clientHeight){const{isOrthographicCamera:t}=U;if(t||_)k.scale&&(Array.isArray(k.scale)?k.scale instanceof a.Pq0?$.current.scale.copy(k.scale.clone().divideScalar(1)):$.current.scale.set(1/k.scale[0],1/k.scale[1],1/k.scale[2]):$.current.scale.setScalar(1/k.scale));else{const t=(x||10)/400,n=e.clientWidth*t,r=e.clientHeight*t;$.current.scale.set(n,r,1)}Z.current=!0}}}else{const t=q.children[0];if(null!=t&&t.clientWidth&&null!=t&&t.clientHeight){const e=1/H.factor,n=t.clientWidth*e,r=t.clientHeight*e;$.current.scale.set(n,r,1),Z.current=!0}$.current.lookAt(e.camera.position)}}));const ie=i.useMemo((()=>({vertexShader:w?void 0:'\n          /*\n            This shader is from the THREE\'s SpriteMaterial.\n            We need to turn the backing plane into a Sprite\n            (make it always face the camera) if "transfrom"\n            is false.\n          */\n          #include <common>\n\n          void main() {\n            vec2 center = vec2(0., 1.);\n            float rotation = 0.0;\n\n            // This is somewhat arbitrary, but it seems to work well\n            // Need to figure out how to derive this dynamically if it even matters\n            float size = 0.03;\n\n            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n            vec2 scale;\n            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\n            bool isPerspective = isPerspectiveMatrix( projectionMatrix );\n            if ( isPerspective ) scale *= - mvPosition.z;\n\n            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;\n            vec2 rotatedPosition;\n            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n            mvPosition.xy += rotatedPosition;\n\n            gl_Position = projectionMatrix * mvPosition;\n          }\n      ',fragmentShader:"\n        void main() {\n          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n        }\n      "})),[w]);return i.createElement("group",(0,r.A)({},k,{ref:j}),I&&!ee&&i.createElement("mesh",{castShadow:S,receiveShadow:B,ref:$},_||i.createElement("planeGeometry",null),T||i.createElement("shaderMaterial",{side:a.$EB,vertexShader:ie.vertexShader,fragmentShader:ie.fragmentShader})))}));function y({onChanged:e,portal:t,preventDefault:n=!0,scroll:r=!0,keyCode:s=9}){const a=i.useRef(0),l=(0,o.A)((e=>e.setEvents)),c=(0,o.A)((e=>e.get)),h=(0,o.A)((e=>e.gl));return i.useEffect((()=>{var i;let o,u=[];const d=c().events.filter,f=null!==(i=null==t?void 0:t.current)&&void 0!==i?i:h.domElement.parentNode,A=()=>f&&e&&e(u,Math.round(a.current)%u.length);l({filter:(e,t)=>{let n=[...e];n.length===u.length&&u.every((e=>n.map((e=>e.object.uuid)).includes(e.object.uuid)))||(a.current=0,u=n,A()),d&&(n=d(n,t));for(let r=0;r<Math.round(a.current)%n.length;r++){const e=n.shift();n=[...n,e]}return n}});const m=e=>{var t,n;a.current=e(a.current),null==(t=c().events.handlers)||t.onPointerCancel(void 0),null==(n=c().events.handlers)||n.onPointerMove(o),A()},p=e=>{(e.keyCode||e.which)===s&&(n&&e.preventDefault(),u.length>1&&m((e=>e+1)))},g=e=>{n&&e.preventDefault();let t=0;e||(e=window.event),e.wheelDelta?t=e.wheelDelta/120:e.detail&&(t=-e.detail/3),u.length>1&&m((e=>Math.abs(e-t)))},v=e=>o=e;return document.addEventListener("pointermove",v,{passive:!0}),r&&document.addEventListener("wheel",g),void 0!==s&&document.addEventListener("keydown",p),()=>{l({filter:d}),void 0!==s&&document.removeEventListener("keydown",p),r&&document.removeEventListener("wheel",g),document.removeEventListener("pointermove",v)}}),[h,c,l,n,r,s]),null}function E(e,t="pointer",n="auto",r=document.body){i.useEffect((()=>{if(e)return r.style.cursor=t,()=>{r.style.cursor=n}}),[e])}var x=n(7283);const C=e=>e;const w=e=>{const t=(0,x.y)(e),n=e=>function(e,t=C){const n=i.useSyncExternalStore(e.subscribe,(()=>t(e.getState())),(()=>t(e.getInitialState())));return i.useDebugValue(n),n}(t,e);return Object.assign(n,t),n},I=e=>e?w(e):w;let b=0;const S=I((e=>(a.h_9.onStart=(t,n,r)=>{e({active:!0,item:t,loaded:n,total:r,progress:(n-b)/(r-b)*100})},a.h_9.onLoad=()=>{e({active:!1})},a.h_9.onError=t=>e((e=>({errors:[...e.errors,t]}))),a.h_9.onProgress=(t,n,r)=>{n===r&&(b=r),e({active:!0,item:t,loaded:n,total:r,progress:(n-b)/(r-b)*100||100})},{errors:[],active:!1,progress:0,item:"",loaded:0,total:0})));function B({children:e}){const t=S();return i.createElement(i.Fragment,null,null==e?void 0:e(t))}const T=e=>`Loading ${e.toFixed(2)}%`;function _({containerStyles:e,innerStyles:t,barStyles:n,dataStyles:r,dataInterpolation:s=T,initialState:a=e=>e}){const{active:o,progress:l}=S(),c=i.useRef(0),h=i.useRef(0),u=i.useRef(null),[d,f]=i.useState(a(o));i.useEffect((()=>{let e;return o!==d&&(e=setTimeout((()=>f(o)),300)),()=>clearTimeout(e)}),[d,o]);const A=i.useCallback((()=>{u.current&&(c.current+=(l-c.current)/2,(c.current>.95*l||100===l)&&(c.current=l),u.current.innerText=s(c.current),c.current<l&&(h.current=requestAnimationFrame(A)))}),[s,l]);return i.useEffect((()=>(A(),()=>cancelAnimationFrame(h.current))),[A]),d?i.createElement("div",{style:{...M.container,opacity:o?1:0,...e}},i.createElement("div",null,i.createElement("div",{style:{...M.inner,...t}},i.createElement("div",{style:{...M.bar,transform:`scaleX(${l/100})`,...n}}),i.createElement("span",{ref:u,style:{...M.data,...r}})))):null}const M={container:{position:"absolute",top:0,left:0,width:"100%",height:"100%",background:"#171717",display:"flex",alignItems:"center",justifyContent:"center",transition:"opacity 300ms ease",zIndex:1e3},inner:{width:100,height:3,background:"#272727",textAlign:"center"},bar:{height:3,width:"100%",background:"white",transition:"transform 200ms",transformOrigin:"left center"},data:{display:"inline-block",position:"relative",fontVariantNumeric:"tabular-nums",marginTop:"0.8em",color:"#f0f0f0",fontSize:"0.6em",fontFamily:'-apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", "Helvetica Neue", Helvetica, Arial, Roboto, Ubuntu, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',whiteSpace:"nowrap"}};const R={toVector:(e,t)=>(void 0===e&&(e=t),Array.isArray(e)?e:[e,e]),add:(e,t)=>[e[0]+t[0],e[1]+t[1]],sub:(e,t)=>[e[0]-t[0],e[1]-t[1]],addTo(e,t){e[0]+=t[0],e[1]+=t[1]},subTo(e,t){e[0]-=t[0],e[1]-=t[1]}};function D(e,t,n){return 0===t||Math.abs(t)===1/0?Math.pow(e,5*n):e*t*n/(t+n*e)}function P(e,t,n,r=.15){return 0===r?function(e,t,n){return Math.max(t,Math.min(e,n))}(e,t,n):e<t?-D(t-e,n-t,r)+t:e>n?+D(e-n,n-t,r)+n:e}function L(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function k(e,t,n){return(t=L(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function F(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function O(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?F(Object(n),!0).forEach((function(t){k(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):F(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const U={pointer:{start:"down",change:"move",end:"up"},mouse:{start:"down",change:"move",end:"up"},touch:{start:"start",change:"move",end:"end"},gesture:{start:"start",change:"change",end:"end"}};function Q(e){return e?e[0].toUpperCase()+e.slice(1):""}const N=["enter","leave"];function z(e,t="",n=!1){const r=U[e],i=r&&r[t]||t;return"on"+Q(e)+Q(i)+(function(e=!1,t){return e&&!N.includes(t)}(n,i)?"Capture":"")}const G=["gotpointercapture","lostpointercapture"];function H(e){let t=e.substring(2).toLowerCase();const n=!!~t.indexOf("passive");n&&(t=t.replace("passive",""));const r=G.includes(t)?"capturecapture":"capture",i=!!~t.indexOf(r);return i&&(t=t.replace("capture","")),{device:t,capture:i,passive:n}}function q(e){return"touches"in e}function Y(e){return q(e)?"touch":"pointerType"in e?e.pointerType:"mouse"}function j(e){return q(e)?function(e){return"touchend"===e.type||"touchcancel"===e.type?e.changedTouches:e.targetTouches}(e)[0]:e}function V(e,t){try{const n=t.clientX-e.clientX,r=t.clientY-e.clientY,i=(t.clientX+e.clientX)/2,s=(t.clientY+e.clientY)/2,a=Math.hypot(n,r),o=-180*Math.atan2(n,r)/Math.PI;return{angle:o,distance:a,origin:[i,s]}}catch(n){}return null}function K(e){return function(e){return Array.from(e.touches).filter((t=>{var n,r;return t.target===e.currentTarget||(null===(n=e.currentTarget)||void 0===n||null===(r=n.contains)||void 0===r?void 0:r.call(n,t.target))}))}(e).map((e=>e.identifier))}function W(e,t){const[n,r]=Array.from(e.touches).filter((e=>t.includes(e.identifier)));return V(n,r)}function J(e){const t=j(e);return q(e)?t.identifier:t.pointerId}function X(e){const t=j(e);return[t.clientX,t.clientY]}function $(e){let{deltaX:t,deltaY:n,deltaMode:r}=e;return 1===r?(t*=40,n*=40):2===r&&(t*=800,n*=800),[t,n]}function Z(e,...t){return"function"==typeof e?e(...t):e}function ee(){}function te(...e){return 0===e.length?ee:1===e.length?e[0]:function(){let t;for(const n of e)t=n.apply(this,arguments)||t;return t}}function ne(e,t){return Object.assign({},t,e||{})}class re{constructor(e,t,n){this.ctrl=e,this.args=t,this.key=n,this.state||(this.state={},this.computeValues([0,0]),this.computeInitial(),this.init&&this.init(),this.reset())}get state(){return this.ctrl.state[this.key]}set state(e){this.ctrl.state[this.key]=e}get shared(){return this.ctrl.state.shared}get eventStore(){return this.ctrl.gestureEventStores[this.key]}get timeoutStore(){return this.ctrl.gestureTimeoutStores[this.key]}get config(){return this.ctrl.config[this.key]}get sharedConfig(){return this.ctrl.config.shared}get handler(){return this.ctrl.handlers[this.key]}reset(){const{state:e,shared:t,ingKey:n,args:r}=this;t[n]=e._active=e.active=e._blocked=e._force=!1,e._step=[!1,!1],e.intentional=!1,e._movement=[0,0],e._distance=[0,0],e._direction=[0,0],e._delta=[0,0],e._bounds=[[-1/0,1/0],[-1/0,1/0]],e.args=r,e.axis=void 0,e.memo=void 0,e.elapsedTime=e.timeDelta=0,e.direction=[0,0],e.distance=[0,0],e.overflow=[0,0],e._movementBound=[!1,!1],e.velocity=[0,0],e.movement=[0,0],e.delta=[0,0],e.timeStamp=0}start(e){const t=this.state,n=this.config;t._active||(this.reset(),this.computeInitial(),t._active=!0,t.target=e.target,t.currentTarget=e.currentTarget,t.lastOffset=n.from?Z(n.from,t):t.offset,t.offset=t.lastOffset,t.startTime=t.timeStamp=e.timeStamp)}computeValues(e){const t=this.state;t._values=e,t.values=this.config.transform(e)}computeInitial(){const e=this.state;e._initial=e._values,e.initial=e.values}compute(e){const{state:t,config:n,shared:r}=this;t.args=this.args;let i=0;if(e&&(t.event=e,n.preventDefault&&e.cancelable&&t.event.preventDefault(),t.type=e.type,r.touches=this.ctrl.pointerIds.size||this.ctrl.touchIds.size,r.locked=!!document.pointerLockElement,Object.assign(r,function(e){const t={};if("buttons"in e&&(t.buttons=e.buttons),"shiftKey"in e){const{shiftKey:n,altKey:r,metaKey:i,ctrlKey:s}=e;Object.assign(t,{shiftKey:n,altKey:r,metaKey:i,ctrlKey:s})}return t}(e)),r.down=r.pressed=r.buttons%2==1||r.touches>0,i=e.timeStamp-t.timeStamp,t.timeStamp=e.timeStamp,t.elapsedTime=t.timeStamp-t.startTime),t._active){const e=t._delta.map(Math.abs);R.addTo(t._distance,e)}this.axisIntent&&this.axisIntent(e);const[s,a]=t._movement,[o,l]=n.threshold,{_step:c,values:h}=t;if(n.hasCustomTransform?(!1===c[0]&&(c[0]=Math.abs(s)>=o&&h[0]),!1===c[1]&&(c[1]=Math.abs(a)>=l&&h[1])):(!1===c[0]&&(c[0]=Math.abs(s)>=o&&Math.sign(s)*o),!1===c[1]&&(c[1]=Math.abs(a)>=l&&Math.sign(a)*l)),t.intentional=!1!==c[0]||!1!==c[1],!t.intentional)return;const u=[0,0];if(n.hasCustomTransform){const[e,t]=h;u[0]=!1!==c[0]?e-c[0]:0,u[1]=!1!==c[1]?t-c[1]:0}else u[0]=!1!==c[0]?s-c[0]:0,u[1]=!1!==c[1]?a-c[1]:0;this.restrictToAxis&&!t._blocked&&this.restrictToAxis(u);const d=t.offset,f=t._active&&!t._blocked||t.active;f&&(t.first=t._active&&!t.active,t.last=!t._active&&t.active,t.active=r[this.ingKey]=t._active,e&&(t.first&&("bounds"in n&&(t._bounds=Z(n.bounds,t)),this.setup&&this.setup()),t.movement=u,this.computeOffset()));const[A,m]=t.offset,[[p,g],[v,y]]=t._bounds;t.overflow=[A<p?-1:A>g?1:0,m<v?-1:m>y?1:0],t._movementBound[0]=!!t.overflow[0]&&(!1===t._movementBound[0]?t._movement[0]:t._movementBound[0]),t._movementBound[1]=!!t.overflow[1]&&(!1===t._movementBound[1]?t._movement[1]:t._movementBound[1]);const E=t._active&&n.rubberband||[0,0];if(t.offset=function(e,[t,n],[r,i]){const[[s,a],[o,l]]=e;return[P(t,s,a,r),P(n,o,l,i)]}(t._bounds,t.offset,E),t.delta=R.sub(t.offset,d),this.computeMovement(),f&&(!t.last||i>32)){t.delta=R.sub(t.offset,d);const e=t.delta.map(Math.abs);R.addTo(t.distance,e),t.direction=t.delta.map(Math.sign),t._direction=t._delta.map(Math.sign),!t.first&&i>0&&(t.velocity=[e[0]/i,e[1]/i],t.timeDelta=i)}}emit(){const e=this.state,t=this.shared,n=this.config;if(e._active||this.clean(),(e._blocked||!e.intentional)&&!e._force&&!n.triggerAllEvents)return;const r=this.handler(O(O(O({},t),e),{},{[this.aliasKey]:e.values}));void 0!==r&&(e.memo=r)}clean(){this.eventStore.clean(),this.timeoutStore.clean()}}class ie extends re{constructor(...e){super(...e),k(this,"aliasKey","xy")}reset(){super.reset(),this.state.axis=void 0}init(){this.state.offset=[0,0],this.state.lastOffset=[0,0]}computeOffset(){this.state.offset=R.add(this.state.lastOffset,this.state.movement)}computeMovement(){this.state.movement=R.sub(this.state.offset,this.state.lastOffset)}axisIntent(e){const t=this.state,n=this.config;if(!t.axis&&e){const r="object"==typeof n.axisThreshold?n.axisThreshold[Y(e)]:n.axisThreshold;t.axis=function([e,t],n){const r=Math.abs(e),i=Math.abs(t);return r>i&&r>n?"x":i>r&&i>n?"y":void 0}(t._movement,r)}t._blocked=(n.lockDirection||!!n.axis)&&!t.axis||!!n.axis&&n.axis!==t.axis}restrictToAxis(e){if(this.config.axis||this.config.lockDirection)switch(this.state.axis){case"x":e[1]=0;break;case"y":e[0]=0}}}const se=e=>e,ae={enabled:(e=!0)=>e,eventOptions:(e,t,n)=>O(O({},n.shared.eventOptions),e),preventDefault:(e=!1)=>e,triggerAllEvents:(e=!1)=>e,rubberband(e=0){switch(e){case!0:return[.15,.15];case!1:return[0,0];default:return R.toVector(e)}},from:e=>"function"==typeof e?e:null!=e?R.toVector(e):void 0,transform(e,t,n){const r=e||n.shared.transform;return this.hasCustomTransform=!!r,r||se},threshold:e=>R.toVector(e,0)};const oe=O(O({},ae),{},{axis(e,t,{axis:n}){if(this.lockDirection="lock"===n,!this.lockDirection)return n},axisThreshold:(e=0)=>e,bounds(e={}){if("function"==typeof e)return t=>oe.bounds(e(t));if("current"in e)return()=>e.current;if("function"==typeof HTMLElement&&e instanceof HTMLElement)return e;const{left:t=-1/0,right:n=1/0,top:r=-1/0,bottom:i=1/0}=e;return[[t,n],[r,i]]}}),le={ArrowRight:(e,t=1)=>[e*t,0],ArrowLeft:(e,t=1)=>[-1*e*t,0],ArrowUp:(e,t=1)=>[0,-1*e*t],ArrowDown:(e,t=1)=>[0,e*t]};const ce="undefined"!=typeof window&&window.document&&window.document.createElement;function he(){return ce&&"ontouchstart"in window}const ue={isBrowser:ce,gesture:function(){try{return"constructor"in GestureEvent}catch(Sf){return!1}}(),touch:he(),touchscreen:he()||ce&&window.navigator.maxTouchPoints>1,pointer:ce&&"onpointerdown"in window,pointerLock:ce&&"exitPointerLock"in window.document},de={mouse:0,touch:0,pen:8},fe=O(O({},oe),{},{device(e,t,{pointer:{touch:n=!1,lock:r=!1,mouse:i=!1}={}}){return this.pointerLock=r&&ue.pointerLock,ue.touch&&n?"touch":this.pointerLock?"mouse":ue.pointer&&!i?"pointer":ue.touch?"touch":"mouse"},preventScrollAxis(e,t,{preventScroll:n}){if(this.preventScrollDelay="number"==typeof n?n:n||void 0===n&&e?250:void 0,ue.touchscreen&&!1!==n)return e||(void 0!==n?"y":void 0)},pointerCapture(e,t,{pointer:{capture:n=!0,buttons:r=1,keys:i=!0}={}}){return this.pointerButtons=r,this.keys=i,!this.pointerLock&&"pointer"===this.device&&n},threshold(e,t,{filterTaps:n=!1,tapsThreshold:r=3,axis:i}){const s=R.toVector(e,n?r:i?1:0);return this.filterTaps=n,this.tapsThreshold=r,s},swipe({velocity:e=.5,distance:t=50,duration:n=250}={}){return{velocity:this.transform(R.toVector(e)),distance:this.transform(R.toVector(t)),duration:n}},delay(e=0){switch(e){case!0:return 180;case!1:return 0;default:return e}},axisThreshold:e=>e?O(O({},de),e):de,keyboardDisplacement:(e=10)=>e});function Ae(e){const[t,n]=e.overflow,[r,i]=e._delta,[s,a]=e._direction;(t<0&&r>0&&s<0||t>0&&r<0&&s>0)&&(e._movement[0]=e._movementBound[0]),(n<0&&i>0&&a<0||n>0&&i<0&&a>0)&&(e._movement[1]=e._movementBound[1])}const me=O(O({},ae),{},{device(e,t,{shared:n,pointer:{touch:r=!1}={}}){if(n.target&&!ue.touch&&ue.gesture)return"gesture";if(ue.touch&&r)return"touch";if(ue.touchscreen){if(ue.pointer)return"pointer";if(ue.touch)return"touch"}},bounds(e,t,{scaleBounds:n={},angleBounds:r={}}){const i=e=>{const t=ne(Z(n,e),{min:-1/0,max:1/0});return[t.min,t.max]},s=e=>{const t=ne(Z(r,e),{min:-1/0,max:1/0});return[t.min,t.max]};return"function"!=typeof n&&"function"!=typeof r?[i(),s()]:e=>[i(e),s(e)]},threshold(e,t,n){this.lockDirection="lock"===n.axis;return R.toVector(e,this.lockDirection?[.1,3]:0)},modifierKey:e=>void 0===e?"ctrlKey":e,pinchOnWheel:(e=!0)=>e});const pe=O(O({},oe),{},{mouseOnly:(e=!0)=>e});const ge=oe;const ve=oe;const ye=O(O({},oe),{},{mouseOnly:(e=!0)=>e}),Ee=new Map,xe=new Map;function Ce(e){Ee.set(e.key,e.engine),xe.set(e.key,e.resolver)}const we={key:"drag",engine:class extends ie{constructor(...e){super(...e),k(this,"ingKey","dragging")}reset(){super.reset();const e=this.state;e._pointerId=void 0,e._pointerActive=!1,e._keyboardActive=!1,e._preventScroll=!1,e._delayed=!1,e.swipe=[0,0],e.tap=!1,e.canceled=!1,e.cancel=this.cancel.bind(this)}setup(){const e=this.state;if(e._bounds instanceof HTMLElement){const t=e._bounds.getBoundingClientRect(),n=e.currentTarget.getBoundingClientRect(),r={left:t.left-n.left+e.offset[0],right:t.right-n.right+e.offset[0],top:t.top-n.top+e.offset[1],bottom:t.bottom-n.bottom+e.offset[1]};e._bounds=oe.bounds(r)}}cancel(){const e=this.state;e.canceled||(e.canceled=!0,e._active=!1,setTimeout((()=>{this.compute(),this.emit()}),0))}setActive(){this.state._active=this.state._pointerActive||this.state._keyboardActive}clean(){this.pointerClean(),this.state._pointerActive=!1,this.state._keyboardActive=!1,super.clean()}pointerDown(e){const t=this.config,n=this.state;if(null!=e.buttons&&(Array.isArray(t.pointerButtons)?!t.pointerButtons.includes(e.buttons):-1!==t.pointerButtons&&t.pointerButtons!==e.buttons))return;const r=this.ctrl.setEventIds(e);t.pointerCapture&&e.target.setPointerCapture(e.pointerId),r&&r.size>1&&n._pointerActive||(this.start(e),this.setupPointer(e),n._pointerId=J(e),n._pointerActive=!0,this.computeValues(X(e)),this.computeInitial(),t.preventScrollAxis&&"mouse"!==Y(e)?(n._active=!1,this.setupScrollPrevention(e)):t.delay>0?(this.setupDelayTrigger(e),t.triggerAllEvents&&(this.compute(e),this.emit())):this.startPointerDrag(e))}startPointerDrag(e){const t=this.state;t._active=!0,t._preventScroll=!0,t._delayed=!1,this.compute(e),this.emit()}pointerMove(e){const t=this.state,n=this.config;if(!t._pointerActive)return;const r=J(e);if(void 0!==t._pointerId&&r!==t._pointerId)return;const i=X(e);return document.pointerLockElement===e.target?t._delta=[e.movementX,e.movementY]:(t._delta=R.sub(i,t._values),this.computeValues(i)),R.addTo(t._movement,t._delta),this.compute(e),t._delayed&&t.intentional?(this.timeoutStore.remove("dragDelay"),t.active=!1,void this.startPointerDrag(e)):n.preventScrollAxis&&!t._preventScroll?t.axis?t.axis===n.preventScrollAxis||"xy"===n.preventScrollAxis?(t._active=!1,void this.clean()):(this.timeoutStore.remove("startPointerDrag"),void this.startPointerDrag(e)):void 0:void this.emit()}pointerUp(e){this.ctrl.setEventIds(e);try{this.config.pointerCapture&&e.target.hasPointerCapture(e.pointerId)&&e.target.releasePointerCapture(e.pointerId)}catch(a){0}const t=this.state,n=this.config;if(!t._active||!t._pointerActive)return;const r=J(e);if(void 0!==t._pointerId&&r!==t._pointerId)return;this.state._pointerActive=!1,this.setActive(),this.compute(e);const[i,s]=t._distance;if(t.tap=i<=n.tapsThreshold&&s<=n.tapsThreshold,t.tap&&n.filterTaps)t._force=!0;else{const[e,r]=t._delta,[i,s]=t._movement,[a,o]=n.swipe.velocity,[l,c]=n.swipe.distance,h=n.swipe.duration;if(t.elapsedTime<h){const n=Math.abs(e/t.timeDelta),h=Math.abs(r/t.timeDelta);n>a&&Math.abs(i)>l&&(t.swipe[0]=Math.sign(e)),h>o&&Math.abs(s)>c&&(t.swipe[1]=Math.sign(r))}}this.emit()}pointerClick(e){!this.state.tap&&e.detail>0&&(e.preventDefault(),e.stopPropagation())}setupPointer(e){const t=this.config,n=t.device;t.pointerLock&&e.currentTarget.requestPointerLock(),t.pointerCapture||(this.eventStore.add(this.sharedConfig.window,n,"change",this.pointerMove.bind(this)),this.eventStore.add(this.sharedConfig.window,n,"end",this.pointerUp.bind(this)),this.eventStore.add(this.sharedConfig.window,n,"cancel",this.pointerUp.bind(this)))}pointerClean(){this.config.pointerLock&&document.pointerLockElement===this.state.currentTarget&&document.exitPointerLock()}preventScroll(e){this.state._preventScroll&&e.cancelable&&e.preventDefault()}setupScrollPrevention(e){this.state._preventScroll=!1,function(e){"persist"in e&&"function"==typeof e.persist&&e.persist()}(e);const t=this.eventStore.add(this.sharedConfig.window,"touch","change",this.preventScroll.bind(this),{passive:!1});this.eventStore.add(this.sharedConfig.window,"touch","end",t),this.eventStore.add(this.sharedConfig.window,"touch","cancel",t),this.timeoutStore.add("startPointerDrag",this.startPointerDrag.bind(this),this.config.preventScrollDelay,e)}setupDelayTrigger(e){this.state._delayed=!0,this.timeoutStore.add("dragDelay",(()=>{this.state._step=[0,0],this.startPointerDrag(e)}),this.config.delay)}keyDown(e){const t=le[e.key];if(t){const n=this.state,r=e.shiftKey?10:e.altKey?.1:1;this.start(e),n._delta=t(this.config.keyboardDisplacement,r),n._keyboardActive=!0,R.addTo(n._movement,n._delta),this.compute(e),this.emit()}}keyUp(e){e.key in le&&(this.state._keyboardActive=!1,this.setActive(),this.compute(e),this.emit())}bind(e){const t=this.config.device;e(t,"start",this.pointerDown.bind(this)),this.config.pointerCapture&&(e(t,"change",this.pointerMove.bind(this)),e(t,"end",this.pointerUp.bind(this)),e(t,"cancel",this.pointerUp.bind(this)),e("lostPointerCapture","",this.pointerUp.bind(this))),this.config.keys&&(e("key","down",this.keyDown.bind(this)),e("key","up",this.keyUp.bind(this))),this.config.filterTaps&&e("click","",this.pointerClick.bind(this),{capture:!0,passive:!1})}},resolver:fe},Ie={key:"hover",engine:class extends ie{constructor(...e){super(...e),k(this,"ingKey","hovering")}enter(e){this.config.mouseOnly&&"mouse"!==e.pointerType||(this.start(e),this.computeValues(X(e)),this.compute(e),this.emit())}leave(e){if(this.config.mouseOnly&&"mouse"!==e.pointerType)return;const t=this.state;if(!t._active)return;t._active=!1;const n=X(e);t._movement=t._delta=R.sub(n,t._values),this.computeValues(n),this.compute(e),t.delta=t.movement,this.emit()}bind(e){e("pointer","enter",this.enter.bind(this)),e("pointer","leave",this.leave.bind(this))}},resolver:ye},be={key:"move",engine:class extends ie{constructor(...e){super(...e),k(this,"ingKey","moving")}move(e){this.config.mouseOnly&&"mouse"!==e.pointerType||(this.state._active?this.moveChange(e):this.moveStart(e),this.timeoutStore.add("moveEnd",this.moveEnd.bind(this)))}moveStart(e){this.start(e),this.computeValues(X(e)),this.compute(e),this.computeInitial(),this.emit()}moveChange(e){if(!this.state._active)return;const t=X(e),n=this.state;n._delta=R.sub(t,n._values),R.addTo(n._movement,n._delta),this.computeValues(t),this.compute(e),this.emit()}moveEnd(e){this.state._active&&(this.state._active=!1,this.compute(e),this.emit())}bind(e){e("pointer","change",this.move.bind(this)),e("pointer","leave",this.moveEnd.bind(this))}},resolver:pe},Se={key:"pinch",engine:class extends re{constructor(...e){super(...e),k(this,"ingKey","pinching"),k(this,"aliasKey","da")}init(){this.state.offset=[1,0],this.state.lastOffset=[1,0],this.state._pointerEvents=new Map}reset(){super.reset();const e=this.state;e._touchIds=[],e.canceled=!1,e.cancel=this.cancel.bind(this),e.turns=0}computeOffset(){const{type:e,movement:t,lastOffset:n}=this.state;this.state.offset="wheel"===e?R.add(t,n):[(1+t[0])*n[0],t[1]+n[1]]}computeMovement(){const{offset:e,lastOffset:t}=this.state;this.state.movement=[e[0]/t[0],e[1]-t[1]]}axisIntent(){const e=this.state,[t,n]=e._movement;if(!e.axis){const r=30*Math.abs(t)-Math.abs(n);r<0?e.axis="angle":r>0&&(e.axis="scale")}}restrictToAxis(e){this.config.lockDirection&&("scale"===this.state.axis?e[1]=0:"angle"===this.state.axis&&(e[0]=0))}cancel(){const e=this.state;e.canceled||setTimeout((()=>{e.canceled=!0,e._active=!1,this.compute(),this.emit()}),0)}touchStart(e){this.ctrl.setEventIds(e);const t=this.state,n=this.ctrl.touchIds;if(t._active&&t._touchIds.every((e=>n.has(e))))return;if(n.size<2)return;this.start(e),t._touchIds=Array.from(n).slice(0,2);const r=W(e,t._touchIds);r&&this.pinchStart(e,r)}pointerStart(e){if(null!=e.buttons&&e.buttons%2!=1)return;this.ctrl.setEventIds(e),e.target.setPointerCapture(e.pointerId);const t=this.state,n=t._pointerEvents,r=this.ctrl.pointerIds;if(t._active&&Array.from(n.keys()).every((e=>r.has(e))))return;if(n.size<2&&n.set(e.pointerId,e),t._pointerEvents.size<2)return;this.start(e);const i=V(...Array.from(n.values()));i&&this.pinchStart(e,i)}pinchStart(e,t){this.state.origin=t.origin,this.computeValues([t.distance,t.angle]),this.computeInitial(),this.compute(e),this.emit()}touchMove(e){if(!this.state._active)return;const t=W(e,this.state._touchIds);t&&this.pinchMove(e,t)}pointerMove(e){const t=this.state._pointerEvents;if(t.has(e.pointerId)&&t.set(e.pointerId,e),!this.state._active)return;const n=V(...Array.from(t.values()));n&&this.pinchMove(e,n)}pinchMove(e,t){const n=this.state,r=n._values[1],i=t.angle-r;let s=0;Math.abs(i)>270&&(s+=Math.sign(i)),this.computeValues([t.distance,t.angle-360*s]),n.origin=t.origin,n.turns=s,n._movement=[n._values[0]/n._initial[0]-1,n._values[1]-n._initial[1]],this.compute(e),this.emit()}touchEnd(e){this.ctrl.setEventIds(e),this.state._active&&this.state._touchIds.some((e=>!this.ctrl.touchIds.has(e)))&&(this.state._active=!1,this.compute(e),this.emit())}pointerEnd(e){const t=this.state;this.ctrl.setEventIds(e);try{e.target.releasePointerCapture(e.pointerId)}catch(n){}t._pointerEvents.has(e.pointerId)&&t._pointerEvents.delete(e.pointerId),t._active&&t._pointerEvents.size<2&&(t._active=!1,this.compute(e),this.emit())}gestureStart(e){e.cancelable&&e.preventDefault();const t=this.state;t._active||(this.start(e),this.computeValues([e.scale,e.rotation]),t.origin=[e.clientX,e.clientY],this.compute(e),this.emit())}gestureMove(e){if(e.cancelable&&e.preventDefault(),!this.state._active)return;const t=this.state;this.computeValues([e.scale,e.rotation]),t.origin=[e.clientX,e.clientY];const n=t._movement;t._movement=[e.scale-1,e.rotation],t._delta=R.sub(t._movement,n),this.compute(e),this.emit()}gestureEnd(e){this.state._active&&(this.state._active=!1,this.compute(e),this.emit())}wheel(e){const t=this.config.modifierKey;t&&!(Array.isArray(t)?t.find((t=>e[t])):e[t])||(this.state._active?this.wheelChange(e):this.wheelStart(e),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this)))}wheelStart(e){this.start(e),this.wheelChange(e)}wheelChange(e){"uv"in e||e.cancelable&&e.preventDefault();const t=this.state;t._delta=[-$(e)[1]/100*t.offset[0],0],R.addTo(t._movement,t._delta),Ae(t),this.state.origin=[e.clientX,e.clientY],this.compute(e),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){const t=this.config.device;t&&(e(t,"start",this[t+"Start"].bind(this)),e(t,"change",this[t+"Move"].bind(this)),e(t,"end",this[t+"End"].bind(this)),e(t,"cancel",this[t+"End"].bind(this)),e("lostPointerCapture","",this[t+"End"].bind(this))),this.config.pinchOnWheel&&e("wheel","",this.wheel.bind(this),{passive:!1})}},resolver:me},Be={key:"scroll",engine:class extends ie{constructor(...e){super(...e),k(this,"ingKey","scrolling")}scroll(e){this.state._active||this.start(e),this.scrollChange(e),this.timeoutStore.add("scrollEnd",this.scrollEnd.bind(this))}scrollChange(e){e.cancelable&&e.preventDefault();const t=this.state,n=function(e){var t,n;const{scrollX:r,scrollY:i,scrollLeft:s,scrollTop:a}=e.currentTarget;return[null!==(t=null!=r?r:s)&&void 0!==t?t:0,null!==(n=null!=i?i:a)&&void 0!==n?n:0]}(e);t._delta=R.sub(n,t._values),R.addTo(t._movement,t._delta),this.computeValues(n),this.compute(e),this.emit()}scrollEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){e("scroll","",this.scroll.bind(this))}},resolver:ge},Te={key:"wheel",engine:class extends ie{constructor(...e){super(...e),k(this,"ingKey","wheeling")}wheel(e){this.state._active||this.start(e),this.wheelChange(e),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this))}wheelChange(e){const t=this.state;t._delta=$(e),R.addTo(t._movement,t._delta),Ae(t),this.compute(e),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){e("wheel","",this.wheel.bind(this))}},resolver:ve};function _e(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}const Me={target(e){if(e)return()=>"current"in e?e.current:e},enabled:(e=!0)=>e,window:(e=(ue.isBrowser?window:void 0))=>e,eventOptions:({passive:e=!0,capture:t=!1}={})=>({passive:e,capture:t}),transform:e=>e},Re=["target","eventOptions","window","enabled","transform"];function De(e={},t){const n={};for(const[r,i]of Object.entries(t))switch(typeof i){case"function":n[r]=i.call(n,e[r],r,e);break;case"object":n[r]=De(e[r],i);break;case"boolean":i&&(n[r]=e[r])}return n}class Pe{constructor(e,t){k(this,"_listeners",new Set),this._ctrl=e,this._gestureKey=t}add(e,t,n,r,i){const s=this._listeners,a=function(e,t=""){const n=U[e];return e+(n&&n[t]||t)}(t,n),o=O(O({},this._gestureKey?this._ctrl.config[this._gestureKey].eventOptions:{}),i);e.addEventListener(a,r,o);const l=()=>{e.removeEventListener(a,r,o),s.delete(l)};return s.add(l),l}clean(){this._listeners.forEach((e=>e())),this._listeners.clear()}}class Le{constructor(){k(this,"_timeouts",new Map)}add(e,t,n=140,...r){this.remove(e),this._timeouts.set(e,window.setTimeout(t,n,...r))}remove(e){const t=this._timeouts.get(e);t&&window.clearTimeout(t)}clean(){this._timeouts.forEach((e=>{window.clearTimeout(e)})),this._timeouts.clear()}}class ke{constructor(e){k(this,"gestures",new Set),k(this,"_targetEventStore",new Pe(this)),k(this,"gestureEventStores",{}),k(this,"gestureTimeoutStores",{}),k(this,"handlers",{}),k(this,"config",{}),k(this,"pointerIds",new Set),k(this,"touchIds",new Set),k(this,"state",{shared:{shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1}}),function(e,t){t.drag&&Fe(e,"drag");t.wheel&&Fe(e,"wheel");t.scroll&&Fe(e,"scroll");t.move&&Fe(e,"move");t.pinch&&Fe(e,"pinch");t.hover&&Fe(e,"hover")}(this,e)}setEventIds(e){return q(e)?(this.touchIds=new Set(K(e)),this.touchIds):"pointerId"in e?("pointerup"===e.type||"pointercancel"===e.type?this.pointerIds.delete(e.pointerId):"pointerdown"===e.type&&this.pointerIds.add(e.pointerId),this.pointerIds):void 0}applyHandlers(e,t){this.handlers=e,this.nativeHandlers=t}applyConfig(e,t){this.config=function(e,t,n={}){const r=e,{target:i,eventOptions:s,window:a,enabled:o,transform:l}=r,c=_e(r,Re);if(n.shared=De({target:i,eventOptions:s,window:a,enabled:o,transform:l},Me),t){const e=xe.get(t);n[t]=De(O({shared:n.shared},c),e)}else for(const h in c){const e=xe.get(h);e&&(n[h]=De(O({shared:n.shared},c[h]),e))}return n}(e,t,this.config)}clean(){this._targetEventStore.clean();for(const e of this.gestures)this.gestureEventStores[e].clean(),this.gestureTimeoutStores[e].clean()}effect(){return this.config.shared.target&&this.bind(),()=>this._targetEventStore.clean()}bind(...e){const t=this.config.shared,n={};let r;if(!t.target||(r=t.target(),r)){if(t.enabled){for(const t of this.gestures){const i=this.config[t],s=Oe(n,i.eventOptions,!!r);if(i.enabled){new(Ee.get(t))(this,e,t).bind(s)}}const i=Oe(n,t.eventOptions,!!r);for(const t in this.nativeHandlers)i(t,"",(n=>this.nativeHandlers[t](O(O({},this.state.shared),{},{event:n,args:e}))),void 0,!0)}for(const e in n)n[e]=te(...n[e]);if(!r)return n;for(const e in n){const{device:t,capture:i,passive:s}=H(e);this._targetEventStore.add(r,t,"",n[e],{capture:i,passive:s})}}}}function Fe(e,t){e.gestures.add(t),e.gestureEventStores[t]=new Pe(e,t),e.gestureTimeoutStores[t]=new Le}const Oe=(e,t,n)=>(r,i,s,a={},o=!1)=>{var l,c;const h=null!==(l=a.capture)&&void 0!==l?l:t.capture,u=null!==(c=a.passive)&&void 0!==c?c:t.passive;let d=o?r:z(r,i,h);n&&u&&(d+="Passive"),e[d]=e[d]||[],e[d].push(s)},Ue=/^on(Drag|Wheel|Scroll|Move|Pinch|Hover)/;function Qe(e,t,n,r,i,s){if(!e.has(n))return;if(!Ee.has(r))return void 0;const a=n+"Start",o=n+"End";i[r]=e=>{let r;return e.first&&a in t&&t[a](e),n in t&&(r=t[n](e)),e.last&&o in t&&t[o](e),r},s[r]=s[r]||{}}function Ne(e,t){const[n,r,i]=function(e){const t={},n={},r=new Set;for(let i in e)Ue.test(i)?(r.add(RegExp.lastMatch),n[i]=e[i]):t[i]=e[i];return[n,t,r]}(e),s={};return Qe(i,n,"onDrag","drag",s,t),Qe(i,n,"onWheel","wheel",s,t),Qe(i,n,"onScroll","scroll",s,t),Qe(i,n,"onPinch","pinch",s,t),Qe(i,n,"onMove","move",s,t),Qe(i,n,"onHover","hover",s,t),{handlers:s,config:t,nativeHandlers:r}}function ze(e,t={},n,r){const s=i.useMemo((()=>new ke(e)),[]);if(s.applyHandlers(e,r),s.applyConfig(t,n),i.useEffect(s.effect.bind(s)),i.useEffect((()=>s.clean.bind(s)),[]),void 0===t.target)return s.bind.bind(s)}function Ge(e,t){const n=([we,Se,Be,Te,be,Ie].forEach(Ce),function(e,t){const{handlers:n,nativeHandlers:r,config:i}=Ne(e,t||{});return ze(n,i,void 0,r)});return n(e,t||{})}const He=new a.Pq0,qe=new a.I9Y,Ye=new a.Pq0,je=new a.Pq0,Ve=new a.Pq0,Ke=new a.Zcv,We=i.forwardRef((({autoTransform:e=!0,matrix:t,axisLock:n,dragLimits:s,onHover:l,onDragStart:c,onDrag:h,onDragEnd:u,children:d,dragConfig:f,...A},m)=>{const p=(0,o.A)((e=>e.controls)),{camera:g,size:v,raycaster:y,invalidate:E}=(0,o.A)(),x=i.useRef(null),C=Ge({onHover:({hovering:e})=>l&&l(null!=e&&e),onDragStart:({event:e})=>{p&&(p.enabled=!1);const{point:t}=e;x.current.matrix.decompose(He,new a.PTz,new a.Pq0),Ye.copy(t),je.copy(Ye).sub(He),c&&c(He),E()},onDrag:({xy:[t,r],intentional:i})=>{if(!i)return;const o=(t-v.left)/v.width*2-1,l=-(r-v.top)/v.height*2+1;if(qe.set(o,l),y.setFromCamera(qe,g),n)switch(n){case"x":Ve.set(1,0,0);break;case"y":Ve.set(0,1,0);break;case"z":Ve.set(0,0,1)}else g.getWorldDirection(Ve).negate();Ke.setFromNormalAndCoplanarPoint(Ve,Ye),y.ray.intersectPlane(Ke,Ye);const c=x.current.matrix.clone(),u=x.current.matrixWorld.clone(),d=new a.Pq0(Ye.x-je.x,Ye.y-je.y,Ye.z-je.z);if(s&&(d.x=s[0]?Math.max(Math.min(d.x,s[0][1]),s[0][0]):d.x,d.y=s[1]?Math.max(Math.min(d.y,s[1][1]),s[1][0]):d.y,d.z=s[2]?Math.max(Math.min(d.z,s[2][1]),s[2][0]):d.z),e){x.current.matrix.setPosition(d);const e=x.current.matrix.clone().multiply(c.invert()),t=x.current.matrix.clone().multiply(u.invert());h&&h(x.current.matrix,e,x.current.matrixWorld,t)}else{const e=(new a.kn4).copy(x.current.matrix);e.setPosition(d);const t=e.clone().multiply(c.invert()),n=e.clone().multiply(u.invert());h&&h(e,t,x.current.matrixWorld,n)}E()},onDragEnd:()=>{p&&(p.enabled=!0),u&&u(),E()}},{drag:{filterTaps:!0,threshold:1,..."object"==typeof f?f:{}}});return i.useImperativeHandle(m,(()=>x.current),[]),i.useLayoutEffect((()=>{t&&(x.current.matrix=t)}),[t]),i.createElement("group",(0,r.A)({ref:x},C(),{matrix:t,matrixAutoUpdate:!1},A),d)}));function Je(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Xe(e,t){return Xe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Xe(e,t)}function $e(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(Sf){return!1}}function Ze(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t[0],i=t[1],s=t[2],a=t[3],o=t[4],l=t[5],c=t[6],h=t[7],u=t[8];return r*o*u+i*l*c+s*a*h-s*o*c-i*a*u-r*l*h}function et(e,t){for(var n=[],r=e.toArray(),i=t.toArray(),s=0;s<r.length;s++)n[s]=r[s]+i[s];return(new a.dwI).fromArray(n)}function tt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function nt(e,t){if(e){if("string"==typeof e)return tt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?tt(e,t):void 0}}function rt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,s=[],a=!0,o=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(s.push(r.value),!t||s.length!==t);a=!0);}catch(l){o=!0,i=l}finally{try{a||null==n.return||n.return()}finally{if(o)throw i}}return s}}(e,t)||nt(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function it(e){return function(e){if(Array.isArray(e))return tt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||nt(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function st(e,t,n){return st=$e()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&Xe(i,n.prototype),i},st.apply(null,arguments)}function at(e){var t=rt(e[0],2),n=t[0],r=t[1],i=rt(e[1],2),s=i[0],a=i[1],o=rt(e[2],2);return Ze(n,r,1,s,a,1,o[0],o[1],1)}function ot(e){return 0===at(e)}var lt=new a.I9Y,ct=new a.I9Y;function ht(e){var t=e.map((function(e){return Array.isArray(e)?st(a.I9Y,it(e)):e})),n=rt(t,3),r=n[0],i=n[1],s=n[2];if(ot(e))return!1;var o=lt.subVectors(i,r);return ct.subVectors(s,r).cross(o)>0}function ut(e,t,n){return Math.max(t,Math.min(n,e))}function dt(e,t){return ut(e-Math.floor(e/t)*t,0,t)}function ft(e,t){var n=dt(t-e,2*Math.PI);return n>Math.PI&&(n-=2*Math.PI),n}function At(e,t){return e.x===t.x?void 0!==e.z&&e.y===t.y?e.z-t.z:e.y-t.y:e.x-t.x}function mt(e){return e*e*e*(e*(6*e-15)+10)}function pt(e,t,n){return e*(1-n)+t*n}function gt(e,t,n){return(n-e)/(t-e)}function vt(e,t){var n=(new a.Pq0).crossVectors(e,t),r=e.dot(t),i=(new a.dwI).identity(),s=(new a.dwI).set(0,-n.z,n.y,n.z,0,-n.x,-n.y,n.x,0),o=(new a.dwI).multiplyMatrices(s,s).multiplyScalar(1/(1+r));return et(et(i,s),o)}var yt=Object.freeze({__proto__:null,clamp:ut,repeat:dt,deltaAngle:ft,degToRad:function(e){return e/180*Math.PI},radToDeg:function(e){return 180*e/Math.PI},fibonacciOnSphere:function(e,t){for(var n=t.radius,r=void 0===n?1:n,i=e.length/3,s=2/i,a=Math.PI*(3-2.2360679775),o=0;o<e.length;o+=3){var l=o*s-1+s/2,c=Math.sqrt(1-Math.pow(l,2)),h=o%i*a,u=Math.cos(h)*c,d=Math.sin(h)*c;e[o]=u*r,e[o+1]=l*r,e[o+2]=d*r}},vectorEquals:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.EPSILON;return Math.abs(e.x-t.x)<n&&Math.abs(e.y-t.y)<n&&Math.abs(e.z-t.z)<n},lexicographic:At,convexHull:function(e){for(var t=e.sort(At),n=[t[0],t[1]],r=2;r<t.length;r++)for(n.push(t[r]);n.length>2&&ht(it(n.slice(-3)));)n.splice(n.length-2,1);for(var i=[t[t.length-1],t[t.length-2]],s=t.length-3;s>=0;s--)for(i.push(t[s]);i.length>2&&ht(it(i.slice(-3)));)i.splice(i.length-2,1);return i.splice(0,1),i.splice(i.length-1,1),[].concat(n,i)},remap:function(e,t,n){var r=rt(t,2),i=r[0],s=r[1],a=rt(n,2),o=a[0];return o+(e-i)*(a[1]-o)/(s-i)},fade:mt,lerp:pt,inverseLerp:gt,normalize:function(e,t,n){var r=Math.sqrt(e*e+t*t+n*n);return[e/r,t/r,n/r]},pointOnCubeToPointOnSphere:function(e,t,n){var r=e*e,i=t*t,s=n*n;return[e*Math.sqrt(1-(i+s)/2+i*s/3),t*Math.sqrt(1-(s+r)/2+s*r/3),n*Math.sqrt(1-(r+i)/2+r*i/3)]},rotateVectorOnVector:vt,pointToCoordinate:function(e,t,n){return[Math.asin(t),Math.atan2(e,-n)]},coordinateToPoint:function(e,t){var n=Math.sin(e),r=Math.cos(e);return[Math.sin(t)*r,n,-Math.cos(t)*r]},planeSegmentIntersection:function(e,t){var n=rt(t,2),r=n[0],i=n[1],s=vt(e.normal,new a.Pq0(0,1,0)),o=gt(r.clone().applyMatrix3(s).y,i.clone().applyMatrix3(s).y,0);return(new a.Pq0).lerpVectors(r,i,o)},pointToPlaneDistance:function(e,t){return t.normal.dot(e)},getIndexFrom3D:function(e,t){var n=rt(e,3),r=n[0],i=n[1],s=n[2],a=rt(t,2),o=a[0];return s*o*a[1]+i*o+r},get3DFromIndex:function(e,t){var n=rt(t,2),r=n[0],i=r*n[1],s=e/i,a=e-i*s;return[a%r,a/r,s]},getIndexFrom2D:function(e,t){return e[0]+t[0]*e[1]},get2DFromIndex:function(e,t){return[e%t,Math.floor(e/t)]}});function Et(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var xt=function e(t,n,r){var i=this;Et(this,e),Je(this,"dot2",(function(e,t){return i.x*e+i.y*t})),Je(this,"dot3",(function(e,t,n){return i.x*e+i.y*t+i.z*n})),this.x=t,this.y=n,this.z=r},Ct=[new xt(1,1,0),new xt(-1,1,0),new xt(1,-1,0),new xt(-1,-1,0),new xt(1,0,1),new xt(-1,0,1),new xt(1,0,-1),new xt(-1,0,-1),new xt(0,1,1),new xt(0,-1,1),new xt(0,1,-1),new xt(0,-1,-1)],wt=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],It=new Array(512),bt=new Array(512),St=function(e){e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8);for(var t=0;t<256;t++){var n;n=1&t?wt[t]^255&e:wt[t]^e>>8&255,It[t]=It[t+256]=n,bt[t]=bt[t+256]=Ct[n%12]}};St(0);Math.sqrt(3),Math.sqrt(3),Math.PI;function Bt(e){var t=function(e){if("number"==typeof e)e=Math.abs(e);else if("string"==typeof e){var t=e;e=0;for(var n=0;n<t.length;n++)e=(e+(n+1)*(t.charCodeAt(n)%96))%2147483647}return 0===e&&(e=311),e}(e);return function(){var e=48271*t%2147483647;return t=e,e/2147483647}}var Tt=function e(t){var n=this;Et(this,e),Je(this,"seed",0),Je(this,"init",(function(e){n.seed=e,n.value=Bt(e)})),Je(this,"value",Bt(this.seed)),this.init(t)};new Tt(Math.random());var _t=function(e){return 1/(1+e+.48*e*e+.235*e*e*e)},Mt={in:function(e){return 1-Math.cos(e*Math.PI/2)},out:function(e){return Math.sin(e*Math.PI/2)},inOut:function(e){return-(Math.cos(Math.PI*e)-1)/2}},Rt={in:function(e){return e*e*e},out:function(e){return 1-Math.pow(1-e,3)},inOut:function(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}},Dt={in:function(e){return e*e*e*e*e},out:function(e){return 1-Math.pow(1-e,5)},inOut:function(e){return e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2}},Pt={in:function(e){return 1-Math.sqrt(1-Math.pow(e,2))},out:function(e){return Math.sqrt(1-Math.pow(e-1,2))},inOut:function(e){return e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2}},Lt={in:function(e){return 0===e?0:Math.pow(2,10*e-10)},out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},inOut:function(e){return 0===e?0:1===e?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2}};function kt(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.25,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.01,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1/0,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:_t,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:.001,l="velocity_"+t;if(void 0===e.__damp&&(e.__damp={}),void 0===e.__damp[l]&&(e.__damp[l]=0),Math.abs(e[t]-n)<=o)return e[t]=n,!1;var c=2/(r=Math.max(1e-4,r)),h=a(c*i),u=e[t]-n,d=n,f=s*r;u=Math.min(Math.max(u,-f),f),n=e[t]-u;var A=(e.__damp[l]+c*u)*i;e.__damp[l]=(e.__damp[l]-c*A)*h;var m=n+(u+A)*h;return d-e[t]>0==m>d&&(m=d,e.__damp[l]=(m-d)/i),e[t]=m,!0}var Ft=new a.Pq0,Ot=new a.PTz,Ut=new a.PTz,Qt=new a.kn4,Nt=new a.Pq0;function zt(e,t,n,r,i,s,a,o){return kt(e,t,e[t]+ft(e[t],n),r,i,s,a,o)}var Gt,Ht,qt=new a.I9Y;var Yt,jt,Vt,Kt=new a.Pq0;function Wt(e,t,n,r,i,s,a){return"number"==typeof t?Kt.setScalar(t):Array.isArray(t)?Kt.set(t[0],t[1],t[2]):Kt.copy(t),Yt=kt(e,"x",Kt.x,n,r,i,s,a),jt=kt(e,"y",Kt.y,n,r,i,s,a),Vt=kt(e,"z",Kt.z,n,r,i,s,a),Yt||jt||Vt}var Jt,Xt,$t,Zt,en=new a.IUQ;var tn,nn,rn,sn=new a.O9p;var an,on,ln,cn=new a.Q1f;var hn,un,dn,fn,An=new a.PTz,mn=new a.IUQ,pn=new a.IUQ,gn=new a.IUQ;function vn(e,t,n,r,i,s,a){var o=e;Array.isArray(t)?An.set(t[0],t[1],t[2],t[3]):An.copy(t);var l=e.dot(An)>0?1:-1;return An.x*=l,An.y*=l,An.z*=l,An.w*=l,hn=kt(e,"x",An.x,n,r,i,s,a),un=kt(e,"y",An.y,n,r,i,s,a),dn=kt(e,"z",An.z,n,r,i,s,a),fn=kt(e,"w",An.w,n,r,i,s,a),mn.set(e.x,e.y,e.z,e.w).normalize(),pn.set(o.__damp.velocity_x,o.__damp.velocity_y,o.__damp.velocity_z,o.__damp.velocity_w),gn.copy(mn).multiplyScalar(pn.dot(mn)/mn.dot(mn)),o.__damp.velocity_x-=gn.x,o.__damp.velocity_y-=gn.y,o.__damp.velocity_z-=gn.z,o.__damp.velocity_w-=gn.w,e.set(mn.x,mn.y,mn.z,mn.w),hn||un||dn||fn}var yn,En,xn,Cn=new a.YHV;var wn,In,bn,Sn=new a.kn4,Bn=new a.Pq0,Tn=new a.PTz,_n=new a.Pq0;var Mn=Object.freeze({__proto__:null,rsqw:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/(2*Math.PI);return n/Math.atan(1/t)*Math.atan(Math.sin(2*Math.PI*e*r)/t)},exp:_t,linear:function(e){return e},sine:Mt,cubic:Rt,quint:Dt,circ:Pt,quart:{in:function(e){return e*e*e*e},out:function(e){return 1- --e*e*e*e},inOut:function(e){return e<.5?8*e*e*e*e:1-8*--e*e*e*e}},expo:Lt,damp:kt,dampLookAt:function(e,t,n,r,i,s,a){"number"==typeof t?Ft.setScalar(t):Array.isArray(t)?Ft.set(t[0],t[1],t[2]):Ft.copy(t);var o=e.parent;e.updateWorldMatrix(!0,!1),Nt.setFromMatrixPosition(e.matrixWorld),function(e){return e&&e.isCamera}(e)||function(e){return e&&e.isLight}(e)?Qt.lookAt(Nt,Ft,e.up):Qt.lookAt(Ft,Nt,e.up),vn(e.quaternion,Ut.setFromRotationMatrix(Qt),n,r,i,s,a),o&&(Qt.extractRotation(o.matrixWorld),Ot.setFromRotationMatrix(Qt),vn(e.quaternion,Ut.copy(e.quaternion).premultiply(Ot.invert()),n,r,i,s,a))},dampAngle:zt,damp2:function(e,t,n,r,i,s,a){return"number"==typeof t?qt.setScalar(t):Array.isArray(t)?qt.set(t[0],t[1]):qt.copy(t),Gt=kt(e,"x",qt.x,n,r,i,s,a),Ht=kt(e,"y",qt.y,n,r,i,s,a),Gt||Ht},damp3:Wt,damp4:function(e,t,n,r,i,s,a){return"number"==typeof t?en.setScalar(t):Array.isArray(t)?en.set(t[0],t[1],t[2],t[3]):en.copy(t),Jt=kt(e,"x",en.x,n,r,i,s,a),Xt=kt(e,"y",en.y,n,r,i,s,a),$t=kt(e,"z",en.z,n,r,i,s,a),Zt=kt(e,"w",en.w,n,r,i,s,a),Jt||Xt||$t||Zt},dampE:function(e,t,n,r,i,s,a){return Array.isArray(t)?sn.set(t[0],t[1],t[2],t[3]):sn.copy(t),tn=zt(e,"x",sn.x,n,r,i,s,a),nn=zt(e,"y",sn.y,n,r,i,s,a),rn=zt(e,"z",sn.z,n,r,i,s,a),tn||nn||rn},dampC:function(e,t,n,r,i,s,o){return t instanceof a.Q1f?cn.copy(t):Array.isArray(t)?cn.setRGB(t[0],t[1],t[2]):cn.set(t),an=kt(e,"r",cn.r,n,r,i,s,o),on=kt(e,"g",cn.g,n,r,i,s,o),ln=kt(e,"b",cn.b,n,r,i,s,o),an||on||ln},dampQ:vn,dampS:function(e,t,n,r,i,s,a){return Array.isArray(t)?Cn.set(t[0],t[1],t[2]):Cn.copy(t),yn=kt(e,"radius",Cn.radius,n,r,i,s,a),En=zt(e,"phi",Cn.phi,n,r,i,s,a),xn=zt(e,"theta",Cn.theta,n,r,i,s,a),yn||En||xn},dampM:function(e,t,n,r,i,s,o){var l=e;return void 0===l.__damp&&(l.__damp={position:new a.Pq0,rotation:new a.PTz,scale:new a.Pq0},e.decompose(l.__damp.position,l.__damp.rotation,l.__damp.scale)),Array.isArray(t)?Sn.set.apply(Sn,it(t)):Sn.copy(t),Sn.decompose(Bn,Tn,_n),wn=Wt(l.__damp.position,Bn,n,r,i,s,o),In=vn(l.__damp.rotation,Tn,n,r,i,s,o),bn=Wt(l.__damp.scale,_n,n,r,i,s,o),e.compose(l.__damp.position,l.__damp.rotation,l.__damp.scale),wn||In||bn}});function Rn(e){return Rn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Rn(e)}function Dn(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}a.LoY;const Pn=i.createContext(null);function Ln(){return i.useContext(Pn)}function kn({eps:e=1e-5,enabled:t=!0,infinite:n,horizontal:r,pages:s=1,distance:a=1,damping:l=.25,maxSpeed:c=1/0,prepend:h=!1,style:u={},children:d}){const{get:f,setEvents:A,gl:m,size:p,invalidate:g,events:v}=(0,o.A)(),[y]=i.useState((()=>document.createElement("div"))),[E]=i.useState((()=>document.createElement("div"))),[x]=i.useState((()=>document.createElement("div"))),C=m.domElement.parentNode,w=i.useRef(0),I=i.useMemo((()=>{const t={el:y,eps:e,fill:E,fixed:x,horizontal:r,damping:l,offset:0,delta:0,scroll:w,pages:s,range(e,t,n=0){const r=e-n,i=r+t+2*n;return this.offset<r?0:this.offset>i?1:(this.offset-r)/(i-r)},curve(e,t,n=0){return Math.sin(this.range(e,t,n)*Math.PI)},visible(e,t,n=0){const r=e-n,i=r+t+2*n;return this.offset>=r&&this.offset<=i}};return t}),[e,l,r,s]);i.useEffect((()=>{y.style.position="absolute",y.style.width="100%",y.style.height="100%",y.style[r?"overflowX":"overflowY"]="auto",y.style[r?"overflowY":"overflowX"]="hidden",y.style.top="0px",y.style.left="0px";for(const n in u)y.style[n]=u[n];x.style.position="sticky",x.style.top="0px",x.style.left="0px",x.style.width="100%",x.style.height="100%",x.style.overflow="hidden",y.appendChild(x),E.style.height=r?"100%":s*a*100+"%",E.style.width=r?s*a*100+"%":"100%",E.style.pointerEvents="none",y.appendChild(E),h?C.prepend(y):C.appendChild(y),y[r?"scrollLeft":"scrollTop"]=1;const e=v.connected||m.domElement;requestAnimationFrame((()=>null==v.connect?void 0:v.connect(y)));const t=f().events.compute;return A({compute(e,t){const{left:n,top:r}=C.getBoundingClientRect(),i=e.clientX-n,s=e.clientY-r;t.pointer.set(i/t.size.width*2-1,-s/t.size.height*2+1),t.raycaster.setFromCamera(t.pointer,t.camera)}}),()=>{C.removeChild(y),A({compute:t}),null==v.connect||v.connect(e)}}),[s,a,r,y,E,x,C]),i.useEffect((()=>{if(v.connected===y){const e=p[r?"width":"height"],i=y[r?"scrollWidth":"scrollHeight"],s=i-e;let a=0,o=!0,l=!0;const c=()=>{if(t&&!l&&(g(),a=y[r?"scrollLeft":"scrollTop"],w.current=a/s,n)){if(!o)if(a>=s){const e=1-I.offset;y[r?"scrollLeft":"scrollTop"]=1,w.current=I.offset=-e,o=!0}else if(a<=0){const e=1+I.offset;y[r?"scrollLeft":"scrollTop"]=i,w.current=I.offset=e,o=!0}o&&setTimeout((()=>o=!1),40)}};y.addEventListener("scroll",c,{passive:!0}),requestAnimationFrame((()=>l=!1));const h=e=>y.scrollLeft+=e.deltaY/2;return r&&y.addEventListener("wheel",h,{passive:!0}),()=>{y.removeEventListener("scroll",c),r&&y.removeEventListener("wheel",h)}}}),[y,v,p,n,I,g,r,t]);let b=0;return(0,o.C)(((t,n)=>{b=I.offset,Mn.damp(I,"offset",w.current,l,n,c,void 0,e),Mn.damp(I,"delta",Math.abs(b-I.offset),l,n,c,void 0,e),I.delta>e&&g()})),i.createElement(Pn.Provider,{value:I},d)}const Fn=i.forwardRef((({children:e},t)=>{const n=i.useRef(null);i.useImperativeHandle(t,(()=>n.current),[]);const r=Ln(),{width:s,height:a}=(0,o.A)((e=>e.viewport));return(0,o.C)((()=>{n.current.position.x=r.horizontal?-s*(r.pages-1)*r.offset:0,n.current.position.y=r.horizontal?0:a*(r.pages-1)*r.offset})),i.createElement("group",{ref:n},e)})),On=i.forwardRef((({children:e,style:t,...n},a)=>{const l=Ln(),c=i.useRef(null);i.useImperativeHandle(a,(()=>c.current),[]);const{width:h,height:u}=(0,o.A)((e=>e.size)),d=i.useContext(o.p),f=i.useMemo((()=>s.createRoot(l.fixed)),[l.fixed]);return(0,o.C)((()=>{l.delta>l.eps&&(c.current.style.transform=`translate3d(${l.horizontal?-h*(l.pages-1)*l.offset:0}px,${l.horizontal?0:u*(l.pages-1)*-l.offset}px,0)`)})),f.render(i.createElement("div",(0,r.A)({ref:c,style:{...t,position:"absolute",top:0,left:0,willChange:"transform"}},n),i.createElement(Pn.Provider,{value:l},i.createElement(o.p.Provider,{value:d},e)))),null})),Un=i.forwardRef((({html:e,...t},n)=>{const s=e?On:Fn;return i.createElement(s,(0,r.A)({ref:n},t))}));function Qn({enabled:e=!0,snap:t,global:n,domElement:s,cursor:l=!0,children:c,speed:h=1,rotation:u=[0,0,0],zoom:d=1,polar:f=[0,Math.PI/2],azimuth:A=[-1/0,1/0],damping:m=.25}){const p=(0,o.A)((e=>e.events)),g=(0,o.A)((e=>e.gl)),v=s||p.connected||g.domElement,{size:y}=(0,o.A)(),E=i.useMemo((()=>[u[0]+f[0],u[0]+f[1]]),[u[0],f[0],f[1]]),x=i.useMemo((()=>[u[1]+A[0],u[1]+A[1]]),[u[1],A[0],A[1]]),C=i.useMemo((()=>[a.cj9.clamp(u[0],...E),a.cj9.clamp(u[1],...x),u[2]]),[u[0],u[1],u[2],E,x]);i.useEffect((()=>{if(n&&l&&e)return v.style.cursor="grab",g.domElement.style.cursor="",()=>{v.style.cursor="default",g.domElement.style.cursor="default"}}),[n,l,v,e]);const[w]=i.useState({scale:1,rotation:C,damping:m}),I=i.useRef(null);(0,o.C)(((e,t)=>{Mn.damp3(I.current.scale,w.scale,w.damping,t),Mn.dampE(I.current.rotation,w.rotation,w.damping,t)}));const b=Ge({onHover:({last:t})=>{l&&!n&&e&&(v.style.cursor=t?"auto":"grab")},onDrag:({down:n,delta:[r,i],memo:[s,o]=w.rotation||C})=>e?(l&&(v.style.cursor=n?"grabbing":"grab"),r=a.cj9.clamp(o+r/y.width*Math.PI*h,...x),i=a.cj9.clamp(s+i/y.height*Math.PI*h,...E),w.scale=n&&i>E[1]/2?d:1,w.rotation=t&&!n?C:[i,r,0],w.damping=t&&!n&&"boolean"!=typeof t?t:m,[i,r]):[i,r]},{target:n?v:void 0});return i.createElement("group",(0,r.A)({ref:I},null==b?void 0:b()),c)}const Nn=e=>(t,n,r)=>{const i=r.subscribe;r.subscribe=(e,t,n)=>{let s=e;if(t){const i=(null==n?void 0:n.equalityFn)||Object.is;let a=e(r.getState());s=n=>{const r=e(n);if(!i(a,r)){const e=a;t(a=r,e)}},(null==n?void 0:n.fireImmediately)&&t(a,a)}return i(s)};return e(t,n,r)};const zn=i.createContext(null);function Gn({map:e,children:t,onChange:n,domElement:r}){const s=e.map((e=>e.name+e.keys)).join("-"),a=i.useMemo((()=>I(Nn((()=>e.reduce(((e,t)=>({...e,[t.name]:!1})),{}))))),[s]),o=i.useMemo((()=>[a.subscribe,a.getState,a]),[s]),l=a.setState;return i.useEffect((()=>{const t=e.map((({name:e,keys:t,up:r})=>({keys:t,up:r,fn:t=>{l({[e]:t}),n&&n(e,t,o[1]())}}))).reduce(((e,{keys:t,fn:n,up:r=!0})=>(t.forEach((t=>e[t]={fn:n,pressed:!1,up:r})),e)),{}),i=({key:e,code:n})=>{const r=t[e]||t[n];if(!r)return;const{fn:i,pressed:s,up:a}=r;r.pressed=!0,!a&&s||i(!0)},s=({key:e,code:n})=>{const r=t[e]||t[n];if(!r)return;const{fn:i,up:s}=r;r.pressed=!1,s&&i(!1)},a=r||window;return a.addEventListener("keydown",i,{passive:!0}),a.addEventListener("keyup",s,{passive:!0}),()=>{a.removeEventListener("keydown",i),a.removeEventListener("keyup",s)}}),[r,s]),i.createElement(zn.Provider,{value:o,children:t})}function Hn(e){const[t,n,r]=i.useContext(zn);return e?r(e):[t,n]}const qn=new a.PPD,Yn=new a.Pq0,jn=new a.Pq0,Vn=new a.Pq0,Kn=new a.Pq0,Wn=new a.Pq0,Jn=new a.Pq0,Xn=new a.Pq0,$n=new a.Pq0,Zn=new a.Pq0,er=new a.Pq0,tr=new a.Pq0,nr=new a.Pq0,rr=new a.Pq0,ir=new a.Pq0;class sr{constructor(e,t,n){this.camera=e,this.scene=t,this.startPoint=new a.Pq0,this.endPoint=new a.Pq0,this.collection=[],this.deep=n||Number.MAX_VALUE}select(e,t){return this.startPoint=e||this.startPoint,this.endPoint=t||this.endPoint,this.collection=[],this.updateFrustum(this.startPoint,this.endPoint),this.searchChildInFrustum(qn,this.scene),this.collection}updateFrustum(e,t){if(e=e||this.startPoint,t=t||this.endPoint,e.x===t.x&&(t.x+=Number.EPSILON),e.y===t.y&&(t.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld(),this.camera.isPerspectiveCamera)jn.copy(e),jn.x=Math.min(e.x,t.x),jn.y=Math.max(e.y,t.y),t.x=Math.max(e.x,t.x),t.y=Math.min(e.y,t.y),Vn.setFromMatrixPosition(this.camera.matrixWorld),Kn.copy(jn),Wn.set(t.x,jn.y,0),Jn.copy(t),Xn.set(jn.x,t.y,0),Kn.unproject(this.camera),Wn.unproject(this.camera),Jn.unproject(this.camera),Xn.unproject(this.camera),nr.copy(Kn).sub(Vn),rr.copy(Wn).sub(Vn),ir.copy(Jn).sub(Vn),nr.normalize(),rr.normalize(),ir.normalize(),nr.multiplyScalar(this.deep),rr.multiplyScalar(this.deep),ir.multiplyScalar(this.deep),nr.add(Vn),rr.add(Vn),ir.add(Vn),(n=qn.planes)[0].setFromCoplanarPoints(Vn,Kn,Wn),n[1].setFromCoplanarPoints(Vn,Wn,Jn),n[2].setFromCoplanarPoints(Jn,Xn,Vn),n[3].setFromCoplanarPoints(Xn,Kn,Vn),n[4].setFromCoplanarPoints(Wn,Jn,Xn),n[5].setFromCoplanarPoints(ir,rr,nr),n[5].normal.multiplyScalar(-1);else if(this.camera.isOrthographicCamera){const r=Math.min(e.x,t.x),i=Math.max(e.y,t.y),s=Math.max(e.x,t.x),a=Math.min(e.y,t.y);var n;Kn.set(r,i,-1),Wn.set(s,i,-1),Jn.set(s,a,-1),Xn.set(r,a,-1),$n.set(r,i,1),Zn.set(s,i,1),er.set(s,a,1),tr.set(r,a,1),Kn.unproject(this.camera),Wn.unproject(this.camera),Jn.unproject(this.camera),Xn.unproject(this.camera),$n.unproject(this.camera),Zn.unproject(this.camera),er.unproject(this.camera),tr.unproject(this.camera),(n=qn.planes)[0].setFromCoplanarPoints(Kn,$n,Zn),n[1].setFromCoplanarPoints(Wn,Zn,er),n[2].setFromCoplanarPoints(er,tr,Xn),n[3].setFromCoplanarPoints(tr,$n,Kn),n[4].setFromCoplanarPoints(Wn,Jn,Xn),n[5].setFromCoplanarPoints(er,Zn,$n),n[5].normal.multiplyScalar(-1)}else console.error("THREE.SelectionBox: Unsupported camera type.")}searchChildInFrustum(e,t){if((t.isMesh||t.isLine||t.isPoints)&&void 0!==t.material&&(null===t.geometry.boundingSphere&&t.geometry.computeBoundingSphere(),Yn.copy(t.geometry.boundingSphere.center),Yn.applyMatrix4(t.matrixWorld),e.containsPoint(Yn)&&this.collection.push(t)),t.children.length>0)for(let n=0;n<t.children.length;n++)this.searchChildInFrustum(e,t.children[n])}}const ar=e=>Symbol.iterator in e,or=e=>"entries"in e,lr=(e,t)=>{const n=e instanceof Map?e:new Map(e.entries()),r=t instanceof Map?t:new Map(t.entries());if(n.size!==r.size)return!1;for(const[i,s]of n)if(!Object.is(s,r.get(i)))return!1;return!0},cr=(e,t)=>{const n=e[Symbol.iterator](),r=t[Symbol.iterator]();let i=n.next(),s=r.next();for(;!i.done&&!s.done;){if(!Object.is(i.value,s.value))return!1;i=n.next(),s=r.next()}return!!i.done&&!!s.done};const hr=i.createContext([]);function ur({box:e,multiple:t,children:n,onChange:s,onChangePointerUp:l,border:c="1px solid #55aaff",backgroundColor:h="rgba(75, 160, 255, 0.1)",filter:u=e=>e,...d}){const[f,A]=i.useState(!1),{setEvents:m,camera:p,raycaster:g,gl:v,controls:y,size:E,get:x}=(0,o.A)(),[C,w]=i.useState(!1),[I,b]=i.useReducer(((e,{object:t,shift:n})=>void 0===t?[]:Array.isArray(t)?t:n?e.includes(t)?e.filter((e=>e!==t)):[t,...e]:e[0]===t?[]:[t]),[]);i.useEffect((()=>{f?null==s||s(I):null==l||l(I)}),[I,f]);const S=i.useCallback((e=>{e.stopPropagation(),b({object:u([e.object])[0],shift:t&&e.shiftKey})}),[]),B=i.useCallback((e=>!C&&b({})),[C]),T=i.useRef(null);return i.useEffect((()=>{if(!e||!t)return;const n=new sr(p,T.current),r=document.createElement("div");r.style.pointerEvents="none",r.style.border=c,r.style.backgroundColor=h,r.style.position="fixed";const i=new a.I9Y,s=new a.I9Y,o=new a.I9Y,l=x().events.enabled,d=null==y?void 0:y.enabled;let f=!1;function g(e,t){const{offsetX:n,offsetY:r}=e,{width:i,height:s}=E;t.set(n/i*2-1,-r/s*2+1)}function C(e){e.shiftKey&&(!function(e){var t;y&&(y.enabled=!1),m({enabled:!1}),A(f=!0),null==(t=v.domElement.parentElement)||t.appendChild(r),r.style.left=`${e.clientX}px`,r.style.top=`${e.clientY}px`,r.style.width="0px",r.style.height="0px",i.x=e.clientX,i.y=e.clientY}(e),g(e,n.startPoint))}let w=[];function I(e){if(f){!function(e){o.x=Math.max(i.x,e.clientX),o.y=Math.max(i.y,e.clientY),s.x=Math.min(i.x,e.clientX),s.y=Math.min(i.y,e.clientY),r.style.left=`${s.x}px`,r.style.top=`${s.y}px`,r.style.width=o.x-s.x+"px",r.style.height=o.y-s.y+"px"}(e),g(e,n.endPoint);const l=n.select().sort((e=>e.uuid)).filter((e=>e.isMesh));t=l,a=w,Object.is(t,a)||"object"==typeof t&&null!==t&&"object"==typeof a&&null!==a&&(ar(t)&&ar(a)?or(t)&&or(a)?lr(t,a):cr(t,a):lr({entries:()=>Object.entries(t)},{entries:()=>Object.entries(a)}))||(w=l,b({object:u(l)}))}var t,a}function S(e){var t;f&&f&&(y&&(y.enabled=d),m({enabled:l}),A(f=!1),null==(t=r.parentElement)||t.removeChild(r))}return document.addEventListener("pointerdown",C,{passive:!0}),document.addEventListener("pointermove",I,{passive:!0,capture:!0}),document.addEventListener("pointerup",S,{passive:!0}),()=>{document.removeEventListener("pointerdown",C),document.removeEventListener("pointermove",I,!0),document.removeEventListener("pointerup",S)}}),[E.width,E.height,g,p,y,v]),i.createElement("group",(0,r.A)({ref:T,onClick:S,onPointerOver:()=>w(!0),onPointerOut:()=>w(!1),onPointerMissed:B},d),i.createElement(hr.Provider,{value:I},n))}function dr(){return i.useContext(hr)}const fr=i.forwardRef((function({children:e,follow:t=!0,lockX:n=!1,lockY:s=!1,lockZ:l=!1,...c},h){const u=i.useRef(null),d=i.useRef(null),f=new a.PTz;return(0,o.C)((({camera:e})=>{if(!t||!d.current)return;const r=u.current.rotation.clone();d.current.updateMatrix(),d.current.updateWorldMatrix(!1,!1),d.current.getWorldQuaternion(f),e.getWorldQuaternion(u.current.quaternion).premultiply(f.invert()),n&&(u.current.rotation.x=r.x),s&&(u.current.rotation.y=r.y),l&&(u.current.rotation.z=r.z)})),i.useImperativeHandle(h,(()=>d.current),[]),i.createElement("group",(0,r.A)({ref:d},c),i.createElement("group",{ref:u},e))})),Ar=i.forwardRef((({children:e,depth:t=-1,...n},s)=>{const a=i.useRef(null);return i.useImperativeHandle(s,(()=>a.current),[]),(0,o.C)((({camera:e})=>{a.current.quaternion.copy(e.quaternion),a.current.position.copy(e.position)})),i.createElement("group",(0,r.A)({ref:a},n),i.createElement("group",{"position-z":-t},e))})),mr=new a.Pq0,pr=new a.Pq0,gr=new a.Pq0,vr=(e,t,n,r=1)=>{const i=mr.set(e.x/n.width*2-1,-e.y/n.height*2+1,r);return i.unproject(t),i},yr=(e,t,n,r)=>{const i=((e,t,n)=>{const r=n.width/2,i=n.height/2;t.updateMatrixWorld(!1);const s=e.project(t);return s.x=s.x*r+r,s.y=-s.y*i+i,s})(gr.copy(e),n,r);let s=0;for(let a=0;a<2;++a){const o=pr.copy(i).setComponent(a,i.getComponent(a)+t),l=vr(o,n,r,o.z);s=Math.max(s,e.distanceTo(l))}return s},Er=new a.Pq0,xr=(0,i.forwardRef)((({scale:e=1,...t},n)=>{const s=(0,i.useRef)(null);return i.useImperativeHandle(n,(()=>s.current),[]),(0,o.C)((t=>{const n=s.current;if(!n)return;const r=yr(n.getWorldPosition(Er),e,t.camera,t.size);n.scale.setScalar(r*e)})),i.createElement("object3D",(0,r.A)({ref:s},t))})),Cr=new a.NRn,wr=new a.Pq0;class Ir extends a.CmU{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new a.qtW([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new a.qtW([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix4(e){const t=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==t&&(t.applyMatrix4(e),n.applyMatrix4(e),t.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const n=new a.LuO(t,6,1);return this.setAttribute("instanceStart",new a.eHs(n,3,0)),this.setAttribute("instanceEnd",new a.eHs(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e,t=3){let n;e instanceof Float32Array?n=e:Array.isArray(e)&&(n=new Float32Array(e));const r=new a.LuO(n,2*t,1);return this.setAttribute("instanceColorStart",new a.eHs(r,t,0)),this.setAttribute("instanceColorEnd",new a.eHs(r,t,t)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new a.XJ7(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new a.NRn);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;void 0!==e&&void 0!==t&&(this.boundingBox.setFromBufferAttribute(e),Cr.setFromBufferAttribute(t),this.boundingBox.union(Cr))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new a.iyt),null===this.boundingBox&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(void 0!==e&&void 0!==t){const n=this.boundingSphere.center;this.boundingBox.getCenter(n);let r=0;for(let i=0,s=e.count;i<s;i++)wr.fromBufferAttribute(e,i),r=Math.max(r,n.distanceToSquared(wr)),wr.fromBufferAttribute(t,i),r=Math.max(r,n.distanceToSquared(wr));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}var br=n(9437);const Sr=(()=>parseInt(a.sPf.replace(/\D+/g,"")))();class Br extends a.BKk{constructor(e){super({type:"LineMaterial",uniforms:a.LlO.clone(a.LlO.merge([br.UniformsLib.common,br.UniformsLib.fog,{worldUnits:{value:1},linewidth:{value:1},resolution:{value:new a.I9Y(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}}])),vertexShader:"\n\t\t\t\t#include <common>\n\t\t\t\t#include <fog_pars_vertex>\n\t\t\t\t#include <logdepthbuf_pars_vertex>\n\t\t\t\t#include <clipping_planes_pars_vertex>\n\n\t\t\t\tuniform float linewidth;\n\t\t\t\tuniform vec2 resolution;\n\n\t\t\t\tattribute vec3 instanceStart;\n\t\t\t\tattribute vec3 instanceEnd;\n\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\t#ifdef USE_LINE_COLOR_ALPHA\n\t\t\t\t\t\tvarying vec4 vLineColor;\n\t\t\t\t\t\tattribute vec4 instanceColorStart;\n\t\t\t\t\t\tattribute vec4 instanceColorEnd;\n\t\t\t\t\t#else\n\t\t\t\t\t\tvarying vec3 vLineColor;\n\t\t\t\t\t\tattribute vec3 instanceColorStart;\n\t\t\t\t\t\tattribute vec3 instanceColorEnd;\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\n\t\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t\tvarying vec4 worldPos;\n\t\t\t\t\tvarying vec3 worldStart;\n\t\t\t\t\tvarying vec3 worldEnd;\n\n\t\t\t\t\t#ifdef USE_DASH\n\n\t\t\t\t\t\tvarying vec2 vUv;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t#else\n\n\t\t\t\t\tvarying vec2 vUv;\n\n\t\t\t\t#endif\n\n\t\t\t\t#ifdef USE_DASH\n\n\t\t\t\t\tuniform float dashScale;\n\t\t\t\t\tattribute float instanceDistanceStart;\n\t\t\t\t\tattribute float instanceDistanceEnd;\n\t\t\t\t\tvarying float vLineDistance;\n\n\t\t\t\t#endif\n\n\t\t\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t\t\t// conservative estimate of the near plane\n\t\t\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\t#ifdef USE_COLOR\n\n\t\t\t\t\t\tvLineColor = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\t#ifdef USE_DASH\n\n\t\t\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t\t\t\t\t\tvUv = uv;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\t\t\t// camera space\n\t\t\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t\t\tworldStart = start.xyz;\n\t\t\t\t\t\tworldEnd = end.xyz;\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\tvUv = uv;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\t\t\tif ( perspective ) {\n\n\t\t\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// clip space\n\t\t\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t\t\t// ndc space\n\t\t\t\t\tvec3 ndcStart = clipStart.xyz / clipStart.w;\n\t\t\t\t\tvec3 ndcEnd = clipEnd.xyz / clipEnd.w;\n\n\t\t\t\t\t// direction\n\t\t\t\t\tvec2 dir = ndcEnd.xy - ndcStart.xy;\n\n\t\t\t\t\t// account for clip-space aspect ratio\n\t\t\t\t\tdir.x *= aspect;\n\t\t\t\t\tdir = normalize( dir );\n\n\t\t\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t\t\t// get the offset direction as perpendicular to the view vector\n\t\t\t\t\t\tvec3 worldDir = normalize( end.xyz - start.xyz );\n\t\t\t\t\t\tvec3 offset;\n\t\t\t\t\t\tif ( position.y < 0.5 ) {\n\n\t\t\t\t\t\t\toffset = normalize( cross( start.xyz, worldDir ) );\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\toffset = normalize( cross( end.xyz, worldDir ) );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// sign flip\n\t\t\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\t\t\tfloat forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );\n\n\t\t\t\t\t\t// don't extend the line if we're rendering dashes because we\n\t\t\t\t\t\t// won't be rendering the endcaps\n\t\t\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t\t\t// extend the line bounds to encompass  endcaps\n\t\t\t\t\t\t\tstart.xyz += - worldDir * linewidth * 0.5;\n\t\t\t\t\t\t\tend.xyz += worldDir * linewidth * 0.5;\n\n\t\t\t\t\t\t\t// shift the position of the quad so it hugs the forward edge of the line\n\t\t\t\t\t\t\toffset.xy -= dir * forwardOffset;\n\t\t\t\t\t\t\toffset.z += 0.5;\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t// endcaps\n\t\t\t\t\t\tif ( position.y > 1.0 || position.y < 0.0 ) {\n\n\t\t\t\t\t\t\toffset.xy += dir * 2.0 * forwardOffset;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// adjust for linewidth\n\t\t\t\t\t\toffset *= linewidth * 0.5;\n\n\t\t\t\t\t\t// set the world position\n\t\t\t\t\t\tworldPos = ( position.y < 0.5 ) ? start : end;\n\t\t\t\t\t\tworldPos.xyz += offset;\n\n\t\t\t\t\t\t// project the worldpos\n\t\t\t\t\t\tvec4 clip = projectionMatrix * worldPos;\n\n\t\t\t\t\t\t// shift the depth of the projected points so the line\n\t\t\t\t\t\t// segments overlap neatly\n\t\t\t\t\t\tvec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;\n\t\t\t\t\t\tclip.z = clipPose.z * clip.w;\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\t\t\t\t\t\t// undo aspect ratio adjustment\n\t\t\t\t\t\tdir.x /= aspect;\n\t\t\t\t\t\toffset.x /= aspect;\n\n\t\t\t\t\t\t// sign flip\n\t\t\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\t\t\t// endcaps\n\t\t\t\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\t\t\t\toffset += - dir;\n\n\t\t\t\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\t\t\t\toffset += dir;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// adjust for linewidth\n\t\t\t\t\t\toffset *= linewidth;\n\n\t\t\t\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\t\t\t\toffset /= resolution.y;\n\n\t\t\t\t\t\t// select end\n\t\t\t\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t\t\t\t// back to clip space\n\t\t\t\t\t\toffset *= clip.w;\n\n\t\t\t\t\t\tclip.xy += offset;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\tgl_Position = clip;\n\n\t\t\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t\t\t#include <logdepthbuf_vertex>\n\t\t\t\t\t#include <clipping_planes_vertex>\n\t\t\t\t\t#include <fog_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:`\n\t\t\t\tuniform vec3 diffuse;\n\t\t\t\tuniform float opacity;\n\t\t\t\tuniform float linewidth;\n\n\t\t\t\t#ifdef USE_DASH\n\n\t\t\t\t\tuniform float dashOffset;\n\t\t\t\t\tuniform float dashSize;\n\t\t\t\t\tuniform float gapSize;\n\n\t\t\t\t#endif\n\n\t\t\t\tvarying float vLineDistance;\n\n\t\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t\tvarying vec4 worldPos;\n\t\t\t\t\tvarying vec3 worldStart;\n\t\t\t\t\tvarying vec3 worldEnd;\n\n\t\t\t\t\t#ifdef USE_DASH\n\n\t\t\t\t\t\tvarying vec2 vUv;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t#else\n\n\t\t\t\t\tvarying vec2 vUv;\n\n\t\t\t\t#endif\n\n\t\t\t\t#include <common>\n\t\t\t\t#include <fog_pars_fragment>\n\t\t\t\t#include <logdepthbuf_pars_fragment>\n\t\t\t\t#include <clipping_planes_pars_fragment>\n\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\t#ifdef USE_LINE_COLOR_ALPHA\n\t\t\t\t\t\tvarying vec4 vLineColor;\n\t\t\t\t\t#else\n\t\t\t\t\t\tvarying vec3 vLineColor;\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\n\t\t\t\tvec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {\n\n\t\t\t\t\tfloat mua;\n\t\t\t\t\tfloat mub;\n\n\t\t\t\t\tvec3 p13 = p1 - p3;\n\t\t\t\t\tvec3 p43 = p4 - p3;\n\n\t\t\t\t\tvec3 p21 = p2 - p1;\n\n\t\t\t\t\tfloat d1343 = dot( p13, p43 );\n\t\t\t\t\tfloat d4321 = dot( p43, p21 );\n\t\t\t\t\tfloat d1321 = dot( p13, p21 );\n\t\t\t\t\tfloat d4343 = dot( p43, p43 );\n\t\t\t\t\tfloat d2121 = dot( p21, p21 );\n\n\t\t\t\t\tfloat denom = d2121 * d4343 - d4321 * d4321;\n\n\t\t\t\t\tfloat numer = d1343 * d4321 - d1321 * d4343;\n\n\t\t\t\t\tmua = numer / denom;\n\t\t\t\t\tmua = clamp( mua, 0.0, 1.0 );\n\t\t\t\t\tmub = ( d1343 + d4321 * ( mua ) ) / d4343;\n\t\t\t\t\tmub = clamp( mub, 0.0, 1.0 );\n\n\t\t\t\t\treturn vec2( mua, mub );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t\t\t#ifdef USE_DASH\n\n\t\t\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\tfloat alpha = opacity;\n\n\t\t\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t\t\t// Find the closest points on the view ray and the line segment\n\t\t\t\t\t\tvec3 rayEnd = normalize( worldPos.xyz ) * 1e5;\n\t\t\t\t\t\tvec3 lineDir = worldEnd - worldStart;\n\t\t\t\t\t\tvec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );\n\n\t\t\t\t\t\tvec3 p1 = worldStart + lineDir * params.x;\n\t\t\t\t\t\tvec3 p2 = rayEnd * params.y;\n\t\t\t\t\t\tvec3 delta = p1 - p2;\n\t\t\t\t\t\tfloat len = length( delta );\n\t\t\t\t\t\tfloat norm = len / linewidth;\n\n\t\t\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t\t\t\tfloat dnorm = fwidth( norm );\n\t\t\t\t\t\t\t\talpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );\n\n\t\t\t\t\t\t\t#else\n\n\t\t\t\t\t\t\t\tif ( norm > 0.5 ) {\n\n\t\t\t\t\t\t\t\t\tdiscard;\n\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\t\t\tfloat len2 = a * a + b * b;\n\t\t\t\t\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t#else\n\n\t\t\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\t\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\tvec4 diffuseColor = vec4( diffuse, alpha );\n\t\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\t\t#ifdef USE_LINE_COLOR_ALPHA\n\t\t\t\t\t\t\tdiffuseColor *= vLineColor;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tdiffuseColor.rgb *= vLineColor;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t#endif\n\n\t\t\t\t\t#include <logdepthbuf_fragment>\n\n\t\t\t\t\tgl_FragColor = diffuseColor;\n\n\t\t\t\t\t#include <tonemapping_fragment>\n\t\t\t\t\t#include <${Sr>=154?"colorspace_fragment":"encodings_fragment"}>\n\t\t\t\t\t#include <fog_fragment>\n\t\t\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t\t\t}\n\t\t\t`,clipping:!0}),this.isLineMaterial=!0,this.onBeforeCompile=function(){this.transparent?this.defines.USE_LINE_COLOR_ALPHA="1":delete this.defines.USE_LINE_COLOR_ALPHA},Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(e){!0===e?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashed:{enumerable:!0,get:function(){return Boolean("USE_DASH"in this.defines)},set(e){Boolean(e)!==Boolean("USE_DASH"in this.defines)&&(this.needsUpdate=!0),!0===e?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},alphaToCoverage:{enumerable:!0,get:function(){return Boolean("USE_ALPHA_TO_COVERAGE"in this.defines)},set:function(e){Boolean(e)!==Boolean("USE_ALPHA_TO_COVERAGE"in this.defines)&&(this.needsUpdate=!0),!0===e?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const Tr=Sr>=125?"uv1":"uv2",_r=new a.IUQ,Mr=new a.Pq0,Rr=new a.Pq0,Dr=new a.IUQ,Pr=new a.IUQ,Lr=new a.IUQ,kr=new a.Pq0,Fr=new a.kn4,Or=new a.cZY,Ur=new a.Pq0,Qr=new a.NRn,Nr=new a.iyt,zr=new a.IUQ;let Gr,Hr;function qr(e,t,n){return zr.set(0,0,-t,1).applyMatrix4(e.projectionMatrix),zr.multiplyScalar(1/zr.w),zr.x=Hr/n.width,zr.y=Hr/n.height,zr.applyMatrix4(e.projectionMatrixInverse),zr.multiplyScalar(1/zr.w),Math.abs(Math.max(zr.x,zr.y))}class Yr extends a.eaF{constructor(e=new Ir,t=new Br({color:16777215*Math.random()})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,n=e.attributes.instanceEnd,r=new Float32Array(2*t.count);for(let s=0,a=0,o=t.count;s<o;s++,a+=2)Mr.fromBufferAttribute(t,s),Rr.fromBufferAttribute(n,s),r[a]=0===a?0:r[a-1],r[a+1]=r[a]+Mr.distanceTo(Rr);const i=new a.LuO(r,2,1);return e.setAttribute("instanceDistanceStart",new a.eHs(i,1,0)),e.setAttribute("instanceDistanceEnd",new a.eHs(i,1,1)),this}raycast(e,t){const n=this.material.worldUnits,r=e.camera;null!==r||n||console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const i=void 0!==e.params.Line2&&e.params.Line2.threshold||0;Gr=e.ray;const s=this.matrixWorld,o=this.geometry,l=this.material;let c,h;if(Hr=l.linewidth+i,null===o.boundingSphere&&o.computeBoundingSphere(),Nr.copy(o.boundingSphere).applyMatrix4(s),n)c=.5*Hr;else{c=qr(r,Math.max(r.near,Nr.distanceToPoint(Gr.origin)),l.resolution)}if(Nr.radius+=c,!1!==Gr.intersectsSphere(Nr)){if(null===o.boundingBox&&o.computeBoundingBox(),Qr.copy(o.boundingBox).applyMatrix4(s),n)h=.5*Hr;else{h=qr(r,Math.max(r.near,Qr.distanceToPoint(Gr.origin)),l.resolution)}Qr.expandByScalar(h),!1!==Gr.intersectsBox(Qr)&&(n?function(e,t){const n=e.matrixWorld,r=e.geometry,i=r.attributes.instanceStart,s=r.attributes.instanceEnd;for(let o=0,l=Math.min(r.instanceCount,i.count);o<l;o++){Or.start.fromBufferAttribute(i,o),Or.end.fromBufferAttribute(s,o),Or.applyMatrix4(n);const r=new a.Pq0,l=new a.Pq0;Gr.distanceSqToSegment(Or.start,Or.end,l,r),l.distanceTo(r)<.5*Hr&&t.push({point:l,pointOnLine:r,distance:Gr.origin.distanceTo(l),object:e,face:null,faceIndex:o,uv:null,[Tr]:null})}}(this,t):function(e,t,n){const r=t.projectionMatrix,i=e.material.resolution,s=e.matrixWorld,o=e.geometry,l=o.attributes.instanceStart,c=o.attributes.instanceEnd,h=Math.min(o.instanceCount,l.count),u=-t.near;Gr.at(1,Lr),Lr.w=1,Lr.applyMatrix4(t.matrixWorldInverse),Lr.applyMatrix4(r),Lr.multiplyScalar(1/Lr.w),Lr.x*=i.x/2,Lr.y*=i.y/2,Lr.z=0,kr.copy(Lr),Fr.multiplyMatrices(t.matrixWorldInverse,s);for(let d=0,f=h;d<f;d++){if(Dr.fromBufferAttribute(l,d),Pr.fromBufferAttribute(c,d),Dr.w=1,Pr.w=1,Dr.applyMatrix4(Fr),Pr.applyMatrix4(Fr),Dr.z>u&&Pr.z>u)continue;if(Dr.z>u){const e=Dr.z-Pr.z,t=(Dr.z-u)/e;Dr.lerp(Pr,t)}else if(Pr.z>u){const e=Pr.z-Dr.z,t=(Pr.z-u)/e;Pr.lerp(Dr,t)}Dr.applyMatrix4(r),Pr.applyMatrix4(r),Dr.multiplyScalar(1/Dr.w),Pr.multiplyScalar(1/Pr.w),Dr.x*=i.x/2,Dr.y*=i.y/2,Pr.x*=i.x/2,Pr.y*=i.y/2,Or.start.copy(Dr),Or.start.z=0,Or.end.copy(Pr),Or.end.z=0;const t=Or.closestPointToPointParameter(kr,!0);Or.at(t,Ur);const o=a.cj9.lerp(Dr.z,Pr.z,t),h=o>=-1&&o<=1,f=kr.distanceTo(Ur)<.5*Hr;if(h&&f){Or.start.fromBufferAttribute(l,d),Or.end.fromBufferAttribute(c,d),Or.start.applyMatrix4(s),Or.end.applyMatrix4(s);const t=new a.Pq0,r=new a.Pq0;Gr.distanceSqToSegment(Or.start,Or.end,r,t),n.push({point:r,pointOnLine:t,distance:Gr.origin.distanceTo(r),object:e,face:null,faceIndex:d,uv:null,[Tr]:null})}}}(this,r,t))}}onBeforeRender(e){const t=this.material.uniforms;t&&t.resolution&&(e.getViewport(_r),this.material.uniforms.resolution.value.set(_r.z,_r.w))}}class jr extends Ir{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,n=new Float32Array(2*t);for(let r=0;r<t;r+=3)n[2*r]=e[r],n[2*r+1]=e[r+1],n[2*r+2]=e[r+2],n[2*r+3]=e[r+3],n[2*r+4]=e[r+4],n[2*r+5]=e[r+5];return super.setPositions(n),this}setColors(e,t=3){const n=e.length-t,r=new Float32Array(2*n);if(3===t)for(let i=0;i<n;i+=t)r[2*i]=e[i],r[2*i+1]=e[i+1],r[2*i+2]=e[i+2],r[2*i+3]=e[i+3],r[2*i+4]=e[i+4],r[2*i+5]=e[i+5];else for(let i=0;i<n;i+=t)r[2*i]=e[i],r[2*i+1]=e[i+1],r[2*i+2]=e[i+2],r[2*i+3]=e[i+3],r[2*i+4]=e[i+4],r[2*i+5]=e[i+5],r[2*i+6]=e[i+6],r[2*i+7]=e[i+7];return super.setColors(r,t),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class Vr extends Yr{constructor(e=new jr,t=new Br({color:16777215*Math.random()})){super(e,t),this.isLine2=!0,this.type="Line2"}}const Kr=i.forwardRef((function({points:e,color:t=16777215,vertexColors:n,linewidth:s,lineWidth:l,segments:c,dashed:h,...u},d){var f,A;const m=(0,o.A)((e=>e.size)),p=i.useMemo((()=>c?new Yr:new Vr),[c]),[g]=i.useState((()=>new Br)),v=4===(null==n||null==(f=n[0])?void 0:f.length)?4:3,y=i.useMemo((()=>{const r=c?new Ir:new jr,i=e.map((e=>{const t=Array.isArray(e);return e instanceof a.Pq0||e instanceof a.IUQ?[e.x,e.y,e.z]:e instanceof a.I9Y?[e.x,e.y,0]:t&&3===e.length?[e[0],e[1],e[2]]:t&&2===e.length?[e[0],e[1],0]:e}));if(r.setPositions(i.flat()),n){t=16777215;const e=n.map((e=>e instanceof a.Q1f?e.toArray():e));r.setColors(e.flat(),v)}return r}),[e,c,n,v]);return i.useLayoutEffect((()=>{p.computeLineDistances()}),[e,p]),i.useLayoutEffect((()=>{h?g.defines.USE_DASH="":delete g.defines.USE_DASH,g.needsUpdate=!0}),[h,g]),i.useEffect((()=>()=>{y.dispose(),g.dispose()}),[y]),i.createElement("primitive",(0,r.A)({object:p,ref:d},u),i.createElement("primitive",{object:y,attach:"geometry"}),i.createElement("primitive",(0,r.A)({object:g,attach:"material",color:t,vertexColors:Boolean(n),resolution:[m.width,m.height],linewidth:null!==(A=null!=s?s:l)&&void 0!==A?A:1,dashed:h,transparent:4===v},u)))})),Wr=new a.Pq0,Jr=i.forwardRef((function({start:e=[0,0,0],end:t=[0,0,0],mid:n,segments:s=20,...o},l){const c=i.useRef(null);i.useImperativeHandle(l,(()=>c.current));const[h]=i.useState((()=>new a.CV9(void 0,void 0,void 0))),u=i.useCallback(((e,t,n,r=20)=>(e instanceof a.Pq0?h.v0.copy(e):h.v0.set(...e),t instanceof a.Pq0?h.v2.copy(t):h.v2.set(...t),n instanceof a.Pq0?h.v1.copy(n):Array.isArray(n)?h.v1.set(...n):h.v1.copy(h.v0.clone().add(h.v2.clone().sub(h.v0)).add(Wr.set(0,h.v0.y-h.v2.y,0))),h.getPoints(r))),[]);i.useLayoutEffect((()=>{c.current.setPoints=(e,t,n)=>{const r=u(e,t,n);c.current.geometry&&c.current.geometry.setPositions(r.map((e=>e.toArray())).flat())}}),[]);const d=i.useMemo((()=>u(e,t,n,s)),[e,t,n,s]);return i.createElement(Kr,(0,r.A)({ref:c,points:d},o))})),Xr=i.forwardRef((function({start:e,end:t,midA:n,midB:s,segments:o=20,...l},c){const h=i.useMemo((()=>{const r=e instanceof a.Pq0?e:new a.Pq0(...e),i=t instanceof a.Pq0?t:new a.Pq0(...t),l=n instanceof a.Pq0?n:new a.Pq0(...n),c=s instanceof a.Pq0?s:new a.Pq0(...s);return new a.s0K(r,l,c,i).getPoints(o)}),[e,t,n,s,o]);return i.createElement(Kr,(0,r.A)({ref:c,points:h},l))})),$r=i.forwardRef((function({points:e,closed:t=!1,curveType:n="centripetal",tension:s=.5,segments:o=20,vertexColors:l,...c},h){const u=i.useMemo((()=>{const r=e.map((e=>e instanceof a.Pq0?e:new a.Pq0(...e)));return new a.B6O(r,t,n,s)}),[e,t,n,s]),d=i.useMemo((()=>u.getPoints(o)),[u,o]),f=i.useMemo((()=>{if(!l||l.length<2)return;if(l.length===o+1)return l;const e=l.map((e=>e instanceof a.Q1f?e:new a.Q1f(...e)));t&&e.push(e[0].clone());const n=[e[0]],r=o/(e.length-1);for(let t=1;t<o;t++){const i=t%r/r,s=Math.floor(t/r);n.push(e[s].clone().lerp(e[s+1],i))}return n.push(e[e.length-1]),n}),[l,o]);return i.createElement(Kr,(0,r.A)({ref:h,points:d,vertexColors:f},c))})),Zr=i.forwardRef((({url:e,distance:t=1,loop:n=!0,autoplay:s,...l},c)=>{const h=i.useRef(null);i.useImperativeHandle(c,(()=>h.current),[]);const u=(0,o.A)((({camera:e})=>e)),[d]=i.useState((()=>new a.Pf$)),f=(0,o.F)(a.Am1,e);return i.useEffect((()=>{const e=h.current;e&&(e.setBuffer(f),e.setRefDistance(t),e.setLoop(n),s&&!e.isPlaying&&e.play())}),[f,u,t,n]),i.useEffect((()=>{const e=h.current;return u.add(d),()=>{u.remove(d),e&&(e.isPlaying&&e.stop(),e.source&&e.source._connected&&e.disconnect())}}),[]),i.createElement("positionalAudio",(0,r.A)({ref:h,args:[d]},l))}));function ei(){var e=Object.create(null);function t(r,i){var s=r.id,a=r.name,o=r.dependencies;void 0===o&&(o=[]);var l=r.init;void 0===l&&(l=function(){});var c=r.getTransferables;if(void 0===c&&(c=null),!e[s])try{o=o.map((function(n){return n&&n.isWorkerModule&&(t(n,(function(e){if(e instanceof Error)throw e})),n=e[n.id].value),n})),l=n("<"+a+">.init",l),c&&(c=n("<"+a+">.getTransferables",c));var h=null;"function"==typeof l?h=l.apply(void 0,o):console.error("worker module init function failed to rehydrate"),e[s]={id:s,value:h,getTransferables:c},i(h)}catch(u){u&&u.noLog||console.error(u),i(u)}}function n(e,t){var n=void 0;self.troikaDefine=function(e){return n=e};var r=URL.createObjectURL(new Blob(["/** "+e.replace(/\*/g,"")+" **/\n\ntroikaDefine(\n"+t+"\n)"],{type:"application/javascript"}));try{importScripts(r)}catch(i){console.error(i)}return URL.revokeObjectURL(r),delete self.troikaDefine,n}self.addEventListener("message",(function(n){var r=n.data,i=r.messageId,s=r.action,a=r.data;try{"registerModule"===s&&t(a,(function(e){e instanceof Error?postMessage({messageId:i,success:!1,error:e.message}):postMessage({messageId:i,success:!0,result:{isCallable:"function"==typeof e}})})),"callModule"===s&&function(t,n){var r,i=t.id,s=t.args;e[i]&&"function"==typeof e[i].value||n(new Error("Worker module "+i+": not found or its 'init' did not return a function"));try{var a=(r=e[i]).value.apply(r,s);a&&"function"==typeof a.then?a.then(o,(function(e){return n(e instanceof Error?e:new Error(""+e))})):o(a)}catch(l){n(l)}function o(t){try{var r=e[i].getTransferables&&e[i].getTransferables(t);r&&Array.isArray(r)&&r.length||(r=void 0),n(t,r)}catch(l){console.error(l),n(l)}}}(a,(function(e,t){e instanceof Error?postMessage({messageId:i,success:!1,error:e.message}):postMessage({messageId:i,success:!0,result:e},t||void 0)}))}catch(o){postMessage({messageId:i,success:!1,error:o.stack})}}))}var ti=function(){var e=!1;if("undefined"!=typeof window&&void 0!==window.document)try{new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"}))).terminate(),e=!0}catch(t){console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+t.message+"]")}return ti=function(){return e},e},ni=0,ri=0,ii=!1,si=Object.create(null),ai=Object.create(null),oi=Object.create(null);function li(e){if(!(e&&"function"==typeof e.init||ii))throw new Error("requires `options.init` function");var t=e.dependencies,n=e.init,r=e.getTransferables,i=e.workerId,s=function(e){var t=function(){for(var e=[],n=arguments.length;n--;)e[n]=arguments[n];return t._getInitResult().then((function(t){if("function"==typeof t)return t.apply(void 0,e);throw new Error("Worker module function was called but `init` did not return a callable function")}))};return t._getInitResult=function(){var n=e.dependencies,r=e.init;n=Array.isArray(n)?n.map((function(e){return e&&(e=e.onMainThread||e)._getInitResult&&(e=e._getInitResult()),e})):[];var i=Promise.all(n).then((function(e){return r.apply(null,e)}));return t._getInitResult=function(){return i},i},t}(e);null==i&&(i="#default");var a="workerModule"+ ++ni,o=e.name||a,l=null;function c(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];if(!ti())return s.apply(void 0,e);if(!l){l=hi(i,"registerModule",c.workerModuleData);var n=function(){l=null,ai[i].delete(n)};(ai[i]||(ai[i]=new Set)).add(n)}return l.then((function(t){if(t.isCallable)return hi(i,"callModule",{id:a,args:e});throw new Error("Worker module function was called but `init` did not return a callable function")}))}return t=t&&t.map((function(e){return"function"!=typeof e||e.workerModuleData||(ii=!0,e=li({workerId:i,name:"<"+o+"> function dependency: "+e.name,init:"function(){return (\n"+ci(e)+"\n)}"}),ii=!1),e&&e.workerModuleData&&(e=e.workerModuleData),e})),c.workerModuleData={isWorkerModule:!0,id:a,name:o,dependencies:t,init:ci(n),getTransferables:r&&ci(r)},c.onMainThread=s,c}function ci(e){var t=e.toString();return!/^function/.test(t)&&/^\w+\s*\(/.test(t)&&(t="function "+t),t}function hi(e,t,n){return new Promise((function(r,i){var s=++ri;oi[s]=function(e){e.success?r(e.result):i(new Error("Error in worker "+t+" call: "+e.error))},function(e){var t=si[e];if(!t){var n=ci(ei);(t=si[e]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+e.replace(/\*/g,"")+" **/\n\n;("+n+")()"],{type:"application/javascript"})))).onmessage=function(e){var t=e.data,n=t.messageId,r=oi[n];if(!r)throw new Error("WorkerModule response with empty or unknown messageId");delete oi[n],r(t)}}return t}(e).postMessage({messageId:s,action:t,data:n})}))}function ui(){var e=function(e){function t(e,t,n,r,i,s,a,o){var l=1-a;o.x=l*l*e+2*l*a*n+a*a*i,o.y=l*l*t+2*l*a*r+a*a*s}function n(e,t,n,r,i,s,a,o,l,c){var h=1-l;c.x=h*h*h*e+3*h*h*l*n+3*h*l*l*i+l*l*l*a,c.y=h*h*h*t+3*h*h*l*r+3*h*l*l*s+l*l*l*o}function r(e,t){for(var n,r,i,s,a,o=/([MLQCZ])([^MLQCZ]*)/g;n=o.exec(e);){var l=n[2].replace(/^\s*|\s*$/g,"").split(/[,\s]+/).map((function(e){return parseFloat(e)}));switch(n[1]){case"M":s=r=l[0],a=i=l[1];break;case"L":l[0]===s&&l[1]===a||t("L",s,a,s=l[0],a=l[1]);break;case"Q":t("Q",s,a,s=l[2],a=l[3],l[0],l[1]);break;case"C":t("C",s,a,s=l[4],a=l[5],l[0],l[1],l[2],l[3]);break;case"Z":s===r&&a===i||t("L",s,a,r,i)}}}function i(e,i,s){void 0===s&&(s=16);var a={x:0,y:0};r(e,(function(e,r,o,l,c,h,u,d,f){switch(e){case"L":i(r,o,l,c);break;case"Q":for(var A=r,m=o,p=1;p<s;p++)t(r,o,h,u,l,c,p/(s-1),a),i(A,m,a.x,a.y),A=a.x,m=a.y;break;case"C":for(var g=r,v=o,y=1;y<s;y++)n(r,o,h,u,d,f,l,c,y/(s-1),a),i(g,v,a.x,a.y),g=a.x,v=a.y}}))}var s="precision highp float;attribute vec2 aUV;varying vec2 vUV;void main(){vUV=aUV;gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",a=new WeakMap,o={premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1};function l(e,t){var n=e.getContext?e.getContext("webgl",o):e,r=a.get(n);if(!r){var i="undefined"!=typeof WebGL2RenderingContext&&n instanceof WebGL2RenderingContext,s={},l={},c={},h=-1,u=[];function d(e){var t=s[e];if(!t&&!(t=s[e]=n.getExtension(e)))throw new Error(e+" not supported");return t}function f(e,t){var r=n.createShader(t);return n.shaderSource(r,e),n.compileShader(r),r}function A(e,t,r,s){if(!l[e]){var a={},o={},c=n.createProgram();n.attachShader(c,f(t,n.VERTEX_SHADER)),n.attachShader(c,f(r,n.FRAGMENT_SHADER)),n.linkProgram(c),l[e]={program:c,transaction:function(e){n.useProgram(c),e({setUniform:function(e,t){for(var r=[],i=arguments.length-2;i-- >0;)r[i]=arguments[i+2];var s=o[t]||(o[t]=n.getUniformLocation(c,t));n["uniform"+e].apply(n,[s].concat(r))},setAttribute:function(e,t,r,s,o){var l=a[e];l||(l=a[e]={buf:n.createBuffer(),loc:n.getAttribLocation(c,e),data:null}),n.bindBuffer(n.ARRAY_BUFFER,l.buf),n.vertexAttribPointer(l.loc,t,n.FLOAT,!1,0,0),n.enableVertexAttribArray(l.loc),i?n.vertexAttribDivisor(l.loc,s):d("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(l.loc,s),o!==l.data&&(n.bufferData(n.ARRAY_BUFFER,o,r),l.data=o)}})}}}l[e].transaction(s)}function m(e,t){h++;try{n.activeTexture(n.TEXTURE0+h);var r=c[e];r||(r=c[e]=n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.bindTexture(n.TEXTURE_2D,r),t(r,h)}finally{h--}}function p(e,t,r){var i=n.createFramebuffer();u.push(i),n.bindFramebuffer(n.FRAMEBUFFER,i),n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,e,0);try{r(i)}finally{n.deleteFramebuffer(i),n.bindFramebuffer(n.FRAMEBUFFER,u[--u.length-1]||null)}}function g(){s={},l={},c={},h=-1,u.length=0}n.canvas.addEventListener("webglcontextlost",(function(e){g(),e.preventDefault()}),!1),a.set(n,r={gl:n,isWebGL2:i,getExtension:d,withProgram:A,withTexture:m,withTextureFramebuffer:p,handleContextLoss:g})}t(r)}function c(e,t,n,r,i,a,o,c){void 0===o&&(o=15),void 0===c&&(c=null),l(e,(function(e){var l=e.gl,h=e.withProgram;(0,e.withTexture)("copy",(function(e,u){l.texImage2D(l.TEXTURE_2D,0,l.RGBA,i,a,0,l.RGBA,l.UNSIGNED_BYTE,t),h("copy",s,"precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){gl_FragColor=texture2D(tex,vUV);}",(function(e){var t=e.setUniform;(0,e.setAttribute)("aUV",2,l.STATIC_DRAW,0,new Float32Array([0,0,2,0,0,2])),t("1i","image",u),l.bindFramebuffer(l.FRAMEBUFFER,c||null),l.disable(l.BLEND),l.colorMask(8&o,4&o,2&o,1&o),l.viewport(n,r,i,a),l.scissor(n,r,i,a),l.drawArrays(l.TRIANGLES,0,3)}))}))}))}var h=Object.freeze({__proto__:null,withWebGLContext:l,renderImageData:c,resizeWebGLCanvasWithoutClearing:function(e,t,n){var r=e.width,i=e.height;l(e,(function(s){var a=s.gl,o=new Uint8Array(r*i*4);a.readPixels(0,0,r,i,a.RGBA,a.UNSIGNED_BYTE,o),e.width=t,e.height=n,c(a,o,0,0,r,i)}))}});function u(e,t,n,r,s,a){void 0===a&&(a=1);var o=new Uint8Array(e*t),l=r[2]-r[0],c=r[3]-r[1],h=[];i(n,(function(e,t,n,r){h.push({x1:e,y1:t,x2:n,y2:r,minX:Math.min(e,n),minY:Math.min(t,r),maxX:Math.max(e,n),maxY:Math.max(t,r)})})),h.sort((function(e,t){return e.maxX-t.maxX}));for(var u=0;u<e;u++)for(var d=0;d<t;d++){var f=p(r[0]+l*(u+.5)/e,r[1]+c*(d+.5)/t),m=Math.pow(1-Math.abs(f)/s,a)/2;f<0&&(m=1-m),m=Math.max(0,Math.min(255,Math.round(255*m))),o[d*e+u]=m}return o;function p(e,t){for(var n=1/0,r=1/0,i=h.length;i--;){var s=h[i];if(s.maxX+r<=e)break;if(e+r>s.minX&&t-r<s.maxY&&t+r>s.minY){var a=A(e,t,s.x1,s.y1,s.x2,s.y2);a<n&&(n=a,r=Math.sqrt(n))}}return function(e,t){for(var n=0,r=h.length;r--;){var i=h[r];if(i.maxX<=e)break;i.y1>t!=i.y2>t&&e<(i.x2-i.x1)*(t-i.y1)/(i.y2-i.y1)+i.x1&&(n+=i.y1<i.y2?1:-1)}return 0!==n}(e,t)&&(r=-r),r}}function d(e,t,n,r,i,s,a,o,l,c){void 0===s&&(s=1),void 0===o&&(o=0),void 0===l&&(l=0),void 0===c&&(c=0),f(e,t,n,r,i,s,a,null,o,l,c)}function f(e,t,n,r,i,s,a,o,l,h,d){void 0===s&&(s=1),void 0===l&&(l=0),void 0===h&&(h=0),void 0===d&&(d=0);for(var f=u(e,t,n,r,i,s),A=new Uint8Array(4*f.length),m=0;m<f.length;m++)A[4*m+d]=f[m];c(a,A,l,h,e,t,1<<3-d,o)}function A(e,t,n,r,i,s){var a=i-n,o=s-r,l=a*a+o*o,c=l?Math.max(0,Math.min(1,((e-n)*a+(t-r)*o)/l)):0,h=e-(n+c*a),u=t-(r+c*o);return h*h+u*u}var m=Object.freeze({__proto__:null,generate:u,generateIntoCanvas:d,generateIntoFramebuffer:f}),p=new Float32Array([0,0,2,0,0,2]),g=null,v=!1,y={},E=new WeakMap;function x(e){if(!v&&!b(e))throw new Error("WebGL generation not supported")}function C(e,t,n,r,i,s,a){if(void 0===s&&(s=1),void 0===a&&(a=null),!a&&!(a=g)){var o="function"==typeof OffscreenCanvas?new OffscreenCanvas(1,1):"undefined"!=typeof document?document.createElement("canvas"):null;if(!o)throw new Error("OffscreenCanvas or DOM canvas not supported");a=g=o.getContext("webgl",{depth:!1})}x(a);var c=new Uint8Array(e*t*4);l(a,(function(a){var o=a.gl,l=a.withTexture,h=a.withTextureFramebuffer;l("readable",(function(a,l){o.texImage2D(o.TEXTURE_2D,0,o.RGBA,e,t,0,o.RGBA,o.UNSIGNED_BYTE,null),h(a,l,(function(a){I(e,t,n,r,i,s,o,a,0,0,0),o.readPixels(0,0,e,t,o.RGBA,o.UNSIGNED_BYTE,c)}))}))}));for(var h=new Uint8Array(e*t),u=0,d=0;u<c.length;u+=4)h[d++]=c[u];return h}function w(e,t,n,r,i,s,a,o,l,c){void 0===s&&(s=1),void 0===o&&(o=0),void 0===l&&(l=0),void 0===c&&(c=0),I(e,t,n,r,i,s,a,null,o,l,c)}function I(e,t,n,r,a,o,c,h,u,d,f){void 0===o&&(o=1),void 0===u&&(u=0),void 0===d&&(d=0),void 0===f&&(f=0),x(c);var A=[];i(n,(function(e,t,n,r){A.push(e,t,n,r)})),A=new Float32Array(A),l(c,(function(n){var i=n.gl,l=n.isWebGL2,c=n.getExtension,m=n.withProgram,g=n.withTexture,v=n.withTextureFramebuffer,y=n.handleContextLoss;if(g("rawDistances",(function(n,g){e===n._lastWidth&&t===n._lastHeight||i.texImage2D(i.TEXTURE_2D,0,i.RGBA,n._lastWidth=e,n._lastHeight=t,0,i.RGBA,i.UNSIGNED_BYTE,null),m("main","precision highp float;uniform vec4 uGlyphBounds;attribute vec2 aUV;attribute vec4 aLineSegment;varying vec4 vLineSegment;varying vec2 vGlyphXY;void main(){vLineSegment=aLineSegment;vGlyphXY=mix(uGlyphBounds.xy,uGlyphBounds.zw,aUV);gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}","precision highp float;uniform vec4 uGlyphBounds;uniform float uMaxDistance;uniform float uExponent;varying vec4 vLineSegment;varying vec2 vGlyphXY;float absDistToSegment(vec2 point,vec2 lineA,vec2 lineB){vec2 lineDir=lineB-lineA;float lenSq=dot(lineDir,lineDir);float t=lenSq==0.0 ? 0.0 : clamp(dot(point-lineA,lineDir)/lenSq,0.0,1.0);vec2 linePt=lineA+t*lineDir;return distance(point,linePt);}void main(){vec4 seg=vLineSegment;vec2 p=vGlyphXY;float dist=absDistToSegment(p,seg.xy,seg.zw);float val=pow(1.0-clamp(dist/uMaxDistance,0.0,1.0),uExponent)*0.5;bool crossing=(seg.y>p.y!=seg.w>p.y)&&(p.x<(seg.z-seg.x)*(p.y-seg.y)/(seg.w-seg.y)+seg.x);bool crossingUp=crossing&&vLineSegment.y<vLineSegment.w;gl_FragColor=vec4(crossingUp ? 1.0/255.0 : 0.0,crossing&&!crossingUp ? 1.0/255.0 : 0.0,0.0,val);}",(function(s){var h=s.setAttribute,u=s.setUniform,d=!l&&c("ANGLE_instanced_arrays"),f=!l&&c("EXT_blend_minmax");h("aUV",2,i.STATIC_DRAW,0,p),h("aLineSegment",4,i.DYNAMIC_DRAW,1,A),u.apply(void 0,["4f","uGlyphBounds"].concat(r)),u("1f","uMaxDistance",a),u("1f","uExponent",o),v(n,g,(function(n){i.enable(i.BLEND),i.colorMask(!0,!0,!0,!0),i.viewport(0,0,e,t),i.scissor(0,0,e,t),i.blendFunc(i.ONE,i.ONE),i.blendEquationSeparate(i.FUNC_ADD,l?i.MAX:f.MAX_EXT),i.clear(i.COLOR_BUFFER_BIT),l?i.drawArraysInstanced(i.TRIANGLES,0,3,A.length/4):d.drawArraysInstancedANGLE(i.TRIANGLES,0,3,A.length/4)}))})),m("post",s,"precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){vec4 color=texture2D(tex,vUV);bool inside=color.r!=color.g;float val=inside ? 1.0-color.a : color.a;gl_FragColor=vec4(val);}",(function(n){n.setAttribute("aUV",2,i.STATIC_DRAW,0,p),n.setUniform("1i","tex",g),i.bindFramebuffer(i.FRAMEBUFFER,h),i.disable(i.BLEND),i.colorMask(0===f,1===f,2===f,3===f),i.viewport(u,d,e,t),i.scissor(u,d,e,t),i.drawArrays(i.TRIANGLES,0,3)}))})),i.isContextLost())throw y(),new Error("webgl context lost")}))}function b(e){var t=e&&e!==g?e.canvas||e:y,n=E.get(t);if(void 0===n){v=!0;var r=null;try{var i=[97,106,97,61,99,137,118,80,80,118,137,99,61,97,106,97],s=C(4,4,"M8,8L16,8L24,24L16,24Z",[0,0,32,32],24,1,e);n=s&&i.length===s.length&&s.every((function(e,t){return e===i[t]})),n||(r="bad trial run results",console.info(i,s))}catch(a){n=!1,r=a.message}r&&console.warn("WebGL SDF generation not supported:",r),v=!1,E.set(t,n)}return n}var S=Object.freeze({__proto__:null,generate:C,generateIntoCanvas:w,generateIntoFramebuffer:I,isSupported:b});return e.forEachPathCommand=r,e.generate=function(e,t,n,r,i,s){void 0===i&&(i=Math.max(r[2]-r[0],r[3]-r[1])/2),void 0===s&&(s=1);try{return C.apply(S,arguments)}catch(Sf){return console.info("WebGL SDF generation failed, falling back to JS",Sf),u.apply(m,arguments)}},e.generateIntoCanvas=function(e,t,n,r,i,s,a,o,l,c){void 0===i&&(i=Math.max(r[2]-r[0],r[3]-r[1])/2),void 0===s&&(s=1),void 0===o&&(o=0),void 0===l&&(l=0),void 0===c&&(c=0);try{return w.apply(S,arguments)}catch(Sf){return console.info("WebGL SDF generation failed, falling back to JS",Sf),d.apply(m,arguments)}},e.javascript=m,e.pathToLineSegments=i,e.webgl=S,e.webglUtils=h,Object.defineProperty(e,"__esModule",{value:!0}),e}({});return e}const di=function(){var e=function(e){var t={R:"13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",EN:"1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",ES:"17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",ET:"z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",AN:"16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",CS:"18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",B:"a,3,f+2,2v,690",S:"9,2,k",WS:"c,k,4f4,1vk+a,u,1j,335",ON:"x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",BN:"0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",NSM:"lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",AL:"16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",LRO:"6ct",RLO:"6cu",LRE:"6cq",RLE:"6cr",PDF:"6cs",LRI:"6ee",RLI:"6ef",FSI:"6eg",PDI:"6eh"},n={},r={};n.L=1,r[1]="L",Object.keys(t).forEach((function(e,t){n[e]=1<<t+1,r[n[e]]=e})),Object.freeze(n);var i=n.LRI|n.RLI|n.FSI,s=n.L|n.R|n.AL,a=n.B|n.S|n.WS|n.ON|n.FSI|n.LRI|n.RLI|n.PDI,o=n.BN|n.RLE|n.LRE|n.RLO|n.LRO|n.PDF,l=n.S|n.WS|n.B|i|n.PDI|o,c=null;function h(e){return function(){if(!c){c=new Map;var e=function(e){if(t.hasOwnProperty(e)){var r=0;t[e].split(",").forEach((function(t){var i=t.split("+"),s=i[0],a=i[1];s=parseInt(s,36),a=a?parseInt(a,36):0,c.set(r+=s,n[e]);for(var o=0;o<a;o++)c.set(++r,n[e])}))}};for(var r in t)e(r)}}(),c.get(e.codePointAt(0))||n.L}var u,d,f,A="14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",m="6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye";function p(e,t){var n,r=0,i=new Map,s=t&&new Map;return e.split(",").forEach((function e(a){if(-1!==a.indexOf("+"))for(var o=+a;o--;)e(n);else{n=a;var l=a.split(">"),c=l[0],h=l[1];c=String.fromCodePoint(r+=parseInt(c,36)),h=String.fromCodePoint(r+=parseInt(h,36)),i.set(c,h),t&&s.set(h,c)}})),{map:i,reverseMap:s}}function g(){if(!u){var e=p(A,!0),t=e.map,n=e.reverseMap;u=t,d=n,f=p(m,!1).map}}function v(e){return g(),u.get(e)||null}function y(e){return g(),d.get(e)||null}function E(e){return g(),f.get(e)||null}var x=n.L,C=n.R,w=n.EN,I=n.ES,b=n.ET,S=n.AN,B=n.CS,T=n.B,_=n.S,M=n.ON,R=n.BN,D=n.NSM,P=n.AL,L=n.LRO,k=n.RLO,F=n.LRE,O=n.RLE,U=n.PDF,Q=n.LRI,N=n.RLI,z=n.FSI,G=n.PDI;var H;function q(e){return function(){if(!H){var e=p("14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1",!0),t=e.map;e.reverseMap.forEach((function(e,n){t.set(n,e)})),H=t}}(),H.get(e)||null}function Y(e,t,n,r){var i=e.length;n=Math.max(0,null==n?0:+n),r=Math.min(i-1,null==r?i-1:+r);var s=[];return t.paragraphs.forEach((function(i){var a=Math.max(n,i.start),o=Math.min(r,i.end);if(a<o){for(var c=t.levels.slice(a,o+1),u=o;u>=a&&h(e[u])&l;u--)c[u]=i.level;for(var d=i.level,f=1/0,A=0;A<c.length;A++){var m=c[A];m>d&&(d=m),m<f&&(f=1|m)}for(var p=d;p>=f;p--)for(var g=0;g<c.length;g++)if(c[g]>=p){for(var v=g;g+1<c.length&&c[g+1]>=p;)g++;g>v&&s.push([v+a,g+a])}}})),s}function j(e,t,n,r){for(var i=Y(e,t,n,r),s=[],a=0;a<e.length;a++)s[a]=a;return i.forEach((function(e){for(var t=e[0],n=e[1],r=s.slice(t,n+1),i=r.length;i--;)s[n-i]=r[i]})),s}return e.closingToOpeningBracket=y,e.getBidiCharType=h,e.getBidiCharTypeName=function(e){return r[h(e)]},e.getCanonicalBracket=E,e.getEmbeddingLevels=function(e,t){for(var n=new Uint32Array(e.length),r=0;r<e.length;r++)n[r]=h(e[r]);var c=new Map;function u(e,t){var r=n[e];n[e]=t,c.set(r,c.get(r)-1),r&a&&c.set(a,c.get(a)-1),c.set(t,(c.get(t)||0)+1),t&a&&c.set(a,(c.get(a)||0)+1)}for(var d=new Uint8Array(e.length),f=new Map,A=[],m=null,p=0;p<e.length;p++)m||A.push(m={start:p,end:e.length-1,level:"rtl"===t?1:"ltr"===t?0:zt(p,!1)}),n[p]&T&&(m.end=p,m=null);for(var g=O|F|k|L|i|G|U|T,H=function(e){return e+(1&e?1:2)},q=function(e){return e+(1&e?2:1)},Y=0;Y<A.length;Y++){var j=[{_level:(m=A[Y]).level,_override:0,_isolate:0}],V=void 0,K=0,W=0,J=0;c.clear();for(var X=m.start;X<=m.end;X++){var $=n[X];if(V=j[j.length-1],c.set($,(c.get($)||0)+1),$&a&&c.set(a,(c.get(a)||0)+1),$&g)if($&(O|F)){d[X]=V._level;var Z=($===O?q:H)(V._level);Z<=125&&!K&&!W?j.push({_level:Z,_override:0,_isolate:0}):K||W++}else if($&(k|L)){d[X]=V._level;var ee=($===k?q:H)(V._level);ee<=125&&!K&&!W?j.push({_level:ee,_override:$&k?C:x,_isolate:0}):K||W++}else if($&i){$&z&&($=1===zt(X+1,!0)?N:Q),d[X]=V._level,V._override&&u(X,V._override);var te=($===N?q:H)(V._level);te<=125&&0===K&&0===W?(J++,j.push({_level:te,_override:0,_isolate:1,_isolInitIndex:X})):K++}else if($&G){if(K>0)K--;else if(J>0){for(W=0;!j[j.length-1]._isolate;)j.pop();var ne=j[j.length-1]._isolInitIndex;null!=ne&&(f.set(ne,X),f.set(X,ne)),j.pop(),J--}V=j[j.length-1],d[X]=V._level,V._override&&u(X,V._override)}else $&U?(0===K&&(W>0?W--:!V._isolate&&j.length>1&&(j.pop(),V=j[j.length-1])),d[X]=V._level):$&T&&(d[X]=m.level);else d[X]=V._level,V._override&&$!==R&&u(X,V._override)}for(var re=[],ie=null,se=m.start;se<=m.end;se++){var ae=n[se];if(!(ae&o)){var oe=d[se],le=ae&i,ce=ae===G;ie&&oe===ie._level?(ie._end=se,ie._endsWithIsolInit=le):re.push(ie={_start:se,_end:se,_level:oe,_startsWithPDI:ce,_endsWithIsolInit:le})}}for(var he=[],ue=0;ue<re.length;ue++){var de=re[ue];if(!de._startsWithPDI||de._startsWithPDI&&!f.has(de._start)){for(var fe=[ie=de],Ae=void 0;ie&&ie._endsWithIsolInit&&null!=(Ae=f.get(ie._end));)for(var me=ue+1;me<re.length;me++)if(re[me]._start===Ae){fe.push(ie=re[me]);break}for(var pe=[],ge=0;ge<fe.length;ge++)for(var ve=fe[ge],ye=ve._start;ye<=ve._end;ye++)pe.push(ye);for(var Ee=d[pe[0]],xe=m.level,Ce=pe[0]-1;Ce>=0;Ce--)if(!(n[Ce]&o)){xe=d[Ce];break}var we=pe[pe.length-1],Ie=d[we],be=m.level;if(!(n[we]&i))for(var Se=we+1;Se<=m.end;Se++)if(!(n[Se]&o)){be=d[Se];break}he.push({_seqIndices:pe,_sosType:Math.max(xe,Ee)%2?C:x,_eosType:Math.max(be,Ie)%2?C:x})}}for(var Be=0;Be<he.length;Be++){var Te=he[Be],_e=Te._seqIndices,Me=Te._sosType,Re=Te._eosType,De=1&d[_e[0]]?C:x;if(c.get(D))for(var Pe=0;Pe<_e.length;Pe++){var Le=_e[Pe];if(n[Le]&D){for(var ke=Me,Fe=Pe-1;Fe>=0;Fe--)if(!(n[_e[Fe]]&o)){ke=n[_e[Fe]];break}u(Le,ke&(i|G)?M:ke)}}if(c.get(w))for(var Oe=0;Oe<_e.length;Oe++){var Ue=_e[Oe];if(n[Ue]&w)for(var Qe=Oe-1;Qe>=-1;Qe--){var Ne=-1===Qe?Me:n[_e[Qe]];if(Ne&s){Ne===P&&u(Ue,S);break}}}if(c.get(P))for(var ze=0;ze<_e.length;ze++){var Ge=_e[ze];n[Ge]&P&&u(Ge,C)}if(c.get(I)||c.get(B))for(var He=1;He<_e.length-1;He++){var qe=_e[He];if(n[qe]&(I|B)){for(var Ye=0,je=0,Ve=He-1;Ve>=0&&(Ye=n[_e[Ve]])&o;Ve--);for(var Ke=He+1;Ke<_e.length&&(je=n[_e[Ke]])&o;Ke++);Ye===je&&(n[qe]===I?Ye===w:Ye&(w|S))&&u(qe,Ye)}}if(c.get(w))for(var We=0;We<_e.length;We++){var Je=_e[We];if(n[Je]&w){for(var Xe=We-1;Xe>=0&&n[_e[Xe]]&(b|o);Xe--)u(_e[Xe],w);for(We++;We<_e.length&&n[_e[We]]&(b|o|w);We++)n[_e[We]]!==w&&u(_e[We],w)}}if(c.get(b)||c.get(I)||c.get(B))for(var $e=0;$e<_e.length;$e++){var Ze=_e[$e];if(n[Ze]&(b|I|B)){u(Ze,M);for(var et=$e-1;et>=0&&n[_e[et]]&o;et--)u(_e[et],M);for(var tt=$e+1;tt<_e.length&&n[_e[tt]]&o;tt++)u(_e[tt],M)}}if(c.get(w))for(var nt=0,rt=Me;nt<_e.length;nt++){var it=_e[nt],st=n[it];st&w?rt===x&&u(it,x):st&s&&(rt=st)}if(c.get(a)){for(var at=C|w|S,ot=at|x,lt=[],ct=[],ht=0;ht<_e.length;ht++)if(n[_e[ht]]&a){var ut=e[_e[ht]],dt=void 0;if(null!==v(ut)){if(!(ct.length<63))break;ct.push({char:ut,seqIndex:ht})}else if(null!==(dt=y(ut)))for(var ft=ct.length-1;ft>=0;ft--){var At=ct[ft].char;if(At===dt||At===y(E(ut))||v(E(At))===ut){lt.push([ct[ft].seqIndex,ht]),ct.length=ft;break}}}lt.sort((function(e,t){return e[0]-t[0]}));for(var mt=0;mt<lt.length;mt++){for(var pt=lt[mt],gt=pt[0],vt=pt[1],yt=!1,Et=0,xt=gt+1;xt<vt;xt++){var Ct=_e[xt];if(n[Ct]&ot){yt=!0;var wt=n[Ct]&at?C:x;if(wt===De){Et=wt;break}}}if(yt&&!Et){Et=Me;for(var It=gt-1;It>=0;It--){var bt=_e[It];if(n[bt]&ot){var St=n[bt]&at?C:x;Et=St!==De?St:De;break}}}if(Et){if(n[_e[gt]]=n[_e[vt]]=Et,Et!==De)for(var Bt=gt+1;Bt<_e.length;Bt++)if(!(n[_e[Bt]]&o)){h(e[_e[Bt]])&D&&(n[_e[Bt]]=Et);break}if(Et!==De)for(var Tt=vt+1;Tt<_e.length;Tt++)if(!(n[_e[Tt]]&o)){h(e[_e[Tt]])&D&&(n[_e[Tt]]=Et);break}}}for(var _t=0;_t<_e.length;_t++)if(n[_e[_t]]&a){for(var Mt=_t,Rt=_t,Dt=Me,Pt=_t-1;Pt>=0;Pt--){if(!(n[_e[Pt]]&o)){Dt=n[_e[Pt]]&at?C:x;break}Mt=Pt}for(var Lt=Re,kt=_t+1;kt<_e.length;kt++){if(!(n[_e[kt]]&(a|o))){Lt=n[_e[kt]]&at?C:x;break}Rt=kt}for(var Ft=Mt;Ft<=Rt;Ft++)n[_e[Ft]]=Dt===Lt?Dt:De;_t=Rt}}}for(var Ot=m.start;Ot<=m.end;Ot++){var Ut=d[Ot],Qt=n[Ot];if(1&Ut?Qt&(x|w|S)&&d[Ot]++:Qt&C?d[Ot]++:Qt&(S|w)&&(d[Ot]+=2),Qt&o&&(d[Ot]=0===Ot?m.level:d[Ot-1]),Ot===m.end||h(e[Ot])&(_|T))for(var Nt=Ot;Nt>=0&&h(e[Nt])&l;Nt--)d[Nt]=m.level}}return{levels:d,paragraphs:A};function zt(t,r){for(var s=t;s<e.length;s++){var a=n[s];if(a&(C|P))return 1;if(a&(T|x)||r&&a===G)return 0;if(a&i){var o=Gt(s);s=-1===o?e.length:o}}return 0}function Gt(t){for(var r=1,s=t+1;s<e.length;s++){var a=n[s];if(a&T)break;if(a&G){if(0==--r)return s}else a&i&&r++}return-1}},e.getMirroredCharacter=q,e.getMirroredCharactersMap=function(e,t,n,r){var i=e.length;n=Math.max(0,null==n?0:+n),r=Math.min(i-1,null==r?i-1:+r);for(var s=new Map,a=n;a<=r;a++)if(1&t[a]){var o=q(e[a]);null!==o&&s.set(a,o)}return s},e.getReorderSegments=Y,e.getReorderedIndices=j,e.getReorderedString=function(e,t,n,r){var i=j(e,t,n,r),s=[].concat(e);return i.forEach((function(n,r){s[r]=(1&t.levels[n]?q(e[n]):null)||e[n]})),s.join("")},e.openingToClosingBracket=v,Object.defineProperty(e,"__esModule",{value:!0}),e}({});return e},fi=/\bvoid\s+main\s*\(\s*\)\s*{/g;function Ai(e){return e.replace(/^[ \t]*#include +<([\w\d./]+)>/gm,(function(e,t){let n=br.ShaderChunk[t];return n?Ai(n):e}))}const mi=[];for(let WC=0;WC<256;WC++)mi[WC]=(WC<16?"0":"")+WC.toString(16);const pi=Object.assign||function(){let e=arguments[0];for(let t=1,n=arguments.length;t<n;t++){let n=arguments[t];if(n)for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},gi=Date.now(),vi=new WeakMap,yi=new Map;let Ei=1e10;function xi(e,t){const n=function(e){const t=JSON.stringify(e,wi);let n=bi.get(t);null==n&&bi.set(t,n=++Ii);return n}(t);let r=vi.get(e);if(r||vi.set(e,r=Object.create(null)),r[n])return new r[n];const i=`_onBeforeCompile${n}`,s=function(r,s){e.onBeforeCompile.call(this,r,s);const a=this.customProgramCacheKey()+"|"+r.vertexShader+"|"+r.fragmentShader;let o=yi[a];if(!o){const e=function(e,{vertexShader:t,fragmentShader:n},r,i){let{vertexDefs:s,vertexMainIntro:a,vertexMainOutro:o,vertexTransform:l,fragmentDefs:c,fragmentMainIntro:h,fragmentMainOutro:u,fragmentColorTransform:d,customRewriter:f,timeUniform:A}=r;s=s||"",a=a||"",o=o||"",c=c||"",h=h||"",u=u||"",(l||f)&&(t=Ai(t));(d||f)&&(n=Ai(n=n.replace(/^[ \t]*#include <((?:tonemapping|encodings|colorspace|fog|premultiplied_alpha|dithering)_fragment)>/gm,"\n//!BEGIN_POST_CHUNK $1\n$&\n//!END_POST_CHUNK\n")));if(f){let e=f({vertexShader:t,fragmentShader:n});t=e.vertexShader,n=e.fragmentShader}if(d){let e=[];n=n.replace(/^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,(t=>(e.push(t),""))),u=`${d}\n${e.join("\n")}\n${u}`}if(A){const e=`\nuniform float ${A};\n`;s=e+s,c=e+c}l&&(s=`${s}\nvoid troikaVertexTransform${i}(inout vec3 position, inout vec3 normal, inout vec2 uv) {\n  ${l}\n}\n`,a=`\ntroika_position_${i} = vec3(position);\ntroika_normal_${i} = vec3(normal);\ntroika_uv_${i} = vec2(uv);\ntroikaVertexTransform${i}(troika_position_${i}, troika_normal_${i}, troika_uv_${i});\n${a}\n`,t=(t=`vec3 troika_position_${i};\nvec3 troika_normal_${i};\nvec2 troika_uv_${i};\n${t}\n`).replace(/\b(position|normal|uv)\b/g,((e,t,n,r)=>/\battribute\s+vec[23]\s+$/.test(r.substr(0,n))?t:`troika_${t}_${i}`)),e.map&&e.map.channel>0||(t=t.replace(/\bMAP_UV\b/g,`troika_uv_${i}`)));return t=Ci(t,i,s,a,o),n=Ci(n,i,c,h,u),{vertexShader:t,fragmentShader:n}}(this,r,t,n);o=yi[a]=e}r.vertexShader=o.vertexShader,r.fragmentShader=o.fragmentShader,pi(r.uniforms,this.uniforms),t.timeUniform&&(r.uniforms[t.timeUniform]={get value(){return Date.now()-gi}}),this[i]&&this[i](r)},o=function(){return l(t.chained?e:e.clone())},l=function(r){const i=Object.create(r,c);return Object.defineProperty(i,"baseMaterial",{value:e}),Object.defineProperty(i,"id",{value:Ei++}),i.uuid=function(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return(mi[255&e]+mi[e>>8&255]+mi[e>>16&255]+mi[e>>24&255]+"-"+mi[255&t]+mi[t>>8&255]+"-"+mi[t>>16&15|64]+mi[t>>24&255]+"-"+mi[63&n|128]+mi[n>>8&255]+"-"+mi[n>>16&255]+mi[n>>24&255]+mi[255&r]+mi[r>>8&255]+mi[r>>16&255]+mi[r>>24&255]).toUpperCase()}(),i.uniforms=pi({},r.uniforms,t.uniforms),i.defines=pi({},r.defines,t.defines),i.defines[`TROIKA_DERIVED_MATERIAL_${n}`]="",i.extensions=pi({},r.extensions,t.extensions),i._listeners=void 0,i},c={constructor:{value:o},isDerivedMaterial:{value:!0},type:{get:()=>e.type,set:t=>{e.type=t}},isDerivedFrom:{writable:!0,configurable:!0,value:function(e){const t=this.baseMaterial;return e===t||t.isDerivedMaterial&&t.isDerivedFrom(e)||!1}},customProgramCacheKey:{writable:!0,configurable:!0,value:function(){return e.customProgramCacheKey()+"|"+n}},onBeforeCompile:{get:()=>s,set(e){this[i]=e}},copy:{writable:!0,configurable:!0,value:function(t){return e.copy.call(this,t),e.isShaderMaterial||e.isDerivedMaterial||(pi(this.extensions,t.extensions),pi(this.defines,t.defines),pi(this.uniforms,a.LlO.clone(t.uniforms))),this}},clone:{writable:!0,configurable:!0,value:function(){const t=new e.constructor;return l(t).copy(this)}},getDepthMaterial:{writable:!0,configurable:!0,value:function(){let n=this._depthMaterial;return n||(n=this._depthMaterial=xi(e.isDerivedMaterial?e.getDepthMaterial():new a.CSG({depthPacking:a.N5j}),t),n.defines.IS_DEPTH_MATERIAL="",n.uniforms=this.uniforms),n}},getDistanceMaterial:{writable:!0,configurable:!0,value:function(){let n=this._distanceMaterial;return n||(n=this._distanceMaterial=xi(e.isDerivedMaterial?e.getDistanceMaterial():new a.aVO,t),n.defines.IS_DISTANCE_MATERIAL="",n.uniforms=this.uniforms),n}},dispose:{writable:!0,configurable:!0,value(){const{_depthMaterial:t,_distanceMaterial:n}=this;t&&t.dispose(),n&&n.dispose(),e.dispose.call(this)}}};return r[n]=o,new o}function Ci(e,t,n,r,i){return(r||i||n)&&(e=e.replace(fi,`\n${n}\nvoid troikaOrigMain${t}() {`),e+=`\nvoid main() {\n  ${r}\n  troikaOrigMain${t}();\n  ${i}\n}`),e}function wi(e,t){return"uniforms"===e?void 0:"function"==typeof t?t.toString():t}let Ii=0;const bi=new Map;a.$EB;a.eaF;const Si=li({name:"Typr Font Parser",dependencies:[function(){return"undefined"==typeof window&&(self.window=self),function(e){var t={parse:function(e){var n=t._bin,r=new Uint8Array(e);if("ttcf"==n.readASCII(r,0,4)){var i=4;n.readUshort(r,i),i+=2,n.readUshort(r,i),i+=2;var s=n.readUint(r,i);i+=4;for(var a=[],o=0;o<s;o++){var l=n.readUint(r,i);i+=4,a.push(t._readFont(r,l))}return a}return[t._readFont(r,0)]},_readFont:function(e,n){var r=t._bin,i=n;r.readFixed(e,n),n+=4;var s=r.readUshort(e,n);n+=2,r.readUshort(e,n),n+=2,r.readUshort(e,n),n+=2,r.readUshort(e,n),n+=2;for(var a=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],o={_data:e,_offset:i},l={},c=0;c<s;c++){var h=r.readASCII(e,n,4);n+=4,r.readUint(e,n),n+=4;var u=r.readUint(e,n);n+=4;var d=r.readUint(e,n);n+=4,l[h]={offset:u,length:d}}for(c=0;c<a.length;c++){var f=a[c];l[f]&&(o[f.trim()]=t[f.trim()].parse(e,l[f].offset,l[f].length,o))}return o},_tabOffset:function(e,n,r){for(var i=t._bin,s=i.readUshort(e,r+4),a=r+12,o=0;o<s;o++){var l=i.readASCII(e,a,4);a+=4,i.readUint(e,a),a+=4;var c=i.readUint(e,a);if(a+=4,i.readUint(e,a),a+=4,l==n)return c}return 0}};t._bin={readFixed:function(e,t){return(e[t]<<8|e[t+1])+(e[t+2]<<8|e[t+3])/65540},readF2dot14:function(e,n){return t._bin.readShort(e,n)/16384},readInt:function(e,n){return t._bin._view(e).getInt32(n)},readInt8:function(e,n){return t._bin._view(e).getInt8(n)},readShort:function(e,n){return t._bin._view(e).getInt16(n)},readUshort:function(e,n){return t._bin._view(e).getUint16(n)},readUshorts:function(e,n,r){for(var i=[],s=0;s<r;s++)i.push(t._bin.readUshort(e,n+2*s));return i},readUint:function(e,n){return t._bin._view(e).getUint32(n)},readUint64:function(e,n){return 4294967296*t._bin.readUint(e,n)+t._bin.readUint(e,n+4)},readASCII:function(e,t,n){for(var r="",i=0;i<n;i++)r+=String.fromCharCode(e[t+i]);return r},readUnicode:function(e,t,n){for(var r="",i=0;i<n;i++){var s=e[t++]<<8|e[t++];r+=String.fromCharCode(s)}return r},_tdec:"undefined"!=typeof window&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(e,n,r){var i=t._bin._tdec;return i&&0==n&&r==e.length?i.decode(e):t._bin.readASCII(e,n,r)},readBytes:function(e,t,n){for(var r=[],i=0;i<n;i++)r.push(e[t+i]);return r},readASCIIArray:function(e,t,n){for(var r=[],i=0;i<n;i++)r.push(String.fromCharCode(e[t+i]));return r},_view:function(e){return e._dataView||(e._dataView=e.buffer?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(new Uint8Array(e).buffer))}},t._lctf={},t._lctf.parse=function(e,n,r,i,s){var a=t._bin,o={},l=n;a.readFixed(e,n),n+=4;var c=a.readUshort(e,n);n+=2;var h=a.readUshort(e,n);n+=2;var u=a.readUshort(e,n);return n+=2,o.scriptList=t._lctf.readScriptList(e,l+c),o.featureList=t._lctf.readFeatureList(e,l+h),o.lookupList=t._lctf.readLookupList(e,l+u,s),o},t._lctf.readLookupList=function(e,n,r){var i=t._bin,s=n,a=[],o=i.readUshort(e,n);n+=2;for(var l=0;l<o;l++){var c=i.readUshort(e,n);n+=2;var h=t._lctf.readLookupTable(e,s+c,r);a.push(h)}return a},t._lctf.readLookupTable=function(e,n,r){var i=t._bin,s=n,a={tabs:[]};a.ltype=i.readUshort(e,n),n+=2,a.flag=i.readUshort(e,n),n+=2;var o=i.readUshort(e,n);n+=2;for(var l=a.ltype,c=0;c<o;c++){var h=i.readUshort(e,n);n+=2;var u=r(e,l,s+h,a);a.tabs.push(u)}return a},t._lctf.numOfOnes=function(e){for(var t=0,n=0;n<32;n++)e>>>n&1&&t++;return t},t._lctf.readClassDef=function(e,n){var r=t._bin,i=[],s=r.readUshort(e,n);if(n+=2,1==s){var a=r.readUshort(e,n);n+=2;var o=r.readUshort(e,n);n+=2;for(var l=0;l<o;l++)i.push(a+l),i.push(a+l),i.push(r.readUshort(e,n)),n+=2}if(2==s){var c=r.readUshort(e,n);for(n+=2,l=0;l<c;l++)i.push(r.readUshort(e,n)),n+=2,i.push(r.readUshort(e,n)),n+=2,i.push(r.readUshort(e,n)),n+=2}return i},t._lctf.getInterval=function(e,t){for(var n=0;n<e.length;n+=3){var r=e[n],i=e[n+1];if(e[n+2],r<=t&&t<=i)return n}return-1},t._lctf.readCoverage=function(e,n){var r=t._bin,i={};i.fmt=r.readUshort(e,n),n+=2;var s=r.readUshort(e,n);return n+=2,1==i.fmt&&(i.tab=r.readUshorts(e,n,s)),2==i.fmt&&(i.tab=r.readUshorts(e,n,3*s)),i},t._lctf.coverageIndex=function(e,n){var r=e.tab;if(1==e.fmt)return r.indexOf(n);if(2==e.fmt){var i=t._lctf.getInterval(r,n);if(-1!=i)return r[i+2]+(n-r[i])}return-1},t._lctf.readFeatureList=function(e,n){var r=t._bin,i=n,s=[],a=r.readUshort(e,n);n+=2;for(var o=0;o<a;o++){var l=r.readASCII(e,n,4);n+=4;var c=r.readUshort(e,n);n+=2;var h=t._lctf.readFeatureTable(e,i+c);h.tag=l.trim(),s.push(h)}return s},t._lctf.readFeatureTable=function(e,n){var r=t._bin,i=n,s={},a=r.readUshort(e,n);n+=2,a>0&&(s.featureParams=i+a);var o=r.readUshort(e,n);n+=2,s.tab=[];for(var l=0;l<o;l++)s.tab.push(r.readUshort(e,n+2*l));return s},t._lctf.readScriptList=function(e,n){var r=t._bin,i=n,s={},a=r.readUshort(e,n);n+=2;for(var o=0;o<a;o++){var l=r.readASCII(e,n,4);n+=4;var c=r.readUshort(e,n);n+=2,s[l.trim()]=t._lctf.readScriptTable(e,i+c)}return s},t._lctf.readScriptTable=function(e,n){var r=t._bin,i=n,s={},a=r.readUshort(e,n);n+=2,a>0&&(s.default=t._lctf.readLangSysTable(e,i+a));var o=r.readUshort(e,n);n+=2;for(var l=0;l<o;l++){var c=r.readASCII(e,n,4);n+=4;var h=r.readUshort(e,n);n+=2,s[c.trim()]=t._lctf.readLangSysTable(e,i+h)}return s},t._lctf.readLangSysTable=function(e,n){var r=t._bin,i={};r.readUshort(e,n),n+=2,i.reqFeature=r.readUshort(e,n),n+=2;var s=r.readUshort(e,n);return n+=2,i.features=r.readUshorts(e,n,s),i},t.CFF={},t.CFF.parse=function(e,n,r){var i=t._bin;(e=new Uint8Array(e.buffer,n,r))[n=0],e[++n],e[++n],e[++n],n++;var s=[];n=t.CFF.readIndex(e,n,s);for(var a=[],o=0;o<s.length-1;o++)a.push(i.readASCII(e,n+s[o],s[o+1]-s[o]));n+=s[s.length-1];var l=[];n=t.CFF.readIndex(e,n,l);var c=[];for(o=0;o<l.length-1;o++)c.push(t.CFF.readDict(e,n+l[o],n+l[o+1]));n+=l[l.length-1];var h=c[0],u=[];n=t.CFF.readIndex(e,n,u);var d=[];for(o=0;o<u.length-1;o++)d.push(i.readASCII(e,n+u[o],u[o+1]-u[o]));if(n+=u[u.length-1],t.CFF.readSubrs(e,n,h),h.CharStrings){n=h.CharStrings,u=[],n=t.CFF.readIndex(e,n,u);var f=[];for(o=0;o<u.length-1;o++)f.push(i.readBytes(e,n+u[o],u[o+1]-u[o]));h.CharStrings=f}if(h.ROS){n=h.FDArray;var A=[];for(n=t.CFF.readIndex(e,n,A),h.FDArray=[],o=0;o<A.length-1;o++){var m=t.CFF.readDict(e,n+A[o],n+A[o+1]);t.CFF._readFDict(e,m,d),h.FDArray.push(m)}n+=A[A.length-1],n=h.FDSelect,h.FDSelect=[];var p=e[n];if(n++,3!=p)throw p;var g=i.readUshort(e,n);for(n+=2,o=0;o<g+1;o++)h.FDSelect.push(i.readUshort(e,n),e[n+2]),n+=3}return h.Encoding&&(h.Encoding=t.CFF.readEncoding(e,h.Encoding,h.CharStrings.length)),h.charset&&(h.charset=t.CFF.readCharset(e,h.charset,h.CharStrings.length)),t.CFF._readFDict(e,h,d),h},t.CFF._readFDict=function(e,n,r){var i;for(var s in n.Private&&(i=n.Private[1],n.Private=t.CFF.readDict(e,i,i+n.Private[0]),n.Private.Subrs&&t.CFF.readSubrs(e,i+n.Private.Subrs,n.Private)),n)-1!=["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(s)&&(n[s]=r[n[s]-426+35])},t.CFF.readSubrs=function(e,n,r){var i=t._bin,s=[];n=t.CFF.readIndex(e,n,s);var a,o=s.length;a=o<1240?107:o<33900?1131:32768,r.Bias=a,r.Subrs=[];for(var l=0;l<s.length-1;l++)r.Subrs.push(i.readBytes(e,n+s[l],s[l+1]-s[l]))},t.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],t.CFF.glyphByUnicode=function(e,t){for(var n=0;n<e.charset.length;n++)if(e.charset[n]==t)return n;return-1},t.CFF.glyphBySE=function(e,n){return n<0||n>255?-1:t.CFF.glyphByUnicode(e,t.CFF.tableSE[n])},t.CFF.readEncoding=function(e,n,r){t._bin;var i=[".notdef"],s=e[n];if(n++,0!=s)throw"error: unknown encoding format: "+s;var a=e[n];n++;for(var o=0;o<a;o++)i.push(e[n+o]);return i},t.CFF.readCharset=function(e,n,r){var i=t._bin,s=[".notdef"],a=e[n];if(n++,0==a)for(var o=0;o<r;o++){var l=i.readUshort(e,n);n+=2,s.push(l)}else{if(1!=a&&2!=a)throw"error: format: "+a;for(;s.length<r;){l=i.readUshort(e,n),n+=2;var c=0;for(1==a?(c=e[n],n++):(c=i.readUshort(e,n),n+=2),o=0;o<=c;o++)s.push(l),l++}}return s},t.CFF.readIndex=function(e,n,r){var i=t._bin,s=i.readUshort(e,n)+1,a=e[n+=2];if(n++,1==a)for(var o=0;o<s;o++)r.push(e[n+o]);else if(2==a)for(o=0;o<s;o++)r.push(i.readUshort(e,n+2*o));else if(3==a)for(o=0;o<s;o++)r.push(16777215&i.readUint(e,n+3*o-1));else if(1!=s)throw"unsupported offset size: "+a+", count: "+s;return(n+=s*a)-1},t.CFF.getCharString=function(e,n,r){var i=t._bin,s=e[n],a=e[n+1];e[n+2],e[n+3],e[n+4];var o=1,l=null,c=null;s<=20&&(l=s,o=1),12==s&&(l=100*s+a,o=2),21<=s&&s<=27&&(l=s,o=1),28==s&&(c=i.readShort(e,n+1),o=3),29<=s&&s<=31&&(l=s,o=1),32<=s&&s<=246&&(c=s-139,o=1),247<=s&&s<=250&&(c=256*(s-247)+a+108,o=2),251<=s&&s<=254&&(c=256*-(s-251)-a-108,o=2),255==s&&(c=i.readInt(e,n+1)/65535,o=5),r.val=null!=c?c:"o"+l,r.size=o},t.CFF.readCharString=function(e,n,r){for(var i=n+r,s=t._bin,a=[];n<i;){var o=e[n],l=e[n+1];e[n+2],e[n+3],e[n+4];var c=1,h=null,u=null;o<=20&&(h=o,c=1),12==o&&(h=100*o+l,c=2),19!=o&&20!=o||(h=o,c=2),21<=o&&o<=27&&(h=o,c=1),28==o&&(u=s.readShort(e,n+1),c=3),29<=o&&o<=31&&(h=o,c=1),32<=o&&o<=246&&(u=o-139,c=1),247<=o&&o<=250&&(u=256*(o-247)+l+108,c=2),251<=o&&o<=254&&(u=256*-(o-251)-l-108,c=2),255==o&&(u=s.readInt(e,n+1)/65535,c=5),a.push(null!=u?u:"o"+h),n+=c}return a},t.CFF.readDict=function(e,n,r){for(var i=t._bin,s={},a=[];n<r;){var o=e[n],l=e[n+1];e[n+2],e[n+3],e[n+4];var c=1,h=null,u=null;if(28==o&&(u=i.readShort(e,n+1),c=3),29==o&&(u=i.readInt(e,n+1),c=5),32<=o&&o<=246&&(u=o-139,c=1),247<=o&&o<=250&&(u=256*(o-247)+l+108,c=2),251<=o&&o<=254&&(u=256*-(o-251)-l-108,c=2),255==o)throw u=i.readInt(e,n+1)/65535,c=5,"unknown number";if(30==o){var d=[];for(c=1;;){var f=e[n+c];c++;var A=f>>4,m=15&f;if(15!=A&&d.push(A),15!=m&&d.push(m),15==m)break}for(var p="",g=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],v=0;v<d.length;v++)p+=g[d[v]];u=parseFloat(p)}o<=21&&(h=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][o],c=1,12==o&&(h=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][l],c=2)),null!=h?(s[h]=1==a.length?a[0]:a,a=[]):a.push(u),n+=c}return s},t.cmap={},t.cmap.parse=function(e,n,r){e=new Uint8Array(e.buffer,n,r),n=0;var i=t._bin,s={};i.readUshort(e,n),n+=2;var a=i.readUshort(e,n);n+=2;var o=[];s.tables=[];for(var l=0;l<a;l++){var c=i.readUshort(e,n);n+=2;var h=i.readUshort(e,n);n+=2;var u=i.readUint(e,n);n+=4;var d="p"+c+"e"+h,f=o.indexOf(u);if(-1==f){var A;f=s.tables.length,o.push(u);var m=i.readUshort(e,u);0==m?A=t.cmap.parse0(e,u):4==m?A=t.cmap.parse4(e,u):6==m?A=t.cmap.parse6(e,u):12==m?A=t.cmap.parse12(e,u):console.debug("unknown format: "+m,c,h,u),s.tables.push(A)}if(null!=s[d])throw"multiple tables for one platform+encoding";s[d]=f}return s},t.cmap.parse0=function(e,n){var r=t._bin,i={};i.format=r.readUshort(e,n),n+=2;var s=r.readUshort(e,n);n+=2,r.readUshort(e,n),n+=2,i.map=[];for(var a=0;a<s-6;a++)i.map.push(e[n+a]);return i},t.cmap.parse4=function(e,n){var r=t._bin,i=n,s={};s.format=r.readUshort(e,n),n+=2;var a=r.readUshort(e,n);n+=2,r.readUshort(e,n),n+=2;var o=r.readUshort(e,n);n+=2;var l=o/2;s.searchRange=r.readUshort(e,n),n+=2,s.entrySelector=r.readUshort(e,n),n+=2,s.rangeShift=r.readUshort(e,n),n+=2,s.endCount=r.readUshorts(e,n,l),n+=2*l,n+=2,s.startCount=r.readUshorts(e,n,l),n+=2*l,s.idDelta=[];for(var c=0;c<l;c++)s.idDelta.push(r.readShort(e,n)),n+=2;for(s.idRangeOffset=r.readUshorts(e,n,l),n+=2*l,s.glyphIdArray=[];n<i+a;)s.glyphIdArray.push(r.readUshort(e,n)),n+=2;return s},t.cmap.parse6=function(e,n){var r=t._bin,i={};i.format=r.readUshort(e,n),n+=2,r.readUshort(e,n),n+=2,r.readUshort(e,n),n+=2,i.firstCode=r.readUshort(e,n),n+=2;var s=r.readUshort(e,n);n+=2,i.glyphIdArray=[];for(var a=0;a<s;a++)i.glyphIdArray.push(r.readUshort(e,n)),n+=2;return i},t.cmap.parse12=function(e,n){var r=t._bin,i={};i.format=r.readUshort(e,n),n+=2,n+=2,r.readUint(e,n),n+=4,r.readUint(e,n),n+=4;var s=r.readUint(e,n);n+=4,i.groups=[];for(var a=0;a<s;a++){var o=n+12*a,l=r.readUint(e,o+0),c=r.readUint(e,o+4),h=r.readUint(e,o+8);i.groups.push([l,c,h])}return i},t.glyf={},t.glyf.parse=function(e,t,n,r){for(var i=[],s=0;s<r.maxp.numGlyphs;s++)i.push(null);return i},t.glyf._parseGlyf=function(e,n){var r=t._bin,i=e._data,s=t._tabOffset(i,"glyf",e._offset)+e.loca[n];if(e.loca[n]==e.loca[n+1])return null;var a={};if(a.noc=r.readShort(i,s),s+=2,a.xMin=r.readShort(i,s),s+=2,a.yMin=r.readShort(i,s),s+=2,a.xMax=r.readShort(i,s),s+=2,a.yMax=r.readShort(i,s),s+=2,a.xMin>=a.xMax||a.yMin>=a.yMax)return null;if(a.noc>0){a.endPts=[];for(var o=0;o<a.noc;o++)a.endPts.push(r.readUshort(i,s)),s+=2;var l=r.readUshort(i,s);if(s+=2,i.length-s<l)return null;a.instructions=r.readBytes(i,s,l),s+=l;var c=a.endPts[a.noc-1]+1;for(a.flags=[],o=0;o<c;o++){var h=i[s];if(s++,a.flags.push(h),8&h){var u=i[s];s++;for(var d=0;d<u;d++)a.flags.push(h),o++}}for(a.xs=[],o=0;o<c;o++){var f=!!(2&a.flags[o]),A=!!(16&a.flags[o]);f?(a.xs.push(A?i[s]:-i[s]),s++):A?a.xs.push(0):(a.xs.push(r.readShort(i,s)),s+=2)}for(a.ys=[],o=0;o<c;o++)f=!!(4&a.flags[o]),A=!!(32&a.flags[o]),f?(a.ys.push(A?i[s]:-i[s]),s++):A?a.ys.push(0):(a.ys.push(r.readShort(i,s)),s+=2);var m=0,p=0;for(o=0;o<c;o++)m+=a.xs[o],p+=a.ys[o],a.xs[o]=m,a.ys[o]=p}else{var g;a.parts=[];do{g=r.readUshort(i,s),s+=2;var v={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(a.parts.push(v),v.glyphIndex=r.readUshort(i,s),s+=2,1&g){var y=r.readShort(i,s);s+=2;var E=r.readShort(i,s);s+=2}else y=r.readInt8(i,s),s++,E=r.readInt8(i,s),s++;2&g?(v.m.tx=y,v.m.ty=E):(v.p1=y,v.p2=E),8&g?(v.m.a=v.m.d=r.readF2dot14(i,s),s+=2):64&g?(v.m.a=r.readF2dot14(i,s),s+=2,v.m.d=r.readF2dot14(i,s),s+=2):128&g&&(v.m.a=r.readF2dot14(i,s),s+=2,v.m.b=r.readF2dot14(i,s),s+=2,v.m.c=r.readF2dot14(i,s),s+=2,v.m.d=r.readF2dot14(i,s),s+=2)}while(32&g);if(256&g){var x=r.readUshort(i,s);for(s+=2,a.instr=[],o=0;o<x;o++)a.instr.push(i[s]),s++}}return a},t.GDEF={},t.GDEF.parse=function(e,n,r,i){var s=n;n+=4;var a=t._bin.readUshort(e,n);return{glyphClassDef:0===a?null:t._lctf.readClassDef(e,s+a)}},t.GPOS={},t.GPOS.parse=function(e,n,r,i){return t._lctf.parse(e,n,r,i,t.GPOS.subt)},t.GPOS.subt=function(e,n,r,i){var s=t._bin,a=r,o={};if(o.fmt=s.readUshort(e,r),r+=2,1==n||2==n||3==n||7==n||8==n&&o.fmt<=2){var l=s.readUshort(e,r);r+=2,o.coverage=t._lctf.readCoverage(e,l+a)}if(1==n&&1==o.fmt){var c=s.readUshort(e,r);r+=2,0!=c&&(o.pos=t.GPOS.readValueRecord(e,r,c))}else if(2==n&&o.fmt>=1&&o.fmt<=2){c=s.readUshort(e,r),r+=2;var h=s.readUshort(e,r);r+=2;var u=t._lctf.numOfOnes(c),d=t._lctf.numOfOnes(h);if(1==o.fmt){o.pairsets=[];var f=s.readUshort(e,r);r+=2;for(var A=0;A<f;A++){var m=a+s.readUshort(e,r);r+=2;var p=s.readUshort(e,m);m+=2;for(var g=[],v=0;v<p;v++){var y=s.readUshort(e,m);m+=2,0!=c&&(b=t.GPOS.readValueRecord(e,m,c),m+=2*u),0!=h&&(S=t.GPOS.readValueRecord(e,m,h),m+=2*d),g.push({gid2:y,val1:b,val2:S})}o.pairsets.push(g)}}if(2==o.fmt){var E=s.readUshort(e,r);r+=2;var x=s.readUshort(e,r);r+=2;var C=s.readUshort(e,r);r+=2;var w=s.readUshort(e,r);for(r+=2,o.classDef1=t._lctf.readClassDef(e,a+E),o.classDef2=t._lctf.readClassDef(e,a+x),o.matrix=[],A=0;A<C;A++){var I=[];for(v=0;v<w;v++){var b=null,S=null;0!=c&&(b=t.GPOS.readValueRecord(e,r,c),r+=2*u),0!=h&&(S=t.GPOS.readValueRecord(e,r,h),r+=2*d),I.push({val1:b,val2:S})}o.matrix.push(I)}}}else if(4==n&&1==o.fmt)o.markCoverage=t._lctf.readCoverage(e,s.readUshort(e,r)+a),o.baseCoverage=t._lctf.readCoverage(e,s.readUshort(e,r+2)+a),o.markClassCount=s.readUshort(e,r+4),o.markArray=t.GPOS.readMarkArray(e,s.readUshort(e,r+6)+a),o.baseArray=t.GPOS.readBaseArray(e,s.readUshort(e,r+8)+a,o.markClassCount);else if(6==n&&1==o.fmt)o.mark1Coverage=t._lctf.readCoverage(e,s.readUshort(e,r)+a),o.mark2Coverage=t._lctf.readCoverage(e,s.readUshort(e,r+2)+a),o.markClassCount=s.readUshort(e,r+4),o.mark1Array=t.GPOS.readMarkArray(e,s.readUshort(e,r+6)+a),o.mark2Array=t.GPOS.readBaseArray(e,s.readUshort(e,r+8)+a,o.markClassCount);else{if(9==n&&1==o.fmt){var B=s.readUshort(e,r);r+=2;var T=s.readUint(e,r);if(r+=4,9==i.ltype)i.ltype=B;else if(i.ltype!=B)throw"invalid extension substitution";return t.GPOS.subt(e,i.ltype,a+T)}console.debug("unsupported GPOS table LookupType",n,"format",o.fmt)}return o},t.GPOS.readValueRecord=function(e,n,r){var i=t._bin,s=[];return s.push(1&r?i.readShort(e,n):0),n+=1&r?2:0,s.push(2&r?i.readShort(e,n):0),n+=2&r?2:0,s.push(4&r?i.readShort(e,n):0),n+=4&r?2:0,s.push(8&r?i.readShort(e,n):0),n+=8&r?2:0,s},t.GPOS.readBaseArray=function(e,n,r){var i=t._bin,s=[],a=n,o=i.readUshort(e,n);n+=2;for(var l=0;l<o;l++){for(var c=[],h=0;h<r;h++)c.push(t.GPOS.readAnchorRecord(e,a+i.readUshort(e,n))),n+=2;s.push(c)}return s},t.GPOS.readMarkArray=function(e,n){var r=t._bin,i=[],s=n,a=r.readUshort(e,n);n+=2;for(var o=0;o<a;o++){var l=t.GPOS.readAnchorRecord(e,r.readUshort(e,n+2)+s);l.markClass=r.readUshort(e,n),i.push(l),n+=4}return i},t.GPOS.readAnchorRecord=function(e,n){var r=t._bin,i={};return i.fmt=r.readUshort(e,n),i.x=r.readShort(e,n+2),i.y=r.readShort(e,n+4),i},t.GSUB={},t.GSUB.parse=function(e,n,r,i){return t._lctf.parse(e,n,r,i,t.GSUB.subt)},t.GSUB.subt=function(e,n,r,i){var s=t._bin,a=r,o={};if(o.fmt=s.readUshort(e,r),r+=2,1!=n&&2!=n&&4!=n&&5!=n&&6!=n)return null;if(1==n||2==n||4==n||5==n&&o.fmt<=2||6==n&&o.fmt<=2){var l=s.readUshort(e,r);r+=2,o.coverage=t._lctf.readCoverage(e,a+l)}if(1==n&&o.fmt>=1&&o.fmt<=2){if(1==o.fmt)o.delta=s.readShort(e,r),r+=2;else if(2==o.fmt){var c=s.readUshort(e,r);r+=2,o.newg=s.readUshorts(e,r,c),r+=2*o.newg.length}}else if(2==n&&1==o.fmt){c=s.readUshort(e,r),r+=2,o.seqs=[];for(var h=0;h<c;h++){var u=s.readUshort(e,r)+a;r+=2;var d=s.readUshort(e,u);o.seqs.push(s.readUshorts(e,u+2,d))}}else if(4==n)for(o.vals=[],c=s.readUshort(e,r),r+=2,h=0;h<c;h++){var f=s.readUshort(e,r);r+=2,o.vals.push(t.GSUB.readLigatureSet(e,a+f))}else if(5==n&&2==o.fmt){if(2==o.fmt){var A=s.readUshort(e,r);r+=2,o.cDef=t._lctf.readClassDef(e,a+A),o.scset=[];var m=s.readUshort(e,r);for(r+=2,h=0;h<m;h++){var p=s.readUshort(e,r);r+=2,o.scset.push(0==p?null:t.GSUB.readSubClassSet(e,a+p))}}}else if(6==n&&3==o.fmt){if(3==o.fmt){for(h=0;h<3;h++){c=s.readUshort(e,r),r+=2;for(var g=[],v=0;v<c;v++)g.push(t._lctf.readCoverage(e,a+s.readUshort(e,r+2*v)));r+=2*c,0==h&&(o.backCvg=g),1==h&&(o.inptCvg=g),2==h&&(o.ahedCvg=g)}c=s.readUshort(e,r),r+=2,o.lookupRec=t.GSUB.readSubstLookupRecords(e,r,c)}}else{if(7==n&&1==o.fmt){var y=s.readUshort(e,r);r+=2;var E=s.readUint(e,r);if(r+=4,9==i.ltype)i.ltype=y;else if(i.ltype!=y)throw"invalid extension substitution";return t.GSUB.subt(e,i.ltype,a+E)}console.debug("unsupported GSUB table LookupType",n,"format",o.fmt)}return o},t.GSUB.readSubClassSet=function(e,n){var r=t._bin.readUshort,i=n,s=[],a=r(e,n);n+=2;for(var o=0;o<a;o++){var l=r(e,n);n+=2,s.push(t.GSUB.readSubClassRule(e,i+l))}return s},t.GSUB.readSubClassRule=function(e,n){var r=t._bin.readUshort,i={},s=r(e,n),a=r(e,n+=2);n+=2,i.input=[];for(var o=0;o<s-1;o++)i.input.push(r(e,n)),n+=2;return i.substLookupRecords=t.GSUB.readSubstLookupRecords(e,n,a),i},t.GSUB.readSubstLookupRecords=function(e,n,r){for(var i=t._bin.readUshort,s=[],a=0;a<r;a++)s.push(i(e,n),i(e,n+2)),n+=4;return s},t.GSUB.readChainSubClassSet=function(e,n){var r=t._bin,i=n,s=[],a=r.readUshort(e,n);n+=2;for(var o=0;o<a;o++){var l=r.readUshort(e,n);n+=2,s.push(t.GSUB.readChainSubClassRule(e,i+l))}return s},t.GSUB.readChainSubClassRule=function(e,n){for(var r=t._bin,i={},s=["backtrack","input","lookahead"],a=0;a<s.length;a++){var o=r.readUshort(e,n);n+=2,1==a&&o--,i[s[a]]=r.readUshorts(e,n,o),n+=2*i[s[a]].length}return o=r.readUshort(e,n),n+=2,i.subst=r.readUshorts(e,n,2*o),n+=2*i.subst.length,i},t.GSUB.readLigatureSet=function(e,n){var r=t._bin,i=n,s=[],a=r.readUshort(e,n);n+=2;for(var o=0;o<a;o++){var l=r.readUshort(e,n);n+=2,s.push(t.GSUB.readLigature(e,i+l))}return s},t.GSUB.readLigature=function(e,n){var r=t._bin,i={chain:[]};i.nglyph=r.readUshort(e,n),n+=2;var s=r.readUshort(e,n);n+=2;for(var a=0;a<s-1;a++)i.chain.push(r.readUshort(e,n)),n+=2;return i},t.head={},t.head.parse=function(e,n,r){var i=t._bin,s={};return i.readFixed(e,n),n+=4,s.fontRevision=i.readFixed(e,n),n+=4,i.readUint(e,n),n+=4,i.readUint(e,n),n+=4,s.flags=i.readUshort(e,n),n+=2,s.unitsPerEm=i.readUshort(e,n),n+=2,s.created=i.readUint64(e,n),n+=8,s.modified=i.readUint64(e,n),n+=8,s.xMin=i.readShort(e,n),n+=2,s.yMin=i.readShort(e,n),n+=2,s.xMax=i.readShort(e,n),n+=2,s.yMax=i.readShort(e,n),n+=2,s.macStyle=i.readUshort(e,n),n+=2,s.lowestRecPPEM=i.readUshort(e,n),n+=2,s.fontDirectionHint=i.readShort(e,n),n+=2,s.indexToLocFormat=i.readShort(e,n),n+=2,s.glyphDataFormat=i.readShort(e,n),n+=2,s},t.hhea={},t.hhea.parse=function(e,n,r){var i=t._bin,s={};return i.readFixed(e,n),n+=4,s.ascender=i.readShort(e,n),n+=2,s.descender=i.readShort(e,n),n+=2,s.lineGap=i.readShort(e,n),n+=2,s.advanceWidthMax=i.readUshort(e,n),n+=2,s.minLeftSideBearing=i.readShort(e,n),n+=2,s.minRightSideBearing=i.readShort(e,n),n+=2,s.xMaxExtent=i.readShort(e,n),n+=2,s.caretSlopeRise=i.readShort(e,n),n+=2,s.caretSlopeRun=i.readShort(e,n),n+=2,s.caretOffset=i.readShort(e,n),n+=2,n+=8,s.metricDataFormat=i.readShort(e,n),n+=2,s.numberOfHMetrics=i.readUshort(e,n),n+=2,s},t.hmtx={},t.hmtx.parse=function(e,n,r,i){for(var s=t._bin,a={aWidth:[],lsBearing:[]},o=0,l=0,c=0;c<i.maxp.numGlyphs;c++)c<i.hhea.numberOfHMetrics&&(o=s.readUshort(e,n),n+=2,l=s.readShort(e,n),n+=2),a.aWidth.push(o),a.lsBearing.push(l);return a},t.kern={},t.kern.parse=function(e,n,r,i){var s=t._bin,a=s.readUshort(e,n);if(n+=2,1==a)return t.kern.parseV1(e,n-2,r,i);var o=s.readUshort(e,n);n+=2;for(var l={glyph1:[],rval:[]},c=0;c<o;c++){n+=2,r=s.readUshort(e,n),n+=2;var h=s.readUshort(e,n);n+=2;var u=h>>>8;if(0!=(u&=15))throw"unknown kern table format: "+u;n=t.kern.readFormat0(e,n,l)}return l},t.kern.parseV1=function(e,n,r,i){var s=t._bin;s.readFixed(e,n),n+=4;var a=s.readUint(e,n);n+=4;for(var o={glyph1:[],rval:[]},l=0;l<a;l++){s.readUint(e,n),n+=4;var c=s.readUshort(e,n);n+=2,s.readUshort(e,n),n+=2;var h=c>>>8;if(0!=(h&=15))throw"unknown kern table format: "+h;n=t.kern.readFormat0(e,n,o)}return o},t.kern.readFormat0=function(e,n,r){var i=t._bin,s=-1,a=i.readUshort(e,n);n+=2,i.readUshort(e,n),n+=2,i.readUshort(e,n),n+=2,i.readUshort(e,n),n+=2;for(var o=0;o<a;o++){var l=i.readUshort(e,n);n+=2;var c=i.readUshort(e,n);n+=2;var h=i.readShort(e,n);n+=2,l!=s&&(r.glyph1.push(l),r.rval.push({glyph2:[],vals:[]}));var u=r.rval[r.rval.length-1];u.glyph2.push(c),u.vals.push(h),s=l}return n},t.loca={},t.loca.parse=function(e,n,r,i){var s=t._bin,a=[],o=i.head.indexToLocFormat,l=i.maxp.numGlyphs+1;if(0==o)for(var c=0;c<l;c++)a.push(s.readUshort(e,n+(c<<1))<<1);if(1==o)for(c=0;c<l;c++)a.push(s.readUint(e,n+(c<<2)));return a},t.maxp={},t.maxp.parse=function(e,n,r){var i=t._bin,s={},a=i.readUint(e,n);return n+=4,s.numGlyphs=i.readUshort(e,n),n+=2,65536==a&&(s.maxPoints=i.readUshort(e,n),n+=2,s.maxContours=i.readUshort(e,n),n+=2,s.maxCompositePoints=i.readUshort(e,n),n+=2,s.maxCompositeContours=i.readUshort(e,n),n+=2,s.maxZones=i.readUshort(e,n),n+=2,s.maxTwilightPoints=i.readUshort(e,n),n+=2,s.maxStorage=i.readUshort(e,n),n+=2,s.maxFunctionDefs=i.readUshort(e,n),n+=2,s.maxInstructionDefs=i.readUshort(e,n),n+=2,s.maxStackElements=i.readUshort(e,n),n+=2,s.maxSizeOfInstructions=i.readUshort(e,n),n+=2,s.maxComponentElements=i.readUshort(e,n),n+=2,s.maxComponentDepth=i.readUshort(e,n),n+=2),s},t.name={},t.name.parse=function(e,n,r){var i=t._bin,s={};i.readUshort(e,n),n+=2;var a=i.readUshort(e,n);n+=2,i.readUshort(e,n);for(var o,l=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],c=n+=2,h=0;h<a;h++){var u=i.readUshort(e,n);n+=2;var d=i.readUshort(e,n);n+=2;var f=i.readUshort(e,n);n+=2;var A=i.readUshort(e,n);n+=2;var m=i.readUshort(e,n);n+=2;var p=i.readUshort(e,n);n+=2;var g,v=l[A],y=c+12*a+p;if(0==u)g=i.readUnicode(e,y,m/2);else if(3==u&&0==d)g=i.readUnicode(e,y,m/2);else if(0==d)g=i.readASCII(e,y,m);else if(1==d)g=i.readUnicode(e,y,m/2);else if(3==d)g=i.readUnicode(e,y,m/2);else{if(1!=u)throw"unknown encoding "+d+", platformID: "+u;g=i.readASCII(e,y,m),console.debug("reading unknown MAC encoding "+d+" as ASCII")}var E="p"+u+","+f.toString(16);null==s[E]&&(s[E]={}),s[E][void 0!==v?v:A]=g,s[E]._lang=f}for(var x in s)if(null!=s[x].postScriptName&&1033==s[x]._lang)return s[x];for(var x in s)if(null!=s[x].postScriptName&&0==s[x]._lang)return s[x];for(var x in s)if(null!=s[x].postScriptName&&3084==s[x]._lang)return s[x];for(var x in s)if(null!=s[x].postScriptName)return s[x];for(var x in s){o=x;break}return console.debug("returning name table with languageID "+s[o]._lang),s[o]},t["OS/2"]={},t["OS/2"].parse=function(e,n,r){var i=t._bin.readUshort(e,n);n+=2;var s={};if(0==i)t["OS/2"].version0(e,n,s);else if(1==i)t["OS/2"].version1(e,n,s);else if(2==i||3==i||4==i)t["OS/2"].version2(e,n,s);else{if(5!=i)throw"unknown OS/2 table version: "+i;t["OS/2"].version5(e,n,s)}return s},t["OS/2"].version0=function(e,n,r){var i=t._bin;return r.xAvgCharWidth=i.readShort(e,n),n+=2,r.usWeightClass=i.readUshort(e,n),n+=2,r.usWidthClass=i.readUshort(e,n),n+=2,r.fsType=i.readUshort(e,n),n+=2,r.ySubscriptXSize=i.readShort(e,n),n+=2,r.ySubscriptYSize=i.readShort(e,n),n+=2,r.ySubscriptXOffset=i.readShort(e,n),n+=2,r.ySubscriptYOffset=i.readShort(e,n),n+=2,r.ySuperscriptXSize=i.readShort(e,n),n+=2,r.ySuperscriptYSize=i.readShort(e,n),n+=2,r.ySuperscriptXOffset=i.readShort(e,n),n+=2,r.ySuperscriptYOffset=i.readShort(e,n),n+=2,r.yStrikeoutSize=i.readShort(e,n),n+=2,r.yStrikeoutPosition=i.readShort(e,n),n+=2,r.sFamilyClass=i.readShort(e,n),n+=2,r.panose=i.readBytes(e,n,10),n+=10,r.ulUnicodeRange1=i.readUint(e,n),n+=4,r.ulUnicodeRange2=i.readUint(e,n),n+=4,r.ulUnicodeRange3=i.readUint(e,n),n+=4,r.ulUnicodeRange4=i.readUint(e,n),n+=4,r.achVendID=[i.readInt8(e,n),i.readInt8(e,n+1),i.readInt8(e,n+2),i.readInt8(e,n+3)],n+=4,r.fsSelection=i.readUshort(e,n),n+=2,r.usFirstCharIndex=i.readUshort(e,n),n+=2,r.usLastCharIndex=i.readUshort(e,n),n+=2,r.sTypoAscender=i.readShort(e,n),n+=2,r.sTypoDescender=i.readShort(e,n),n+=2,r.sTypoLineGap=i.readShort(e,n),n+=2,r.usWinAscent=i.readUshort(e,n),n+=2,r.usWinDescent=i.readUshort(e,n),n+2},t["OS/2"].version1=function(e,n,r){var i=t._bin;return n=t["OS/2"].version0(e,n,r),r.ulCodePageRange1=i.readUint(e,n),n+=4,r.ulCodePageRange2=i.readUint(e,n),n+4},t["OS/2"].version2=function(e,n,r){var i=t._bin;return n=t["OS/2"].version1(e,n,r),r.sxHeight=i.readShort(e,n),n+=2,r.sCapHeight=i.readShort(e,n),n+=2,r.usDefault=i.readUshort(e,n),n+=2,r.usBreak=i.readUshort(e,n),n+=2,r.usMaxContext=i.readUshort(e,n),n+2},t["OS/2"].version5=function(e,n,r){var i=t._bin;return n=t["OS/2"].version2(e,n,r),r.usLowerOpticalPointSize=i.readUshort(e,n),n+=2,r.usUpperOpticalPointSize=i.readUshort(e,n),n+2},t.post={},t.post.parse=function(e,n,r){var i=t._bin,s={};return s.version=i.readFixed(e,n),n+=4,s.italicAngle=i.readFixed(e,n),n+=4,s.underlinePosition=i.readShort(e,n),n+=2,s.underlineThickness=i.readShort(e,n),n+=2,s},null==t&&(t={}),null==t.U&&(t.U={}),t.U.codeToGlyph=function(e,t){var n=e.cmap,r=-1;if(null!=n.p0e4?r=n.p0e4:null!=n.p3e1?r=n.p3e1:null!=n.p1e0?r=n.p1e0:null!=n.p0e3&&(r=n.p0e3),-1==r)throw"no familiar platform and encoding!";var i=n.tables[r];if(0==i.format)return t>=i.map.length?0:i.map[t];if(4==i.format){for(var s=-1,a=0;a<i.endCount.length;a++)if(t<=i.endCount[a]){s=a;break}return-1==s||i.startCount[s]>t?0:65535&(0!=i.idRangeOffset[s]?i.glyphIdArray[t-i.startCount[s]+(i.idRangeOffset[s]>>1)-(i.idRangeOffset.length-s)]:t+i.idDelta[s])}if(12==i.format){if(t>i.groups[i.groups.length-1][1])return 0;for(a=0;a<i.groups.length;a++){var o=i.groups[a];if(o[0]<=t&&t<=o[1])return o[2]+(t-o[0])}return 0}throw"unknown cmap table format "+i.format},t.U.glyphToPath=function(e,n){var r={cmds:[],crds:[]};if(e.SVG&&e.SVG.entries[n]){var i=e.SVG.entries[n];return null==i?r:("string"==typeof i&&(i=t.SVG.toPath(i),e.SVG.entries[n]=i),i)}if(e.CFF){var s={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:e.CFF.Private?e.CFF.Private.defaultWidthX:0,open:!1},a=e.CFF,o=e.CFF.Private;if(a.ROS){for(var l=0;a.FDSelect[l+2]<=n;)l+=2;o=a.FDArray[a.FDSelect[l+1]].Private}t.U._drawCFF(e.CFF.CharStrings[n],s,a,o,r)}else e.glyf&&t.U._drawGlyf(n,e,r);return r},t.U._drawGlyf=function(e,n,r){var i=n.glyf[e];null==i&&(i=n.glyf[e]=t.glyf._parseGlyf(n,e)),null!=i&&(i.noc>-1?t.U._simpleGlyph(i,r):t.U._compoGlyph(i,n,r))},t.U._simpleGlyph=function(e,n){for(var r=0;r<e.noc;r++){for(var i=0==r?0:e.endPts[r-1]+1,s=e.endPts[r],a=i;a<=s;a++){var o=a==i?s:a-1,l=a==s?i:a+1,c=1&e.flags[a],h=1&e.flags[o],u=1&e.flags[l],d=e.xs[a],f=e.ys[a];if(a==i)if(c){if(!h){t.U.P.moveTo(n,d,f);continue}t.U.P.moveTo(n,e.xs[o],e.ys[o])}else h?t.U.P.moveTo(n,e.xs[o],e.ys[o]):t.U.P.moveTo(n,(e.xs[o]+d)/2,(e.ys[o]+f)/2);c?h&&t.U.P.lineTo(n,d,f):u?t.U.P.qcurveTo(n,d,f,e.xs[l],e.ys[l]):t.U.P.qcurveTo(n,d,f,(d+e.xs[l])/2,(f+e.ys[l])/2)}t.U.P.closePath(n)}},t.U._compoGlyph=function(e,n,r){for(var i=0;i<e.parts.length;i++){var s={cmds:[],crds:[]},a=e.parts[i];t.U._drawGlyf(a.glyphIndex,n,s);for(var o=a.m,l=0;l<s.crds.length;l+=2){var c=s.crds[l],h=s.crds[l+1];r.crds.push(c*o.a+h*o.b+o.tx),r.crds.push(c*o.c+h*o.d+o.ty)}for(l=0;l<s.cmds.length;l++)r.cmds.push(s.cmds[l])}},t.U._getGlyphClass=function(e,n){var r=t._lctf.getInterval(n,e);return-1==r?0:n[r+2]},t.U._applySubs=function(e,n,r,i){for(var s=e.length-n-1,a=0;a<r.tabs.length;a++)if(null!=r.tabs[a]){var o,l=r.tabs[a];if(!l.coverage||-1!=(o=t._lctf.coverageIndex(l.coverage,e[n])))if(1==r.ltype)e[n],1==l.fmt?e[n]=e[n]+l.delta:e[n]=l.newg[o];else if(4==r.ltype)for(var c=l.vals[o],h=0;h<c.length;h++){var u=c[h],d=u.chain.length;if(!(d>s)){for(var f=!0,A=0,m=0;m<d;m++){for(;-1==e[n+A+(1+m)];)A++;u.chain[m]!=e[n+A+(1+m)]&&(f=!1)}if(f){for(e[n]=u.nglyph,m=0;m<d+A;m++)e[n+m+1]=-1;break}}}else if(5==r.ltype&&2==l.fmt)for(var p=t._lctf.getInterval(l.cDef,e[n]),g=l.cDef[p+2],v=l.scset[g],y=0;y<v.length;y++){var E=v[y],x=E.input;if(!(x.length>s)){for(f=!0,m=0;m<x.length;m++){var C=t._lctf.getInterval(l.cDef,e[n+1+m]);if(-1==p&&l.cDef[C+2]!=x[m]){f=!1;break}}if(f){var w=E.substLookupRecords;for(h=0;h<w.length;h+=2)w[h],w[h+1]}}}else if(6==r.ltype&&3==l.fmt){if(!t.U._glsCovered(e,l.backCvg,n-l.backCvg.length))continue;if(!t.U._glsCovered(e,l.inptCvg,n))continue;if(!t.U._glsCovered(e,l.ahedCvg,n+l.inptCvg.length))continue;var I=l.lookupRec;for(y=0;y<I.length;y+=2){p=I[y];var b=i[I[y+1]];t.U._applySubs(e,n+p,b,i)}}}},t.U._glsCovered=function(e,n,r){for(var i=0;i<n.length;i++)if(-1==t._lctf.coverageIndex(n[i],e[r+i]))return!1;return!0},t.U.glyphsToPath=function(e,n,r){for(var i={cmds:[],crds:[]},s=0,a=0;a<n.length;a++){var o=n[a];if(-1!=o){for(var l=a<n.length-1&&-1!=n[a+1]?n[a+1]:0,c=t.U.glyphToPath(e,o),h=0;h<c.crds.length;h+=2)i.crds.push(c.crds[h]+s),i.crds.push(c.crds[h+1]);for(r&&i.cmds.push(r),h=0;h<c.cmds.length;h++)i.cmds.push(c.cmds[h]);r&&i.cmds.push("X"),s+=e.hmtx.aWidth[o],a<n.length-1&&(s+=t.U.getPairAdjustment(e,o,l))}}return i},t.U.P={},t.U.P.moveTo=function(e,t,n){e.cmds.push("M"),e.crds.push(t,n)},t.U.P.lineTo=function(e,t,n){e.cmds.push("L"),e.crds.push(t,n)},t.U.P.curveTo=function(e,t,n,r,i,s,a){e.cmds.push("C"),e.crds.push(t,n,r,i,s,a)},t.U.P.qcurveTo=function(e,t,n,r,i){e.cmds.push("Q"),e.crds.push(t,n,r,i)},t.U.P.closePath=function(e){e.cmds.push("Z")},t.U._drawCFF=function(e,n,r,i,s){for(var a=n.stack,o=n.nStems,l=n.haveWidth,c=n.width,h=n.open,u=0,d=n.x,f=n.y,A=0,m=0,p=0,g=0,v=0,y=0,E=0,x=0,C=0,w=0,I={val:0,size:0};u<e.length;){t.CFF.getCharString(e,u,I);var b=I.val;if(u+=I.size,"o1"==b||"o18"==b)a.length%2!=0&&!l&&(c=a.shift()+i.nominalWidthX),o+=a.length>>1,a.length=0,l=!0;else if("o3"==b||"o23"==b)a.length%2!=0&&!l&&(c=a.shift()+i.nominalWidthX),o+=a.length>>1,a.length=0,l=!0;else if("o4"==b)a.length>1&&!l&&(c=a.shift()+i.nominalWidthX,l=!0),h&&t.U.P.closePath(s),f+=a.pop(),t.U.P.moveTo(s,d,f),h=!0;else if("o5"==b)for(;a.length>0;)d+=a.shift(),f+=a.shift(),t.U.P.lineTo(s,d,f);else if("o6"==b||"o7"==b)for(var S=a.length,B="o6"==b,T=0;T<S;T++){var _=a.shift();B?d+=_:f+=_,B=!B,t.U.P.lineTo(s,d,f)}else if("o8"==b||"o24"==b){S=a.length;for(var M=0;M+6<=S;)A=d+a.shift(),m=f+a.shift(),p=A+a.shift(),g=m+a.shift(),d=p+a.shift(),f=g+a.shift(),t.U.P.curveTo(s,A,m,p,g,d,f),M+=6;"o24"==b&&(d+=a.shift(),f+=a.shift(),t.U.P.lineTo(s,d,f))}else{if("o11"==b)break;if("o1234"==b||"o1235"==b||"o1236"==b||"o1237"==b)"o1234"==b&&(m=f,p=(A=d+a.shift())+a.shift(),w=g=m+a.shift(),y=g,x=f,d=(E=(v=(C=p+a.shift())+a.shift())+a.shift())+a.shift(),t.U.P.curveTo(s,A,m,p,g,C,w),t.U.P.curveTo(s,v,y,E,x,d,f)),"o1235"==b&&(A=d+a.shift(),m=f+a.shift(),p=A+a.shift(),g=m+a.shift(),C=p+a.shift(),w=g+a.shift(),v=C+a.shift(),y=w+a.shift(),E=v+a.shift(),x=y+a.shift(),d=E+a.shift(),f=x+a.shift(),a.shift(),t.U.P.curveTo(s,A,m,p,g,C,w),t.U.P.curveTo(s,v,y,E,x,d,f)),"o1236"==b&&(A=d+a.shift(),m=f+a.shift(),p=A+a.shift(),w=g=m+a.shift(),y=g,E=(v=(C=p+a.shift())+a.shift())+a.shift(),x=y+a.shift(),d=E+a.shift(),t.U.P.curveTo(s,A,m,p,g,C,w),t.U.P.curveTo(s,v,y,E,x,d,f)),"o1237"==b&&(A=d+a.shift(),m=f+a.shift(),p=A+a.shift(),g=m+a.shift(),C=p+a.shift(),w=g+a.shift(),v=C+a.shift(),y=w+a.shift(),E=v+a.shift(),x=y+a.shift(),Math.abs(E-d)>Math.abs(x-f)?d=E+a.shift():f=x+a.shift(),t.U.P.curveTo(s,A,m,p,g,C,w),t.U.P.curveTo(s,v,y,E,x,d,f));else if("o14"==b){if(a.length>0&&!l&&(c=a.shift()+r.nominalWidthX,l=!0),4==a.length){var R=a.shift(),D=a.shift(),P=a.shift(),L=a.shift(),k=t.CFF.glyphBySE(r,P),F=t.CFF.glyphBySE(r,L);t.U._drawCFF(r.CharStrings[k],n,r,i,s),n.x=R,n.y=D,t.U._drawCFF(r.CharStrings[F],n,r,i,s)}h&&(t.U.P.closePath(s),h=!1)}else if("o19"==b||"o20"==b)a.length%2!=0&&!l&&(c=a.shift()+i.nominalWidthX),o+=a.length>>1,a.length=0,l=!0,u+=o+7>>3;else if("o21"==b)a.length>2&&!l&&(c=a.shift()+i.nominalWidthX,l=!0),f+=a.pop(),d+=a.pop(),h&&t.U.P.closePath(s),t.U.P.moveTo(s,d,f),h=!0;else if("o22"==b)a.length>1&&!l&&(c=a.shift()+i.nominalWidthX,l=!0),d+=a.pop(),h&&t.U.P.closePath(s),t.U.P.moveTo(s,d,f),h=!0;else if("o25"==b){for(;a.length>6;)d+=a.shift(),f+=a.shift(),t.U.P.lineTo(s,d,f);A=d+a.shift(),m=f+a.shift(),p=A+a.shift(),g=m+a.shift(),d=p+a.shift(),f=g+a.shift(),t.U.P.curveTo(s,A,m,p,g,d,f)}else if("o26"==b)for(a.length%2&&(d+=a.shift());a.length>0;)A=d,m=f+a.shift(),d=p=A+a.shift(),f=(g=m+a.shift())+a.shift(),t.U.P.curveTo(s,A,m,p,g,d,f);else if("o27"==b)for(a.length%2&&(f+=a.shift());a.length>0;)m=f,p=(A=d+a.shift())+a.shift(),g=m+a.shift(),d=p+a.shift(),f=g,t.U.P.curveTo(s,A,m,p,g,d,f);else if("o10"==b||"o29"==b){var O="o10"==b?i:r;if(0==a.length)console.debug("error: empty stack");else{var U=a.pop(),Q=O.Subrs[U+O.Bias];n.x=d,n.y=f,n.nStems=o,n.haveWidth=l,n.width=c,n.open=h,t.U._drawCFF(Q,n,r,i,s),d=n.x,f=n.y,o=n.nStems,l=n.haveWidth,c=n.width,h=n.open}}else if("o30"==b||"o31"==b){var N=a.length,z=(M=0,"o31"==b);for(M+=N-(S=-3&N);M<S;)z?(m=f,p=(A=d+a.shift())+a.shift(),f=(g=m+a.shift())+a.shift(),S-M==5?(d=p+a.shift(),M++):d=p,z=!1):(A=d,m=f+a.shift(),p=A+a.shift(),g=m+a.shift(),d=p+a.shift(),S-M==5?(f=g+a.shift(),M++):f=g,z=!0),t.U.P.curveTo(s,A,m,p,g,d,f),M+=4}else{if("o"==(b+"").charAt(0))throw console.debug("Unknown operation: "+b,e),b;a.push(b)}}}n.x=d,n.y=f,n.nStems=o,n.haveWidth=l,n.width=c,n.open=h};var n=t,r={Typr:n};return e.Typr=n,e.default=r,Object.defineProperty(e,"__esModule",{value:!0}),e}({}).Typr},function(){return function(e){var t=Uint8Array,n=Uint16Array,r=Uint32Array,i=new t([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),s=new t([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),a=new t([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),o=function(e,t){for(var i=new n(31),s=0;s<31;++s)i[s]=t+=1<<e[s-1];var a=new r(i[30]);for(s=1;s<30;++s)for(var o=i[s];o<i[s+1];++o)a[o]=o-i[s]<<5|s;return[i,a]},l=o(i,2),c=l[0],h=l[1];c[28]=258,h[258]=28;for(var u=o(s,0)[0],d=new n(32768),f=0;f<32768;++f){var A=(43690&f)>>>1|(21845&f)<<1;A=(61680&(A=(52428&A)>>>2|(13107&A)<<2))>>>4|(3855&A)<<4,d[f]=((65280&A)>>>8|(255&A)<<8)>>>1}var m=function(e,t,r){for(var i=e.length,s=0,a=new n(t);s<i;++s)++a[e[s]-1];var o,l=new n(t);for(s=0;s<t;++s)l[s]=l[s-1]+a[s-1]<<1;if(r){o=new n(1<<t);var c=15-t;for(s=0;s<i;++s)if(e[s])for(var h=s<<4|e[s],u=t-e[s],f=l[e[s]-1]++<<u,A=f|(1<<u)-1;f<=A;++f)o[d[f]>>>c]=h}else for(o=new n(i),s=0;s<i;++s)e[s]&&(o[s]=d[l[e[s]-1]++]>>>15-e[s]);return o},p=new t(288);for(f=0;f<144;++f)p[f]=8;for(f=144;f<256;++f)p[f]=9;for(f=256;f<280;++f)p[f]=7;for(f=280;f<288;++f)p[f]=8;var g=new t(32);for(f=0;f<32;++f)g[f]=5;var v=m(p,9,1),y=m(g,5,1),E=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},x=function(e,t,n){var r=t/8|0;return(e[r]|e[r+1]<<8)>>(7&t)&n},C=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},w=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],I=function(e,t,n){var r=new Error(t||w[e]);if(r.code=e,Error.captureStackTrace&&Error.captureStackTrace(r,I),!n)throw r;return r},b=function(e,o,l){var h=e.length;if(!h||l&&!l.l&&h<5)return o||new t(0);var d=!o||l,f=!l||l.i;l||(l={}),o||(o=new t(3*h));var A,p=function(e){var n=o.length;if(e>n){var r=new t(Math.max(2*n,e));r.set(o),o=r}},g=l.f||0,w=l.p||0,b=l.b||0,S=l.l,B=l.d,T=l.m,_=l.n,M=8*h;do{if(!S){l.f=g=x(e,w,1);var R=x(e,w+1,3);if(w+=3,!R){var D=e[(H=((A=w)/8|0)+(7&A&&1)+4)-4]|e[H-3]<<8,P=H+D;if(P>h){f&&I(0);break}d&&p(b+D),o.set(e.subarray(H,P),b),l.b=b+=D,l.p=w=8*P;continue}if(1==R)S=v,B=y,T=9,_=5;else if(2==R){var L=x(e,w,31)+257,k=x(e,w+10,15)+4,F=L+x(e,w+5,31)+1;w+=14;for(var O=new t(F),U=new t(19),Q=0;Q<k;++Q)U[a[Q]]=x(e,w+3*Q,7);w+=3*k;var N=E(U),z=(1<<N)-1,G=m(U,N,1);for(Q=0;Q<F;){var H,q=G[x(e,w,z)];if(w+=15&q,(H=q>>>4)<16)O[Q++]=H;else{var Y=0,j=0;for(16==H?(j=3+x(e,w,3),w+=2,Y=O[Q-1]):17==H?(j=3+x(e,w,7),w+=3):18==H&&(j=11+x(e,w,127),w+=7);j--;)O[Q++]=Y}}var V=O.subarray(0,L),K=O.subarray(L);T=E(V),_=E(K),S=m(V,T,1),B=m(K,_,1)}else I(1);if(w>M){f&&I(0);break}}d&&p(b+131072);for(var W=(1<<T)-1,J=(1<<_)-1,X=w;;X=w){var $=(Y=S[C(e,w)&W])>>>4;if((w+=15&Y)>M){f&&I(0);break}if(Y||I(2),$<256)o[b++]=$;else{if(256==$){X=w,S=null;break}var Z=$-254;if($>264){var ee=i[Q=$-257];Z=x(e,w,(1<<ee)-1)+c[Q],w+=ee}var te=B[C(e,w)&J],ne=te>>>4;if(te||I(3),w+=15&te,K=u[ne],ne>3&&(ee=s[ne],K+=C(e,w)&(1<<ee)-1,w+=ee),w>M){f&&I(0);break}d&&p(b+131072);for(var re=b+Z;b<re;b+=4)o[b]=o[b-K],o[b+1]=o[b+1-K],o[b+2]=o[b+2-K],o[b+3]=o[b+3-K];b=re}}l.l=S,l.p=X,l.b=b,S&&(g=1,l.m=T,l.d=B,l.n=_)}while(!g);return b==o.length?o:function(e,i,s){(null==i||i<0)&&(i=0),(null==s||s>e.length)&&(s=e.length);var a=new(e instanceof n?n:e instanceof r?r:t)(s-i);return a.set(e.subarray(i,s)),a}(o,0,b)},S=new t(0),B="undefined"!=typeof TextDecoder&&new TextDecoder;try{B.decode(S,{stream:!0})}catch(e){}return e.convert_streams=function(e){var t=new DataView(e),n=0;function r(){var e=t.getUint16(n);return n+=2,e}function i(){var e=t.getUint32(n);return n+=4,e}function s(e){g.setUint16(v,e),v+=2}function a(e){g.setUint32(v,e),v+=4}for(var o={signature:i(),flavor:i(),length:i(),numTables:r(),reserved:r(),totalSfntSize:i(),majorVersion:r(),minorVersion:r(),metaOffset:i(),metaLength:i(),metaOrigLength:i(),privOffset:i(),privLength:i()},l=0;Math.pow(2,l)<=o.numTables;)l++;l--;for(var c=16*Math.pow(2,l),h=16*o.numTables-c,u=12,d=[],f=0;f<o.numTables;f++)d.push({tag:i(),offset:i(),compLength:i(),origLength:i(),origChecksum:i()}),u+=16;var A,m=new Uint8Array(12+16*d.length+d.reduce((function(e,t){return e+t.origLength+4}),0)),p=m.buffer,g=new DataView(p),v=0;return a(o.flavor),s(o.numTables),s(c),s(l),s(h),d.forEach((function(e){a(e.tag),a(e.origChecksum),a(u),a(e.origLength),e.outOffset=u,(u+=e.origLength)%4!=0&&(u+=4-u%4)})),d.forEach((function(t){var n,r=e.slice(t.offset,t.offset+t.compLength);if(t.compLength!=t.origLength){var i=new Uint8Array(t.origLength);n=new Uint8Array(r,2),b(n,i)}else i=new Uint8Array(r);m.set(i,t.outOffset);var s=0;(u=t.outOffset+t.origLength)%4!=0&&(s=4-u%4),m.set(new Uint8Array(s).buffer,t.outOffset+t.origLength),A=u+s})),p.slice(0,A)},Object.defineProperty(e,"__esModule",{value:!0}),e}({}).convert_streams},function(e,t){const n={M:2,L:2,Q:4,C:6,Z:0},r={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"};let i;function s(e){if(!i){const e={R:2,L:1,D:4,C:16,U:32,T:8};i=new Map;for(let t in r){let n=0;r[t].split(",").forEach((r=>{let[s,a]=r.split("+");s=parseInt(s,36),a=a?parseInt(a,36):0,i.set(n+=s,e[t]);for(let o=a;o--;)i.set(++n,e[t])}))}}return i.get(e)||32}const a=[null,"isol","init","fina","medi"];function o(e){const t=new Uint8Array(e.length);let n=32,r=1,i=-1;for(let a=0;a<e.length;a++){const o=e.codePointAt(a);let l=0|s(o),c=1;8&l||(21&n?22&l?(c=3,1!==r&&3!==r||t[i]++):33&l&&(2!==r&&4!==r||t[i]--):34&n&&(2!==r&&4!==r||t[i]--),r=t[a]=c,n=l,i=a,o>65535&&a++)}return t}function l(t,n){const r=t.GDEF&&t.GDEF.glyphClassDef;return r?e.U._getGlyphClass(n,r):0}function c(...e){for(let t=0;t<e.length;t++)if("number"==typeof e[t])return e[t]}function h(t){const r=Object.create(null),i=t["OS/2"],s=t.hhea,h=t.head.unitsPerEm,u=c(i&&i.sTypoAscender,s&&s.ascender,h),d={unitsPerEm:h,ascender:u,descender:c(i&&i.sTypoDescender,s&&s.descender,0),capHeight:c(i&&i.sCapHeight,u),xHeight:c(i&&i.sxHeight,u),lineGap:c(i&&i.sTypoLineGap,s&&s.lineGap),supportsCodePoint:n=>e.U.codeToGlyph(t,n)>0,forEachGlyph(i,s,c,h){let u=0;const f=1/d.unitsPerEm*s,A=function(t,n){const r=[];for(let s=0;s<n.length;s++){const i=n.codePointAt(s);i>65535&&s++,r.push(e.U.codeToGlyph(t,i))}const i=t.GSUB;if(i){const{lookupList:t,featureList:s}=i;let l;const c=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,h=[];s.forEach((i=>{if(c.test(i.tag))for(let s=0;s<i.tab.length;s++){if(h[i.tab[s]])continue;h[i.tab[s]]=!0;const c=t[i.tab[s]],u=/^(isol|init|fina|medi)$/.test(i.tag);u&&!l&&(l=o(n));for(let n=0;n<r.length;n++)l&&u&&a[l[n]]!==i.tag||e.U._applySubs(r,n,c,t)}}))}return r}(t,i);let m=0;const p=function(t,n){const r=new Int16Array(3*n.length);let i=0;for(;i<n.length;i++){const c=n[i];if(-1===c)continue;r[3*i+2]=t.hmtx.aWidth[c];const h=t.GPOS;if(h){const u=h.lookupList;for(let h=0;h<u.length;h++){const d=u[h];for(let h=0;h<d.tabs.length;h++){const u=d.tabs[h];if(1===d.ltype){if(-1!==e._lctf.coverageIndex(u.coverage,c)&&u.pos){o(u.pos,i);break}}else if(2===d.ltype){let t=null,r=s();if(-1!==r){const s=e._lctf.coverageIndex(u.coverage,n[r]);if(-1!==s){if(1===u.fmt){const e=u.pairsets[s];for(let n=0;n<e.length;n++)e[n].gid2===c&&(t=e[n])}else if(2===u.fmt){const i=e.U._getGlyphClass(n[r],u.classDef1),s=e.U._getGlyphClass(c,u.classDef2);t=u.matrix[i][s]}if(t){t.val1&&o(t.val1,r),t.val2&&o(t.val2,i);break}}}}else if(4===d.ltype){const t=e._lctf.coverageIndex(u.markCoverage,c);if(-1!==t){const o=s(a),l=-1===o?-1:e._lctf.coverageIndex(u.baseCoverage,n[o]);if(-1!==l){const e=u.markArray[t],n=u.baseArray[l][e.markClass];r[3*i]=n.x-e.x+r[3*o]-r[3*o+2],r[3*i+1]=n.y-e.y+r[3*o+1];break}}}else if(6===d.ltype){const a=e._lctf.coverageIndex(u.mark1Coverage,c);if(-1!==a){const o=s();if(-1!==o){const s=n[o];if(3===l(t,s)){const t=e._lctf.coverageIndex(u.mark2Coverage,s);if(-1!==t){const e=u.mark1Array[a],n=u.mark2Array[t][e.markClass];r[3*i]=n.x-e.x+r[3*o]-r[3*o+2],r[3*i+1]=n.y-e.y+r[3*o+1];break}}}}}}}}else if(t.kern&&!t.cff){const e=s();if(-1!==e){const i=t.kern.glyph1.indexOf(n[e]);if(-1!==i){const n=t.kern.rval[i].glyph2.indexOf(c);-1!==n&&(r[3*e+2]+=t.kern.rval[i].vals[n])}}}}return r;function s(e){for(let t=i-1;t>=0;t--)if(-1!==n[t]&&(!e||e(n[t])))return t;return-1}function a(e){return 1===l(t,e)}function o(e,t){for(let n=0;n<3;n++)r[3*t+n]+=e[n]||0}}(t,A);return A.forEach(((a,o)=>{if(-1!==a){let i=r[a];if(!i){const{cmds:s,crds:o}=e.U.glyphToPath(t,a);let l,c,h,u,d="",f=0;for(let e=0,t=s.length;e<t;e++){const t=n[s[e]];d+=s[e];for(let e=1;e<=t;e++)d+=(e>1?",":"")+o[f++]}if(o.length){l=c=1/0,h=u=-1/0;for(let e=0,t=o.length;e<t;e+=2){let t=o[e],n=o[e+1];t<l&&(l=t),n<c&&(c=n),t>h&&(h=t),n>u&&(u=n)}}else l=h=c=u=0;i=r[a]={index:a,advanceWidth:t.hmtx.aWidth[a],xMin:l,yMin:c,xMax:h,yMax:u,path:d}}h.call(null,i,u+p[3*o]*f,p[3*o+1]*f,m),u+=p[3*o+2]*f,c&&(u+=c*s)}m+=i.codePointAt(m)>65535?2:1})),u}};return d}return function(n){const r=new Uint8Array(n,0,4),i=e._bin.readASCII(r,0,4);if("wOFF"===i)n=t(n);else if("wOF2"===i)throw new Error("woff2 fonts not supported");return h(e.parse(n)[0])}}],init:(e,t,n)=>n(e(),t())});const Bi=li({name:"FontResolver",dependencies:[function(e,t){const n=Object.create(null),r=Object.create(null);function i(t,i){let s=n[t];s?i(s):r[t]?r[t].push(i):(r[t]=[i],function(t,n){const r=e=>{console.error(`Failure loading font ${t}`,e)};try{const i=new XMLHttpRequest;i.open("get",t,!0),i.responseType="arraybuffer",i.onload=function(){if(i.status>=400)r(new Error(i.statusText));else if(i.status>0)try{const r=e(i.response);r.src=t,n(r)}catch(Sf){r(Sf)}},i.onerror=r,i.send()}catch(i){r(i)}}(t,(e=>{e.src=t,n[t]=e,r[t].forEach((t=>t(e))),delete r[t]})))}return function(e,r,{lang:s,fonts:a=[],style:o="normal",weight:l="normal",unicodeFontsURL:c}={}){const h=new Uint8Array(e.length),u=[];e.length||m();const d=new Map,f=[];if("italic"!==o&&(o="normal"),"number"!=typeof l&&(l="bold"===l?700:400),a&&!Array.isArray(a)&&(a=[a]),(a=a.slice().filter((e=>!e.lang||e.lang.test(s))).reverse()).length){const t=1,r=2;let s=0;!function o(l=0){for(let c=l,A=e.length;c<A;c++){const l=e.codePointAt(c);if(s===t&&u[h[c-1]].supportsCodePoint(l)||c>0&&/\s/.test(e[c]))h[c]=h[c-1],s===r&&(f[f.length-1][1]=c);else for(let e=h[c],A=a.length;e<=A;e++)if(e===A){(s===r?f[f.length-1]:f[f.length]=[c,c])[1]=c,s=r}else{h[c]=e;const{src:r,unicodeRange:f}=a[e];if(!f||p(l,f)){const e=n[r];if(!e)return void i(r,(()=>{o(c)}));if(e.supportsCodePoint(l)){let n=d.get(e);"number"!=typeof n&&(n=u.length,u.push(e),d.set(e,n)),h[c]=n,s=t;break}}}l>65535&&c+1<A&&(h[c+1]=h[c],c++,s===r&&(f[f.length-1][1]=c))}A()}()}else f.push([0,e.length-1]),A();function A(){if(f.length){const n=f.map((t=>e.substring(t[0],t[1]+1))).join("\n");t.getFontsForString(n,{lang:s||void 0,style:o,weight:l,dataUrl:c}).then((({fontUrls:e,chars:t})=>{const n=u.length;let r=0;f.forEach((e=>{for(let i=0,s=e[1]-e[0];i<=s;i++)h[e[0]+i]=t[r++]+n;r++}));let s=0;e.forEach(((t,r)=>{i(t,(t=>{u[r+n]=t,++s===e.length&&m()}))}))}))}else m()}function m(){r({chars:h,fonts:u})}function p(e,t){for(let n=0;n<t.length;n++){const[r,i=r]=t[n];if(r<=e&&e<=i)return!0}return!1}}},Si,function(){return function(e){var t=function(){this.buckets=new Map};t.prototype.add=function(e){var t=e>>5;this.buckets.set(t,(this.buckets.get(t)||0)|1<<(31&e))},t.prototype.has=function(e){var t=this.buckets.get(e>>5);return void 0!==t&&!!(t&1<<(31&e))},t.prototype.serialize=function(){var e=[];return this.buckets.forEach((function(t,n){e.push((+n).toString(36)+":"+t.toString(36))})),e.join(",")},t.prototype.deserialize=function(e){var t=this;this.buckets.clear(),e.split(",").forEach((function(e){var n=e.split(":");t.buckets.set(parseInt(n[0],36),parseInt(n[1],36))}))};var n=Math.pow(2,8),r=n-1,i=~r;function s(e){var t=function(e){return e&i}(e).toString(16),r=function(e){return(e&i)+n-1}(e).toString(16);return"codepoint-index/plane"+(e>>16)+"/"+t+"-"+r+".json"}function a(e,t){var n=e&r,i=t.codePointAt(n/6|0);return!!((i=(i||48)-48)&1<<n%6)}function o(e,t){!function(e,t){var n;(n=e,n.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map((function(e){return e.split("-").map((function(e){return parseInt(e.trim(),16)}))}))).forEach((function(e){var n=e[0],r=e[1];void 0===r&&(r=n),t(n,r)}))}(e,(function(e,n){for(var r=e;r<=n;r++)t(r)}))}var l={},c={},h=new WeakMap,u="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function d(e){var n=h.get(e);return n||(n=new t,o(e.ranges,(function(e){return n.add(e)})),h.set(e,n)),n}var f,A=new Map;function m(e,t,n){return e[t]?t:e[n]?n:function(e){for(var t in e)return t}(e)}function p(e,t){var n=t;if(!e.includes(n)){n=1/0;for(var r=0;r<e.length;r++)Math.abs(e[r]-t)<Math.abs(n-t)&&(n=e[r])}return n}function g(e){return f||(f=new Set,o("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",(function(e){f.add(e)}))),f.has(e)}return e.CodePointSet=t,e.clearCache=function(){l={},c={}},e.getFontsForString=function(e,t){void 0===t&&(t={});var n,r=t.lang;void 0===r&&(r=/\p{Script=Hangul}/u.test(n=e)?"ko":/\p{Script=Hiragana}|\p{Script=Katakana}/u.test(n)?"ja":"en");var i=t.category;void 0===i&&(i="sans-serif");var o=t.style;void 0===o&&(o="normal");var h=t.weight;void 0===h&&(h=400);var f=(t.dataUrl||u).replace(/\/$/g,""),v=new Map,y=new Uint8Array(e.length),E={},x={},C=new Array(e.length),w=new Map,I=!1;function b(e){var t=A.get(e);return t||(t=fetch(f+"/"+e).then((function(e){if(!e.ok)throw new Error(e.statusText);return e.json().then((function(e){if(!Array.isArray(e)||1!==e[0])throw new Error("Incorrect schema version; need 1, got "+e[0]);return e[1]}))})).catch((function(t){if(f!==u)return I||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+f+'", trying default CDN. '+t.message),I=!0),f=u,A.delete(e),b(e);throw t})),A.set(e,t)),t}for(var S=function(t){var n=e.codePointAt(t),r=s(n);C[t]=r,l[r]||w.has(r)||w.set(r,b(r).then((function(e){l[r]=e}))),n>65535&&(t++,B=t)},B=0;B<e.length;B++)S(B);return Promise.all(w.values()).then((function(){w.clear();for(var t=function(t){var i=e.codePointAt(t),s=null,o=l[C[t]],h=void 0;for(var u in o){var d=x[u];if(void 0===d&&(d=x[u]=new RegExp(u).test(r||"en")),d){for(var f in h=u,o[u])if(a(i,o[u][f])){s=f;break}break}}if(!s)e:for(var A in o)if(A!==h)for(var m in o[A])if(a(i,o[A][m])){s=m;break e}s||(console.debug("No font coverage for U+"+i.toString(16)),s="latin"),C[t]=s,c[s]||w.has(s)||w.set(s,b("font-meta/"+s+".json").then((function(e){c[s]=e}))),i>65535&&(t++,n=t)},n=0;n<e.length;n++)t(n);return Promise.all(w.values())})).then((function(){for(var t,n=null,r=0;r<e.length;r++){var s=e.codePointAt(r);if(n&&(g(s)||d(n).has(s)))y[r]=y[r-1];else{n=c[C[r]];var a=E[n.id];if(!a){var l=n.typeforms,u=m(l,i,"sans-serif"),A=m(l[u],o,"normal"),x=p(null===(t=l[u])||void 0===t?void 0:t[A],h);a=E[n.id]=f+"/font-files/"+n.id+"/"+u+"."+A+"."+x+".woff"}var w=v.get(a);null==w&&(w=v.size,v.set(a,w)),y[r]=w}s>65535&&(r++,y[r]=y[r-1])}return{fontUrls:Array.from(v.keys()),chars:y}}))},Object.defineProperty(e,"__esModule",{value:!0}),e}({})}],init:(e,t,n)=>e(t,n())});const Ti=()=>(self.performance||Date).now(),_i=ui();let Mi;const Ri=[];let Di=0;function Pi(){const e=Ti();for(;Ri.length&&Ti()-e<5;)Ri.shift()();Di=Ri.length?setTimeout(Pi,0):0}const Li=(...e)=>new Promise(((t,n)=>{Ri.push((()=>{const r=Ti();try{_i.webgl.generateIntoCanvas(...e),t({timing:Ti()-r})}catch(i){n(i)}})),Di||(Di=setTimeout(Pi,0))})),ki=4,Fi=2e3,Oi={};let Ui=0;function Qi(e,t,n,r,i,s,a,o,l,c){const h="TroikaTextSDFGenerator_JS_"+Ui++%ki;let u=Oi[h];return u||(u=Oi[h]={workerModule:li({name:h,workerId:h,dependencies:[ui,Ti],init(e,t){const n=e().javascript.generate;return function(...e){const r=t();return{textureData:n(...e),timing:t()-r}}},getTransferables:e=>[e.textureData.buffer]}),requests:0,idleTimer:null}),u.requests++,clearTimeout(u.idleTimer),u.workerModule(e,t,n,r,i,s).then((({textureData:n,timing:r})=>{const i=Ti(),s=new Uint8Array(4*n.length);for(let e=0;e<n.length;e++)s[4*e+c]=n[e];return _i.webglUtils.renderImageData(a,s,o,l,e,t,1<<3-c),r+=Ti()-i,0==--u.requests&&(u.idleTimer=setTimeout((()=>{!function(e){ai[e]&&ai[e].forEach((function(e){e()})),si[e]&&(si[e].terminate(),delete si[e])}(h)}),Fi)),{timing:r}}))}const Ni=_i.webglUtils.resizeWebGLCanvasWithoutClearing,zi={defaultFontURL:null,unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048,useWorker:!0},Gi=new a.Q1f;let Hi=!1;function qi(){return(self.performance||Date).now()}const Yi=Object.create(null);function ji(e,t){Hi=!0,e=Ki({},e);const n=qi(),{defaultFontURL:r}=zi,i=[];if(r&&i.push({label:"default",src:Ji(r)}),e.font&&i.push({label:"user",src:Ji(e.font)}),e.font=i,e.text=""+e.text,e.sdfGlyphSize=e.sdfGlyphSize||zi.sdfGlyphSize,e.unicodeFontsURL=e.unicodeFontsURL||zi.unicodeFontsURL,null!=e.colorRanges){let t={};for(let n in e.colorRanges)if(e.colorRanges.hasOwnProperty(n)){let r=e.colorRanges[n];"number"!=typeof r&&(r=Gi.set(r).getHex()),t[n]=r}e.colorRanges=t}Object.freeze(e);const{textureWidth:s,sdfExponent:o}=zi,{sdfGlyphSize:l}=e,c=s/l*4;let h=Yi[l];if(!h){const e=document.createElement("canvas");e.width=s,e.height=256*l/c,h=Yi[l]={glyphCount:0,sdfGlyphSize:l,sdfCanvas:e,sdfTexture:new a.gPd(e,void 0,void 0,void 0,a.k6q,a.k6q),contextLost:!1,glyphsByFont:new Map},h.sdfTexture.generateMipmaps=!1,function(e){const t=e.sdfCanvas;t.addEventListener("webglcontextlost",(t=>{console.log("Context Lost",t),t.preventDefault(),e.contextLost=!0})),t.addEventListener("webglcontextrestored",(t=>{console.log("Context Restored",t),e.contextLost=!1;const n=[];e.glyphsByFont.forEach((t=>{t.forEach((t=>{n.push(Vi(t,e,!0))}))})),Promise.all(n).then((()=>{Xi(e),e.sdfTexture.needsUpdate=!0}))}))}(h)}const{sdfTexture:u,sdfCanvas:d}=h;(zi.useWorker?Zi:es)(e).then((r=>{const{glyphIds:i,glyphFontIndices:a,fontData:f,glyphPositions:A,fontSize:m,timings:p}=r,g=[],v=new Float32Array(4*i.length);let y=0,E=0;const x=qi(),C=f.map((e=>{let t=h.glyphsByFont.get(e.src);return t||h.glyphsByFont.set(e.src,t=new Map),t}));i.forEach(((e,t)=>{const n=a[t],{src:s,unitsPerEm:o}=f[n];let c=C[n].get(e);if(!c){const{path:t,pathBounds:i}=r.glyphData[s][e],a=Math.max(i[2]-i[0],i[3]-i[1])/l*(zi.sdfMargin*l+.5),o=h.glyphCount++,u=[i[0]-a,i[1]-a,i[2]+a,i[3]+a];C[n].set(e,c={path:t,atlasIndex:o,sdfViewBox:u}),g.push(c)}const{sdfViewBox:u}=c,d=A[E++],p=A[E++],x=m/o;v[y++]=d+u[0]*x,v[y++]=p+u[1]*x,v[y++]=d+u[2]*x,v[y++]=p+u[3]*x,i[t]=c.atlasIndex})),p.quads=(p.quads||0)+(qi()-x);const w=qi();p.sdf={};const I=d.height,b=Math.ceil(h.glyphCount/c),S=Math.pow(2,Math.ceil(Math.log2(b*l)));S>I&&(console.info(`Increasing SDF texture size ${I}->${S}`),Ni(d,s,S),u.dispose()),Promise.all(g.map((t=>Vi(t,h,e.gpuAccelerateSDF).then((({timing:e})=>{p.sdf[t.atlasIndex]=e}))))).then((()=>{g.length&&!h.contextLost&&(Xi(h),u.needsUpdate=!0),p.sdfTotal=qi()-w,p.total=qi()-n,t(Object.freeze({parameters:e,sdfTexture:u,sdfGlyphSize:l,sdfExponent:o,glyphBounds:v,glyphAtlasIndices:i,glyphColors:r.glyphColors,caretPositions:r.caretPositions,chunkedBounds:r.chunkedBounds,ascender:r.ascender,descender:r.descender,lineHeight:r.lineHeight,capHeight:r.capHeight,xHeight:r.xHeight,topBaseline:r.topBaseline,blockBounds:r.blockBounds,visibleBounds:r.visibleBounds,timings:r.timings}))}))})),Promise.resolve().then((()=>{var e;h.contextLost||(e=d)._warm||(_i.webgl.isSupported(e),e._warm=!0)}))}function Vi({path:e,atlasIndex:t,sdfViewBox:n},{sdfGlyphSize:r,sdfCanvas:i,contextLost:s},a){if(s)return Promise.resolve({timing:-1});const{textureWidth:o,sdfExponent:l}=zi,c=Math.max(n[2]-n[0],n[3]-n[1]),h=Math.floor(t/4);return function(e,t,n,r,i,s,a,o,l,c,h=!0){return h?Li(e,t,n,r,i,s,a,o,l,c).then(null,(h=>(Mi||(console.warn("WebGL SDF generation failed, falling back to JS",h),Mi=!0),Qi(e,t,n,r,i,s,a,o,l,c)))):Qi(e,t,n,r,i,s,a,o,l,c)}(r,r,e,n,c,l,i,h%(o/r)*r,Math.floor(h/(o/r))*r,t%4,a)}function Ki(e,t){for(let n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}let Wi;function Ji(e){return Wi||(Wi="undefined"==typeof document?{}:document.createElement("a")),Wi.href=e,Wi.href}function Xi(e){if("function"!=typeof createImageBitmap){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:t,sdfTexture:n}=e,{width:r,height:i}=t,s=e.sdfCanvas.getContext("webgl");let a=n.image.data;a&&a.length===r*i*4||(a=new Uint8Array(r*i*4),n.image={width:r,height:i,data:a},n.flipY=!1,n.isDataTexture=!0),s.readPixels(0,0,r,i,s.RGBA,s.UNSIGNED_BYTE,a)}}const $i=li({name:"Typesetter",dependencies:[function(e,t){const n=1/0,r=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,i="[^\\S\\u00A0]",s=new RegExp(`${i}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function a({text:a="",font:u,lang:d,sdfGlyphSize:f=64,fontSize:A=400,fontWeight:m=1,fontStyle:p="normal",letterSpacing:g=0,lineHeight:v="normal",maxWidth:y=n,direction:E,textAlign:x="left",textIndent:C=0,whiteSpace:w="normal",overflowWrap:I="normal",anchorX:b=0,anchorY:S=0,metricsOnly:B=!1,unicodeFontsURL:T,preResolvedFonts:_=null,includeCaretPositions:M=!1,chunkedBoundsSize:R=8192,colorRanges:D=null},P){const L=c(),k={fontLoad:0,typesetting:0};a.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),a=a.replace(/\r\n/g,"\n").replace(/\r/g,"\n")),A=+A,g=+g,y=+y,v=v||"normal",C=+C,function({text:t,lang:n,fonts:r,style:i,weight:s,preResolvedFonts:a,unicodeFontsURL:o},l){const c=({chars:e,fonts:t})=>{let n,r;const i=[];for(let s=0;s<e.length;s++)e[s]!==r?(r=e[s],i.push(n={start:s,end:s,fontObj:t[e[s]]})):n.end=s;l(i)};a?c(a):e(t,c,{lang:n,fonts:r,style:i,weight:s,unicodeFontsURL:o})}({text:a,lang:d,style:p,weight:m,fonts:"string"==typeof u?[{src:u}]:u,unicodeFontsURL:T,preResolvedFonts:_},(e=>{k.fontLoad=c()-L;const u=isFinite(y);let d=null,f=null,m=null,p=null,T=null,_=null,F=null,O=null,U=0,Q=0,N="nowrap"!==w;const z=new Map,G=c();let H=C,q=0,Y=new h;const j=[Y];e.forEach((e=>{const{fontObj:t}=e,{ascender:n,descender:o,unitsPerEm:l,lineGap:c,capHeight:d,xHeight:f}=t;let m=z.get(t);if(!m){const e=A/l,r="normal"===v?(n-o+c)*e:v*A,i=(r-(n-o)*e)/2,s=Math.min(r,(n-o)*e),a=(n+o)/2*e+s/2;m={index:z.size,src:t.src,fontObj:t,fontSizeMult:e,unitsPerEm:l,ascender:n*e,descender:o*e,capHeight:d*e,xHeight:f*e,lineHeight:r,baseline:-i-n*e,caretTop:a,caretBottom:a-s},z.set(t,m)}const{fontSizeMult:p}=m,E=a.slice(e.start,e.end+1);let x,w;t.forEachGlyph(E,A,g,((t,n,o,l)=>{n+=q,l+=e.start,x=n,w=t;const c=a.charAt(l),d=t.advanceWidth*p,f=Y.count;let v;if("isEmpty"in t||(t.isWhitespace=!!c&&new RegExp(i).test(c),t.canBreakAfter=!!c&&s.test(c),t.isEmpty=t.xMin===t.xMax||t.yMin===t.yMax||r.test(c)),t.isWhitespace||t.isEmpty||Q++,N&&u&&!t.isWhitespace&&n+d+H>y&&f){if(Y.glyphAt(f-1).glyphObj.canBreakAfter)v=new h,H=-n;else for(let e=f;e--;){if(0===e&&"break-word"===I){v=new h,H=-n;break}if(Y.glyphAt(e).glyphObj.canBreakAfter){v=Y.splitAt(e+1);const t=v.glyphAt(0).x;H-=t;for(let e=v.count;e--;)v.glyphAt(e).x-=t;break}}v&&(Y.isSoftWrapped=!0,Y=v,j.push(Y),U=y)}let E=Y.glyphAt(Y.count);E.glyphObj=t,E.x=n+H,E.y=o,E.width=d,E.charIndex=l,E.fontData=m,"\n"===c&&(Y=new h,j.push(Y),H=-(n+d+g*A)+C)})),q=x+w.advanceWidth*p+g*A}));let V=0;j.forEach((e=>{let t=!0;for(let n=e.count;n--;){const r=e.glyphAt(n);t&&!r.glyphObj.isWhitespace&&(e.width=r.x+r.width,e.width>U&&(U=e.width),t=!1);let{lineHeight:i,capHeight:s,xHeight:a,baseline:o}=r.fontData;i>e.lineHeight&&(e.lineHeight=i);const l=o-e.baseline;l<0&&(e.baseline+=l,e.cap+=l,e.ex+=l),e.cap=Math.max(e.cap,e.baseline+s),e.ex=Math.max(e.ex,e.baseline+a)}e.baseline-=V,e.cap-=V,e.ex-=V,V+=e.lineHeight}));let K=0,W=0;if(b&&("number"==typeof b?K=-b:"string"==typeof b&&(K=-U*("left"===b?0:"center"===b?.5:"right"===b?1:o(b)))),S&&("number"==typeof S?W=-S:"string"==typeof S&&(W="top"===S?0:"top-baseline"===S?-j[0].baseline:"top-cap"===S?-j[0].cap:"top-ex"===S?-j[0].ex:"middle"===S?V/2:"bottom"===S?V:"bottom-baseline"===S?-j[j.length-1].baseline:o(S)*V)),!B){const e=t.getEmbeddingLevels(a,E);d=new Uint16Array(Q),f=new Uint8Array(Q),m=new Float32Array(2*Q),p={},F=[n,n,-1/0,-1/0],O=[],M&&(_=new Float32Array(4*a.length)),D&&(T=new Uint8Array(3*Q));let r,i,s=0,o=-1,c=-1;if(j.forEach(((h,u)=>{let{count:A,width:g}=h;if(A>0){let u=0;for(let e=A;e--&&h.glyphAt(e).glyphObj.isWhitespace;)u++;let v=0,y=0;if("center"===x)v=(U-g)/2;else if("right"===x)v=U-g;else if("justify"===x&&h.isSoftWrapped){let e=0;for(let t=A-u;t--;)h.glyphAt(t).glyphObj.isWhitespace&&e++;y=(U-g)/e}if(y||v){let e=0;for(let t=0;t<A;t++){let n=h.glyphAt(t);const r=n.glyphObj;n.x+=v+e,0!==y&&r.isWhitespace&&t<A-u&&(e+=y,n.width+=y)}}const E=t.getReorderSegments(a,e,h.glyphAt(0).charIndex,h.glyphAt(h.count-1).charIndex);for(let e=0;e<E.length;e++){const[t,n]=E[e];let r=1/0,i=-1/0;for(let e=0;e<A;e++)if(h.glyphAt(e).charIndex>=t){let t=e,s=e;for(;s<A;s++){let e=h.glyphAt(s);if(e.charIndex>n)break;s<A-u&&(r=Math.min(r,e.x),i=Math.max(i,e.x+e.width))}for(let e=t;e<s;e++){const t=h.glyphAt(e);t.x=i-(t.x+t.width-r)}break}}let C;const w=e=>C=e;for(let g=0;g<A;g++){const u=h.glyphAt(g);C=u.glyphObj;const A=C.index,v=1&e.levels[u.charIndex];if(v){const e=t.getMirroredCharacter(a[u.charIndex]);e&&u.fontData.fontObj.forEachGlyph(e,0,0,w)}if(M){const{charIndex:e,fontData:t}=u,n=u.x+K,r=u.x+u.width+K;_[4*e]=v?r:n,_[4*e+1]=v?n:r,_[4*e+2]=h.baseline+t.caretBottom+W,_[4*e+3]=h.baseline+t.caretTop+W;const i=e-o;i>1&&l(_,o,i),o=e}if(D){const{charIndex:e}=u;for(;e>c;)c++,D.hasOwnProperty(c)&&(i=D[c])}if(!C.isWhitespace&&!C.isEmpty){const e=s++,{fontSizeMult:t,src:a,index:o}=u.fontData,l=p[a]||(p[a]={});l[A]||(l[A]={path:C.path,pathBounds:[C.xMin,C.yMin,C.xMax,C.yMax]});const c=u.x+K,g=u.y+h.baseline+W;m[2*e]=c,m[2*e+1]=g;const v=c+C.xMin*t,y=g+C.yMin*t,E=c+C.xMax*t,x=g+C.yMax*t;v<F[0]&&(F[0]=v),y<F[1]&&(F[1]=y),E>F[2]&&(F[2]=E),x>F[3]&&(F[3]=x),e%R==0&&(r={start:e,end:e,rect:[n,n,-1/0,-1/0]},O.push(r)),r.end++;const w=r.rect;if(v<w[0]&&(w[0]=v),y<w[1]&&(w[1]=y),E>w[2]&&(w[2]=E),x>w[3]&&(w[3]=x),d[e]=A,f[e]=o,D){const t=3*e;T[t]=i>>16&255,T[t+1]=i>>8&255,T[t+2]=255&i}}}}})),_){const e=a.length-o;e>1&&l(_,o,e)}}const J=[];z.forEach((({index:e,src:t,unitsPerEm:n,ascender:r,descender:i,lineHeight:s,capHeight:a,xHeight:o})=>{J[e]={src:t,unitsPerEm:n,ascender:r,descender:i,lineHeight:s,capHeight:a,xHeight:o}})),k.typesetting=c()-G,P({glyphIds:d,glyphFontIndices:f,glyphPositions:m,glyphData:p,fontData:J,caretPositions:_,glyphColors:T,chunkedBounds:O,fontSize:A,topBaseline:W+j[0].baseline,blockBounds:[K,W-V,K+U,W],visibleBounds:F,timings:k})}))}function o(e){let t=e.match(/^([\d.]+)%$/),n=t?parseFloat(t[1]):NaN;return isNaN(n)?0:n/100}function l(e,t,n){const r=e[4*t],i=e[4*t+1],s=e[4*t+2],a=e[4*t+3],o=(i-r)/n;for(let l=0;l<n;l++){const n=4*(t+l);e[n]=r+o*l,e[n+1]=r+o*(l+1),e[n+2]=s,e[n+3]=a}}function c(){return(self.performance||Date).now()}function h(){this.data=[]}const u=["glyphObj","x","y","width","charIndex","fontData"];return h.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/u.length)},glyphAt(e){let t=h.flyweight;return t.data=this.data,t.index=e,t},splitAt(e){let t=new h;return t.data=this.data.splice(e*u.length),t}},h.flyweight=u.reduce(((e,t,n,r)=>(Object.defineProperty(e,t,{get(){return this.data[this.index*u.length+n]},set(e){this.data[this.index*u.length+n]=e}}),e)),{data:null,index:0}),{typeset:a,measure:function(e,t){a({...e,metricsOnly:!0},(e=>{const[n,r,i,s]=e.blockBounds;t({width:i-n,height:s-r})}))}}},Bi,di],init:(e,t,n)=>e(t,n())}),Zi=li({name:"Typesetter",dependencies:[$i],init:e=>function(t){return new Promise((n=>{e.typeset(t,n)}))},getTransferables(e){const t=[];for(let n in e)e[n]&&e[n].buffer&&t.push(e[n].buffer);return t}}),es=Zi.onMainThread;const ts={};const ns="aTroikaGlyphBounds",rs="aTroikaGlyphIndex";class is extends a.CmU{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new a.iyt,this.boundingBox=new a.NRn}computeBoundingSphere(){}computeBoundingBox(){}set detail(e){if(e!==this._detail){this._detail=e,("number"!=typeof e||e<1)&&(e=1);let t=function(e){let t=ts[e];return t||(t=ts[e]=new a.bdM(1,1,e,e).translate(.5,.5,0)),t}(e);["position","normal","uv"].forEach((e=>{this.attributes[e]=t.attributes[e].clone()})),this.setIndex(t.getIndex().clone())}}get detail(){return this._detail}set curveRadius(e){e!==this._curveRadius&&(this._curveRadius=e,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(e,t,n,r,i){this.updateAttributeData(ns,e,4),this.updateAttributeData(rs,t,1),this.updateAttributeData("aTroikaGlyphColor",i,3),this._blockBounds=n,this._chunkedBounds=r,this.instanceCount=t.length,this._updateBounds()}_updateBounds(){const e=this._blockBounds;if(e){const{curveRadius:t,boundingBox:n}=this;if(t){const{PI:r,floor:i,min:s,max:a,sin:o,cos:l}=Math,c=r/2,h=2*r,u=Math.abs(t),d=e[0]/u,f=e[2]/u,A=i((d+c)/h)!==i((f+c)/h)?-u:s(o(d)*u,o(f)*u),m=i((d-c)/h)!==i((f-c)/h)?u:a(o(d)*u,o(f)*u),p=i((d+r)/h)!==i((f+r)/h)?2*u:a(u-l(d)*u,u-l(f)*u);n.min.set(A,e[1],t<0?-p:0),n.max.set(m,e[3],t<0?0:p)}else n.min.set(e[0],e[1],0),n.max.set(e[2],e[3],0);n.getBoundingSphere(this.boundingSphere)}}applyClipRect(e){let t=this.getAttribute(rs).count,n=this._chunkedBounds;if(n)for(let r=n.length;r--;){t=n[r].end;let i=n[r].rect;if(i[1]<e.w&&i[3]>e.y&&i[0]<e.z&&i[2]>e.x)break}this.instanceCount=t}updateAttributeData(e,t,n){const r=this.getAttribute(e);t?r&&r.array.length===t.length?(r.array.set(t),r.needsUpdate=!0):(this.setAttribute(e,new a.uWO(t,n)),delete this._maxInstanceCount,this.dispose()):r&&this.deleteAttribute(e)}}function ss(e){const t=xi(e,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new a.I9Y},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new a.IUQ(0,0,0,0)},uTroikaClipRect:{value:new a.IUQ(0,0,0,0)},uTroikaEdgeOffset:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new a.I9Y},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new a.Q1f},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new a.dwI},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:"\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform vec4 uTroikaTotalBounds;\nuniform vec4 uTroikaClipRect;\nuniform mat3 uTroikaOrient;\nuniform bool uTroikaUseGlyphColors;\nuniform float uTroikaEdgeOffset;\nuniform float uTroikaBlurRadius;\nuniform vec2 uTroikaPositionOffset;\nuniform float uTroikaCurveRadius;\nattribute vec4 aTroikaGlyphBounds;\nattribute float aTroikaGlyphIndex;\nattribute vec3 aTroikaGlyphColor;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec3 vTroikaGlyphColor;\nvarying vec2 vTroikaGlyphDimensions;\n",vertexTransform:"\nvec4 bounds = aTroikaGlyphBounds;\nbounds.xz += uTroikaPositionOffset.x;\nbounds.yw -= uTroikaPositionOffset.y;\n\nvec4 outlineBounds = vec4(\n  bounds.xy - uTroikaEdgeOffset - uTroikaBlurRadius,\n  bounds.zw + uTroikaEdgeOffset + uTroikaBlurRadius\n);\nvec4 clippedBounds = vec4(\n  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),\n  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)\n);\n\nvec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);\n\nposition.xy = mix(bounds.xy, bounds.zw, clippedXY);\n\nuv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);\n\nfloat rad = uTroikaCurveRadius;\nif (rad != 0.0) {\n  float angle = position.x / rad;\n  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);\n  normal.xz = vec2(sin(angle), cos(angle));\n}\n  \nposition = uTroikaOrient * position;\nnormal = uTroikaOrient * normal;\n\nvTroikaGlyphUV = clippedXY.xy;\nvTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);\n\n\nfloat txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;\nvec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;\nvec2 txStartUV = txUvPerSquare * vec2(\n  mod(floor(aTroikaGlyphIndex / 4.0), txCols),\n  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)\n);\nvTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);\nvTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);\n",fragmentDefs:"\nuniform sampler2D uTroikaSDFTexture;\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform float uTroikaSDFExponent;\nuniform float uTroikaEdgeOffset;\nuniform float uTroikaFillOpacity;\nuniform float uTroikaBlurRadius;\nuniform vec3 uTroikaStrokeColor;\nuniform float uTroikaStrokeWidth;\nuniform float uTroikaStrokeOpacity;\nuniform bool uTroikaSDFDebug;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec2 vTroikaGlyphDimensions;\n\nfloat troikaSdfValueToSignedDistance(float alpha) {\n  // Inverse of exponential encoding in webgl-sdf-generator\n  \n  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);\n  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;\n  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);\n  return signedDist;\n}\n\nfloat troikaGlyphUvToSdfValue(vec2 glyphUV) {\n  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);\n  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);\n  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1\n  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;\n}\n\nfloat troikaGlyphUvToDistance(vec2 uv) {\n  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));\n}\n\nfloat troikaGetAADist() {\n  \n  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300\n  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;\n  #else\n  return vTroikaGlyphDimensions.x / 64.0;\n  #endif\n}\n\nfloat troikaGetFragDistValue() {\n  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);\n  float distance = troikaGlyphUvToDistance(clampedGlyphUV);\n \n  // Extrapolate distance when outside bounds:\n  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : \n    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);\n\n  \n\n  return distance;\n}\n\nfloat troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {\n  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)\n  float alpha = step(-distanceOffset, -distance);\n  #else\n\n  float alpha = smoothstep(\n    distanceOffset + aaDist,\n    distanceOffset - aaDist,\n    distance\n  );\n  #endif\n\n  return alpha;\n}\n",fragmentColorTransform:"\nfloat aaDist = troikaGetAADist();\nfloat fragDistance = troikaGetFragDistValue();\nfloat edgeAlpha = uTroikaSDFDebug ?\n  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :\n  troikaGetEdgeAlpha(fragDistance, uTroikaEdgeOffset, max(aaDist, uTroikaBlurRadius));\n\n#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)\nvec4 fillRGBA = gl_FragColor;\nfillRGBA.a *= uTroikaFillOpacity;\nvec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);\nif (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;\ngl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(\n  -uTroikaStrokeWidth - aaDist,\n  -uTroikaStrokeWidth + aaDist,\n  fragDistance\n));\ngl_FragColor.a *= edgeAlpha;\n#endif\n\nif (edgeAlpha == 0.0) {\n  discard;\n}\n",customRewriter({vertexShader:e,fragmentShader:t}){let n=/\buniform\s+vec3\s+diffuse\b/;return n.test(t)&&(t=t.replace(n,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),n.test(e)||(e=e.replace(fi,"uniform vec3 diffuse;\n$&\nvTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;\n"))),{vertexShader:e,fragmentShader:t}}});return t.transparent=!0,t.forceSinglePass=!0,Object.defineProperties(t,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),t}const as=new a.V9B({color:16777215,side:a.$EB,transparent:!0}),os=8421504,ls=new a.kn4,cs=new a.Pq0,hs=new a.Pq0,us=[],ds=new a.Pq0,fs="+x+y";function As(e){return Array.isArray(e)?e[0]:e}let ms=()=>{const e=new a.eaF(new a.bdM(1,1),as);return ms=()=>e,e},ps=()=>{const e=new a.eaF(new a.bdM(1,1,32,1),as);return ps=()=>e,e};const gs={type:"syncstart"},vs={type:"synccomplete"},ys=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],Es=ys.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");class xs extends a.eaF{constructor(){super(new is,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=os,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=fs,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(e){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(e):(this._isSyncing=!0,this.dispatchEvent(gs),ji({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},(t=>{this._isSyncing=!1,this._textRenderInfo=t,this.geometry.updateGlyphs(t.glyphBounds,t.glyphAtlasIndices,t.blockBounds,t.chunkedBounds,t.glyphColors);const n=this._queuedSyncs;n&&(this._queuedSyncs=null,this._needsSync=!0,this.sync((()=>{n.forEach((e=>e&&e()))}))),this.dispatchEvent(vs),e&&e()}))))}onBeforeRender(e,t,n,r,i,s){this.sync(),i.isTroikaTextMaterial&&this._prepareForRender(i)}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}createDerivedMaterial(e){return ss(e)}get material(){let e=this._derivedMaterial;const t=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=as.clone());if(e&&e.isDerivedFrom(t)||(e=this._derivedMaterial=this.createDerivedMaterial(t),t.addEventListener("dispose",(function n(){t.removeEventListener("dispose",n),e.dispose()}))),this.hasOutline()){let t=e._outlineMtl;return t||(t=e._outlineMtl=Object.create(e,{id:{value:e.id+.1}}),t.isTextOutlineMaterial=!0,t.depthWrite=!1,t.map=null,e.addEventListener("dispose",(function n(){e.removeEventListener("dispose",n),t.dispose()}))),[t,e]}return e}set material(e){e&&e.isTroikaTextMaterial?(this._derivedMaterial=e,this._baseMaterial=e.baseMaterial):this._baseMaterial=e}hasOutline(){return!!(this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY)}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(e){this.geometry.detail=e}get curveRadius(){return this.geometry.curveRadius}set curveRadius(e){this.geometry.curveRadius=e}get customDepthMaterial(){return As(this.material).getDepthMaterial()}get customDistanceMaterial(){return As(this.material).getDistanceMaterial()}_prepareForRender(e){const t=e.isTextOutlineMaterial,n=e.uniforms,r=this.textRenderInfo;if(r){const{sdfTexture:e,blockBounds:i}=r;n.uTroikaSDFTexture.value=e,n.uTroikaSDFTextureSize.value.set(e.image.width,e.image.height),n.uTroikaSDFGlyphSize.value=r.sdfGlyphSize,n.uTroikaSDFExponent.value=r.sdfExponent,n.uTroikaTotalBounds.value.fromArray(i),n.uTroikaUseGlyphColors.value=!t&&!!r.glyphColors;let s,a,o,l=0,c=0,h=0,u=0,d=0;if(t){let{outlineWidth:e,outlineOffsetX:t,outlineOffsetY:n,outlineBlur:r,outlineOpacity:i}=this;l=this._parsePercent(e)||0,c=Math.max(0,this._parsePercent(r)||0),s=i,u=this._parsePercent(t)||0,d=this._parsePercent(n)||0}else h=Math.max(0,this._parsePercent(this.strokeWidth)||0),h&&(o=this.strokeColor,n.uTroikaStrokeColor.value.set(null==o?os:o),a=this.strokeOpacity,null==a&&(a=1)),s=this.fillOpacity;n.uTroikaEdgeOffset.value=l,n.uTroikaPositionOffset.value.set(u,d),n.uTroikaBlurRadius.value=c,n.uTroikaStrokeWidth.value=h,n.uTroikaStrokeOpacity.value=a,n.uTroikaFillOpacity.value=null==s?1:s,n.uTroikaCurveRadius.value=this.curveRadius||0;let f=this.clipRect;if(f&&Array.isArray(f)&&4===f.length)n.uTroikaClipRect.value.fromArray(f);else{const e=100*(this.fontSize||.1);n.uTroikaClipRect.value.set(i[0]-e,i[1]-e,i[2]+e,i[3]+e)}this.geometry.applyClipRect(n.uTroikaClipRect.value)}n.uTroikaSDFDebug.value=!!this.debugSDF,e.polygonOffset=!!this.depthOffset,e.polygonOffsetFactor=e.polygonOffsetUnits=this.depthOffset||0;const i=t?this.outlineColor||0:this.color;if(null==i)delete e.color;else{const t=e.hasOwnProperty("color")?e.color:e.color=new a.Q1f;i===t._input&&"object"!=typeof i||t.set(t._input=i)}let s=this.orientation||fs;if(s!==e._orientation){let t=n.uTroikaOrient.value;s=s.replace(/[^-+xyz]/g,"");let r=s!==fs&&s.match(/^([-+])([xyz])([-+])([xyz])$/);if(r){let[,e,n,i,s]=r;cs.set(0,0,0)[n]="-"===e?1:-1,hs.set(0,0,0)[s]="-"===i?-1:1,ls.lookAt(ds,cs.cross(hs),hs),t.setFromMatrix4(ls)}else t.identity();e._orientation=s}}_parsePercent(e){if("string"==typeof e){let t=e.match(/^(-?[\d.]+)%$/),n=t?parseFloat(t[1]):NaN;e=(isNaN(n)?0:n/100)*this.fontSize}return e}localPositionToTextCoords(e,t=new a.I9Y){t.copy(e);const n=this.curveRadius;return n&&(t.x=Math.atan2(e.x,Math.abs(n)-Math.abs(e.z))*Math.abs(n)),t}worldPositionToTextCoords(e,t=new a.I9Y){return cs.copy(e),this.localPositionToTextCoords(this.worldToLocal(cs),t)}raycast(e,t){const{textRenderInfo:n,curveRadius:r}=this;if(n){const i=n.blockBounds,s=r?ps():ms(),a=s.geometry,{position:o,uv:l}=a.attributes;for(let e=0;e<l.count;e++){let t=i[0]+l.getX(e)*(i[2]-i[0]);const n=i[1]+l.getY(e)*(i[3]-i[1]);let s=0;r&&(s=r-Math.cos(t/r)*r,t=Math.sin(t/r)*r),o.setXYZ(e,t,n,s)}a.boundingSphere=this.geometry.boundingSphere,a.boundingBox=this.geometry.boundingBox,s.matrixWorld=this.matrixWorld,s.material.side=this.material.side,us.length=0,s.raycast(e,us);for(let e=0;e<us.length;e++)us[e].object=this,t.push(us[e])}}copy(e){const t=this.geometry;return super.copy(e),this.geometry=t,Es.forEach((t=>{this[t]=e[t]})),this}clone(){return(new this.constructor).copy(this)}}ys.forEach((e=>{const t="_private_"+e;Object.defineProperty(xs.prototype,e,{get(){return this[t]},set(e){e!==this[t]&&(this[t]=e,this._needsSync=!0)}})}));new a.NRn,new a.Q1f;new WeakMap;new WeakMap;var Cs=n(6749);const ws=i.forwardRef((({sdfGlyphSize:e=64,anchorX:t="center",anchorY:n="middle",font:s,fontSize:a=1,children:l,characters:c,onSync:h,...u},d)=>{const f=(0,o.A)((({invalidate:e})=>e)),[A]=i.useState((()=>new xs)),[m,p]=i.useMemo((()=>{const e=[];let t="";return i.Children.forEach(l,(n=>{"string"==typeof n||"number"==typeof n?t+=n:e.push(n)})),[e,t]}),[l]);return(0,Cs.DY)((()=>new Promise((e=>function({font:e,characters:t,sdfGlyphSize:n},r){ji({font:e,sdfGlyphSize:n,text:Array.isArray(t)?t.join("\n"):""+t},r)}({font:s,characters:c},e)))),["troika-text",s,c]),i.useLayoutEffect((()=>{A.sync((()=>{f(),h&&h(A)}))})),i.useEffect((()=>()=>A.dispose()),[A]),i.createElement("primitive",(0,r.A)({object:A,ref:d,font:s,text:p,anchorX:t,anchorY:n,fontSize:a,sdfGlyphSize:e},u),m)}));class Is extends a.QCA{constructor(e,t={}){const{bevelEnabled:n=!1,bevelSize:r=8,bevelThickness:i=10,font:s,height:a=50,size:o=100,lineHeight:l=1,letterSpacing:c=0,...h}=t;if(void 0===s)super();else{super(s.generateShapes(e,o,{lineHeight:l,letterSpacing:c}),{...h,bevelEnabled:n,bevelSize:r,bevelThickness:i,depth:a})}this.type="TextGeometry"}}function bs(e,t){if(t===a.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===a.rYR||t===a.O49){let n=e.getIndex();if(null===n){const t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const r=n.count-2,i=[];if(n)if(t===a.rYR)for(let e=1;e<=r;e++)i.push(n.getX(0)),i.push(n.getX(e)),i.push(n.getX(e+1));else for(let e=0;e<r;e++)e%2==0?(i.push(n.getX(e)),i.push(n.getX(e+1)),i.push(n.getX(e+2))):(i.push(n.getX(e+2)),i.push(n.getX(e+1)),i.push(n.getX(e)));i.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=e.clone();return s.setIndex(i),s.clearGroups(),s}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}function Ss(e,t=Math.PI/3){const n=Math.cos(t),r=100*(1+1e-10),i=[new a.Pq0,new a.Pq0,new a.Pq0],s=new a.Pq0,o=new a.Pq0,l=new a.Pq0,c=new a.Pq0;function h(e){return`${~~(e.x*r)},${~~(e.y*r)},${~~(e.z*r)}`}const u=e.index?e.toNonIndexed():e,d=u.attributes.position,f={};for(let p=0,g=d.count/3;p<g;p++){const e=3*p,t=i[0].fromBufferAttribute(d,e+0),n=i[1].fromBufferAttribute(d,e+1),r=i[2].fromBufferAttribute(d,e+2);s.subVectors(r,n),o.subVectors(t,n);const l=(new a.Pq0).crossVectors(s,o).normalize();for(let s=0;s<3;s++){const e=h(i[s]);e in f||(f[e]=[]),f[e].push(l)}}const A=new Float32Array(3*d.count),m=new a.THS(A,3,!1);for(let a=0,p=d.count/3;a<p;a++){const e=3*a,t=i[0].fromBufferAttribute(d,e+0),r=i[1].fromBufferAttribute(d,e+1),u=i[2].fromBufferAttribute(d,e+2);s.subVectors(u,r),o.subVectors(t,r),l.crossVectors(s,o).normalize();for(let s=0;s<3;s++){const t=f[h(i[s])];c.set(0,0,0);for(let e=0,r=t.length;e<r;e++){const r=t[e];l.dot(r)>n&&c.add(r)}c.normalize(),m.setXYZ(e+s,c.x,c.y,c.z)}}return u.setAttribute("normal",m),u}var Bs=Object.defineProperty,Ts=(e,t,n)=>(((e,t,n)=>{t in e?Bs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class _s extends a.aHM{constructor(e){super(e)}load(e,t,n,r){const i=new a.Y9S(this.manager);i.setPath(this.path),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(e=>{if("string"!=typeof e)throw new Error("unsupported data type");const n=JSON.parse(e),r=this.parse(n);t&&t(r)}),n,r)}loadAsync(e,t){return super.loadAsync(e,t)}parse(e){return new Ms(e)}}class Ms{constructor(e){Ts(this,"data"),Ts(this,"isFont",!0),Ts(this,"type","Font"),this.data=e}generateShapes(e,t=100,n){const r=[],i={letterSpacing:0,lineHeight:1,...n},s=function(e,t,n,r){const i=Array.from(e),s=t/n.resolution,a=(n.boundingBox.yMax-n.boundingBox.yMin+n.underlineThickness)*s,o=[];let l=0,c=0;for(let h=0;h<i.length;h++){const e=i[h];if("\n"===e)l=0,c-=a*r.lineHeight;else{const t=Rs(e,s,l,c,n);t&&(l+=t.offsetX+r.letterSpacing,o.push(t.path))}}return o}(e,t,this.data,i);for(let a=0,o=s.length;a<o;a++)Array.prototype.push.apply(r,s[a].toShapes(!1));return r}}function Rs(e,t,n,r,i){const s=i.glyphs[e]||i.glyphs["?"];if(!s)return void console.error('THREE.Font: character "'+e+'" does not exists in font family '+i.familyName+".");const o=new a.Ld9;let l,c,h,u,d,f,A,m;if(s.o){const e=s._cachedOutline||(s._cachedOutline=s.o.split(" "));for(let i=0,s=e.length;i<s;){switch(e[i++]){case"m":l=parseInt(e[i++])*t+n,c=parseInt(e[i++])*t+r,o.moveTo(l,c);break;case"l":l=parseInt(e[i++])*t+n,c=parseInt(e[i++])*t+r,o.lineTo(l,c);break;case"q":h=parseInt(e[i++])*t+n,u=parseInt(e[i++])*t+r,d=parseInt(e[i++])*t+n,f=parseInt(e[i++])*t+r,o.quadraticCurveTo(d,f,h,u);break;case"b":h=parseInt(e[i++])*t+n,u=parseInt(e[i++])*t+r,d=parseInt(e[i++])*t+n,f=parseInt(e[i++])*t+r,A=parseInt(e[i++])*t+n,m=parseInt(e[i++])*t+r,o.bezierCurveTo(d,f,A,m,h,u)}}}return{offsetX:s.ha*t,path:o}}let Ds=null;async function Ps(e){const t=await async function(e){return"string"==typeof e?await(await fetch(e)).json():e}(e);return n=t,Ds||(Ds=new _s),Ds.parse(n);var n}function Ls(e){return(0,Cs.DY)(Ps,[e])}Ls.preload=e=>(0,Cs.uv)(Ps,[e]),Ls.clear=e=>(0,Cs.IU)([e]);const ks=["string","number"],Fs=i.forwardRef((({font:e,letterSpacing:t=0,lineHeight:n=1,size:s=1,height:l=.2,bevelThickness:c=.1,bevelSize:h=.01,bevelEnabled:u=!1,bevelOffset:d=0,bevelSegments:f=4,curveSegments:A=8,smooth:m,children:p,...g},v)=>{i.useMemo((()=>(0,o.e)({RenamedTextGeometry:Is})),[]);const y=i.useRef(null),E=Ls(e),x=(0,i.useMemo)((()=>({font:E,size:s,height:l,bevelThickness:c,bevelSize:h,bevelEnabled:u,bevelSegments:f,bevelOffset:d,curveSegments:A,letterSpacing:t,lineHeight:n})),[E,s,l,c,h,u,f,d,A,t,n]),[C,...w]=(0,i.useMemo)((()=>(e=>{let t="";const n=[];return i.Children.forEach(e,(e=>{ks.includes(typeof e)?t+=e+"":n.push(e)})),[t,...n]})(p)),[p]),I=i.useMemo((()=>[C,x]),[C,x]);return i.useLayoutEffect((()=>{m&&(y.current.geometry=function(e,t=1e-4){t=Math.max(t,Number.EPSILON);const n={},r=e.getIndex(),i=e.getAttribute("position"),s=r?r.count:i.count;let o=0;const l=Object.keys(e.attributes),c={},h={},u=[],d=["getX","getY","getZ","getW"];for(let a=0,p=l.length;a<p;a++){const t=l[a];c[t]=[];const n=e.morphAttributes[t];n&&(h[t]=new Array(n.length).fill(0).map((()=>[])))}const f=Math.log10(1/t),A=Math.pow(10,f);for(let a=0;a<s;a++){const t=r?r.getX(a):a;let i="";for(let n=0,r=l.length;n<r;n++){const r=l[n],s=e.getAttribute(r),a=s.itemSize;for(let e=0;e<a;e++)i+=~~(s[d[e]](t)*A)+","}if(i in n)u.push(n[i]);else{for(let n=0,r=l.length;n<r;n++){const r=l[n],i=e.getAttribute(r),s=e.morphAttributes[r],a=i.itemSize,o=c[r],u=h[r];for(let e=0;e<a;e++){const n=d[e];if(o.push(i[n](t)),s)for(let e=0,r=s.length;e<r;e++)u[e].push(s[e][n](t))}}n[i]=o,u.push(o),o++}}const m=e.clone();for(let p=0,g=l.length;p<g;p++){const t=l[p],n=e.getAttribute(t),r=new n.array.constructor(c[t]),i=new a.THS(r,n.itemSize,n.normalized);if(m.setAttribute(t,i),t in h)for(let s=0;s<h[t].length;s++){const n=e.morphAttributes[t][s],r=new n.array.constructor(h[t][s]),i=new a.THS(r,n.itemSize,n.normalized);m.morphAttributes[t][s]=i}}return m.setIndex(u),m}(y.current.geometry,m),y.current.geometry.computeVertexNormals())}),[I,m]),i.useImperativeHandle(v,(()=>y.current),[]),i.createElement("mesh",(0,r.A)({},g,{ref:y}),i.createElement("renamedTextGeometry",{args:I}),w)})),Os={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n    varying vec2 vUv;\n\n    void main() {\n\n    \tvUv = uv;\n    \tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n    }\n  ",fragmentShader:"\n    uniform float opacity;\n\n    uniform sampler2D tDiffuse;\n\n    varying vec2 vUv;\n\n    void main() {\n\n    \tvec4 texel = texture2D( tDiffuse, vUv );\n    \tgl_FragColor = opacity * texel;\n\n    }\n  "};var Us=Object.defineProperty,Qs=(e,t,n)=>(((e,t,n)=>{t in e?Us(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Ns{constructor(){Qs(this,"enabled",!0),Qs(this,"needsSwap",!0),Qs(this,"clear",!1),Qs(this,"renderToScreen",!1)}setSize(e,t){}render(e,t,n,r,i){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}class zs{constructor(e){Qs(this,"camera",new a.qUd(-1,1,1,-1,0,1)),Qs(this,"geometry",new a.bdM(2,2)),Qs(this,"mesh"),this.mesh=new a.eaF(this.geometry,e)}get material(){return this.mesh.material}set material(e){this.mesh.material=e}dispose(){this.mesh.geometry.dispose()}render(e){e.render(this.mesh,this.camera)}}var Gs=Object.defineProperty,Hs=(e,t,n)=>(((e,t,n)=>{t in e?Gs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class qs extends Ns{constructor(e,t="tDiffuse"){super(),Hs(this,"textureID"),Hs(this,"uniforms"),Hs(this,"material"),Hs(this,"fsQuad"),this.textureID=t,e instanceof a.BKk?(this.uniforms=e.uniforms,this.material=e):(this.uniforms=a.LlO.clone(e.uniforms),this.material=new a.BKk({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new zs(this.material)}render(e,t,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.fsQuad.dispose(),this.material.dispose()}}var Ys=Object.defineProperty,js=(e,t,n)=>(((e,t,n)=>{t in e?Ys(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Vs extends Ns{constructor(e,t){super(),js(this,"scene"),js(this,"camera"),js(this,"inverse"),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,n){const r=e.getContext(),i=e.state;let s,a;i.buffers.color.setMask(!1),i.buffers.depth.setMask(!1),i.buffers.color.setLocked(!0),i.buffers.depth.setLocked(!0),this.inverse?(s=0,a=1):(s=1,a=0),i.buffers.stencil.setTest(!0),i.buffers.stencil.setOp(r.REPLACE,r.REPLACE,r.REPLACE),i.buffers.stencil.setFunc(r.ALWAYS,s,4294967295),i.buffers.stencil.setClear(a),i.buffers.stencil.setLocked(!0),e.setRenderTarget(n),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),i.buffers.color.setLocked(!1),i.buffers.depth.setLocked(!1),i.buffers.stencil.setLocked(!1),i.buffers.stencil.setFunc(r.EQUAL,1,4294967295),i.buffers.stencil.setOp(r.KEEP,r.KEEP,r.KEEP),i.buffers.stencil.setLocked(!0)}}class Ks extends Ns{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}var Ws=Object.defineProperty,Js=(e,t,n)=>(((e,t,n)=>{t in e?Ws(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Xs{constructor(e,t){if(Js(this,"renderer"),Js(this,"_pixelRatio"),Js(this,"_width"),Js(this,"_height"),Js(this,"renderTarget1"),Js(this,"renderTarget2"),Js(this,"writeBuffer"),Js(this,"readBuffer"),Js(this,"renderToScreen"),Js(this,"passes",[]),Js(this,"copyPass"),Js(this,"clock"),this.renderer=e,void 0===t){const n={minFilter:a.k6q,magFilter:a.k6q,format:a.GWd},r=e.getSize(new a.I9Y);this._pixelRatio=e.getPixelRatio(),this._width=r.width,this._height=r.height,(t=new a.nWS(this._width*this._pixelRatio,this._height*this._pixelRatio,n)).texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,void 0===Os&&console.error("THREE.EffectComposer relies on CopyShader"),void 0===qs&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new qs(Os),this.copyPass.material.blending=a.XIg,this.clock=new a.zD7}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);-1!==t&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){void 0===e&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let n=!1;const r=this.passes.length;for(let i=0;i<r;i++){const t=this.passes[i];if(!1!==t.enabled){if(t.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(i),t.render(this.renderer,this.writeBuffer,this.readBuffer,e,n),t.needsSwap){if(n){const t=this.renderer.getContext(),n=this.renderer.state.buffers.stencil;n.setFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),n.setFunc(t.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==Vs&&(t instanceof Vs?n=!0:t instanceof Ks&&(n=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(void 0===e){const t=this.renderer.getSize(new a.I9Y);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,(e=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const n=this._width*this._pixelRatio,r=this._height*this._pixelRatio;this.renderTarget1.setSize(n,r),this.renderTarget2.setSize(n,r);for(let i=0;i<this.passes.length;i++)this.passes[i].setSize(n,r)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}var $s=Object.defineProperty,Zs=(e,t,n)=>(((e,t,n)=>{t in e?$s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class ea extends Ns{constructor(e,t,n,r,i=0){super(),Zs(this,"scene"),Zs(this,"camera"),Zs(this,"overrideMaterial"),Zs(this,"clearColor"),Zs(this,"clearAlpha"),Zs(this,"clearDepth",!1),Zs(this,"_oldClearColor",new a.Q1f),this.scene=e,this.camera=t,this.overrideMaterial=n,this.clearColor=r,this.clearAlpha=i,this.clear=!0,this.needsSwap=!1}render(e,t,n){let r,i=e.autoClear;e.autoClear=!1;let s=null;void 0!==this.overrideMaterial&&(s=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),r=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:n),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,r),void 0!==this.overrideMaterial&&(this.scene.overrideMaterial=s),e.autoClear=i}}const ta={uniforms:{tDiffuse:{value:null}},vertexShader:"\n    varying vec2 vUv;\n\n    void main() {\n\n    \tvUv = uv;\n    \tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n    }\n  ",fragmentShader:"\n    uniform sampler2D tDiffuse;\n\n    varying vec2 vUv;\n\n    void main() {\n\n    \tvec4 tex = texture2D( tDiffuse, vUv );\n\n    \t#ifdef LinearTosRGB\n    \t\tgl_FragColor = LinearTosRGB( tex );\n    \t#else\n    \t\tgl_FragColor = sRGBTransferOETF( tex );\n    \t#endif\n\n    }\n  "},na=()=>{try{var e=document.createElement("canvas");return!(!window.WebGL2RenderingContext||!e.getContext("webgl2"))}catch(Sf){return!1}},ra=i.forwardRef((({children:e,multisamping:t=8,renderIndex:n=1,disableRender:s,disableGamma:l,disableRenderPass:c,depthBuffer:h=!0,stencilBuffer:u=!1,anisotropy:d=1,colorSpace:f,type:A,...m},p)=>{i.useMemo((()=>(0,o.e)({EffectComposer:Xs,RenderPass:ea,ShaderPass:qs})),[]);const g=i.useRef(null);i.useImperativeHandle(p,(()=>g.current),[]);const{scene:v,camera:y,gl:E,size:x,viewport:C}=(0,o.A)(),[w]=i.useState((()=>{const e=new a.nWS(x.width,x.height,{type:A||a.ix0,format:a.GWd,depthBuffer:h,stencilBuffer:u,anisotropy:d});return A===a.OUM&&null!=f&&(e.texture.colorSpace=f),e.samples=t,e}));i.useEffect((()=>{var e,t;null==(e=g.current)||e.setSize(x.width,x.height),null==(t=g.current)||t.setPixelRatio(C.dpr)}),[E,x,C.dpr]),(0,o.C)((()=>{var e;s||null==(e=g.current)||e.render()}),n);const I=[];return c||I.push(i.createElement("renderPass",{key:"renderpass",attach:`passes-${I.length}`,args:[v,y]})),l||I.push(i.createElement("shaderPass",{attach:`passes-${I.length}`,key:"gammapass",args:[ta]})),i.Children.forEach(e,(e=>{e&&I.push(i.cloneElement(e,{key:I.length,attach:`passes-${I.length}`}))})),i.createElement("effectComposer",(0,r.A)({ref:g,args:[E,w]},m),I)}));let ia=function(e){return e.Linear="linear",e.Radial="radial",e}({});function sa({stops:e,colors:t,size:n=1024,width:s=16,type:l=ia.Linear,innerCircleRadius:c=0,outerCircleRadius:h="auto",...u}){const d=(0,o.A)((e=>e.gl)),f=i.useMemo((()=>{const r=document.createElement("canvas"),i=r.getContext("2d");let o;if(r.width=s,r.height=n,l===ia.Linear)o=i.createLinearGradient(0,0,0,n);else{const e=r.width/2,t=r.height/2,n="auto"!==h?Math.abs(Number(h)):Math.sqrt(e**2+t**2);o=i.createRadialGradient(e,t,Math.abs(c),e,t,n)}const u=new a.Q1f;let d=e.length;for(;d--;)o.addColorStop(e[d],u.set(t[d]).getStyle());return i.save(),i.fillStyle=o,i.fillRect(0,0,s,n),i.restore(),r}),[e]);return i.createElement("canvasTexture",(0,r.A)({colorSpace:d.outputColorSpace,args:[f],attach:"map"},u))}function aa(e,t,n,r){var i;return(i=class extends a.BKk{constructor(i){super({vertexShader:t,fragmentShader:n,...i});for(const t in e)this.uniforms[t]=new a.nc$(e[t]),Object.defineProperty(this,t,{get(){return this.uniforms[t].value},set(e){this.uniforms[t].value=e}});null==r||r(this)}}).key=a.cj9.generateUUID(),i}const oa=e=>e===Object(e)&&!Array.isArray(e)&&"function"!=typeof e;function la(e,t){const n=(0,o.A)((e=>e.gl)),r=(0,o.F)(a.Tap,oa(e)?Object.values(e):e);(0,i.useLayoutEffect)((()=>{null==t||t(r)}),[t]),(0,i.useEffect)((()=>{if("initTexture"in n){let e=[];Array.isArray(r)?e=r:r instanceof a.gPd?e=[r]:oa(r)&&(e=Object.values(r)),e.forEach((e=>{e instanceof a.gPd&&n.initTexture(e)}))}}),[n,r]);const s=(0,i.useMemo)((()=>{if(oa(e)){const t={};let n=0;for(const i in e)t[i]=r[n++];return t}return r}),[e,r]);return s}la.preload=e=>o.F.preload(a.Tap,e),la.clear=e=>o.F.clear(a.Tap,e);const ca=({children:e,input:t,onLoad:n})=>{const r=la(t,n);return i.createElement(i.Fragment,null,null==e?void 0:e(r))},ha=(()=>parseInt(a.sPf.replace(/\D+/g,"")))(),ua=aa({color:new a.Q1f("white"),scale:new a.I9Y(1,1),imageBounds:new a.I9Y(1,1),resolution:1024,map:null,zoom:1,radius:0,grayscale:0,opacity:1},"\n  varying vec2 vUv;\n  varying vec2 vPos;\n  void main() {\n    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);\n    vUv = uv;\n    vPos = position.xy;\n  }\n",`\n  // mostly from https://gist.github.com/statico/df64c5d167362ecf7b34fca0b1459a44\n  varying vec2 vUv;\n  varying vec2 vPos;\n  uniform vec2 scale;\n  uniform vec2 imageBounds;\n  uniform float resolution;\n  uniform vec3 color;\n  uniform sampler2D map;\n  uniform float radius;\n  uniform float zoom;\n  uniform float grayscale;\n  uniform float opacity;\n  const vec3 luma = vec3(.299, 0.587, 0.114);\n  vec4 toGrayscale(vec4 color, float intensity) {\n    return vec4(mix(color.rgb, vec3(dot(color.rgb, luma)), intensity), color.a);\n  }\n  vec2 aspect(vec2 size) {\n    return size / min(size.x, size.y);\n  }\n  \n  const float PI = 3.14159265;\n    \n  // from https://iquilezles.org/articles/distfunctions\n  float udRoundBox( vec2 p, vec2 b, float r ) {\n    return length(max(abs(p)-b+r,0.0))-r;\n  }\n\n  void main() {\n    vec2 s = aspect(scale);\n    vec2 i = aspect(imageBounds);\n    float rs = s.x / s.y;\n    float ri = i.x / i.y;\n    vec2 new = rs < ri ? vec2(i.x * s.y / i.y, s.y) : vec2(s.x, i.y * s.x / i.x);\n    vec2 offset = (rs < ri ? vec2((new.x - s.x) / 2.0, 0.0) : vec2(0.0, (new.y - s.y) / 2.0)) / new;\n    vec2 uv = vUv * s / new + offset;\n    vec2 zUv = (uv - vec2(0.5, 0.5)) / zoom + vec2(0.5, 0.5);\n\n    vec2 res = vec2(scale * resolution);\n    vec2 halfRes = 0.5 * res;\n    float b = udRoundBox(vUv.xy * res - halfRes, halfRes, resolution * radius);    \n\t  vec3 a = mix(vec3(1.0,0.0,0.0), vec3(0.0,0.0,0.0), smoothstep(0.0, 1.0, b));\n    gl_FragColor = toGrayscale(texture2D(map, zUv) * vec4(color, opacity * a), grayscale);\n    \n    #include <tonemapping_fragment>\n    #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n  }\n`),da=i.forwardRef((({children:e,color:t,segments:n=1,scale:s=1,zoom:a=1,grayscale:l=0,opacity:c=1,radius:h=0,texture:u,toneMapped:d,transparent:f,side:A,...m},p)=>{(0,o.e)({ImageMaterial:ua});const g=i.useRef(null),v=(0,o.A)((e=>e.size)),y=Array.isArray(s)?[s[0],s[1]]:[s,s],E=[u.image.width,u.image.height],x=Math.max(v.width,v.height);return i.useImperativeHandle(p,(()=>g.current),[]),i.useLayoutEffect((()=>{g.current.geometry.parameters&&g.current.material.scale.set(y[0]*g.current.geometry.parameters.width,y[1]*g.current.geometry.parameters.height)}),[y[0],y[1]]),i.createElement("mesh",(0,r.A)({ref:g,scale:Array.isArray(s)?[...s,1]:s},m),i.createElement("planeGeometry",{args:[1,1,n,n]}),i.createElement("imageMaterial",{color:t,map:u,zoom:a,grayscale:l,opacity:c,scale:y,imageBounds:E,resolution:x,radius:h,toneMapped:d,transparent:f,side:A,key:ua.key}),e)})),fa=i.forwardRef((({url:e,...t},n)=>{const s=la(e);return i.createElement(da,(0,r.A)({},t,{texture:s,ref:n}))})),Aa=i.forwardRef((({url:e,...t},n)=>i.createElement(da,(0,r.A)({},t,{ref:n})))),ma=i.forwardRef(((e,t)=>{if(e.url)return i.createElement(fa,(0,r.A)({},e,{ref:t}));if(e.texture)return i.createElement(Aa,(0,r.A)({},e,{ref:t}));throw new Error("<Image /> requires a url or texture")})),pa=i.forwardRef((({threshold:e=15,geometry:t,...n},s)=>{const o=i.useRef(null);i.useImperativeHandle(s,(()=>o.current),[]);const l=i.useMemo((()=>[0,0,0,1,0,0]),[]),c=i.useRef(null),h=i.useRef(null);return i.useLayoutEffect((()=>{const n=o.current.parent,r=null!=t?t:null==n?void 0:n.geometry;if(!r)return;if(c.current===r&&h.current===e)return;c.current=r,h.current=e;const i=new a.TDQ(r,e).attributes.position.array;o.current.geometry.setPositions(i),o.current.geometry.attributes.instanceStart.needsUpdate=!0,o.current.geometry.attributes.instanceEnd.needsUpdate=!0,o.current.computeLineDistances()})),i.createElement(Kr,(0,r.A)({segments:!0,points:l,ref:o,raycast:()=>null},n))})),ga=aa({screenspace:!1,color:new a.Q1f("black"),opacity:1,thickness:.05,size:new a.I9Y},"#include <common>\n   #include <morphtarget_pars_vertex>\n   #include <skinning_pars_vertex>\n   #include <clipping_planes_pars_vertex>\n   uniform float thickness;\n   uniform bool screenspace;\n   uniform vec2 size;\n   void main() {\n     #if defined (USE_SKINNING)\n\t     #include <beginnormal_vertex>\n       #include <morphnormal_vertex>\n       #include <skinbase_vertex>\n       #include <skinnormal_vertex>\n       #include <defaultnormal_vertex>\n     #endif\n     #include <begin_vertex>\n\t   #include <morphtarget_vertex>\n\t   #include <skinning_vertex>\n     #include <project_vertex>\n     #include <clipping_planes_vertex>\n     vec4 tNormal = vec4(normal, 0.0);\n     vec4 tPosition = vec4(transformed, 1.0);\n     #ifdef USE_INSTANCING\n       tNormal = instanceMatrix * tNormal;\n       tPosition = instanceMatrix * tPosition;\n     #endif\n     if (screenspace) {\n       vec3 newPosition = tPosition.xyz + tNormal.xyz * thickness;\n       gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0); \n     } else {\n       vec4 clipPosition = projectionMatrix * modelViewMatrix * tPosition;\n       vec4 clipNormal = projectionMatrix * modelViewMatrix * tNormal;\n       vec2 offset = normalize(clipNormal.xy) * thickness / size * clipPosition.w * 2.0;\n       clipPosition.xy += offset;\n       gl_Position = clipPosition;\n     }\n   }",`uniform vec3 color;\n   uniform float opacity;\n   #include <clipping_planes_pars_fragment>\n   void main(){\n     #include <clipping_planes_fragment>\n     gl_FragColor = vec4(color, opacity);\n     #include <tonemapping_fragment>\n     #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n   }`);function va({color:e="black",opacity:t=1,transparent:n=!1,screenspace:s=!1,toneMapped:l=!0,polygonOffset:c=!1,polygonOffsetFactor:h=0,renderOrder:u=0,thickness:d=.05,angle:f=Math.PI,clippingPlanes:A,...m}){const p=i.useRef(null),[g]=i.useState((()=>new ga({side:a.hsX}))),{gl:v}=(0,o.A)(),y=v.getDrawingBufferSize(new a.I9Y);i.useMemo((()=>(0,o.e)({OutlinesMaterial:ga})),[]);const E=i.useRef(0),x=i.useRef(null);return i.useLayoutEffect((()=>{const e=p.current;if(!e)return;const t=e.parent;if(t&&t.geometry&&(E.current!==f||x.current!==t.geometry)){var n;E.current=f,x.current=t.geometry;let r=null==(n=e.children)?void 0:n[0];r&&(f&&r.geometry.dispose(),e.remove(r)),t.skeleton?(r=new a.I46,r.material=g,r.bind(t.skeleton,t.bindMatrix),e.add(r)):t.isInstancedMesh?(r=new a.ZLX(t.geometry,g,t.count),r.instanceMatrix=t.instanceMatrix,e.add(r)):(r=new a.eaF,r.material=g,e.add(r)),r.geometry=f?Ss(t.geometry,f):t.geometry,r.morphTargetInfluences=t.morphTargetInfluences,r.morphTargetDictionary=t.morphTargetDictionary}})),i.useLayoutEffect((()=>{const r=p.current;if(!r)return;const i=r.children[0];if(i){i.renderOrder=u;const a=r.parent;(0,o.q)(i,{morphTargetInfluences:a.morphTargetInfluences,morphTargetDictionary:a.morphTargetDictionary}),(0,o.q)(i.material,{transparent:n,thickness:d,color:e,opacity:t,size:y,screenspace:s,toneMapped:l,polygonOffset:c,polygonOffsetFactor:h,clippingPlanes:A,clipping:A&&A.length>0})}})),i.useEffect((()=>()=>{const e=p.current;if(!e)return;const t=e.children[0];t&&(f&&t.geometry.dispose(),e.remove(t))}),[]),i.createElement("group",(0,r.A)({ref:p},m))}var ya=Object.defineProperty,Ea=(e,t,n)=>(((e,t,n)=>{t in e?ya(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);function xa(e,t,n,r,i){let s;if(e=e.subarray||e.slice?e:e.buffer,n=n.subarray||n.slice?n:n.buffer,e=t?e.subarray?e.subarray(t,i&&t+i):e.slice(t,i&&t+i):e,n.set)n.set(e,r);else for(s=0;s<e.length;s++)n[s+r]=e[s];return n}class Ca extends a.LoY{constructor(){super(),Ea(this,"type","MeshLine"),Ea(this,"isMeshLine",!0),Ea(this,"positions",[]),Ea(this,"previous",[]),Ea(this,"next",[]),Ea(this,"side",[]),Ea(this,"width",[]),Ea(this,"indices_array",[]),Ea(this,"uvs",[]),Ea(this,"counters",[]),Ea(this,"widthCallback",null),Ea(this,"_attributes"),Ea(this,"_points",[]),Ea(this,"points"),Ea(this,"matrixWorld",new a.kn4),Object.defineProperties(this,{points:{enumerable:!0,get(){return this._points},set(e){this.setPoints(e,this.widthCallback)}}})}setMatrixWorld(e){this.matrixWorld=e}setPoints(e,t){if(e=function(e){return e instanceof Float32Array?e:e instanceof a.LoY?e.getAttribute("position").array:e.map((e=>{const t=Array.isArray(e);return e instanceof a.Pq0?[e.x,e.y,e.z]:e instanceof a.I9Y?[e.x,e.y,0]:t&&3===e.length?[e[0],e[1],e[2]]:t&&2===e.length?[e[0],e[1],0]:e})).flat()}(e),this._points=e,this.widthCallback=null!=t?t:null,this.positions=[],this.counters=[],e.length&&e[0]instanceof a.Pq0)for(let n=0;n<e.length;n++){const t=e[n],r=n/(e.length-1);this.positions.push(t.x,t.y,t.z),this.positions.push(t.x,t.y,t.z),this.counters.push(r),this.counters.push(r)}else for(let n=0;n<e.length;n+=3){const t=n/(e.length-1);this.positions.push(e[n],e[n+1],e[n+2]),this.positions.push(e[n],e[n+1],e[n+2]),this.counters.push(t),this.counters.push(t)}this.process()}compareV3(e,t){const n=6*e,r=6*t;return this.positions[n]===this.positions[r]&&this.positions[n+1]===this.positions[r+1]&&this.positions[n+2]===this.positions[r+2]}copyV3(e){const t=6*e;return[this.positions[t],this.positions[t+1],this.positions[t+2]]}process(){const e=this.positions.length/6;let t,n;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],n=this.compareV3(0,e-1)?this.copyV3(e-2):this.copyV3(0),this.previous.push(n[0],n[1],n[2]),this.previous.push(n[0],n[1],n[2]);for(let r=0;r<e;r++){if(this.side.push(1),this.side.push(-1),t=this.widthCallback?this.widthCallback(r/(e-1)):1,this.width.push(t),this.width.push(t),this.uvs.push(r/(e-1),0),this.uvs.push(r/(e-1),1),r<e-1){n=this.copyV3(r),this.previous.push(n[0],n[1],n[2]),this.previous.push(n[0],n[1],n[2]);const e=2*r;this.indices_array.push(e,e+1,e+2),this.indices_array.push(e+2,e+1,e+3)}r>0&&(n=this.copyV3(r),this.next.push(n[0],n[1],n[2]),this.next.push(n[0],n[1],n[2]))}n=this.compareV3(e-1,0)?this.copyV3(1):this.copyV3(e-1),this.next.push(n[0],n[1],n[2]),this.next.push(n[0],n[1],n[2]),this._attributes&&this._attributes.position.count===this.counters.length?(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0):this._attributes={position:new a.THS(new Float32Array(this.positions),3),previous:new a.THS(new Float32Array(this.previous),3),next:new a.THS(new Float32Array(this.next),3),side:new a.THS(new Float32Array(this.side),1),width:new a.THS(new Float32Array(this.width),1),uv:new a.THS(new Float32Array(this.uvs),2),index:new a.THS(new Uint16Array(this.indices_array),1),counters:new a.THS(new Float32Array(this.counters),1)},this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()}advance({x:e,y:t,z:n}){const r=this._attributes.position.array,i=this._attributes.previous.array,s=this._attributes.next.array,a=r.length;xa(r,0,i,0,a),xa(r,6,r,0,a-6),r[a-6]=e,r[a-5]=t,r[a-4]=n,r[a-3]=e,r[a-2]=t,r[a-1]=n,xa(r,6,s,0,a-6),s[a-6]=e,s[a-5]=t,s[a-4]=n,s[a-3]=e,s[a-2]=t,s[a-1]=n,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0}}const wa=`\n  #include <fog_pars_fragment>\n  #include <logdepthbuf_pars_fragment>\n  #include <clipping_planes_pars_fragment>\n  \n  uniform sampler2D map;\n  uniform sampler2D alphaMap;\n  uniform float useGradient;\n  uniform float useMap;\n  uniform float useAlphaMap;\n  uniform float useDash;\n  uniform float dashArray;\n  uniform float dashOffset;\n  uniform float dashRatio;\n  uniform float visibility;\n  uniform float alphaTest;\n  uniform vec2 repeat;\n  uniform vec3 gradient[2];\n  \n  varying vec2 vUV;\n  varying vec4 vColor;\n  varying float vCounters;\n  \n  void main() {\n    #include <logdepthbuf_fragment>\n    vec4 diffuseColor = vColor;\n    if (useGradient == 1.) diffuseColor = vec4(mix(gradient[0], gradient[1], vCounters), 1.0);\n    if (useMap == 1.) diffuseColor *= texture2D(map, vUV * repeat);\n    if (useAlphaMap == 1.) diffuseColor.a *= texture2D(alphaMap, vUV * repeat).a;\n    if (diffuseColor.a < alphaTest) discard;\n    if (useDash == 1.) diffuseColor.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));\n    diffuseColor.a *= step(vCounters, visibility);\n    #include <clipping_planes_fragment>\n    gl_FragColor = diffuseColor;     \n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n    #include <${(()=>parseInt(a.sPf.replace(/\D+/g,"")))()>=154?"colorspace_fragment":"encodings_fragment"}>\n  }\n`;class Ia extends a.BKk{constructor(e){super({uniforms:{...br.UniformsLib.fog,lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new a.Q1f(16777215)},gradient:{value:[new a.Q1f(16711680),new a.Q1f(65280)]},opacity:{value:1},resolution:{value:new a.I9Y(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},useGradient:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new a.I9Y(1,1)}},vertexShader:"\n  #include <common>\n  #include <logdepthbuf_pars_vertex>\n  #include <fog_pars_vertex>\n  #include <clipping_planes_pars_vertex>\n\n  attribute vec3 previous;\n  attribute vec3 next;\n  attribute float side;\n  attribute float width;\n  attribute float counters;\n  \n  uniform vec2 resolution;\n  uniform float lineWidth;\n  uniform vec3 color;\n  uniform float opacity;\n  uniform float sizeAttenuation;\n  \n  varying vec2 vUV;\n  varying vec4 vColor;\n  varying float vCounters;\n  \n  vec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n    return res;\n  }\n  \n  void main() {\n    float aspect = resolution.x / resolution.y;\n    vColor = vec4(color, opacity);\n    vUV = uv;\n    vCounters = counters;\n  \n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4(position, 1.0) * aspect;\n    vec4 prevPos = m * vec4(previous, 1.0);\n    vec4 nextPos = m * vec4(next, 1.0);\n  \n    vec2 currentP = fix(finalPosition, aspect);\n    vec2 prevP = fix(prevPos, aspect);\n    vec2 nextP = fix(nextPos, aspect);\n  \n    float w = lineWidth * width;\n  \n    vec2 dir;\n    if (nextP == currentP) dir = normalize(currentP - prevP);\n    else if (prevP == currentP) dir = normalize(nextP - currentP);\n    else {\n      vec2 dir1 = normalize(currentP - prevP);\n      vec2 dir2 = normalize(nextP - currentP);\n      dir = normalize(dir1 + dir2);\n  \n      vec2 perp = vec2(-dir1.y, dir1.x);\n      vec2 miter = vec2(-dir.y, dir.x);\n      //w = clamp(w / dot(miter, perp), 0., 4. * lineWidth * width);\n    }\n  \n    //vec2 normal = (cross(vec3(dir, 0.), vec3(0., 0., 1.))).xy;\n    vec4 normal = vec4(-dir.y, dir.x, 0., 1.);\n    normal.xy *= .5 * w;\n    //normal *= projectionMatrix;\n    if (sizeAttenuation == 0.) {\n      normal.xy *= finalPosition.w;\n      normal.xy /= (vec4(resolution, 0., 1.) * projectionMatrix).xy * aspect;\n    }\n  \n    finalPosition.xy += normal.xy * side;\n    gl_Position = finalPosition;\n    #include <logdepthbuf_vertex>\n    #include <fog_vertex>\n    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n    #include <clipping_planes_vertex>\n    #include <fog_vertex>\n  }\n",fragmentShader:wa}),Ea(this,"lineWidth"),Ea(this,"map"),Ea(this,"useMap"),Ea(this,"alphaMap"),Ea(this,"useAlphaMap"),Ea(this,"color"),Ea(this,"gradient"),Ea(this,"resolution"),Ea(this,"sizeAttenuation"),Ea(this,"dashArray"),Ea(this,"dashOffset"),Ea(this,"dashRatio"),Ea(this,"useDash"),Ea(this,"useGradient"),Ea(this,"visibility"),Ea(this,"repeat"),this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get(){return this.uniforms.lineWidth.value},set(e){this.uniforms.lineWidth.value=e}},map:{enumerable:!0,get(){return this.uniforms.map.value},set(e){this.uniforms.map.value=e}},useMap:{enumerable:!0,get(){return this.uniforms.useMap.value},set(e){this.uniforms.useMap.value=e}},alphaMap:{enumerable:!0,get(){return this.uniforms.alphaMap.value},set(e){this.uniforms.alphaMap.value=e}},useAlphaMap:{enumerable:!0,get(){return this.uniforms.useAlphaMap.value},set(e){this.uniforms.useAlphaMap.value=e}},color:{enumerable:!0,get(){return this.uniforms.color.value},set(e){this.uniforms.color.value=e}},gradient:{enumerable:!0,get(){return this.uniforms.gradient.value},set(e){this.uniforms.gradient.value=e}},opacity:{enumerable:!0,get(){return this.uniforms.opacity.value},set(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get(){return this.uniforms.resolution.value},set(e){this.uniforms.resolution.value.copy(e)}},sizeAttenuation:{enumerable:!0,get(){return this.uniforms.sizeAttenuation.value},set(e){this.uniforms.sizeAttenuation.value=e}},dashArray:{enumerable:!0,get(){return this.uniforms.dashArray.value},set(e){this.uniforms.dashArray.value=e,this.useDash=0!==e?1:0}},dashOffset:{enumerable:!0,get(){return this.uniforms.dashOffset.value},set(e){this.uniforms.dashOffset.value=e}},dashRatio:{enumerable:!0,get(){return this.uniforms.dashRatio.value},set(e){this.uniforms.dashRatio.value=e}},useDash:{enumerable:!0,get(){return this.uniforms.useDash.value},set(e){this.uniforms.useDash.value=e}},useGradient:{enumerable:!0,get(){return this.uniforms.useGradient.value},set(e){this.uniforms.useGradient.value=e}},visibility:{enumerable:!0,get(){return this.uniforms.visibility.value},set(e){this.uniforms.visibility.value=e}},alphaTest:{enumerable:!0,get(){return this.uniforms.alphaTest.value},set(e){this.uniforms.alphaTest.value=e}},repeat:{enumerable:!0,get(){return this.uniforms.repeat.value},set(e){this.uniforms.repeat.value.copy(e)}}}),this.setValues(e)}copy(e){return super.copy(e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.gradient=e.gradient,this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray=e.dashArray,this.dashOffset=e.dashOffset,this.dashRatio=e.dashRatio,this.useDash=e.useDash,this.useGradient=e.useGradient,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this}}const ba={width:.2,length:1,decay:1,local:!1,stride:0,interval:1},Sa=(e,t=1)=>(e.set(e.subarray(t)),e.fill(-1/0,-t),e);function Ba(e,t){const{length:n,local:r,decay:s,interval:l,stride:c}={...ba,...t},h=i.useRef(null),[u]=i.useState((()=>new a.Pq0));i.useLayoutEffect((()=>{e&&(h.current=Float32Array.from({length:10*n*3},((t,n)=>e.position.getComponent(n%3))))}),[n,e]);const d=i.useRef(new a.Pq0),f=i.useRef(0);return(0,o.C)((()=>{if(e&&h.current){if(0===f.current){let t;r?t=e.position:(e.getWorldPosition(u),t=u);const n=1*s;for(let e=0;e<n;e++)t.distanceTo(d.current)<c||(Sa(h.current,3),h.current.set(t.toArray(),h.current.length-3));d.current.copy(t)}f.current++,f.current=f.current%l}})),h}const Ta=i.forwardRef(((e,t)=>{const{children:n}=e,{width:r,length:s,decay:l,local:c,stride:h,interval:u}={...ba,...e},{color:d="hotpink",attenuation:f,target:A}=e,m=(0,o.A)((e=>e.size)),p=(0,o.A)((e=>e.scene)),g=i.useRef(null),[v,y]=i.useState(null),E=Ba(v,{length:s,decay:l,local:c,stride:h,interval:u});i.useEffect((()=>{const e=(null==A?void 0:A.current)||g.current.children.find((e=>e instanceof a.B69));e&&y(e)}),[E,A]);const x=i.useMemo((()=>new Ca),[]),C=i.useMemo((()=>{var e,t;const i=new Ia({lineWidth:.1*r,color:d,sizeAttenuation:1,resolution:new a.I9Y(m.width,m.height)});let s;if(n)if(Array.isArray(n))s=n.find((e=>{const t=e;return"string"==typeof t.type&&"meshLineMaterial"===t.type}));else{const e=n;"string"==typeof e.type&&"meshLineMaterial"===e.type&&(s=e)}return"object"==typeof(null==(e=s)?void 0:e.props)&&null!==(null==(t=s)?void 0:t.props)&&i.setValues(s.props),i}),[r,d,m,n]);return i.useEffect((()=>{C.uniforms.resolution.value.set(m.width,m.height)}),[m]),(0,o.C)((()=>{E.current&&x.setPoints(E.current,f)})),i.createElement("group",null,(0,o.o)(i.createElement("mesh",{ref:t,geometry:x,material:C}),p),i.createElement("group",{ref:g},n))})),_a=new a.lMl,Ma=new a.Pq0;class Ra{constructor(e){let t=e.geometry;t.index&&(console.warn("THREE.MeshSurfaceSampler: Converting geometry to non-indexed BufferGeometry."),t=t.toNonIndexed()),this.geometry=t,this.randomFunction=Math.random,this.positionAttribute=this.geometry.getAttribute("position"),this.colorAttribute=this.geometry.getAttribute("color"),this.weightAttribute=null,this.distribution=null}setWeightAttribute(e){return this.weightAttribute=e?this.geometry.getAttribute(e):null,this}build(){const e=this.positionAttribute,t=this.weightAttribute,n=new Float32Array(e.count/3);for(let i=0;i<e.count;i+=3){let r=1;t&&(r=t.getX(i)+t.getX(i+1)+t.getX(i+2)),_a.a.fromBufferAttribute(e,i),_a.b.fromBufferAttribute(e,i+1),_a.c.fromBufferAttribute(e,i+2),r*=_a.getArea(),n[i/3]=r}this.distribution=new Float32Array(e.count/3);let r=0;for(let i=0;i<n.length;i++)r+=n[i],this.distribution[i]=r;return this}setRandomGenerator(e){return this.randomFunction=e,this}sample(e,t,n){const r=this.sampleFaceIndex();return this.sampleFace(r,e,t,n)}sampleFaceIndex(){const e=this.distribution[this.distribution.length-1];return this.binarySearch(this.randomFunction()*e)}binarySearch(e){const t=this.distribution;let n=0,r=t.length-1,i=-1;for(;n<=r;){const s=Math.ceil((n+r)/2);if(0===s||t[s-1]<=e&&t[s]>e){i=s;break}e<t[s]?r=s-1:n=s+1}return i}sampleFace(e,t,n,r){let i=this.randomFunction(),s=this.randomFunction();return i+s>1&&(i=1-i,s=1-s),_a.a.fromBufferAttribute(this.positionAttribute,3*e),_a.b.fromBufferAttribute(this.positionAttribute,3*e+1),_a.c.fromBufferAttribute(this.positionAttribute,3*e+2),t.set(0,0,0).addScaledVector(_a.a,i).addScaledVector(_a.b,s).addScaledVector(_a.c,1-(i+s)),void 0!==n&&_a.getNormal(n),void 0!==r&&void 0!==this.colorAttribute&&(_a.a.fromBufferAttribute(this.colorAttribute,3*e),_a.b.fromBufferAttribute(this.colorAttribute,3*e+1),_a.c.fromBufferAttribute(this.colorAttribute,3*e+2),Ma.set(0,0,0).addScaledVector(_a.a,i).addScaledVector(_a.b,s).addScaledVector(_a.c,1-(i+s)),r.r=Ma.x,r.g=Ma.y,r.b=Ma.z),this}}function Da(e,t=16,n,r,s){const[o,l]=i.useState((()=>{const e=Array.from({length:t},(()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])).flat();return new a.uWO(Float32Array.from(e),16)}));return i.useLayoutEffect((()=>{if(void 0===e.current)return;const i=new Ra(e.current);r&&i.setWeightAttribute(r),i.build();const c=new a.Pq0,h=new a.Pq0,u=new a.Q1f,d=new a.B69;e.current.updateMatrixWorld(!0);for(let r=0;r<t;r++)i.sample(c,h,u),"function"==typeof n?n({dummy:d,sampledMesh:e.current,position:c,normal:h,color:u},r):d.position.copy(c),d.updateMatrix(),null!=s&&s.current&&s.current.setMatrixAt(r,d.matrix),d.matrix.toArray(o.array,16*r);null!=s&&s.current&&(s.current.instanceMatrix.needsUpdate=!0),o.needsUpdate=!0,l(new a.uWO(o.array,o.itemSize).copy(o))}),[e,s,r,t,n]),o}function Pa({children:e,weight:t,transform:n,instances:s,mesh:a,count:o=16,...l}){const c=i.useRef(null),h=i.useRef(null),u=i.useRef(null);return i.useLayoutEffect((()=>{var e,t;h.current=null!==(e=null==s?void 0:s.current)&&void 0!==e?e:c.current.children.find((e=>e.hasOwnProperty("instanceMatrix"))),u.current=null!==(t=null==a?void 0:a.current)&&void 0!==t?t:c.current.children.find((e=>"Mesh"===e.type))}),[e,null==a?void 0:a.current,null==s?void 0:s.current]),Da(u,o,n,t,h),i.createElement("group",(0,r.A)({ref:c},l),e)}const La=({compute:e,name:t,...n})=>{const[s]=i.useState((()=>new a.THS(new Float32Array(0),1))),o=i.useRef(null);return i.useLayoutEffect((()=>{if(o.current){var t;const n=null!==(t=o.current.parent)&&void 0!==t?t:o.current.__r3f.parent.object,r=e(n);o.current.copy(r)}}),[e]),i.createElement("primitive",(0,r.A)({ref:o,object:s,attach:`attributes-${t}`},n))};function ka(e,t,n={}){const r=new a.Pq0,i=new a.PTz,s=new a.Pq0,o=new a.kn4,l=new a.kn4,c=new a.kn4;n.preserveMatrix=void 0===n.preserveMatrix||n.preserveMatrix,n.preservePosition=void 0===n.preservePosition||n.preservePosition,n.preserveHipPosition=void 0!==n.preserveHipPosition&&n.preserveHipPosition,n.useTargetMatrix=void 0!==n.useTargetMatrix&&n.useTargetMatrix,n.hip=void 0!==n.hip?n.hip:"hip",n.names=n.names||{};const h=t.isObject3D?t.skeleton.bones:Oa(t),u=e.isObject3D?e.skeleton.bones:Oa(e);let d,f,A,m,p;if(e.isObject3D?e.skeleton.pose():(n.useTargetMatrix=!0,n.preserveMatrix=!1),n.preservePosition){p=[];for(let e=0;e<u.length;e++)p.push(u[e].position.clone())}if(n.preserveMatrix){e.updateMatrixWorld(),e.matrixWorld.identity();for(let t=0;t<e.children.length;++t)e.children[t].updateMatrixWorld(!0)}if(n.offsets){d=[];for(let e=0;e<u.length;++e)f=u[e],A=n.names[f.name]||f.name,n.offsets[A]&&(f.matrix.multiply(n.offsets[A]),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()),d.push(f.matrixWorld.clone())}for(let a=0;a<u.length;++a){if(f=u[a],A=n.names[f.name]||f.name,m=Fa(A,h),c.copy(f.matrixWorld),m){if(m.updateMatrixWorld(),n.useTargetMatrix?l.copy(m.matrixWorld):(l.copy(e.matrixWorld).invert(),l.multiply(m.matrixWorld)),s.setFromMatrixScale(l),l.scale(s.set(1/s.x,1/s.y,1/s.z)),c.makeRotationFromQuaternion(i.setFromRotationMatrix(l)),e.isObject3D){const t=u.indexOf(f),n=d?d[t]:o.copy(e.skeleton.boneInverses[t]).invert();c.multiply(n)}c.copyPosition(l)}f.parent&&f.parent.isBone?(f.matrix.copy(f.parent.matrixWorld).invert(),f.matrix.multiply(c)):f.matrix.copy(c),n.preserveHipPosition&&A===n.hip&&f.matrix.setPosition(r.set(0,f.position.y,0)),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()}if(n.preservePosition)for(let a=0;a<u.length;++a)f=u[a],A=n.names[f.name]||f.name,A!==n.hip&&f.position.copy(p[a]);n.preserveMatrix&&e.updateMatrixWorld(!0)}function Fa(e,t){for(let n=0,r=Oa(t);n<r.length;n++)if(e===r[n].name)return r[n]}function Oa(e){return Array.isArray(e)?e:e.bones}function Ua(e,t,n){n(e,t);for(let r=0;r<e.children.length;r++)Ua(e.children[r],t.children[r],n)}const Qa={retarget:ka,retargetClip:function(e,t,n,r={}){r.useFirstFramePosition=void 0!==r.useFirstFramePosition&&r.useFirstFramePosition,r.fps=void 0!==r.fps?r.fps:30,r.names=r.names||[],t.isObject3D||(t=function(e){const t=new a._xc(e.bones[0]);return t.skeleton=e,t}(t));const i=Math.round(n.duration*(r.fps/1e3)*1e3),s=1/r.fps,o=[],l=new a.Iw4(t),c=Oa(e.skeleton),h=[];let u,d,f,A,m;l.clipAction(n).play(),l.update(0),t.updateMatrixWorld();for(let a=0;a<i;++a){const n=a*s;ka(e,t,r);for(let e=0;e<c.length;++e)m=r.names[c[e].name]||c[e].name,f=Fa(m,t.skeleton),f&&(d=c[e],A=h[e]=h[e]||{bone:d},r.hip===m&&(A.pos||(A.pos={times:new Float32Array(i),values:new Float32Array(3*i)}),r.useFirstFramePosition&&(0===a&&(u=d.position.clone()),d.position.sub(u)),A.pos.times[a]=n,d.position.toArray(A.pos.values,3*a)),A.quat||(A.quat={times:new Float32Array(i),values:new Float32Array(4*i)}),A.quat.times[a]=n,d.quaternion.toArray(A.quat.values,4*a));l.update(s),t.updateMatrixWorld()}for(let p=0;p<h.length;++p)A=h[p],A&&(A.pos&&o.push(new a.RiT(".bones["+A.bone.name+"].position",A.pos.times,A.pos.values)),o.push(new a.MBL(".bones["+A.bone.name+"].quaternion",A.quat.times,A.quat.values)));return l.uncacheAction(n),new a.tz3(n.name,-1,o)},clone:function(e){const t=new Map,n=new Map,r=e.clone();return Ua(e,r,(function(e,r){t.set(r,e),n.set(e,r)})),r.traverse((function(e){if(!e.isSkinnedMesh)return;const r=e,i=t.get(e),s=i.skeleton.bones;r.skeleton=i.skeleton.clone(),r.bindMatrix.copy(i.bindMatrix),r.skeleton.bones=s.map((function(e){return n.get(e)})),r.bind(r.skeleton,r.bindMatrix)})),r}};const Na=i.forwardRef((({isChild:e=!1,object:t,children:n,deep:s,castShadow:o,receiveShadow:l,inject:c,keys:h,...u},d)=>{const f={keys:h,deep:s,inject:c,castShadow:o,receiveShadow:l};if(t=i.useMemo((()=>{if(!1===e&&!Array.isArray(t)){let e=!1;if(t.traverse((t=>{t.isSkinnedMesh&&(e=!0)})),e)return Qa.clone(t)}return t}),[t,e]),Array.isArray(t))return i.createElement("group",(0,r.A)({},u,{ref:d}),t.map((e=>i.createElement(Na,(0,r.A)({key:e.uuid,object:e},f)))),n);const{children:A,...m}=function(e,{keys:t=["near","far","color","distance","decay","penumbra","angle","intensity","skeleton","visible","castShadow","receiveShadow","morphTargetDictionary","morphTargetInfluences","name","geometry","material","position","rotation","scale","up","userData","bindMode","bindMatrix","bindMatrixInverse","skeleton"],deep:n,inject:r,castShadow:s,receiveShadow:o}){let l={};for(const i of t)l[i]=e[i];return n&&(l.geometry&&"materialsOnly"!==n&&(l.geometry=l.geometry.clone()),l.material&&"geometriesOnly"!==n&&(l.material=l.material.clone())),r&&(l="function"==typeof r?{...l,children:r(e)}:i.isValidElement(r)?{...l,children:r}:{...l,...r}),e instanceof a.eaF&&(s&&(l.castShadow=!0),o&&(l.receiveShadow=!0)),l}(t,f),p=t.type[0].toLowerCase()+t.type.slice(1);return i.createElement(p,(0,r.A)({},m,u,{ref:d}),t.children.map((e=>"Bone"===e.type?i.createElement("primitive",(0,r.A)({key:e.uuid,object:e},f)):i.createElement(Na,(0,r.A)({key:e.uuid,object:e},f,{isChild:!0})))),n,A)}));class za extends a.eaF{constructor(e,t,n=!1,r=!1,i=1e4){const s=new a.LoY;super(s,t),this.isMarchingCubes=!0;const o=this,l=new Float32Array(36),c=new Float32Array(36),h=new Float32Array(36);function u(e,t,n){return e+(t-e)*n}function d(e,t,n,r,i,s,a,d,f,A){const m=(n-a)/(d-a),p=o.normal_cache;l[t+0]=r+m*o.delta,l[t+1]=i,l[t+2]=s,c[t+0]=u(p[e+0],p[e+3],m),c[t+1]=u(p[e+1],p[e+4],m),c[t+2]=u(p[e+2],p[e+5],m),h[t+0]=u(o.palette[3*f+0],o.palette[3*A+0],m),h[t+1]=u(o.palette[3*f+1],o.palette[3*A+1],m),h[t+2]=u(o.palette[3*f+2],o.palette[3*A+2],m)}function f(e,t,n,r,i,s,a,d,f,A){const m=(n-a)/(d-a),p=o.normal_cache;l[t+0]=r,l[t+1]=i+m*o.delta,l[t+2]=s;const g=e+3*o.yd;c[t+0]=u(p[e+0],p[g+0],m),c[t+1]=u(p[e+1],p[g+1],m),c[t+2]=u(p[e+2],p[g+2],m),h[t+0]=u(o.palette[3*f+0],o.palette[3*A+0],m),h[t+1]=u(o.palette[3*f+1],o.palette[3*A+1],m),h[t+2]=u(o.palette[3*f+2],o.palette[3*A+2],m)}function A(e,t,n,r,i,s,a,d,f,A){const m=(n-a)/(d-a),p=o.normal_cache;l[t+0]=r,l[t+1]=i,l[t+2]=s+m*o.delta;const g=e+3*o.zd;c[t+0]=u(p[e+0],p[g+0],m),c[t+1]=u(p[e+1],p[g+1],m),c[t+2]=u(p[e+2],p[g+2],m),h[t+0]=u(o.palette[3*f+0],o.palette[3*A+0],m),h[t+1]=u(o.palette[3*f+1],o.palette[3*A+1],m),h[t+2]=u(o.palette[3*f+2],o.palette[3*A+2],m)}function m(e){const t=3*e;0===o.normal_cache[t]&&(o.normal_cache[t+0]=o.field[e-1]-o.field[e+1],o.normal_cache[t+1]=o.field[e-o.yd]-o.field[e+o.yd],o.normal_cache[t+2]=o.field[e-o.zd]-o.field[e+o.zd])}function p(e,t,n,r,i){const s=r+1,a=r+o.yd,u=r+o.zd,p=s+o.yd,v=s+o.zd,y=r+o.yd+o.zd,E=s+o.yd+o.zd;let x=0;const C=o.field[r],w=o.field[s],I=o.field[a],b=o.field[p],S=o.field[u],B=o.field[v],T=o.field[y],_=o.field[E];C<i&&(x|=1),w<i&&(x|=2),I<i&&(x|=8),b<i&&(x|=4),S<i&&(x|=16),B<i&&(x|=32),T<i&&(x|=128),_<i&&(x|=64);const M=Ga[x];if(0===M)return 0;const R=o.delta,D=e+R,P=t+R,L=n+R;1&M&&(m(r),m(s),d(3*r,0,i,e,t,n,C,w,r,s)),2&M&&(m(s),m(p),f(3*s,3,i,D,t,n,w,b,s,p)),4&M&&(m(a),m(p),d(3*a,6,i,e,P,n,I,b,a,p)),8&M&&(m(r),m(a),f(3*r,9,i,e,t,n,C,I,r,a)),16&M&&(m(u),m(v),d(3*u,12,i,e,t,L,S,B,u,v)),32&M&&(m(v),m(E),f(3*v,15,i,D,t,L,B,_,v,E)),64&M&&(m(y),m(E),d(3*y,18,i,e,P,L,T,_,y,E)),128&M&&(m(u),m(y),f(3*u,21,i,e,t,L,S,T,u,y)),256&M&&(m(r),m(u),A(3*r,24,i,e,t,n,C,S,r,u)),512&M&&(m(s),m(v),A(3*s,27,i,D,t,n,w,B,s,v)),1024&M&&(m(p),m(E),A(3*p,30,i,D,P,n,b,_,p,E)),2048&M&&(m(a),m(y),A(3*a,33,i,e,P,n,I,T,a,y)),x<<=4;let k,F,O,U=0,Q=0;for(;-1!=Ha[x+Q];)k=x+Q,F=k+1,O=k+2,g(l,c,h,3*Ha[k],3*Ha[F],3*Ha[O]),Q+=3,U++;return U}function g(e,t,n,r,i,s){const a=3*o.count;if(o.positionArray[a+0]=e[r],o.positionArray[a+1]=e[r+1],o.positionArray[a+2]=e[r+2],o.positionArray[a+3]=e[i],o.positionArray[a+4]=e[i+1],o.positionArray[a+5]=e[i+2],o.positionArray[a+6]=e[s],o.positionArray[a+7]=e[s+1],o.positionArray[a+8]=e[s+2],!0===o.material.flatShading){const e=(t[r+0]+t[i+0]+t[s+0])/3,n=(t[r+1]+t[i+1]+t[s+1])/3,l=(t[r+2]+t[i+2]+t[s+2])/3;o.normalArray[a+0]=e,o.normalArray[a+1]=n,o.normalArray[a+2]=l,o.normalArray[a+3]=e,o.normalArray[a+4]=n,o.normalArray[a+5]=l,o.normalArray[a+6]=e,o.normalArray[a+7]=n,o.normalArray[a+8]=l}else o.normalArray[a+0]=t[r+0],o.normalArray[a+1]=t[r+1],o.normalArray[a+2]=t[r+2],o.normalArray[a+3]=t[i+0],o.normalArray[a+4]=t[i+1],o.normalArray[a+5]=t[i+2],o.normalArray[a+6]=t[s+0],o.normalArray[a+7]=t[s+1],o.normalArray[a+8]=t[s+2];if(o.enableUvs){const t=2*o.count;o.uvArray[t+0]=e[r+0],o.uvArray[t+1]=e[r+2],o.uvArray[t+2]=e[i+0],o.uvArray[t+3]=e[i+2],o.uvArray[t+4]=e[s+0],o.uvArray[t+5]=e[s+2]}o.enableColors&&(o.colorArray[a+0]=n[r+0],o.colorArray[a+1]=n[r+1],o.colorArray[a+2]=n[r+2],o.colorArray[a+3]=n[i+0],o.colorArray[a+4]=n[i+1],o.colorArray[a+5]=n[i+2],o.colorArray[a+6]=n[s+0],o.colorArray[a+7]=n[s+1],o.colorArray[a+8]=n[s+2]),o.count+=3}this.enableUvs=n,this.enableColors=r,this.init=function(e){this.resolution=e,this.isolation=80,this.size=e,this.size2=this.size*this.size,this.size3=this.size2*this.size,this.halfsize=this.size/2,this.delta=2/this.size,this.yd=this.size,this.zd=this.size2,this.field=new Float32Array(this.size3),this.normal_cache=new Float32Array(3*this.size3),this.palette=new Float32Array(3*this.size3),this.count=0;const t=3*i;this.positionArray=new Float32Array(3*t);const n=new a.THS(this.positionArray,3);n.setUsage(a.Vnu),s.setAttribute("position",n),this.normalArray=new Float32Array(3*t);const r=new a.THS(this.normalArray,3);if(r.setUsage(a.Vnu),s.setAttribute("normal",r),this.enableUvs){this.uvArray=new Float32Array(2*t);const e=new a.THS(this.uvArray,2);e.setUsage(a.Vnu),s.setAttribute("uv",e)}if(this.enableColors){this.colorArray=new Float32Array(3*t);const e=new a.THS(this.colorArray,3);e.setUsage(a.Vnu),s.setAttribute("color",e)}s.boundingSphere=new a.iyt(new a.Pq0,1)},this.addBall=function(e,t,n,r,i,s){const o=Math.sign(r);r=Math.abs(r);const l=!(null==s);let c=new a.Q1f(e,t,n);if(l)try{c=s instanceof a.Q1f?s:Array.isArray(s)?new a.Q1f(Math.min(Math.abs(s[0]),1),Math.min(Math.abs(s[1]),1),Math.min(Math.abs(s[2]),1)):new a.Q1f(s)}catch(R){c=new a.Q1f(e,t,n)}const h=this.size*Math.sqrt(r/i),u=n*this.size,d=t*this.size,f=e*this.size;let A=Math.floor(u-h);A<1&&(A=1);let m=Math.floor(u+h);m>this.size-1&&(m=this.size-1);let p=Math.floor(d-h);p<1&&(p=1);let g=Math.floor(d+h);g>this.size-1&&(g=this.size-1);let v=Math.floor(f-h);v<1&&(v=1);let y,E,x,C,w,I,b,S,B,T,_,M=Math.floor(f+h);for(M>this.size-1&&(M=this.size-1),x=A;x<m;x++)for(w=this.size2*x,S=x/this.size-n,B=S*S,E=p;E<g;E++)for(C=w+this.size*E,b=E/this.size-t,T=b*b,y=v;y<M;y++)if(I=y/this.size-e,_=r/(1e-6+I*I+T+B)-i,_>0){this.field[C+y]+=_*o;const e=Math.sqrt((y-f)*(y-f)+(E-d)*(E-d)+(x-u)*(x-u))/h,t=1-e*e*e*(e*(6*e-15)+10);this.palette[3*(C+y)+0]+=c.r*t,this.palette[3*(C+y)+1]+=c.g*t,this.palette[3*(C+y)+2]+=c.b*t}},this.addPlaneX=function(e,t){const n=this.size,r=this.yd,i=this.zd,s=this.field;let a,o,l,c,h,u,d,f=n*Math.sqrt(e/t);for(f>n&&(f=n),a=0;a<f;a++)if(u=a/n,c=u*u,h=e/(1e-4+c)-t,h>0)for(o=0;o<n;o++)for(d=a+o*r,l=0;l<n;l++)s[i*l+d]+=h},this.addPlaneY=function(e,t){const n=this.size,r=this.yd,i=this.zd,s=this.field;let a,o,l,c,h,u,d,f,A=n*Math.sqrt(e/t);for(A>n&&(A=n),o=0;o<A;o++)if(u=o/n,c=u*u,h=e/(1e-4+c)-t,h>0)for(d=o*r,a=0;a<n;a++)for(f=d+a,l=0;l<n;l++)s[i*l+f]+=h},this.addPlaneZ=function(e,t){const n=this.size,r=this.yd,i=this.zd,s=this.field;let a,o,l,c,h,u,d,f,A=n*Math.sqrt(e/t);for(A>n&&(A=n),l=0;l<A;l++)if(u=l/n,c=u*u,h=e/(1e-4+c)-t,h>0)for(d=i*l,o=0;o<n;o++)for(f=d+o*r,a=0;a<n;a++)s[f+a]+=h},this.setCell=function(e,t,n,r){const i=this.size2*n+this.size*t+e;this.field[i]=r},this.getCell=function(e,t,n){const r=this.size2*n+this.size*t+e;return this.field[r]},this.blur=function(e=1){const t=this.field,n=t.slice(),r=this.size,i=this.size2;for(let s=0;s<r;s++)for(let a=0;a<r;a++)for(let o=0;o<r;o++){const l=i*o+r*a+s;let c=n[l],h=1;for(let t=-1;t<=1;t+=2){const l=t+s;if(!(l<0||l>=r))for(let t=-1;t<=1;t+=2){const s=t+a;if(!(s<0||s>=r))for(let t=-1;t<=1;t+=2){const a=t+o;if(a<0||a>=r)continue;h++,c+=e*(n[i*a+r*s+l]-c)/h}}}t[l]=c}},this.reset=function(){for(let e=0;e<this.size3;e++)this.normal_cache[3*e]=0,this.field[e]=0,this.palette[3*e]=this.palette[3*e+1]=this.palette[3*e+2]=0},this.update=function(){this.count=0;const e=this.size-2;for(let t=1;t<e;t++){const n=this.size2*t,r=(t-this.halfsize)/this.halfsize;for(let t=1;t<e;t++){const i=n+this.size*t,s=(t-this.halfsize)/this.halfsize;for(let t=1;t<e;t++){p((t-this.halfsize)/this.halfsize,s,r,i+t,this.isolation)}}}this.geometry.setDrawRange(0,this.count),s.getAttribute("position").needsUpdate=!0,s.getAttribute("normal").needsUpdate=!0,this.enableUvs&&(s.getAttribute("uv").needsUpdate=!0),this.enableColors&&(s.getAttribute("color").needsUpdate=!0),this.count/3>i&&console.warn("THREE.MarchingCubes: Geometry buffers too small for rendering. Please create an instance with a higher poly count.")},this.init(e)}}const Ga=new Int32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0]),Ha=new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),qa=i.createContext(null),Ya=i.forwardRef((({resolution:e=28,maxPolyCount:t=1e4,enableUvs:n=!1,enableColors:s=!1,children:a,...l},c)=>{const h=i.useRef(null);i.useImperativeHandle(c,(()=>h.current),[]);const u=i.useMemo((()=>new za(e,null,n,s,t)),[e,t,n,s]),d=i.useMemo((()=>({getParent:()=>h})),[]);return(0,o.C)((()=>{u.update(),u.reset()}),-1),i.createElement(i.Fragment,null,i.createElement("primitive",(0,r.A)({object:u,ref:h},l),i.createElement(qa.Provider,{value:d},a)))})),ja=i.forwardRef((({strength:e=.5,subtract:t=12,color:n,...s},l)=>{const{getParent:c}=i.useContext(qa),h=i.useMemo((()=>c()),[c]),u=i.useRef(null);i.useImperativeHandle(l,(()=>u.current),[]);const d=new a.Pq0;return(0,o.C)((r=>{h.current&&u.current&&(u.current.getWorldPosition(d),h.current.addBall(.5+.5*d.x,.5+.5*d.y,.5+.5*d.z,e,t,n))})),i.createElement("group",(0,r.A)({ref:u},s))})),Va=i.forwardRef((({planeType:e="x",strength:t=.5,subtract:n=12,...s},a)=>{const{getParent:l}=i.useContext(qa),c=i.useMemo((()=>l()),[l]),h=i.useRef(null);i.useImperativeHandle(a,(()=>h.current),[]);const u=i.useMemo((()=>"x"===e?"addPlaneX":"y"===e?"addPlaneY":"addPlaneZ"),[e]);return(0,o.C)((()=>{c.current&&h.current&&c.current[u](t,n)})),i.createElement("group",(0,r.A)({ref:h},s))}));class Ka extends a.LoY{constructor(e,t,n,r){super();const i=[],s=[],o=[],l=new a.Pq0,c=new a.kn4;c.makeRotationFromEuler(n),c.setPosition(t);const h=new a.kn4;function u(t,n,r){n.applyMatrix4(e.matrixWorld),n.applyMatrix4(h),r.transformDirection(e.matrixWorld),t.push(new Wa(n.clone(),r.clone()))}function d(e,t){const n=[],i=.5*Math.abs(r.dot(t));for(let r=0;r<e.length;r+=3){let s,a,o,l,c,h,u,d=0;switch(s=e[r+0].position.dot(t)-i>0,a=e[r+1].position.dot(t)-i>0,o=e[r+2].position.dot(t)-i>0,d=(s?1:0)+(a?1:0)+(o?1:0),d){case 0:n.push(e[r]),n.push(e[r+1]),n.push(e[r+2]);break;case 1:if(s&&(l=e[r+1],c=e[r+2],h=f(e[r],l,t,i),u=f(e[r],c,t,i)),a){l=e[r],c=e[r+2],h=f(e[r+1],l,t,i),u=f(e[r+1],c,t,i),n.push(h),n.push(c.clone()),n.push(l.clone()),n.push(c.clone()),n.push(h.clone()),n.push(u);break}o&&(l=e[r],c=e[r+1],h=f(e[r+2],l,t,i),u=f(e[r+2],c,t,i)),n.push(l.clone()),n.push(c.clone()),n.push(h),n.push(u),n.push(h.clone()),n.push(c.clone());break;case 2:s||(l=e[r].clone(),c=f(l,e[r+1],t,i),h=f(l,e[r+2],t,i),n.push(l),n.push(c),n.push(h)),a||(l=e[r+1].clone(),c=f(l,e[r+2],t,i),h=f(l,e[r],t,i),n.push(l),n.push(c),n.push(h)),o||(l=e[r+2].clone(),c=f(l,e[r],t,i),h=f(l,e[r+1],t,i),n.push(l),n.push(c),n.push(h))}}return n}function f(e,t,n,r){const i=e.position.dot(n)-r,s=i/(i-(t.position.dot(n)-r));return new Wa(new a.Pq0(e.position.x+s*(t.position.x-e.position.x),e.position.y+s*(t.position.y-e.position.y),e.position.z+s*(t.position.z-e.position.z)),new a.Pq0(e.normal.x+s*(t.normal.x-e.normal.x),e.normal.y+s*(t.normal.y-e.normal.y),e.normal.z+s*(t.normal.z-e.normal.z)))}h.copy(c).invert(),function(){let t,n=[];const h=new a.Pq0,f=new a.Pq0;if(!0===e.geometry.isGeometry)return void console.error("THREE.DecalGeometry no longer supports THREE.Geometry. Use BufferGeometry instead.");const A=e.geometry,m=A.attributes.position,p=A.attributes.normal;if(null!==A.index){const e=A.index;for(t=0;t<e.count;t++)h.fromBufferAttribute(m,e.getX(t)),f.fromBufferAttribute(p,e.getX(t)),u(n,h,f)}else for(t=0;t<m.count;t++)h.fromBufferAttribute(m,t),f.fromBufferAttribute(p,t),u(n,h,f);for(n=d(n,l.set(1,0,0)),n=d(n,l.set(-1,0,0)),n=d(n,l.set(0,1,0)),n=d(n,l.set(0,-1,0)),n=d(n,l.set(0,0,1)),n=d(n,l.set(0,0,-1)),t=0;t<n.length;t++){const e=n[t];o.push(.5+e.position.x/r.x,.5+e.position.y/r.y),e.position.applyMatrix4(c),i.push(e.position.x,e.position.y,e.position.z),s.push(e.normal.x,e.normal.y,e.normal.z)}}(),this.setAttribute("position",new a.qtW(i,3)),this.setAttribute("normal",new a.qtW(s,3)),this.setAttribute("uv",new a.qtW(o,2))}}class Wa{constructor(e,t){this.position=e,this.normal=t}clone(){return new this.constructor(this.position.clone(),this.normal.clone())}}function Ja(e=[0,0,0]){return function(e){return Array.isArray(e)}(e)?e:e instanceof a.Pq0||e instanceof a.O9p?[e.x,e.y,e.z]:[e,e,e]}const Xa=i.forwardRef((function({debug:e,depthTest:t=!1,polygonOffsetFactor:n=-10,map:s,mesh:l,children:c,position:h,rotation:u,scale:d,...f},A){const m=i.useRef(null);i.useImperativeHandle(A,(()=>m.current));const p=i.useRef(null),g=i.useRef({position:new a.Pq0,rotation:new a.O9p,scale:new a.Pq0(1,1,1)});return i.useLayoutEffect((()=>{const e=(null==l?void 0:l.current)||m.current.parent,t=m.current;if(!(e instanceof a.eaF))throw new Error('Decal must have a Mesh as parent or specify its "mesh" prop');if(e){(0,o.q)(g.current,{position:h,scale:d});const n=e.matrixWorld.clone();if(e.matrixWorld.identity(),u&&"number"!=typeof u)(0,o.q)(g.current,{rotation:u});else{const t=new a.B69;t.position.copy(g.current.position);const n=e.geometry.attributes.position.array;void 0===e.geometry.attributes.normal&&e.geometry.computeVertexNormals();const r=e.geometry.attributes.normal.array;let i=1/0;new a.Pq0;let s=new a.Pq0;const l=t.position.x,c=t.position.y,h=t.position.z,d=n.length;let f=-1;for(let e=0;e<d;e+=3){const t=n[e]-l,r=n[e+1]-c,s=n[e+2]-h,a=t*t+r*r+s*s;a<i&&(i=a,f=e)}s.fromArray(r,f),t.lookAt(t.position.clone().add(s)),t.rotateZ(Math.PI),t.rotateY(Math.PI),"number"==typeof u&&t.rotateZ(u),(0,o.q)(g.current,{rotation:t.rotation})}return t.geometry=new Ka(e,g.current.position,g.current.rotation,g.current.scale),e.matrixWorld=n,()=>{t.geometry.dispose()}}}),[l,...Ja(h),...Ja(d),...Ja(u)]),i.useLayoutEffect((()=>{p.current&&((0,o.q)(p.current,g.current),p.current.traverse((e=>e.raycast=()=>null)))}),[e]),i.createElement("mesh",(0,r.A)({ref:m,"material-transparent":!0,"material-polygonOffset":!0,"material-polygonOffsetFactor":n,"material-depthTest":t,"material-map":s},f),c,e&&i.createElement("mesh",{ref:p},i.createElement("boxGeometry",null),i.createElement("meshNormalMaterial",{wireframe:!0}),i.createElement("axesHelper",null)))})),$a=(()=>{class e extends a.aHM{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,n,r){const i=this,s=new a.Y9S(i.manager);s.setPath(i.path),s.setRequestHeader(i.requestHeader),s.setWithCredentials(i.withCredentials),s.load(e,(function(n){try{t(i.parse(n))}catch(Sf){r?r(Sf):console.error(Sf),i.manager.itemError(e)}}),n,r)}parse(e){const t=this;function n(e,t,n,i,s,a,o,l){if(0==t||0==n)return void e.lineTo(l.x,l.y);i=i*Math.PI/180,t=Math.abs(t),n=Math.abs(n);const c=(o.x-l.x)/2,h=(o.y-l.y)/2,u=Math.cos(i)*c+Math.sin(i)*h,d=-Math.sin(i)*c+Math.cos(i)*h;let f=t*t,A=n*n;const m=u*u,p=d*d,g=m/f+p/A;if(g>1){const e=Math.sqrt(g);f=(t*=e)*t,A=(n*=e)*n}const v=f*p+A*m,y=(f*A-v)/v;let E=Math.sqrt(Math.max(0,y));s===a&&(E=-E);const x=E*t*d/n,C=-E*n*u/t,w=Math.cos(i)*x-Math.sin(i)*C+(o.x+l.x)/2,I=Math.sin(i)*x+Math.cos(i)*C+(o.y+l.y)/2,b=r(1,0,(u-x)/t,(d-C)/n),S=r((u-x)/t,(d-C)/n,(-u-x)/t,(-d-C)/n)%(2*Math.PI);e.currentPath.absellipse(w,I,t,n,b,b+S,0===a,i)}function r(e,t,n,r){const i=e*n+t*r,s=Math.sqrt(e*e+t*t)*Math.sqrt(n*n+r*r);let a=Math.acos(Math.max(-1,Math.min(1,i/s)));return e*r-t*n<0&&(a=-a),a}function i(e,t){t=Object.assign({},t);let n={};if(e.hasAttribute("class")){const t=e.getAttribute("class").split(/\s/).filter(Boolean).map((e=>e.trim()));for(let e=0;e<t.length;e++)n=Object.assign(n,p["."+t[e]])}function r(r,i,s){void 0===s&&(s=function(e){return e.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),e}),e.hasAttribute(r)&&(t[i]=s(e.getAttribute(r))),n[r]&&(t[i]=s(n[r])),e.style&&""!==e.style[r]&&(t[i]=s(e.style[r]))}function i(e){return Math.max(0,Math.min(1,h(e)))}function s(e){return Math.max(0,h(e))}return e.hasAttribute("id")&&(n=Object.assign(n,p["#"+e.getAttribute("id")])),r("fill","fill"),r("fill-opacity","fillOpacity",i),r("fill-rule","fillRule"),r("opacity","opacity",i),r("stroke","stroke"),r("stroke-opacity","strokeOpacity",i),r("stroke-width","strokeWidth",s),r("stroke-linejoin","strokeLineJoin"),r("stroke-linecap","strokeLineCap"),r("stroke-miterlimit","strokeMiterLimit",s),r("visibility","visibility"),t}function s(e,t){return e-(t-e)}function o(e,t,n){if("string"!=typeof e)throw new TypeError("Invalid input: "+typeof e);const r={SEPARATOR:/[ \t\r\n\,.\-+]/,WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/};let i=0,s=!0,a="",o="";const l=[];function c(e,t,n){const r=new SyntaxError('Unexpected character "'+e+'" at index '+t+".");throw r.partial=n,r}function h(){""!==a&&(""===o?l.push(Number(a)):l.push(Number(a)*Math.pow(10,Number(o)))),a="",o=""}let u;const d=e.length;for(let f=0;f<d;f++)if(u=e[f],Array.isArray(t)&&t.includes(l.length%n)&&r.FLAGS.test(u))i=1,a=u,h();else{if(0===i){if(r.WHITESPACE.test(u))continue;if(r.DIGIT.test(u)||r.SIGN.test(u)){i=1,a=u;continue}if(r.POINT.test(u)){i=2,a=u;continue}r.COMMA.test(u)&&(s&&c(u,f,l),s=!0)}if(1===i){if(r.DIGIT.test(u)){a+=u;continue}if(r.POINT.test(u)){a+=u,i=2;continue}if(r.EXP.test(u)){i=3;continue}r.SIGN.test(u)&&1===a.length&&r.SIGN.test(a[0])&&c(u,f,l)}if(2===i){if(r.DIGIT.test(u)){a+=u;continue}if(r.EXP.test(u)){i=3;continue}r.POINT.test(u)&&"."===a[a.length-1]&&c(u,f,l)}if(3===i){if(r.DIGIT.test(u)){o+=u;continue}if(r.SIGN.test(u)){if(""===o){o+=u;continue}1===o.length&&r.SIGN.test(o)&&c(u,f,l)}}r.WHITESPACE.test(u)?(h(),i=0,s=!1):r.COMMA.test(u)?(h(),i=0,s=!0):r.SIGN.test(u)?(h(),i=1,a=u):r.POINT.test(u)?(h(),i=2,a=u):c(u,f,l)}return h(),l}const l=["mm","cm","in","pt","pc","px"],c={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function h(e){let n,r="px";if("string"==typeof e||e instanceof String)for(let t=0,i=l.length;t<i;t++){const n=l[t];if(e.endsWith(n)){r=n,e=e.substring(0,e.length-n.length);break}}return"px"===r&&"px"!==t.defaultUnit?n=c.in[t.defaultUnit]/t.defaultDPI:(n=c[r][t.defaultUnit],n<0&&(n=c[r].in*t.defaultDPI)),n*parseFloat(e)}function u(e){const t=e.elements;return t[0]*t[4]-t[1]*t[3]<0}function d(e){const t=e.elements,n=t[0]*t[3]+t[1]*t[4];if(0===n)return!1;const r=f(e),i=A(e);return Math.abs(n/(r*i))>Number.EPSILON}function f(e){const t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function A(e){const t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}const m=[],p={},g=[],v=new a.dwI,y=new a.dwI,E=new a.dwI,x=new a.dwI,C=new a.I9Y,w=new a.Pq0,I=new a.dwI,b=(new DOMParser).parseFromString(e,"image/svg+xml");!function e(t,r){if(1!==t.nodeType)return;const l=function(e){if(!(e.hasAttribute("transform")||"use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))))return null;const t=function(e){const t=new a.dwI,n=v;if("use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))){const n=h(e.getAttribute("x")),r=h(e.getAttribute("y"));t.translate(n,r)}if(e.hasAttribute("transform")){const r=e.getAttribute("transform").split(")");for(let e=r.length-1;e>=0;e--){const i=r[e].trim();if(""===i)continue;const s=i.indexOf("("),a=i.length;if(s>0&&s<a){const e=i.slice(0,s),t=o(i.slice(s+1));switch(n.identity(),e){case"translate":if(t.length>=1){const e=t[0];let r=0;t.length>=2&&(r=t[1]),n.translate(e,r)}break;case"rotate":if(t.length>=1){let e=0,r=0,i=0;e=t[0]*Math.PI/180,t.length>=3&&(r=t[1],i=t[2]),y.makeTranslation(-r,-i),E.makeRotation(e),x.multiplyMatrices(E,y),y.makeTranslation(r,i),n.multiplyMatrices(y,x)}break;case"scale":if(t.length>=1){const e=t[0];let r=e;t.length>=2&&(r=t[1]),n.scale(e,r)}break;case"skewX":1===t.length&&n.set(1,Math.tan(t[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===t.length&&n.set(1,0,0,Math.tan(t[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===t.length&&n.set(t[0],t[2],t[4],t[1],t[3],t[5],0,0,1)}}t.premultiply(n)}}return t}(e);g.length>0&&t.premultiply(g[g.length-1]);return I.copy(t),g.push(t),t}(t);let c=!1,b=null;switch(t.nodeName){case"svg":case"g":r=i(t,r);break;case"style":!function(e){if(!e.sheet||!e.sheet.cssRules||!e.sheet.cssRules.length)return;for(let t=0;t<e.sheet.cssRules.length;t++){const n=e.sheet.cssRules[t];if(1!==n.type)continue;const r=n.selectorText.split(/,/gm).filter(Boolean).map((e=>e.trim()));for(let e=0;e<r.length;e++){const t=Object.fromEntries(Object.entries(n.style).filter((([,e])=>""!==e)));p[r[e]]=Object.assign(p[r[e]]||{},t)}}}(t);break;case"path":r=i(t,r),t.hasAttribute("d")&&(b=function(e){const t=new a.Ld9,r=new a.I9Y,i=new a.I9Y,l=new a.I9Y;let c=!0,h=!1;const u=e.getAttribute("d");if(""===u||"none"===u)return null;const d=u.match(/[a-df-z][^a-df-z]*/gi);for(let a=0,f=d.length;a<f;a++){const e=d[a],u=e.charAt(0),f=e.slice(1).trim();let A;switch(!0===c&&(h=!0,c=!1),u){case"M":A=o(f);for(let e=0,n=A.length;e<n;e+=2)r.x=A[e+0],r.y=A[e+1],i.x=r.x,i.y=r.y,0===e?t.moveTo(r.x,r.y):t.lineTo(r.x,r.y),0===e&&l.copy(r);break;case"H":A=o(f);for(let e=0,n=A.length;e<n;e++)r.x=A[e],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"V":A=o(f);for(let e=0,n=A.length;e<n;e++)r.y=A[e],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"L":A=o(f);for(let e=0,n=A.length;e<n;e+=2)r.x=A[e+0],r.y=A[e+1],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"C":A=o(f);for(let e=0,n=A.length;e<n;e+=6)t.bezierCurveTo(A[e+0],A[e+1],A[e+2],A[e+3],A[e+4],A[e+5]),i.x=A[e+2],i.y=A[e+3],r.x=A[e+4],r.y=A[e+5],0===e&&!0===h&&l.copy(r);break;case"S":A=o(f);for(let e=0,n=A.length;e<n;e+=4)t.bezierCurveTo(s(r.x,i.x),s(r.y,i.y),A[e+0],A[e+1],A[e+2],A[e+3]),i.x=A[e+0],i.y=A[e+1],r.x=A[e+2],r.y=A[e+3],0===e&&!0===h&&l.copy(r);break;case"Q":A=o(f);for(let e=0,n=A.length;e<n;e+=4)t.quadraticCurveTo(A[e+0],A[e+1],A[e+2],A[e+3]),i.x=A[e+0],i.y=A[e+1],r.x=A[e+2],r.y=A[e+3],0===e&&!0===h&&l.copy(r);break;case"T":A=o(f);for(let e=0,n=A.length;e<n;e+=2){const n=s(r.x,i.x),a=s(r.y,i.y);t.quadraticCurveTo(n,a,A[e+0],A[e+1]),i.x=n,i.y=a,r.x=A[e+0],r.y=A[e+1],0===e&&!0===h&&l.copy(r)}break;case"A":A=o(f,[3,4],7);for(let e=0,s=A.length;e<s;e+=7){if(A[e+5]==r.x&&A[e+6]==r.y)continue;const s=r.clone();r.x=A[e+5],r.y=A[e+6],i.x=r.x,i.y=r.y,n(t,A[e],A[e+1],A[e+2],A[e+3],A[e+4],s,r),0===e&&!0===h&&l.copy(r)}break;case"m":A=o(f);for(let e=0,n=A.length;e<n;e+=2)r.x+=A[e+0],r.y+=A[e+1],i.x=r.x,i.y=r.y,0===e?t.moveTo(r.x,r.y):t.lineTo(r.x,r.y),0===e&&l.copy(r);break;case"h":A=o(f);for(let e=0,n=A.length;e<n;e++)r.x+=A[e],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"v":A=o(f);for(let e=0,n=A.length;e<n;e++)r.y+=A[e],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"l":A=o(f);for(let e=0,n=A.length;e<n;e+=2)r.x+=A[e+0],r.y+=A[e+1],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"c":A=o(f);for(let e=0,n=A.length;e<n;e+=6)t.bezierCurveTo(r.x+A[e+0],r.y+A[e+1],r.x+A[e+2],r.y+A[e+3],r.x+A[e+4],r.y+A[e+5]),i.x=r.x+A[e+2],i.y=r.y+A[e+3],r.x+=A[e+4],r.y+=A[e+5],0===e&&!0===h&&l.copy(r);break;case"s":A=o(f);for(let e=0,n=A.length;e<n;e+=4)t.bezierCurveTo(s(r.x,i.x),s(r.y,i.y),r.x+A[e+0],r.y+A[e+1],r.x+A[e+2],r.y+A[e+3]),i.x=r.x+A[e+0],i.y=r.y+A[e+1],r.x+=A[e+2],r.y+=A[e+3],0===e&&!0===h&&l.copy(r);break;case"q":A=o(f);for(let e=0,n=A.length;e<n;e+=4)t.quadraticCurveTo(r.x+A[e+0],r.y+A[e+1],r.x+A[e+2],r.y+A[e+3]),i.x=r.x+A[e+0],i.y=r.y+A[e+1],r.x+=A[e+2],r.y+=A[e+3],0===e&&!0===h&&l.copy(r);break;case"t":A=o(f);for(let e=0,n=A.length;e<n;e+=2){const n=s(r.x,i.x),a=s(r.y,i.y);t.quadraticCurveTo(n,a,r.x+A[e+0],r.y+A[e+1]),i.x=n,i.y=a,r.x=r.x+A[e+0],r.y=r.y+A[e+1],0===e&&!0===h&&l.copy(r)}break;case"a":A=o(f,[3,4],7);for(let e=0,s=A.length;e<s;e+=7){if(0==A[e+5]&&0==A[e+6])continue;const s=r.clone();r.x+=A[e+5],r.y+=A[e+6],i.x=r.x,i.y=r.y,n(t,A[e],A[e+1],A[e+2],A[e+3],A[e+4],s,r),0===e&&!0===h&&l.copy(r)}break;case"Z":case"z":t.currentPath.autoClose=!0,t.currentPath.curves.length>0&&(r.copy(l),t.currentPath.currentPoint.copy(r),c=!0);break;default:console.warn(e)}h=!1}return t}(t));break;case"rect":r=i(t,r),b=function(e){const t=h(e.getAttribute("x")||0),n=h(e.getAttribute("y")||0),r=h(e.getAttribute("rx")||e.getAttribute("ry")||0),i=h(e.getAttribute("ry")||e.getAttribute("rx")||0),s=h(e.getAttribute("width")),o=h(e.getAttribute("height")),l=.448084975506,c=new a.Ld9;c.moveTo(t+r,n),c.lineTo(t+s-r,n),(0!==r||0!==i)&&c.bezierCurveTo(t+s-r*l,n,t+s,n+i*l,t+s,n+i);c.lineTo(t+s,n+o-i),(0!==r||0!==i)&&c.bezierCurveTo(t+s,n+o-i*l,t+s-r*l,n+o,t+s-r,n+o);c.lineTo(t+r,n+o),(0!==r||0!==i)&&c.bezierCurveTo(t+r*l,n+o,t,n+o-i*l,t,n+o-i);c.lineTo(t,n+i),(0!==r||0!==i)&&c.bezierCurveTo(t,n+i*l,t+r*l,n,t+r,n);return c}(t);break;case"polygon":r=i(t,r),b=function(e){function t(e,t,n){const s=h(t),a=h(n);0===i?r.moveTo(s,a):r.lineTo(s,a),i++}const n=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,r=new a.Ld9;let i=0;return e.getAttribute("points").replace(n,t),r.currentPath.autoClose=!0,r}(t);break;case"polyline":r=i(t,r),b=function(e){function t(e,t,n){const s=h(t),a=h(n);0===i?r.moveTo(s,a):r.lineTo(s,a),i++}const n=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,r=new a.Ld9;let i=0;return e.getAttribute("points").replace(n,t),r.currentPath.autoClose=!1,r}(t);break;case"circle":r=i(t,r),b=function(e){const t=h(e.getAttribute("cx")||0),n=h(e.getAttribute("cy")||0),r=h(e.getAttribute("r")||0),i=new a.wAk;i.absarc(t,n,r,0,2*Math.PI);const s=new a.Ld9;return s.subPaths.push(i),s}(t);break;case"ellipse":r=i(t,r),b=function(e){const t=h(e.getAttribute("cx")||0),n=h(e.getAttribute("cy")||0),r=h(e.getAttribute("rx")||0),i=h(e.getAttribute("ry")||0),s=new a.wAk;s.absellipse(t,n,r,i,0,2*Math.PI);const o=new a.Ld9;return o.subPaths.push(s),o}(t);break;case"line":r=i(t,r),b=function(e){const t=h(e.getAttribute("x1")||0),n=h(e.getAttribute("y1")||0),r=h(e.getAttribute("x2")||0),i=h(e.getAttribute("y2")||0),s=new a.Ld9;return s.moveTo(t,n),s.lineTo(r,i),s.currentPath.autoClose=!1,s}(t);break;case"defs":c=!0;break;case"use":r=i(t,r);const l=(t.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),u=t.viewportElement.getElementById(l);u?e(u,r):console.warn("SVGLoader: 'use node' references non-existent node id: "+l)}b&&(void 0!==r.fill&&"none"!==r.fill&&b.color.setStyle(r.fill,"srgb"),function(e,t){function n(e){w.set(e.x,e.y,1).applyMatrix3(t),e.set(w.x,w.y)}function r(e){const n=e.xRadius,r=e.yRadius,i=Math.cos(e.aRotation),s=Math.sin(e.aRotation),o=new a.Pq0(n*i,n*s,0),l=new a.Pq0(-r*s,r*i,0),c=o.applyMatrix3(t),h=l.applyMatrix3(t),d=v.set(c.x,h.x,0,c.y,h.y,0,0,0,1),f=y.copy(d).invert(),A=E.copy(f).transpose().multiply(f).elements,m=function(e,t,n){let r,i,s,a,o;const l=e+n,c=e-n,h=Math.sqrt(c*c+4*t*t);l>0?(r=.5*(l+h),o=1/r,i=e*o*n-t*o*t):l<0?i=.5*(l-h):(r=.5*h,i=-.5*h);s=c>0?c+h:c-h;Math.abs(s)>2*Math.abs(t)?(o=-2*t/s,a=1/Math.sqrt(1+o*o),s=o*a):0===Math.abs(t)?(s=1,a=0):(o=-.5*s/t,s=1/Math.sqrt(1+o*o),a=o*s);c>0&&(o=s,s=-a,a=o);return{rt1:r,rt2:i,cs:s,sn:a}}(A[0],A[1],A[4]),p=Math.sqrt(m.rt1),g=Math.sqrt(m.rt2);e.xRadius=1/p,e.yRadius=1/g,e.aRotation=Math.atan2(m.sn,m.cs);if(!((e.aEndAngle-e.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const n=y.set(p,0,0,0,g,0,0,0,1),r=E.set(m.cs,m.sn,0,-m.sn,m.cs,0,0,0,1),i=n.multiply(r).multiply(d),s=e=>{const{x:t,y:n}=new a.Pq0(Math.cos(e),Math.sin(e),0).applyMatrix3(i);return Math.atan2(n,t)};e.aStartAngle=s(e.aStartAngle),e.aEndAngle=s(e.aEndAngle),u(t)&&(e.aClockwise=!e.aClockwise)}}function i(e){const n=f(t),r=A(t);e.xRadius*=n,e.yRadius*=r;const i=n>Number.EPSILON?Math.atan2(t.elements[1],t.elements[0]):Math.atan2(-t.elements[3],t.elements[4]);e.aRotation+=i,u(t)&&(e.aStartAngle*=-1,e.aEndAngle*=-1,e.aClockwise=!e.aClockwise)}const s=e.subPaths;for(let a=0,o=s.length;a<o;a++){const e=s[a].curves;for(let s=0;s<e.length;s++){const a=e[s];a.isLineCurve?(n(a.v1),n(a.v2)):a.isCubicBezierCurve?(n(a.v0),n(a.v1),n(a.v2),n(a.v3)):a.isQuadraticBezierCurve?(n(a.v0),n(a.v1),n(a.v2)):a.isEllipseCurve&&(C.set(a.aX,a.aY),n(C),a.aX=C.x,a.aY=C.y,d(t)?r(a):i(a))}}}(b,I),m.push(b),b.userData={node:t,style:r});const S=t.childNodes;for(let n=0;n<S.length;n++){const t=S[n];c&&"style"!==t.nodeName&&"defs"!==t.nodeName||e(t,r)}l&&(g.pop(),g.length>0?I.copy(g[g.length-1]):I.identity())}(b.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4});return{paths:m,xml:b.documentElement}}static createShapes(e){const t=999999999,n=0,r=1,i=2,s=3,o=4,l=5,c=6,h={loc:n,t:0};function u(e,t,r,s){const a=e.x,o=t.x,l=r.x,c=s.x,u=e.y,f=t.y,A=r.y,m=s.y,p=(c-l)*(u-A)-(m-A)*(a-l),g=(m-A)*(o-a)-(c-l)*(f-u),v=p/g,y=((o-a)*(u-A)-(f-u)*(a-l))/g;if(0===g&&0!==p||v<=0||v>=1||y<0||y>1)return null;if(0===p&&0===g){for(let l=0;l<2;l++){if(d(0===l?r:s,e,t),h.loc==n){const e=0===l?r:s;return{x:e.x,y:e.y,t:h.t}}if(h.loc==i){return{x:+(a+h.t*(o-a)).toPrecision(10),y:+(u+h.t*(f-u)).toPrecision(10),t:h.t}}}return null}for(let i=0;i<2;i++)if(d(0===i?r:s,e,t),h.loc==n){const e=0===i?r:s;return{x:e.x,y:e.y,t:h.t}}return{x:+(a+v*(o-a)).toPrecision(10),y:+(u+v*(f-u)).toPrecision(10),t:v}}function d(e,t,a){const u=a.x-t.x,d=a.y-t.y,f=e.x-t.x,A=e.y-t.y,m=u*A-f*d;if(e.x===t.x&&e.y===t.y)return h.loc=n,void(h.t=0);if(e.x===a.x&&e.y===a.y)return h.loc=r,void(h.t=1);if(m<-Number.EPSILON)return void(h.loc=s);if(m>Number.EPSILON)return void(h.loc=o);if(u*f<0||d*A<0)return void(h.loc=l);if(Math.sqrt(u*u+d*d)<Math.sqrt(f*f+A*A))return void(h.loc=c);let p;p=0!==u?f/u:A/d,h.loc=i,h.t=p}function f(e,t,n){const r=new a.I9Y;t.getCenter(r);const i=[];return n.forEach((t=>{if(t.boundingBox.containsPoint(r)){const n=function(e,t){const n=[],r=[];for(let i=1;i<e.length;i++){const s=e[i-1],o=e[i];for(let e=1;e<t.length;e++){const i=u(s,o,t[e-1],t[e]);null!==i&&void 0===n.find((e=>e.t<=i.t+Number.EPSILON&&e.t>=i.t-Number.EPSILON))&&(n.push(i),r.push(new a.I9Y(i.x,i.y)))}}return r}(e,t.points);n.forEach((e=>{i.push({identifier:t.identifier,isCW:t.isCW,point:e})}))}})),i.sort(((e,t)=>e.point.x-t.point.x)),i}let A=t,m=-999999999,p=e.subPaths.map((e=>{const n=e.getPoints();let r=-999999999,i=t,s=-999999999,o=t;for(let t=0;t<n.length;t++){const e=n[t];e.y>r&&(r=e.y),e.y<i&&(i=e.y),e.x>s&&(s=e.x),e.x<o&&(o=e.x)}return m<=s&&(m=s+1),A>=o&&(A=o-1),{curves:e.curves,points:n,isCW:a.xJ6.isClockWise(n),identifier:-1,boundingBox:new a.UtB(new a.I9Y(o,i),new a.I9Y(s,r))}}));p=p.filter((e=>e.points.length>1));for(let a=0;a<p.length;a++)p[a].identifier=a;const g=p.map((t=>function(e,t,n,r,i){null!=i&&""!==i||(i="nonzero");const s=new a.I9Y;e.boundingBox.getCenter(s);const o=f([new a.I9Y(n,s.y),new a.I9Y(r,s.y)],e.boundingBox,t);o.sort(((e,t)=>e.point.x-t.point.x));const l=[],c=[];o.forEach((t=>{t.identifier===e.identifier?l.push(t):c.push(t)}));const h=l[0].point.x,u=[];let d=0;for(;d<c.length&&c[d].point.x<h;)u.length>0&&u[u.length-1]===c[d].identifier?u.pop():u.push(c[d].identifier),d++;if(u.push(e.identifier),"evenodd"===i){const t=u.length%2==0,n=u[u.length-2];return{identifier:e.identifier,isHole:t,for:n}}if("nonzero"===i){let n=!0,r=null,i=null;for(let e=0;e<u.length;e++){const s=u[e];n?(i=t[s].isCW,n=!1,r=s):i!==t[s].isCW&&(i=t[s].isCW,n=!0)}return{identifier:e.identifier,isHole:n,for:r}}console.warn('fill-rule: "'+i+'" is currently not implemented.')}(t,p,A,m,e.userData?e.userData.style.fillRule:void 0))),v=[];return p.forEach((e=>{if(!g[e.identifier].isHole){const t=new a.ypk;t.curves=e.curves;g.filter((t=>t.isHole&&t.for===e.identifier)).forEach((e=>{const n=p[e.identifier],r=new a.wAk;r.curves=n.curves,t.holes.push(r)})),v.push(t)}})),v}static getStrokeStyle(e,t,n,r,i){return{strokeColor:t=void 0!==t?t:"#000",strokeWidth:e=void 0!==e?e:1,strokeLineJoin:n=void 0!==n?n:"miter",strokeLineCap:r=void 0!==r?r:"butt",strokeMiterLimit:i=void 0!==i?i:4}}static pointsToStroke(t,n,r,i){const s=[],o=[],l=[];if(0===e.pointsToStrokeWithBuffers(t,n,r,i,s,o,l))return null;const c=new a.LoY;return c.setAttribute("position",new a.qtW(s,3)),c.setAttribute("normal",new a.qtW(o,3)),c.setAttribute("uv",new a.qtW(l,2)),c}static pointsToStrokeWithBuffers(e,t,n,r,i,s,o,l){const c=new a.I9Y,h=new a.I9Y,u=new a.I9Y,d=new a.I9Y,f=new a.I9Y,A=new a.I9Y,m=new a.I9Y,p=new a.I9Y,g=new a.I9Y,v=new a.I9Y,y=new a.I9Y,E=new a.I9Y,x=new a.I9Y,C=new a.I9Y,w=new a.I9Y,I=new a.I9Y,b=new a.I9Y;n=void 0!==n?n:12,r=void 0!==r?r:.001,l=void 0!==l?l:0,e=function(e){let t=!1;for(let i=1,s=e.length-1;i<s;i++)if(e[i].distanceTo(e[i+1])<r){t=!0;break}if(!t)return e;const n=[];n.push(e[0]);for(let i=1,s=e.length-1;i<s;i++)e[i].distanceTo(e[i+1])>=r&&n.push(e[i]);return n.push(e[e.length-1]),n}(e);const S=e.length;if(S<2)return 0;const B=e[0].equals(e[S-1]);let T,_,M=e[0];const R=t.strokeWidth/2,D=1/(S-1);let P,L,k,F,O=0,U=!1,Q=0,N=3*l,z=2*l;G(e[0],e[1],c).multiplyScalar(R),p.copy(e[0]).sub(c),g.copy(e[0]).add(c),v.copy(p),y.copy(g);for(let a=1;a<S;a++){T=e[a],_=a===S-1?B?e[1]:void 0:e[a+1];const n=c;if(G(M,T,n),u.copy(n).multiplyScalar(R),E.copy(T).sub(u),x.copy(T).add(u),P=O+D,L=!1,void 0!==_){G(T,_,h),u.copy(h).multiplyScalar(R),C.copy(T).sub(u),w.copy(T).add(u),k=!0,u.subVectors(_,M),n.dot(u)<0&&(k=!1),1===a&&(U=k),u.subVectors(_,T),u.normalize();const e=Math.abs(n.dot(u));if(e>Number.EPSILON){const n=R/e;u.multiplyScalar(-n),d.subVectors(T,M),f.copy(d).setLength(n).add(u),I.copy(f).negate();const r=f.length(),i=d.length();d.divideScalar(i),A.subVectors(_,T);const s=A.length();switch(A.divideScalar(s),d.dot(I)<i&&A.dot(I)<s&&(L=!0),b.copy(f).add(T),I.add(T),F=!1,L?k?(w.copy(I),x.copy(I)):(C.copy(I),E.copy(I)):Y(),t.strokeLineJoin){case"bevel":j(k,L,P);break;case"round":V(k,L),k?q(T,E,C,P,0):q(T,w,x,P,1);break;default:const e=R*t.strokeMiterLimit/r;if(e<1){if("miter-clip"!==t.strokeLineJoin){j(k,L,P);break}V(k,L),k?(A.subVectors(b,E).multiplyScalar(e).add(E),m.subVectors(b,C).multiplyScalar(e).add(C),H(E,P,0),H(A,P,0),H(T,P,.5),H(T,P,.5),H(A,P,0),H(m,P,0),H(T,P,.5),H(m,P,0),H(C,P,0)):(A.subVectors(b,x).multiplyScalar(e).add(x),m.subVectors(b,w).multiplyScalar(e).add(w),H(x,P,1),H(A,P,1),H(T,P,.5),H(T,P,.5),H(A,P,1),H(m,P,1),H(T,P,.5),H(m,P,1),H(w,P,1))}else L?(k?(H(g,O,1),H(p,O,0),H(b,P,0),H(g,O,1),H(b,P,0),H(I,P,1)):(H(g,O,1),H(p,O,0),H(b,P,1),H(p,O,0),H(I,P,0),H(b,P,1)),k?C.copy(b):w.copy(b)):k?(H(E,P,0),H(b,P,0),H(T,P,.5),H(T,P,.5),H(b,P,0),H(C,P,0)):(H(x,P,1),H(b,P,1),H(T,P,.5),H(T,P,.5),H(b,P,1),H(w,P,1)),F=!0}}else Y()}else Y();B||a!==S-1||K(e[0],v,y,k,!0,O),O=P,M=T,p.copy(C),g.copy(w)}if(B){if(L&&i){let e=b,t=I;U!==k&&(e=I,t=b),k?(F||U)&&(t.toArray(i,0),t.toArray(i,9),F&&e.toArray(i,3)):!F&&U||(t.toArray(i,3),t.toArray(i,9),F&&e.toArray(i,0))}}else K(T,E,x,k,!1,P);return Q;function G(e,t,n){return n.subVectors(t,e),n.set(-n.y,n.x).normalize()}function H(e,t,n){i&&(i[N]=e.x,i[N+1]=e.y,i[N+2]=0,s&&(s[N]=0,s[N+1]=0,s[N+2]=1),N+=3,o&&(o[z]=t,o[z+1]=n,z+=2)),Q+=3}function q(e,t,r,i,s){c.copy(t).sub(e).normalize(),h.copy(r).sub(e).normalize();let a=Math.PI;const o=c.dot(h);Math.abs(o)<1&&(a=Math.abs(Math.acos(o))),a/=n,u.copy(t);for(let l=0,c=n-1;l<c;l++)d.copy(u).rotateAround(e,a),H(u,i,s),H(d,i,s),H(e,i,.5),u.copy(d);H(d,i,s),H(r,i,s),H(e,i,.5)}function Y(){H(g,O,1),H(p,O,0),H(E,P,0),H(g,O,1),H(E,P,0),H(x,P,1)}function j(e,t,n){t?e?(H(g,O,1),H(p,O,0),H(E,P,0),H(g,O,1),H(E,P,0),H(I,P,1),H(E,n,0),H(C,n,0),H(I,n,.5)):(H(g,O,1),H(p,O,0),H(x,P,1),H(p,O,0),H(I,P,0),H(x,P,1),H(x,n,1),H(I,n,0),H(w,n,1)):e?(H(E,n,0),H(C,n,0),H(T,n,.5)):(H(x,n,1),H(w,n,0),H(T,n,.5))}function V(e,t){t&&(e?(H(g,O,1),H(p,O,0),H(E,P,0),H(g,O,1),H(E,P,0),H(I,P,1),H(E,O,0),H(T,P,.5),H(I,P,1),H(T,P,.5),H(C,O,0),H(I,P,1)):(H(g,O,1),H(p,O,0),H(x,P,1),H(p,O,0),H(I,P,0),H(x,P,1),H(x,O,1),H(I,P,0),H(T,P,.5),H(T,P,.5),H(I,P,0),H(w,O,1)))}function K(e,n,r,s,a,l){switch(t.strokeLineCap){case"round":a?q(e,r,n,l,.5):q(e,n,r,l,.5);break;case"square":if(a)c.subVectors(n,e),h.set(c.y,-c.x),u.addVectors(c,h).add(e),d.subVectors(h,c).add(e),s?(u.toArray(i,3),d.toArray(i,0),d.toArray(i,9)):(u.toArray(i,3),1===o[7]?d.toArray(i,9):u.toArray(i,9),d.toArray(i,0));else{c.subVectors(r,e),h.set(c.y,-c.x),u.addVectors(c,h).add(e),d.subVectors(h,c).add(e);const t=i.length;s?(u.toArray(i,t-3),d.toArray(i,t-6),d.toArray(i,t-12)):(d.toArray(i,t-6),u.toArray(i,t-3),d.toArray(i,t-12))}}}}}return e})(),Za=(0,i.forwardRef)((function({src:e,skipFill:t,skipStrokes:n,fillMaterial:s,strokeMaterial:l,fillMeshProps:c,strokeMeshProps:h,...u},d){const f=(0,o.F)($a,e.startsWith("<svg")?`data:image/svg+xml;utf8,${e}`:e),A=(0,i.useMemo)((()=>n?[]:f.paths.map((e=>{var t;return void 0===(null==(t=e.userData)?void 0:t.style.stroke)||"none"===e.userData.style.stroke?null:e.subPaths.map((t=>$a.pointsToStroke(t.getPoints(),e.userData.style)))}))),[f,n]);(0,i.useEffect)((()=>()=>A.forEach((e=>e&&e.map((e=>e.dispose()))))),[A]);let m=0;return i.createElement("object3D",(0,r.A)({ref:d},u),i.createElement("object3D",{scale:[1,-1,1]},f.paths.map(((e,o)=>{var u,d;return i.createElement(i.Fragment,{key:o},!t&&void 0!==(null==(u=e.userData)?void 0:u.style.fill)&&"none"!==e.userData.style.fill&&$a.createShapes(e).map(((t,n)=>i.createElement("mesh",(0,r.A)({key:n},c,{renderOrder:m++}),i.createElement("shapeGeometry",{args:[t]}),i.createElement("meshBasicMaterial",(0,r.A)({color:e.userData.style.fill,opacity:e.userData.style.fillOpacity,transparent:!0,side:a.$EB,depthWrite:!1},s))))),!n&&void 0!==(null==(d=e.userData)?void 0:d.style.stroke)&&"none"!==e.userData.style.stroke&&e.subPaths.map(((t,n)=>i.createElement("mesh",(0,r.A)({key:n,geometry:A[o][n]},h,{renderOrder:m++}),i.createElement("meshBasicMaterial",(0,r.A)({color:e.userData.style.stroke,opacity:e.userData.style.strokeOpacity,transparent:!0,side:a.$EB,depthWrite:!1},l))))))}))))})),eo=new WeakMap;class to extends a.aHM{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,n,r){const i=new a.Y9S(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(e=>{const n={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,n).then(t).catch(r)}),n,r)}decodeDracoFile(e,t,n,r){const i={attributeIDs:n||this.defaultAttributeIDs,attributeTypes:r||this.defaultAttributeTypes,useUniqueIDs:!!n};this.decodeGeometry(e,i).then(t)}decodeGeometry(e,t){for(const o in t.attributeTypes){const e=t.attributeTypes[o];void 0!==e.BYTES_PER_ELEMENT&&(t.attributeTypes[o]=e.name)}const n=JSON.stringify(t);if(eo.has(e)){const t=eo.get(e);if(t.key===n)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let r;const i=this.workerNextTaskID++,s=e.byteLength,a=this._getWorker(i,s).then((n=>(r=n,new Promise(((n,s)=>{r._callbacks[i]={resolve:n,reject:s},r.postMessage({type:"decode",id:i,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return a.catch((()=>!0)).then((()=>{r&&i&&this._releaseTask(r,i)})),eo.set(e,{key:n,promise:a}),a}_createGeometry(e){const t=new a.LoY;e.index&&t.setIndex(new a.THS(e.index.array,1));for(let n=0;n<e.attributes.length;n++){const r=e.attributes[n],i=r.name,s=r.array,o=r.itemSize;t.setAttribute(i,new a.THS(s,o))}return t}_loadLibrary(e,t){const n=new a.Y9S(this.manager);return n.setPath(this.decoderPath),n.setResponseType(t),n.setWithCredentials(this.withCredentials),new Promise(((t,r)=>{n.load(e,t,void 0,r)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const n=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const r=no.toString(),i=["/* draco decoder */",n,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const n=t.data;switch(n.type){case"decode":e._callbacks[n.id].resolve(n);break;case"error":e._callbacks[n.id].reject(n);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+n.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const n=this.workerPool[this.workerPool.length-1];return n._taskCosts[e]=t,n._taskLoad+=t,n}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function no(){let e,t;function n(e,t,n,r,i,s){const a=s.num_components(),o=n.num_points()*a,l=o*i.BYTES_PER_ELEMENT,c=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,i),h=e._malloc(l);t.GetAttributeDataArrayForAllPoints(n,s,c,l,h);const u=new i(e.HEAPF32.buffer,h,o).slice();return e._free(h),{name:r,array:u,itemSize:a}}onmessage=function(r){const i=r.data;switch(i.type){case"init":e=i.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const r=i.buffer,s=i.taskConfig;t.then((e=>{const t=e.draco,a=new t.Decoder,o=new t.DecoderBuffer;o.Init(new Int8Array(r),r.byteLength);try{const e=function(e,t,r,i){const s=i.attributeIDs,a=i.attributeTypes;let o,l;const c=t.GetEncodedGeometryType(r);if(c===e.TRIANGULAR_MESH)o=new e.Mesh,l=t.DecodeBufferToMesh(r,o);else{if(c!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new e.PointCloud,l=t.DecodeBufferToPointCloud(r,o)}if(!l.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const h={index:null,attributes:[]};for(const u in s){const r=self[a[u]];let l,c;if(i.useUniqueIDs)c=s[u],l=t.GetAttributeByUniqueId(o,c);else{if(c=t.GetAttributeId(o,e[s[u]]),-1===c)continue;l=t.GetAttribute(o,c)}h.attributes.push(n(e,t,o,u,r,l))}c===e.TRIANGULAR_MESH&&(h.index=function(e,t,n){const r=n.num_faces(),i=3*r,s=4*i,a=e._malloc(s);t.GetTrianglesUInt32Array(n,s,a);const o=new Uint32Array(e.HEAPF32.buffer,a,i).slice();return e._free(a),{array:o,itemSize:1}}(e,t,o));return e.destroy(o),h}(t,a,o,s),r=e.attributes.map((e=>e.array.buffer));e.index&&r.push(e.index.array.buffer),self.postMessage({type:"decode",id:i.id,geometry:e},r)}catch(l){console.error(l),self.postMessage({type:"error",id:i.id,error:l.message})}finally{t.destroy(o),t.destroy(a)}}))}}}let ro;const io=()=>{if(ro)return ro;const e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),t=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]);if("object"!=typeof WebAssembly)return{supported:!1};let n,r="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB";WebAssembly.validate(e)&&(r="B9h9z9tFBBBFiI9gBB9gLaaaaaFa9gEaaaB9gFaFaEMcBBFBFFGGGEILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBOn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBNI9z9iqlBVc+N9IcIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMk8lLbaE97F9+FaL978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAeDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAeDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBReCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBH8ZCFD9tA8ZAPD9OD9hD9RH8ZDQBTFtGmEYIPLdKeOnHpAIAQJDBIBHyCFD9tAyAPD9OD9hD9RHyAIASJDBIBH8cCFD9tA8cAPD9OD9hD9RH8cDQBTFtGmEYIPLdKeOnH8dDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAeD9uHeDyBjGBAEAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeApA8dDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNiV8ZcpMyS8cQ8df8eb8fHdAyA8cDQNiV8ZcpMyS8cQ8df8eb8fH8ZDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/dLEK97FaF97GXGXAGCI9HQBAF9FQFCBRGEXABABDBBBHECiD+rFCiD+sFD/6FHIAECND+rFCiD+sFD/6FAID/gFAECTD+rFCiD+sFD/6FHLD/gFD/kFD/lFHKCBDtD+2FHOAICUUUU94DtHND9OD9RD/kFHI9DBB/+hDYAIAID/mFAKAKD/mFALAOALAND9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHLD/mF9DBBX9LDYHOD/kFCgFDtD9OAECUUU94DtD9OD9QAIALD/mFAOD/kFCND+rFCU/+EDtD9OD9QAKALD/mFAOD/kFCTD+rFCUU/8ODtD9OD9QDMBBABCTJRBAGCIJHGAF9JQBSGMMAF9FQBCBRGEXABCTJHVAVDBBBHECBDtHOCUU98D8cFCUU98D8cEHND9OABDBBBHKAEDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAKAEDQBFGENVcMTtmYi8ZpyHECTD+sFD/6FHID/gFAECTD+rFCTD+sFD/6FHLD/gFD/kFD/lFHE9DB/+g6DYALAEAOD+2FHOALCUUUU94DtHcD9OD9RD/kFHLALD/mFAEAED/mFAIAOAIAcD9OD9RD/kFHEAED/mFD/kFD/kFD/jFD/nFHID/mF9DBBX9LDYHOD/kFCTD+rFALAID/mFAOD/kFCggEDtD9OD9QHLAEAID/mFAOD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHEDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAKAND9OALAEDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM/hEIGaF97FaL978jUUUUBCTlREGXAF9FQBCBRIEXAEABDBBBHLABCTJHKDBBBHODQILKOSQfbPden8c8d8e8fHNCTD+sFHVCID+rFDMIBAB9DBBU8/DY9D/zI818/DYAVCEDtD9QD/6FD/nFHVALAODQBFGENVcMTtmYi8ZpyHLCTD+rFCTD+sFD/6FD/mFHOAOD/mFAVALCTD+sFD/6FD/mFHcAcD/mFAVANCTD+rFCTD+sFD/6FD/mFHNAND/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHVD/mF9DBBX9LDYHLD/kFCggEDtHMD9OAcAVD/mFALD/kFCTD+rFD9QHcANAVD/mFALD/kFCTD+rFAOAVD/mFALD/kFAMD9OD9QHVDQBFTtGEmYILPdKOenHLD8dBAEDBIBDyB+t+J83EBABCNJALD8dFAEDBIBDyF+t+J83EBAKAcAVDQNVi8ZcMpySQ8c8dfb8e8fHVD8dBAEDBIBDyG+t+J83EBABCiJAVD8dFAEDBIBDyE+t+J83EBABCAJRBAICIJHIAF9JQBMMM9jFF97GXAGCGrAF9sHG9FQBCBRFEXABABDBBBHECND+rFCND+sFD/6FAECiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBABCTJRBAFCIJHFAG9JQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB");const i=WebAssembly.instantiate(function(e){const n=new Uint8Array(e.length);for(let t=0;t<e.length;++t){const r=e.charCodeAt(t);n[t]=r>96?r-71:r>64?r-65:r>47?r+4:r>46?63:62}let r=0;for(let i=0;i<e.length;++i)n[r++]=n[i]<60?t[n[i]]:64*(n[i]-60)+n[++i];return n.buffer.slice(0,r)}(r),{}).then((e=>{n=e.instance,n.exports.__wasm_call_ctors()}));function s(e,t,r,i,s,a){const o=n.exports.sbrk,l=r+3&-4,c=o(l*i),h=o(s.length),u=new Uint8Array(n.exports.memory.buffer);u.set(s,h);const d=e(c,r,i,h,s.length);if(0===d&&a&&a(c,l,i),t.set(u.subarray(c,c+r*i)),o(c-o(0)),0!==d)throw new Error(`Malformed buffer data: ${d}`)}const a={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},o={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return ro={ready:i,supported:!0,decodeVertexBuffer(e,t,r,i,o){s(n.exports.meshopt_decodeVertexBuffer,e,t,r,i,n.exports[a[o]])},decodeIndexBuffer(e,t,r,i){s(n.exports.meshopt_decodeIndexBuffer,e,t,r,i)},decodeIndexSequence(e,t,r,i){s(n.exports.meshopt_decodeIndexSequence,e,t,r,i)},decodeGltfBuffer(e,t,r,i,l,c){s(n.exports[o[l]],e,t,r,i,n.exports[a[c]])}},ro};function so(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let n=0,r=e.length;n<r;n++)t+=String.fromCharCode(e[n]);try{return decodeURIComponent(escape(t))}catch(Sf){return t}}const ao="srgb",oo="srgb-linear";class lo extends a.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new mo(e)})),this.register((function(e){return new po(e)})),this.register((function(e){return new bo(e)})),this.register((function(e){return new So(e)})),this.register((function(e){return new Bo(e)})),this.register((function(e){return new vo(e)})),this.register((function(e){return new yo(e)})),this.register((function(e){return new Eo(e)})),this.register((function(e){return new xo(e)})),this.register((function(e){return new Ao(e)})),this.register((function(e){return new Co(e)})),this.register((function(e){return new go(e)})),this.register((function(e){return new Io(e)})),this.register((function(e){return new wo(e)})),this.register((function(e){return new uo(e)})),this.register((function(e){return new To(e)})),this.register((function(e){return new _o(e)}))}load(e,t,n,r){const i=this;let s;if(""!==this.resourcePath)s=this.resourcePath;else if(""!==this.path){const t=a.r6x.extractUrlBase(e);s=a.r6x.resolveURL(t,this.path)}else s=a.r6x.extractUrlBase(e);this.manager.itemStart(e);const o=function(t){r?r(t):console.error(t),i.manager.itemError(e),i.manager.itemEnd(e)},l=new a.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(n){try{i.parse(n,s,(function(n){t(n),i.manager.itemEnd(e)}),o)}catch(Sf){o(Sf)}}),n,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i;const s={},a={};if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer){if(so(new Uint8Array(e.slice(0,4)))===Mo){try{s[ho.KHR_BINARY_GLTF]=new Po(e)}catch(l){return void(r&&r(l))}i=JSON.parse(s[ho.KHR_BINARY_GLTF].content)}else i=JSON.parse(so(new Uint8Array(e)))}else i=e;if(void 0===i.asset||i.asset.version[0]<2)return void(r&&r(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const o=new il(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});o.fileLoader.setRequestHeader(this.requestHeader);for(let c=0;c<this.pluginCallbacks.length;c++){const e=this.pluginCallbacks[c](o);e.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[e.name]=e,s[e.name]=!0}if(i.extensionsUsed)for(let c=0;c<i.extensionsUsed.length;++c){const e=i.extensionsUsed[c],t=i.extensionsRequired||[];switch(e){case ho.KHR_MATERIALS_UNLIT:s[e]=new fo;break;case ho.KHR_DRACO_MESH_COMPRESSION:s[e]=new Lo(i,this.dracoLoader);break;case ho.KHR_TEXTURE_TRANSFORM:s[e]=new ko;break;case ho.KHR_MESH_QUANTIZATION:s[e]=new Fo;break;default:t.indexOf(e)>=0&&void 0===a[e]&&console.warn('THREE.GLTFLoader: Unknown extension "'+e+'".')}}o.setExtensions(s),o.setPlugins(a),o.parse(n,r)}parseAsync(e,t){const n=this;return new Promise((function(r,i){n.parse(e,t,r,i)}))}}function co(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const ho={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class uo{constructor(e){this.parser=e,this.name=ho.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){const r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let r=t.cache.get(n);if(r)return r;const i=t.json,s=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let o;const l=new a.Q1f(16777215);void 0!==s.color&&l.setRGB(s.color[0],s.color[1],s.color[2],oo);const c=void 0!==s.range?s.range:0;switch(s.type){case"directional":o=new a.ZyN(l),o.target.position.set(0,0,-1),o.add(o.target);break;case"point":o=new a.HiM(l),o.distance=c;break;case"spot":o=new a.nCl(l),o.distance=c,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,o.angle=s.spot.outerConeAngle,o.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,o.target.position.set(0,0,-1),o.add(o.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+s.type)}return o.position.set(0,0,0),o.decay=2,$o(o,s),void 0!==s.intensity&&(o.intensity=s.intensity),o.name=t.createUniqueName(s.name||"light_"+e),r=Promise.resolve(o),t.cache.add(n,r),r}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(e){return n._getNodeRef(t.cache,i,e)}))}}class fo{constructor(){this.name=ho.KHR_MATERIALS_UNLIT}getMaterialType(){return a.V9B}extendParams(e,t,n){const r=[];e.color=new a.Q1f(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],oo),e.opacity=t[3]}void 0!==i.baseColorTexture&&r.push(n.assignTexture(e,"map",i.baseColorTexture,ao))}return Promise.all(r)}}class Ao{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class mo{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],s=r.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&i.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&i.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(i.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){const e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new a.I9Y(e,e)}return Promise.all(i)}}class po{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class go{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],s=r.extensions[this.name];return void 0!==s.iridescenceFactor&&(t.iridescence=s.iridescenceFactor),void 0!==s.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",s.iridescenceTexture)),void 0!==s.iridescenceIor&&(t.iridescenceIOR=s.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==s.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=s.iridescenceThicknessMinimum),void 0!==s.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=s.iridescenceThicknessMaximum),void 0!==s.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",s.iridescenceThicknessTexture)),Promise.all(i)}}class vo{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new a.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;const s=r.extensions[this.name];if(void 0!==s.sheenColorFactor){const e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],oo)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&i.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,ao)),void 0!==s.sheenRoughnessTexture&&i.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(i)}}class yo{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],s=r.extensions[this.name];return void 0!==s.transmissionFactor&&(t.transmission=s.transmissionFactor),void 0!==s.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",s.transmissionTexture)),Promise.all(i)}}class Eo{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],s=r.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&i.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;const o=s.attenuationColor||[1,1,1];return t.attenuationColor=(new a.Q1f).setRGB(o[0],o[1],o[2],oo),Promise.all(i)}}class xo{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class Co{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],s=r.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&i.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));const o=s.specularColorFactor||[1,1,1];return t.specularColor=(new a.Q1f).setRGB(o[0],o[1],o[2],oo),void 0!==s.specularColorTexture&&i.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,ao)),Promise.all(i)}}class wo{constructor(e){this.parser=e,this.name=ho.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],s=r.extensions[this.name];return t.bumpScale=void 0!==s.bumpFactor?s.bumpFactor:1,void 0!==s.bumpTexture&&i.push(n.assignTexture(t,"bumpMap",s.bumpTexture)),Promise.all(i)}}class Io{constructor(e){this.parser=e,this.name=ho.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?a.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],s=r.extensions[this.name];return void 0!==s.anisotropyStrength&&(t.anisotropy=s.anisotropyStrength),void 0!==s.anisotropyRotation&&(t.anisotropyRotation=s.anisotropyRotation),void 0!==s.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",s.anisotropyTexture)),Promise.all(i)}}class bo{constructor(e){this.parser=e,this.name=ho.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;const i=r.extensions[this.name],s=t.options.ktx2Loader;if(!s){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,s)}}class So{constructor(e){this.parser=e,this.name=ho.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;const s=i.extensions[t],a=r.images[s.source];let o=n.textureLoader;if(a.uri){const e=n.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(i){if(i)return n.loadTextureImage(e,s.source,o);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Bo{constructor(e){this.parser=e,this.name=ho.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;const s=i.extensions[t],a=r.images[s.source];let o=n.textureLoader;if(a.uri){const e=n.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(i){if(i)return n.loadTextureImage(e,s.source,o);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class To{constructor(e){this.name=ho.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then((function(t){const n=e.byteOffset||0,r=e.byteLength||0,s=e.count,a=e.byteStride,o=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(s,a,o,e.mode,e.filter).then((function(e){return e.buffer})):i.ready.then((function(){const t=new ArrayBuffer(s*a);return i.decodeGltfBuffer(new Uint8Array(t),s,a,o,e.mode,e.filter),t}))}))}return null}}class _o{constructor(e){this.name=ho.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;const r=t.meshes[n.mesh];for(const a of r.primitives)if(a.mode!==No.TRIANGLES&&a.mode!==No.TRIANGLE_STRIP&&a.mode!==No.TRIANGLE_FAN&&void 0!==a.mode)return null;const i=n.extensions[this.name].attributes,s=[],o={};for(const a in i)s.push(this.parser.getDependency("accessor",i[a]).then((e=>(o[a]=e,o[a]))));return s.length<1?null:(s.push(this.parser.createNodeMesh(e)),Promise.all(s).then((e=>{const t=e.pop(),n=t.isGroup?t.children:[t],r=e[0].count,i=[];for(const s of n){const e=new a.kn4,t=new a.Pq0,n=new a.PTz,l=new a.Pq0(1,1,1),c=new a.ZLX(s.geometry,s.material,r);for(let i=0;i<r;i++)o.TRANSLATION&&t.fromBufferAttribute(o.TRANSLATION,i),o.ROTATION&&n.fromBufferAttribute(o.ROTATION,i),o.SCALE&&l.fromBufferAttribute(o.SCALE,i),c.setMatrixAt(i,e.compose(t,n,l));for(const r in o)if("_COLOR_0"===r){const e=o[r];c.instanceColor=new a.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==r&&"ROTATION"!==r&&"SCALE"!==r&&s.geometry.setAttribute(r,o[r]);a.B69.prototype.copy.call(c,s),this.parser.assignFinalMaterial(c),i.push(c)}return t.isGroup?(t.clear(),t.add(...i),t):i[0]})))}}const Mo="glTF",Ro=1313821514,Do=5130562;class Po{constructor(e){this.name=ho.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:so(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Mo)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,r=new DataView(e,12);let i=0;for(;i<n;){const t=r.getUint32(i,!0);i+=4;const n=r.getUint32(i,!0);if(i+=4,n===Ro){const n=new Uint8Array(e,12+i,t);this.content=so(n)}else if(n===Do){const n=12+i;this.body=e.slice(n,n+t)}i+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Lo{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=ho.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,r=this.dracoLoader,i=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},o={},l={};for(const c in s){const e=Yo[c]||c.toLowerCase();a[e]=s[c]}for(const c in e.attributes){const t=Yo[c]||c.toLowerCase();if(void 0!==s[c]){const r=n.accessors[e.attributes[c]],i=zo[r.componentType];l[t]=i.name,o[t]=!0===r.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t,n){r.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],r=o[t];void 0!==r&&(n.normalized=r)}t(e)}),a,l,oo,n)}))}))}}class ko{constructor(){this.name=ho.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Fo{constructor(){this.name=ho.KHR_MESH_QUANTIZATION}}class Oo extends a.lGw{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let s=0;s!==r;s++)t[s]=n[i+s];return t}interpolate_(e,t,n,r){const i=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,c=r-t,h=(n-t)/c,u=h*h,d=u*h,f=e*l,A=f-l,m=-2*d+3*u,p=d-u,g=1-m,v=p-u+h;for(let y=0;y!==a;y++){const e=s[A+y+a],t=s[A+y+o]*c,n=s[f+y+a],r=s[f+y]*c;i[y]=g*e+v*t+m*n+p*r}return i}}const Uo=new a.PTz;class Qo extends Oo{interpolate_(e,t,n,r){const i=super.interpolate_(e,t,n,r);return Uo.fromArray(i).normalize().toArray(i),i}}const No={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},zo={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Go={9728:a.hxR,9729:a.k6q,9984:a.pHI,9985:a.kRr,9986:a.Cfg,9987:a.$_I},Ho={33071:a.ghU,33648:a.kTW,10497:a.GJx},qo={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Yo={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...Sr>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},jo={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Vo={CUBICSPLINE:void 0,LINEAR:a.PJ3,STEP:a.ljd},Ko="OPAQUE",Wo="MASK",Jo="BLEND";function Xo(e,t,n){for(const r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function $o(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Zo(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function el(e){let t;const n=e.extensions&&e.extensions[ho.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+tl(n.attributes):e.indices+":"+tl(e.attributes)+":"+e.mode,void 0!==e.targets)for(let r=0,i=e.targets.length;r<i;r++)t+=":"+tl(e.targets[r]);return t}function tl(e){let t="";const n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function nl(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const rl=new a.kn4;class il{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new co,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,r=!1,i=-1;"undefined"!=typeof navigator&&void 0!==navigator.userAgent&&(n=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),r=navigator.userAgent.indexOf("Firefox")>-1,i=r?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||n||r&&i<98?this.textureLoader=new a.Tap(this.options.manager):this.textureLoader=new a.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new a.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const s={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return Xo(i,s,r),$o(s,r),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(s)}))).then((function(){for(const e of s.scenes)e.updateMatrixWorld();e(s)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let r=0,i=t.length;r<i;r++){const n=t[r].joints;for(let t=0,r=n.length;t<r;t++)e[n[t]].isBone=!0}for(let r=0,i=e.length;r<i;r++){const t=e[r];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(n[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const r=n.clone(),i=(e,t)=>{const n=this.associations.get(e);null!=n&&this.associations.set(t,n);for(const[r,s]of e.children.entries())i(s,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const r=e(t[n]);if(r)return r}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let r=0;r<t.length;r++){const i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){const n=e+":"+t;let r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":r=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":r=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":r=this.loadCamera(t);break;default:if(r=this._invokeOne((function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})),!r)throw new Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,r=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(r.map((function(t,r){return n.getDependency(e,r)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[ho.KHR_BINARY_GLTF].body);const r=this.options;return new Promise((function(e,i){n.load(a.r6x.resolveURL(t.uri,r.path),e,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)}))}loadAccessor(e){const t=this,n=this.json,r=this.json.accessors[e];if(void 0===r.bufferView&&void 0===r.sparse){const e=qo[r.type],t=zo[r.componentType],n=!0===r.normalized,i=new t(r.count*e);return Promise.resolve(new a.THS(i,e,n))}const i=[];return void 0!==r.bufferView?i.push(this.getDependency("bufferView",r.bufferView)):i.push(null),void 0!==r.sparse&&(i.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(i).then((function(e){const i=e[0],s=qo[r.type],o=zo[r.componentType],l=o.BYTES_PER_ELEMENT,c=l*s,h=r.byteOffset||0,u=void 0!==r.bufferView?n.bufferViews[r.bufferView].byteStride:void 0,d=!0===r.normalized;let f,A;if(u&&u!==c){const e=Math.floor(h/u),n="InterleavedBuffer:"+r.bufferView+":"+r.componentType+":"+e+":"+r.count;let c=t.cache.get(n);c||(f=new o(i,e*u,r.count*u/l),c=new a.eB$(f,u/l),t.cache.add(n,c)),A=new a.eHs(c,s,h%u/l,d)}else f=null===i?new o(r.count*s):new o(i,h,r.count*s),A=new a.THS(f,s,d);if(void 0!==r.sparse){const t=qo.SCALAR,n=zo[r.sparse.indices.componentType],l=r.sparse.indices.byteOffset||0,c=r.sparse.values.byteOffset||0,h=new n(e[1],l,r.sparse.count*t),u=new o(e[2],c,r.sparse.count*s);null!==i&&(A=new a.THS(A.array.slice(),A.itemSize,A.normalized));for(let e=0,r=h.length;e<r;e++){const t=h[e];if(A.setX(t,u[e*s]),s>=2&&A.setY(t,u[e*s+1]),s>=3&&A.setZ(t,u[e*s+2]),s>=4&&A.setW(t,u[e*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return A}))}loadTexture(e){const t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r];let s=this.textureLoader;if(i.uri){const e=n.manager.getHandler(i.uri);null!==e&&(s=e)}return this.loadTextureImage(e,r,s)}loadTextureImage(e,t,n){const r=this,i=this.json,s=i.textures[e],o=i.images[t],l=(o.uri||o.bufferView)+":"+s.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(t,n).then((function(t){t.flipY=!1,t.name=s.name||o.name||"",""===t.name&&"string"==typeof o.uri&&!1===o.uri.startsWith("data:image/")&&(t.name=o.uri);const n=(i.samplers||{})[s.sampler]||{};return t.magFilter=Go[n.magFilter]||a.k6q,t.minFilter=Go[n.minFilter]||a.$_I,t.wrapS=Ho[n.wrapS]||a.GJx,t.wrapT=Ho[n.wrapT]||a.GJx,r.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[l]=c,c}loadImageSource(e,t){const n=this,r=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const s=r.images[e],o=self.URL||self.webkitURL;let l=s.uri||"",c=!1;if(void 0!==s.bufferView)l=n.getDependency("bufferView",s.bufferView).then((function(e){c=!0;const t=new Blob([e],{type:s.mimeType});return l=o.createObjectURL(t),l}));else if(void 0===s.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(l).then((function(e){return new Promise((function(n,r){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){const t=new a.gPd(e);t.needsUpdate=!0,n(t)}),t.load(a.r6x.resolveURL(e,i.path),s,void 0,r)}))})).then((function(e){var t;return!0===c&&o.revokeObjectURL(l),$o(e,s),e.userData.mimeType=s.mimeType||((t=s.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),e}));return this.sourceCache[e]=h,h}assignTexture(e,t,n,r){const i=this;return this.getDependency("texture",n.index).then((function(s){if(!s)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((s=s.clone()).channel=n.texCoord),i.extensions[ho.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[ho.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(s);s=i.extensions[ho.KHR_TEXTURE_TRANSFORM].extendTexture(s,e),i.associations.set(s,t)}}return void 0!==r&&("number"==typeof r&&(r=3001===r?ao:oo),"colorSpace"in s?s.colorSpace=r:s.encoding=r===ao?3001:3e3),e[t]=s,s}))}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const r=void 0===t.attributes.tangent,i=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new a.BH$,a.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new a.mrM,a.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(r||i||s){let e="ClonedMaterial:"+n.uuid+":";r&&(e+="derivative-tangents:"),i&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),i&&(t.vertexColors=!0),s&&(t.flatShading=!0),r&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return a._4j}loadMaterial(e){const t=this,n=this.json,r=this.extensions,i=n.materials[e];let s;const o={},l=[];if((i.extensions||{})[ho.KHR_MATERIALS_UNLIT]){const e=r[ho.KHR_MATERIALS_UNLIT];s=e.getMaterialType(),l.push(e.extendParams(o,i,t))}else{const n=i.pbrMetallicRoughness||{};if(o.color=new a.Q1f(1,1,1),o.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;o.color.setRGB(e[0],e[1],e[2],oo),o.opacity=e[3]}void 0!==n.baseColorTexture&&l.push(t.assignTexture(o,"map",n.baseColorTexture,ao)),o.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,o.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(l.push(t.assignTexture(o,"metalnessMap",n.metallicRoughnessTexture)),l.push(t.assignTexture(o,"roughnessMap",n.metallicRoughnessTexture))),s=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===i.doubleSided&&(o.side=a.$EB);const c=i.alphaMode||Ko;if(c===Jo?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,c===Wo&&(o.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&s!==a.V9B&&(l.push(t.assignTexture(o,"normalMap",i.normalTexture)),o.normalScale=new a.I9Y(1,1),void 0!==i.normalTexture.scale)){const e=i.normalTexture.scale;o.normalScale.set(e,e)}if(void 0!==i.occlusionTexture&&s!==a.V9B&&(l.push(t.assignTexture(o,"aoMap",i.occlusionTexture)),void 0!==i.occlusionTexture.strength&&(o.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&s!==a.V9B){const e=i.emissiveFactor;o.emissive=(new a.Q1f).setRGB(e[0],e[1],e[2],oo)}return void 0!==i.emissiveTexture&&s!==a.V9B&&l.push(t.assignTexture(o,"emissiveMap",i.emissiveTexture,ao)),Promise.all(l).then((function(){const n=new s(o);return i.name&&(n.name=i.name),$o(n,i),t.associations.set(n,{materials:e}),i.extensions&&Xo(r,n,i),n}))}createUniqueName(e){const t=a.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,r=this.primitiveCache;function i(e){return n[ho.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(n){return sl(n,e,t)}))}const s=[];for(let o=0,l=e.length;o<l;o++){const n=e[o],l=el(n),c=r[l];if(c)s.push(c.promise);else{let e;e=n.extensions&&n.extensions[ho.KHR_DRACO_MESH_COMPRESSION]?i(n):sl(new a.LoY,n,t),r[l]={primitive:n,promise:e},s.push(e)}}return Promise.all(s)}loadMesh(e){const t=this,n=this.json,r=this.extensions,i=n.meshes[e],s=i.primitives,o=[];for(let c=0,h=s.length;c<h;c++){const e=void 0===s[c].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new a._4j({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:a.hB5})),l.DefaultMaterial):this.getDependency("material",s[c].material);o.push(e)}var l;return o.push(t.loadGeometries(s)),Promise.all(o).then((function(n){const o=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let u=0,d=l.length;u<d;u++){const n=l[u],h=s[u];let d;const f=o[u];if(h.mode===No.TRIANGLES||h.mode===No.TRIANGLE_STRIP||h.mode===No.TRIANGLE_FAN||void 0===h.mode)d=!0===i.isSkinnedMesh?new a.I46(n,f):new a.eaF(n,f),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),h.mode===No.TRIANGLE_STRIP?d.geometry=bs(d.geometry,a.O49):h.mode===No.TRIANGLE_FAN&&(d.geometry=bs(d.geometry,a.rYR));else if(h.mode===No.LINES)d=new a.DXC(n,f);else if(h.mode===No.LINE_STRIP)d=new a.N1A(n,f);else if(h.mode===No.LINE_LOOP)d=new a.FCc(n,f);else{if(h.mode!==No.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);d=new a.ONl(n,f)}Object.keys(d.geometry.morphAttributes).length>0&&Zo(d,i),d.name=t.createUniqueName(i.name||"mesh_"+e),$o(d,i),h.extensions&&Xo(r,d,h),t.assignFinalMaterial(d),c.push(d)}for(let r=0,i=c.length;r<i;r++)t.associations.set(c[r],{meshes:e,primitives:r});if(1===c.length)return i.extensions&&Xo(r,c[0],i),c[0];const h=new a.YJl;i.extensions&&Xo(r,h,i),t.associations.set(h,{meshes:e});for(let e=0,t=c.length;e<t;e++)h.add(c[e]);return h}))}loadCamera(e){let t;const n=this.json.cameras[e],r=n[n.type];if(r)return"perspective"===n.type?t=new a.ubm(a.cj9.radToDeg(r.yfov),r.aspectRatio||1,r.znear||1,r.zfar||2e6):"orthographic"===n.type&&(t=new a.qUd(-r.xmag,r.xmag,r.ymag,-r.ymag,r.znear,r.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),$o(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],n=[];for(let r=0,i=t.joints.length;r<i;r++)n.push(this._loadNodeShallow(t.joints[r]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then((function(e){const n=e.pop(),r=e,i=[],s=[];for(let o=0,l=r.length;o<l;o++){const e=r[o];if(e){i.push(e);const t=new a.kn4;null!==n&&t.fromArray(n.array,16*o),s.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[o])}return new a.EAD(i,s)}))}loadAnimation(e){const t=this.json,n=this,r=t.animations[e],i=r.name?r.name:"animation_"+e,s=[],o=[],l=[],c=[],h=[];for(let a=0,u=r.channels.length;a<u;a++){const e=r.channels[a],t=r.samplers[e.sampler],n=e.target,i=n.node,u=void 0!==r.parameters?r.parameters[t.input]:t.input,d=void 0!==r.parameters?r.parameters[t.output]:t.output;void 0!==n.node&&(s.push(this.getDependency("node",i)),o.push(this.getDependency("accessor",u)),l.push(this.getDependency("accessor",d)),c.push(t),h.push(n))}return Promise.all([Promise.all(s),Promise.all(o),Promise.all(l),Promise.all(c),Promise.all(h)]).then((function(e){const t=e[0],r=e[1],s=e[2],o=e[3],l=e[4],c=[];for(let i=0,a=t.length;i<a;i++){const e=t[i],a=r[i],h=s[i],u=o[i],d=l[i];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const f=n._createAnimationTracks(e,a,h,u,d);if(f)for(let t=0;t<f.length;t++)c.push(f[t])}return new a.tz3(i,void 0,c)}))}createNodeMesh(e){const t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))}loadNode(e){const t=this,n=this.json.nodes[e],r=t._loadNodeShallow(e),i=[],s=n.children||[];for(let o=0,l=s.length;o<l;o++)i.push(t.getDependency("node",s[o]));const a=void 0===n.skin?Promise.resolve(null):t.getDependency("skin",n.skin);return Promise.all([r,Promise.all(i),a]).then((function(e){const t=e[0],n=e[1],r=e[2];null!==r&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(r,rl)}));for(let i=0,s=n.length;i<s;i++)t.add(n[i]);return t}))}_loadNodeShallow(e){const t=this.json,n=this.extensions,r=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const i=t.nodes[e],s=i.name?r.createUniqueName(i.name):"",o=[],l=r._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return l&&o.push(l),void 0!==i.camera&&o.push(r.getDependency("camera",i.camera).then((function(e){return r._getNodeRef(r.cameraCache,i.camera,e)}))),r._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){o.push(e)})),this.nodeCache[e]=Promise.all(o).then((function(t){let o;if(o=!0===i.isBone?new a.$Kf:t.length>1?new a.YJl:1===t.length?t[0]:new a.B69,o!==t[0])for(let e=0,n=t.length;e<n;e++)o.add(t[e]);if(i.name&&(o.userData.name=i.name,o.name=s),$o(o,i),i.extensions&&Xo(n,o,i),void 0!==i.matrix){const e=new a.kn4;e.fromArray(i.matrix),o.applyMatrix4(e)}else void 0!==i.translation&&o.position.fromArray(i.translation),void 0!==i.rotation&&o.quaternion.fromArray(i.rotation),void 0!==i.scale&&o.scale.fromArray(i.scale);return r.associations.has(o)||r.associations.set(o,{}),r.associations.get(o).nodes=e,o})),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],r=this,i=new a.YJl;n.name&&(i.name=r.createUniqueName(n.name)),$o(i,n),n.extensions&&Xo(t,i,n);const s=n.nodes||[],o=[];for(let a=0,l=s.length;a<l;a++)o.push(r.getDependency("node",s[a]));return Promise.all(o).then((function(e){for(let t=0,n=e.length;t<n;t++)i.add(e[t]);return r.associations=(e=>{const t=new Map;for(const[n,i]of r.associations)(n instanceof a.imn||n instanceof a.gPd)&&t.set(n,i);return e.traverse((e=>{const n=r.associations.get(e);null!=n&&t.set(e,n)})),t})(i),i}))}_createAnimationTracks(e,t,n,r,i){const s=[],o=e.name?e.name:e.uuid,l=[];let c;switch(jo[i.path]===jo.weights?e.traverse((function(e){e.morphTargetInfluences&&l.push(e.name?e.name:e.uuid)})):l.push(o),jo[i.path]){case jo.weights:c=a.Hit;break;case jo.rotation:c=a.MBL;break;case jo.position:case jo.scale:c=a.RiT;break;default:if(1===n.itemSize)c=a.Hit;else c=a.RiT}const h=void 0!==r.interpolation?Vo[r.interpolation]:a.PJ3,u=this._getArrayFromAccessor(n);for(let a=0,d=l.length;a<d;a++){const e=new c(l[a]+"."+jo[i.path],t.array,u,h);"CUBICSPLINE"===r.interpolation&&this._createCubicSplineTrackInterpolant(e),s.push(e)}return s}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=nl(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof a.MBL?Qo:Oo)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function sl(e,t,n){const r=t.attributes,i=[];function s(t,r){return n.getDependency("accessor",t).then((function(t){e.setAttribute(r,t)}))}for(const a in r){const t=Yo[a]||a.toLowerCase();t in e.attributes||i.push(s(r[a],t))}if(void 0!==t.indices&&!e.index){const r=n.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));i.push(r)}return $o(e,t),function(e,t,n){const r=t.attributes,i=new a.NRn;if(void 0===r.POSITION)return;{const e=n.json.accessors[r.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(i.set(new a.Pq0(t[0],t[1],t[2]),new a.Pq0(s[0],s[1],s[2])),e.normalized){const t=nl(zo[e.componentType]);i.min.multiplyScalar(t),i.max.multiplyScalar(t)}}const s=t.targets;if(void 0!==s){const e=new a.Pq0,t=new a.Pq0;for(let r=0,i=s.length;r<i;r++){const i=s[r];if(void 0!==i.POSITION){const r=n.json.accessors[i.POSITION],s=r.min,a=r.max;if(void 0!==s&&void 0!==a){if(t.setX(Math.max(Math.abs(s[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(s[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(s[2]),Math.abs(a[2]))),r.normalized){const e=nl(zo[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(e)}e.boundingBox=i;const o=new a.iyt;i.getCenter(o.center),o.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=o}(e,t,n),Promise.all(i).then((function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,s=!1;for(let c=0,h=t.length;c<h;c++){const e=t[c];if(void 0!==e.POSITION&&(r=!0),void 0!==e.NORMAL&&(i=!0),void 0!==e.COLOR_0&&(s=!0),r&&i&&s)break}if(!r&&!i&&!s)return Promise.resolve(e);const a=[],o=[],l=[];for(let c=0,h=t.length;c<h;c++){const h=t[c];if(r){const t=void 0!==h.POSITION?n.getDependency("accessor",h.POSITION):e.attributes.position;a.push(t)}if(i){const t=void 0!==h.NORMAL?n.getDependency("accessor",h.NORMAL):e.attributes.normal;o.push(t)}if(s){const t=void 0!==h.COLOR_0?n.getDependency("accessor",h.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l)]).then((function(t){const n=t[0],a=t[1],o=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=a),s&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,n):e}))}let al=null,ol="https://www.gstatic.com/draco/versioned/decoders/1.5.5/";function ll(e=!0,t=!0,n){return r=>{n&&n(r),e&&(al||(al=new to),al.setDecoderPath("string"==typeof e?e:ol),r.setDRACOLoader(al)),t&&r.setMeshoptDecoder(io())}}const cl=(e,t,n,r)=>(0,o.F)(lo,e,ll(t,n,r));cl.preload=(e,t,n,r)=>o.F.preload(lo,e,ll(t,n,r)),cl.clear=e=>o.F.clear(lo,e),cl.setDecoderPath=e=>{ol=e};const hl=i.forwardRef((({src:e,useDraco:t,useMeshOpt:n,extendLoader:s,...a},o)=>{const{scene:l}=cl(e,t,n,s);return i.createElement(Na,(0,r.A)({ref:o},a,{object:l}))}));class ul{constructor(e,t=" .:-=+*#%@",n={}){const r=n.resolution||.15,i=n.scale||1,s=n.color||!1,a=n.alpha||!1,o=n.block||!1,l=n.invert||!1,c=n.strResolution||"low";let h,u;const d=document.createElement("div");d.style.cursor="default";const f=document.createElement("table");let A,m,p;d.appendChild(f),this.setSize=function(t,n){h=t,u=n,e.setSize(t,n),function(){A=Math.floor(h*r),m=Math.floor(u*r),x.width=A,x.height=m,p=e.domElement,p.style.backgroundColor&&(f.rows[0].cells[0].style.backgroundColor=p.style.backgroundColor,f.rows[0].cells[0].style.color=p.style.color);f.cellSpacing=0,f.cellPadding=0;const t=f.style;t.whiteSpace="pre",t.margin="0px",t.padding="0px",t.letterSpacing=S+"px",t.fontFamily=y,t.fontSize=I+"px",t.lineHeight=b+"px",t.textAlign="left",t.textDecoration="none"}()},this.render=function(t,n){e.render(t,n),function(e){C.clearRect(0,0,A,m),C.drawImage(E,0,0,A,m);const t=C.getImageData(0,0,A,m).data;let n="";for(let r=0;r<m;r+=2){for(let e=0;e<A;e++){const i=4*(r*A+e),c=t[i],h=t[i+1],u=t[i+2],d=t[i+3];let f,m;m=(.3*c+.59*h+.11*u)/255,0==d&&(m=1),f=Math.floor((1-m)*(w.length-1)),l&&(f=w.length-f-1);let p=w[f];void 0!==p&&" "!=p||(p="&nbsp;"),n+=s?"<span style='color:rgb("+c+","+h+","+u+");"+(o?"background-color:rgb("+c+","+h+","+u+");":"")+(a?"opacity:"+d/255+";":"")+"'>"+p+"</span>":p}n+="<br/>"}e.innerHTML=`<tr><td style="display:block;width:${h}px;height:${u}px;overflow:hidden">${n}</td></tr>`}(f)},this.domElement=d;const g=" .,:;i1tfLCG08@".split(""),v=" CGO08@".split(""),y="courier new, monospace",E=e.domElement,x=document.createElement("canvas");if(!x.getContext)return;const C=x.getContext("2d");if(!C.getImageData)return;let w=s?v:g;t&&(w=t);const I=2/r*i,b=2/r*i;let S=0;if("low"==c)switch(i){case 1:S=-1;break;case 2:case 3:S=-2.1;break;case 4:S=-3.1;break;case 5:S=-4.15}if("medium"==c)switch(i){case 1:S=0;break;case 2:S=-1;break;case 3:S=-1.04;break;case 4:case 5:S=-2.1}if("high"==c)switch(i){case 1:case 2:S=0;break;case 3:case 4:case 5:S=-1}}}function dl({renderIndex:e=1,bgColor:t="black",fgColor:n="white",characters:r=" .:-+*=%@#",invert:s=!0,color:a=!1,resolution:l=.15}){const{size:c,gl:h,scene:u,camera:d}=(0,o.A)(),f=i.useMemo((()=>{const e=new ul(h,r,{invert:s,color:a,resolution:l});return e.domElement.style.position="absolute",e.domElement.style.top="0px",e.domElement.style.left="0px",e.domElement.style.pointerEvents="none",e}),[r,s,a,l]);return i.useLayoutEffect((()=>{f.domElement.style.color=n,f.domElement.style.backgroundColor=t}),[n,t]),i.useEffect((()=>(h.domElement.style.opacity="0",h.domElement.parentNode.appendChild(f.domElement),()=>{h.domElement.style.opacity="1",h.domElement.parentNode.removeChild(f.domElement)})),[f]),i.useEffect((()=>{f.setSize(c.width,c.height)}),[f,c]),(0,o.C)((e=>{f.render(u,d)}),e),i.createElement(i.Fragment,null)}const fl=aa({alphaTest:0,viewport:new a.I9Y(1980,1080),focal:1e3,centerAndScaleTexture:null,covAndColorTexture:null},"\n    precision highp sampler2D;\n    precision highp usampler2D;\n    out vec4 vColor;\n    out vec3 vPosition;\n    uniform vec2 resolution;\n    uniform vec2 viewport;\n    uniform float focal;\n    attribute uint splatIndex;\n    uniform sampler2D centerAndScaleTexture;\n    uniform usampler2D covAndColorTexture;    \n\n    vec2 unpackInt16(in uint value) {\n      int v = int(value);\n      int v0 = v >> 16;\n      int v1 = (v & 0xFFFF);\n      if((v & 0x8000) != 0)\n        v1 |= 0xFFFF0000;\n      return vec2(float(v1), float(v0));\n    }\n\n    void main () {\n      ivec2 texSize = textureSize(centerAndScaleTexture, 0);\n      ivec2 texPos = ivec2(splatIndex%uint(texSize.x), splatIndex/uint(texSize.x));\n      vec4 centerAndScaleData = texelFetch(centerAndScaleTexture, texPos, 0);\n      vec4 center = vec4(centerAndScaleData.xyz, 1);\n      vec4 camspace = modelViewMatrix * center;\n      vec4 pos2d = projectionMatrix * camspace;\n\n      float bounds = 1.2 * pos2d.w;\n      if (pos2d.z < -pos2d.w || pos2d.x < -bounds || pos2d.x > bounds\n        || pos2d.y < -bounds || pos2d.y > bounds) {\n        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);\n        return;\n      }\n\n      uvec4 covAndColorData = texelFetch(covAndColorTexture, texPos, 0);\n      vec2 cov3D_M11_M12 = unpackInt16(covAndColorData.x) * centerAndScaleData.w;\n      vec2 cov3D_M13_M22 = unpackInt16(covAndColorData.y) * centerAndScaleData.w;\n      vec2 cov3D_M23_M33 = unpackInt16(covAndColorData.z) * centerAndScaleData.w;\n      mat3 Vrk = mat3(\n        cov3D_M11_M12.x, cov3D_M11_M12.y, cov3D_M13_M22.x,\n        cov3D_M11_M12.y, cov3D_M13_M22.y, cov3D_M23_M33.x,\n        cov3D_M13_M22.x, cov3D_M23_M33.x, cov3D_M23_M33.y\n      );\n\n      mat3 J = mat3(\n        focal / camspace.z, 0., -(focal * camspace.x) / (camspace.z * camspace.z),\n        0., focal / camspace.z, -(focal * camspace.y) / (camspace.z * camspace.z),\n        0., 0., 0.\n      );\n\n      mat3 W = transpose(mat3(modelViewMatrix));\n      mat3 T = W * J;\n      mat3 cov = transpose(T) * Vrk * T;\n      vec2 vCenter = vec2(pos2d) / pos2d.w;\n      float diagonal1 = cov[0][0] + 0.3;\n      float offDiagonal = cov[0][1];\n      float diagonal2 = cov[1][1] + 0.3;\n      float mid = 0.5 * (diagonal1 + diagonal2);\n      float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n      float lambda1 = mid + radius;\n      float lambda2 = max(mid - radius, 0.1);\n      vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n      vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;\n      vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);\n      uint colorUint = covAndColorData.w;\n      vColor = vec4(\n        float(colorUint & uint(0xFF)) / 255.0,\n        float((colorUint >> uint(8)) & uint(0xFF)) / 255.0,\n        float((colorUint >> uint(16)) & uint(0xFF)) / 255.0,\n        float(colorUint >> uint(24)) / 255.0\n      );\n      vPosition = position;\n\n      gl_Position = vec4(\n        vCenter \n          + position.x * v2 / viewport * 2.0 \n          + position.y * v1 / viewport * 2.0, pos2d.z / pos2d.w, 1.0);\n    }\n    ",`\n    #include <alphatest_pars_fragment>\n    #include <alphahash_pars_fragment>\n    in vec4 vColor;\n    in vec3 vPosition;\n    void main () {\n      float A = -dot(vPosition.xy, vPosition.xy);\n      if (A < -4.0) discard;\n      float B = exp(A) * vColor.a;\n      vec4 diffuseColor = vec4(vColor.rgb, B);\n      #include <alphatest_fragment>\n      #include <alphahash_fragment>\n      gl_FragColor = diffuseColor;\n      #include <tonemapping_fragment>\n      #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n    }\n  `);function Al(e){let t=null,n=0;e.onmessage=r=>{if("push"==r.data.method){0===n&&(t=new Float32Array(r.data.length));const e=new Float32Array(r.data.matrices);t.set(e,n),n+=e.length}else if("sort"==r.data.method&&null!==t){const n=function(e,n=!1){const r=t.length/16;let i=-1/0,s=1/0;const a=new Float32Array(r),o=new Int32Array(a.buffer),l=new Int32Array(r);let c=0;for(let A=0;A<r;A++){const r=e[0]*t[16*A+12]+e[1]*t[16*A+13]+e[2]*t[16*A+14]+e[3];(n||r<0&&t[16*A+15]>-1e-4*r)&&(a[c]=r,l[c]=A,c++,r>i&&(i=r),r<s&&(s=r))}const h=65535/(i-s),u=new Uint32Array(65536);for(let t=0;t<c;t++)o[t]=(a[t]-s)*h|0,u[o[t]]++;const d=new Uint32Array(65536);for(let t=1;t<65536;t++)d[t]=d[t-1]+u[t-1];const f=new Uint32Array(c);for(let t=0;t<c;t++)f[d[o[t]]++]=l[t];return f}(new Float32Array(r.data.view),r.data.hashed);e.postMessage({indices:n,key:r.data.key},[n.buffer])}}}class ml extends a.aHM{constructor(...e){super(...e),this.gl=null,this.chunkSize=25e3}load(e,t,n,r){const i={gl:this.gl,url:this.manager.resolveURL(e),worker:new Worker(URL.createObjectURL(new Blob(["(",Al.toString(),")(self)"],{type:"application/javascript"}))),manager:this.manager,update:(e,t,n)=>function(e,t,n,r){if(e.updateMatrixWorld(),t.gl.getCurrentViewport(n.viewport),n.material.viewport.x=n.viewport.z,n.material.viewport.y=n.viewport.w,n.material.focal=n.viewport.w/2*Math.abs(e.projectionMatrix.elements[5]),n.ready){if(r&&n.sorted)return;n.ready=!1;const e=new Float32Array([n.modelViewMatrix.elements[2],-n.modelViewMatrix.elements[6],n.modelViewMatrix.elements[10],n.modelViewMatrix.elements[14]]);t.worker.postMessage({method:"sort",src:t.url,key:n.uuid,view:e.buffer,hashed:r},[e.buffer]),r&&t.loaded&&(n.sorted=!0)}}(t,i,e,n),connect:e=>function(e,t){e.loading||async function(e){e.loading=!0;let t=0,n=0;const r=[];let i=0;const s=0!==e.totalDownloadBytes;for(;;)try{const{value:a,done:o}=await e.stream.read();if(o)break;if(t+=a.length,null!=e.totalDownloadBytes){const n=t/e.totalDownloadBytes*100;if(e.onProgress&&n-i>1){const r=new ProgressEvent("progress",{lengthComputable:s,loaded:t,total:e.totalDownloadBytes});e.onProgress(r),i=n}}r.push(a);const l=t-n;if(null!=e.totalDownloadBytes&&l>e.rowLength*e.chunkSize){let t=Math.floor(l/e.rowLength);const i=new Uint8Array(l);let a=0;for(const e of r)i.set(e,a),a+=e.length;if(r.length=0,l>t*e.rowLength){const n=new Uint8Array(l-t*e.rowLength);n.set(i.subarray(l-n.length,l),0),r.push(n)}const o=new Uint8Array(t*e.rowLength);o.set(i.subarray(0,o.byteLength),0);const c=pl(e,o.buffer,t);if(e.worker.postMessage({method:"push",src:e.url,length:16*e.numVertices,matrices:c.buffer},[c.buffer]),n+=t*e.rowLength,e.onProgress){const t=new ProgressEvent("progress",{lengthComputable:s,loaded:e.totalDownloadBytes,total:e.totalDownloadBytes});e.onProgress(t)}}}catch(a){console.error(a);break}if(t-n>0){let t=new Uint8Array(r.reduce(((e,t)=>e+t.length),0)),n=0;for(const e of r)t.set(e,n),n+=e.length;let i=Math.floor(t.byteLength/e.rowLength);const s=pl(e,t.buffer,i);e.worker.postMessage({method:"push",src:e.url,length:16*i,matrices:s.buffer},[s.buffer])}e.loaded=!0,e.manager.itemEnd(e.url)}(e);t.ready=!1,t.pm=new a.kn4,t.vm1=new a.kn4,t.vm2=new a.kn4,t.viewport=new a.IUQ;let n=new Uint32Array(e.bufferTextureWidth*e.bufferTextureHeight);const r=new a.uWO(n,1,!1);r.setUsage(a.Vnu);const i=t.geometry=new a.CmU,s=new Float32Array(18),o=new a.THS(s,3);function l(e){if(t&&e.data.key===t.uuid){let n=new Uint32Array(e.data.indices);i.attributes.splatIndex.set(n),i.attributes.splatIndex.needsUpdate=!0,i.instanceCount=n.length,t.ready=!0}}async function c(){for(;;){const t=e.gl.properties.get(e.centerAndScaleTexture),n=e.gl.properties.get(e.covAndColorTexture);if(null!=t&&t.__webglTexture&&null!=n&&n.__webglTexture&&e.loadedVertexCount>0)break;await new Promise((e=>setTimeout(e,10)))}t.ready=!0}return i.setAttribute("position",o),o.setXYZ(2,-2,2,0),o.setXYZ(1,2,2,0),o.setXYZ(0,-2,-2,0),o.setXYZ(5,-2,-2,0),o.setXYZ(4,2,2,0),o.setXYZ(3,2,-2,0),o.needsUpdate=!0,i.setAttribute("splatIndex",r),i.instanceCount=1,e.worker.addEventListener("message",l),c(),()=>e.worker.removeEventListener("message",l)}(i,e),loading:!1,loaded:!1,loadedVertexCount:0,chunkSize:this.chunkSize,totalDownloadBytes:0,numVertices:0,rowLength:32,maxVertexes:0,bufferTextureWidth:0,bufferTextureHeight:0,stream:null,centerAndScaleData:null,covAndColorData:null,covAndColorTexture:null,centerAndScaleTexture:null,onProgress:n};(async function(e){e.manager.itemStart(e.url);const t=await fetch(e.url);if(null===t.body)throw"Failed to fetch file";let n=t.headers.get("Content-Length");const r=n?parseInt(n):void 0;if(null==r)throw"Failed to get content length";e.stream=t.body.getReader(),e.totalDownloadBytes=r,e.numVertices=Math.floor(e.totalDownloadBytes/e.rowLength);const i=e.gl.getContext();let s=i.getParameter(i.MAX_TEXTURE_SIZE);e.maxVertexes=s*s,e.numVertices>e.maxVertexes&&(e.numVertices=e.maxVertexes);return e.bufferTextureWidth=s,e.bufferTextureHeight=Math.floor((e.numVertices-1)/s)+1,e.centerAndScaleData=new Float32Array(e.bufferTextureWidth*e.bufferTextureHeight*4),e.covAndColorData=new Uint32Array(e.bufferTextureWidth*e.bufferTextureHeight*4),e.centerAndScaleTexture=new a.GYF(e.centerAndScaleData,e.bufferTextureWidth,e.bufferTextureHeight,a.GWd,a.RQf),e.centerAndScaleTexture.needsUpdate=!0,e.covAndColorTexture=new a.GYF(e.covAndColorData,e.bufferTextureWidth,e.bufferTextureHeight,a.c90,a.bkx),e.covAndColorTexture.internalFormat="RGBA32UI",e.covAndColorTexture.needsUpdate=!0,e})(i).then(t).catch((e=>{null==r||r(e),i.manager.itemError(i.url)}))}}function pl(e,t,n){const r=e.gl.getContext();if(e.loadedVertexCount+n>e.maxVertexes&&(n=e.maxVertexes-e.loadedVertexCount),n<=0)throw"Failed to parse file";const i=new Uint8Array(t),s=new Float32Array(t),o=new Float32Array(16*n),l=new Uint8Array(e.covAndColorData.buffer),c=new Int16Array(e.covAndColorData.buffer);for(let h=0;h<n;h++){const t=new a.PTz(-(i[32*h+28+1]-128)/128,(i[32*h+28+2]-128)/128,(i[32*h+28+3]-128)/128,-(i[32*h+28+0]-128)/128);t.invert();const n=new a.Pq0(s[8*h+0],s[8*h+1],-s[8*h+2]),r=new a.Pq0(s[8*h+3+0],s[8*h+3+1],s[8*h+3+2]),u=new a.kn4;u.makeRotationFromQuaternion(t),u.transpose(),u.scale(r);const d=u.clone();u.transpose(),u.premultiply(d),u.setPosition(n);const f=[0,1,2,5,6,10];let A=0;for(let e=0;e<f.length;e++)Math.abs(u.elements[f[e]])>A&&(A=Math.abs(u.elements[f[e]]));let m=4*e.loadedVertexCount+4*h;e.centerAndScaleData[m+0]=n.x,e.centerAndScaleData[m+1]=-n.y,e.centerAndScaleData[m+2]=n.z,e.centerAndScaleData[m+3]=A/32767,m=8*e.loadedVertexCount+4*h*2;for(let e=0;e<f.length;e++)c[m+e]=32767*u.elements[f[e]]/A;m=16*e.loadedVertexCount+4*(4*h+3);const p=new a.Q1f(i[32*h+24+0]/255,i[32*h+24+1]/255,i[32*h+24+2]/255);p.convertSRGBToLinear(),l[m+0]=255*p.r,l[m+1]=255*p.g,l[m+2]=255*p.b,l[m+3]=i[32*h+24+3],u.elements[15]=Math.max(r.x,r.y,r.z)*i[32*h+24+3]/255;for(let e=0;e<16;e++)o[16*h+e]=u.elements[e]}for(;n>0;){let t=0,i=0;const s=e.loadedVertexCount%e.bufferTextureWidth,a=Math.floor(e.loadedVertexCount/e.bufferTextureWidth);e.loadedVertexCount%e.bufferTextureWidth!=0?(t=Math.min(e.bufferTextureWidth,s+n)-s,i=1):Math.floor(n/e.bufferTextureWidth)>0?(t=e.bufferTextureWidth,i=Math.floor(n/e.bufferTextureWidth)):(t=n%e.bufferTextureWidth,i=1);const o=e.gl.properties.get(e.centerAndScaleTexture);r.bindTexture(r.TEXTURE_2D,o.__webglTexture),r.texSubImage2D(r.TEXTURE_2D,0,s,a,t,i,r.RGBA,r.FLOAT,e.centerAndScaleData,4*e.loadedVertexCount);const l=e.gl.properties.get(e.covAndColorTexture);r.bindTexture(r.TEXTURE_2D,l.__webglTexture),r.texSubImage2D(r.TEXTURE_2D,0,s,a,t,i,r.RGBA_INTEGER,r.UNSIGNED_INT,e.covAndColorData,4*e.loadedVertexCount),e.gl.resetState(),e.loadedVertexCount+=t*i,n-=t*i}return o}function gl({src:e,toneMapped:t=!1,alphaTest:n=0,alphaHash:s=!1,chunkSize:l=25e3,...c}){(0,o.e)({SplatMaterial:fl});const h=i.useRef(null),u=(0,o.A)((e=>e.gl)),d=(0,o.A)((e=>e.camera)),f=(0,o.F)(ml,e,(e=>{e.gl=u,e.chunkSize=l}));return i.useLayoutEffect((()=>f.connect(h.current)),[e]),(0,o.C)((()=>f.update(h.current,d,s))),i.createElement("mesh",(0,r.A)({ref:h,frustumCulled:!1},c),i.createElement("splatMaterial",{key:`${e}/${n}/${s}${fl.key}`,transparent:!s,depthTest:!0,alphaTest:s?0:n,centerAndScaleTexture:f.centerAndScaleTexture,covAndColorTexture:f.covAndColorTexture,depthWrite:!!s||n>0,blending:s?a.NTi:a.bCz,blendSrcAlpha:a.qad,alphaHash:!!s,toneMapped:t}))}function vl(e,t,n){const r=(0,o.A)((e=>e.size)),s=(0,o.A)((e=>e.viewport)),l="number"==typeof e?e:r.width*s.dpr,c="number"==typeof t?t:r.height*s.dpr,h=("number"==typeof e?n:e)||{},{samples:u=0,depth:d,...f}=h,A=i.useMemo((()=>{const e=new a.nWS(l,c,{minFilter:a.k6q,magFilter:a.k6q,type:a.ix0,...f});return d&&(e.depthTexture=new a.VCu(l,c,a.RQf)),e.samples=u,e}),[]);return i.useLayoutEffect((()=>{A.setSize(l,c),u&&(A.samples=u)}),[u,A,l,c]),i.useEffect((()=>()=>A.dispose()),[]),A}const yl=({children:e,width:t,height:n,...r})=>{const s=vl(t,n,r);return i.createElement(i.Fragment,null,null==e?void 0:e(s))},El=i.forwardRef((({envMap:e,resolution:t=256,frames:n=1/0,children:s,makeDefault:a,...l},c)=>{const h=(0,o.A)((({set:e})=>e)),u=(0,o.A)((({camera:e})=>e)),d=(0,o.A)((({size:e})=>e)),f=i.useRef(null);i.useImperativeHandle(c,(()=>f.current),[]);const A=i.useRef(null),m=vl(t);i.useLayoutEffect((()=>{l.manual||f.current.updateProjectionMatrix()}),[d,l]),i.useLayoutEffect((()=>{f.current.updateProjectionMatrix()})),i.useLayoutEffect((()=>{if(a){const e=u;return h((()=>({camera:f.current}))),()=>h((()=>({camera:e})))}}),[f,a,h]);let p=0,g=null;const v="function"==typeof s;return(0,o.C)((t=>{v&&(n===1/0||p<n)&&(A.current.visible=!1,t.gl.setRenderTarget(m),g=t.scene.background,e&&(t.scene.background=e),t.gl.render(t.scene,f.current),t.scene.background=g,t.gl.setRenderTarget(null),A.current.visible=!0,p++)})),i.createElement(i.Fragment,null,i.createElement("orthographicCamera",(0,r.A)({left:d.width/-2,right:d.width/2,top:d.height/2,bottom:d.height/-2,ref:f},l),!v&&s),i.createElement("group",{ref:A},v&&s(m.texture)))})),xl=i.forwardRef((({envMap:e,resolution:t=256,frames:n=1/0,makeDefault:s,children:a,...l},c)=>{const h=(0,o.A)((({set:e})=>e)),u=(0,o.A)((({camera:e})=>e)),d=(0,o.A)((({size:e})=>e)),f=i.useRef(null);i.useImperativeHandle(c,(()=>f.current),[]);const A=i.useRef(null),m=vl(t);i.useLayoutEffect((()=>{l.manual||(f.current.aspect=d.width/d.height)}),[d,l]),i.useLayoutEffect((()=>{f.current.updateProjectionMatrix()}));let p=0,g=null;const v="function"==typeof a;return(0,o.C)((t=>{v&&(n===1/0||p<n)&&(A.current.visible=!1,t.gl.setRenderTarget(m),g=t.scene.background,e&&(t.scene.background=e),t.gl.render(t.scene,f.current),t.scene.background=g,t.gl.setRenderTarget(null),A.current.visible=!0,p++)})),i.useLayoutEffect((()=>{if(s){const e=u;return h((()=>({camera:f.current}))),()=>h((()=>({camera:e})))}}),[f,s,h]),i.createElement(i.Fragment,null,i.createElement("perspectiveCamera",(0,r.A)({ref:f},l),!v&&a),i.createElement("group",{ref:A},v&&a(m.texture)))}));function Cl({resolution:e=256,near:t=.1,far:n=1e3,envMap:r,fog:s}={}){const l=(0,o.A)((({gl:e})=>e)),c=(0,o.A)((({scene:e})=>e)),h=(0,i.useMemo)((()=>{const t=new a.o6l(e);return t.texture.type=a.ix0,t}),[e]);(0,i.useEffect)((()=>()=>{h.dispose()}),[h]);const u=(0,i.useMemo)((()=>new a.F1T(t,n,h)),[t,n,h]);let d,f;const A=i.useCallback((()=>{d=c.fog,f=c.background,c.background=r||f,c.fog=s||d,u.update(l,c),c.fog=d,c.background=f}),[l,c,u]);return{fbo:h,camera:u,update:A}}function wl({children:e,frames:t=1/0,resolution:n,near:r,far:s,envMap:a,fog:l,...c}){const h=i.useRef(null),{fbo:u,camera:d,update:f}=Cl({resolution:n,near:r,far:s,envMap:a,fog:l});let A=0;return(0,o.C)((()=>{h.current&&(t===1/0||A<t)&&(h.current.visible=!1,f(),h.current.visible=!0,A++)})),i.createElement("group",c,i.createElement("primitive",{object:d}),i.createElement("group",{ref:h},null==e?void 0:e(u.texture)))}var Il=Object.defineProperty,bl=(e,t,n)=>(((e,t,n)=>{t in e?Il(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Sl{constructor(){bl(this,"_listeners")}addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;const n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)}removeEventListener(e,t){if(void 0===this._listeners)return;const n=this._listeners[e];if(void 0!==n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const n=t.slice(0);for(let t=0,r=n.length;t<r;t++)n[t].call(this,e);e.target=null}}}var Bl=Object.defineProperty,Tl=(e,t,n)=>(((e,t,n)=>{t in e?Bl(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class _l extends Sl{constructor(e){super(),Tl(this,"object"),Tl(this,"changeEvent",{type:"change"}),Tl(this,"EPS",1e-6),Tl(this,"enabled",!0),Tl(this,"deviceOrientation",{alpha:0,beta:0,gamma:0}),Tl(this,"screenOrientation",0),Tl(this,"alphaOffset",0),Tl(this,"onDeviceOrientationChangeEvent",(e=>{this.deviceOrientation=e})),Tl(this,"onScreenOrientationChangeEvent",(()=>{this.screenOrientation=window.orientation||0})),Tl(this,"zee",new a.Pq0(0,0,1)),Tl(this,"euler",new a.O9p),Tl(this,"q0",new a.PTz),Tl(this,"q1",new a.PTz(-Math.sqrt(.5),0,0,Math.sqrt(.5))),Tl(this,"setObjectQuaternion",((e,t,n,r,i)=>{this.euler.set(n,t,-r,"YXZ"),e.setFromEuler(this.euler),e.multiply(this.q1),e.multiply(this.q0.setFromAxisAngle(this.zee,-i))})),Tl(this,"connect",(()=>{this.onScreenOrientationChangeEvent(),void 0!==window.DeviceOrientationEvent&&"function"==typeof window.DeviceOrientationEvent.requestPermission?window.DeviceOrientationEvent.requestPermission().then((e=>{"granted"==e&&(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent))})).catch((e=>{console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",e)})):(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent)),this.enabled=!0})),Tl(this,"disconnect",(()=>{window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this.enabled=!1})),Tl(this,"lastQuaternion",new a.PTz),Tl(this,"update",(()=>{if(!1===this.enabled)return;const e=this.deviceOrientation;if(e){const t=e.alpha?a.cj9.degToRad(e.alpha)+this.alphaOffset:0,n=e.beta?a.cj9.degToRad(e.beta):0,r=e.gamma?a.cj9.degToRad(e.gamma):0,i=this.screenOrientation?a.cj9.degToRad(this.screenOrientation):0;this.setObjectQuaternion(this.object.quaternion,t,n,r,i),8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS&&(this.lastQuaternion.copy(this.object.quaternion),this.dispatchEvent(this.changeEvent))}})),Tl(this,"dispose",(()=>this.disconnect())),this.object=e,this.object.rotation.reorder("YXZ"),this.connect()}}const Ml=i.forwardRef(((e,t)=>{const{camera:n,onChange:s,makeDefault:a,...l}=e,c=(0,o.A)((e=>e.camera)),h=(0,o.A)((e=>e.invalidate)),u=(0,o.A)((e=>e.get)),d=(0,o.A)((e=>e.set)),f=n||c,A=i.useMemo((()=>new _l(f)),[f]);return i.useEffect((()=>{const e=e=>{h(),s&&s(e)};return null==A||null==A.addEventListener||A.addEventListener("change",e),()=>null==A||null==A.removeEventListener?void 0:A.removeEventListener("change",e)}),[s,A,h]),(0,o.C)((()=>null==A?void 0:A.update()),-1),i.useEffect((()=>{const e=A;return null==e||e.connect(),()=>null==e?void 0:e.dispose()}),[A]),i.useEffect((()=>{if(a){const e=u().controls;return d({controls:A}),()=>d({controls:e})}}),[a,A]),A?i.createElement("primitive",(0,r.A)({ref:t,object:A},l)):null}));var Rl=Object.defineProperty,Dl=(e,t,n)=>(((e,t,n)=>{t in e?Rl(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);function Pl(e){e.preventDefault()}class Ll extends Sl{constructor(e,t){super(),Dl(this,"object"),Dl(this,"domElement",null),Dl(this,"movementSpeed",1),Dl(this,"rollSpeed",.005),Dl(this,"dragToLook",!1),Dl(this,"autoForward",!1),Dl(this,"changeEvent",{type:"change"}),Dl(this,"EPS",1e-6),Dl(this,"tmpQuaternion",new a.PTz),Dl(this,"mouseStatus",0),Dl(this,"movementSpeedMultiplier",1),Dl(this,"moveState",{up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0}),Dl(this,"moveVector",new a.Pq0(0,0,0)),Dl(this,"rotationVector",new a.Pq0(0,0,0)),Dl(this,"keydown",(e=>{if(!e.altKey){switch(e.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this.moveState.forward=1;break;case"KeyS":this.moveState.back=1;break;case"KeyA":this.moveState.left=1;break;case"KeyD":this.moveState.right=1;break;case"KeyR":this.moveState.up=1;break;case"KeyF":this.moveState.down=1;break;case"ArrowUp":this.moveState.pitchUp=1;break;case"ArrowDown":this.moveState.pitchDown=1;break;case"ArrowLeft":this.moveState.yawLeft=1;break;case"ArrowRight":this.moveState.yawRight=1;break;case"KeyQ":this.moveState.rollLeft=1;break;case"KeyE":this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}})),Dl(this,"keyup",(e=>{switch(e.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this.moveState.forward=0;break;case"KeyS":this.moveState.back=0;break;case"KeyA":this.moveState.left=0;break;case"KeyD":this.moveState.right=0;break;case"KeyR":this.moveState.up=0;break;case"KeyF":this.moveState.down=0;break;case"ArrowUp":this.moveState.pitchUp=0;break;case"ArrowDown":this.moveState.pitchDown=0;break;case"ArrowLeft":this.moveState.yawLeft=0;break;case"ArrowRight":this.moveState.yawRight=0;break;case"KeyQ":this.moveState.rollLeft=0;break;case"KeyE":this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()})),Dl(this,"pointerdown",(e=>{if(this.dragToLook)this.mouseStatus++;else{switch(e.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1}this.updateMovementVector()}})),Dl(this,"pointermove",(e=>{if(!this.dragToLook||this.mouseStatus>0){const t=this.getContainerDimensions(),n=t.size[0]/2,r=t.size[1]/2;this.moveState.yawLeft=-(e.pageX-t.offset[0]-n)/n,this.moveState.pitchDown=(e.pageY-t.offset[1]-r)/r,this.updateRotationVector()}})),Dl(this,"pointerup",(e=>{if(this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(e.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0}this.updateMovementVector()}this.updateRotationVector()})),Dl(this,"lastQuaternion",new a.PTz),Dl(this,"lastPosition",new a.Pq0),Dl(this,"update",(e=>{const t=e*this.movementSpeed,n=e*this.rollSpeed;this.object.translateX(this.moveVector.x*t),this.object.translateY(this.moveVector.y*t),this.object.translateZ(this.moveVector.z*t),this.tmpQuaternion.set(this.rotationVector.x*n,this.rotationVector.y*n,this.rotationVector.z*n,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS)&&(this.dispatchEvent(this.changeEvent),this.lastQuaternion.copy(this.object.quaternion),this.lastPosition.copy(this.object.position))})),Dl(this,"updateMovementVector",(()=>{const e=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-e+this.moveState.back})),Dl(this,"updateRotationVector",(()=>{this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft})),Dl(this,"getContainerDimensions",(()=>this.domElement==document||this.domElement instanceof Document?{size:[window.innerWidth,window.innerHeight],offset:[0,0]}:{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]})),Dl(this,"connect",(e=>{this.domElement=e,e instanceof Document||e.setAttribute("tabindex",-1),this.domElement.addEventListener("contextmenu",Pl),this.domElement.addEventListener("pointermove",this.pointermove),this.domElement.addEventListener("pointerdown",this.pointerdown),this.domElement.addEventListener("pointerup",this.pointerup),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup)})),Dl(this,"dispose",(()=>{this.domElement.removeEventListener("contextmenu",Pl),this.domElement.removeEventListener("pointermove",this.pointermove),this.domElement.removeEventListener("pointerdown",this.pointerdown),this.domElement.removeEventListener("pointerup",this.pointerup),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup)})),this.object=e,void 0!==t&&this.connect(t),this.updateMovementVector(),this.updateRotationVector()}}const kl=i.forwardRef((({domElement:e,...t},n)=>{const{onChange:s,makeDefault:a,...l}=t,c=(0,o.A)((e=>e.invalidate)),h=(0,o.A)((e=>e.camera)),u=(0,o.A)((e=>e.gl)),d=(0,o.A)((e=>e.events)),f=(0,o.A)((e=>e.get)),A=(0,o.A)((e=>e.set)),m=e||d.connected||u.domElement,p=i.useMemo((()=>new Ll(h)),[h]);return i.useEffect((()=>(p.connect(m),()=>{p.dispose()})),[m,p,c]),i.useEffect((()=>{const e=e=>{c(),s&&s(e)};return null==p.addEventListener||p.addEventListener("change",e),()=>null==p.removeEventListener?void 0:p.removeEventListener("change",e)}),[s,c]),i.useEffect((()=>{if(a){const e=f().controls;return A({controls:p}),()=>A({controls:e})}}),[a,p]),(0,o.C)(((e,t)=>p.update(t))),i.createElement("primitive",(0,r.A)({ref:n,object:p,args:[h,m]},l))}));var Fl=Object.defineProperty,Ol=(e,t,n)=>(((e,t,n)=>{t in e?Fl(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Ul=new a.RlV,Ql=new a.Zcv,Nl=Math.cos(Math.PI/180*70),zl=(e,t)=>(e%t+t)%t;class Gl extends Sl{constructor(e,t){super(),Ol(this,"object"),Ol(this,"domElement"),Ol(this,"enabled",!0),Ol(this,"target",new a.Pq0),Ol(this,"minDistance",0),Ol(this,"maxDistance",1/0),Ol(this,"minZoom",0),Ol(this,"maxZoom",1/0),Ol(this,"minPolarAngle",0),Ol(this,"maxPolarAngle",Math.PI),Ol(this,"minAzimuthAngle",-1/0),Ol(this,"maxAzimuthAngle",1/0),Ol(this,"enableDamping",!1),Ol(this,"dampingFactor",.05),Ol(this,"enableZoom",!0),Ol(this,"zoomSpeed",1),Ol(this,"enableRotate",!0),Ol(this,"rotateSpeed",1),Ol(this,"enablePan",!0),Ol(this,"panSpeed",1),Ol(this,"screenSpacePanning",!0),Ol(this,"keyPanSpeed",7),Ol(this,"zoomToCursor",!1),Ol(this,"autoRotate",!1),Ol(this,"autoRotateSpeed",2),Ol(this,"reverseOrbit",!1),Ol(this,"reverseHorizontalOrbit",!1),Ol(this,"reverseVerticalOrbit",!1),Ol(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),Ol(this,"mouseButtons",{LEFT:a.kBv.ROTATE,MIDDLE:a.kBv.DOLLY,RIGHT:a.kBv.PAN}),Ol(this,"touches",{ONE:a.wtR.ROTATE,TWO:a.wtR.DOLLY_PAN}),Ol(this,"target0"),Ol(this,"position0"),Ol(this,"zoom0"),Ol(this,"_domElementKeyEvents",null),Ol(this,"getPolarAngle"),Ol(this,"getAzimuthalAngle"),Ol(this,"setPolarAngle"),Ol(this,"setAzimuthalAngle"),Ol(this,"getDistance"),Ol(this,"getZoomScale"),Ol(this,"listenToKeyEvents"),Ol(this,"stopListenToKeyEvents"),Ol(this,"saveState"),Ol(this,"reset"),Ol(this,"update"),Ol(this,"connect"),Ol(this,"dispose"),Ol(this,"dollyIn"),Ol(this,"dollyOut"),Ol(this,"getScale"),Ol(this,"setScale"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>h.phi,this.getAzimuthalAngle=()=>h.theta,this.setPolarAngle=e=>{let t=zl(e,2*Math.PI),r=h.phi;r<0&&(r+=2*Math.PI),t<0&&(t+=2*Math.PI);let i=Math.abs(t-r);2*Math.PI-i<i&&(t<r?t+=2*Math.PI:r+=2*Math.PI),u.phi=t-r,n.update()},this.setAzimuthalAngle=e=>{let t=zl(e,2*Math.PI),r=h.theta;r<0&&(r+=2*Math.PI),t<0&&(t+=2*Math.PI);let i=Math.abs(t-r);2*Math.PI-i<i&&(t<r?t+=2*Math.PI:r+=2*Math.PI),u.theta=t-r,n.update()},this.getDistance=()=>n.object.position.distanceTo(n.target),this.listenToKeyEvents=e=>{e.addEventListener("keydown",X),this._domElementKeyEvents=e},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",X),this._domElementKeyEvents=null},this.saveState=()=>{n.target0.copy(n.target),n.position0.copy(n.object.position),n.zoom0=n.object.zoom},this.reset=()=>{n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.zoom=n.zoom0,n.object.updateProjectionMatrix(),n.dispatchEvent(r),n.update(),l=o.NONE},this.update=(()=>{const t=new a.Pq0,i=new a.Pq0(0,1,0),s=(new a.PTz).setFromUnitVectors(e.up,i),A=s.clone().invert(),m=new a.Pq0,p=new a.PTz,g=2*Math.PI;return function(){const v=n.object.position;s.setFromUnitVectors(e.up,i),A.copy(s).invert(),t.copy(v).sub(n.target),t.applyQuaternion(s),h.setFromVector3(t),n.autoRotate&&l===o.NONE&&_(2*Math.PI/60/60*n.autoRotateSpeed),n.enableDamping?(h.theta+=u.theta*n.dampingFactor,h.phi+=u.phi*n.dampingFactor):(h.theta+=u.theta,h.phi+=u.phi);let y=n.minAzimuthAngle,E=n.maxAzimuthAngle;isFinite(y)&&isFinite(E)&&(y<-Math.PI?y+=g:y>Math.PI&&(y-=g),E<-Math.PI?E+=g:E>Math.PI&&(E-=g),h.theta=y<=E?Math.max(y,Math.min(E,h.theta)):h.theta>(y+E)/2?Math.max(y,h.theta):Math.min(E,h.theta)),h.phi=Math.max(n.minPolarAngle,Math.min(n.maxPolarAngle,h.phi)),h.makeSafe(),!0===n.enableDamping?n.target.addScaledVector(f,n.dampingFactor):n.target.add(f),n.zoomToCursor&&b||n.object.isOrthographicCamera?h.radius=U(h.radius):h.radius=U(h.radius*d),t.setFromSpherical(h),t.applyQuaternion(A),v.copy(n.target).add(t),n.object.matrixAutoUpdate||n.object.updateMatrix(),n.object.lookAt(n.target),!0===n.enableDamping?(u.theta*=1-n.dampingFactor,u.phi*=1-n.dampingFactor,f.multiplyScalar(1-n.dampingFactor)):(u.set(0,0,0),f.set(0,0,0));let x=!1;if(n.zoomToCursor&&b){let r=null;if(n.object instanceof a.ubm&&n.object.isPerspectiveCamera){const e=t.length();r=U(e*d);const i=e-r;n.object.position.addScaledVector(w,i),n.object.updateMatrixWorld()}else if(n.object.isOrthographicCamera){const e=new a.Pq0(I.x,I.y,0);e.unproject(n.object),n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/d)),n.object.updateProjectionMatrix(),x=!0;const i=new a.Pq0(I.x,I.y,0);i.unproject(n.object),n.object.position.sub(i).add(e),n.object.updateMatrixWorld(),r=t.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),n.zoomToCursor=!1;null!==r&&(n.screenSpacePanning?n.target.set(0,0,-1).transformDirection(n.object.matrix).multiplyScalar(r).add(n.object.position):(Ul.origin.copy(n.object.position),Ul.direction.set(0,0,-1).transformDirection(n.object.matrix),Math.abs(n.object.up.dot(Ul.direction))<Nl?e.lookAt(n.target):(Ql.setFromNormalAndCoplanarPoint(n.object.up,n.target),Ul.intersectPlane(Ql,n.target))))}else n.object instanceof a.qUd&&n.object.isOrthographicCamera&&(x=1!==d,x&&(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/d)),n.object.updateProjectionMatrix()));return d=1,b=!1,!!(x||m.distanceToSquared(n.object.position)>c||8*(1-p.dot(n.object.quaternion))>c)&&(n.dispatchEvent(r),m.copy(n.object.position),p.copy(n.object.quaternion),x=!1,!0)}})(),this.connect=e=>{n.domElement=e,n.domElement.style.touchAction="none",n.domElement.addEventListener("contextmenu",$),n.domElement.addEventListener("pointerdown",V),n.domElement.addEventListener("pointercancel",W),n.domElement.addEventListener("wheel",J)},this.dispose=()=>{var e,t,r,i,s,a;n.domElement&&(n.domElement.style.touchAction="auto"),null==(e=n.domElement)||e.removeEventListener("contextmenu",$),null==(t=n.domElement)||t.removeEventListener("pointerdown",V),null==(r=n.domElement)||r.removeEventListener("pointercancel",W),null==(i=n.domElement)||i.removeEventListener("wheel",J),null==(s=n.domElement)||s.ownerDocument.removeEventListener("pointermove",K),null==(a=n.domElement)||a.ownerDocument.removeEventListener("pointerup",W),null!==n._domElementKeyEvents&&n._domElementKeyEvents.removeEventListener("keydown",X)};const n=this,r={type:"change"},i={type:"start"},s={type:"end"},o={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let l=o.NONE;const c=1e-6,h=new a.YHV,u=new a.YHV;let d=1;const f=new a.Pq0,A=new a.I9Y,m=new a.I9Y,p=new a.I9Y,g=new a.I9Y,v=new a.I9Y,y=new a.I9Y,E=new a.I9Y,x=new a.I9Y,C=new a.I9Y,w=new a.Pq0,I=new a.I9Y;let b=!1;const S=[],B={};function T(){return Math.pow(.95,n.zoomSpeed)}function _(e){n.reverseOrbit||n.reverseHorizontalOrbit?u.theta+=e:u.theta-=e}function M(e){n.reverseOrbit||n.reverseVerticalOrbit?u.phi+=e:u.phi-=e}const R=(()=>{const e=new a.Pq0;return function(t,n){e.setFromMatrixColumn(n,0),e.multiplyScalar(-t),f.add(e)}})(),D=(()=>{const e=new a.Pq0;return function(t,r){!0===n.screenSpacePanning?e.setFromMatrixColumn(r,1):(e.setFromMatrixColumn(r,0),e.crossVectors(n.object.up,e)),e.multiplyScalar(t),f.add(e)}})(),P=(()=>{const e=new a.Pq0;return function(t,r){const i=n.domElement;if(i&&n.object instanceof a.ubm&&n.object.isPerspectiveCamera){const s=n.object.position;e.copy(s).sub(n.target);let a=e.length();a*=Math.tan(n.object.fov/2*Math.PI/180),R(2*t*a/i.clientHeight,n.object.matrix),D(2*r*a/i.clientHeight,n.object.matrix)}else i&&n.object instanceof a.qUd&&n.object.isOrthographicCamera?(R(t*(n.object.right-n.object.left)/n.object.zoom/i.clientWidth,n.object.matrix),D(r*(n.object.top-n.object.bottom)/n.object.zoom/i.clientHeight,n.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),n.enablePan=!1)}})();function L(e){n.object instanceof a.ubm&&n.object.isPerspectiveCamera||n.object instanceof a.qUd&&n.object.isOrthographicCamera?d=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function k(e){L(d/e)}function F(e){L(d*e)}function O(e){if(!n.zoomToCursor||!n.domElement)return;b=!0;const t=n.domElement.getBoundingClientRect(),r=e.clientX-t.left,i=e.clientY-t.top,s=t.width,a=t.height;I.x=r/s*2-1,I.y=-i/a*2+1,w.set(I.x,I.y,1).unproject(n.object).sub(n.object.position).normalize()}function U(e){return Math.max(n.minDistance,Math.min(n.maxDistance,e))}function Q(e){A.set(e.clientX,e.clientY)}function N(e){g.set(e.clientX,e.clientY)}function z(){if(1==S.length)A.set(S[0].pageX,S[0].pageY);else{const e=.5*(S[0].pageX+S[1].pageX),t=.5*(S[0].pageY+S[1].pageY);A.set(e,t)}}function G(){if(1==S.length)g.set(S[0].pageX,S[0].pageY);else{const e=.5*(S[0].pageX+S[1].pageX),t=.5*(S[0].pageY+S[1].pageY);g.set(e,t)}}function H(){const e=S[0].pageX-S[1].pageX,t=S[0].pageY-S[1].pageY,n=Math.sqrt(e*e+t*t);E.set(0,n)}function q(e){if(1==S.length)m.set(e.pageX,e.pageY);else{const t=ee(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);m.set(n,r)}p.subVectors(m,A).multiplyScalar(n.rotateSpeed);const t=n.domElement;t&&(_(2*Math.PI*p.x/t.clientHeight),M(2*Math.PI*p.y/t.clientHeight)),A.copy(m)}function Y(e){if(1==S.length)v.set(e.pageX,e.pageY);else{const t=ee(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);v.set(n,r)}y.subVectors(v,g).multiplyScalar(n.panSpeed),P(y.x,y.y),g.copy(v)}function j(e){const t=ee(e),r=e.pageX-t.x,i=e.pageY-t.y,s=Math.sqrt(r*r+i*i);x.set(0,s),C.set(0,Math.pow(x.y/E.y,n.zoomSpeed)),k(C.y),E.copy(x)}function V(e){var t,r;!1!==n.enabled&&(0===S.length&&(null==(t=n.domElement)||t.ownerDocument.addEventListener("pointermove",K),null==(r=n.domElement)||r.ownerDocument.addEventListener("pointerup",W)),function(e){S.push(e)}(e),"touch"===e.pointerType?function(e){switch(Z(e),S.length){case 1:switch(n.touches.ONE){case a.wtR.ROTATE:if(!1===n.enableRotate)return;z(),l=o.TOUCH_ROTATE;break;case a.wtR.PAN:if(!1===n.enablePan)return;G(),l=o.TOUCH_PAN;break;default:l=o.NONE}break;case 2:switch(n.touches.TWO){case a.wtR.DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;n.enableZoom&&H(),n.enablePan&&G(),l=o.TOUCH_DOLLY_PAN;break;case a.wtR.DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;n.enableZoom&&H(),n.enableRotate&&z(),l=o.TOUCH_DOLLY_ROTATE;break;default:l=o.NONE}break;default:l=o.NONE}l!==o.NONE&&n.dispatchEvent(i)}(e):function(e){let t;switch(e.button){case 0:t=n.mouseButtons.LEFT;break;case 1:t=n.mouseButtons.MIDDLE;break;case 2:t=n.mouseButtons.RIGHT;break;default:t=-1}switch(t){case a.kBv.DOLLY:if(!1===n.enableZoom)return;!function(e){O(e),E.set(e.clientX,e.clientY)}(e),l=o.DOLLY;break;case a.kBv.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enablePan)return;N(e),l=o.PAN}else{if(!1===n.enableRotate)return;Q(e),l=o.ROTATE}break;case a.kBv.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enableRotate)return;Q(e),l=o.ROTATE}else{if(!1===n.enablePan)return;N(e),l=o.PAN}break;default:l=o.NONE}l!==o.NONE&&n.dispatchEvent(i)}(e))}function K(e){!1!==n.enabled&&("touch"===e.pointerType?function(e){switch(Z(e),l){case o.TOUCH_ROTATE:if(!1===n.enableRotate)return;q(e),n.update();break;case o.TOUCH_PAN:if(!1===n.enablePan)return;Y(e),n.update();break;case o.TOUCH_DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;!function(e){n.enableZoom&&j(e),n.enablePan&&Y(e)}(e),n.update();break;case o.TOUCH_DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;!function(e){n.enableZoom&&j(e),n.enableRotate&&q(e)}(e),n.update();break;default:l=o.NONE}}(e):function(e){if(!1===n.enabled)return;switch(l){case o.ROTATE:if(!1===n.enableRotate)return;!function(e){m.set(e.clientX,e.clientY),p.subVectors(m,A).multiplyScalar(n.rotateSpeed);const t=n.domElement;t&&(_(2*Math.PI*p.x/t.clientHeight),M(2*Math.PI*p.y/t.clientHeight)),A.copy(m),n.update()}(e);break;case o.DOLLY:if(!1===n.enableZoom)return;!function(e){x.set(e.clientX,e.clientY),C.subVectors(x,E),C.y>0?k(T()):C.y<0&&F(T()),E.copy(x),n.update()}(e);break;case o.PAN:if(!1===n.enablePan)return;!function(e){v.set(e.clientX,e.clientY),y.subVectors(v,g).multiplyScalar(n.panSpeed),P(y.x,y.y),g.copy(v),n.update()}(e)}}(e))}function W(e){var t,r,i;!function(e){delete B[e.pointerId];for(let t=0;t<S.length;t++)if(S[t].pointerId==e.pointerId)return void S.splice(t,1)}(e),0===S.length&&(null==(t=n.domElement)||t.releasePointerCapture(e.pointerId),null==(r=n.domElement)||r.ownerDocument.removeEventListener("pointermove",K),null==(i=n.domElement)||i.ownerDocument.removeEventListener("pointerup",W)),n.dispatchEvent(s),l=o.NONE}function J(e){!1===n.enabled||!1===n.enableZoom||l!==o.NONE&&l!==o.ROTATE||(e.preventDefault(),n.dispatchEvent(i),function(e){O(e),e.deltaY<0?F(T()):e.deltaY>0&&k(T()),n.update()}(e),n.dispatchEvent(s))}function X(e){!1!==n.enabled&&!1!==n.enablePan&&function(e){let t=!1;switch(e.code){case n.keys.UP:P(0,n.keyPanSpeed),t=!0;break;case n.keys.BOTTOM:P(0,-n.keyPanSpeed),t=!0;break;case n.keys.LEFT:P(n.keyPanSpeed,0),t=!0;break;case n.keys.RIGHT:P(-n.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),n.update())}(e)}function $(e){!1!==n.enabled&&e.preventDefault()}function Z(e){let t=B[e.pointerId];void 0===t&&(t=new a.I9Y,B[e.pointerId]=t),t.set(e.pageX,e.pageY)}function ee(e){const t=e.pointerId===S[0].pointerId?S[1]:S[0];return B[t.pointerId]}this.dollyIn=(e=T())=>{F(e),n.update()},this.dollyOut=(e=T())=>{k(e),n.update()},this.getScale=()=>d,this.setScale=e=>{L(e),n.update()},this.getZoomScale=()=>T(),void 0!==t&&this.connect(t),this.update()}}class Hl extends Gl{constructor(e,t){super(e,t),this.screenSpacePanning=!1,this.mouseButtons.LEFT=a.kBv.PAN,this.mouseButtons.RIGHT=a.kBv.ROTATE,this.touches.ONE=a.wtR.PAN,this.touches.TWO=a.wtR.DOLLY_ROTATE}}const ql=i.forwardRef(((e={enableDamping:!0},t)=>{const{domElement:n,camera:s,makeDefault:a,onChange:l,onStart:c,onEnd:h,...u}=e,d=(0,o.A)((e=>e.invalidate)),f=(0,o.A)((e=>e.camera)),A=(0,o.A)((e=>e.gl)),m=(0,o.A)((e=>e.events)),p=(0,o.A)((e=>e.set)),g=(0,o.A)((e=>e.get)),v=n||m.connected||A.domElement,y=s||f,E=i.useMemo((()=>new Hl(y)),[y]);return i.useEffect((()=>{E.connect(v);const e=e=>{d(),l&&l(e)};return E.addEventListener("change",e),c&&E.addEventListener("start",c),h&&E.addEventListener("end",h),()=>{E.dispose(),E.removeEventListener("change",e),c&&E.removeEventListener("start",c),h&&E.removeEventListener("end",h)}}),[l,c,h,E,d,v]),i.useEffect((()=>{if(a){const e=g().controls;return p({controls:E}),()=>p({controls:e})}}),[a,E]),(0,o.C)((()=>E.update()),-1),i.createElement("primitive",(0,r.A)({ref:t,object:E,enableDamping:!0},u))})),Yl=i.forwardRef((({makeDefault:e,camera:t,regress:n,domElement:s,enableDamping:a=!0,keyEvents:l=!1,onChange:c,onStart:h,onEnd:u,...d},f)=>{const A=(0,o.A)((e=>e.invalidate)),m=(0,o.A)((e=>e.camera)),p=(0,o.A)((e=>e.gl)),g=(0,o.A)((e=>e.events)),v=(0,o.A)((e=>e.setEvents)),y=(0,o.A)((e=>e.set)),E=(0,o.A)((e=>e.get)),x=(0,o.A)((e=>e.performance)),C=t||m,w=s||g.connected||p.domElement,I=i.useMemo((()=>new Gl(C)),[C]);return(0,o.C)((()=>{I.enabled&&I.update()}),-1),i.useEffect((()=>(l&&I.connect(!0===l?w:l),I.connect(w),()=>{I.dispose()})),[l,w,n,I,A]),i.useEffect((()=>{const e=e=>{A(),n&&x.regress(),c&&c(e)},t=e=>{h&&h(e)},r=e=>{u&&u(e)};return I.addEventListener("change",e),I.addEventListener("start",t),I.addEventListener("end",r),()=>{I.removeEventListener("start",t),I.removeEventListener("end",r),I.removeEventListener("change",e)}}),[c,h,u,I,A,v]),i.useEffect((()=>{if(e){const e=E().controls;return y({controls:I}),()=>y({controls:e})}}),[e,I]),i.createElement("primitive",(0,r.A)({ref:f,object:I,enableDamping:a},d))}));var jl=Object.defineProperty,Vl=(e,t,n)=>(((e,t,n)=>{t in e?jl(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Kl extends Sl{constructor(e,t){super(),Vl(this,"enabled",!0),Vl(this,"screen",{left:0,top:0,width:0,height:0}),Vl(this,"rotateSpeed",1),Vl(this,"zoomSpeed",1.2),Vl(this,"panSpeed",.3),Vl(this,"noRotate",!1),Vl(this,"noZoom",!1),Vl(this,"noPan",!1),Vl(this,"staticMoving",!1),Vl(this,"dynamicDampingFactor",.2),Vl(this,"minDistance",0),Vl(this,"maxDistance",1/0),Vl(this,"keys",["KeyA","KeyS","KeyD"]),Vl(this,"mouseButtons",{LEFT:a.kBv.ROTATE,MIDDLE:a.kBv.DOLLY,RIGHT:a.kBv.PAN}),Vl(this,"object"),Vl(this,"domElement"),Vl(this,"cursorZoom",!1),Vl(this,"target",new a.Pq0),Vl(this,"mousePosition",new a.I9Y),Vl(this,"STATE",{NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4}),Vl(this,"EPS",1e-6),Vl(this,"lastZoom",1),Vl(this,"lastPosition",new a.Pq0),Vl(this,"cursorVector",new a.Pq0),Vl(this,"targetVector",new a.Pq0),Vl(this,"_state",this.STATE.NONE),Vl(this,"_keyState",this.STATE.NONE),Vl(this,"_eye",new a.Pq0),Vl(this,"_movePrev",new a.I9Y),Vl(this,"_moveCurr",new a.I9Y),Vl(this,"_lastAxis",new a.Pq0),Vl(this,"_lastAngle",0),Vl(this,"_zoomStart",new a.I9Y),Vl(this,"_zoomEnd",new a.I9Y),Vl(this,"_touchZoomDistanceStart",0),Vl(this,"_touchZoomDistanceEnd",0),Vl(this,"_panStart",new a.I9Y),Vl(this,"_panEnd",new a.I9Y),Vl(this,"target0"),Vl(this,"position0"),Vl(this,"up0"),Vl(this,"zoom0"),Vl(this,"changeEvent",{type:"change"}),Vl(this,"startEvent",{type:"start"}),Vl(this,"endEvent",{type:"end"}),Vl(this,"onScreenVector",new a.I9Y),Vl(this,"getMouseOnScreen",((e,t)=>(this.onScreenVector.set((e-this.screen.left)/this.screen.width,(t-this.screen.top)/this.screen.height),this.onScreenVector))),Vl(this,"onCircleVector",new a.I9Y),Vl(this,"getMouseOnCircle",((e,t)=>(this.onCircleVector.set((e-.5*this.screen.width-this.screen.left)/(.5*this.screen.width),(this.screen.height+2*(this.screen.top-t))/this.screen.width),this.onCircleVector))),Vl(this,"axis",new a.Pq0),Vl(this,"quaternion",new a.PTz),Vl(this,"eyeDirection",new a.Pq0),Vl(this,"objectUpDirection",new a.Pq0),Vl(this,"objectSidewaysDirection",new a.Pq0),Vl(this,"moveDirection",new a.Pq0),Vl(this,"angle",0),Vl(this,"rotateCamera",(()=>{this.moveDirection.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0),this.angle=this.moveDirection.length(),this.angle?(this._eye.copy(this.object.position).sub(this.target),this.eyeDirection.copy(this._eye).normalize(),this.objectUpDirection.copy(this.object.up).normalize(),this.objectSidewaysDirection.crossVectors(this.objectUpDirection,this.eyeDirection).normalize(),this.objectUpDirection.setLength(this._moveCurr.y-this._movePrev.y),this.objectSidewaysDirection.setLength(this._moveCurr.x-this._movePrev.x),this.moveDirection.copy(this.objectUpDirection.add(this.objectSidewaysDirection)),this.axis.crossVectors(this.moveDirection,this._eye).normalize(),this.angle*=this.rotateSpeed,this.quaternion.setFromAxisAngle(this.axis,this.angle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion),this._lastAxis.copy(this.axis),this._lastAngle=this.angle):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),this.quaternion.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion)),this._movePrev.copy(this._moveCurr)})),Vl(this,"zoomCamera",(()=>{let e;if(this._state===this.STATE.TOUCH_ZOOM_PAN)e=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(e):this.object.isOrthographicCamera?(this.object.zoom/=e,this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type");else{if(e=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,Math.abs(e-1)>this.EPS&&e>0&&(this.object.isPerspectiveCamera?(e>1&&this._eye.length()>=this.maxDistance-this.EPS&&(e=1),this._eye.multiplyScalar(e)):this.object.isOrthographicCamera?(e>1&&this.object.zoom<this.maxDistance*this.maxDistance&&(e=1),this.object.zoom/=e):console.warn("THREE.TrackballControls: Unsupported camera type")),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor,this.cursorZoom){this.targetVector.copy(this.target).project(this.object);let t=this.cursorVector.set(this.mousePosition.x,this.mousePosition.y,this.targetVector.z).unproject(this.object);this.target.lerpVectors(t,this.target,e)}this.object.isOrthographicCamera&&this.object.updateProjectionMatrix()}})),Vl(this,"mouseChange",new a.I9Y),Vl(this,"objectUp",new a.Pq0),Vl(this,"pan",new a.Pq0),Vl(this,"panCamera",(()=>{if(this.domElement&&(this.mouseChange.copy(this._panEnd).sub(this._panStart),this.mouseChange.lengthSq()>this.EPS)){if(this.object.isOrthographicCamera){const e=this.object,t=(e.right-e.left)/this.object.zoom,n=(e.top-e.bottom)/this.object.zoom;this.mouseChange.x*=t,this.mouseChange.y*=n}else this.mouseChange.multiplyScalar(this._eye.length()*this.panSpeed);this.pan.copy(this._eye).cross(this.object.up).setLength(this.mouseChange.x),this.pan.add(this.objectUp.copy(this.object.up).setLength(this.mouseChange.y)),this.object.position.add(this.pan),this.target.add(this.pan),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(this.mouseChange.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}})),Vl(this,"checkDistances",(()=>{this.noZoom&&this.noPan||(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))})),Vl(this,"handleResize",(()=>{if(!this.domElement)return;const e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height})),Vl(this,"update",(()=>{this._eye.subVectors(this.object.position,this.target),this.noRotate||this.rotateCamera(),this.noZoom||this.zoomCamera(),this.noPan||this.panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this.checkDistances(),this.object.lookAt(this.target),this.lastPosition.distanceToSquared(this.object.position)>this.EPS&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position))):this.object.isOrthographicCamera?(this.object.lookAt(this.target),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||this.lastZoom!==this.object.zoom)&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")})),Vl(this,"reset",(()=>{this._state=this.STATE.NONE,this._keyState=this.STATE.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.up.copy(this.up0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom})),Vl(this,"keydown",(e=>{!1!==this.enabled&&(window.removeEventListener("keydown",this.keydown),this._keyState===this.STATE.NONE&&(e.code!==this.keys[this.STATE.ROTATE]||this.noRotate?e.code!==this.keys[this.STATE.ZOOM]||this.noZoom?e.code!==this.keys[this.STATE.PAN]||this.noPan||(this._keyState=this.STATE.PAN):this._keyState=this.STATE.ZOOM:this._keyState=this.STATE.ROTATE))})),Vl(this,"onPointerDown",(e=>{if(!1!==this.enabled)switch(e.pointerType){case"mouse":case"pen":this.onMouseDown(e)}})),Vl(this,"onPointerMove",(e=>{if(!1!==this.enabled)switch(e.pointerType){case"mouse":case"pen":this.onMouseMove(e)}})),Vl(this,"onPointerUp",(e=>{if(!1!==this.enabled)switch(e.pointerType){case"mouse":case"pen":this.onMouseUp()}})),Vl(this,"keyup",(()=>{!1!==this.enabled&&(this._keyState=this.STATE.NONE,window.addEventListener("keydown",this.keydown))})),Vl(this,"onMouseDown",(e=>{if(!this.domElement)return;if(this._state===this.STATE.NONE)switch(e.button){case this.mouseButtons.LEFT:this._state=this.STATE.ROTATE;break;case this.mouseButtons.MIDDLE:this._state=this.STATE.ZOOM;break;case this.mouseButtons.RIGHT:this._state=this.STATE.PAN}const t=this._keyState!==this.STATE.NONE?this._keyState:this._state;t!==this.STATE.ROTATE||this.noRotate?t!==this.STATE.ZOOM||this.noZoom?t!==this.STATE.PAN||this.noPan||(this._panStart.copy(this.getMouseOnScreen(e.pageX,e.pageY)),this._panEnd.copy(this._panStart)):(this._zoomStart.copy(this.getMouseOnScreen(e.pageX,e.pageY)),this._zoomEnd.copy(this._zoomStart)):(this._moveCurr.copy(this.getMouseOnCircle(e.pageX,e.pageY)),this._movePrev.copy(this._moveCurr)),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.startEvent)})),Vl(this,"onMouseMove",(e=>{if(!1===this.enabled)return;const t=this._keyState!==this.STATE.NONE?this._keyState:this._state;t!==this.STATE.ROTATE||this.noRotate?t!==this.STATE.ZOOM||this.noZoom?t!==this.STATE.PAN||this.noPan||this._panEnd.copy(this.getMouseOnScreen(e.pageX,e.pageY)):this._zoomEnd.copy(this.getMouseOnScreen(e.pageX,e.pageY)):(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(e.pageX,e.pageY)))})),Vl(this,"onMouseUp",(()=>{this.domElement&&!1!==this.enabled&&(this._state=this.STATE.NONE,this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.endEvent))})),Vl(this,"mousewheel",(e=>{if(!1!==this.enabled&&!0!==this.noZoom){switch(e.preventDefault(),e.deltaMode){case 2:this._zoomStart.y-=.025*e.deltaY;break;case 1:this._zoomStart.y-=.01*e.deltaY;break;default:this._zoomStart.y-=25e-5*e.deltaY}this.mousePosition.x=e.offsetX/this.screen.width*2-1,this.mousePosition.y=-e.offsetY/this.screen.height*2+1,this.dispatchEvent(this.startEvent),this.dispatchEvent(this.endEvent)}})),Vl(this,"touchstart",(e=>{if(!1!==this.enabled){if(e.preventDefault(),1===e.touches.length)this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(e.touches[0].pageX,e.touches[0].pageY)),this._movePrev.copy(this._moveCurr);else{this._state=this.STATE.TOUCH_ZOOM_PAN;const t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(t*t+n*n);const r=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;this._panStart.copy(this.getMouseOnScreen(r,i)),this._panEnd.copy(this._panStart)}this.dispatchEvent(this.startEvent)}})),Vl(this,"touchmove",(e=>{if(!1!==this.enabled)if(e.preventDefault(),1===e.touches.length)this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(e.touches[0].pageX,e.touches[0].pageY));else{const t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;this._touchZoomDistanceEnd=Math.sqrt(t*t+n*n);const r=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;this._panEnd.copy(this.getMouseOnScreen(r,i))}})),Vl(this,"touchend",(e=>{if(!1!==this.enabled){switch(e.touches.length){case 0:this._state=this.STATE.NONE;break;case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(e.touches[0].pageX,e.touches[0].pageY)),this._movePrev.copy(this._moveCurr)}this.dispatchEvent(this.endEvent)}})),Vl(this,"contextmenu",(e=>{!1!==this.enabled&&e.preventDefault()})),Vl(this,"connect",(e=>{e===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=e,this.domElement.addEventListener("contextmenu",this.contextmenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("wheel",this.mousewheel),this.domElement.addEventListener("touchstart",this.touchstart),this.domElement.addEventListener("touchend",this.touchend),this.domElement.addEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup),this.handleResize()})),Vl(this,"dispose",(()=>{this.domElement&&(this.domElement.removeEventListener("contextmenu",this.contextmenu),this.domElement.removeEventListener("pointerdown",this.onPointerDown),this.domElement.removeEventListener("wheel",this.mousewheel),this.domElement.removeEventListener("touchstart",this.touchstart),this.domElement.removeEventListener("touchend",this.touchend),this.domElement.removeEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup))})),this.object=e,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom,void 0!==t&&this.connect(t),this.update()}}const Wl=i.forwardRef((({makeDefault:e,camera:t,domElement:n,regress:s,onChange:a,onStart:l,onEnd:c,...h},u)=>{const{invalidate:d,camera:f,gl:A,events:m,set:p,get:g,performance:v,viewport:y}=(0,o.A)(),E=t||f,x=n||m.connected||A.domElement,C=i.useMemo((()=>new Kl(E)),[E]);return(0,o.C)((()=>{C.enabled&&C.update()}),-1),i.useEffect((()=>(C.connect(x),()=>{C.dispose()})),[x,s,C,d]),i.useEffect((()=>{const e=e=>{d(),s&&v.regress(),a&&a(e)};return C.addEventListener("change",e),l&&C.addEventListener("start",l),c&&C.addEventListener("end",c),()=>{l&&C.removeEventListener("start",l),c&&C.removeEventListener("end",c),C.removeEventListener("change",e)}}),[a,l,c,C,d]),i.useEffect((()=>{C.handleResize()}),[y]),i.useEffect((()=>{if(e){const e=g().controls;return p({controls:C}),()=>p({controls:e})}}),[e,C]),i.createElement("primitive",(0,r.A)({ref:u,object:C},h))}));var Jl=Object.defineProperty,Xl=(e,t,n)=>(((e,t,n)=>{t in e?Jl(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const $l={IDLE:Symbol(),ROTATE:Symbol(),PAN:Symbol(),SCALE:Symbol(),FOV:Symbol(),FOCUS:Symbol(),ZROTATE:Symbol(),TOUCH_MULTI:Symbol(),ANIMATION_FOCUS:Symbol(),ANIMATION_ROTATE:Symbol()},Zl={NONE:Symbol(),ONE_FINGER:Symbol(),ONE_FINGER_SWITCHED:Symbol(),TWO_FINGER:Symbol(),MULT_FINGER:Symbol(),CURSOR:Symbol()},ec={x:0,y:0},tc={camera:new a.kn4,gizmos:new a.kn4},nc={type:"change"},rc={type:"start"},ic={type:"end"};class sc extends Sl{constructor(e,t=null,n=null){super(),Xl(this,"camera"),Xl(this,"domElement"),Xl(this,"scene"),Xl(this,"mouseActions"),Xl(this,"_mouseOp"),Xl(this,"_v2_1"),Xl(this,"_v3_1"),Xl(this,"_v3_2"),Xl(this,"_m4_1"),Xl(this,"_m4_2"),Xl(this,"_quat"),Xl(this,"_translationMatrix"),Xl(this,"_rotationMatrix"),Xl(this,"_scaleMatrix"),Xl(this,"_rotationAxis"),Xl(this,"_cameraMatrixState"),Xl(this,"_cameraProjectionState"),Xl(this,"_fovState"),Xl(this,"_upState"),Xl(this,"_zoomState"),Xl(this,"_nearPos"),Xl(this,"_farPos"),Xl(this,"_gizmoMatrixState"),Xl(this,"_up0"),Xl(this,"_zoom0"),Xl(this,"_fov0"),Xl(this,"_initialNear"),Xl(this,"_nearPos0"),Xl(this,"_initialFar"),Xl(this,"_farPos0"),Xl(this,"_cameraMatrixState0"),Xl(this,"_gizmoMatrixState0"),Xl(this,"_button"),Xl(this,"_touchStart"),Xl(this,"_touchCurrent"),Xl(this,"_input"),Xl(this,"_switchSensibility"),Xl(this,"_startFingerDistance"),Xl(this,"_currentFingerDistance"),Xl(this,"_startFingerRotation"),Xl(this,"_currentFingerRotation"),Xl(this,"_devPxRatio"),Xl(this,"_downValid"),Xl(this,"_nclicks"),Xl(this,"_downEvents"),Xl(this,"_clickStart"),Xl(this,"_maxDownTime"),Xl(this,"_maxInterval"),Xl(this,"_posThreshold"),Xl(this,"_movementThreshold"),Xl(this,"_currentCursorPosition"),Xl(this,"_startCursorPosition"),Xl(this,"_grid"),Xl(this,"_gridPosition"),Xl(this,"_gizmos"),Xl(this,"_curvePts"),Xl(this,"_timeStart"),Xl(this,"_animationId"),Xl(this,"focusAnimationTime"),Xl(this,"_timePrev"),Xl(this,"_timeCurrent"),Xl(this,"_anglePrev"),Xl(this,"_angleCurrent"),Xl(this,"_cursorPosPrev"),Xl(this,"_cursorPosCurr"),Xl(this,"_wPrev"),Xl(this,"_wCurr"),Xl(this,"adjustNearFar"),Xl(this,"scaleFactor"),Xl(this,"dampingFactor"),Xl(this,"wMax"),Xl(this,"enableAnimations"),Xl(this,"enableGrid"),Xl(this,"cursorZoom"),Xl(this,"minFov"),Xl(this,"maxFov"),Xl(this,"enabled"),Xl(this,"enablePan"),Xl(this,"enableRotate"),Xl(this,"enableZoom"),Xl(this,"minDistance"),Xl(this,"maxDistance"),Xl(this,"minZoom"),Xl(this,"maxZoom"),Xl(this,"target"),Xl(this,"_currentTarget"),Xl(this,"_tbRadius"),Xl(this,"_state"),Xl(this,"onWindowResize",(()=>{const e=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3;if(this.camera){const e=this.calculateTbRadius(this.camera);void 0!==e&&(this._tbRadius=e)}const t=this._tbRadius/e,n=new a.S20(0,0,t,t).getPoints(this._curvePts),r=(new a.LoY).setFromPoints(n);for(const i in this._gizmos.children){this._gizmos.children[i].geometry=r}this.dispatchEvent(nc)})),Xl(this,"onContextMenu",(e=>{if(this.enabled)for(let t=0;t<this.mouseActions.length;t++)if(2==this.mouseActions[t].mouse){e.preventDefault();break}})),Xl(this,"onPointerCancel",(()=>{this._touchStart.splice(0,this._touchStart.length),this._touchCurrent.splice(0,this._touchCurrent.length),this._input=Zl.NONE})),Xl(this,"onPointerDown",(e=>{if(0==e.button&&e.isPrimary?(this._downValid=!0,this._downEvents.push(e)):this._downValid=!1,"touch"==e.pointerType&&this._input!=Zl.CURSOR)switch(this._touchStart.push(e),this._touchCurrent.push(e),this._input){case Zl.NONE:this._input=Zl.ONE_FINGER,this.onSinglePanStart(e,"ROTATE"),window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp);break;case Zl.ONE_FINGER:case Zl.ONE_FINGER_SWITCHED:this._input=Zl.TWO_FINGER,this.onRotateStart(),this.onPinchStart(),this.onDoublePanStart();break;case Zl.TWO_FINGER:this._input=Zl.MULT_FINGER,this.onTriplePanStart()}else if("touch"!=e.pointerType&&this._input==Zl.NONE){let t=null;e.ctrlKey||e.metaKey?t="CTRL":e.shiftKey&&(t="SHIFT"),this._mouseOp=this.getOpFromAction(e.button,t),this._mouseOp&&(window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp),this._input=Zl.CURSOR,this._button=e.button,this.onSinglePanStart(e,this._mouseOp))}})),Xl(this,"onPointerMove",(e=>{if("touch"==e.pointerType&&this._input!=Zl.CURSOR)switch(this._input){case Zl.ONE_FINGER:this.updateTouchEvent(e),this.onSinglePanMove(e,$l.ROTATE);break;case Zl.ONE_FINGER_SWITCHED:if(this.calculatePointersDistance(this._touchCurrent[0],e)*this._devPxRatio>=this._switchSensibility){this._input=Zl.ONE_FINGER,this.updateTouchEvent(e),this.onSinglePanStart(e,"ROTATE");break}break;case Zl.TWO_FINGER:this.updateTouchEvent(e),this.onRotateMove(),this.onPinchMove(),this.onDoublePanMove();break;case Zl.MULT_FINGER:this.updateTouchEvent(e),this.onTriplePanMove()}else if("touch"!=e.pointerType&&this._input==Zl.CURSOR){let t=null;e.ctrlKey||e.metaKey?t="CTRL":e.shiftKey&&(t="SHIFT");const n=this.getOpStateFromAction(this._button,t);n&&this.onSinglePanMove(e,n)}if(this._downValid){this.calculatePointersDistance(this._downEvents[this._downEvents.length-1],e)*this._devPxRatio>this._movementThreshold&&(this._downValid=!1)}})),Xl(this,"onPointerUp",(e=>{if("touch"==e.pointerType&&this._input!=Zl.CURSOR){const t=this._touchCurrent.length;for(let n=0;n<t;n++)if(this._touchCurrent[n].pointerId==e.pointerId){this._touchCurrent.splice(n,1),this._touchStart.splice(n,1);break}switch(this._input){case Zl.ONE_FINGER:case Zl.ONE_FINGER_SWITCHED:window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Zl.NONE,this.onSinglePanEnd();break;case Zl.TWO_FINGER:this.onDoublePanEnd(),this.onPinchEnd(),this.onRotateEnd(),this._input=Zl.ONE_FINGER_SWITCHED;break;case Zl.MULT_FINGER:0==this._touchCurrent.length&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Zl.NONE,this.onTriplePanEnd())}}else"touch"!=e.pointerType&&this._input==Zl.CURSOR&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Zl.NONE,this.onSinglePanEnd(),this._button=-1);if(e.isPrimary)if(this._downValid){if(e.timeStamp-this._downEvents[this._downEvents.length-1].timeStamp<=this._maxDownTime)if(0==this._nclicks)this._nclicks=1,this._clickStart=performance.now();else{const t=e.timeStamp-this._clickStart,n=this.calculatePointersDistance(this._downEvents[1],this._downEvents[0])*this._devPxRatio;t<=this._maxInterval&&n<=this._posThreshold?(this._nclicks=0,this._downEvents.splice(0,this._downEvents.length),this.onDoubleTap(e)):(this._nclicks=1,this._downEvents.shift(),this._clickStart=performance.now())}else this._downValid=!1,this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)}else this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)})),Xl(this,"onWheel",(e=>{var t,n;if(this.enabled&&this.enableZoom&&this.domElement){let r=null;e.ctrlKey||e.metaKey?r="CTRL":e.shiftKey&&(r="SHIFT");const i=this.getOpFromAction("WHEEL",r);if(i){e.preventDefault(),this.dispatchEvent(rc);const r=125;let s=e.deltaY/r,o=1;switch(s>0?o=1/this.scaleFactor:s<0&&(o=this.scaleFactor),i){case"ZOOM":if(this.updateTbState($l.SCALE,!0),s>0?o=1/Math.pow(this.scaleFactor,s):s<0&&(o=Math.pow(this.scaleFactor,-s)),this.cursorZoom&&this.enablePan){let r;this.camera instanceof a.qUd&&(r=null==(t=this.unprojectOnTbPlane(this.camera,e.clientX,e.clientY,this.domElement))?void 0:t.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position)),this.camera instanceof a.ubm&&(r=null==(n=this.unprojectOnTbPlane(this.camera,e.clientX,e.clientY,this.domElement))?void 0:n.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)),void 0!==r&&this.applyTransformMatrix(this.applyScale(o,r))}else this.applyTransformMatrix(this.applyScale(o,this._gizmos.position));this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState($l.IDLE,!1),this.dispatchEvent(nc),this.dispatchEvent(ic);break;case"FOV":if(this.camera instanceof a.ubm){this.updateTbState($l.FOV,!0),0!=e.deltaX&&(s=e.deltaX/r,o=1,s>0?o=1/Math.pow(this.scaleFactor,s):s<0&&(o=Math.pow(this.scaleFactor,-s))),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const t=this._v3_1.distanceTo(this._gizmos.position);let n=t/o;n=a.cj9.clamp(n,this.minDistance,this.maxDistance);const i=t*Math.tan(a.cj9.DEG2RAD*this.camera.fov*.5);let l=a.cj9.RAD2DEG*(2*Math.atan(i/n));l>this.maxFov?l=this.maxFov:l<this.minFov&&(l=this.minFov);o=t/(i/Math.tan(a.cj9.DEG2RAD*(l/2))),this.setFov(l),this.applyTransformMatrix(this.applyScale(o,this._gizmos.position,!1))}this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState($l.IDLE,!1),this.dispatchEvent(nc),this.dispatchEvent(ic)}}}})),Xl(this,"onSinglePanStart",((e,t)=>{if(this.enabled&&this.domElement)switch(this.dispatchEvent(rc),this.setCenter(e.clientX,e.clientY),t){case"PAN":if(!this.enablePan)return;if(-1!=this._animationId&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(nc)),this.camera){this.updateTbState($l.PAN,!0);const e=this.unprojectOnTbPlane(this.camera,ec.x,ec.y,this.domElement);void 0!==e&&this._startCursorPosition.copy(e),this.enableGrid&&(this.drawGrid(),this.dispatchEvent(nc))}break;case"ROTATE":if(!this.enableRotate)return;if(-1!=this._animationId&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1),this.camera){this.updateTbState($l.ROTATE,!0);const e=this.unprojectOnTbSurface(this.camera,ec.x,ec.y,this.domElement,this._tbRadius);void 0!==e&&this._startCursorPosition.copy(e),this.activateGizmos(!0),this.enableAnimations&&(this._timePrev=this._timeCurrent=performance.now(),this._angleCurrent=this._anglePrev=0,this._cursorPosPrev.copy(this._startCursorPosition),this._cursorPosCurr.copy(this._cursorPosPrev),this._wCurr=0,this._wPrev=this._wCurr)}this.dispatchEvent(nc);break;case"FOV":if(!this.enableZoom)return;this.camera instanceof a.ubm&&(-1!=this._animationId&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(nc)),this.updateTbState($l.FOV,!0),this._startCursorPosition.setY(.5*this.getCursorNDC(ec.x,ec.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition));break;case"ZOOM":if(!this.enableZoom)return;-1!=this._animationId&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(nc)),this.updateTbState($l.SCALE,!0),this._startCursorPosition.setY(.5*this.getCursorNDC(ec.x,ec.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition)}})),Xl(this,"onSinglePanMove",((e,t)=>{if(this.enabled&&this.domElement){const n=t!=this._state;switch(this.setCenter(e.clientX,e.clientY),t){case $l.PAN:if(this.enablePan&&this.camera)if(n){this.dispatchEvent(ic),this.dispatchEvent(rc),this.updateTbState(t,!0);const e=this.unprojectOnTbPlane(this.camera,ec.x,ec.y,this.domElement);void 0!==e&&this._startCursorPosition.copy(e),this.enableGrid&&this.drawGrid(),this.activateGizmos(!1)}else{const e=this.unprojectOnTbPlane(this.camera,ec.x,ec.y,this.domElement);void 0!==e&&this._currentCursorPosition.copy(e),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition))}break;case $l.ROTATE:if(this.enableRotate&&this.camera)if(n){this.dispatchEvent(ic),this.dispatchEvent(rc),this.updateTbState(t,!0);const e=this.unprojectOnTbSurface(this.camera,ec.x,ec.y,this.domElement,this._tbRadius);void 0!==e&&this._startCursorPosition.copy(e),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!0)}else{const e=this.unprojectOnTbSurface(this.camera,ec.x,ec.y,this.domElement,this._tbRadius);void 0!==e&&this._currentCursorPosition.copy(e);const t=this._startCursorPosition.distanceTo(this._currentCursorPosition),n=this._startCursorPosition.angleTo(this._currentCursorPosition),r=Math.max(t/this._tbRadius,n);this.applyTransformMatrix(this.rotate(this.calculateRotationAxis(this._startCursorPosition,this._currentCursorPosition),r)),this.enableAnimations&&(this._timePrev=this._timeCurrent,this._timeCurrent=performance.now(),this._anglePrev=this._angleCurrent,this._angleCurrent=r,this._cursorPosPrev.copy(this._cursorPosCurr),this._cursorPosCurr.copy(this._currentCursorPosition),this._wPrev=this._wCurr,this._wCurr=this.calculateAngularSpeed(this._anglePrev,this._angleCurrent,this._timePrev,this._timeCurrent))}break;case $l.SCALE:if(this.enableZoom)if(n)this.dispatchEvent(ic),this.dispatchEvent(rc),this.updateTbState(t,!0),this._startCursorPosition.setY(.5*this.getCursorNDC(ec.x,ec.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{const e=8;this._currentCursorPosition.setY(.5*this.getCursorNDC(ec.x,ec.y,this.domElement).y);const t=this._currentCursorPosition.y-this._startCursorPosition.y;let n=1;t<0?n=1/Math.pow(this.scaleFactor,-t*e):t>0&&(n=Math.pow(this.scaleFactor,t*e)),this.applyTransformMatrix(this.applyScale(n,this._gizmos.position))}break;case $l.FOV:if(this.enableZoom&&this.camera instanceof a.ubm)if(n)this.dispatchEvent(ic),this.dispatchEvent(rc),this.updateTbState(t,!0),this._startCursorPosition.setY(.5*this.getCursorNDC(ec.x,ec.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{const e=8;this._currentCursorPosition.setY(.5*this.getCursorNDC(ec.x,ec.y,this.domElement).y);const t=this._currentCursorPosition.y-this._startCursorPosition.y;let n=1;t<0?n=1/Math.pow(this.scaleFactor,-t*e):t>0&&(n=Math.pow(this.scaleFactor,t*e)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const r=this._v3_1.distanceTo(this._gizmos.position);let i=r/n;i=a.cj9.clamp(i,this.minDistance,this.maxDistance);const s=r*Math.tan(a.cj9.DEG2RAD*this._fovState*.5);let o=a.cj9.RAD2DEG*(2*Math.atan(s/i));o=a.cj9.clamp(o,this.minFov,this.maxFov);const l=s/Math.tan(a.cj9.DEG2RAD*(o/2));n=r/l,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(o),this.applyTransformMatrix(this.applyScale(n,this._v3_2,!1));const c=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(l/r);this._m4_1.makeTranslation(c.x,c.y,c.z)}}this.dispatchEvent(nc)}})),Xl(this,"onSinglePanEnd",(()=>{if(this._state==$l.ROTATE){if(!this.enableRotate)return;if(this.enableAnimations){if(performance.now()-this._timeCurrent<120){const e=Math.abs((this._wPrev+this._wCurr)/2),t=this;this._animationId=window.requestAnimationFrame((function(n){t.updateTbState($l.ANIMATION_ROTATE,!0);const r=t.calculateRotationAxis(t._cursorPosPrev,t._cursorPosCurr);t.onRotationAnim(n,r,Math.min(e,t.wMax))}))}else this.updateTbState($l.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(nc)}else this.updateTbState($l.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(nc)}else this._state!=$l.PAN&&this._state!=$l.IDLE||(this.updateTbState($l.IDLE,!1),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1),this.dispatchEvent(nc));this.dispatchEvent(ic)})),Xl(this,"onDoubleTap",(e=>{if(this.enabled&&this.enablePan&&this.scene&&this.camera&&this.domElement){this.dispatchEvent(rc),this.setCenter(e.clientX,e.clientY);const t=this.unprojectOnObj(this.getCursorNDC(ec.x,ec.y,this.domElement),this.camera);if(t&&this.enableAnimations){const e=this;-1!=this._animationId&&window.cancelAnimationFrame(this._animationId),this._timeStart=-1,this._animationId=window.requestAnimationFrame((function(n){e.updateTbState($l.ANIMATION_FOCUS,!0),e.onFocusAnim(n,t,e._cameraMatrixState,e._gizmoMatrixState)}))}else t&&!this.enableAnimations&&(this.updateTbState($l.FOCUS,!0),this.focus(t,this.scaleFactor),this.updateTbState($l.IDLE,!1),this.dispatchEvent(nc))}this.dispatchEvent(ic)})),Xl(this,"onDoublePanStart",(()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.dispatchEvent(rc),this.updateTbState($l.PAN,!0),this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const e=this.unprojectOnTbPlane(this.camera,ec.x,ec.y,this.domElement,!0);void 0!==e&&this._startCursorPosition.copy(e),this._currentCursorPosition.copy(this._startCursorPosition),this.activateGizmos(!1)}})),Xl(this,"onDoublePanMove",(()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._state!=$l.PAN&&(this.updateTbState($l.PAN,!0),this._startCursorPosition.copy(this._currentCursorPosition));const e=this.unprojectOnTbPlane(this.camera,ec.x,ec.y,this.domElement,!0);void 0!==e&&this._currentCursorPosition.copy(e),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition,!0)),this.dispatchEvent(nc)}})),Xl(this,"onDoublePanEnd",(()=>{this.updateTbState($l.IDLE,!1),this.dispatchEvent(ic)})),Xl(this,"onRotateStart",(()=>{var e;this.enabled&&this.enableRotate&&(this.dispatchEvent(rc),this.updateTbState($l.ZROTATE,!0),this._startFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this._currentFingerRotation=this._startFingerRotation,null==(e=this.camera)||e.getWorldDirection(this._rotationAxis),this.enablePan||this.enableZoom||this.activateGizmos(!0))})),Xl(this,"onRotateMove",(()=>{var e;if(this.enabled&&this.enableRotate&&this.camera&&this.domElement){let t;this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._state!=$l.ZROTATE&&(this.updateTbState($l.ZROTATE,!0),this._startFingerRotation=this._currentFingerRotation),this._currentFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this.enablePan?this.camera&&(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),t=null==(e=this.unprojectOnTbPlane(this.camera,ec.x,ec.y,this.domElement))?void 0:e.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._v3_2)):t=(new a.Pq0).setFromMatrixPosition(this._gizmoMatrixState);const n=a.cj9.DEG2RAD*(this._startFingerRotation-this._currentFingerRotation);void 0!==t&&this.applyTransformMatrix(this.zRotate(t,n)),this.dispatchEvent(nc)}})),Xl(this,"onRotateEnd",(()=>{this.updateTbState($l.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(ic)})),Xl(this,"onPinchStart",(()=>{this.enabled&&this.enableZoom&&(this.dispatchEvent(rc),this.updateTbState($l.SCALE,!0),this._startFingerDistance=this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),this._currentFingerDistance=this._startFingerDistance,this.activateGizmos(!1))})),Xl(this,"onPinchMove",(()=>{var e,t;if(this.enabled&&this.enableZoom&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const n=12;this._state!=$l.SCALE&&(this._startFingerDistance=this._currentFingerDistance,this.updateTbState($l.SCALE,!0)),this._currentFingerDistance=Math.max(this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),n*this._devPxRatio);const r=this._currentFingerDistance/this._startFingerDistance;let i;this.enablePan?this.camera instanceof a.qUd?i=null==(e=this.unprojectOnTbPlane(this.camera,ec.x,ec.y,this.domElement))?void 0:e.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera instanceof a.ubm&&(i=null==(t=this.unprojectOnTbPlane(this.camera,ec.x,ec.y,this.domElement))?void 0:t.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)):i=this._gizmos.position,void 0!==i&&this.applyTransformMatrix(this.applyScale(r,i)),this.dispatchEvent(nc)}})),Xl(this,"onPinchEnd",(()=>{this.updateTbState($l.IDLE,!1),this.dispatchEvent(ic)})),Xl(this,"onTriplePanStart",(()=>{if(this.enabled&&this.enableZoom&&this.domElement){this.dispatchEvent(rc),this.updateTbState($l.SCALE,!0);let e=0,t=0;const n=this._touchCurrent.length;for(let r=0;r<n;r++)e+=this._touchCurrent[r].clientX,t+=this._touchCurrent[r].clientY;this.setCenter(e/n,t/n),this._startCursorPosition.setY(.5*this.getCursorNDC(ec.x,ec.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition)}})),Xl(this,"onTriplePanMove",(()=>{if(this.enabled&&this.enableZoom&&this.camera&&this.domElement){let e=0,t=0;const n=this._touchCurrent.length;for(let a=0;a<n;a++)e+=this._touchCurrent[a].clientX,t+=this._touchCurrent[a].clientY;this.setCenter(e/n,t/n);const r=8;this._currentCursorPosition.setY(.5*this.getCursorNDC(ec.x,ec.y,this.domElement).y);const i=this._currentCursorPosition.y-this._startCursorPosition.y;let s=1;i<0?s=1/Math.pow(this.scaleFactor,-i*r):i>0&&(s=Math.pow(this.scaleFactor,i*r)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const o=this._v3_1.distanceTo(this._gizmos.position);let l=o/s;l=a.cj9.clamp(l,this.minDistance,this.maxDistance);const c=o*Math.tan(a.cj9.DEG2RAD*this._fovState*.5);let h=a.cj9.RAD2DEG*(2*Math.atan(c/l));h=a.cj9.clamp(h,this.minFov,this.maxFov);const u=c/Math.tan(a.cj9.DEG2RAD*(h/2));s=o/u,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(h),this.applyTransformMatrix(this.applyScale(s,this._v3_2,!1));const d=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(u/o);this._m4_1.makeTranslation(d.x,d.y,d.z),this.dispatchEvent(nc)}})),Xl(this,"onTriplePanEnd",(()=>{this.updateTbState($l.IDLE,!1),this.dispatchEvent(ic)})),Xl(this,"setCenter",((e,t)=>{ec.x=e,ec.y=t})),Xl(this,"initializeMouseActions",(()=>{this.setMouseAction("PAN",0,"CTRL"),this.setMouseAction("PAN",2),this.setMouseAction("ROTATE",0),this.setMouseAction("ZOOM","WHEEL"),this.setMouseAction("ZOOM",1),this.setMouseAction("FOV","WHEEL","SHIFT"),this.setMouseAction("FOV",1,"SHIFT")})),Xl(this,"setMouseAction",((e,t,n=null)=>{let r;if(!["PAN","ROTATE","ZOOM","FOV"].includes(e)||![0,1,2,"WHEEL"].includes(t)||!["CTRL","SHIFT",null].includes(n))return!1;if("WHEEL"==t&&"ZOOM"!=e&&"FOV"!=e)return!1;switch(e){case"PAN":r=$l.PAN;break;case"ROTATE":r=$l.ROTATE;break;case"ZOOM":r=$l.SCALE;break;case"FOV":r=$l.FOV}const i={operation:e,mouse:t,key:n,state:r};for(let s=0;s<this.mouseActions.length;s++)if(this.mouseActions[s].mouse==i.mouse&&this.mouseActions[s].key==i.key)return this.mouseActions.splice(s,1,i),!0;return this.mouseActions.push(i),!0})),Xl(this,"getOpFromAction",((e,t)=>{let n;for(let r=0;r<this.mouseActions.length;r++)if(n=this.mouseActions[r],n.mouse==e&&n.key==t)return n.operation;if(t)for(let r=0;r<this.mouseActions.length;r++)if(n=this.mouseActions[r],n.mouse==e&&null==n.key)return n.operation;return null})),Xl(this,"getOpStateFromAction",((e,t)=>{let n;for(let r=0;r<this.mouseActions.length;r++)if(n=this.mouseActions[r],n.mouse==e&&n.key==t)return n.state;if(t)for(let r=0;r<this.mouseActions.length;r++)if(n=this.mouseActions[r],n.mouse==e&&null==n.key)return n.state;return null})),Xl(this,"getAngle",((e,t)=>180*Math.atan2(t.clientY-e.clientY,t.clientX-e.clientX)/Math.PI)),Xl(this,"updateTouchEvent",(e=>{for(let t=0;t<this._touchCurrent.length;t++)if(this._touchCurrent[t].pointerId==e.pointerId){this._touchCurrent.splice(t,1,e);break}})),Xl(this,"calculateAngularSpeed",((e,t,n,r)=>{const i=(r-n)/1e3;return 0==i?0:(t-e)/i})),Xl(this,"calculatePointersDistance",((e,t)=>Math.sqrt(Math.pow(t.clientX-e.clientX,2)+Math.pow(t.clientY-e.clientY,2)))),Xl(this,"calculateRotationAxis",((e,t)=>(this._rotationMatrix.extractRotation(this._cameraMatrixState),this._quat.setFromRotationMatrix(this._rotationMatrix),this._rotationAxis.crossVectors(e,t).applyQuaternion(this._quat),this._rotationAxis.normalize().clone()))),Xl(this,"calculateTbRadius",(e=>{const t=e.position.distanceTo(this._gizmos.position);if(e instanceof a.ubm){const n=a.cj9.DEG2RAD*e.fov*.5,r=Math.atan(e.aspect*Math.tan(n));return Math.tan(Math.min(n,r))*t*.67}if(e instanceof a.qUd)return.67*Math.min(e.top,e.right)})),Xl(this,"focus",((e,t,n=1)=>{if(this.camera){const r=e.clone();r.sub(this._gizmos.position).multiplyScalar(n),this._translationMatrix.makeTranslation(r.x,r.y,r.z);const i=this._gizmoMatrixState.clone();this._gizmoMatrixState.premultiply(this._translationMatrix),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale);const s=this._cameraMatrixState.clone();this._cameraMatrixState.premultiply(this._translationMatrix),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.enableZoom&&this.applyTransformMatrix(this.applyScale(t,this._gizmos.position)),this._gizmoMatrixState.copy(i),this._cameraMatrixState.copy(s)}})),Xl(this,"drawGrid",(()=>{if(this.scene){const e=8947848,t=3;let n,r,i,s;if(this.camera instanceof a.qUd){const e=this.camera.right-this.camera.left,a=this.camera.bottom-this.camera.top;i=Math.max(e,a),s=i/20,n=i/this.camera.zoom*t,r=n/s*this.camera.zoom}else if(this.camera instanceof a.ubm){const e=this.camera.position.distanceTo(this._gizmos.position),o=a.cj9.DEG2RAD*this.camera.fov*.5,l=Math.atan(this.camera.aspect*Math.tan(o));i=Math.tan(Math.max(o,l))*e*2,s=i/20,n=i*t,r=n/s}null==this._grid&&this.camera&&(this._grid=new a.fTw(n,r,e,e),this._grid.position.copy(this._gizmos.position),this._gridPosition.copy(this._grid.position),this._grid.quaternion.copy(this.camera.quaternion),this._grid.rotateX(.5*Math.PI),this.scene.add(this._grid))}})),Xl(this,"connect",(e=>{e===document&&console.error('THREE.ArcballControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=e,this.domElement.style.touchAction="none",this.domElement.addEventListener("contextmenu",this.onContextMenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointercancel",this.onPointerCancel),this.domElement.addEventListener("wheel",this.onWheel)})),Xl(this,"dispose",(()=>{var e,t,n,r,i;-1!=this._animationId&&window.cancelAnimationFrame(this._animationId),null==(e=this.domElement)||e.removeEventListener("pointerdown",this.onPointerDown),null==(t=this.domElement)||t.removeEventListener("pointercancel",this.onPointerCancel),null==(n=this.domElement)||n.removeEventListener("wheel",this.onWheel),null==(r=this.domElement)||r.removeEventListener("contextmenu",this.onContextMenu),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("resize",this.onWindowResize),null==(i=this.scene)||i.remove(this._gizmos),this.disposeGrid()})),Xl(this,"disposeGrid",(()=>{this._grid&&this.scene&&(this.scene.remove(this._grid),this._grid=null)})),Xl(this,"easeOutCubic",(e=>1-Math.pow(1-e,3))),Xl(this,"activateGizmos",(e=>{for(const t of this._gizmos.children)t.material.setValues({opacity:e?1:.6})})),Xl(this,"getCursorNDC",((e,t,n)=>{const r=n.getBoundingClientRect();return this._v2_1.setX((e-r.left)/r.width*2-1),this._v2_1.setY((r.bottom-t)/r.height*2-1),this._v2_1.clone()})),Xl(this,"getCursorPosition",((e,t,n)=>(this._v2_1.copy(this.getCursorNDC(e,t,n)),this.camera instanceof a.qUd&&(this._v2_1.x*=.5*(this.camera.right-this.camera.left),this._v2_1.y*=.5*(this.camera.top-this.camera.bottom)),this._v2_1.clone()))),Xl(this,"setCamera",(e=>{if(e){e.lookAt(this.target),e.updateMatrix(),e instanceof a.ubm&&(this._fov0=e.fov,this._fovState=e.fov),this._cameraMatrixState0.copy(e.matrix),this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraProjectionState.copy(e.projectionMatrix),this._zoom0=e.zoom,this._zoomState=this._zoom0,this._initialNear=e.near,this._nearPos0=e.position.distanceTo(this.target)-e.near,this._nearPos=this._initialNear,this._initialFar=e.far,this._farPos0=e.position.distanceTo(this.target)-e.far,this._farPos=this._initialFar,this._up0.copy(e.up),this._upState.copy(e.up),this.camera=e,this.camera.updateProjectionMatrix();const t=this.calculateTbRadius(e);void 0!==t&&(this._tbRadius=t),this.makeGizmos(this.target,this._tbRadius)}})),Xl(this,"makeGizmos",((e,t)=>{const n=new a.S20(0,0,t,t).getPoints(this._curvePts),r=(new a.LoY).setFromPoints(n),i=new a.mrM({color:16744576,fog:!1,transparent:!0,opacity:.6}),s=new a.mrM({color:8454016,fog:!1,transparent:!0,opacity:.6}),o=new a.mrM({color:8421631,fog:!1,transparent:!0,opacity:.6}),l=new a.N1A(r,i),c=new a.N1A(r,s),h=new a.N1A(r,o),u=.5*Math.PI;if(l.rotation.x=u,c.rotation.y=u,this._gizmoMatrixState0.identity().setPosition(e),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this.camera&&1!=this.camera.zoom){const t=1/this.camera.zoom;this._scaleMatrix.makeScale(t,t,t),this._translationMatrix.makeTranslation(-e.x,-e.y,-e.z),this._gizmoMatrixState.premultiply(this._translationMatrix).premultiply(this._scaleMatrix),this._translationMatrix.makeTranslation(e.x,e.y,e.z),this._gizmoMatrixState.premultiply(this._translationMatrix)}this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.clear(),this._gizmos.add(l),this._gizmos.add(c),this._gizmos.add(h)})),Xl(this,"onFocusAnim",((e,t,n,r)=>{if(-1==this._timeStart&&(this._timeStart=e),this._state==$l.ANIMATION_FOCUS){const i=(e-this._timeStart)/this.focusAnimationTime;if(this._gizmoMatrixState.copy(r),i>=1)this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(t,this.scaleFactor),this._timeStart=-1,this.updateTbState($l.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(nc);else{const e=this.easeOutCubic(i),s=1-e+this.scaleFactor*e;this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(t,s,e),this.dispatchEvent(nc);const a=this;this._animationId=window.requestAnimationFrame((function(e){a.onFocusAnim(e,t,n,r.clone())}))}}else this._animationId=-1,this._timeStart=-1})),Xl(this,"onRotationAnim",((e,t,n)=>{if(-1==this._timeStart&&(this._anglePrev=0,this._angleCurrent=0,this._timeStart=e),this._state==$l.ANIMATION_ROTATE){const r=(e-this._timeStart)/1e3;if(n+-this.dampingFactor*r>0){this._angleCurrent=.5*-this.dampingFactor*Math.pow(r,2)+n*r+0,this.applyTransformMatrix(this.rotate(t,this._angleCurrent)),this.dispatchEvent(nc);const e=this;this._animationId=window.requestAnimationFrame((function(r){e.onRotationAnim(r,t,n)}))}else this._animationId=-1,this._timeStart=-1,this.updateTbState($l.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(nc)}else this._animationId=-1,this._timeStart=-1,this._state!=$l.ROTATE&&(this.activateGizmos(!1),this.dispatchEvent(nc))})),Xl(this,"pan",((e,t,n=!1)=>{if(this.camera){const r=e.clone().sub(t);if(this.camera instanceof a.qUd&&r.multiplyScalar(1/this.camera.zoom),this.camera instanceof a.ubm&&n){this._v3_1.setFromMatrixPosition(this._cameraMatrixState0),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0);const e=this._v3_1.distanceTo(this._v3_2)/this.camera.position.distanceTo(this._gizmos.position);r.multiplyScalar(1/e)}this._v3_1.set(r.x,r.y,0).applyQuaternion(this.camera.quaternion),this._m4_1.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z),this.setTransformationMatrices(this._m4_1,this._m4_1)}return tc})),Xl(this,"reset",(()=>{if(this.camera){this.camera.zoom=this._zoom0,this.camera instanceof a.ubm&&(this.camera.fov=this._fov0),this.camera.near=this._nearPos,this.camera.far=this._farPos,this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(this._up0),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this._gizmoMatrixState0.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix();const e=this.calculateTbRadius(this.camera);void 0!==e&&(this._tbRadius=e),this.makeGizmos(this._gizmos.position,this._tbRadius),this.camera.lookAt(this._gizmos.position),this.updateTbState($l.IDLE,!1),this.dispatchEvent(nc)}})),Xl(this,"rotate",((e,t)=>{const n=this._gizmos.position;return this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._rotationMatrix.makeRotationAxis(e,-t),this._m4_1.makeTranslation(n.x,n.y,n.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1),tc})),Xl(this,"copyState",(()=>{if(this.camera){const e=JSON.stringify(this.camera instanceof a.qUd?{arcballState:{cameraFar:this.camera.far,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}}:{arcballState:{cameraFar:this.camera.far,cameraFov:this.camera.fov,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}});navigator.clipboard.writeText(e)}})),Xl(this,"pasteState",(()=>{const e=this;navigator.clipboard.readText().then((function(t){e.setStateFromJSON(t)}))})),Xl(this,"saveState",(()=>{this.camera&&(this._cameraMatrixState0.copy(this.camera.matrix),this._gizmoMatrixState0.copy(this._gizmos.matrix),this._nearPos=this.camera.near,this._farPos=this.camera.far,this._zoom0=this.camera.zoom,this._up0.copy(this.camera.up),this.camera instanceof a.ubm&&(this._fov0=this.camera.fov))})),Xl(this,"applyScale",((e,t,n=!0)=>{if(!this.camera)return;const r=t.clone();let i=1/e;if(this.camera instanceof a.qUd){this.camera.zoom=this._zoomState,this.camera.zoom*=e,this.camera.zoom>this.maxZoom?(this.camera.zoom=this.maxZoom,i=this._zoomState/this.maxZoom):this.camera.zoom<this.minZoom&&(this.camera.zoom=this.minZoom,i=this._zoomState/this.minZoom),this.camera.updateProjectionMatrix(),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this._scaleMatrix.makeScale(i,i,i),this._translationMatrix.makeTranslation(-this._v3_1.x,-this._v3_1.y,-this._v3_1.z),this._m4_2.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z).multiply(this._scaleMatrix),this._m4_2.multiply(this._translationMatrix),r.sub(this._v3_1);const t=r.clone().multiplyScalar(i);return r.sub(t),this._m4_1.makeTranslation(r.x,r.y,r.z),this._m4_2.premultiply(this._m4_1),this.setTransformationMatrices(this._m4_1,this._m4_2),tc}if(this.camera instanceof a.ubm){this._v3_1.setFromMatrixPosition(this._cameraMatrixState),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState);let e=this._v3_1.distanceTo(r),t=e-e*i;const s=e-t;s<this.minDistance?(i=this.minDistance/e,t=e-e*i):s>this.maxDistance&&(i=this.maxDistance/e,t=e-e*i);let a=r.clone().sub(this._v3_1).normalize().multiplyScalar(t);if(this._m4_1.makeTranslation(a.x,a.y,a.z),n){const n=this._v3_2;e=n.distanceTo(r),t=e-e*i,a=r.clone().sub(this._v3_2).normalize().multiplyScalar(t),this._translationMatrix.makeTranslation(n.x,n.y,n.z),this._scaleMatrix.makeScale(i,i,i),this._m4_2.makeTranslation(a.x,a.y,a.z).multiply(this._translationMatrix),this._m4_2.multiply(this._scaleMatrix),this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._m4_2.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1,this._m4_2)}else this.setTransformationMatrices(this._m4_1);return tc}})),Xl(this,"setFov",(e=>{this.camera instanceof a.ubm&&(this.camera.fov=a.cj9.clamp(e,this.minFov,this.maxFov),this.camera.updateProjectionMatrix())})),Xl(this,"setTarget",((e,t,n)=>{if(this.camera){this.target.set(e,t,n),this._gizmos.position.set(e,t,n);const r=this.calculateTbRadius(this.camera);void 0!==r&&(this._tbRadius=r),this.makeGizmos(this.target,this._tbRadius),this.camera.lookAt(this.target)}})),Xl(this,"zRotate",((e,t)=>(this._rotationMatrix.makeRotationAxis(this._rotationAxis,t),this._translationMatrix.makeTranslation(-e.x,-e.y,-e.z),this._m4_1.makeTranslation(e.x,e.y,e.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState).sub(e),this._v3_2.copy(this._v3_1).applyAxisAngle(this._rotationAxis,t),this._v3_2.sub(this._v3_1),this._m4_2.makeTranslation(this._v3_2.x,this._v3_2.y,this._v3_2.z),this.setTransformationMatrices(this._m4_1,this._m4_2),tc))),Xl(this,"unprojectOnObj",((e,t)=>{if(!this.scene)return null;const n=new a.tBo;n.near=t.near,n.far=t.far,n.setFromCamera(e,t);const r=n.intersectObjects(this.scene.children,!0);for(let i=0;i<r.length;i++)if(r[i].object.uuid!=this._gizmos.uuid&&r[i].face)return r[i].point.clone();return null})),Xl(this,"unprojectOnTbSurface",((e,t,n,r,i)=>{if(e instanceof a.qUd){this._v2_1.copy(this.getCursorPosition(t,n,r)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0);const e=Math.pow(this._v2_1.x,2),i=Math.pow(this._v2_1.y,2),s=Math.pow(this._tbRadius,2);return e+i<=.5*s?this._v3_1.setZ(Math.sqrt(s-(e+i))):this._v3_1.setZ(.5*s/Math.sqrt(e+i)),this._v3_1}if(e instanceof a.ubm){this._v2_1.copy(this.getCursorNDC(t,n,r)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(e.projectionMatrixInverse);const s=this._v3_1.clone().normalize(),o=e.position.distanceTo(this._gizmos.position),l=Math.pow(i,2),c=this._v3_1.z,h=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));if(0==h)return s.set(this._v3_1.x,this._v3_1.y,i),s;const u=c/h,d=o;let f=Math.pow(u,2)+1,A=2*u*d,m=Math.pow(d,2)-l,p=Math.pow(A,2)-4*f*m;if(p>=0){this._v2_1.setX((-A-Math.sqrt(p))/(2*f)),this._v2_1.setY(u*this._v2_1.x+d);if(a.cj9.RAD2DEG*this._v2_1.angle()>=45){const e=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(o-this._v2_1.y,2));return s.multiplyScalar(e),s.z+=o,s}}f=u,A=d,m=.5*-l,p=Math.pow(A,2)-4*f*m,this._v2_1.setX((-A-Math.sqrt(p))/(2*f)),this._v2_1.setY(u*this._v2_1.x+d);const g=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(o-this._v2_1.y,2));return s.multiplyScalar(g),s.z+=o,s}})),Xl(this,"unprojectOnTbPlane",((e,t,n,r,i=!1)=>{if(e instanceof a.qUd)return this._v2_1.copy(this.getCursorPosition(t,n,r)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0),this._v3_1.clone();if(e instanceof a.ubm){this._v2_1.copy(this.getCursorNDC(t,n,r)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(e.projectionMatrixInverse);const s=this._v3_1.clone().normalize(),a=this._v3_1.z,o=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));let l;if(l=i?this._v3_1.setFromMatrixPosition(this._cameraMatrixState0).distanceTo(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0)):e.position.distanceTo(this._gizmos.position),0==o)return s.set(0,0,0),s;const c=l,h=-c/(a/o),u=Math.sqrt(Math.pow(c,2)+Math.pow(h,2));return s.multiplyScalar(u),s.z=0,s}})),Xl(this,"updateMatrixState",(()=>{this.camera&&(this._cameraMatrixState.copy(this.camera.matrix),this._gizmoMatrixState.copy(this._gizmos.matrix),this.camera instanceof a.qUd&&(this._cameraProjectionState.copy(this.camera.projectionMatrix),this.camera.updateProjectionMatrix(),this._zoomState=this.camera.zoom),this.camera instanceof a.ubm&&(this._fovState=this.camera.fov))})),Xl(this,"updateTbState",((e,t)=>{this._state=e,t&&this.updateMatrixState()})),Xl(this,"update",(()=>{const e=1e-6;if(!this.target.equals(this._currentTarget)&&this.camera){this._gizmos.position.set(this.target.x,this.target.y,this.target.z);const e=this.calculateTbRadius(this.camera);void 0!==e&&(this._tbRadius=e),this.makeGizmos(this.target,this._tbRadius),this._currentTarget.copy(this.target)}if(this.camera){if(this.camera instanceof a.qUd&&(this.camera.zoom>this.maxZoom||this.camera.zoom<this.minZoom)){const e=a.cj9.clamp(this.camera.zoom,this.minZoom,this.maxZoom);this.applyTransformMatrix(this.applyScale(e/this.camera.zoom,this._gizmos.position,!0))}if(this.camera instanceof a.ubm){const t=this.camera.position.distanceTo(this._gizmos.position);if(t>this.maxDistance+e||t<this.minDistance-e){const e=a.cj9.clamp(t,this.minDistance,this.maxDistance);this.applyTransformMatrix(this.applyScale(e/t,this._gizmos.position)),this.updateMatrixState()}(this.camera.fov<this.minFov||this.camera.fov>this.maxFov)&&(this.camera.fov=a.cj9.clamp(this.camera.fov,this.minFov,this.maxFov),this.camera.updateProjectionMatrix());const n=this._tbRadius,r=this.calculateTbRadius(this.camera);if(void 0!==r&&(this._tbRadius=r),n<this._tbRadius-e||n>this._tbRadius+e){const e=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3,t=this._tbRadius/e,n=new a.S20(0,0,t,t).getPoints(this._curvePts),r=(new a.LoY).setFromPoints(n);for(const i in this._gizmos.children){this._gizmos.children[i].geometry=r}}}this.camera.lookAt(this._gizmos.position)}})),Xl(this,"setStateFromJSON",(e=>{const t=JSON.parse(e);if(t.arcballState&&this.camera){this._cameraMatrixState.fromArray(t.arcballState.cameraMatrix.elements),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(t.arcballState.cameraUp),this.camera.near=t.arcballState.cameraNear,this.camera.far=t.arcballState.cameraFar,this.camera.zoom=t.arcballState.cameraZoom,this.camera instanceof a.ubm&&(this.camera.fov=t.arcballState.cameraFov),this._gizmoMatrixState.fromArray(t.arcballState.gizmoMatrix.elements),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmos.updateMatrix();const e=this.calculateTbRadius(this.camera);void 0!==e&&(this._tbRadius=e);const n=(new a.kn4).copy(this._gizmoMatrixState0);this.makeGizmos(this._gizmos.position,this._tbRadius),this._gizmoMatrixState0.copy(n),this.camera.lookAt(this._gizmos.position),this.updateTbState($l.IDLE,!1),this.dispatchEvent(nc)}})),this.camera=null,this.domElement=t,this.scene=n,this.mouseActions=[],this._mouseOp=null,this._v2_1=new a.I9Y,this._v3_1=new a.Pq0,this._v3_2=new a.Pq0,this._m4_1=new a.kn4,this._m4_2=new a.kn4,this._quat=new a.PTz,this._translationMatrix=new a.kn4,this._rotationMatrix=new a.kn4,this._scaleMatrix=new a.kn4,this._rotationAxis=new a.Pq0,this._cameraMatrixState=new a.kn4,this._cameraProjectionState=new a.kn4,this._fovState=1,this._upState=new a.Pq0,this._zoomState=1,this._nearPos=0,this._farPos=0,this._gizmoMatrixState=new a.kn4,this._up0=new a.Pq0,this._zoom0=1,this._fov0=0,this._initialNear=0,this._nearPos0=0,this._initialFar=0,this._farPos0=0,this._cameraMatrixState0=new a.kn4,this._gizmoMatrixState0=new a.kn4,this._button=-1,this._touchStart=[],this._touchCurrent=[],this._input=Zl.NONE,this._switchSensibility=32,this._startFingerDistance=0,this._currentFingerDistance=0,this._startFingerRotation=0,this._currentFingerRotation=0,this._devPxRatio=0,this._downValid=!0,this._nclicks=0,this._downEvents=[],this._clickStart=0,this._maxDownTime=250,this._maxInterval=300,this._posThreshold=24,this._movementThreshold=24,this._currentCursorPosition=new a.Pq0,this._startCursorPosition=new a.Pq0,this._grid=null,this._gridPosition=new a.Pq0,this._gizmos=new a.YJl,this._curvePts=128,this._timeStart=-1,this._animationId=-1,this.focusAnimationTime=500,this._timePrev=0,this._timeCurrent=0,this._anglePrev=0,this._angleCurrent=0,this._cursorPosPrev=new a.Pq0,this._cursorPosCurr=new a.Pq0,this._wPrev=0,this._wCurr=0,this.adjustNearFar=!1,this.scaleFactor=1.1,this.dampingFactor=25,this.wMax=20,this.enableAnimations=!0,this.enableGrid=!1,this.cursorZoom=!1,this.minFov=5,this.maxFov=90,this.enabled=!0,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.target=new a.Pq0(0,0,0),this._currentTarget=new a.Pq0(0,0,0),this._tbRadius=1,this._state=$l.IDLE,this.setCamera(e),this.scene&&this.scene.add(this._gizmos),this._devPxRatio=window.devicePixelRatio,this.initializeMouseActions(),this.domElement&&this.connect(this.domElement),window.addEventListener("resize",this.onWindowResize)}applyTransformMatrix(e){if((null==e?void 0:e.camera)&&this.camera&&(this._m4_1.copy(this._cameraMatrixState).premultiply(e.camera),this._m4_1.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.updateMatrix(),this._state!=$l.ROTATE&&this._state!=$l.ZROTATE&&this._state!=$l.ANIMATION_ROTATE||this.camera.up.copy(this._upState).applyQuaternion(this.camera.quaternion)),(null==e?void 0:e.gizmos)&&(this._m4_1.copy(this._gizmoMatrixState).premultiply(e.gizmos),this._m4_1.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix()),(this._state==$l.SCALE||this._state==$l.FOCUS||this._state==$l.ANIMATION_FOCUS)&&this.camera){const e=this.calculateTbRadius(this.camera);if(void 0!==e&&(this._tbRadius=e),this.adjustNearFar){const e=this.camera.position.distanceTo(this._gizmos.position),t=new a.NRn;t.setFromObject(this._gizmos);const n=new a.iyt;t.getBoundingSphere(n);const r=Math.max(this._nearPos0,n.radius+n.center.length()),i=e-this._initialNear,s=Math.min(r,i);this.camera.near=e-s;const o=Math.min(this._farPos0,-n.radius+n.center.length()),l=e-this._initialFar,c=Math.min(o,l);this.camera.far=e-c,this.camera.updateProjectionMatrix()}else{let e=!1;this.camera.near!=this._initialNear&&(this.camera.near=this._initialNear,e=!0),this.camera.far!=this._initialFar&&(this.camera.far=this._initialFar,e=!0),e&&this.camera.updateProjectionMatrix()}}}setGizmosVisible(e){this._gizmos.visible=e,this.dispatchEvent(nc)}setTransformationMatrices(e=null,t=null){e?tc.camera?tc.camera.copy(e):tc.camera=e.clone():tc.camera=null,t?tc.gizmos?tc.gizmos.copy(t):tc.gizmos=t.clone():tc.gizmos=null}}const ac=(0,i.forwardRef)((({camera:e,makeDefault:t,regress:n,domElement:s,onChange:a,onStart:l,onEnd:c,...h},u)=>{const d=(0,o.A)((e=>e.invalidate)),f=(0,o.A)((e=>e.camera)),A=(0,o.A)((e=>e.gl)),m=(0,o.A)((e=>e.events)),p=(0,o.A)((e=>e.set)),g=(0,o.A)((e=>e.get)),v=(0,o.A)((e=>e.performance)),y=e||f,E=s||m.connected||A.domElement,x=(0,i.useMemo)((()=>new sc(y)),[y]);return(0,o.C)((()=>{x.enabled&&x.update()}),-1),(0,i.useEffect)((()=>(x.connect(E),()=>{x.dispose()})),[E,n,x,d]),(0,i.useEffect)((()=>{const e=e=>{d(),n&&v.regress(),a&&a(e)};return x.addEventListener("change",e),l&&x.addEventListener("start",l),c&&x.addEventListener("end",c),()=>{x.removeEventListener("change",e),l&&x.removeEventListener("start",l),c&&x.removeEventListener("end",c)}}),[a,l,c]),(0,i.useEffect)((()=>{if(t){const e=g().controls;return p({controls:x}),()=>p({controls:e})}}),[t,x]),i.createElement("primitive",(0,r.A)({ref:u,object:x},h))}));var oc=Object.defineProperty,lc=(e,t,n)=>(((e,t,n)=>{t in e?oc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class cc extends a.B69{constructor(e,t){super(),lc(this,"isTransformControls",!0),lc(this,"visible",!1),lc(this,"domElement"),lc(this,"raycaster",new a.tBo),lc(this,"gizmo"),lc(this,"plane"),lc(this,"tempVector",new a.Pq0),lc(this,"tempVector2",new a.Pq0),lc(this,"tempQuaternion",new a.PTz),lc(this,"unit",{X:new a.Pq0(1,0,0),Y:new a.Pq0(0,1,0),Z:new a.Pq0(0,0,1)}),lc(this,"pointStart",new a.Pq0),lc(this,"pointEnd",new a.Pq0),lc(this,"offset",new a.Pq0),lc(this,"rotationAxis",new a.Pq0),lc(this,"startNorm",new a.Pq0),lc(this,"endNorm",new a.Pq0),lc(this,"rotationAngle",0),lc(this,"cameraPosition",new a.Pq0),lc(this,"cameraQuaternion",new a.PTz),lc(this,"cameraScale",new a.Pq0),lc(this,"parentPosition",new a.Pq0),lc(this,"parentQuaternion",new a.PTz),lc(this,"parentQuaternionInv",new a.PTz),lc(this,"parentScale",new a.Pq0),lc(this,"worldPositionStart",new a.Pq0),lc(this,"worldQuaternionStart",new a.PTz),lc(this,"worldScaleStart",new a.Pq0),lc(this,"worldPosition",new a.Pq0),lc(this,"worldQuaternion",new a.PTz),lc(this,"worldQuaternionInv",new a.PTz),lc(this,"worldScale",new a.Pq0),lc(this,"eye",new a.Pq0),lc(this,"positionStart",new a.Pq0),lc(this,"quaternionStart",new a.PTz),lc(this,"scaleStart",new a.Pq0),lc(this,"camera"),lc(this,"object"),lc(this,"enabled",!0),lc(this,"axis",null),lc(this,"mode","translate"),lc(this,"translationSnap",null),lc(this,"rotationSnap",null),lc(this,"scaleSnap",null),lc(this,"space","world"),lc(this,"size",1),lc(this,"dragging",!1),lc(this,"showX",!0),lc(this,"showY",!0),lc(this,"showZ",!0),lc(this,"changeEvent",{type:"change"}),lc(this,"mouseDownEvent",{type:"mouseDown",mode:this.mode}),lc(this,"mouseUpEvent",{type:"mouseUp",mode:this.mode}),lc(this,"objectChangeEvent",{type:"objectChange"}),lc(this,"intersectObjectWithRay",((e,t,n)=>{const r=t.intersectObject(e,!0);for(let i=0;i<r.length;i++)if(r[i].object.visible||n)return r[i];return!1})),lc(this,"attach",(e=>(this.object=e,this.visible=!0,this))),lc(this,"detach",(()=>(this.object=void 0,this.visible=!1,this.axis=null,this))),lc(this,"reset",(()=>this.enabled?(this.dragging&&void 0!==this.object&&(this.object.position.copy(this.positionStart),this.object.quaternion.copy(this.quaternionStart),this.object.scale.copy(this.scaleStart),this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent),this.pointStart.copy(this.pointEnd)),this):this)),lc(this,"updateMatrixWorld",(()=>{void 0!==this.object&&(this.object.updateMatrixWorld(),null===this.object.parent?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this.parentPosition,this.parentQuaternion,this.parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this.worldScale),this.parentQuaternionInv.copy(this.parentQuaternion).invert(),this.worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this.cameraScale),this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld()})),lc(this,"pointerHover",(e=>{if(void 0===this.object||!0===this.dragging)return;this.raycaster.setFromCamera(e,this.camera);const t=this.intersectObjectWithRay(this.gizmo.picker[this.mode],this.raycaster);this.axis=t?t.object.name:null})),lc(this,"pointerDown",(e=>{if(void 0!==this.object&&!0!==this.dragging&&0===e.button&&null!==this.axis){this.raycaster.setFromCamera(e,this.camera);const t=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(t){let e=this.space;if("scale"===this.mode?e="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(e="world"),"local"===e&&"rotate"===this.mode){const e=this.rotationSnap;"X"===this.axis&&e&&(this.object.rotation.x=Math.round(this.object.rotation.x/e)*e),"Y"===this.axis&&e&&(this.object.rotation.y=Math.round(this.object.rotation.y/e)*e),"Z"===this.axis&&e&&(this.object.rotation.z=Math.round(this.object.rotation.z/e)*e)}this.object.updateMatrixWorld(),this.object.parent&&this.object.parent.updateMatrixWorld(),this.positionStart.copy(this.object.position),this.quaternionStart.copy(this.object.quaternion),this.scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this.worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)}this.dragging=!0,this.mouseDownEvent.mode=this.mode,this.dispatchEvent(this.mouseDownEvent)}})),lc(this,"pointerMove",(e=>{const t=this.axis,n=this.mode,r=this.object;let i=this.space;if("scale"===n?i="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(i="world"),void 0===r||null===t||!1===this.dragging||-1!==e.button)return;this.raycaster.setFromCamera(e,this.camera);const s=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(s){if(this.pointEnd.copy(s.point).sub(this.worldPositionStart),"translate"===n)this.offset.copy(this.pointEnd).sub(this.pointStart),"local"===i&&"XYZ"!==t&&this.offset.applyQuaternion(this.worldQuaternionInv),-1===t.indexOf("X")&&(this.offset.x=0),-1===t.indexOf("Y")&&(this.offset.y=0),-1===t.indexOf("Z")&&(this.offset.z=0),"local"===i&&"XYZ"!==t?this.offset.applyQuaternion(this.quaternionStart).divide(this.parentScale):this.offset.applyQuaternion(this.parentQuaternionInv).divide(this.parentScale),r.position.copy(this.offset).add(this.positionStart),this.translationSnap&&("local"===i&&(r.position.applyQuaternion(this.tempQuaternion.copy(this.quaternionStart).invert()),-1!==t.search("X")&&(r.position.x=Math.round(r.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(r.position.y=Math.round(r.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(r.position.z=Math.round(r.position.z/this.translationSnap)*this.translationSnap),r.position.applyQuaternion(this.quaternionStart)),"world"===i&&(r.parent&&r.position.add(this.tempVector.setFromMatrixPosition(r.parent.matrixWorld)),-1!==t.search("X")&&(r.position.x=Math.round(r.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(r.position.y=Math.round(r.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(r.position.z=Math.round(r.position.z/this.translationSnap)*this.translationSnap),r.parent&&r.position.sub(this.tempVector.setFromMatrixPosition(r.parent.matrixWorld))));else if("scale"===n){if(-1!==t.search("XYZ")){let e=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(e*=-1),this.tempVector2.set(e,e,e)}else this.tempVector.copy(this.pointStart),this.tempVector2.copy(this.pointEnd),this.tempVector.applyQuaternion(this.worldQuaternionInv),this.tempVector2.applyQuaternion(this.worldQuaternionInv),this.tempVector2.divide(this.tempVector),-1===t.search("X")&&(this.tempVector2.x=1),-1===t.search("Y")&&(this.tempVector2.y=1),-1===t.search("Z")&&(this.tempVector2.z=1);r.scale.copy(this.scaleStart).multiply(this.tempVector2),this.scaleSnap&&this.object&&(-1!==t.search("X")&&(this.object.scale.x=Math.round(r.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(r.scale.y=Math.round(r.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(r.scale.z=Math.round(r.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===n){this.offset.copy(this.pointEnd).sub(this.pointStart);const e=20/this.worldPosition.distanceTo(this.tempVector.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this.startNorm.copy(this.pointStart).normalize(),this.endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this.endNorm.cross(this.startNorm).dot(this.eye)<0?1:-1):"XYZE"===t?(this.rotationAxis.copy(this.offset).cross(this.eye).normalize(),this.rotationAngle=this.offset.dot(this.tempVector.copy(this.rotationAxis).cross(this.eye))*e):"X"!==t&&"Y"!==t&&"Z"!==t||(this.rotationAxis.copy(this.unit[t]),this.tempVector.copy(this.unit[t]),"local"===i&&this.tempVector.applyQuaternion(this.worldQuaternion),this.rotationAngle=this.offset.dot(this.tempVector.cross(this.eye).normalize())*e),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===i&&"E"!==t&&"XYZE"!==t?(r.quaternion.copy(this.quaternionStart),r.quaternion.multiply(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this.parentQuaternionInv),r.quaternion.copy(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),r.quaternion.multiply(this.quaternionStart).normalize())}this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent)}})),lc(this,"pointerUp",(e=>{0===e.button&&(this.dragging&&null!==this.axis&&(this.mouseUpEvent.mode=this.mode,this.dispatchEvent(this.mouseUpEvent)),this.dragging=!1,this.axis=null)})),lc(this,"getPointer",(e=>{var t;if(this.domElement&&(null==(t=this.domElement.ownerDocument)?void 0:t.pointerLockElement))return{x:0,y:0,button:e.button};{const t=e.changedTouches?e.changedTouches[0]:e,n=this.domElement.getBoundingClientRect();return{x:(t.clientX-n.left)/n.width*2-1,y:-(t.clientY-n.top)/n.height*2+1,button:e.button}}})),lc(this,"onPointerHover",(e=>{if(this.enabled)switch(e.pointerType){case"mouse":case"pen":this.pointerHover(this.getPointer(e))}})),lc(this,"onPointerDown",(e=>{this.enabled&&this.domElement&&(this.domElement.style.touchAction="none",this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.pointerHover(this.getPointer(e)),this.pointerDown(this.getPointer(e)))})),lc(this,"onPointerMove",(e=>{this.enabled&&this.pointerMove(this.getPointer(e))})),lc(this,"onPointerUp",(e=>{this.enabled&&this.domElement&&(this.domElement.style.touchAction="",this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.pointerUp(this.getPointer(e)))})),lc(this,"getMode",(()=>this.mode)),lc(this,"setMode",(e=>{this.mode=e})),lc(this,"setTranslationSnap",(e=>{this.translationSnap=e})),lc(this,"setRotationSnap",(e=>{this.rotationSnap=e})),lc(this,"setScaleSnap",(e=>{this.scaleSnap=e})),lc(this,"setSize",(e=>{this.size=e})),lc(this,"setSpace",(e=>{this.space=e})),lc(this,"update",(()=>{console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")})),lc(this,"connect",(e=>{e===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=e,this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointermove",this.onPointerHover),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp)})),lc(this,"dispose",(()=>{var e,t,n,r,i,s;null==(e=this.domElement)||e.removeEventListener("pointerdown",this.onPointerDown),null==(t=this.domElement)||t.removeEventListener("pointermove",this.onPointerHover),null==(r=null==(n=this.domElement)?void 0:n.ownerDocument)||r.removeEventListener("pointermove",this.onPointerMove),null==(s=null==(i=this.domElement)?void 0:i.ownerDocument)||s.removeEventListener("pointerup",this.onPointerUp),this.traverse((e=>{const t=e;t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}))})),this.domElement=t,this.camera=e,this.gizmo=new hc,this.add(this.gizmo),this.plane=new uc,this.add(this.plane);const n=(e,t)=>{let n=t;Object.defineProperty(this,e,{get:function(){return void 0!==n?n:t},set:function(t){n!==t&&(n=t,this.plane[e]=t,this.gizmo[e]=t,this.dispatchEvent({type:e+"-changed",value:t}),this.dispatchEvent(this.changeEvent))}}),this[e]=t,this.plane[e]=t,this.gizmo[e]=t};n("camera",this.camera),n("object",this.object),n("enabled",this.enabled),n("axis",this.axis),n("mode",this.mode),n("translationSnap",this.translationSnap),n("rotationSnap",this.rotationSnap),n("scaleSnap",this.scaleSnap),n("space",this.space),n("size",this.size),n("dragging",this.dragging),n("showX",this.showX),n("showY",this.showY),n("showZ",this.showZ),n("worldPosition",this.worldPosition),n("worldPositionStart",this.worldPositionStart),n("worldQuaternion",this.worldQuaternion),n("worldQuaternionStart",this.worldQuaternionStart),n("cameraPosition",this.cameraPosition),n("cameraQuaternion",this.cameraQuaternion),n("pointStart",this.pointStart),n("pointEnd",this.pointEnd),n("rotationAxis",this.rotationAxis),n("rotationAngle",this.rotationAngle),n("eye",this.eye),void 0!==t&&this.connect(t)}}class hc extends a.B69{constructor(){super(),lc(this,"isTransformControlsGizmo",!0),lc(this,"type","TransformControlsGizmo"),lc(this,"tempVector",new a.Pq0(0,0,0)),lc(this,"tempEuler",new a.O9p),lc(this,"alignVector",new a.Pq0(0,1,0)),lc(this,"zeroVector",new a.Pq0(0,0,0)),lc(this,"lookAtMatrix",new a.kn4),lc(this,"tempQuaternion",new a.PTz),lc(this,"tempQuaternion2",new a.PTz),lc(this,"identityQuaternion",new a.PTz),lc(this,"unitX",new a.Pq0(1,0,0)),lc(this,"unitY",new a.Pq0(0,1,0)),lc(this,"unitZ",new a.Pq0(0,0,1)),lc(this,"gizmo"),lc(this,"picker"),lc(this,"helper"),lc(this,"rotationAxis",new a.Pq0),lc(this,"cameraPosition",new a.Pq0),lc(this,"worldPositionStart",new a.Pq0),lc(this,"worldQuaternionStart",new a.PTz),lc(this,"worldPosition",new a.Pq0),lc(this,"worldQuaternion",new a.PTz),lc(this,"eye",new a.Pq0),lc(this,"camera",null),lc(this,"enabled",!0),lc(this,"axis",null),lc(this,"mode","translate"),lc(this,"space","world"),lc(this,"size",1),lc(this,"dragging",!1),lc(this,"showX",!0),lc(this,"showY",!0),lc(this,"showZ",!0),lc(this,"updateMatrixWorld",(()=>{let e=this.space;"scale"===this.mode&&(e="local");const t="local"===e?this.worldQuaternion:this.identityQuaternion;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let n=[];n=n.concat(this.picker[this.mode].children),n=n.concat(this.gizmo[this.mode].children),n=n.concat(this.helper[this.mode].children);for(let r=0;r<n.length;r++){const e=n[r];let i;if(e.visible=!0,e.rotation.set(0,0,0),e.position.copy(this.worldPosition),i=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),e.scale.set(1,1,1).multiplyScalar(i*this.size/7),"helper"!==e.tag){if(e.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode){const n=.99,r=.2,i=0;"X"!==e.name&&"XYZX"!==e.name||Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(t).dot(this.eye))>n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"Y"!==e.name&&"XYZY"!==e.name||Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(t).dot(this.eye))>n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"Z"!==e.name&&"XYZZ"!==e.name||Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(t).dot(this.eye))>n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"XY"===e.name&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(t).dot(this.eye))<r&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"YZ"===e.name&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(t).dot(this.eye))<r&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"XZ"===e.name&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(t).dot(this.eye))<r&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),-1!==e.name.search("X")&&(this.alignVector.copy(this.unitX).applyQuaternion(t).dot(this.eye)<i?"fwd"===e.tag?e.visible=!1:e.scale.x*=-1:"bwd"===e.tag&&(e.visible=!1)),-1!==e.name.search("Y")&&(this.alignVector.copy(this.unitY).applyQuaternion(t).dot(this.eye)<i?"fwd"===e.tag?e.visible=!1:e.scale.y*=-1:"bwd"===e.tag&&(e.visible=!1)),-1!==e.name.search("Z")&&(this.alignVector.copy(this.unitZ).applyQuaternion(t).dot(this.eye)<i?"fwd"===e.tag?e.visible=!1:e.scale.z*=-1:"bwd"===e.tag&&(e.visible=!1))}else"rotate"===this.mode&&(this.tempQuaternion2.copy(t),this.alignVector.copy(this.eye).applyQuaternion(this.tempQuaternion.copy(t).invert()),-1!==e.name.search("E")&&e.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.eye,this.zeroVector,this.unitY)),"X"===e.name&&(this.tempQuaternion.setFromAxisAngle(this.unitX,Math.atan2(-this.alignVector.y,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),e.quaternion.copy(this.tempQuaternion)),"Y"===e.name&&(this.tempQuaternion.setFromAxisAngle(this.unitY,Math.atan2(this.alignVector.x,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),e.quaternion.copy(this.tempQuaternion)),"Z"===e.name&&(this.tempQuaternion.setFromAxisAngle(this.unitZ,Math.atan2(this.alignVector.y,this.alignVector.x)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),e.quaternion.copy(this.tempQuaternion)));e.visible=e.visible&&(-1===e.name.indexOf("X")||this.showX),e.visible=e.visible&&(-1===e.name.indexOf("Y")||this.showY),e.visible=e.visible&&(-1===e.name.indexOf("Z")||this.showZ),e.visible=e.visible&&(-1===e.name.indexOf("E")||this.showX&&this.showY&&this.showZ),e.material.tempOpacity=e.material.tempOpacity||e.material.opacity,e.material.tempColor=e.material.tempColor||e.material.color.clone(),e.material.color.copy(e.material.tempColor),e.material.opacity=e.material.tempOpacity,this.enabled?this.axis&&(e.name===this.axis||this.axis.split("").some((function(t){return e.name===t}))?(e.material.opacity=1,e.material.color.lerp(new a.Q1f(1,1,1),.5)):(e.material.opacity*=.25,e.material.color.lerp(new a.Q1f(1,1,1),.5))):(e.material.opacity*=.5,e.material.color.lerp(new a.Q1f(1,1,1),.5))}else e.visible=!1,"AXIS"===e.name?(e.position.copy(this.worldPositionStart),e.visible=!!this.axis,"X"===this.axis&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,0)),e.quaternion.copy(t).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"Y"===this.axis&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,Math.PI/2)),e.quaternion.copy(t).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"Z"===this.axis&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),e.quaternion.copy(t).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"XYZE"===this.axis&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),this.alignVector.copy(this.rotationAxis),e.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.zeroVector,this.alignVector,this.unitY)),e.quaternion.multiply(this.tempQuaternion),e.visible=this.dragging),"E"===this.axis&&(e.visible=!1)):"START"===e.name?(e.position.copy(this.worldPositionStart),e.visible=this.dragging):"END"===e.name?(e.position.copy(this.worldPosition),e.visible=this.dragging):"DELTA"===e.name?(e.position.copy(this.worldPositionStart),e.quaternion.copy(this.worldQuaternionStart),this.tempVector.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),this.tempVector.applyQuaternion(this.worldQuaternionStart.clone().invert()),e.scale.copy(this.tempVector),e.visible=this.dragging):(e.quaternion.copy(t),this.dragging?e.position.copy(this.worldPositionStart):e.position.copy(this.worldPosition),this.axis&&(e.visible=-1!==this.axis.search(e.name)))}super.updateMatrixWorld()}));const e=new a.V9B({depthTest:!1,depthWrite:!1,transparent:!0,side:a.$EB,fog:!1,toneMapped:!1}),t=new a.mrM({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1}),n=e.clone();n.opacity=.15;const r=e.clone();r.opacity=.33;const i=e.clone();i.color.set(16711680);const s=e.clone();s.color.set(65280);const o=e.clone();o.color.set(255);const l=e.clone();l.opacity=.25;const c=l.clone();c.color.set(16776960);const h=l.clone();h.color.set(65535);const u=l.clone();u.color.set(16711935);e.clone().color.set(16776960);const d=t.clone();d.color.set(16711680);const f=t.clone();f.color.set(65280);const A=t.clone();A.color.set(255);const m=t.clone();m.color.set(65535);const p=t.clone();p.color.set(16711935);const g=t.clone();g.color.set(16776960);const v=t.clone();v.color.set(7895160);const y=g.clone();y.opacity=.25;const E=new a.Ho_(0,.05,.2,12,1,!1),x=new a.iNn(.125,.125,.125),C=new a.LoY;C.setAttribute("position",new a.qtW([0,0,0,1,0,0],3));const w=(e,t)=>{const n=new a.LoY,r=[];for(let i=0;i<=64*t;++i)r.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e);return n.setAttribute("position",new a.qtW(r,3)),n},I={X:[[new a.eaF(E,i),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new a.eaF(E,i),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new a.N1A(C,d)]],Y:[[new a.eaF(E,s),[0,1,0],null,null,"fwd"],[new a.eaF(E,s),[0,1,0],[Math.PI,0,0],null,"bwd"],[new a.N1A(C,f),null,[0,0,Math.PI/2]]],Z:[[new a.eaF(E,o),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new a.eaF(E,o),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new a.N1A(C,A),null,[0,-Math.PI/2,0]]],XYZ:[[new a.eaF(new a.Ufg(.1,0),l.clone()),[0,0,0],[0,0,0]]],XY:[[new a.eaF(new a.bdM(.295,.295),c.clone()),[.15,.15,0]],[new a.N1A(C,g),[.18,.3,0],null,[.125,1,1]],[new a.N1A(C,g),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new a.eaF(new a.bdM(.295,.295),h.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new a.N1A(C,m),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new a.N1A(C,m),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new a.eaF(new a.bdM(.295,.295),u.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new a.N1A(C,p),[.18,0,.3],null,[.125,1,1]],[new a.N1A(C,p),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},b={X:[[new a.eaF(new a.Ho_(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new a.eaF(new a.Ho_(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new a.eaF(new a.Ho_(.2,0,1,4,1,!1),n),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new a.eaF(new a.Ufg(.2,0),n)]],XY:[[new a.eaF(new a.bdM(.4,.4),n),[.2,.2,0]]],YZ:[[new a.eaF(new a.bdM(.4,.4),n),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new a.eaF(new a.bdM(.4,.4),n),[.2,0,.2],[-Math.PI/2,0,0]]]},S={START:[[new a.eaF(new a.Ufg(.01,2),r),null,null,null,"helper"]],END:[[new a.eaF(new a.Ufg(.01,2),r),null,null,null,"helper"]],DELTA:[[new a.N1A((()=>{const e=new a.LoY;return e.setAttribute("position",new a.qtW([0,0,0,1,1,1],3)),e})(),r),null,null,null,"helper"]],X:[[new a.N1A(C,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new a.N1A(C,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new a.N1A(C,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},B={X:[[new a.N1A(w(1,.5),d)],[new a.eaF(new a.Ufg(.04,0),i),[0,0,.99],null,[1,3,1]]],Y:[[new a.N1A(w(1,.5),f),null,[0,0,-Math.PI/2]],[new a.eaF(new a.Ufg(.04,0),s),[0,0,.99],null,[3,1,1]]],Z:[[new a.N1A(w(1,.5),A),null,[0,Math.PI/2,0]],[new a.eaF(new a.Ufg(.04,0),o),[.99,0,0],null,[1,3,1]]],E:[[new a.N1A(w(1.25,1),y),null,[0,Math.PI/2,0]],[new a.eaF(new a.Ho_(.03,0,.15,4,1,!1),y),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new a.eaF(new a.Ho_(.03,0,.15,4,1,!1),y),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new a.eaF(new a.Ho_(.03,0,.15,4,1,!1),y),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new a.eaF(new a.Ho_(.03,0,.15,4,1,!1),y),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new a.N1A(w(1,1),v),null,[0,Math.PI/2,0]]]},T={AXIS:[[new a.N1A(C,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},_={X:[[new a.eaF(new a.O3Y(1,.1,4,24),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new a.eaF(new a.O3Y(1,.1,4,24),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new a.eaF(new a.O3Y(1,.1,4,24),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new a.eaF(new a.O3Y(1.25,.1,2,24),n)]],XYZE:[[new a.eaF(new a.Gu$(.7,10,8),n)]]},M={X:[[new a.eaF(x,i),[.8,0,0],[0,0,-Math.PI/2]],[new a.N1A(C,d),null,null,[.8,1,1]]],Y:[[new a.eaF(x,s),[0,.8,0]],[new a.N1A(C,f),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new a.eaF(x,o),[0,0,.8],[Math.PI/2,0,0]],[new a.N1A(C,A),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new a.eaF(x,c),[.85,.85,0],null,[2,2,.2]],[new a.N1A(C,g),[.855,.98,0],null,[.125,1,1]],[new a.N1A(C,g),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new a.eaF(x,h),[0,.85,.85],null,[.2,2,2]],[new a.N1A(C,m),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new a.N1A(C,m),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new a.eaF(x,u),[.85,0,.85],null,[2,.2,2]],[new a.N1A(C,p),[.855,0,.98],null,[.125,1,1]],[new a.N1A(C,p),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new a.eaF(new a.iNn(.125,.125,.125),l.clone()),[1.1,0,0]]],XYZY:[[new a.eaF(new a.iNn(.125,.125,.125),l.clone()),[0,1.1,0]]],XYZZ:[[new a.eaF(new a.iNn(.125,.125,.125),l.clone()),[0,0,1.1]]]},R={X:[[new a.eaF(new a.Ho_(.2,0,.8,4,1,!1),n),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new a.eaF(new a.Ho_(.2,0,.8,4,1,!1),n),[0,.5,0]]],Z:[[new a.eaF(new a.Ho_(.2,0,.8,4,1,!1),n),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new a.eaF(x,n),[.85,.85,0],null,[3,3,.2]]],YZ:[[new a.eaF(x,n),[0,.85,.85],null,[.2,3,3]]],XZ:[[new a.eaF(x,n),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new a.eaF(new a.iNn(.2,.2,.2),n),[1.1,0,0]]],XYZY:[[new a.eaF(new a.iNn(.2,.2,.2),n),[0,1.1,0]]],XYZZ:[[new a.eaF(new a.iNn(.2,.2,.2),n),[0,0,1.1]]]},D={X:[[new a.N1A(C,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new a.N1A(C,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new a.N1A(C,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},P=e=>{const t=new a.B69;for(let n in e)for(let r=e[n].length;r--;){const i=e[n][r][0].clone(),s=e[n][r][1],a=e[n][r][2],o=e[n][r][3],l=e[n][r][4];i.name=n,i.tag=l,s&&i.position.set(s[0],s[1],s[2]),a&&i.rotation.set(a[0],a[1],a[2]),o&&i.scale.set(o[0],o[1],o[2]),i.updateMatrix();const c=i.geometry.clone();c.applyMatrix4(i.matrix),i.geometry=c,i.renderOrder=1/0,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t};this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=P(I)),this.add(this.gizmo.rotate=P(B)),this.add(this.gizmo.scale=P(M)),this.add(this.picker.translate=P(b)),this.add(this.picker.rotate=P(_)),this.add(this.picker.scale=P(R)),this.add(this.helper.translate=P(S)),this.add(this.helper.rotate=P(T)),this.add(this.helper.scale=P(D)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}}class uc extends a.eaF{constructor(){super(new a.bdM(1e5,1e5,2,2),new a.V9B({visible:!1,wireframe:!0,side:a.$EB,transparent:!0,opacity:.1,toneMapped:!1})),lc(this,"isTransformControlsPlane",!0),lc(this,"type","TransformControlsPlane"),lc(this,"unitX",new a.Pq0(1,0,0)),lc(this,"unitY",new a.Pq0(0,1,0)),lc(this,"unitZ",new a.Pq0(0,0,1)),lc(this,"tempVector",new a.Pq0),lc(this,"dirVector",new a.Pq0),lc(this,"alignVector",new a.Pq0),lc(this,"tempMatrix",new a.kn4),lc(this,"identityQuaternion",new a.PTz),lc(this,"cameraQuaternion",new a.PTz),lc(this,"worldPosition",new a.Pq0),lc(this,"worldQuaternion",new a.PTz),lc(this,"eye",new a.Pq0),lc(this,"axis",null),lc(this,"mode","translate"),lc(this,"space","world"),lc(this,"updateMatrixWorld",(()=>{let e=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(e="local"),this.unitX.set(1,0,0).applyQuaternion("local"===e?this.worldQuaternion:this.identityQuaternion),this.unitY.set(0,1,0).applyQuaternion("local"===e?this.worldQuaternion:this.identityQuaternion),this.unitZ.set(0,0,1).applyQuaternion("local"===e?this.worldQuaternion:this.identityQuaternion),this.alignVector.copy(this.unitY),this.mode){case"translate":case"scale":switch(this.axis){case"X":this.alignVector.copy(this.eye).cross(this.unitX),this.dirVector.copy(this.unitX).cross(this.alignVector);break;case"Y":this.alignVector.copy(this.eye).cross(this.unitY),this.dirVector.copy(this.unitY).cross(this.alignVector);break;case"Z":this.alignVector.copy(this.eye).cross(this.unitZ),this.dirVector.copy(this.unitZ).cross(this.alignVector);break;case"XY":this.dirVector.copy(this.unitZ);break;case"YZ":this.dirVector.copy(this.unitX);break;case"XZ":this.alignVector.copy(this.unitZ),this.dirVector.copy(this.unitY);break;case"XYZ":case"E":this.dirVector.set(0,0,0)}break;default:this.dirVector.set(0,0,0)}0===this.dirVector.length()?this.quaternion.copy(this.cameraQuaternion):(this.tempMatrix.lookAt(this.tempVector.set(0,0,0),this.dirVector,this.alignVector),this.quaternion.setFromRotationMatrix(this.tempMatrix)),super.updateMatrixWorld()}))}}const dc=i.forwardRef((({children:e,domElement:t,onChange:n,onMouseDown:s,onMouseUp:l,onObjectChange:c,object:h,makeDefault:u,camera:d,enabled:f,axis:A,mode:m,translationSnap:p,rotationSnap:g,scaleSnap:v,space:y,size:E,showX:x,showY:C,showZ:w,...I},b)=>{const S=(0,o.A)((e=>e.controls)),B=(0,o.A)((e=>e.gl)),T=(0,o.A)((e=>e.events)),_=(0,o.A)((e=>e.camera)),M=(0,o.A)((e=>e.invalidate)),R=(0,o.A)((e=>e.get)),D=(0,o.A)((e=>e.set)),P=d||_,L=t||T.connected||B.domElement,k=i.useMemo((()=>new cc(P,L)),[P,L]),F=i.useRef(null);i.useLayoutEffect((()=>(h?k.attach(h instanceof a.B69?h:h.current):F.current instanceof a.B69&&k.attach(F.current),()=>{k.detach()})),[h,e,k]),i.useEffect((()=>{if(S){const e=e=>S.enabled=!e.value;return k.addEventListener("dragging-changed",e),()=>k.removeEventListener("dragging-changed",e)}}),[k,S]);const O=i.useRef(void 0),U=i.useRef(void 0),Q=i.useRef(void 0),N=i.useRef(void 0);return i.useLayoutEffect((()=>{O.current=n}),[n]),i.useLayoutEffect((()=>{U.current=s}),[s]),i.useLayoutEffect((()=>{Q.current=l}),[l]),i.useLayoutEffect((()=>{N.current=c}),[c]),i.useEffect((()=>{const e=e=>{M(),null==O.current||O.current(e)},t=e=>null==U.current?void 0:U.current(e),n=e=>null==Q.current?void 0:Q.current(e),r=e=>null==N.current?void 0:N.current(e);return k.addEventListener("change",e),k.addEventListener("mouseDown",t),k.addEventListener("mouseUp",n),k.addEventListener("objectChange",r),()=>{k.removeEventListener("change",e),k.removeEventListener("mouseDown",t),k.removeEventListener("mouseUp",n),k.removeEventListener("objectChange",r)}}),[M,k]),i.useEffect((()=>{if(u){const e=R().controls;return D({controls:k}),()=>D({controls:e})}}),[u,k]),i.createElement(i.Fragment,null,i.createElement("primitive",{ref:b,object:k,enabled:f,axis:A,mode:m,translationSnap:p,rotationSnap:g,scaleSnap:v,space:y,size:E,showX:x,showY:C,showZ:w}),i.createElement("group",(0,r.A)({ref:F},I),e))}));var fc=Object.defineProperty,Ac=(e,t,n)=>(((e,t,n)=>{t in e?fc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const mc=new a.O9p(0,0,0,"YXZ"),pc=new a.Pq0,gc={type:"change"},vc={type:"lock"},yc={type:"unlock"},Ec=Math.PI/2;class xc extends Sl{constructor(e,t){super(),Ac(this,"camera"),Ac(this,"domElement"),Ac(this,"isLocked"),Ac(this,"minPolarAngle"),Ac(this,"maxPolarAngle"),Ac(this,"pointerSpeed"),Ac(this,"onMouseMove",(e=>{this.domElement&&!1!==this.isLocked&&(mc.setFromQuaternion(this.camera.quaternion),mc.y-=.002*e.movementX*this.pointerSpeed,mc.x-=.002*e.movementY*this.pointerSpeed,mc.x=Math.max(Ec-this.maxPolarAngle,Math.min(Ec-this.minPolarAngle,mc.x)),this.camera.quaternion.setFromEuler(mc),this.dispatchEvent(gc))})),Ac(this,"onPointerlockChange",(()=>{this.domElement&&(this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(vc),this.isLocked=!0):(this.dispatchEvent(yc),this.isLocked=!1))})),Ac(this,"onPointerlockError",(()=>{console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")})),Ac(this,"connect",(e=>{this.domElement=e||this.domElement,this.domElement&&(this.domElement.ownerDocument.addEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this.onPointerlockError))})),Ac(this,"disconnect",(()=>{this.domElement&&(this.domElement.ownerDocument.removeEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this.onPointerlockError))})),Ac(this,"dispose",(()=>{this.disconnect()})),Ac(this,"getObject",(()=>this.camera)),Ac(this,"direction",new a.Pq0(0,0,-1)),Ac(this,"getDirection",(e=>e.copy(this.direction).applyQuaternion(this.camera.quaternion))),Ac(this,"moveForward",(e=>{pc.setFromMatrixColumn(this.camera.matrix,0),pc.crossVectors(this.camera.up,pc),this.camera.position.addScaledVector(pc,e)})),Ac(this,"moveRight",(e=>{pc.setFromMatrixColumn(this.camera.matrix,0),this.camera.position.addScaledVector(pc,e)})),Ac(this,"lock",(()=>{this.domElement&&this.domElement.requestPointerLock()})),Ac(this,"unlock",(()=>{this.domElement&&this.domElement.ownerDocument.exitPointerLock()})),this.camera=e,this.domElement=t,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,t&&this.connect(t)}}const Cc=i.forwardRef((({domElement:e,selector:t,onChange:n,onLock:s,onUnlock:a,enabled:l=!0,makeDefault:c,...h},u)=>{const{camera:d,...f}=h,A=(0,o.A)((e=>e.setEvents)),m=(0,o.A)((e=>e.gl)),p=(0,o.A)((e=>e.camera)),g=(0,o.A)((e=>e.invalidate)),v=(0,o.A)((e=>e.events)),y=(0,o.A)((e=>e.get)),E=(0,o.A)((e=>e.set)),x=d||p,C=e||v.connected||m.domElement,w=i.useMemo((()=>new xc(x)),[x]);return i.useEffect((()=>{if(l){w.connect(C);const e=y().events.compute;return A({compute(e,t){const n=t.size.width/2,r=t.size.height/2;t.pointer.set(n/t.size.width*2-1,-r/t.size.height*2+1),t.raycaster.setFromCamera(t.pointer,t.camera)}}),()=>{w.disconnect(),A({compute:e})}}}),[l,w]),i.useEffect((()=>{const e=e=>{g(),n&&n(e)};w.addEventListener("change",e),s&&w.addEventListener("lock",s),a&&w.addEventListener("unlock",a);const r=()=>w.lock(),i=t?Array.from(document.querySelectorAll(t)):[document];return i.forEach((e=>e&&e.addEventListener("click",r))),()=>{w.removeEventListener("change",e),s&&w.removeEventListener("lock",s),a&&w.removeEventListener("unlock",a),i.forEach((e=>e?e.removeEventListener("click",r):void 0))}}),[n,s,a,t,w,g]),i.useEffect((()=>{if(c){const e=y().controls;return E({controls:w}),()=>E({controls:e})}}),[c,w]),i.createElement("primitive",(0,r.A)({ref:u,object:w},f))}));var wc=Object.defineProperty,Ic=(e,t,n)=>(((e,t,n)=>{t in e?wc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const bc=new a.Pq0;class Sc extends Sl{constructor(e,t){super(),Ic(this,"object"),Ic(this,"domElement"),Ic(this,"enabled",!0),Ic(this,"movementSpeed",1),Ic(this,"lookSpeed",.005),Ic(this,"lookVertical",!0),Ic(this,"autoForward",!1),Ic(this,"activeLook",!0),Ic(this,"heightSpeed",!1),Ic(this,"heightCoef",1),Ic(this,"heightMin",0),Ic(this,"heightMax",1),Ic(this,"constrainVertical",!1),Ic(this,"verticalMin",0),Ic(this,"verticalMax",Math.PI),Ic(this,"mouseDragOn",!1),Ic(this,"autoSpeedFactor",0),Ic(this,"mouseX",0),Ic(this,"mouseY",0),Ic(this,"moveForward",!1),Ic(this,"moveBackward",!1),Ic(this,"moveLeft",!1),Ic(this,"moveRight",!1),Ic(this,"moveUp",!1),Ic(this,"moveDown",!1),Ic(this,"viewHalfX",0),Ic(this,"viewHalfY",0),Ic(this,"lat",0),Ic(this,"lon",0),Ic(this,"lookDirection",new a.Pq0),Ic(this,"spherical",new a.YHV),Ic(this,"target",new a.Pq0),Ic(this,"connect",(e=>{e.setAttribute("tabindex","-1"),e.style.touchAction="none",e.addEventListener("contextmenu",this.contextmenu),e.addEventListener("mousemove",this.onMouseMove),e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("mouseup",this.onMouseUp),this.domElement=e,window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.handleResize()})),Ic(this,"dispose",(()=>{var e,t,n,r;null==(e=this.domElement)||e.removeEventListener("contextmenu",this.contextmenu),null==(t=this.domElement)||t.removeEventListener("mousedown",this.onMouseDown),null==(n=this.domElement)||n.removeEventListener("mousemove",this.onMouseMove),null==(r=this.domElement)||r.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)})),Ic(this,"handleResize",(()=>{this.domElement&&(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)})),Ic(this,"onMouseDown",(e=>{var t;if(null==(t=this.domElement)||t.focus(),this.activeLook)switch(e.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.mouseDragOn=!0})),Ic(this,"onMouseUp",(e=>{if(this.activeLook)switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.mouseDragOn=!1})),Ic(this,"onMouseMove",(e=>{this.domElement&&(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY)})),Ic(this,"onKeyDown",(e=>{switch(e.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"KeyR":this.moveUp=!0;break;case"KeyF":this.moveDown=!0}})),Ic(this,"onKeyUp",(e=>{switch(e.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"KeyR":this.moveUp=!1;break;case"KeyF":this.moveDown=!1}})),Ic(this,"lookAt",((e,t,n)=>(e instanceof a.Pq0?this.target.copy(e):t&&n&&this.target.set(e,t,n),this.object.lookAt(this.target),this.setOrientation(),this))),Ic(this,"update",(e=>{if(!this.enabled)return;if(this.heightSpeed){const t=a.cj9.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin;this.autoSpeedFactor=e*(t*this.heightCoef)}else this.autoSpeedFactor=0;const t=e*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(t+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(t),this.moveLeft&&this.object.translateX(-t),this.moveRight&&this.object.translateX(t),this.moveUp&&this.object.translateY(t),this.moveDown&&this.object.translateY(-t);let n=e*this.lookSpeed;this.activeLook||(n=0);let r=1;this.constrainVertical&&(r=Math.PI/(this.verticalMax-this.verticalMin)),this.lon-=this.mouseX*n,this.lookVertical&&(this.lat-=this.mouseY*n*r),this.lat=Math.max(-85,Math.min(85,this.lat));let i=a.cj9.degToRad(90-this.lat);const s=a.cj9.degToRad(this.lon);this.constrainVertical&&(i=a.cj9.mapLinear(i,0,Math.PI,this.verticalMin,this.verticalMax));const o=this.object.position;bc.setFromSphericalCoords(1,i,s).add(o),this.object.lookAt(bc)})),Ic(this,"contextmenu",(e=>e.preventDefault())),Ic(this,"setOrientation",(()=>{this.lookDirection.set(0,0,-1).applyQuaternion(this.object.quaternion),this.spherical.setFromVector3(this.lookDirection),this.lat=90-a.cj9.radToDeg(this.spherical.phi),this.lon=a.cj9.radToDeg(this.spherical.theta)})),this.object=e,this.domElement=t,this.setOrientation(),t&&this.connect(t)}}const Bc=i.forwardRef((({domElement:e,makeDefault:t,...n},s)=>{const a=(0,o.A)((e=>e.camera)),l=(0,o.A)((e=>e.gl)),c=(0,o.A)((e=>e.events)),h=(0,o.A)((e=>e.get)),u=(0,o.A)((e=>e.set)),d=e||c.connected||l.domElement,[f]=i.useState((()=>new Sc(a,d)));return i.useEffect((()=>{if(t){const e=h().controls;return u({controls:f}),()=>u({controls:e})}}),[t,f]),(0,o.C)(((e,t)=>{f.update(t)}),-1),f?i.createElement("primitive",(0,r.A)({ref:s,object:f},n)):null})),Tc=1,_c=2,Mc=4,Rc=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),Dc=0,Pc=1,Lc=-1;function kc(e){return e.isPerspectiveCamera}function Fc(e){return e.isOrthographicCamera}const Oc=2*Math.PI,Uc=Math.PI/2,Qc=Math.PI/180;function Nc(e,t,n){return Math.max(t,Math.min(n,e))}function zc(e,t=1e-5){return Math.abs(e)<t}function Gc(e,t,n=1e-5){return zc(e-t,n)}function Hc(e,t){return Math.round(e/t)*t}function qc(e){return isFinite(e)?e:e<0?-Number.MAX_VALUE:Number.MAX_VALUE}function Yc(e){return Math.abs(e)<Number.MAX_VALUE?e:e*(1/0)}function jc(e,t,n,r,i=1/0,s){const a=2/(r=Math.max(1e-4,r)),o=a*s,l=1/(1+o+.48*o*o+.235*o*o*o);let c=e-t;const h=t,u=i*r;c=Nc(c,-u,u),t=e-c;const d=(n.value+a*c)*s;n.value=(n.value-a*d)*l;let f=t+(c+d)*l;return h-e>0==f>h&&(f=h,n.value=(f-h)/s),f}function Vc(e,t,n,r,i=1/0,s,a){const o=2/(r=Math.max(1e-4,r)),l=o*s,c=1/(1+l+.48*l*l+.235*l*l*l);let h=t.x,u=t.y,d=t.z,f=e.x-h,A=e.y-u,m=e.z-d;const p=h,g=u,v=d,y=i*r,E=f*f+A*A+m*m;if(E>y*y){const e=Math.sqrt(E);f=f/e*y,A=A/e*y,m=m/e*y}h=e.x-f,u=e.y-A,d=e.z-m;const x=(n.x+o*f)*s,C=(n.y+o*A)*s,w=(n.z+o*m)*s;n.x=(n.x-o*x)*c,n.y=(n.y-o*C)*c,n.z=(n.z-o*w)*c,a.x=h+(f+x)*c,a.y=u+(A+C)*c,a.z=d+(m+w)*c;const I=p-e.x,b=g-e.y,S=v-e.z;return I*(a.x-p)+b*(a.y-g)+S*(a.z-v)>0&&(a.x=p,a.y=g,a.z=v,n.x=(a.x-p)/s,n.y=(a.y-g)/s,n.z=(a.z-v)/s),a}function Kc(e,t){t.set(0,0),e.forEach((e=>{t.x+=e.clientX,t.y+=e.clientY})),t.x/=e.length,t.y/=e.length}function Wc(e,t){return!!Fc(e)&&(console.warn(`${t} is not supported in OrthographicCamera`),!0)}class Jc{constructor(){this._listeners={}}addEventListener(e,t){const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){const n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)}removeEventListener(e,t){const n=this._listeners[e];if(void 0!==n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}removeAllEventListeners(e){e?Array.isArray(this._listeners[e])&&(this._listeners[e].length=0):this._listeners={}}dispatchEvent(e){const t=this._listeners[e.type];if(void 0!==t){e.target=this;const n=t.slice(0);for(let t=0,r=n.length;t<r;t++)n[t].call(this,e)}}}var Xc;const $c=1/8,Zc=/Mac/.test(null===(Xc=null===globalThis||void 0===globalThis?void 0:globalThis.navigator)||void 0===Xc?void 0:Xc.platform);let eh,th,nh,rh,ih,sh,ah,oh,lh,ch,hh,uh,dh,fh,Ah,mh,ph,gh,vh,yh,Eh,xh,Ch;class wh extends Jc{static install(e){eh=e.THREE,th=Object.freeze(new eh.Vector3(0,0,0)),nh=Object.freeze(new eh.Vector3(0,1,0)),rh=Object.freeze(new eh.Vector3(0,0,1)),ih=new eh.Vector2,sh=new eh.Vector3,ah=new eh.Vector3,oh=new eh.Vector3,lh=new eh.Vector3,ch=new eh.Vector3,hh=new eh.Vector3,uh=new eh.Vector3,dh=new eh.Vector3,fh=new eh.Vector3,Ah=new eh.Spherical,mh=new eh.Spherical,ph=new eh.Box3,gh=new eh.Box3,vh=new eh.Sphere,yh=new eh.Quaternion,Eh=new eh.Quaternion,xh=new eh.Matrix4,Ch=new eh.Raycaster}static get ACTION(){return Rc}constructor(e,t){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=Rc.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=Dc,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new eh.Vector3,this._focalOffsetVelocity=new eh.Vector3,this._zoomVelocity={value:0},this._truckInternal=(e,t,n,r)=>{let i,s;if(kc(this._camera)){const n=sh.copy(this._camera.position).sub(this._target),r=this._camera.getEffectiveFOV()*Qc,a=n.length()*Math.tan(.5*r);i=this.truckSpeed*e*a/this._elementRect.height,s=this.truckSpeed*t*a/this._elementRect.height}else{if(!Fc(this._camera))return;{const n=this._camera;i=this.truckSpeed*e*(n.right-n.left)/n.zoom/this._elementRect.width,s=this.truckSpeed*t*(n.top-n.bottom)/n.zoom/this._elementRect.height}}r?(n?this.setFocalOffset(this._focalOffsetEnd.x+i,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(i,0,!0),this.forward(-s,!0)):n?this.setFocalOffset(this._focalOffsetEnd.x+i,this._focalOffsetEnd.y+s,this._focalOffsetEnd.z,!0):this.truck(i,s,!0)},this._rotateInternal=(e,t)=>{const n=Oc*this.azimuthRotateSpeed*e/this._elementRect.height,r=Oc*this.polarRotateSpeed*t/this._elementRect.height;this.rotate(n,r,!0)},this._dollyInternal=(e,t,n)=>{const r=Math.pow(.95,-e*this.dollySpeed),i=this._sphericalEnd.radius,s=this._sphericalEnd.radius*r,a=Nc(s,this.minDistance,this.maxDistance),o=a-s;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(s,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(o,!0),this._dollyToNoClamp(a,!0)):this._dollyToNoClamp(a,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?s:a)-i,this._dollyControlCoord.set(t,n)),this._lastDollyDirection=Math.sign(-e)},this._zoomInternal=(e,t,n)=>{const r=Math.pow(.95,e*this.dollySpeed),i=this._zoom,s=this._zoom*r;this.zoomTo(s,!0),this.dollyToCursor&&(this._changedZoom+=s-i,this._dollyControlCoord.set(t,n))},void 0===eh&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=e,this._yAxisUpSpace=(new eh.Quaternion).setFromUnitVectors(this._camera.up,nh),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=Rc.NONE,this._target=new eh.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new eh.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=(new eh.Spherical).setFromVector3(sh.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new eh.Vector3,new eh.Vector3,new eh.Vector3,new eh.Vector3],this._updateNearPlaneCorners(),this._boundary=new eh.Box3(new eh.Vector3(-1/0,-1/0,-1/0),new eh.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new eh.Vector2,this.mouseButtons={left:Rc.ROTATE,middle:Rc.DOLLY,right:Rc.TRUCK,wheel:kc(this._camera)?Rc.DOLLY:Fc(this._camera)?Rc.ZOOM:Rc.NONE},this.touches={one:Rc.TOUCH_ROTATE,two:kc(this._camera)?Rc.TOUCH_DOLLY_TRUCK:Fc(this._camera)?Rc.TOUCH_ZOOM_TRUCK:Rc.NONE,three:Rc.TOUCH_TRUCK};const n=new eh.Vector2,r=new eh.Vector2,i=new eh.Vector2,s=e=>{if(!this._enabled||!this._domElement)return;if(0!==this._interactiveArea.left||0!==this._interactiveArea.top||1!==this._interactiveArea.width||1!==this._interactiveArea.height){const t=this._domElement.getBoundingClientRect(),n=e.clientX/t.width,r=e.clientY/t.height;if(n<this._interactiveArea.left||n>this._interactiveArea.right||r<this._interactiveArea.top||r>this._interactiveArea.bottom)return}const t="mouse"!==e.pointerType?null:(e.buttons&Tc)===Tc?Tc:(e.buttons&Mc)===Mc?Mc:(e.buttons&_c)===_c?_c:null;if(null!==t){const e=this._findPointerByMouseButton(t);e&&this._disposePointer(e)}if((e.buttons&Tc)===Tc&&this._lockedPointer)return;const n={pointerId:e.pointerId,clientX:e.clientX,clientY:e.clientY,deltaX:0,deltaY:0,mouseButton:t};this._activePointers.push(n),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",o),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",o),this._isDragging=!0,u(e)},a=e=>{e.cancelable&&e.preventDefault();const t=e.pointerId,n=this._lockedPointer||this._findPointerById(t);if(n){if(n.clientX=e.clientX,n.clientY=e.clientY,n.deltaX=e.movementX,n.deltaY=e.movementY,this._state=0,"touch"===e.pointerType)switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(e.buttons&Tc)===Tc)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(e.buttons&Mc)===Mc&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(e.buttons&_c)===_c&&(this._state=this._state|this.mouseButtons.right);d()}},o=e=>{const t=this._findPointerById(e.pointerId);if(!t||t!==this._lockedPointer){if(t&&this._disposePointer(t),"touch"===e.pointerType)switch(this._activePointers.length){case 0:this._state=Rc.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else this._state=Rc.NONE;f()}};let l=-1;const c=e=>{if(!this._domElement)return;if(!this._enabled||this.mouseButtons.wheel===Rc.NONE)return;if(0!==this._interactiveArea.left||0!==this._interactiveArea.top||1!==this._interactiveArea.width||1!==this._interactiveArea.height){const t=this._domElement.getBoundingClientRect(),n=e.clientX/t.width,r=e.clientY/t.height;if(n<this._interactiveArea.left||n>this._interactiveArea.right||r<this._interactiveArea.top||r>this._interactiveArea.bottom)return}if(e.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===Rc.ROTATE||this.mouseButtons.wheel===Rc.TRUCK){const e=performance.now();l-e<1e3&&this._getClientRect(this._elementRect),l=e}const t=Zc?-1:-3,n=1===e.deltaMode?e.deltaY/t:e.deltaY/(10*t),r=this.dollyToCursor?(e.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,i=this.dollyToCursor?(e.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case Rc.ROTATE:this._rotateInternal(e.deltaX,e.deltaY),this._isUserControllingRotate=!0;break;case Rc.TRUCK:this._truckInternal(e.deltaX,e.deltaY,!1,!1),this._isUserControllingTruck=!0;break;case Rc.SCREEN_PAN:this._truckInternal(e.deltaX,e.deltaY,!1,!0),this._isUserControllingTruck=!0;break;case Rc.OFFSET:this._truckInternal(e.deltaX,e.deltaY,!0,!1),this._isUserControllingOffset=!0;break;case Rc.DOLLY:this._dollyInternal(-n,r,i),this._isUserControllingDolly=!0;break;case Rc.ZOOM:this._zoomInternal(-n,r,i),this._isUserControllingZoom=!0}this.dispatchEvent({type:"control"})},h=e=>{if(this._domElement&&this._enabled){if(this.mouseButtons.right===wh.ACTION.NONE){const t=e instanceof PointerEvent?e.pointerId:0,n=this._findPointerById(t);return n&&this._disposePointer(n),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),void this._domElement.ownerDocument.removeEventListener("pointerup",o)}e.preventDefault()}},u=e=>{if(!this._enabled)return;Kc(this._activePointers,ih),this._getClientRect(this._elementRect),n.copy(ih),r.copy(ih);if(this._activePointers.length>=2){const e=ih.x-this._activePointers[1].clientX,t=ih.y-this._activePointers[1].clientY,n=Math.sqrt(e*e+t*t);i.set(0,n);const s=.5*(this._activePointers[0].clientX+this._activePointers[1].clientX),a=.5*(this._activePointers[0].clientY+this._activePointers[1].clientY);r.set(s,a)}if(this._state=0,e)if("pointerType"in e&&"touch"===e.pointerType)switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else this._lockedPointer||(e.buttons&Tc)!==Tc||(this._state=this._state|this.mouseButtons.left),(e.buttons&Mc)===Mc&&(this._state=this._state|this.mouseButtons.middle),(e.buttons&_c)===_c&&(this._state=this._state|this.mouseButtons.right);else this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);(this._state&Rc.ROTATE)!==Rc.ROTATE&&(this._state&Rc.TOUCH_ROTATE)!==Rc.TOUCH_ROTATE&&(this._state&Rc.TOUCH_DOLLY_ROTATE)!==Rc.TOUCH_DOLLY_ROTATE&&(this._state&Rc.TOUCH_ZOOM_ROTATE)!==Rc.TOUCH_ZOOM_ROTATE||(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),(this._state&Rc.TRUCK)!==Rc.TRUCK&&(this._state&Rc.SCREEN_PAN)!==Rc.SCREEN_PAN&&(this._state&Rc.TOUCH_TRUCK)!==Rc.TOUCH_TRUCK&&(this._state&Rc.TOUCH_SCREEN_PAN)!==Rc.TOUCH_SCREEN_PAN&&(this._state&Rc.TOUCH_DOLLY_TRUCK)!==Rc.TOUCH_DOLLY_TRUCK&&(this._state&Rc.TOUCH_DOLLY_SCREEN_PAN)!==Rc.TOUCH_DOLLY_SCREEN_PAN&&(this._state&Rc.TOUCH_ZOOM_TRUCK)!==Rc.TOUCH_ZOOM_TRUCK&&(this._state&Rc.TOUCH_ZOOM_SCREEN_PAN)!==Rc.TOUCH_DOLLY_SCREEN_PAN||(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),(this._state&Rc.DOLLY)!==Rc.DOLLY&&(this._state&Rc.TOUCH_DOLLY)!==Rc.TOUCH_DOLLY&&(this._state&Rc.TOUCH_DOLLY_TRUCK)!==Rc.TOUCH_DOLLY_TRUCK&&(this._state&Rc.TOUCH_DOLLY_SCREEN_PAN)!==Rc.TOUCH_DOLLY_SCREEN_PAN&&(this._state&Rc.TOUCH_DOLLY_OFFSET)!==Rc.TOUCH_DOLLY_OFFSET&&(this._state&Rc.TOUCH_DOLLY_ROTATE)!==Rc.TOUCH_DOLLY_ROTATE||(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),(this._state&Rc.ZOOM)!==Rc.ZOOM&&(this._state&Rc.TOUCH_ZOOM)!==Rc.TOUCH_ZOOM&&(this._state&Rc.TOUCH_ZOOM_TRUCK)!==Rc.TOUCH_ZOOM_TRUCK&&(this._state&Rc.TOUCH_ZOOM_SCREEN_PAN)!==Rc.TOUCH_ZOOM_SCREEN_PAN&&(this._state&Rc.TOUCH_ZOOM_OFFSET)!==Rc.TOUCH_ZOOM_OFFSET&&(this._state&Rc.TOUCH_ZOOM_ROTATE)!==Rc.TOUCH_ZOOM_ROTATE||(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),(this._state&Rc.OFFSET)!==Rc.OFFSET&&(this._state&Rc.TOUCH_OFFSET)!==Rc.TOUCH_OFFSET&&(this._state&Rc.TOUCH_DOLLY_OFFSET)!==Rc.TOUCH_DOLLY_OFFSET&&(this._state&Rc.TOUCH_ZOOM_OFFSET)!==Rc.TOUCH_ZOOM_OFFSET||(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},d=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,Kc(this._activePointers,ih);const e=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,t=e?-e.deltaX:r.x-ih.x,s=e?-e.deltaY:r.y-ih.y;if(r.copy(ih),(this._state&Rc.ROTATE)!==Rc.ROTATE&&(this._state&Rc.TOUCH_ROTATE)!==Rc.TOUCH_ROTATE&&(this._state&Rc.TOUCH_DOLLY_ROTATE)!==Rc.TOUCH_DOLLY_ROTATE&&(this._state&Rc.TOUCH_ZOOM_ROTATE)!==Rc.TOUCH_ZOOM_ROTATE||(this._rotateInternal(t,s),this._isUserControllingRotate=!0),(this._state&Rc.DOLLY)===Rc.DOLLY||(this._state&Rc.ZOOM)===Rc.ZOOM){const e=this.dollyToCursor?(n.x-this._elementRect.x)/this._elementRect.width*2-1:0,t=this.dollyToCursor?(n.y-this._elementRect.y)/this._elementRect.height*-2+1:0,r=this.dollyDragInverted?-1:1;(this._state&Rc.DOLLY)===Rc.DOLLY?(this._dollyInternal(r*s*$c,e,t),this._isUserControllingDolly=!0):(this._zoomInternal(r*s*$c,e,t),this._isUserControllingZoom=!0)}if((this._state&Rc.TOUCH_DOLLY)===Rc.TOUCH_DOLLY||(this._state&Rc.TOUCH_ZOOM)===Rc.TOUCH_ZOOM||(this._state&Rc.TOUCH_DOLLY_TRUCK)===Rc.TOUCH_DOLLY_TRUCK||(this._state&Rc.TOUCH_ZOOM_TRUCK)===Rc.TOUCH_ZOOM_TRUCK||(this._state&Rc.TOUCH_DOLLY_SCREEN_PAN)===Rc.TOUCH_DOLLY_SCREEN_PAN||(this._state&Rc.TOUCH_ZOOM_SCREEN_PAN)===Rc.TOUCH_ZOOM_SCREEN_PAN||(this._state&Rc.TOUCH_DOLLY_OFFSET)===Rc.TOUCH_DOLLY_OFFSET||(this._state&Rc.TOUCH_ZOOM_OFFSET)===Rc.TOUCH_ZOOM_OFFSET||(this._state&Rc.TOUCH_DOLLY_ROTATE)===Rc.TOUCH_DOLLY_ROTATE||(this._state&Rc.TOUCH_ZOOM_ROTATE)===Rc.TOUCH_ZOOM_ROTATE){const e=ih.x-this._activePointers[1].clientX,t=ih.y-this._activePointers[1].clientY,n=Math.sqrt(e*e+t*t),s=i.y-n;i.set(0,n);const a=this.dollyToCursor?(r.x-this._elementRect.x)/this._elementRect.width*2-1:0,o=this.dollyToCursor?(r.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&Rc.TOUCH_DOLLY)===Rc.TOUCH_DOLLY||(this._state&Rc.TOUCH_DOLLY_ROTATE)===Rc.TOUCH_DOLLY_ROTATE||(this._state&Rc.TOUCH_DOLLY_TRUCK)===Rc.TOUCH_DOLLY_TRUCK||(this._state&Rc.TOUCH_DOLLY_SCREEN_PAN)===Rc.TOUCH_DOLLY_SCREEN_PAN||(this._state&Rc.TOUCH_DOLLY_OFFSET)===Rc.TOUCH_DOLLY_OFFSET?(this._dollyInternal(s*$c,a,o),this._isUserControllingDolly=!0):(this._zoomInternal(s*$c,a,o),this._isUserControllingZoom=!0)}(this._state&Rc.TRUCK)!==Rc.TRUCK&&(this._state&Rc.TOUCH_TRUCK)!==Rc.TOUCH_TRUCK&&(this._state&Rc.TOUCH_DOLLY_TRUCK)!==Rc.TOUCH_DOLLY_TRUCK&&(this._state&Rc.TOUCH_ZOOM_TRUCK)!==Rc.TOUCH_ZOOM_TRUCK||(this._truckInternal(t,s,!1,!1),this._isUserControllingTruck=!0),(this._state&Rc.SCREEN_PAN)!==Rc.SCREEN_PAN&&(this._state&Rc.TOUCH_SCREEN_PAN)!==Rc.TOUCH_SCREEN_PAN&&(this._state&Rc.TOUCH_DOLLY_SCREEN_PAN)!==Rc.TOUCH_DOLLY_SCREEN_PAN&&(this._state&Rc.TOUCH_ZOOM_SCREEN_PAN)!==Rc.TOUCH_ZOOM_SCREEN_PAN||(this._truckInternal(t,s,!1,!0),this._isUserControllingTruck=!0),(this._state&Rc.OFFSET)!==Rc.OFFSET&&(this._state&Rc.TOUCH_OFFSET)!==Rc.TOUCH_OFFSET&&(this._state&Rc.TOUCH_DOLLY_OFFSET)!==Rc.TOUCH_DOLLY_OFFSET&&(this._state&Rc.TOUCH_ZOOM_OFFSET)!==Rc.TOUCH_ZOOM_OFFSET||(this._truckInternal(t,s,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},f=()=>{Kc(this._activePointers,ih),r.copy(ih),this._dragNeedsUpdate=!1,(0===this._activePointers.length||1===this._activePointers.length&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),0===this._activePointers.length&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",o),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{this._enabled&&this._domElement&&(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",o),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",A),this._domElement.ownerDocument.addEventListener("pointerlockerror",m),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",o),u())},this.unlockPointer=()=>{var e,t,n;null!==this._lockedPointer&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),null===(e=this._domElement)||void 0===e||e.ownerDocument.exitPointerLock(),null===(t=this._domElement)||void 0===t||t.ownerDocument.removeEventListener("pointerlockchange",A),null===(n=this._domElement)||void 0===n||n.ownerDocument.removeEventListener("pointerlockerror",m),this.cancel()};const A=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},m=()=>{this.unlockPointer()};this._addAllEventListeners=e=>{this._domElement=e,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",s),this._domElement.addEventListener("pointercancel",o),this._domElement.addEventListener("wheel",c,{passive:!1}),this._domElement.addEventListener("contextmenu",h)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",s),this._domElement.removeEventListener("pointercancel",o),this._domElement.removeEventListener("wheel",c,{passive:!1}),this._domElement.removeEventListener("contextmenu",h),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",o),this._domElement.ownerDocument.removeEventListener("pointerlockchange",A),this._domElement.ownerDocument.removeEventListener("pointerlockerror",m))},this.cancel=()=>{this._state!==Rc.NONE&&(this._state=Rc.NONE,this._activePointers.length=0,f())},t&&this.connect(t),this.update(0)}get camera(){return this._camera}set camera(e){this._camera=e,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._domElement&&(e?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(e){this._spherical.radius===e&&this._sphericalEnd.radius===e||(this._spherical.radius=e,this._sphericalEnd.radius=e,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(e){this._spherical.theta===e&&this._sphericalEnd.theta===e||(this._spherical.theta=e,this._sphericalEnd.theta=e,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(e){this._spherical.phi===e&&this._sphericalEnd.phi===e||(this._spherical.phi=e,this._sphericalEnd.phi=e,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(e){this._boundaryEnclosesCamera=e,this._needsUpdate=!0}set interactiveArea(e){this._interactiveArea.width=Nc(e.width,0,1),this._interactiveArea.height=Nc(e.height,0,1),this._interactiveArea.x=Nc(e.x,0,1-this._interactiveArea.width),this._interactiveArea.y=Nc(e.y,0,1-this._interactiveArea.height)}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}rotate(e,t,n=!1){return this.rotateTo(this._sphericalEnd.theta+e,this._sphericalEnd.phi+t,n)}rotateAzimuthTo(e,t=!1){return this.rotateTo(e,this._sphericalEnd.phi,t)}rotatePolarTo(e,t=!1){return this.rotateTo(this._sphericalEnd.theta,e,t)}rotateTo(e,t,n=!1){this._isUserControllingRotate=!1;const r=Nc(e,this.minAzimuthAngle,this.maxAzimuthAngle),i=Nc(t,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=r,this._sphericalEnd.phi=i,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,n||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const s=!n||Gc(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Gc(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(s)}dolly(e,t=!1){return this.dollyTo(this._sphericalEnd.radius-e,t)}dollyTo(e,t=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=Dc,this._changedDolly=0,this._dollyToNoClamp(Nc(e,this.minDistance,this.maxDistance),t)}_dollyToNoClamp(e,t=!1){const n=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const t=this._collisionTest(),r=Gc(t,this._spherical.radius);if(!(n>e)&&r)return Promise.resolve();this._sphericalEnd.radius=Math.min(e,t)}else this._sphericalEnd.radius=e;this._needsUpdate=!0,t||(this._spherical.radius=this._sphericalEnd.radius);const r=!t||Gc(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(r)}dollyInFixed(e,t=!1){this._targetEnd.add(this._getCameraDirection(lh).multiplyScalar(e)),t||this._target.copy(this._targetEnd);const n=!t||Gc(this._target.x,this._targetEnd.x,this.restThreshold)&&Gc(this._target.y,this._targetEnd.y,this.restThreshold)&&Gc(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}zoom(e,t=!1){return this.zoomTo(this._zoomEnd+e,t)}zoomTo(e,t=!1){this._isUserControllingZoom=!1,this._zoomEnd=Nc(e,this.minZoom,this.maxZoom),this._needsUpdate=!0,t||(this._zoom=this._zoomEnd);const n=!t||Gc(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(n)}pan(e,t,n=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(e,t,n)}truck(e,t,n=!1){this._camera.updateMatrix(),ch.setFromMatrixColumn(this._camera.matrix,0),hh.setFromMatrixColumn(this._camera.matrix,1),ch.multiplyScalar(e),hh.multiplyScalar(-t);const r=sh.copy(ch).add(hh),i=ah.copy(this._targetEnd).add(r);return this.moveTo(i.x,i.y,i.z,n)}forward(e,t=!1){sh.setFromMatrixColumn(this._camera.matrix,0),sh.crossVectors(this._camera.up,sh),sh.multiplyScalar(e);const n=ah.copy(this._targetEnd).add(sh);return this.moveTo(n.x,n.y,n.z,t)}elevate(e,t=!1){return sh.copy(this._camera.up).multiplyScalar(e),this.moveTo(this._targetEnd.x+sh.x,this._targetEnd.y+sh.y,this._targetEnd.z+sh.z,t)}moveTo(e,t,n,r=!1){this._isUserControllingTruck=!1;const i=sh.set(e,t,n).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,i,this.boundaryFriction),this._needsUpdate=!0,r||this._target.copy(this._targetEnd);const s=!r||Gc(this._target.x,this._targetEnd.x,this.restThreshold)&&Gc(this._target.y,this._targetEnd.y,this.restThreshold)&&Gc(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(s)}lookInDirectionOf(e,t,n,r=!1){const i=sh.set(e,t,n).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(i.x,i.y,i.z,r)}fitToBox(e,t,{cover:n=!1,paddingLeft:r=0,paddingRight:i=0,paddingBottom:s=0,paddingTop:a=0}={}){const o=[],l=e.isBox3?ph.copy(e):ph.setFromObject(e);l.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const c=Hc(this._sphericalEnd.theta,Uc),h=Hc(this._sphericalEnd.phi,Uc);o.push(this.rotateTo(c,h,t));const u=sh.setFromSpherical(this._sphericalEnd).normalize(),d=yh.setFromUnitVectors(u,rh),f=Gc(Math.abs(u.y),1);f&&d.multiply(Eh.setFromAxisAngle(nh,c)),d.multiply(this._yAxisUpSpaceInverse);const A=gh.makeEmpty();ah.copy(l.min).applyQuaternion(d),A.expandByPoint(ah),ah.copy(l.min).setX(l.max.x).applyQuaternion(d),A.expandByPoint(ah),ah.copy(l.min).setY(l.max.y).applyQuaternion(d),A.expandByPoint(ah),ah.copy(l.max).setZ(l.min.z).applyQuaternion(d),A.expandByPoint(ah),ah.copy(l.min).setZ(l.max.z).applyQuaternion(d),A.expandByPoint(ah),ah.copy(l.max).setY(l.min.y).applyQuaternion(d),A.expandByPoint(ah),ah.copy(l.max).setX(l.min.x).applyQuaternion(d),A.expandByPoint(ah),ah.copy(l.max).applyQuaternion(d),A.expandByPoint(ah),A.min.x-=r,A.min.y-=s,A.max.x+=i,A.max.y+=a,d.setFromUnitVectors(rh,u),f&&d.premultiply(Eh.invert()),d.premultiply(this._yAxisUpSpace);const m=A.getSize(sh),p=A.getCenter(ah).applyQuaternion(d);if(kc(this._camera)){const e=this.getDistanceToFitBox(m.x,m.y,m.z,n);o.push(this.moveTo(p.x,p.y,p.z,t)),o.push(this.dollyTo(e,t)),o.push(this.setFocalOffset(0,0,0,t))}else if(Fc(this._camera)){const e=this._camera,r=e.right-e.left,i=e.top-e.bottom,s=n?Math.max(r/m.x,i/m.y):Math.min(r/m.x,i/m.y);o.push(this.moveTo(p.x,p.y,p.z,t)),o.push(this.zoomTo(s,t)),o.push(this.setFocalOffset(0,0,0,t))}return Promise.all(o)}fitToSphere(e,t){const n=[],r="isObject3D"in e?wh.createBoundingSphere(e,vh):vh.copy(e);if(n.push(this.moveTo(r.center.x,r.center.y,r.center.z,t)),kc(this._camera)){const e=this.getDistanceToFitSphere(r.radius);n.push(this.dollyTo(e,t))}else if(Fc(this._camera)){const e=this._camera.right-this._camera.left,i=this._camera.top-this._camera.bottom,s=2*r.radius,a=Math.min(e/s,i/s);n.push(this.zoomTo(a,t))}return n.push(this.setFocalOffset(0,0,0,t)),Promise.all(n)}setLookAt(e,t,n,r,i,s,a=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Dc,this._changedDolly=0;const o=ah.set(r,i,s),l=sh.set(e,t,n);this._targetEnd.copy(o),this._sphericalEnd.setFromVector3(l.sub(o).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,a||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const c=!a||Gc(this._target.x,this._targetEnd.x,this.restThreshold)&&Gc(this._target.y,this._targetEnd.y,this.restThreshold)&&Gc(this._target.z,this._targetEnd.z,this.restThreshold)&&Gc(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Gc(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Gc(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(c)}lerpLookAt(e,t,n,r,i,s,a,o,l,c,h,u,d,f=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Dc,this._changedDolly=0;const A=sh.set(r,i,s),m=ah.set(e,t,n);Ah.setFromVector3(m.sub(A).applyQuaternion(this._yAxisUpSpace));const p=oh.set(c,h,u),g=ah.set(a,o,l);mh.setFromVector3(g.sub(p).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(A.lerp(p,d));const v=mh.theta-Ah.theta,y=mh.phi-Ah.phi,E=mh.radius-Ah.radius;this._sphericalEnd.set(Ah.radius+E*d,Ah.phi+y*d,Ah.theta+v*d),this.normalizeRotations(),this._needsUpdate=!0,f||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const x=!f||Gc(this._target.x,this._targetEnd.x,this.restThreshold)&&Gc(this._target.y,this._targetEnd.y,this.restThreshold)&&Gc(this._target.z,this._targetEnd.z,this.restThreshold)&&Gc(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Gc(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Gc(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(x)}setPosition(e,t,n,r=!1){return this.setLookAt(e,t,n,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,r)}setTarget(e,t,n,r=!1){const i=this.getPosition(sh),s=this.setLookAt(i.x,i.y,i.z,e,t,n,r);return this._sphericalEnd.phi=Nc(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),s}setFocalOffset(e,t,n,r=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(e,t,n),this._needsUpdate=!0,r||this._focalOffset.copy(this._focalOffsetEnd);const i=!r||Gc(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&Gc(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&Gc(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(i)}setOrbitPoint(e,t,n){this._camera.updateMatrixWorld(),ch.setFromMatrixColumn(this._camera.matrixWorldInverse,0),hh.setFromMatrixColumn(this._camera.matrixWorldInverse,1),uh.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const r=sh.set(e,t,n),i=r.distanceTo(this._camera.position),s=r.sub(this._camera.position);ch.multiplyScalar(s.x),hh.multiplyScalar(s.y),uh.multiplyScalar(s.z),sh.copy(ch).add(hh).add(uh),sh.z=sh.z+i,this.dollyTo(i,!1),this.setFocalOffset(-sh.x,sh.y,-sh.z,!1),this.moveTo(e,t,n,!1)}setBoundary(e){if(!e)return this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),void(this._needsUpdate=!0);this._boundary.copy(e),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(e,t,n,r){null!==e?(this._viewport=this._viewport||new eh.Vector4,"number"==typeof e?this._viewport.set(e,t,n,r):this._viewport.copy(e)):this._viewport=null}getDistanceToFitBox(e,t,n,r=!1){if(Wc(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const i=e/t,s=this._camera.getEffectiveFOV()*Qc,a=this._camera.aspect;return.5*((r?i>a:i<a)?t:e/a)/Math.tan(.5*s)+.5*n}getDistanceToFitSphere(e){if(Wc(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const t=this._camera.getEffectiveFOV()*Qc,n=2*Math.atan(Math.tan(.5*t)*this._camera.aspect),r=1<this._camera.aspect?t:n;return e/Math.sin(.5*r)}getTarget(e,t=!0){return(e&&e.isVector3?e:new eh.Vector3).copy(t?this._targetEnd:this._target)}getPosition(e,t=!0){return(e&&e.isVector3?e:new eh.Vector3).setFromSpherical(t?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(t?this._targetEnd:this._target)}getSpherical(e,t=!0){return(e||new eh.Spherical).copy(t?this._sphericalEnd:this._spherical)}getFocalOffset(e,t=!0){return(e&&e.isVector3?e:new eh.Vector3).copy(t?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%Oc,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=Oc),this._spherical.theta+=Oc*Math.round((this._sphericalEnd.theta-this._spherical.theta)/Oc)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(e=!1){if(!Gc(this._camera.up.x,this._cameraUp0.x)||!Gc(this._camera.up.y,this._cameraUp0.y)||!Gc(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const e=this.getPosition(sh);this.updateCameraUp(),this.setPosition(e.x,e.y,e.z)}const t=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,e),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,e),this.zoomTo(this._zoom0,e)];return Promise.all(t)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,nh),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const e=sh.subVectors(this._target,this._camera.position).normalize(),t=ah.crossVectors(e,this._camera.up);this._camera.up.crossVectors(t,e).normalize(),this._camera.updateMatrixWorld();const n=this.getPosition(sh);this.updateCameraUp(),this.setPosition(n.x,n.y,n.z)}update(e){const t=this._sphericalEnd.theta-this._spherical.theta,n=this._sphericalEnd.phi-this._spherical.phi,r=this._sphericalEnd.radius-this._spherical.radius,i=dh.subVectors(this._targetEnd,this._target),s=fh.subVectors(this._focalOffsetEnd,this._focalOffset),a=this._zoomEnd-this._zoom;if(zc(t))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const t=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=jc(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,t,1/0,e),this._needsUpdate=!0}if(zc(n))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const t=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=jc(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,t,1/0,e),this._needsUpdate=!0}if(zc(r))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const t=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=jc(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,t,this.maxSpeed,e),this._needsUpdate=!0}if(zc(i.x)&&zc(i.y)&&zc(i.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const t=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;Vc(this._target,this._targetEnd,this._targetVelocity,t,this.maxSpeed,e,this._target),this._needsUpdate=!0}if(zc(s.x)&&zc(s.y)&&zc(s.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const t=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;Vc(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,t,this.maxSpeed,e,this._focalOffset),this._needsUpdate=!0}if(zc(a))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const t=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=jc(this._zoom,this._zoomEnd,this._zoomVelocity,t,1/0,e)}if(this.dollyToCursor)if(kc(this._camera)&&0!==this._changedDolly){const e=this._spherical.radius-this._lastDistance,t=this._camera,n=this._getCameraDirection(lh),r=sh.copy(n).cross(t.up).normalize();0===r.lengthSq()&&(r.x=1);const i=ah.crossVectors(r,n),s=this._sphericalEnd.radius*Math.tan(t.getEffectiveFOV()*Qc*.5),a=(this._sphericalEnd.radius-e-this._sphericalEnd.radius)/this._sphericalEnd.radius,o=oh.copy(this._targetEnd).add(r.multiplyScalar(this._dollyControlCoord.x*s*t.aspect)).add(i.multiplyScalar(this._dollyControlCoord.y*s)),l=sh.copy(this._targetEnd).lerp(o,a),c=this._lastDollyDirection===Pc&&this._spherical.radius<=this.minDistance,h=this._lastDollyDirection===Lc&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(c||h)){this._sphericalEnd.radius-=e,this._spherical.radius-=e;const t=ah.copy(n).multiplyScalar(-e);l.add(t)}this._boundary.clampPoint(l,l);const u=ah.subVectors(l,this._targetEnd);this._targetEnd.copy(l),this._target.add(u),this._changedDolly-=e,zc(this._changedDolly)&&(this._changedDolly=0)}else if(Fc(this._camera)&&0!==this._changedZoom){const e=this._zoom-this._lastZoom,t=this._camera,n=sh.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(t.near+t.far)/(t.near-t.far)).unproject(t),r=ah.set(0,0,-1).applyQuaternion(t.quaternion),i=oh.copy(n).add(r.multiplyScalar(-n.dot(t.up))),s=-(this._zoom-e-this._zoom)/this._zoom,a=this._getCameraDirection(lh),o=this._targetEnd.dot(a),l=sh.copy(this._targetEnd).lerp(i,s),c=l.dot(a),h=a.multiplyScalar(c-o);l.sub(h),this._boundary.clampPoint(l,l);const u=ah.subVectors(l,this._targetEnd);this._targetEnd.copy(l),this._target.add(u),this._changedZoom-=e,zc(this._changedZoom)&&(this._changedZoom=0)}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const o=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,o),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target);(!zc(this._focalOffset.x)||!zc(this._focalOffset.y)||!zc(this._focalOffset.z))&&(ch.setFromMatrixColumn(this._camera.matrix,0),hh.setFromMatrixColumn(this._camera.matrix,1),uh.setFromMatrixColumn(this._camera.matrix,2),ch.multiplyScalar(this._focalOffset.x),hh.multiplyScalar(-this._focalOffset.y),uh.multiplyScalar(this._focalOffset.z),sh.copy(ch).add(hh).add(uh),this._camera.position.add(sh),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),sh.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const l=this._needsUpdate;return l&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):l?(this.dispatchEvent({type:"update"}),zc(t,this.restThreshold)&&zc(n,this.restThreshold)&&zc(r,this.restThreshold)&&zc(i.x,this.restThreshold)&&zc(i.y,this.restThreshold)&&zc(i.z,this.restThreshold)&&zc(s.x,this.restThreshold)&&zc(s.y,this.restThreshold)&&zc(s.z,this.restThreshold)&&zc(a,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!l&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=l,this._needsUpdate=!1,l}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:qc(this.maxDistance),minZoom:this.minZoom,maxZoom:qc(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:qc(this.maxPolarAngle),minAzimuthAngle:qc(this.minAzimuthAngle),maxAzimuthAngle:qc(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:sh.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(e,t=!1){const n=JSON.parse(e);this.enabled=n.enabled,this.minDistance=n.minDistance,this.maxDistance=Yc(n.maxDistance),this.minZoom=n.minZoom,this.maxZoom=Yc(n.maxZoom),this.minPolarAngle=n.minPolarAngle,this.maxPolarAngle=Yc(n.maxPolarAngle),this.minAzimuthAngle=Yc(n.minAzimuthAngle),this.maxAzimuthAngle=Yc(n.maxAzimuthAngle),this.smoothTime=n.smoothTime,this.draggingSmoothTime=n.draggingSmoothTime,this.dollySpeed=n.dollySpeed,this.truckSpeed=n.truckSpeed,this.dollyToCursor=n.dollyToCursor,this._target0.fromArray(n.target0),this._position0.fromArray(n.position0),this._zoom0=n.zoom0,this._focalOffset0.fromArray(n.focalOffset0),this.moveTo(n.target[0],n.target[1],n.target[2],t),Ah.setFromVector3(sh.fromArray(n.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(Ah.theta,Ah.phi,t),this.dollyTo(Ah.radius,t),this.zoomTo(n.zoom,t),this.setFocalOffset(n.focalOffset[0],n.focalOffset[1],n.focalOffset[2],t),this._needsUpdate=!0}connect(e){this._domElement?console.warn("camera-controls is already connected."):(e.setAttribute("data-camera-controls-version","2.10.0"),this._addAllEventListeners(e),this._getClientRect(this._elementRect))}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(e){return e.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(e){return this._getTargetDirection(e).negate()}_findPointerById(e){return this._activePointers.find((t=>t.pointerId===e))}_findPointerByMouseButton(e){return this._activePointers.find((t=>t.mouseButton===e))}_disposePointer(e){this._activePointers.splice(this._activePointers.indexOf(e),1)}_encloseToBoundary(e,t,n){const r=t.lengthSq();if(0===r)return e;const i=ah.copy(t).add(e),s=this._boundary.clampPoint(i,oh).sub(i),a=s.lengthSq();if(0===a)return e.add(t);if(a===r)return e;if(0===n)return e.add(t).add(s);{const r=1+n*a/t.dot(s);return e.add(ah.copy(t).multiplyScalar(r)).add(s.multiplyScalar(1-n))}}_updateNearPlaneCorners(){if(kc(this._camera)){const e=this._camera,t=e.near,n=e.getEffectiveFOV()*Qc,r=Math.tan(.5*n)*t,i=r*e.aspect;this._nearPlaneCorners[0].set(-i,-r,0),this._nearPlaneCorners[1].set(i,-r,0),this._nearPlaneCorners[2].set(i,r,0),this._nearPlaneCorners[3].set(-i,r,0)}else if(Fc(this._camera)){const e=this._camera,t=1/e.zoom,n=e.left*t,r=e.right*t,i=e.top*t,s=e.bottom*t;this._nearPlaneCorners[0].set(n,i,0),this._nearPlaneCorners[1].set(r,i,0),this._nearPlaneCorners[2].set(r,s,0),this._nearPlaneCorners[3].set(n,s,0)}}_collisionTest(){let e=1/0;if(!(this.colliderMeshes.length>=1))return e;if(Wc(this._camera,"_collisionTest"))return e;const t=this._getTargetDirection(lh);xh.lookAt(th,t,this._camera.up);for(let n=0;n<4;n++){const r=ah.copy(this._nearPlaneCorners[n]);r.applyMatrix4(xh);const i=oh.addVectors(this._target,r);Ch.set(i,t),Ch.far=this._spherical.radius+1;const s=Ch.intersectObjects(this.colliderMeshes);0!==s.length&&s[0].distance<e&&(e=s[0].distance)}return e}_getClientRect(e){if(!this._domElement)return;const t=this._domElement.getBoundingClientRect();return e.x=t.left,e.y=t.top,this._viewport?(e.x+=this._viewport.x,e.y+=t.height-this._viewport.w-this._viewport.y,e.width=this._viewport.z,e.height=this._viewport.w):(e.width=t.width,e.height=t.height),e}_createOnRestPromise(e){return e?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise((e=>{const t=()=>{this.removeEventListener("rest",t),e()};this.addEventListener("rest",t)})))}_addAllEventListeners(e){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(e){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(e){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(e,t=new eh.Sphere){const n=t,r=n.center;ph.makeEmpty(),e.traverseVisible((e=>{e.isMesh&&ph.expandByObject(e)})),ph.getCenter(r);let i=0;return e.traverseVisible((e=>{if(!e.isMesh)return;const t=e;if(!t.geometry)return;const n=t.geometry.clone();n.applyMatrix4(t.matrixWorld);const s=n.attributes.position;for(let a=0,o=s.count;a<o;a++)sh.fromBufferAttribute(s,a),i=Math.max(i,r.distanceToSquared(sh))})),n.radius=Math.sqrt(i),n}}const Ih=(0,i.forwardRef)(((e,t)=>{(0,i.useMemo)((()=>{const e={Box3:a.NRn,MathUtils:{clamp:a.cj9.clamp},Matrix4:a.kn4,Quaternion:a.PTz,Raycaster:a.tBo,Sphere:a.iyt,Spherical:a.YHV,Vector2:a.I9Y,Vector3:a.Pq0,Vector4:a.IUQ};wh.install({THREE:e}),(0,o.e)({CameraControlsImpl:wh})}),[]);const{camera:n,domElement:s,makeDefault:l,onStart:c,onEnd:h,onChange:u,regress:d,...f}=e,A=(0,o.A)((e=>e.camera)),m=(0,o.A)((e=>e.gl)),p=(0,o.A)((e=>e.invalidate)),g=(0,o.A)((e=>e.events)),v=(0,o.A)((e=>e.setEvents)),y=(0,o.A)((e=>e.set)),E=(0,o.A)((e=>e.get)),x=(0,o.A)((e=>e.performance)),C=n||A,w=s||g.connected||m.domElement,I=(0,i.useMemo)((()=>new wh(C)),[C]);return(0,o.C)(((e,t)=>{I.enabled&&I.update(t)}),-1),(0,i.useEffect)((()=>(I.connect(w),()=>{I.disconnect()})),[w,I]),(0,i.useEffect)((()=>{const e=e=>{p(),d&&x.regress(),u&&u(e)},t=e=>{c&&c(e)},n=e=>{h&&h(e)};return I.addEventListener("update",e),I.addEventListener("controlstart",t),I.addEventListener("controlend",n),I.addEventListener("control",e),I.addEventListener("transitionstart",e),I.addEventListener("wake",e),()=>{I.removeEventListener("update",e),I.removeEventListener("controlstart",t),I.removeEventListener("controlend",n),I.removeEventListener("control",e),I.removeEventListener("transitionstart",e),I.removeEventListener("wake",e)}}),[I,c,h,p,v,d,u]),(0,i.useEffect)((()=>{if(l){const e=E().controls;return y({controls:I}),()=>y({controls:e})}}),[l,I]),i.createElement("primitive",(0,r.A)({ref:t,object:I},f))})),bh=i.createContext(null);function Sh(){const e=i.useContext(bh);if(!e)throw new Error("useMotion hook must be used in a MotionPathControls component.");return e}function Bh({points:e=50,color:t="black"}){const{path:n}=Sh(),[r,s]=i.useState([]),o=i.useMemo((()=>new a.V9B({color:t})),[t]),l=i.useMemo((()=>new a.Gu$(.025,16,16)),[]),c=i.useRef([]);return i.useEffect((()=>{n.curves!==c.current&&(s(n.getPoints(e)),c.current=n.curves)})),r.map(((e,t)=>i.createElement("mesh",{key:t,material:o,geometry:l,position:[e.x,e.y,e.z]})))}const Th=i.forwardRef((({children:e,curves:t=[],debug:n=!1,debugColor:s="black",object:l,focus:c,loop:h=!0,offset:u,smooth:d=!1,eps:f=1e-5,damping:A=.1,focusDamping:m=.1,maxSpeed:p=1/0,...g},v)=>{const{camera:y}=(0,o.A)(),E=i.useRef(null),x=i.useRef(null!=u?u:0),C=i.useMemo((()=>new a.jGm),[]),w=i.useMemo((()=>({focus:c,object:(null==l?void 0:l.current)instanceof a.B69?l:{current:y},path:C,current:x.current,offset:x.current,point:new a.Pq0,tangent:new a.Pq0,next:new a.Pq0})),[c,l]),I=(0,o.y)(E);i.useLayoutEffect((()=>{const e=I.current;C.curves=[];const n=t.length>0?t:e.children.map((e=>e.object));for(let t=0;t<n.length;t++)C.add(n[t]);if(d){const e=C.getPoints("number"==typeof d?d:1),t=new a.B6O(e);C.curves=[t]}C.updateArcLengths()})),i.useImperativeHandle(v,(()=>Object.assign(E.current,{motion:w})),[w]),i.useLayoutEffect((()=>{x.current=yt.repeat(x.current,1)}),[u]);const b=i.useMemo((()=>new a.Pq0),[]);return(0,o.C)(((e,t)=>{const n=w.offset;if(Mn.damp(x,"current",void 0!==u?u:w.current,A,t,p,void 0,f),w.offset=h?yt.repeat(x.current,1):yt.clamp(x.current,0,1),C.getCurveLengths().length>0){C.getPointAt(w.offset,w.point),C.getTangentAt(w.offset,w.tangent).normalize(),C.getPointAt(yt.repeat(x.current-(n-w.offset),1),w.next);const e=(null==l?void 0:l.current)instanceof a.B69?l.current:y;e.position.copy(w.point),c&&Mn.dampLookAt(e,(e=>(null==e?void 0:e.current)instanceof a.B69)(c)?c.current.getWorldPosition(b):c,m,t,p,void 0,f)}})),i.createElement("group",(0,r.A)({ref:E},g),i.createElement(bh.Provider,{value:w},e,n&&i.createElement(Bh,{color:s})))}));function _h({defaultScene:e,defaultCamera:t,renderPriority:n=1}){const{gl:r,scene:s,camera:a}=(0,o.A)();let l;return(0,o.C)((()=>{l=r.autoClear,1===n&&(r.autoClear=!0,r.render(e,t)),r.autoClear=!1,r.clearDepth(),r.render(s,a),r.autoClear=l}),n),i.createElement("group",{onPointerOver:()=>null})}function Mh({children:e,renderPriority:t=1}){const{scene:n,camera:r}=(0,o.A)(),[s]=i.useState((()=>new a.Z58));return i.createElement(i.Fragment,null,(0,o.o)(i.createElement(i.Fragment,null,e,i.createElement(_h,{defaultScene:n,defaultCamera:r,renderPriority:t})),s,{events:{priority:t+1}}))}const Rh=i.createContext({}),Dh=()=>i.useContext(Rh),Ph=2*Math.PI,Lh=new a.B69,kh=new a.kn4,[Fh,Oh]=[new a.PTz,new a.PTz],Uh=new a.Pq0,Qh=new a.Pq0,Nh=e=>"getTarget"in e,zh=({alignment:e="bottom-right",margin:t=[80,80],renderPriority:n=1,onUpdate:r,onTarget:s,children:l})=>{const c=(0,o.A)((e=>e.size)),h=(0,o.A)((e=>e.camera)),u=(0,o.A)((e=>e.controls)),d=(0,o.A)((e=>e.invalidate)),f=i.useRef(null),A=i.useRef(null),m=i.useRef(!1),p=i.useRef(0),g=i.useRef(new a.Pq0(0,0,0)),v=i.useRef(new a.Pq0(0,0,0));i.useEffect((()=>{v.current.copy(h.up),Lh.up.copy(h.up)}),[h]);const y=i.useCallback((e=>{m.current=!0,(u||s)&&(g.current=(null==s?void 0:s())||(Nh(u)?u.getTarget(g.current):null==u?void 0:u.target)),p.current=h.position.distanceTo(Uh),Fh.copy(h.quaternion),Qh.copy(e).multiplyScalar(p.current).add(Uh),Lh.lookAt(Qh),Oh.copy(Lh.quaternion),d()}),[u,h,s,d]);(0,o.C)(((e,t)=>{if(A.current&&f.current){var n;if(m.current)if(Fh.angleTo(Oh)<.01)m.current=!1,"minPolarAngle"in u&&h.up.copy(v.current);else{const e=t*Ph;Fh.rotateTowards(Oh,e),h.position.set(0,0,1).applyQuaternion(Fh).multiplyScalar(p.current).add(g.current),h.up.set(0,1,0).applyQuaternion(Fh).normalize(),h.quaternion.copy(Fh),Nh(u)&&u.setPosition(h.position.x,h.position.y,h.position.z),r?r():u&&u.update(t),d()}kh.copy(h.matrix).invert(),null==(n=f.current)||n.quaternion.setFromRotationMatrix(kh)}}));const E=i.useMemo((()=>({tweenCamera:y})),[y]),[x,C]=t,w=e.endsWith("-center")?0:e.endsWith("-left")?-c.width/2+x:c.width/2-x,I=e.startsWith("center-")?0:e.startsWith("top-")?c.height/2-C:-c.height/2+C;return i.createElement(Mh,{renderPriority:n},i.createElement(Rh.Provider,{value:E},i.createElement(El,{makeDefault:!0,ref:A,position:[0,0,200]}),i.createElement("group",{ref:f,position:[w,I,0]},l)))},Gh="#f0f0f0",Hh="#999",qh="black",Yh="black",jh=["Right","Left","Top","Bottom","Front","Back"],Vh=e=>new a.Pq0(...e).multiplyScalar(.38),Kh=[[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]].map(Vh),Wh=[.25,.25,.25],Jh=[[1,1,0],[1,0,1],[1,0,-1],[1,-1,0],[0,1,1],[0,1,-1],[0,-1,1],[0,-1,-1],[-1,1,0],[-1,0,1],[-1,0,-1],[-1,-1,0]].map(Vh),Xh=Jh.map((e=>e.toArray().map((e=>0==e?.5:.25)))),$h=({hover:e,index:t,font:n="20px Inter var, Arial, sans-serif",faces:r=jh,color:s=Gh,hoverColor:l=Hh,textColor:c=qh,strokeColor:h=Yh,opacity:u=1})=>{const d=(0,o.A)((e=>e.gl)),f=i.useMemo((()=>{const e=document.createElement("canvas");e.width=128,e.height=128;const i=e.getContext("2d");return i.fillStyle=s,i.fillRect(0,0,e.width,e.height),i.strokeStyle=h,i.strokeRect(0,0,e.width,e.height),i.font=n,i.textAlign="center",i.fillStyle=c,i.fillText(r[t].toUpperCase(),64,76),new a.GOR(e)}),[t,r,n,s,c,h]);return i.createElement("meshBasicMaterial",{map:f,"map-anisotropy":d.capabilities.getMaxAnisotropy()||1,attach:`material-${t}`,color:e?l:"white",transparent:!0,opacity:u})},Zh=e=>{const{tweenCamera:t}=Dh(),[n,s]=i.useState(null);return i.createElement("mesh",{onPointerOut:e=>{e.stopPropagation(),s(null)},onPointerMove:e=>{e.stopPropagation(),s(Math.floor(e.faceIndex/2))},onClick:e.onClick||(e=>{e.stopPropagation(),t(e.face.normal)})},[...Array(6)].map(((t,s)=>i.createElement($h,(0,r.A)({key:s,index:s,hover:n===s},e)))),i.createElement("boxGeometry",null))},eu=({onClick:e,dimensions:t,position:n,hoverColor:r=Hh})=>{const{tweenCamera:s}=Dh(),[a,o]=i.useState(!1);return i.createElement("mesh",{scale:1.01,position:n,onPointerOver:e=>{e.stopPropagation(),o(!0)},onPointerOut:e=>{e.stopPropagation(),o(!1)},onClick:e||(e=>{e.stopPropagation(),s(n)})},i.createElement("meshBasicMaterial",{color:a?r:"white",transparent:!0,opacity:.6,visible:a}),i.createElement("boxGeometry",{args:t}))},tu=e=>i.createElement("group",{scale:[60,60,60]},i.createElement(Zh,e),Jh.map(((t,n)=>i.createElement(eu,(0,r.A)({key:n,position:t,dimensions:Xh[n]},e)))),Kh.map(((t,n)=>i.createElement(eu,(0,r.A)({key:n,position:t,dimensions:Wh},e)))));function nu({scale:e=[.8,.05,.05],color:t,rotation:n}){return i.createElement("group",{rotation:n},i.createElement("mesh",{position:[.4,0,0]},i.createElement("boxGeometry",{args:e}),i.createElement("meshBasicMaterial",{color:t,toneMapped:!1})))}function ru({onClick:e,font:t,disabled:n,arcStyle:s,label:l,labelColor:c,axisHeadScale:h=1,...u}){const d=(0,o.A)((e=>e.gl)),f=i.useMemo((()=>{const e=document.createElement("canvas");e.width=64,e.height=64;const n=e.getContext("2d");return n.beginPath(),n.arc(32,32,16,0,2*Math.PI),n.closePath(),n.fillStyle=s,n.fill(),l&&(n.font=t,n.textAlign="center",n.fillStyle=c,n.fillText(l,32,41)),new a.GOR(e)}),[s,l,c,t]),[A,m]=i.useState(!1),p=(l?1:.75)*(A?1.2:1)*h;return i.createElement("sprite",(0,r.A)({scale:p,onPointerOver:n?void 0:e=>{e.stopPropagation(),m(!0)},onPointerOut:n?void 0:e||(e=>{e.stopPropagation(),m(!1)})},u),i.createElement("spriteMaterial",{map:f,"map-anisotropy":d.capabilities.getMaxAnisotropy()||1,alphaTest:.3,opacity:l?1:.75,toneMapped:!1}))}const iu=({hideNegativeAxes:e,hideAxisHeads:t,disabled:n,font:s="18px Inter var, Arial, sans-serif",axisColors:a=["#ff2060","#20df80","#2080ff"],axisHeadScale:o=1,axisScale:l,labels:c=["X","Y","Z"],labelColor:h="#000",onClick:u,...d})=>{const[f,A,m]=a,{tweenCamera:p}=Dh(),g={font:s,disabled:n,labelColor:h,onClick:u,axisHeadScale:o,onPointerDown:n?void 0:e=>{p(e.object.position),e.stopPropagation()}};return i.createElement("group",(0,r.A)({scale:40},d),i.createElement(nu,{color:f,rotation:[0,0,0],scale:l}),i.createElement(nu,{color:A,rotation:[0,0,Math.PI/2],scale:l}),i.createElement(nu,{color:m,rotation:[0,-Math.PI/2,0],scale:l}),!t&&i.createElement(i.Fragment,null,i.createElement(ru,(0,r.A)({arcStyle:f,position:[1,0,0],label:c[0]},g)),i.createElement(ru,(0,r.A)({arcStyle:A,position:[0,1,0],label:c[1]},g)),i.createElement(ru,(0,r.A)({arcStyle:m,position:[0,0,1],label:c[2]},g)),!e&&i.createElement(i.Fragment,null,i.createElement(ru,(0,r.A)({arcStyle:f,position:[-1,0,0]},g)),i.createElement(ru,(0,r.A)({arcStyle:A,position:[0,-1,0]},g)),i.createElement(ru,(0,r.A)({arcStyle:m,position:[0,0,-1]},g)))))},su=aa({cellSize:.5,sectionSize:1,fadeDistance:100,fadeStrength:1,fadeFrom:1,cellThickness:.5,sectionThickness:1,cellColor:new a.Q1f,sectionColor:new a.Q1f,infiniteGrid:!1,followCamera:!1,worldCamProjPosition:new a.Pq0,worldPlanePosition:new a.Pq0},"\n    varying vec3 localPosition;\n    varying vec4 worldPosition;\n\n    uniform vec3 worldCamProjPosition;\n    uniform vec3 worldPlanePosition;\n    uniform float fadeDistance;\n    uniform bool infiniteGrid;\n    uniform bool followCamera;\n\n    void main() {\n      localPosition = position.xzy;\n      if (infiniteGrid) localPosition *= 1.0 + fadeDistance;\n      \n      worldPosition = modelMatrix * vec4(localPosition, 1.0);\n      if (followCamera) {\n        worldPosition.xyz += (worldCamProjPosition - worldPlanePosition);\n        localPosition = (inverse(modelMatrix) * worldPosition).xyz;\n      }\n\n      gl_Position = projectionMatrix * viewMatrix * worldPosition;\n    }\n  ",`\n    varying vec3 localPosition;\n    varying vec4 worldPosition;\n\n    uniform vec3 worldCamProjPosition;\n    uniform float cellSize;\n    uniform float sectionSize;\n    uniform vec3 cellColor;\n    uniform vec3 sectionColor;\n    uniform float fadeDistance;\n    uniform float fadeStrength;\n    uniform float fadeFrom;\n    uniform float cellThickness;\n    uniform float sectionThickness;\n\n    float getGrid(float size, float thickness) {\n      vec2 r = localPosition.xz / size;\n      vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);\n      float line = min(grid.x, grid.y) + 1.0 - thickness;\n      return 1.0 - min(line, 1.0);\n    }\n\n    void main() {\n      float g1 = getGrid(cellSize, cellThickness);\n      float g2 = getGrid(sectionSize, sectionThickness);\n\n      vec3 from = worldCamProjPosition*vec3(fadeFrom);\n      float dist = distance(from, worldPosition.xyz);\n      float d = 1.0 - min(dist / fadeDistance, 1.0);\n      vec3 color = mix(cellColor, sectionColor, min(1.0, sectionThickness * g2));\n\n      gl_FragColor = vec4(color, (g1 + g2) * pow(d, fadeStrength));\n      gl_FragColor.a = mix(0.75 * gl_FragColor.a, gl_FragColor.a, g2);\n      if (gl_FragColor.a <= 0.0) discard;\n\n      #include <tonemapping_fragment>\n      #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n    }\n  `),au=i.forwardRef((({args:e,cellColor:t="#000000",sectionColor:n="#2080ff",cellSize:s=.5,sectionSize:l=1,followCamera:c=!1,infiniteGrid:h=!1,fadeDistance:u=100,fadeStrength:d=1,fadeFrom:f=1,cellThickness:A=.5,sectionThickness:m=1,side:p=a.hsX,...g},v)=>{(0,o.e)({GridMaterial:su});const y=i.useRef(null);i.useImperativeHandle(v,(()=>y.current),[]);const E=new a.Zcv,x=new a.Pq0(0,1,0),C=new a.Pq0(0,0,0);(0,o.C)((e=>{E.setFromNormalAndCoplanarPoint(x,C).applyMatrix4(y.current.matrixWorld);const t=y.current.material,n=t.uniforms.worldCamProjPosition,r=t.uniforms.worldPlanePosition;E.projectPoint(e.camera.position,n.value),r.value.set(0,0,0).applyMatrix4(y.current.matrixWorld)}));const w={cellSize:s,sectionSize:l,cellColor:t,sectionColor:n,cellThickness:A,sectionThickness:m},I={fadeDistance:u,fadeStrength:d,fadeFrom:f,infiniteGrid:h,followCamera:c};return i.createElement("mesh",(0,r.A)({ref:y,frustumCulled:!1},g),i.createElement("gridMaterial",(0,r.A)({transparent:!0,"extensions-derivatives":!0,side:p},w,I)),i.createElement("planeGeometry",{args:e}))}));function ou(e,{path:t}){const[n]=(0,o.F)(a.ScU,[e],(e=>e.setPath(t)));return n}function lu({children:e,files:t,...n}){const r=ou(t,{...n});return i.createElement(i.Fragment,null,null==e?void 0:e(r))}ou.preload=(e,{path:t})=>o.F.preload(a.ScU,[e],(e=>e.setPath(t)));var cu=Uint8Array,hu=Uint16Array,uu=Uint32Array,du=new cu([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),fu=new cu([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Au=new cu([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),mu=function(e,t){for(var n=new hu(31),r=0;r<31;++r)n[r]=t+=1<<e[r-1];var i=new uu(n[30]);for(r=1;r<30;++r)for(var s=n[r];s<n[r+1];++s)i[s]=s-n[r]<<5|r;return[n,i]},pu=mu(du,2),gu=pu[0],vu=pu[1];gu[28]=258,vu[258]=28;for(var yu=mu(fu,0),Eu=yu[0],xu=(yu[1],new hu(32768)),Cu=0;Cu<32768;++Cu){var wu=(43690&Cu)>>>1|(21845&Cu)<<1;wu=(61680&(wu=(52428&wu)>>>2|(13107&wu)<<2))>>>4|(3855&wu)<<4,xu[Cu]=((65280&wu)>>>8|(255&wu)<<8)>>>1}var Iu=function(e,t,n){for(var r=e.length,i=0,s=new hu(t);i<r;++i)++s[e[i]-1];var a,o=new hu(t);for(i=0;i<t;++i)o[i]=o[i-1]+s[i-1]<<1;if(n){a=new hu(1<<t);var l=15-t;for(i=0;i<r;++i)if(e[i])for(var c=i<<4|e[i],h=t-e[i],u=o[e[i]-1]++<<h,d=u|(1<<h)-1;u<=d;++u)a[xu[u]>>>l]=c}else for(a=new hu(r),i=0;i<r;++i)e[i]&&(a[i]=xu[o[e[i]-1]++]>>>15-e[i]);return a},bu=new cu(288);for(Cu=0;Cu<144;++Cu)bu[Cu]=8;for(Cu=144;Cu<256;++Cu)bu[Cu]=9;for(Cu=256;Cu<280;++Cu)bu[Cu]=7;for(Cu=280;Cu<288;++Cu)bu[Cu]=8;var Su=new cu(32);for(Cu=0;Cu<32;++Cu)Su[Cu]=5;var Bu=Iu(bu,9,1),Tu=Iu(Su,5,1),_u=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},Mu=function(e,t,n){var r=t/8|0;return(e[r]|e[r+1]<<8)>>(7&t)&n},Ru=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},Du=function(e){return(e/8|0)+(7&e&&1)},Pu=function(e,t,n){(null==t||t<0)&&(t=0),(null==n||n>e.length)&&(n=e.length);var r=new(e instanceof hu?hu:e instanceof uu?uu:cu)(n-t);return r.set(e.subarray(t,n)),r},Lu=function(e,t,n){var r=e.length;if(!r||n&&!n.l&&r<5)return t||new cu(0);var i=!t||n,s=!n||n.i;n||(n={}),t||(t=new cu(3*r));var a=function(e){var n=t.length;if(e>n){var r=new cu(Math.max(2*n,e));r.set(t),t=r}},o=n.f||0,l=n.p||0,c=n.b||0,h=n.l,u=n.d,d=n.m,f=n.n,A=8*r;do{if(!h){n.f=o=Mu(e,l,1);var m=Mu(e,l+1,3);if(l+=3,!m){var p=e[(B=Du(l)+4)-4]|e[B-3]<<8,g=B+p;if(g>r){if(s)throw"unexpected EOF";break}i&&a(c+p),t.set(e.subarray(B,g),c),n.b=c+=p,n.p=l=8*g;continue}if(1==m)h=Bu,u=Tu,d=9,f=5;else{if(2!=m)throw"invalid block type";var v=Mu(e,l,31)+257,y=Mu(e,l+10,15)+4,E=v+Mu(e,l+5,31)+1;l+=14;for(var x=new cu(E),C=new cu(19),w=0;w<y;++w)C[Au[w]]=Mu(e,l+3*w,7);l+=3*y;var I=_u(C),b=(1<<I)-1,S=Iu(C,I,1);for(w=0;w<E;){var B,T=S[Mu(e,l,b)];if(l+=15&T,(B=T>>>4)<16)x[w++]=B;else{var _=0,M=0;for(16==B?(M=3+Mu(e,l,3),l+=2,_=x[w-1]):17==B?(M=3+Mu(e,l,7),l+=3):18==B&&(M=11+Mu(e,l,127),l+=7);M--;)x[w++]=_}}var R=x.subarray(0,v),D=x.subarray(v);d=_u(R),f=_u(D),h=Iu(R,d,1),u=Iu(D,f,1)}if(l>A){if(s)throw"unexpected EOF";break}}i&&a(c+131072);for(var P=(1<<d)-1,L=(1<<f)-1,k=l;;k=l){var F=(_=h[Ru(e,l)&P])>>>4;if((l+=15&_)>A){if(s)throw"unexpected EOF";break}if(!_)throw"invalid length/literal";if(F<256)t[c++]=F;else{if(256==F){k=l,h=null;break}var O=F-254;if(F>264){var U=du[w=F-257];O=Mu(e,l,(1<<U)-1)+gu[w],l+=U}var Q=u[Ru(e,l)&L],N=Q>>>4;if(!Q)throw"invalid distance";l+=15&Q;D=Eu[N];if(N>3){U=fu[N];D+=Ru(e,l)&(1<<U)-1,l+=U}if(l>A){if(s)throw"unexpected EOF";break}i&&a(c+131072);for(var z=c+O;c<z;c+=4)t[c]=t[c-D],t[c+1]=t[c+1-D],t[c+2]=t[c+2-D],t[c+3]=t[c+3-D];c=z}}n.l=h,n.p=k,n.b=c,h&&(o=1,n.m=d,n.d=u,n.n=f)}while(!o);return c==t.length?t:Pu(t,0,c)},ku=new cu(0),Fu=function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"};function Ou(e,t){return Lu((Fu(e),e.subarray(2,-4)),t)}var Uu="undefined"!=typeof TextDecoder&&new TextDecoder;try{Uu.decode(ku,{stream:!0})}catch(Sf){}function Qu(e,t,n){const r=n.length-e-1;if(t>=n[r])return r-1;if(t<=n[e])return e;let i=e,s=r,a=Math.floor((i+s)/2);for(;t<n[a]||t>=n[a+1];)t<n[a]?s=a:i=a,a=Math.floor((i+s)/2);return a}function Nu(e,t,n,r){const i=[],s=[],a=[];i[0]=1;for(let o=1;o<=n;++o){s[o]=t-r[e+1-o],a[o]=r[e+o]-t;let n=0;for(let e=0;e<o;++e){const t=a[e+1],r=s[o-e],l=i[e]/(t+r);i[e]=n+t*l,n=r*l}i[o]=n}return i}function zu(e,t){let n=1;for(let i=2;i<=e;++i)n*=i;let r=1;for(let i=2;i<=t;++i)r*=i;for(let i=2;i<=e-t;++i)r*=i;return n/r}function Gu(e,t,n,r,i){const s=function(e,t,n,r,i){const s=i<e?i:e,o=[],l=Qu(e,r,t),c=function(e,t,n,r,i){const s=[];for(let u=0;u<=n;++u)s[u]=0;const a=[];for(let u=0;u<=r;++u)a[u]=s.slice(0);const o=[];for(let u=0;u<=n;++u)o[u]=s.slice(0);o[0][0]=1;const l=s.slice(0),c=s.slice(0);for(let u=1;u<=n;++u){l[u]=t-i[e+1-u],c[u]=i[e+u]-t;let n=0;for(let e=0;e<u;++e){const t=c[e+1],r=l[u-e];o[u][e]=t+r;const i=o[e][u-1]/o[u][e];o[e][u]=n+t*i,n=r*i}o[u][u]=n}for(let u=0;u<=n;++u)a[0][u]=o[u][n];for(let u=0;u<=n;++u){let e=0,t=1;const i=[];for(let r=0;r<=n;++r)i[r]=s.slice(0);i[0][0]=1;for(let s=1;s<=r;++s){let r=0;const l=u-s,c=n-s;u>=s&&(i[t][0]=i[e][0]/o[c+1][l],r=i[t][0]*o[l][c]);const h=u-1<=c?s-1:n-u;for(let n=l>=-1?1:-l;n<=h;++n)i[t][n]=(i[e][n]-i[e][n-1])/o[c+1][l+n],r+=i[t][n]*o[l+n][c];u<=c&&(i[t][s]=-i[e][s-1]/o[c+1][u],r+=i[t][s]*o[u][c]),a[s][u]=r;const d=e;e=t,t=d}}let h=n;for(let u=1;u<=r;++u){for(let e=0;e<=n;++e)a[u][e]*=h;h*=n-u}return a}(l,r,e,s,t),h=[];for(let a=0;a<n.length;++a){const e=n[a].clone(),t=e.w;e.x*=t,e.y*=t,e.z*=t,h[a]=e}for(let a=0;a<=s;++a){const t=h[l-e].clone().multiplyScalar(c[a][0]);for(let n=1;n<=e;++n)t.add(h[l-e+n].clone().multiplyScalar(c[a][n]));o[a]=t}for(let u=s+1;u<=i+1;++u)o[u]=new a.IUQ(0,0,0);return o}(e,t,n,r,i);return function(e){const t=e.length,n=[],r=[];for(let s=0;s<t;++s){const t=e[s];n[s]=new a.Pq0(t.x,t.y,t.z),r[s]=t.w}const i=[];for(let s=0;s<t;++s){const e=n[s].clone();for(let t=1;t<=s;++t)e.sub(i[s-t].clone().multiplyScalar(zu(s,t)*r[t]));i[s]=e.divideScalar(r[0])}return i}(s)}class Hu extends a.Ipv{constructor(e,t,n,r,i){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=r||0,this.endKnot=i||this.knots.length-1;for(let s=0;s<n.length;++s){const e=n[s];this.controlPoints[s]=new a.IUQ(e.x,e.y,e.z,e.w)}}getPoint(e,t){const n=t||new a.Pq0,r=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),i=function(e,t,n,r){const i=Qu(e,r,t),s=Nu(i,r,e,t),o=new a.IUQ(0,0,0,0);for(let a=0;a<=e;++a){const t=n[i-e+a],r=s[a],l=t.w*r;o.x+=t.x*l,o.y+=t.y*l,o.z+=t.z*l,o.w+=t.w*r}return o}(this.degree,this.knots,this.controlPoints,r);return 1!=i.w&&i.divideScalar(i.w),n.set(i.x,i.y,i.z)}getTangent(e,t){const n=t||new a.Pq0,r=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),i=Gu(this.degree,this.knots,this.controlPoints,r,1);return n.copy(i[1]).normalize(),n}}let qu,Yu,ju;class Vu extends a.aHM{constructor(e){super(e)}load(e,t,n,r){const i=this,s=""===i.path?a.r6x.extractUrlBase(e):i.path,o=new a.Y9S(this.manager);o.setPath(i.path),o.setResponseType("arraybuffer"),o.setRequestHeader(i.requestHeader),o.setWithCredentials(i.withCredentials),o.load(e,(function(n){try{t(i.parse(n,s))}catch(Sf){r?r(Sf):console.error(Sf),i.manager.itemError(e)}}),n,r)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===hd(e,0,t.length)}(e))qu=(new $u).parse(e);else{const t=hd(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function r(t){const r=e[t-1];return e=e.slice(n+t),n++,r}for(let i=0;i<t.length;++i){if(r(1)===t[i])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(td(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+td(t));qu=(new Xu).parse(t)}const n=new a.Tap(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Ku(n,this.manager).parse(qu)}}class Ku{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Yu=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),r=this.parseDeformers(),i=(new Wu).parse(r);return this.parseScene(r,i,n),ju}parseConnections(){const e=new Map;if("Connections"in qu){qu.Connections.connections.forEach((function(t){const n=t[0],r=t[1],i=t[2];e.has(n)||e.set(n,{parents:[],children:[]});const s={ID:r,relationship:i};e.get(n).parents.push(s),e.has(r)||e.set(r,{parents:[],children:[]});const a={ID:n,relationship:i};e.get(r).children.push(a)}))}return e}parseImages(){const e={},t={};if("Video"in qu.Objects){const n=qu.Objects.Video;for(const r in n){const i=n[r];if(e[parseInt(r)]=i.RelativeFilename||i.Filename,"Content"in i){const e=i.Content instanceof ArrayBuffer&&i.Content.byteLength>0,s="string"==typeof i.Content&&""!==i.Content;if(e||s){const e=this.parseImage(n[r]);t[i.RelativeFilename||i.Filename]=e}}}}for(const n in e){const r=e[n];void 0!==t[r]?e[n]=t[r]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,r=n.slice(n.lastIndexOf(".")+1).toLowerCase();let i;switch(r){case"bmp":i="image/bmp";break;case"jpg":case"jpeg":i="image/jpeg";break;case"png":i="image/png";break;case"tif":i="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",n),i="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+r+'" is not supported.')}if("string"==typeof t)return"data:"+i+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:i}))}}parseTextures(e){const t=new Map;if("Texture"in qu.Objects){const n=qu.Objects.Texture;for(const r in n){const i=this.parseTexture(n[r],e);t.set(parseInt(r),i)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const r=e.WrapModeU,i=e.WrapModeV,s=void 0!==r?r.value:0,o=void 0!==i?i.value:0;if(n.wrapS=0===s?a.GJx:a.ghU,n.wrapT=0===o?a.GJx:a.ghU,"Scaling"in e){const t=e.Scaling.value;n.repeat.x=t[0],n.repeat.y=t[1]}return n}loadTexture(e,t){let n;const r=this.textureLoader.path,i=Yu.get(e.id).children;let s;void 0!==i&&i.length>0&&void 0!==t[i[0].ID]&&(n=t[i[0].ID],0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));const o=e.FileName.slice(-3).toLowerCase();if("tga"===o){const t=this.manager.getHandler(".tga");null===t?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),s=new a.gPd):(t.setPath(this.textureLoader.path),s=t.load(n))}else"psd"===o?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),s=new a.gPd):s=this.textureLoader.load(n);return this.textureLoader.setPath(r),s}parseMaterials(e){const t=new Map;if("Material"in qu.Objects){const n=qu.Objects.Material;for(const r in n){const i=this.parseMaterial(n[r],e);null!==i&&t.set(parseInt(r),i)}}return t}parseMaterial(e,t){const n=e.id,r=e.attrName;let i=e.ShadingModel;if("object"==typeof i&&(i=i.value),!Yu.has(n))return null;const s=this.parseParameters(e,t,n);let o;switch(i.toLowerCase()){case"phong":o=new a.tXL;break;case"lambert":o=new a.G_z;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',i),o=new a.tXL}return o.setValues(s),o.name=r,o}parseParameters(e,t,n){const r={};e.BumpFactor&&(r.bumpScale=e.BumpFactor.value),e.Diffuse?r.color=(new a.Q1f).fromArray(e.Diffuse.value):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(r.color=(new a.Q1f).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(r.displacementScale=e.DisplacementFactor.value),e.Emissive?r.emissive=(new a.Q1f).fromArray(e.Emissive.value):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(r.emissive=(new a.Q1f).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(r.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(r.opacity=parseFloat(e.Opacity.value)),r.opacity<1&&(r.transparent=!0),e.ReflectionFactor&&(r.reflectivity=e.ReflectionFactor.value),e.Shininess&&(r.shininess=e.Shininess.value),e.Specular?r.specular=(new a.Q1f).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(r.specular=(new a.Q1f).fromArray(e.SpecularColor.value));const i=this;return Yu.get(n).children.forEach((function(e){const n=e.relationship;switch(n){case"Bump":r.bumpMap=i.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":r.aoMap=i.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":r.map=i.getTexture(t,e.ID),void 0!==r.map&&("colorSpace"in r.map?r.map.colorSpace="srgb":r.map.encoding=3001);break;case"DisplacementColor":r.displacementMap=i.getTexture(t,e.ID);break;case"EmissiveColor":r.emissiveMap=i.getTexture(t,e.ID),void 0!==r.emissiveMap&&("colorSpace"in r.emissiveMap?r.emissiveMap.colorSpace="srgb":r.emissiveMap.encoding=3001);break;case"NormalMap":case"Maya|TEX_normal_map":r.normalMap=i.getTexture(t,e.ID);break;case"ReflectionColor":r.envMap=i.getTexture(t,e.ID),void 0!==r.envMap&&(r.envMap.mapping=a.wfO,"colorSpace"in r.envMap?r.envMap.colorSpace="srgb":r.envMap.encoding=3001);break;case"SpecularColor":r.specularMap=i.getTexture(t,e.ID),void 0!==r.specularMap&&("colorSpace"in r.specularMap?r.specularMap.colorSpace="srgb":r.specularMap.encoding=3001);break;case"TransparentColor":case"TransparencyFactor":r.alphaMap=i.getTexture(t,e.ID),r.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",n)}})),r}getTexture(e,t){return"LayeredTexture"in qu.Objects&&t in qu.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=Yu.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in qu.Objects){const n=qu.Objects.Deformer;for(const r in n){const i=n[r],s=Yu.get(parseInt(r));if("Skin"===i.attrType){const t=this.parseSkeleton(s,n);t.ID=r,s.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=s.parents[0].ID,e[r]=t}else if("BlendShape"===i.attrType){const e={id:r};e.rawTargets=this.parseMorphTargets(s,n),e.id=r,s.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[r]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach((function(e){const r=t[e.ID];if("Cluster"!==r.attrType)return;const i={ID:e.ID,indices:[],weights:[],transformLink:(new a.kn4).fromArray(r.TransformLink.a)};"Indexes"in r&&(i.indices=r.Indexes.a,i.weights=r.Weights.a),n.push(i)})),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let r=0;r<e.children.length;r++){const i=e.children[r],s=t[i.ID],a={name:s.attrName,initialWeight:s.DeformPercent,id:s.id,fullWeights:s.FullWeights.a};if("BlendShapeChannel"!==s.attrType)return;a.geoID=Yu.get(parseInt(i.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(a)}return n}parseScene(e,t,n){ju=new a.YJl;const r=this.parseModels(e.skeletons,t,n),i=qu.Objects.Model,s=this;r.forEach((function(e){const t=i[e.ID];s.setLookAtProperties(e,t);Yu.get(e.ID).parents.forEach((function(t){const n=r.get(t.ID);void 0!==n&&n.add(e)})),null===e.parent&&ju.add(e)})),this.bindSkeleton(e.skeletons,t,r),this.createAmbientLight(),ju.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=od(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const o=(new Ju).parse();1===ju.children.length&&ju.children[0].isGroup&&(ju.children[0].animations=o,ju=ju.children[0]),ju.animations=o}parseModels(e,t,n){const r=new Map,i=qu.Objects.Model;for(const s in i){const o=parseInt(s),l=i[s],c=Yu.get(o);let h=this.buildSkeleton(c,e,o,l.attrName);if(!h){switch(l.attrType){case"Camera":h=this.createCamera(c);break;case"Light":h=this.createLight(c);break;case"Mesh":h=this.createMesh(c,t,n);break;case"NurbsCurve":h=this.createCurve(c,t);break;case"LimbNode":case"Root":h=new a.$Kf;break;default:h=new a.YJl}h.name=l.attrName?a.Nwf.sanitizeNodeName(l.attrName):"",h.ID=o}this.getTransformData(h,l),r.set(o,h)}return r}buildSkeleton(e,t,n,r){let i=null;return e.parents.forEach((function(e){for(const s in t){const o=t[s];o.rawBones.forEach((function(t,s){if(t.ID===e.ID){const e=i;i=new a.$Kf,i.matrixWorld.copy(t.transformLink),i.name=r?a.Nwf.sanitizeNodeName(r):"",i.ID=n,o.bones[s]=i,null!==e&&i.add(e)}}))}})),i}createCamera(e){let t,n;if(e.children.forEach((function(e){const t=qu.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new a.B69;else{let e=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(e=1);let r=1;void 0!==n.NearPlane&&(r=n.NearPlane.value/1e3);let i=1e3;void 0!==n.FarPlane&&(i=n.FarPlane.value/1e3);let s=window.innerWidth,o=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(s=n.AspectWidth.value,o=n.AspectHeight.value);const l=s/o;let c=45;void 0!==n.FieldOfView&&(c=n.FieldOfView.value);const h=n.FocalLength?n.FocalLength.value:null;switch(e){case 0:t=new a.ubm(c,l,r,i),null!==h&&t.setFocalLength(h);break;case 1:t=new a.qUd(-s/2,s/2,o/2,-o/2,r,i);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new a.B69}}return t}createLight(e){let t,n;if(e.children.forEach((function(e){const t=qu.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new a.B69;else{let e;e=void 0===n.LightType?0:n.LightType.value;let r=16777215;void 0!==n.Color&&(r=(new a.Q1f).fromArray(n.Color.value));let i=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(i=0);let s=0;void 0!==n.FarAttenuationEnd&&(s=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);const o=1;switch(e){case 0:t=new a.HiM(r,i,s,o);break;case 1:t=new a.ZyN(r,i);break;case 2:let e=Math.PI/3;void 0!==n.InnerAngle&&(e=a.cj9.degToRad(n.InnerAngle.value));let l=0;void 0!==n.OuterAngle&&(l=a.cj9.degToRad(n.OuterAngle.value),l=Math.max(l,1)),t=new a.nCl(r,i,s,e,l,o);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new a.HiM(r,i)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,n){let r,i=null,s=null;const o=[];return e.children.forEach((function(e){t.has(e.ID)&&(i=t.get(e.ID)),n.has(e.ID)&&o.push(n.get(e.ID))})),o.length>1?s=o:o.length>0?s=o[0]:(s=new a.tXL({color:13421772}),o.push(s)),"color"in i.attributes&&o.forEach((function(e){e.vertexColors=!0})),i.FBX_Deformer?(r=new a.I46(i,s),r.normalizeSkinWeights()):r=new a.eaF(i,s),r}createCurve(e,t){const n=e.children.reduce((function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e}),null),r=new a.mrM({color:3342591,linewidth:1});return new a.N1A(n,r)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder="RotationOrder"in t?ld(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){if("LookAtProperty"in t){Yu.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const n=qu.Objects.Model[t.ID];if("Lcl_Translation"in n){const t=n.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),ju.add(e.target)):e.lookAt((new a.Pq0).fromArray(t))}}}))}}bindSkeleton(e,t,n){const r=this.parsePoseNodes();for(const i in e){const s=e[i];Yu.get(parseInt(s.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;Yu.get(t).parents.forEach((function(e){if(n.has(e.ID)){n.get(e.ID).bind(new a.EAD(s.bones),r[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in qu.Objects){const t=qu.Objects.Pose;for(const n in t)if("BindPose"===t[n].attrType&&t[n].NbPoseNodes>0){const r=t[n].PoseNode;Array.isArray(r)?r.forEach((function(t){e[t.Node]=(new a.kn4).fromArray(t.Matrix.a)})):e[r.Node]=(new a.kn4).fromArray(r.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in qu&&"AmbientColor"in qu.GlobalSettings){const e=qu.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],r=e[2];if(0!==t||0!==n||0!==r){const e=new a.Q1f(t,n,r);ju.add(new a.$p8(e,1))}}}}class Wu{parse(e){const t=new Map;if("Geometry"in qu.Objects){const n=qu.Objects.Geometry;for(const r in n){const i=Yu.get(parseInt(r)),s=this.parseGeometry(i,n[r],e);t.set(parseInt(r),s)}}return t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const r=n.skeletons,i=[],s=e.parents.map((function(e){return qu.Objects.Model[e.ID]}));if(0===s.length)return;const a=e.children.reduce((function(e,t){return void 0!==r[t.ID]&&(e=r[t.ID]),e}),null);e.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&i.push(n.morphTargets[e.ID])}));const o=s[0],l={};"RotationOrder"in o&&(l.eulerOrder=ld(o.RotationOrder.value)),"InheritType"in o&&(l.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(l.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(l.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(l.scale=o.GeometricScaling.value);const c=od(l);return this.genGeometry(t,a,i,c)}genGeometry(e,t,n,r){const i=new a.LoY;e.attrName&&(i.name=e.attrName);const s=this.parseGeoNode(e,t),o=this.genBuffers(s),l=new a.qtW(o.vertex,3);if(l.applyMatrix4(r),i.setAttribute("position",l),o.colors.length>0&&i.setAttribute("color",new a.qtW(o.colors,3)),t&&(i.setAttribute("skinIndex",new a.A$4(o.weightsIndices,4)),i.setAttribute("skinWeight",new a.qtW(o.vertexWeights,4)),i.FBX_Deformer=t),o.normal.length>0){const e=(new a.dwI).getNormalMatrix(r),t=new a.qtW(o.normal,3);t.applyNormalMatrix(e),i.setAttribute("normal",t)}if(o.uvs.forEach((function(e,t){"uv2"===Tr&&t++;const n=0===t?"uv":`uv${t}`;i.setAttribute(n,new a.qtW(o.uvs[t],2))})),s.material&&"AllSame"!==s.material.mappingType){let e=o.materialIndex[0],t=0;if(o.materialIndex.forEach((function(n,r){n!==e&&(i.addGroup(t,r-t,e),e=n,t=r)})),i.groups.length>0){const t=i.groups[i.groups.length-1],n=t.start+t.count;n!==o.materialIndex.length&&i.addGroup(n,o.materialIndex.length-n,e)}0===i.groups.length&&i.addGroup(0,o.materialIndex.length,o.materialIndex[0])}return this.addMorphTargets(i,e,n,r),i}parseGeoNode(e,t){const n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(r,i){void 0===n.weightTable[r]&&(n.weightTable[r]=[]),n.weightTable[r].push({id:t,weight:e.weights[i]})}))}))),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,r=0,i=!1,s=[],a=[],o=[],l=[],c=[],h=[];const u=this;return e.vertexIndices.forEach((function(d,f){let A,m=!1;d<0&&(d=~d,m=!0);let p=[],g=[];if(s.push(3*d,3*d+1,3*d+2),e.color){const t=id(f,n,d,e.color);o.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){g.push(e.weight),p.push(e.id)})),g.length>4){i||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),i=!0);const e=[0,0,0,0],t=[0,0,0,0];g.forEach((function(n,r){let i=n,s=p[r];t.forEach((function(t,n,r){if(i>t){r[n]=i,i=t;const a=e[n];e[n]=s,s=a}}))})),p=e,g=t}for(;g.length<4;)g.push(0),p.push(0);for(let e=0;e<4;++e)c.push(g[e]),h.push(p[e])}if(e.normal){const t=id(f,n,d,e.normal);a.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(A=id(f,n,d,e.material)[0]),e.uv&&e.uv.forEach((function(e,t){const r=id(f,n,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(r[0]),l[t].push(r[1])})),r++,m&&(u.genFace(t,e,s,A,a,o,l,c,h,r),n++,r=0,s=[],a=[],o=[],l=[],c=[],h=[])})),t}genFace(e,t,n,r,i,s,a,o,l,c){for(let h=2;h<c;h++)e.vertex.push(t.vertexPositions[n[0]]),e.vertex.push(t.vertexPositions[n[1]]),e.vertex.push(t.vertexPositions[n[2]]),e.vertex.push(t.vertexPositions[n[3*(h-1)]]),e.vertex.push(t.vertexPositions[n[3*(h-1)+1]]),e.vertex.push(t.vertexPositions[n[3*(h-1)+2]]),e.vertex.push(t.vertexPositions[n[3*h]]),e.vertex.push(t.vertexPositions[n[3*h+1]]),e.vertex.push(t.vertexPositions[n[3*h+2]]),t.skeleton&&(e.vertexWeights.push(o[0]),e.vertexWeights.push(o[1]),e.vertexWeights.push(o[2]),e.vertexWeights.push(o[3]),e.vertexWeights.push(o[4*(h-1)]),e.vertexWeights.push(o[4*(h-1)+1]),e.vertexWeights.push(o[4*(h-1)+2]),e.vertexWeights.push(o[4*(h-1)+3]),e.vertexWeights.push(o[4*h]),e.vertexWeights.push(o[4*h+1]),e.vertexWeights.push(o[4*h+2]),e.vertexWeights.push(o[4*h+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(h-1)]),e.weightsIndices.push(l[4*(h-1)+1]),e.weightsIndices.push(l[4*(h-1)+2]),e.weightsIndices.push(l[4*(h-1)+3]),e.weightsIndices.push(l[4*h]),e.weightsIndices.push(l[4*h+1]),e.weightsIndices.push(l[4*h+2]),e.weightsIndices.push(l[4*h+3])),t.color&&(e.colors.push(s[0]),e.colors.push(s[1]),e.colors.push(s[2]),e.colors.push(s[3*(h-1)]),e.colors.push(s[3*(h-1)+1]),e.colors.push(s[3*(h-1)+2]),e.colors.push(s[3*h]),e.colors.push(s[3*h+1]),e.colors.push(s[3*h+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(r),e.materialIndex.push(r),e.materialIndex.push(r)),t.normal&&(e.normal.push(i[0]),e.normal.push(i[1]),e.normal.push(i[2]),e.normal.push(i[3*(h-1)]),e.normal.push(i[3*(h-1)+1]),e.normal.push(i[3*(h-1)+2]),e.normal.push(i[3*h]),e.normal.push(i[3*h+1]),e.normal.push(i[3*h+2])),t.uv&&t.uv.forEach((function(t,n){void 0===e.uvs[n]&&(e.uvs[n]=[]),e.uvs[n].push(a[n][0]),e.uvs[n].push(a[n][1]),e.uvs[n].push(a[n][2*(h-1)]),e.uvs[n].push(a[n][2*(h-1)+1]),e.uvs[n].push(a[n][2*h]),e.uvs[n].push(a[n][2*h+1])}))}addMorphTargets(e,t,n,r){if(0===n.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const i=this;n.forEach((function(n){n.rawTargets.forEach((function(n){const s=qu.Objects.Geometry[n.geoID];void 0!==s&&i.genMorphGeometry(e,t,s,r,n.name)}))}))}genMorphGeometry(e,t,n,r,i){const s=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],o=void 0!==n.Vertices?n.Vertices.a:[],l=void 0!==n.Indexes?n.Indexes.a:[],c=3*e.attributes.position.count,h=new Float32Array(c);for(let a=0;a<l.length;a++){const e=3*l[a];h[e]=o[3*a],h[e+1]=o[3*a+1],h[e+2]=o[3*a+2]}const u={vertexIndices:s,vertexPositions:h},d=this.genBuffers(u),f=new a.qtW(d.vertex,3);f.name=i||n.attrName,f.applyMatrix4(r),e.morphAttributes.position.push(f)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.Normals.a;let i=[];return"IndexToDirect"===n&&("NormalIndex"in e?i=e.NormalIndex.a:"NormalsIndex"in e&&(i=e.NormalsIndex.a)),{dataSize:3,buffer:r,indices:i,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.UV.a;let i=[];return"IndexToDirect"===n&&(i=e.UVIndex.a),{dataSize:2,buffer:r,indices:i,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.Colors.a;let i=[];return"IndexToDirect"===n&&(i=e.ColorIndex.a),{dataSize:4,buffer:r,indices:i,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const r=e.Materials.a,i=[];for(let s=0;s<r.length;++s)i.push(s);return{dataSize:1,buffer:r,indices:i,mappingType:t,referenceType:n}}parseNurbsGeometry(e){if(void 0===Hu)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new a.LoY;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new a.LoY;const n=t-1,r=e.KnotVector.a,i=[],s=e.Points.a;for(let h=0,u=s.length;h<u;h+=4)i.push((new a.IUQ).fromArray(s,h));let o,l;if("Closed"===e.Form)i.push(i[0]);else if("Periodic"===e.Form){o=n,l=r.length-1-o;for(let e=0;e<n;++e)i.push(i[e])}const c=new Hu(n,r,i,o,l).getPoints(12*i.length);return(new a.LoY).setFromPoints(c)}}class Ju{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const n in t){const r=t[n],i=this.addClip(r);e.push(i)}return e}parseClips(){if(void 0===qu.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=qu.Objects.AnimationCurveNode,t=new Map;for(const n in e){const r=e[n];if(null!==r.attrName.match(/S|R|T|DeformPercent/)){const e={id:r.id,attr:r.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=qu.Objects.AnimationCurve;for(const n in t){const r={id:t[n].id,times:t[n].KeyTime.a.map(nd),values:t[n].KeyValueFloat.a},i=Yu.get(r.id);if(void 0!==i){const t=i.parents[0].ID,n=i.parents[0].relationship;n.match(/X/)?e.get(t).curves.x=r:n.match(/Y/)?e.get(t).curves.y=r:n.match(/Z/)?e.get(t).curves.z=r:n.match(/d|DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=r)}}}parseAnimationLayers(e){const t=qu.Objects.AnimationLayer,n=new Map;for(const r in t){const t=[],i=Yu.get(parseInt(r));if(void 0!==i){i.children.forEach((function(n,r){if(e.has(n.ID)){const i=e.get(n.ID);if(void 0!==i.curves.x||void 0!==i.curves.y||void 0!==i.curves.z){if(void 0===t[r]){const e=Yu.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const i=qu.Objects.Model[e.toString()];if(void 0===i)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",n);const s={modelName:i.attrName?a.Nwf.sanitizeNodeName(i.attrName):"",ID:i.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};ju.traverse((function(e){e.ID===i.id&&(s.transform=e.matrix,e.userData.transformData&&(s.eulerOrder=e.userData.transformData.eulerOrder))})),s.transform||(s.transform=new a.kn4),"PreRotation"in i&&(s.preRotation=i.PreRotation.value),"PostRotation"in i&&(s.postRotation=i.PostRotation.value),t[r]=s}}t[r]&&(t[r][i.attr]=i)}else if(void 0!==i.curves.morph){if(void 0===t[r]){const e=Yu.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,i=Yu.get(e).parents[0].ID,s=Yu.get(i).parents[0].ID,o=Yu.get(s).parents[0].ID,l=qu.Objects.Model[o],c={modelName:l.attrName?a.Nwf.sanitizeNodeName(l.attrName):"",morphName:qu.Objects.Deformer[e].attrName};t[r]=c}t[r][i.attr]=i}}})),n.set(parseInt(r),t)}}return n}parseAnimStacks(e){const t=qu.Objects.AnimationStack,n={};for(const r in t){const i=Yu.get(parseInt(r)).children;i.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const s=e.get(i[0].ID);n[r]={name:t[r].attrName,layer:s}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach((function(e){t=t.concat(n.generateTracks(e))})),new a.tz3(e.name,-1,t)}generateTracks(e){const t=[];let n=new a.Pq0,r=new a.PTz,i=new a.Pq0;if(e.transform&&e.transform.decompose(n,r,i),n=n.toArray(),r=(new a.O9p).setFromQuaternion(r,e.eulerOrder).toArray(),i=i.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==r&&t.push(r)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const n=this.generateRotationTrack(e.modelName,e.R.curves,r,e.preRotation,e.postRotation,e.eulerOrder);void 0!==n&&t.push(n)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const n=this.generateVectorTrack(e.modelName,e.S.curves,i,"scale");void 0!==n&&t.push(n)}if(void 0!==e.DeformPercent){const n=this.generateMorphTrack(e);void 0!==n&&t.push(n)}return t}generateVectorTrack(e,t,n,r){const i=this.getTimesForAllAxes(t),s=this.getKeyframeTrackValues(i,t,n);return new a.RiT(e+"."+r,i,s)}generateRotationTrack(e,t,n,r,i,s){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(a.cj9.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(a.cj9.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(a.cj9.degToRad));const o=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(o,t,n);void 0!==r&&((r=r.map(a.cj9.degToRad)).push(s),r=(new a.O9p).fromArray(r),r=(new a.PTz).setFromEuler(r)),void 0!==i&&((i=i.map(a.cj9.degToRad)).push(s),i=(new a.O9p).fromArray(i),i=(new a.PTz).setFromEuler(i).invert());const c=new a.PTz,h=new a.O9p,u=[];for(let a=0;a<l.length;a+=3)h.set(l[a],l[a+1],l[a+2],s),c.setFromEuler(h),void 0!==r&&c.premultiply(r),void 0!==i&&c.multiply(i),c.toArray(u,a/3*4);return new a.MBL(e+".quaternion",o,u)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),r=ju.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new a.Hit(e.modelName+".morphTargetInfluences["+r+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,n=t[0];for(let r=1;r<t.length;r++){const i=t[r];i!==n&&(t[e]=i,n=i,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,n){const r=n,i=[];let s=-1,a=-1,o=-1;return e.forEach((function(e){if(t.x&&(s=t.x.times.indexOf(e)),t.y&&(a=t.y.times.indexOf(e)),t.z&&(o=t.z.times.indexOf(e)),-1!==s){const e=t.x.values[s];i.push(e),r[0]=e}else i.push(r[0]);if(-1!==a){const e=t.y.values[a];i.push(e),r[1]=e}else i.push(r[1]);if(-1!==o){const e=t.z.values[o];i.push(e),r[2]=e}else i.push(r[2])})),i}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const n=e.values[t-1],r=e.values[t]-n,i=Math.abs(r);if(i>=180){const s=i/180,a=r/s;let o=n+a;const l=e.times[t-1],c=(e.times[t]-l)/s;let h=l+c;const u=[],d=[];for(;h<e.times[t];)u.push(h),h+=c,d.push(o),o+=a;e.times=ud(e.times,t,u),e.values=ud(e.values,t,d)}}}}class Xu{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new ed,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach((function(e,r){const i=e.match(/^[\s\t]*;/),s=e.match(/^[\s\t]*$/);if(i||s)return;const a=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),o=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");a?t.parseNodeBegin(e,a):o?t.parseNodeProperty(e,o,n[++r]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),r=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),i={name:n},s=this.parseNodeAttr(r),a=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,i):n in a?("PoseNode"===n?a.PoseNode.push(i):void 0!==a[n].id&&(a[n]={},a[n][a[n].id]=a[n]),""!==s.id&&(a[n][s.id]=i)):"number"==typeof s.id?(a[n]={},a[n][s.id]=i):"Properties70"!==n&&(a[n]="PoseNode"===n?[i]:i),"number"==typeof s.id&&(i.id=s.id),""!==s.name&&(i.attrName=s.name),""!==s.type&&(i.attrType=s.type),this.pushStack(i)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",r="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),r=e[2]),{id:t,name:n,type:r}}parseNodeProperty(e,t,n){let r=t[1].replace(/^"/,"").replace(/"$/,"").trim(),i=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===r&&","===i&&(i=n.replace(/"/g,"").replace(/,$/,"").trim());const s=this.getCurrentNode();if("Properties70"!==s.name){if("C"===r){const e=i.split(",").slice(1),t=parseInt(e[0]),n=parseInt(e[1]);let a=i.split(",").slice(3);a=a.map((function(e){return e.trim().replace(/^"/,"")})),r="connections",i=[t,n],function(e,t){for(let n=0,r=e.length,i=t.length;n<i;n++,r++)e[r]=t[n]}(i,a),void 0===s[r]&&(s[r]=[])}"Node"===r&&(s.id=i),r in s&&Array.isArray(s[r])?s[r].push(i):"a"!==r?s[r]=i:s.a=i,this.setCurrentProp(s,r),"a"===r&&","!==i.slice(-1)&&(s.a=cd(i))}else this.parseNodeSpecialProperty(e,r,i)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=cd(t.a))}parseNodeSpecialProperty(e,t,n){const r=n.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),i=r[0],s=r[1],a=r[2],o=r[3];let l=r[4];switch(s){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=cd(l)}this.getPrevNode()[i]={type:s,type2:a,flag:o,value:l},this.setCurrentProp(this.getPrevNode(),i)}}class $u{parse(e){const t=new Zu(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const r=new ed;for(;!this.endOfContent(t);){const e=this.parseNode(t,n);null!==e&&r.add(e.name,e)}return r}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},r=t>=7500?e.getUint64():e.getUint32(),i=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const s=e.getUint8(),a=e.getString(s);if(0===r)return null;const o=[];for(let u=0;u<i;u++)o.push(this.parseProperty(e));const l=o.length>0?o[0]:"",c=o.length>1?o[1]:"",h=o.length>2?o[2]:"";for(n.singleProperty=1===i&&e.getOffset()===r;r>e.getOffset();){const r=this.parseNode(e,t);null!==r&&this.parseSubNode(a,n,r)}return n.propertyList=o,"number"==typeof l&&(n.id=l),""!==c&&(n.attrName=c),""!==h&&(n.attrType=h),""!==a&&(n.name=a),n}parseSubNode(e,t,n){if(!0===n.singleProperty){const e=n.propertyList[0];Array.isArray(e)?(t[n.name]=n,n.a=e):t[n.name]=e}else if("Connections"===e&&"C"===n.name){const e=[];n.propertyList.forEach((function(t,n){0!==n&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===n.name){Object.keys(n).forEach((function(e){t[e]=n[e]}))}else if("Properties70"===e&&"P"===n.name){let e=n.propertyList[0],r=n.propertyList[1];const i=n.propertyList[2],s=n.propertyList[3];let a;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===r.indexOf("Lcl ")&&(r=r.replace("Lcl ","Lcl_")),a="Color"===r||"ColorRGB"===r||"Vector"===r||"Vector3D"===r||0===r.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[e]={type:r,type2:i,flag:s,value:a}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const r=e.getUint32(),i=e.getUint32(),s=e.getUint32();if(0===i)switch(t){case"b":case"c":return e.getBooleanArray(r);case"d":return e.getFloat64Array(r);case"f":return e.getFloat32Array(r);case"i":return e.getInt32Array(r);case"l":return e.getInt64Array(r)}const a=Ou(new Uint8Array(e.getArrayBuffer(s))),o=new Zu(a.buffer);switch(t){case"b":case"c":return o.getBooleanArray(r);case"d":return o.getFloat64Array(r);case"f":return o.getFloat32Array(r);case"i":return o.getInt32Array(r);case"l":return o.getInt64Array(r)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class Zu{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return!(1&~this.getUint8())}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let r=0;r<e;r++)t[r]=this.getUint8();const n=t.indexOf(0);return n>=0&&(t=t.slice(0,n)),so(new Uint8Array(t))}}class ed{add(e,t){this[e]=t}}function td(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function nd(e){return e/46186158e3}const rd=[];function id(e,t,n,r){let i;switch(r.mappingType){case"ByPolygonVertex":i=e;break;case"ByPolygon":i=t;break;case"ByVertice":i=n;break;case"AllSame":i=r.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+r.mappingType)}"IndexToDirect"===r.referenceType&&(i=r.indices[i]);const s=i*r.dataSize,a=s+r.dataSize;return function(e,t,n,r){for(let i=n,s=0;i<r;i++,s++)e[s]=t[i];return e}(rd,r.buffer,s,a)}const sd=new a.O9p,ad=new a.Pq0;function od(e){const t=new a.kn4,n=new a.kn4,r=new a.kn4,i=new a.kn4,s=new a.kn4,o=new a.kn4,l=new a.kn4,c=new a.kn4,h=new a.kn4,u=new a.kn4,d=new a.kn4,f=new a.kn4,A=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(ad.fromArray(e.translation)),e.preRotation){const t=e.preRotation.map(a.cj9.degToRad);t.push(e.eulerOrder),n.makeRotationFromEuler(sd.fromArray(t))}if(e.rotation){const t=e.rotation.map(a.cj9.degToRad);t.push(e.eulerOrder),r.makeRotationFromEuler(sd.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(a.cj9.degToRad);t.push(e.eulerOrder),i.makeRotationFromEuler(sd.fromArray(t)),i.invert()}e.scale&&s.scale(ad.fromArray(e.scale)),e.scalingOffset&&l.setPosition(ad.fromArray(e.scalingOffset)),e.scalingPivot&&o.setPosition(ad.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(ad.fromArray(e.rotationOffset)),e.rotationPivot&&h.setPosition(ad.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(d.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const m=n.clone().multiply(r).multiply(i),p=new a.kn4;p.extractRotation(u);const g=new a.kn4;g.copyPosition(u);const v=g.clone().invert().multiply(u),y=p.clone().invert().multiply(v),E=s,x=new a.kn4;if(0===A)x.copy(p).multiply(m).multiply(y).multiply(E);else if(1===A)x.copy(p).multiply(y).multiply(m).multiply(E);else{const e=(new a.kn4).scale((new a.Pq0).setFromMatrixScale(d)).clone().invert(),t=y.clone().multiply(e);x.copy(p).multiply(m).multiply(t).multiply(E)}const C=h.clone().invert(),w=o.clone().invert();let I=t.clone().multiply(c).multiply(h).multiply(n).multiply(r).multiply(i).multiply(C).multiply(l).multiply(o).multiply(s).multiply(w);const b=(new a.kn4).copyPosition(I),S=u.clone().multiply(b);return f.copyPosition(S),I=f.clone().multiply(x),I.premultiply(u.invert()),I}function ld(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function cd(e){return e.split(",").map((function(e){return parseFloat(e)}))}function hd(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),so(new Uint8Array(e,t,n))}function ud(e,t,n){return e.slice(0,t).concat(n).concat(e.slice(t))}function dd(e){return(0,o.F)(Vu,e)}function fd({path:e,...t}){const n=dd(e).children[0];return i.createElement(Na,(0,r.A)({},t,{object:n}))}dd.preload=e=>o.F.preload(Vu,e),dd.clear=e=>o.F.clear(Vu,e);class Ad{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const n=this.workersResolve[e];if(n&&n(t),this.queue.length){const{resolve:t,msg:n,transfer:r}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(n,r)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise((n=>{const r=this._getIdleWorker();-1!==r?(this._initWorker(r),this.workerStatus|=1<<r,this.workersResolve[r]=n,this.workers[r].postMessage(e,t)):this.queue.push({resolve:n,msg:e,transfer:t})}))}dispose(){this.workers.forEach((e=>e.terminate())),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const md=9,pd=15,gd=16,vd=22,yd=37,Ed=43,xd=76,Cd=83,wd=97,Id=100,bd=103,Sd=109,Bd=165,Td=166;class _d{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class Md{constructor(e,t,n,r){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,n),this._littleEndian=r,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian)+2**32*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t){void 0===t&&(t=0);const n=this._offset;let r=0;for(;this._dataView.getUint8(this._offset)!==t&&r<e;)r++,this._offset++;return r<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+n,r)}}const Rd=[171,75,84,88,32,50,48,187,13,10,26,10];function Dd(e){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(e):Buffer.from(e).toString("utf8")}let Pd,Ld,kd;const Fd={env:{emscripten_notify_memory_growth:function(e){kd=new Uint8Array(Ld.exports.memory.buffer)}}};class Od{init(){return Pd||(Pd="undefined"!=typeof fetch?fetch("data:application/wasm;base64,"+Ud).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,Fd))).then(this._init):WebAssembly.instantiate(Buffer.from(Ud,"base64"),Fd).then(this._init),Pd)}_init(e){Ld=e.instance,Fd.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!Ld)throw new Error("ZSTDDecoder: Await .init() before decoding.");const n=e.byteLength,r=Ld.exports.malloc(n);kd.set(e,r),t=t||Number(Ld.exports.ZSTD_findDecompressedSize(r,n));const i=Ld.exports.malloc(t),s=Ld.exports.ZSTD_decompress(i,t,r,n),a=kd.slice(i,i+s);return Ld.exports.free(r),Ld.exports.free(i),a}}const Ud="AGFzbQEAAAABpQEVYAF/AX9gAn9/AGADf39/AX9gBX9/f39/AX9gAX8AYAJ/fwF/YAR/f39/AX9gA39/fwBgBn9/f39/fwF/YAd/f39/f39/AX9gAn9/AX5gAn5+AX5gAABgBX9/f39/AGAGf39/f39/AGAIf39/f39/f38AYAl/f39/f39/f38AYAABf2AIf39/f39/f38Bf2ANf39/f39/f39/f39/fwF/YAF/AX4CJwEDZW52H2Vtc2NyaXB0ZW5fbm90aWZ5X21lbW9yeV9ncm93dGgABANpaAEFAAAFAgEFCwACAQABAgIFBQcAAwABDgsBAQcAEhMHAAUBDAQEAAANBwQCAgYCBAgDAwMDBgEACQkHBgICAAYGAgQUBwYGAwIGAAMCAQgBBwUGCgoEEQAEBAEIAwgDBQgDEA8IAAcABAUBcAECAgUEAQCAAgYJAX8BQaCgwAILB2AHBm1lbW9yeQIABm1hbGxvYwAoBGZyZWUAJgxaU1REX2lzRXJyb3IAaBlaU1REX2ZpbmREZWNvbXByZXNzZWRTaXplAFQPWlNURF9kZWNvbXByZXNzAEoGX3N0YXJ0ACQJBwEAQQELASQKussBaA8AIAAgACgCBCABajYCBAsZACAAKAIAIAAoAgRBH3F0QQAgAWtBH3F2CwgAIABBiH9LC34BBH9BAyEBIAAoAgQiA0EgTQRAIAAoAggiASAAKAIQTwRAIAAQDQ8LIAAoAgwiAiABRgRAQQFBAiADQSBJGw8LIAAgASABIAJrIANBA3YiBCABIARrIAJJIgEbIgJrIgQ2AgggACADIAJBA3RrNgIEIAAgBCgAADYCAAsgAQsUAQF/IAAgARACIQIgACABEAEgAgv3AQECfyACRQRAIABCADcCACAAQQA2AhAgAEIANwIIQbh/DwsgACABNgIMIAAgAUEEajYCECACQQRPBEAgACABIAJqIgFBfGoiAzYCCCAAIAMoAAA2AgAgAUF/ai0AACIBBEAgAEEIIAEQFGs2AgQgAg8LIABBADYCBEF/DwsgACABNgIIIAAgAS0AACIDNgIAIAJBfmoiBEEBTQRAIARBAWtFBEAgACABLQACQRB0IANyIgM2AgALIAAgAS0AAUEIdCADajYCAAsgASACakF/ai0AACIBRQRAIABBADYCBEFsDwsgAEEoIAEQFCACQQN0ams2AgQgAgsWACAAIAEpAAA3AAAgACABKQAINwAICy8BAX8gAUECdEGgHWooAgAgACgCAEEgIAEgACgCBGprQR9xdnEhAiAAIAEQASACCyEAIAFCz9bTvtLHq9lCfiAAfEIfiUKHla+vmLbem55/fgsdAQF/IAAoAgggACgCDEYEfyAAKAIEQSBGBUEACwuCBAEDfyACQYDAAE8EQCAAIAEgAhBnIAAPCyAAIAJqIQMCQCAAIAFzQQNxRQRAAkAgAkEBSARAIAAhAgwBCyAAQQNxRQRAIAAhAgwBCyAAIQIDQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADTw0BIAJBA3ENAAsLAkAgA0F8cSIEQcAASQ0AIAIgBEFAaiIFSw0AA0AgAiABKAIANgIAIAIgASgCBDYCBCACIAEoAgg2AgggAiABKAIMNgIMIAIgASgCEDYCECACIAEoAhQ2AhQgAiABKAIYNgIYIAIgASgCHDYCHCACIAEoAiA2AiAgAiABKAIkNgIkIAIgASgCKDYCKCACIAEoAiw2AiwgAiABKAIwNgIwIAIgASgCNDYCNCACIAEoAjg2AjggAiABKAI8NgI8IAFBQGshASACQUBrIgIgBU0NAAsLIAIgBE8NAQNAIAIgASgCADYCACABQQRqIQEgAkEEaiICIARJDQALDAELIANBBEkEQCAAIQIMAQsgA0F8aiIEIABJBEAgACECDAELIAAhAgNAIAIgAS0AADoAACACIAEtAAE6AAEgAiABLQACOgACIAIgAS0AAzoAAyABQQRqIQEgAkEEaiICIARNDQALCyACIANJBEADQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADRw0ACwsgAAsMACAAIAEpAAA3AAALQQECfyAAKAIIIgEgACgCEEkEQEEDDwsgACAAKAIEIgJBB3E2AgQgACABIAJBA3ZrIgE2AgggACABKAAANgIAQQALDAAgACABKAIANgAAC/cCAQJ/AkAgACABRg0AAkAgASACaiAASwRAIAAgAmoiBCABSw0BCyAAIAEgAhALDwsgACABc0EDcSEDAkACQCAAIAFJBEAgAwRAIAAhAwwDCyAAQQNxRQRAIAAhAwwCCyAAIQMDQCACRQ0EIAMgAS0AADoAACABQQFqIQEgAkF/aiECIANBAWoiA0EDcQ0ACwwBCwJAIAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigCACACaiAAQQZ2IgFBAnRBsB5qKAIAaiAAQSBxIgBFaiABRSAAQQV2cWoFQbh/CwsdACAAKAKQ4gEQWiAAQQA2AqDiASAAQgA3A5DiAQu1AwEFfyMAQZACayIKJABBuH8hBgJAIAVFDQAgBCwAACIIQf8BcSEHAkAgCEF/TARAIAdBgn9qQQF2IgggBU8NAkFsIQYgB0GBf2oiBUGAAk8NAiAEQQFqIQdBACEGA0AgBiAFTwRAIAUhBiAIIQcMAwUgACAGaiAHIAZBAXZqIgQtAABBBHY6AAAgACAGQQFyaiAELQAAQQ9xOgAAIAZBAmohBgwBCwAACwALIAcgBU8NASAAIARBAWogByAKEFMiBhADDQELIAYhBEEAIQYgAUEAQTQQECEJQQAhBQNAIAQgBkcEQCAAIAZqIggtAAAiAUELSwRAQWwhBgwDBSAJIAFBAnRqIgEgASgCAEEBajYCACAGQQFqIQZBASAILQAAdEEBdSAFaiEFDAILAAsLQWwhBiAFRQ0AIAUQFEEBaiIBQQxLDQAgAyABNgIAQQFBASABdCAFayIDEBQiAXQgA0cNACAAIARqIAFBAWoiADoAACAJIABBAnRqIgAgACgCAEEBajYCACAJKAIEIgBBAkkgAEEBcXINACACIARBAWo2AgAgB0EBaiEGCyAKQZACaiQAIAYLxhEBDH8jAEHwAGsiBSQAQWwhCwJAIANBCkkNACACLwAAIQogAi8AAiEJIAIvAAQhByAFQQhqIAQQDgJAIAMgByAJIApqakEGaiIMSQ0AIAUtAAohCCAFQdgAaiACQQZqIgIgChAGIgsQAw0BIAVBQGsgAiAKaiICIAkQBiILEAMNASAFQShqIAIgCWoiAiAHEAYiCxADDQEgBUEQaiACIAdqIAMgDGsQBiILEAMNASAAIAFqIg9BfWohECAEQQRqIQZBASELIAAgAUEDakECdiIDaiIMIANqIgIgA2oiDiEDIAIhBCAMIQcDQCALIAMgEElxBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgCS0AAyELIAcgBiAFQUBrIAgQAkECdGoiCS8BADsAACAFQUBrIAktAAIQASAJLQADIQogBCAGIAVBKGogCBACQQJ0aiIJLwEAOwAAIAVBKGogCS0AAhABIAktAAMhCSADIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgDS0AAyENIAAgC2oiCyAGIAVB2ABqIAgQAkECdGoiAC8BADsAACAFQdgAaiAALQACEAEgAC0AAyEAIAcgCmoiCiAGIAVBQGsgCBACQQJ0aiIHLwEAOwAAIAVBQGsgBy0AAhABIActAAMhByAEIAlqIgkgBiAFQShqIAgQAkECdGoiBC8BADsAACAFQShqIAQtAAIQASAELQADIQQgAyANaiIDIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgACALaiEAIAcgCmohByAEIAlqIQQgAyANLQADaiEDIAVB2ABqEA0gBUFAaxANciAFQShqEA1yIAVBEGoQDXJFIQsMAQsLIAQgDksgByACS3INAEFsIQsgACAMSw0BIAxBfWohCQNAQQAgACAJSSAFQdgAahAEGwRAIAAgBiAFQdgAaiAIEAJBAnRqIgovAQA7AAAgBUHYAGogCi0AAhABIAAgCi0AA2oiACAGIAVB2ABqIAgQAkECdGoiCi8BADsAACAFQdgAaiAKLQACEAEgACAKLQADaiEADAEFIAxBfmohCgNAIAVB2ABqEAQgACAKS3JFBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgACAJLQADaiEADAELCwNAIAAgCk0EQCAAIAYgBUHYAGogCBACQQJ0aiIJLwEAOwAAIAVB2ABqIAktAAIQASAAIAktAANqIQAMAQsLAkAgACAMTw0AIAAgBiAFQdgAaiAIEAIiAEECdGoiDC0AADoAACAMLQADQQFGBEAgBUHYAGogDC0AAhABDAELIAUoAlxBH0sNACAFQdgAaiAGIABBAnRqLQACEAEgBSgCXEEhSQ0AIAVBIDYCXAsgAkF9aiEMA0BBACAHIAxJIAVBQGsQBBsEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiIAIAYgBUFAayAIEAJBAnRqIgcvAQA7AAAgBUFAayAHLQACEAEgACAHLQADaiEHDAEFIAJBfmohDANAIAVBQGsQBCAHIAxLckUEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwNAIAcgDE0EQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwJAIAcgAk8NACAHIAYgBUFAayAIEAIiAEECdGoiAi0AADoAACACLQADQQFGBEAgBUFAayACLQACEAEMAQsgBSgCREEfSw0AIAVBQGsgBiAAQQJ0ai0AAhABIAUoAkRBIUkNACAFQSA2AkQLIA5BfWohAgNAQQAgBCACSSAFQShqEAQbBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2oiACAGIAVBKGogCBACQQJ0aiIELwEAOwAAIAVBKGogBC0AAhABIAAgBC0AA2ohBAwBBSAOQX5qIQIDQCAFQShqEAQgBCACS3JFBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsDQCAEIAJNBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsCQCAEIA5PDQAgBCAGIAVBKGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBKGogAi0AAhABDAELIAUoAixBH0sNACAFQShqIAYgAEECdGotAAIQASAFKAIsQSFJDQAgBUEgNgIsCwNAQQAgAyAQSSAFQRBqEAQbBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2oiACAGIAVBEGogCBACQQJ0aiICLwEAOwAAIAVBEGogAi0AAhABIAAgAi0AA2ohAwwBBSAPQX5qIQIDQCAFQRBqEAQgAyACS3JFBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsDQCADIAJNBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsCQCADIA9PDQAgAyAGIAVBEGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBEGogAi0AAhABDAELIAUoAhRBH0sNACAFQRBqIAYgAEECdGotAAIQASAFKAIUQSFJDQAgBUEgNgIUCyABQWwgBUHYAGoQCiAFQUBrEApxIAVBKGoQCnEgBUEQahAKcRshCwwJCwAACwALAAALAAsAAAsACwAACwALQWwhCwsgBUHwAGokACALC7UEAQ5/IwBBEGsiBiQAIAZBBGogABAOQVQhBQJAIARB3AtJDQAgBi0ABCEHIANB8ARqQQBB7AAQECEIIAdBDEsNACADQdwJaiIJIAggBkEIaiAGQQxqIAEgAhAxIhAQA0UEQCAGKAIMIgQgB0sNASADQdwFaiEPIANBpAVqIREgAEEEaiESIANBqAVqIQEgBCEFA0AgBSICQX9qIQUgCCACQQJ0aigCAEUNAAsgAkEBaiEOQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgASALaiAKNgIAIAVBAWohBSAKIAxqIQoMAQsLIAEgCjYCAEEAIQUgBigCCCELA0AgBSALRkUEQCABIAUgCWotAAAiDEECdGoiDSANKAIAIg1BAWo2AgAgDyANQQF0aiINIAw6AAEgDSAFOgAAIAVBAWohBQwBCwtBACEBIANBADYCqAUgBEF/cyAHaiEJQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgAyALaiABNgIAIAwgBSAJanQgAWohASAFQQFqIQUMAQsLIAcgBEEBaiIBIAJrIgRrQQFqIQgDQEEBIQUgBCAIT0UEQANAIAUgDk9FBEAgBUECdCIJIAMgBEE0bGpqIAMgCWooAgAgBHY2AgAgBUEBaiEFDAELCyAEQQFqIQQMAQsLIBIgByAPIAogESADIAIgARBkIAZBAToABSAGIAc6AAYgACAGKAIENgIACyAQIQULIAZBEGokACAFC8ENAQt/IwBB8ABrIgUkAEFsIQkCQCADQQpJDQAgAi8AACEKIAIvAAIhDCACLwAEIQYgBUEIaiAEEA4CQCADIAYgCiAMampBBmoiDUkNACAFLQAKIQcgBUHYAGogAkEGaiICIAoQBiIJEAMNASAFQUBrIAIgCmoiAiAMEAYiCRADDQEgBUEoaiACIAxqIgIgBhAGIgkQAw0BIAVBEGogAiAGaiADIA1rEAYiCRADDQEgACABaiIOQX1qIQ8gBEEEaiEGQQEhCSAAIAFBA2pBAnYiAmoiCiACaiIMIAJqIg0hAyAMIQQgCiECA0AgCSADIA9JcQRAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAACAGIAVBQGsgBxACQQF0aiIILQAAIQsgBUFAayAILQABEAEgAiALOgAAIAYgBUEoaiAHEAJBAXRqIggtAAAhCyAFQShqIAgtAAEQASAEIAs6AAAgBiAFQRBqIAcQAkEBdGoiCC0AACELIAVBEGogCC0AARABIAMgCzoAACAGIAVB2ABqIAcQAkEBdGoiCC0AACELIAVB2ABqIAgtAAEQASAAIAs6AAEgBiAFQUBrIAcQAkEBdGoiCC0AACELIAVBQGsgCC0AARABIAIgCzoAASAGIAVBKGogBxACQQF0aiIILQAAIQsgBUEoaiAILQABEAEgBCALOgABIAYgBUEQaiAHEAJBAXRqIggtAAAhCyAFQRBqIAgtAAEQASADIAs6AAEgA0ECaiEDIARBAmohBCACQQJqIQIgAEECaiEAIAkgBUHYAGoQDUVxIAVBQGsQDUVxIAVBKGoQDUVxIAVBEGoQDUVxIQkMAQsLIAQgDUsgAiAMS3INAEFsIQkgACAKSw0BIApBfWohCQNAIAVB2ABqEAQgACAJT3JFBEAgBiAFQdgAaiAHEAJBAXRqIggtAAAhCyAFQdgAaiAILQABEAEgACALOgAAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAASAAQQJqIQAMAQsLA0AgBUHYAGoQBCAAIApPckUEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCwNAIAAgCkkEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCyAMQX1qIQADQCAFQUBrEAQgAiAAT3JFBEAgBiAFQUBrIAcQAkEBdGoiCi0AACEJIAVBQGsgCi0AARABIAIgCToAACAGIAVBQGsgBxACQQF0aiIKLQAAIQkgBUFAayAKLQABEAEgAiAJOgABIAJBAmohAgwBCwsDQCAFQUBrEAQgAiAMT3JFBEAgBiAFQUBrIAcQAkEBdGoiAC0AACEKIAVBQGsgAC0AARABIAIgCjoAACACQQFqIQIMAQsLA0AgAiAMSQRAIAYgBUFAayAHEAJBAXRqIgAtAAAhCiAFQUBrIAAtAAEQASACIAo6AAAgAkEBaiECDAELCyANQX1qIQADQCAFQShqEAQgBCAAT3JFBEAgBiAFQShqIAcQAkEBdGoiAi0AACEKIAVBKGogAi0AARABIAQgCjoAACAGIAVBKGogBxACQQF0aiICLQAAIQogBUEoaiACLQABEAEgBCAKOgABIARBAmohBAwBCwsDQCAFQShqEAQgBCANT3JFBEAgBiAFQShqIAcQAkEBdGoiAC0AACECIAVBKGogAC0AARABIAQgAjoAACAEQQFqIQQMAQsLA0AgBCANSQRAIAYgBUEoaiAHEAJBAXRqIgAtAAAhAiAFQShqIAAtAAEQASAEIAI6AAAgBEEBaiEEDAELCwNAIAVBEGoQBCADIA9PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIAYgBUEQaiAHEAJBAXRqIgAtAAAhAiAFQRBqIAAtAAEQASADIAI6AAEgA0ECaiEDDAELCwNAIAVBEGoQBCADIA5PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIANBAWohAwwBCwsDQCADIA5JBEAgBiAFQRBqIAcQAkEBdGoiAC0AACECIAVBEGogAC0AARABIAMgAjoAACADQQFqIQMMAQsLIAFBbCAFQdgAahAKIAVBQGsQCnEgBUEoahAKcSAFQRBqEApxGyEJDAELQWwhCQsgBUHwAGokACAJC8oCAQR/IwBBIGsiBSQAIAUgBBAOIAUtAAIhByAFQQhqIAIgAxAGIgIQA0UEQCAEQQRqIQIgACABaiIDQX1qIQQDQCAFQQhqEAQgACAET3JFBEAgAiAFQQhqIAcQAkEBdGoiBi0AACEIIAVBCGogBi0AARABIAAgCDoAACACIAVBCGogBxACQQF0aiIGLQAAIQggBUEIaiAGLQABEAEgACAIOgABIABBAmohAAwBCwsDQCAFQQhqEAQgACADT3JFBEAgAiAFQQhqIAcQAkEBdGoiBC0AACEGIAVBCGogBC0AARABIAAgBjoAACAAQQFqIQAMAQsLA0AgACADT0UEQCACIAVBCGogBxACQQF0aiIELQAAIQYgBUEIaiAELQABEAEgACAGOgAAIABBAWohAAwBCwsgAUFsIAVBCGoQChshAgsgBUEgaiQAIAILtgMBCX8jAEEQayIGJAAgBkEANgIMIAZBADYCCEFUIQQCQAJAIANBQGsiDCADIAZBCGogBkEMaiABIAIQMSICEAMNACAGQQRqIAAQDiAGKAIMIgcgBi0ABEEBaksNASAAQQRqIQogBkEAOgAFIAYgBzoABiAAIAYoAgQ2AgAgB0EBaiEJQQEhBANAIAQgCUkEQCADIARBAnRqIgEoAgAhACABIAU2AgAgACAEQX9qdCAFaiEFIARBAWohBAwBCwsgB0EBaiEHQQAhBSAGKAIIIQkDQCAFIAlGDQEgAyAFIAxqLQAAIgRBAnRqIgBBASAEdEEBdSILIAAoAgAiAWoiADYCACAHIARrIQhBACEEAkAgC0EDTQRAA0AgBCALRg0CIAogASAEakEBdGoiACAIOgABIAAgBToAACAEQQFqIQQMAAALAAsDQCABIABPDQEgCiABQQF0aiIEIAg6AAEgBCAFOgAAIAQgCDoAAyAEIAU6AAIgBCAIOgAFIAQgBToABCAEIAg6AAcgBCAFOgAGIAFBBGohAQwAAAsACyAFQQFqIQUMAAALAAsgAiEECyAGQRBqJAAgBAutAQECfwJAQYQgKAIAIABHIAAoAgBBAXYiAyABa0F4aiICQXhxQQhHcgR/IAIFIAMQJ0UNASACQQhqC0EQSQ0AIAAgACgCACICQQFxIAAgAWpBD2pBeHEiASAAa0EBdHI2AgAgASAANgIEIAEgASgCAEEBcSAAIAJBAXZqIAFrIgJBAXRyNgIAQYQgIAEgAkH/////B3FqQQRqQYQgKAIAIABGGyABNgIAIAEQJQsLygIBBX8CQAJAAkAgAEEIIABBCEsbZ0EfcyAAaUEBR2oiAUEESSAAIAF2cg0AIAFBAnRB/B5qKAIAIgJFDQADQCACQXhqIgMoAgBBAXZBeGoiBSAATwRAIAIgBUEIIAVBCEsbZ0Efc0ECdEGAH2oiASgCAEYEQCABIAIoAgQ2AgALDAMLIARBHksNASAEQQFqIQQgAigCBCICDQALC0EAIQMgAUEgTw0BA0AgAUECdEGAH2ooAgAiAkUEQCABQR5LIQIgAUEBaiEBIAJFDQEMAwsLIAIgAkF4aiIDKAIAQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgBGBEAgASACKAIENgIACwsgAigCACIBBEAgASACKAIENgIECyACKAIEIgEEQCABIAIoAgA2AgALIAMgAygCAEEBcjYCACADIAAQNwsgAwvhCwINfwV+IwBB8ABrIgckACAHIAAoAvDhASIINgJcIAEgAmohDSAIIAAoAoDiAWohDwJAAkAgBUUEQCABIQQMAQsgACgCxOABIRAgACgCwOABIREgACgCvOABIQ4gAEEBNgKM4QFBACEIA0AgCEEDRwRAIAcgCEECdCICaiAAIAJqQazQAWooAgA2AkQgCEEBaiEIDAELC0FsIQwgB0EYaiADIAQQBhADDQEgB0EsaiAHQRhqIAAoAgAQEyAHQTRqIAdBGGogACgCCBATIAdBPGogB0EYaiAAKAIEEBMgDUFgaiESIAEhBEEAIQwDQCAHKAIwIAcoAixBA3RqKQIAIhRCEIinQf8BcSEIIAcoAkAgBygCPEEDdGopAgAiFUIQiKdB/wFxIQsgBygCOCAHKAI0QQN0aikCACIWQiCIpyEJIBVCIIghFyAUQiCIpyECAkAgFkIQiKdB/wFxIgNBAk8EQAJAIAZFIANBGUlyRQRAIAkgB0EYaiADQSAgBygCHGsiCiAKIANLGyIKEAUgAyAKayIDdGohCSAHQRhqEAQaIANFDQEgB0EYaiADEAUgCWohCQwBCyAHQRhqIAMQBSAJaiEJIAdBGGoQBBoLIAcpAkQhGCAHIAk2AkQgByAYNwNIDAELAkAgA0UEQCACBEAgBygCRCEJDAMLIAcoAkghCQwBCwJAAkAgB0EYakEBEAUgCSACRWpqIgNBA0YEQCAHKAJEQX9qIgMgA0VqIQkMAQsgA0ECdCAHaigCRCIJIAlFaiEJIANBAUYNAQsgByAHKAJINgJMCwsgByAHKAJENgJIIAcgCTYCRAsgF6chAyALBEAgB0EYaiALEAUgA2ohAwsgCCALakEUTwRAIAdBGGoQBBoLIAgEQCAHQRhqIAgQBSACaiECCyAHQRhqEAQaIAcgB0EYaiAUQhiIp0H/AXEQCCAUp0H//wNxajYCLCAHIAdBGGogFUIYiKdB/wFxEAggFadB//8DcWo2AjwgB0EYahAEGiAHIAdBGGogFkIYiKdB/wFxEAggFqdB//8DcWo2AjQgByACNgJgIAcoAlwhCiAHIAk2AmggByADNgJkAkACQAJAIAQgAiADaiILaiASSw0AIAIgCmoiEyAPSw0AIA0gBGsgC0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY0AAQMyIFEAMiBg0AIANBHzYCfCADIANB/ABqIANB+ABqIAQgBCAFaiAGGyIEIAEgAmoiAiAEaxAVIgUQAw0AIAMoAnwiBkEfSw0AIAMoAngiB0EJTw0AIABBiCBqIAMgBkGAC0GADCAHEBggA0E0NgJ8IAMgA0H8AGogA0H4AGogBCAFaiIEIAIgBGsQFSIFEAMNACADKAJ8IgZBNEsNACADKAJ4IgdBCk8NACAAQZAwaiADIAZBgA1B4A4gBxAYIANBIzYCfCADIANB/ABqIANB+ABqIAQgBWoiBCACIARrEBUiBRADDQAgAygCfCIGQSNLDQAgAygCeCIHQQpPDQAgACADIAZBwBBB0BEgBxAYIAQgBWoiBEEMaiIFIAJLDQAgAiAFayEFQQAhAgNAIAJBA0cEQCAEKAAAIgZBf2ogBU8NAiAAIAJBAnRqQZzQAWogBjYCACACQQFqIQIgBEEEaiEEDAELCyAEIAFrIQgLIANBgAFqJAAgCAtGAQN/IABBCGohAyAAKAIEIQJBACEAA0AgACACdkUEQCABIAMgAEEDdGotAAJBFktqIQEgAEEBaiEADAELCyABQQggAmt0C4YDAQV/Qbh/IQcCQCADRQ0AIAItAAAiBEUEQCABQQA2AgBBAUG4fyADQQFGGw8LAn8gAkEBaiIFIARBGHRBGHUiBkF/Sg0AGiAGQX9GBEAgA0EDSA0CIAUvAABBgP4BaiEEIAJBA2oMAQsgA0ECSA0BIAItAAEgBEEIdHJBgIB+aiEEIAJBAmoLIQUgASAENgIAIAVBAWoiASACIANqIgNLDQBBbCEHIABBEGogACAFLQAAIgVBBnZBI0EJIAEgAyABa0HAEEHQEUHwEiAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBmCBqIABBCGogBUEEdkEDcUEfQQggASABIAZqIAgbIgEgAyABa0GAC0GADEGAFyAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBoDBqIABBBGogBUECdkEDcUE0QQkgASABIAZqIAgbIgEgAyABa0GADUHgDkGQGSAAKAKM4QEgACgCnOIBIAQQHyIAEAMNACAAIAFqIAJrIQcLIAcLrQMBCn8jAEGABGsiCCQAAn9BUiACQf8BSw0AGkFUIANBDEsNABogAkEBaiELIABBBGohCUGAgAQgA0F/anRBEHUhCkEAIQJBASEEQQEgA3QiB0F/aiIMIQUDQCACIAtGRQRAAkAgASACQQF0Ig1qLwEAIgZB//8DRgRAIAkgBUECdGogAjoAAiAFQX9qIQVBASEGDAELIARBACAKIAZBEHRBEHVKGyEECyAIIA1qIAY7AQAgAkEBaiECDAELCyAAIAQ7AQIgACADOwEAIAdBA3YgB0EBdmpBA2ohBkEAIQRBACECA0AgBCALRkUEQCABIARBAXRqLgEAIQpBACEAA0AgACAKTkUEQCAJIAJBAnRqIAQ6AAIDQCACIAZqIAxxIgIgBUsNAAsgAEEBaiEADAELCyAEQQFqIQQMAQsLQX8gAg0AGkEAIQIDfyACIAdGBH9BAAUgCCAJIAJBAnRqIgAtAAJBAXRqIgEgAS8BACIBQQFqOwEAIAAgAyABEBRrIgU6AAMgACABIAVB/wFxdCAHazsBACACQQFqIQIMAQsLCyEFIAhBgARqJAAgBQvjBgEIf0FsIQcCQCACQQNJDQACQAJAAkACQCABLQAAIgNBA3EiCUEBaw4DAwEAAgsgACgCiOEBDQBBYg8LIAJBBUkNAkEDIQYgASgAACEFAn8CQAJAIANBAnZBA3EiCEF+aiIEQQFNBEAgBEEBaw0BDAILIAVBDnZB/wdxIQQgBUEEdkH/B3EhAyAIRQwCCyAFQRJ2IQRBBCEGIAVBBHZB//8AcSEDQQAMAQsgBUEEdkH//w9xIgNBgIAISw0DIAEtAARBCnQgBUEWdnIhBEEFIQZBAAshBSAEIAZqIgogAksNAgJAIANBgQZJDQAgACgCnOIBRQ0AQQAhAgNAIAJBg4ABSw0BIAJBQGshAgwAAAsACwJ/IAlBA0YEQCABIAZqIQEgAEHw4gFqIQIgACgCDCEGIAUEQCACIAMgASAEIAYQXwwCCyACIAMgASAEIAYQXQwBCyAAQbjQAWohAiABIAZqIQEgAEHw4gFqIQYgAEGo0ABqIQggBQRAIAggBiADIAEgBCACEF4MAQsgCCAGIAMgASAEIAIQXAsQAw0CIAAgAzYCgOIBIABBATYCiOEBIAAgAEHw4gFqNgLw4QEgCUECRgRAIAAgAEGo0ABqNgIMCyAAIANqIgBBiOMBakIANwAAIABBgOMBakIANwAAIABB+OIBakIANwAAIABB8OIBakIANwAAIAoPCwJ/AkACQAJAIANBAnZBA3FBf2oiBEECSw0AIARBAWsOAgACAQtBASEEIANBA3YMAgtBAiEEIAEvAABBBHYMAQtBAyEEIAEQIUEEdgsiAyAEaiIFQSBqIAJLBEAgBSACSw0CIABB8OIBaiABIARqIAMQCyEBIAAgAzYCgOIBIAAgATYC8OEBIAEgA2oiAEIANwAYIABCADcAECAAQgA3AAggAEIANwAAIAUPCyAAIAM2AoDiASAAIAEgBGo2AvDhASAFDwsCfwJAAkACQCADQQJ2QQNxQX9qIgRBAksNACAEQQFrDgIAAgELQQEhByADQQN2DAILQQIhByABLwAAQQR2DAELIAJBBEkgARAhIgJBj4CAAUtyDQFBAyEHIAJBBHYLIQIgAEHw4gFqIAEgB2otAAAgAkEgahAQIQEgACACNgKA4gEgACABNgLw4QEgB0EBaiEHCyAHC0sAIABC+erQ0OfJoeThADcDICAAQgA3AxggAELP1tO+0ser2UI3AxAgAELW64Lu6v2J9eAANwMIIABCADcDACAAQShqQQBBKBAQGgviAgICfwV+IABBKGoiASAAKAJIaiECAn4gACkDACIDQiBaBEAgACkDECIEQgeJIAApAwgiBUIBiXwgACkDGCIGQgyJfCAAKQMgIgdCEol8IAUQGSAEEBkgBhAZIAcQGQwBCyAAKQMYQsXP2bLx5brqJ3wLIAN8IQMDQCABQQhqIgAgAk0EQEIAIAEpAAAQCSADhUIbiUKHla+vmLbem55/fkLj3MqV/M7y9YV/fCEDIAAhAQwBCwsCQCABQQRqIgAgAksEQCABIQAMAQsgASgAAK1Ch5Wvr5i23puef34gA4VCF4lCz9bTvtLHq9lCfkL5893xmfaZqxZ8IQMLA0AgACACSQRAIAAxAABCxc/ZsvHluuonfiADhUILiUKHla+vmLbem55/fiEDIABBAWohAAwBCwsgA0IhiCADhULP1tO+0ser2UJ+IgNCHYggA4VC+fPd8Zn2masWfiIDQiCIIAOFC+8CAgJ/BH4gACAAKQMAIAKtfDcDAAJAAkAgACgCSCIDIAJqIgRBH00EQCABRQ0BIAAgA2pBKGogASACECAgACgCSCACaiEEDAELIAEgAmohAgJ/IAMEQCAAQShqIgQgA2ogAUEgIANrECAgACAAKQMIIAQpAAAQCTcDCCAAIAApAxAgACkAMBAJNwMQIAAgACkDGCAAKQA4EAk3AxggACAAKQMgIABBQGspAAAQCTcDICAAKAJIIQMgAEEANgJIIAEgA2tBIGohAQsgAUEgaiACTQsEQCACQWBqIQMgACkDICEFIAApAxghBiAAKQMQIQcgACkDCCEIA0AgCCABKQAAEAkhCCAHIAEpAAgQCSEHIAYgASkAEBAJIQYgBSABKQAYEAkhBSABQSBqIgEgA00NAAsgACAFNwMgIAAgBjcDGCAAIAc3AxAgACAINwMICyABIAJPDQEgAEEoaiABIAIgAWsiBBAgCyAAIAQ2AkgLCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQEBogAwVBun8LCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQCxogAwVBun8LC6gCAQZ/IwBBEGsiByQAIABB2OABaikDAEKAgIAQViEIQbh/IQUCQCAEQf//B0sNACAAIAMgBBBCIgUQAyIGDQAgACgCnOIBIQkgACAHQQxqIAMgAyAFaiAGGyIKIARBACAFIAYbayIGEEAiAxADBEAgAyEFDAELIAcoAgwhBCABRQRAQbp/IQUgBEEASg0BCyAGIANrIQUgAyAKaiEDAkAgCQRAIABBADYCnOIBDAELAkACQAJAIARBBUgNACAAQdjgAWopAwBCgICACFgNAAwBCyAAQQA2ApziAQwBCyAAKAIIED8hBiAAQQA2ApziASAGQRRPDQELIAAgASACIAMgBSAEIAgQOSEFDAELIAAgASACIAMgBSAEIAgQOiEFCyAHQRBqJAAgBQtnACAAQdDgAWogASACIAAoAuzhARAuIgEQAwRAIAEPC0G4fyECAkAgAQ0AIABB7OABaigCACIBBEBBYCECIAAoApjiASABRw0BC0EAIQIgAEHw4AFqKAIARQ0AIABBkOEBahBDCyACCycBAX8QVyIERQRAQUAPCyAEIAAgASACIAMgBBBLEE8hACAEEFYgAAs/AQF/AkACQAJAIAAoAqDiAUEBaiIBQQJLDQAgAUEBaw4CAAECCyAAEDBBAA8LIABBADYCoOIBCyAAKAKU4gELvAMCB38BfiMAQRBrIgkkAEG4fyEGAkAgBCgCACIIQQVBCSAAKALs4QEiBRtJDQAgAygCACIHQQFBBSAFGyAFEC8iBRADBEAgBSEGDAELIAggBUEDakkNACAAIAcgBRBJIgYQAw0AIAEgAmohCiAAQZDhAWohCyAIIAVrIQIgBSAHaiEHIAEhBQNAIAcgAiAJECwiBhADDQEgAkF9aiICIAZJBEBBuH8hBgwCCyAJKAIAIghBAksEQEFsIQYMAgsgB0EDaiEHAn8CQAJAAkAgCEEBaw4CAgABCyAAIAUgCiAFayAHIAYQSAwCCyAFIAogBWsgByAGEEcMAQsgBSAKIAVrIActAAAgCSgCCBBGCyIIEAMEQCAIIQYMAgsgACgC8OABBEAgCyAFIAgQRQsgAiAGayECIAYgB2ohByAFIAhqIQUgCSgCBEUNAAsgACkD0OABIgxCf1IEQEFsIQYgDCAFIAFrrFINAQsgACgC8OABBEBBaiEGIAJBBEkNASALEEQhDCAHKAAAIAynRw0BIAdBBGohByACQXxqIQILIAMgBzYCACAEIAI2AgAgBSABayEGCyAJQRBqJAAgBgsuACAAECsCf0EAQQAQAw0AGiABRSACRXJFBEBBYiAAIAEgAhA9EAMNARoLQQALCzcAIAEEQCAAIAAoAsTgASABKAIEIAEoAghqRzYCnOIBCyAAECtBABADIAFFckUEQCAAIAEQWwsL0QIBB38jAEEQayIGJAAgBiAENgIIIAYgAzYCDCAFBEAgBSgCBCEKIAUoAgghCQsgASEIAkACQANAIAAoAuzhARAWIQsCQANAIAQgC0kNASADKAAAQXBxQdDUtMIBRgRAIAMgBBAiIgcQAw0EIAQgB2shBCADIAdqIQMMAQsLIAYgAzYCDCAGIAQ2AggCQCAFBEAgACAFEE5BACEHQQAQA0UNAQwFCyAAIAogCRBNIgcQAw0ECyAAIAgQUCAMQQFHQQAgACAIIAIgBkEMaiAGQQhqEEwiByIDa0EAIAMQAxtBCkdyRQRAQbh/IQcMBAsgBxADDQMgAiAHayECIAcgCGohCEEBIQwgBigCDCEDIAYoAgghBAwBCwsgBiADNgIMIAYgBDYCCEG4fyEHIAQNASAIIAFrIQcMAQsgBiADNgIMIAYgBDYCCAsgBkEQaiQAIAcLRgECfyABIAAoArjgASICRwRAIAAgAjYCxOABIAAgATYCuOABIAAoArzgASEDIAAgATYCvOABIAAgASADIAJrajYCwOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ";class Qd extends a.FvD{constructor(e,t,n){super(void 0,e[0].width,e[0].height,t,n,a.hy7),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}}class Nd extends a.FvD{constructor(e,t,n,r,i,s){super(e,t,n,i,s),this.isCompressedArrayTexture=!0,this.image.depth=r,this.wrapR=a.ghU}}class zd extends a.gPd{constructor(e=null,t=1,n=1,r=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:n,depth:r},this.magFilter=a.hxR,this.minFilter=a.hxR,this.wrapR=a.ghU,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}var Gd=Object.defineProperty,Hd=(e,t,n)=>(((e,t,n)=>{t in e?Gd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const qd=3e3,Yd=3001,jd="srgb",Vd=new WeakMap;let Kd,Wd=0;const Jd=(()=>{const e=class extends a.aHM{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new Ad,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},e.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this}init(){if(!this.transcoderPending){const t=new a.Y9S(this.manager);t.setPath(this.transcoderPath),t.setWithCredentials(this.withCredentials);const n=t.loadAsync("basis_transcoder.js"),r=new a.Y9S(this.manager);r.setPath(this.transcoderPath),r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials);const i=r.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([n,i]).then((([t,n])=>{const r=e.BasisWorker.toString(),i=["/* constants */","let _EngineFormat = "+JSON.stringify(e.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(e.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(e.BasisFormat),"/* basis_transcoder.js */",t,"/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i])),this.transcoderBinary=n,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e}))})),Wd>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Wd++}return this.transcoderPending}load(e,t,n,r){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const i=new a.Y9S(this.manager);i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials),i.load(e,(e=>{if(Vd.has(e)){return Vd.get(e).promise.then(t).catch(r)}this._createTexture(e).then((e=>t?t(e):null)).catch(r)}),n,r)}_createTextureFrom(e,t){const{faces:n,width:r,height:i,format:s,type:o,error:l,dfdFlags:c}=e;if("error"===o)return Promise.reject(l);let h;if(6===t.faceCount)h=new Qd(n,s,a.OUM);else{const e=n[0].mipmaps;h=t.layerCount>1?new Nd(e,r,i,t.layerCount,s,a.OUM):new a.FvD(e,r,i,s,a.OUM)}h.minFilter=1===n[0].mipmaps.length?a.k6q:a.$_I,h.magFilter=a.k6q,h.generateMipmaps=!1,h.needsUpdate=!0;const u=ef(t);return"colorSpace"in h?h.colorSpace=u:h.encoding=u===jd?3001:3e3,h.premultiplyAlpha=!!(1&c),h}async _createTexture(e,t={}){const n=function(e){const t=new Uint8Array(e.buffer,e.byteOffset,Rd.length);if(t[0]!==Rd[0]||t[1]!==Rd[1]||t[2]!==Rd[2]||t[3]!==Rd[3]||t[4]!==Rd[4]||t[5]!==Rd[5]||t[6]!==Rd[6]||t[7]!==Rd[7]||t[8]!==Rd[8]||t[9]!==Rd[9]||t[10]!==Rd[10]||t[11]!==Rd[11])throw new Error("Missing KTX 2.0 identifier.");const n=new _d,r=17*Uint32Array.BYTES_PER_ELEMENT,i=new Md(e,Rd.length,r,!0);n.vkFormat=i._nextUint32(),n.typeSize=i._nextUint32(),n.pixelWidth=i._nextUint32(),n.pixelHeight=i._nextUint32(),n.pixelDepth=i._nextUint32(),n.layerCount=i._nextUint32(),n.faceCount=i._nextUint32();const s=i._nextUint32();n.supercompressionScheme=i._nextUint32();const a=i._nextUint32(),o=i._nextUint32(),l=i._nextUint32(),c=i._nextUint32(),h=i._nextUint64(),u=i._nextUint64(),d=new Md(e,Rd.length+r,3*s*8,!0);for(let P=0;P<s;P++)n.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});const f=new Md(e,a,o,!0),A={vendorId:f._skip(4)._nextUint16(),descriptorType:f._nextUint16(),versionNumber:f._nextUint16(),descriptorBlockSize:f._nextUint16(),colorModel:f._nextUint8(),colorPrimaries:f._nextUint8(),transferFunction:f._nextUint8(),flags:f._nextUint8(),texelBlockDimension:[f._nextUint8(),f._nextUint8(),f._nextUint8(),f._nextUint8()],bytesPlane:[f._nextUint8(),f._nextUint8(),f._nextUint8(),f._nextUint8(),f._nextUint8(),f._nextUint8(),f._nextUint8(),f._nextUint8()],samples:[]},m=(A.descriptorBlockSize/4-6)/4;for(let P=0;P<m;P++){const e={bitOffset:f._nextUint16(),bitLength:f._nextUint8(),channelType:f._nextUint8(),samplePosition:[f._nextUint8(),f._nextUint8(),f._nextUint8(),f._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&e.channelType?(e.sampleLower=f._nextInt32(),e.sampleUpper=f._nextInt32()):(e.sampleLower=f._nextUint32(),e.sampleUpper=f._nextUint32()),A.samples[P]=e}n.dataFormatDescriptor.length=0,n.dataFormatDescriptor.push(A);const p=new Md(e,l,c,!0);for(;p._offset<c;){const e=p._nextUint32(),t=p._scan(e),r=Dd(t);if(n.keyValue[r]=p._nextUint8Array(e-t.byteLength-1),r.match(/^ktx/i)){const e=Dd(n.keyValue[r]);n.keyValue[r]=e.substring(0,e.lastIndexOf("\0"))}const i=e%4?4-e%4:0;p._skip(i)}if(u<=0)return n;const g=new Md(e,h,u,!0),v=g._nextUint16(),y=g._nextUint16(),E=g._nextUint32(),x=g._nextUint32(),C=g._nextUint32(),w=g._nextUint32(),I=[];for(let P=0;P<s;P++)I.push({imageFlags:g._nextUint32(),rgbSliceByteOffset:g._nextUint32(),rgbSliceByteLength:g._nextUint32(),alphaSliceByteOffset:g._nextUint32(),alphaSliceByteLength:g._nextUint32()});const b=h+g._offset,S=b+E,B=S+x,T=B+C,_=new Uint8Array(e.buffer,e.byteOffset+b,E),M=new Uint8Array(e.buffer,e.byteOffset+S,x),R=new Uint8Array(e.buffer,e.byteOffset+B,C),D=new Uint8Array(e.buffer,e.byteOffset+T,w);return n.globalData={endpointCount:v,selectorCount:y,imageDescs:I,endpointsData:_,selectorsData:M,tablesData:R,extendedData:D},n}(new Uint8Array(e));if(0!==n.vkFormat)return async function(e){const{vkFormat:t}=e;if(void 0===$d[t])throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let n;2===e.supercompressionScheme&&(Kd||(Kd=new Promise((async e=>{const t=new Od;await t.init(),e(t)}))),n=await Kd);const r=[];for(let o=0;o<e.levels.length;o++){const i=Math.max(1,e.pixelWidth>>o),s=Math.max(1,e.pixelHeight>>o),l=e.pixelDepth?Math.max(1,e.pixelDepth>>o):0,c=e.levels[o];let h,u;if(0===e.supercompressionScheme)h=c.levelData;else{if(2!==e.supercompressionScheme)throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");h=n.decode(c.levelData,c.uncompressedByteLength)}u=Zd[t]===a.RQf?new Float32Array(h.buffer,h.byteOffset,h.byteLength/Float32Array.BYTES_PER_ELEMENT):Zd[t]===a.ix0?new Uint16Array(h.buffer,h.byteOffset,h.byteLength/Uint16Array.BYTES_PER_ELEMENT):h,r.push({data:u,width:i,height:s,depth:l})}let i;if(Xd.has($d[t]))i=0===e.pixelDepth?new a.GYF(r[0].data,e.pixelWidth,e.pixelHeight):new zd(r[0].data,e.pixelWidth,e.pixelHeight,e.pixelDepth);else{if(e.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");i=new a.FvD(r,e.pixelWidth,e.pixelHeight)}i.mipmaps=r,i.type=Zd[t],i.format=$d[t],i.needsUpdate=!0;const s=ef(e);"colorSpace"in i?i.colorSpace=s:i.encoding=s===jd?Yd:qd;return Promise.resolve(i)}(n);const r=t,i=this.init().then((()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:r},[e]))).then((e=>this._createTextureFrom(e.data,n)));return Vd.set(e,{promise:i}),i}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),Wd--,this}};let t=e;return Hd(t,"BasisFormat",{ETC1S:0,UASTC_4x4:1}),Hd(t,"TranscoderFormat",{ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16}),Hd(t,"EngineFormat",{RGBAFormat:a.GWd,RGBA_ASTC_4x4_Format:a.qa3,RGBA_BPTC_Format:a.Fn,RGBA_ETC2_EAC_Format:a.KDk,RGBA_PVRTC_4BPPV1_Format:a.HXV,RGBA_S3TC_DXT5_Format:a.BXX,RGB_ETC1_Format:a.CVz,RGB_ETC2_Format:a.Riy,RGB_PVRTC_4BPPV1_Format:a.k6Q,RGB_S3TC_DXT1_Format:a.IE4}),Hd(t,"BasisWorker",(function(){let e,t,n;const r=_EngineFormat,i=_TranscoderFormat,s=_BasisFormat;self.addEventListener("message",(function(a){const u=a.data;switch(u.type){case"init":e=u.config,d=u.transcoderBinary,t=new Promise((e=>{n={wasmBinary:d,onRuntimeInitialized:e},BASIS(n)})).then((()=>{n.initializeBasis(),void 0===n.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")}));break;case"transcode":t.then((()=>{try{const{faces:t,buffers:a,width:d,height:f,hasAlpha:A,format:m,dfdFlags:p}=function(t){const a=new n.KTX2File(new Uint8Array(t));function u(){a.close(),a.delete()}if(!a.isValid())throw u(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");const d=a.isUASTC()?s.UASTC_4x4:s.ETC1S,f=a.getWidth(),A=a.getHeight(),m=a.getLayers()||1,p=a.getLevels(),g=a.getFaces(),v=a.getHasAlpha(),y=a.getDFDFlags(),{transcoderFormat:E,engineFormat:x}=function(t,n,a,h){let u,d;const f=t===s.ETC1S?o:l;for(let r=0;r<f.length;r++){const i=f[r];if(e[i.if]&&(i.basisFormat.includes(t)&&!(h&&i.transcoderFormat.length<2)&&(!i.needsPowerOfTwo||c(n)&&c(a))))return u=i.transcoderFormat[h?1:0],d=i.engineFormat[h?1:0],{transcoderFormat:u,engineFormat:d}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),u=i.RGBA32,d=r.RGBAFormat,{transcoderFormat:u,engineFormat:d}}(d,f,A,v);if(!f||!A||!p)throw u(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!a.startTranscoding())throw u(),new Error("THREE.KTX2Loader: .startTranscoding failed");const C=[],w=[];for(let e=0;e<g;e++){const t=[];for(let n=0;n<p;n++){const r=[];let i,s;for(let t=0;t<m;t++){const o=a.getImageLevelInfo(n,t,e);0!==e||0!==n||0!==t||o.origWidth%4==0&&o.origHeight%4==0||console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),p>1?(i=o.origWidth,s=o.origHeight):(i=o.width,s=o.height);const l=new Uint8Array(a.getImageTranscodedSizeInBytes(n,t,0,E));if(!a.transcodeImage(l,n,t,e,E,0,-1,-1))throw u(),new Error("THREE.KTX2Loader: .transcodeImage failed.");r.push(l)}const o=h(r);t.push({data:o,width:i,height:s}),w.push(o.buffer)}C.push({mipmaps:t,width:f,height:A,format:x})}return u(),{faces:C,buffers:w,width:f,height:A,hasAlpha:v,format:x,dfdFlags:y}}(u.buffer);self.postMessage({type:"transcode",id:u.id,faces:t,width:d,height:f,hasAlpha:A,format:m,dfdFlags:p},a)}catch(t){console.error(t),self.postMessage({type:"error",id:u.id,error:t.message})}}))}var d}));const a=[{if:"astcSupported",basisFormat:[s.UASTC_4x4],transcoderFormat:[i.ASTC_4x4,i.ASTC_4x4],engineFormat:[r.RGBA_ASTC_4x4_Format,r.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.BC7_M5,i.BC7_M5],engineFormat:[r.RGBA_BPTC_Format,r.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.BC1,i.BC3],engineFormat:[r.RGB_S3TC_DXT1_Format,r.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.ETC1,i.ETC2],engineFormat:[r.RGB_ETC2_Format,r.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.ETC1],engineFormat:[r.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.PVRTC1_4_RGB,i.PVRTC1_4_RGBA],engineFormat:[r.RGB_PVRTC_4BPPV1_Format,r.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],o=a.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),l=a.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function c(e){return e<=2||!(e&e-1)&&0!==e}function h(e){if(1===e.length)return e[0];let t=0;for(let i=0;i<e.length;i++){t+=e[i].byteLength}const n=new Uint8Array(t);let r=0;for(let i=0;i<e.length;i++){const t=e[i];n.set(t,r),r+=t.byteLength}return n}})),t})(),Xd=new Set([a.GWd,a.paN,a.VT0]),$d={[Sd]:a.GWd,[wd]:a.GWd,[yd]:a.GWd,[Ed]:a.GWd,[bd]:a.paN,[Cd]:a.paN,[gd]:a.paN,[vd]:a.paN,[Id]:a.VT0,[xd]:a.VT0,[pd]:a.VT0,[md]:a.VT0,[Td]:a.Qrf,[Bd]:a.Qrf},Zd={[Sd]:a.RQf,[wd]:a.ix0,[yd]:a.OUM,[Ed]:a.OUM,[bd]:a.RQf,[Cd]:a.ix0,[gd]:a.OUM,[vd]:a.OUM,[Id]:a.RQf,[xd]:a.ix0,[pd]:a.OUM,[md]:a.OUM,[Td]:a.OUM,[Bd]:a.OUM};function ef(e){const t=e.dataFormatDescriptor[0];return 1===t.colorPrimaries?2===t.transferFunction?jd:"srgb-linear":10===t.colorPrimaries?2===t.transferFunction?"display-p3":"display-p3-linear":(0===t.colorPrimaries||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${t.colorPrimaries}"`),"")}const tf="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master";function nf(e,t=`${tf}/basis/`){const n=(0,o.A)((e=>e.gl)),r=(0,o.F)(Jd,oa(e)?Object.values(e):e,(e=>{e.detectSupport(n),e.setTranscoderPath(t)}));if((0,i.useEffect)((()=>{(Array.isArray(r)?r:[r]).forEach(n.initTexture)}),[n,r]),oa(e)){const t=Object.keys(e),n={};return t.forEach((e=>Object.assign(n,{[e]:r[t.indexOf(e)]}))),n}return r}nf.preload=(e,t=`${tf}/basis/`)=>o.F.preload(Jd,e,(e=>{e.setTranscoderPath(t)})),nf.clear=e=>o.F.clear(Jd,e);const rf=({children:e,input:t,basisPath:n})=>{const r=nf(t,n);return i.createElement(i.Fragment,null,null==e?void 0:e(r))};var sf=n(4945);const af=((e,t)=>"undefined"!=typeof window&&"function"==typeof(null==(e=window.document)?void 0:e.createElement)&&"string"==typeof(null==(t=window.navigator)?void 0:t.userAgent))();let of=null;function lf(e,{unsuspend:t="loadedmetadata",start:r=!0,hls:s={},crossOrigin:l="anonymous",muted:c=!0,loop:h=!0,playsInline:u=!0,onVideoFrame:d,...f}={}){const A=(0,o.A)((e=>e.gl)),m=(0,i.useRef)(null),p=(0,Cs.DY)((()=>new Promise((async r=>{let i,o;"string"==typeof e?i=e:o=e;const d=Object.assign(document.createElement("video"),{src:i,srcObject:o,crossOrigin:l,loop:h,muted:c,playsInline:u,...f});if(i&&af&&i.endsWith(".m3u8")){const e=m.current=await async function(...e){var t;null!==(t=of)&&void 0!==t||(of=await Promise.resolve().then(n.bind(n,4945)));const r=of.default;return r.isSupported()?new r(...e):null}(s);e&&(e.on(sf.Events.MEDIA_ATTACHED,(()=>{e.loadSource(i)})),e.attachMedia(d))}const p=new a.Nv2(d);p.colorSpace=A.outputColorSpace,d.addEventListener(t,(()=>r(p)))}))),[e]),g=p.source.data;return hf(g,d),(0,i.useEffect)((()=>(r&&p.image.play(),()=>{m.current&&(m.current.destroy(),m.current=null)})),[p,r]),p}const cf=(0,i.forwardRef)((({children:e,src:t,...n},r)=>{const s=lf(t,n);return(0,i.useEffect)((()=>()=>{s.dispose()}),[s]),(0,i.useImperativeHandle)(r,(()=>s),[s]),i.createElement(i.Fragment,null,null==e?void 0:e(s))})),hf=(e,t)=>{(0,i.useEffect)((()=>{if(!t)return;if(!e.requestVideoFrameCallback)return;let n;const r=(...i)=>{t(...i),n=e.requestVideoFrameCallback(r)};return e.requestVideoFrameCallback(r),()=>e.cancelVideoFrameCallback(n)}),[e,t])},uf=(e,t)=>{if(Array.isArray(e))return e[0];return e[null!=t?t:Object.keys(e)[0]][0]},df=e=>{for(let t=3;t<e.length;t+=4)if(0!==e[t])return!1;return!0};function ff(e,t,n,r,s,l){const c=i.useRef((0,o.A)((e=>e.viewport))),h=i.useRef(null),u=i.useRef(0),d=i.useRef(e),f=i.useRef(t),A=i.useRef(n),[m,p]=(0,i.useState)(null),[g,v]=i.useState(new a.gPd),y=i.useMemo((()=>new a.Tap),[]),[E,x]=(0,i.useState)(null),C=i.useCallback(((e,t,n)=>{const r=t*(c.current.aspect>e/t?c.current.width/e:c.current.height/t),i=e*(c.current.aspect>e/t?c.current.width/e:c.current.height/t)*n,s=r*n;let o=Math.min(1,i),l=Math.min(1,s);return i>1&&(o=1,l=s/i*1),new a.Pq0(o,l,1)}),[]),w=i.useCallback(((e,t)=>{if(e.image){const n=document.createElement("canvas"),r=n.getContext("2d",l);if(!r)throw new Error("Failed to get 2d context");n.width=e.image.width,n.height=e.image.height,r.drawImage(e.image,0,0);const i=e.image.width,s=e.image.height,a=Math.round(Math.sqrt(t*(i/s))),o=Math.round(t/a),c=i/a,h=s/o,u=[];for(let e=0;e<o;e++)for(let n=0;n<a;n++){if(e*a+n>=t){u.push({row:e,col:n});continue}const i=r.getImageData(n*c,e*h,c,h).data;df(i)&&u.push({row:e,col:n})}return{rows:o,columns:a,frameWidth:c,frameHeight:h,emptyFrames:u}}return{rows:0,columns:0,frameWidth:0,frameHeight:0,emptyFrames:[]}}),[l]),I=i.useCallback((e=>{const t=e=>{let t=null;for(const n of e){const{w:e,h:r}=n.frame,i=e*r;(!t||i>t.area)&&(t={w:e,h:r,area:i})}return e.map((e=>{const{w:n,h:r}=e.frame,i=n*r,s=t?i===t.area?1:Math.sqrt(i/t.area):1;return{...e,scaleRatio:s}}))};if(Array.isArray(e))return t(e);{const n={};for(const r in e)n[r]=t(e[r]);return n}}),[]),b=i.useCallback((()=>{const e={},t=h.current,n=A.current;if(t){if(n&&Array.isArray(t.frames)){for(let r=0;r<n.length;r++){e[n[r]]=[];for(const i of t.frames){const t=i.frame,s=i.sourceSize.w,a=i.sourceSize.h;"string"==typeof i.filename&&-1!==i.filename.toLowerCase().indexOf(n[r].toLowerCase())&&e[n[r]].push({...i,frame:t,sourceSize:{w:s,h:a}})}}for(const t in e){const n=I(e[t]);Array.isArray(n)&&(e[t]=n)}return e}if(n&&"object"==typeof t.frames){for(let r=0;r<n.length;r++){e[n[r]]=[];for(const i in t.frames){const s=t.frames[i],a=s.frame,o=s.sourceSize.w,l=s.sourceSize.h;"string"==typeof i&&-1!==i.toLowerCase().indexOf(n[r].toLowerCase())&&e[n[r]].push({...s,frame:a,sourceSize:{w:o,h:l}})}}for(const t in e){const n=I(e[t]);Array.isArray(n)&&(e[t]=n)}return e}{let e=[];return null!=t&&t.frames&&(e=Array.isArray(t.frames)?t.frames.map((e=>({...e,x:e.frame.x,y:e.frame.y,w:e.frame.w,h:e.frame.h}))):Object.values(t.frames).flat().map((e=>({...e,x:e.frame.x,y:e.frame.y,w:e.frame.w,h:e.frame.h})))),I(e)}}return[]}),[I,h]),S=i.useCallback(((e,t)=>{let n=new a.Pq0(1,1,1);if(null===e){if(t&&r){const e=t.image.width,i=t.image.height;u.current=r;const{rows:s,columns:a,frameWidth:o,frameHeight:l,emptyFrames:c}=w(t,r),d={frames:[],meta:{version:"1.0",size:{w:e,h:i},rows:s,columns:a,frameWidth:o,frameHeight:l,scale:"1"}};for(let t=0;t<s;t++)for(let e=0;e<a;e++){(null!=c?c:[]).some((n=>n.row===t&&n.col===e))||Array.isArray(d.frames)&&d.frames.push({frame:{x:e*o,y:t*l,w:o,h:l},scaleRatio:1,rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:o,h:l},sourceSize:{w:o,h:l}})}n=C(o,l,.1),h.current=d}h.current&&h.current.frames&&(h.current.frames=I(h.current.frames))}else if(t){h.current=e,h.current.frames=b(),u.current=Array.isArray(e.frames)?e.frames.length:Object.keys(e.frames).length;const{w:t,h:r}=uf(e.frames).sourceSize;n=C(t,r,.1)}p(h.current),"encoding"in t?t.encoding=3001:"colorSpace"in t&&(t.colorSpace=a.er$),v(t),x({spriteTexture:t,spriteData:h.current,aspect:n})}),[w,r,b,C,I]),B=i.useCallback(((e,t,n)=>{const r=fetch(e).then((e=>e.json())),i=new Promise((e=>{y.load(t,e)}));Promise.all([r,i]).then((e=>{n(e[0],e[1])}))}),[y]),T=i.useCallback((e=>{if(!e&&!d.current)throw new Error("Either textureUrl or input must be provided");const t=null!=e?e:d.current;if(!t)throw new Error("A valid texture URL must be provided");y.load(t,(e=>S(null,e)))}),[y,S]),_=i.useCallback(((e,t)=>{t&&e?B(t,e,S):T(e)}),[B,T,S]);return i.useLayoutEffect((()=>{f.current&&d.current?B(f.current,d.current,S):d.current&&T();const e=d.current;return()=>{e&&o.F.clear(a.Tap,e)}}),[B,T,S]),i.useLayoutEffect((()=>{null==s||s(g,null!=m?m:null)}),[g,m,s]),{spriteObj:E,loadJsonAndTexture:_}}function Af(e,t,...n){const r=i.useRef(null),s=(0,o.A)((e=>e.scene));return i.useLayoutEffect((()=>{let i;if(e&&null!=e&&e.current&&t&&(r.current=i=new t(e.current,...n)),i)return i.traverse((e=>e.raycast=()=>null)),s.add(i),()=>{r.current=void 0,s.remove(i),null==i.dispose||i.dispose()}}),[s,t,e,...n]),(0,o.C)((()=>{var e;null==(e=r.current)||null==e.update||e.update()})),r}ff.preload=e=>o.F.preload(a.Tap,e),ff.clear=e=>o.F.clear(a.Tap,e);const mf=({type:e,args:t=[]})=>{const n=i.useRef(null),r=i.useRef(null);return i.useLayoutEffect((()=>{r.current=n.current.parent})),Af(r,e,...t),i.createElement("object3D",{ref:n})};var pf=n(6571),gf=n.n(pf);function vf(e,t){"function"==typeof e?e(t):null!=e&&(e.current=t)}function yf({showPanel:e=0,className:t,parent:n}){const r=function(e,t=[],n){const[r,s]=i.useState();return i.useLayoutEffect((()=>{const t=e();return s(t),vf(n,t),()=>vf(n,null)}),t),r}((()=>new(gf())),[]);return i.useEffect((()=>{if(r){const i=n&&n.current||document.body;r.showPanel(e),null==i||i.appendChild(r.dom);const s=(null!=t?t:"").split(" ").filter((e=>e));s.length&&r.dom.classList.add(...s);const a=(0,o.j)((()=>r.begin())),l=(0,o.k)((()=>r.end()));return()=>{s.length&&r.dom.classList.remove(...s),null==i||i.removeChild(r.dom),a(),l()}}}),[n,r,t,e]),null}const Ef=class e{constructor({trackGPU:t=!1,logsPerSecond:n=30,samplesLog:r=60,samplesGraph:i=10,precision:s=2,minimal:a=!1,horizontal:o=!0,mode:l=0}={}){this.gl=null,this.ext=null,this.activeQuery=null,this.gpuQueries=[],this.threeRendererPatched=!1,this.frames=0,this.renderCount=0,this.isRunningCPUProfiling=!1,this.totalCpuDuration=0,this.totalGpuDuration=0,this.totalGpuDurationCompute=0,this.totalFps=0,this.gpuPanel=null,this.gpuPanelCompute=null,this.averageFps={logs:[],graph:[]},this.averageCpu={logs:[],graph:[]},this.averageGpu={logs:[],graph:[]},this.averageGpuCompute={logs:[],graph:[]},this.handleClick=e=>{e.preventDefault(),this.showPanel(++this.mode%this.dom.children.length)},this.handleResize=()=>{this.resizePanel(this.fpsPanel,0),this.resizePanel(this.msPanel,1),this.gpuPanel&&this.resizePanel(this.gpuPanel,2),this.gpuPanelCompute&&this.resizePanel(this.gpuPanelCompute,3)},this.mode=l,this.horizontal=o,this.minimal=a,this.trackGPU=t,this.samplesLog=r,this.samplesGraph=i,this.precision=s,this.logsPerSecond=n,this.dom=document.createElement("div"),this.initializeDOM(),this.beginTime=performance.now(),this.prevTime=this.beginTime,this.prevCpuTime=this.beginTime,this.fpsPanel=this.addPanel(new e.Panel("FPS","#0ff","#002"),0),this.msPanel=this.addPanel(new e.Panel("CPU","#0f0","#020"),1),this.setupEventListeners()}initializeDOM(){this.dom.style.cssText=`\n      position: fixed;\n      top: 0;\n      left: 0;\n      opacity: 0.9;\n      z-index: 10000;\n      ${this.minimal?"cursor: pointer;":""}\n    `}setupEventListeners(){this.minimal?(this.dom.addEventListener("click",this.handleClick),this.showPanel(this.mode)):window.addEventListener("resize",this.handleResize)}async init(e){e?this.handleThreeRenderer(e)||await this.handleWebGPURenderer(e)||this.initializeWebGL(e):console.error('Stats: The "canvas" parameter is undefined.')}handleThreeRenderer(e){return!(!e.isWebGLRenderer||this.threeRendererPatched)&&(this.patchThreeRenderer(e),this.gl=e.getContext(),this.trackGPU&&this.initializeGPUTracking(),!0)}async handleWebGPURenderer(e){return!!e.isWebGPURenderer&&(this.trackGPU&&(e.backend.trackTimestamp=!0,await e.hasFeatureAsync("timestamp-query")&&this.initializeWebGPUPanels()),this.info=e.info,!0)}initializeWebGPUPanels(){this.gpuPanel=this.addPanel(new e.Panel("GPU","#ff0","#220"),2),this.gpuPanelCompute=this.addPanel(new e.Panel("CPT","#e1e1e1","#212121"),3)}initializeWebGL(e){if(e instanceof WebGL2RenderingContext)this.gl=e;else{if(!(e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas))return console.error("Stats: Invalid input type. Expected WebGL2RenderingContext, HTMLCanvasElement, or OffscreenCanvas."),!1;if(this.gl=e.getContext("webgl2"),!this.gl)return console.error("Stats: Unable to obtain WebGL2 context."),!1}return!0}initializeGPUTracking(){this.gl&&(this.ext=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),this.ext&&(this.gpuPanel=this.addPanel(new e.Panel("GPU","#ff0","#220"),2)))}begin(){this.isRunningCPUProfiling||this.beginProfiling("cpu-started"),this.gl&&this.ext&&(this.activeQuery&&this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.activeQuery=this.gl.createQuery(),this.activeQuery&&this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery))}end(){this.renderCount++,this.gl&&this.ext&&this.activeQuery&&(this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.gpuQueries.push({query:this.activeQuery}),this.activeQuery=null)}update(){this.info?this.processWebGPUTimestamps():this.processGpuQueries(),this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.updateAverages(),this.resetCounters()}processWebGPUTimestamps(){this.totalGpuDuration=this.info.render.timestamp,this.totalGpuDurationCompute=this.info.compute.timestamp,this.addToAverage(this.totalGpuDurationCompute,this.averageGpuCompute)}updateAverages(){this.addToAverage(this.totalCpuDuration,this.averageCpu),this.addToAverage(this.totalGpuDuration,this.averageGpu)}resetCounters(){this.renderCount=0,0===this.totalCpuDuration&&this.beginProfiling("cpu-started"),this.totalCpuDuration=0,this.totalFps=0,this.beginTime=this.endInternal()}resizePanel(e,t){e.canvas.style.position="absolute",this.minimal?e.canvas.style.display="none":(e.canvas.style.display="block",this.horizontal?(e.canvas.style.top="0px",e.canvas.style.left=t*e.WIDTH/e.PR+"px"):(e.canvas.style.left="0px",e.canvas.style.top=t*e.HEIGHT/e.PR+"px"))}addPanel(e,t){return e.canvas&&(this.dom.appendChild(e.canvas),this.resizePanel(e,t)),e}showPanel(e){for(let t=0;t<this.dom.children.length;t++){this.dom.children[t].style.display=t===e?"block":"none"}this.mode=e}processGpuQueries(){this.gl&&this.ext&&(this.totalGpuDuration=0,this.gpuQueries.forEach(((e,t)=>{if(this.gl){const n=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT_AVAILABLE),r=this.gl.getParameter(this.ext.GPU_DISJOINT_EXT);if(n&&!r){const n=1e-6*this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT);this.totalGpuDuration+=n,this.gl.deleteQuery(e.query),this.gpuQueries.splice(t,1)}}})))}endInternal(){this.frames++;const e=(performance||Date).now(),t=e-this.prevTime;if(e>=this.prevCpuTime+1e3/this.logsPerSecond){const n=Math.round(1e3*this.frames/t);this.addToAverage(n,this.averageFps),this.updatePanel(this.fpsPanel,this.averageFps,0),this.updatePanel(this.msPanel,this.averageCpu,this.precision),this.updatePanel(this.gpuPanel,this.averageGpu,this.precision),this.gpuPanelCompute&&this.updatePanel(this.gpuPanelCompute,this.averageGpuCompute),this.frames=0,this.prevCpuTime=e,this.prevTime=e}return e}addToAverage(e,t){t.logs.push(e),t.logs.length>this.samplesLog&&t.logs.shift(),t.graph.push(e),t.graph.length>this.samplesGraph&&t.graph.shift()}beginProfiling(e){window.performance&&(window.performance.mark(e),this.isRunningCPUProfiling=!0)}endProfiling(e,t,n){if(window.performance&&t&&this.isRunningCPUProfiling){window.performance.mark(t);const r=performance.measure(n,e,t);this.totalCpuDuration+=r.duration,this.isRunningCPUProfiling=!1}}updatePanel(e,t,n=2){if(t.logs.length>0){let r=0,i=.01;for(let e=0;e<t.logs.length;e++)r+=t.logs[e],t.logs[e]>i&&(i=t.logs[e]);let s=0,a=.01;for(let e=0;e<t.graph.length;e++)s+=t.graph[e],t.graph[e]>a&&(a=t.graph[e]);e&&e.update(r/Math.min(t.logs.length,this.samplesLog),s/Math.min(t.graph.length,this.samplesGraph),i,a,n)}}get domElement(){return this.dom}patchThreeRenderer(e){const t=e.render,n=this;e.render=function(e,r){n.begin(),t.call(this,e,r),n.end()},this.threeRendererPatched=!0}};Ef.Panel=class{constructor(e,t,n){this.name=e,this.fg=t,this.bg=n,this.gradient=null,this.PR=Math.round(window.devicePixelRatio||1),this.WIDTH=90*this.PR,this.HEIGHT=48*this.PR,this.TEXT_X=3*this.PR,this.TEXT_Y=2*this.PR,this.GRAPH_X=3*this.PR,this.GRAPH_Y=15*this.PR,this.GRAPH_WIDTH=84*this.PR,this.GRAPH_HEIGHT=30*this.PR,this.canvas=document.createElement("canvas"),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="90px",this.canvas.style.height="48px",this.canvas.style.position="absolute",this.canvas.style.cssText="width:90px;height:48px",this.context=this.canvas.getContext("2d"),this.initializeCanvas()}createGradient(){if(!this.context)throw new Error("No context");const e=this.context.createLinearGradient(0,this.GRAPH_Y,0,this.GRAPH_Y+this.GRAPH_HEIGHT);let t;const n=this.fg;switch(this.fg.toLowerCase()){case"#0ff":t="#006666";break;case"#0f0":t="#006600";break;case"#ff0":t="#666600";break;case"#e1e1e1":t="#666666";break;default:t=this.bg}return e.addColorStop(0,t),e.addColorStop(1,n),e}initializeCanvas(){this.context&&(this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.gradient=this.createGradient(),this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=this.fg,this.context.fillText(this.name,this.TEXT_X,this.TEXT_Y),this.context.fillStyle=this.fg,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT))}update(e,t,n,r,i=0){if(!this.context||!this.gradient)return;const s=Math.min(1/0,e),a=Math.max(n,e);r=Math.max(r,t),this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y),this.context.fillStyle=this.fg,this.context.fillText(`${e.toFixed(i)} ${this.name} (${s.toFixed(i)}-${parseFloat(a.toFixed(i))})`,this.TEXT_X,this.TEXT_Y),this.context.drawImage(this.canvas,this.GRAPH_X+this.PR,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT,this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT);const o=this.GRAPH_HEIGHT-(1-t/r)*this.GRAPH_HEIGHT;o>0&&(this.context.globalAlpha=1,this.context.fillStyle=this.gradient,this.context.fillRect(this.GRAPH_X+this.GRAPH_WIDTH-this.PR,this.GRAPH_Y+this.GRAPH_HEIGHT-o,this.PR,o))}};let xf=Ef;const Cf=i.forwardRef((function({className:e,parent:t,id:n,clearStatsGlStyle:r,...s},a){const l=(0,o.A)((e=>e.gl)),c=i.useMemo((()=>{const e=new xf({...s});return e.init(l),e}),[l]);return i.useImperativeHandle(a,(()=>c.domElement),[c]),i.useEffect((()=>{if(c){const i=t&&t.current||document.body;null==i||i.appendChild(c.domElement),c.domElement.querySelectorAll("canvas").forEach((e=>{e.style.removeProperty("position")})),n&&(c.domElement.id=n),r&&c.domElement.removeAttribute("style"),c.domElement.removeAttribute("style");const s=(null!=e?e:"").split(" ").filter((e=>e));s.length&&c.domElement.classList.add(...s);const a=(0,o.k)((()=>c.update()));return()=>{s.length&&c.domElement.classList.remove(...s),null==i||i.removeChild(c.domElement),a()}}}),[t,c,e,n,r]),null}));function wf({size:e=256,frames:t=1/0}={}){const n=(0,o.A)((e=>e.viewport.dpr)),{width:r,height:s}=(0,o.A)((e=>e.size)),l=e||r*n,c=e||s*n,h=i.useMemo((()=>{const e=new a.VCu(l,c);return e.format=a.zdS,e.type=a.cHt,{depthTexture:e}}),[l,c]);let u=0;const d=vl(l,c,h);return(0,o.C)((e=>{(t===1/0||u<t)&&(e.gl.setRenderTarget(d),e.gl.render(e.scene,e.camera),e.gl.setRenderTarget(null),u++)})),d.depthTexture}function If(e,t,n=1){const r=(0,o.A)((e=>e.viewport)),i=t*(r.aspect>e/t?r.width/e:r.height/t);return[e*(r.aspect>e/t?r.width/e:r.height/t)*n,i*n,1]}function bf(e,t){const n=(0,o.A)((e=>e.pointer)),[r]=i.useState((()=>{const r=new a.tBo;return t&&(0,o.q)(r,t),function(t,i){r.setFromCamera(n,e instanceof a.i7d?e:e.current);const s=this.constructor.prototype.raycast.bind(this);s&&s(r,i)}}));return r}function Sf(e,t,n,r){return new(n||(n=Promise))((function(i,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}l((r=r.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const Bf=["geforce 320m","geforce 8600","geforce 8600m gt","geforce 8800 gs","geforce 8800 gt","geforce 9400","geforce 9400m g","geforce 9400m","geforce 9600m gt","geforce 9600m","geforce fx go5200","geforce gt 120","geforce gt 130","geforce gt 330m","geforce gtx 285","google swiftshader","intel g41","intel g45","intel gma 4500mhd","intel gma x3100","intel hd 3000","intel q45","legacy","mali-2","mali-3","mali-4","quadro fx 1500","quadro fx 4","quadro fx 5","radeon hd 2400","radeon hd 2600","radeon hd 4670","radeon hd 4850","radeon hd 4870","radeon hd 5670","radeon hd 5750","radeon hd 6290","radeon hd 6300","radeon hd 6310","radeon hd 6320","radeon hd 6490m","radeon hd 6630m","radeon hd 6750m","radeon hd 6770m","radeon hd 6970m","sgx 543","sgx543"];function Tf(e){return e.toLowerCase().replace(/.*angle ?\((.+)\)(?: on vulkan [0-9.]+)?$/i,"$1").replace(/\s(\d{1,2}gb|direct3d.+$)|\(r\)| \([^)]+\)$/g,"").replace(/(?:vulkan|opengl) \d+\.\d+(?:\.\d+)?(?: \((.*)\))?/,"$1")}const _f="undefined"==typeof window,Mf=(()=>{if(_f)return;const{userAgent:e,platform:t,maxTouchPoints:n}=window.navigator,r=/(iphone|ipod|ipad)/i.test(e),i="iPad"===t||"MacIntel"===t&&n>0&&!window.MSStream;return{isIpad:i,isMobile:/android/i.test(e)||r||i,isSafari12:/Version\/12.+Safari/.test(e),isFirefox:/Firefox/.test(e)}})();class Rf extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}}const Df=[],Pf=[];function Lf(e,t){if(e===t)return 0;const n=e;e.length>t.length&&(e=t,t=n);let r=e.length,i=t.length;for(;r>0&&e.charCodeAt(~-r)===t.charCodeAt(~-i);)r--,i--;let s,a=0;for(;a<r&&e.charCodeAt(a)===t.charCodeAt(a);)a++;if(r-=a,i-=a,0===r)return i;let o,l,c=0,h=0,u=0;for(;h<r;)Pf[h]=e.charCodeAt(a+h),Df[h]=++h;for(;u<i;)for(s=t.charCodeAt(a+u),o=u++,c=u,h=0;h<r;h++)l=s===Pf[h]?o:o+1,o=Df[h],c=Df[h]=o>c?l>c?c+1:l:l>o?o+1:l;return c}function kf(e){return null!=e}const Ff=({mobileTiers:e=[0,15,30,60],desktopTiers:t=[0,15,30,60],override:n={},glContext:r,failIfMajorPerformanceCaveat:i=!1,benchmarksURL:s="https://unpkg.com/detect-gpu@5.0.70/dist/benchmarks"}={})=>Sf(void 0,void 0,void 0,(function*(){const a={};if(_f)return{tier:0,type:"SSR"};const{isIpad:o=!!(null==Mf?void 0:Mf.isIpad),isMobile:l=!!(null==Mf?void 0:Mf.isMobile),screenSize:c=window.screen,loadBenchmarks:h=e=>Sf(void 0,void 0,void 0,(function*(){const t=yield fetch(`${s}/${e}`).then((e=>e.json()));if(parseInt(t.shift().split(".")[0],10)<4)throw new Rf("Detect GPU benchmark data is out of date. Please update to version 4x");return t}))}=n;let{renderer:u}=n;const d=(e,t,n,r,i)=>({device:i,fps:r,gpu:n,isMobile:l,tier:e,type:t});let f,A="";if(u)u=Tf(u),f=[u];else{const e=r||function(e,t=!1){const n={alpha:!1,antialias:!1,depth:!1,failIfMajorPerformanceCaveat:t,powerPreference:"high-performance",stencil:!1};e&&delete n.powerPreference;const r=window.document.createElement("canvas"),i=r.getContext("webgl",n)||r.getContext("experimental-webgl",n);return null!=i?i:void 0}(null==Mf?void 0:Mf.isSafari12,i);if(!e)return d(0,"WEBGL_UNSUPPORTED");const t=(null==Mf?void 0:Mf.isFirefox)?null:e.getExtension("WEBGL_debug_renderer_info");if(u=t?e.getParameter(t.UNMASKED_RENDERER_WEBGL):e.getParameter(e.RENDERER),!u)return d(1,"FALLBACK");A=u,u=Tf(u),f=function(e,t,n){return"apple gpu"===t?function(e,t,n){if(!n)return[t];const r=function(e){const t=e.createShader(35633),n=e.createShader(35632),r=e.createProgram();if(!(n&&t&&r))return;e.shaderSource(t,"\n    precision highp float;\n    attribute vec3 aPosition;\n    varying float vvv;\n    void main() {\n      vvv = 0.31622776601683794;\n      gl_Position = vec4(aPosition, 1.0);\n    }\n  "),e.shaderSource(n,"\n    precision highp float;\n    varying float vvv;\n    void main() {\n      vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * vvv;\n      enc = fract(enc);\n      enc -= enc.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n      gl_FragColor = enc;\n    }\n  "),e.compileShader(t),e.compileShader(n),e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),e.detachShader(r,t),e.detachShader(r,n),e.deleteShader(t),e.deleteShader(n),e.useProgram(r);const i=e.createBuffer();e.bindBuffer(34962,i),e.bufferData(34962,new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),35044);const s=e.getAttribLocation(r,"aPosition");e.vertexAttribPointer(s,3,5126,!1,0,0),e.enableVertexAttribArray(s),e.clearColor(1,1,1,1),e.clear(16384),e.viewport(0,0,1,1),e.drawArrays(4,0,3);const a=new Uint8Array(4);return e.readPixels(0,0,1,1,6408,5121,a),e.deleteProgram(r),e.deleteBuffer(i),a.join("")}(e),i="801621810",s="8016218135",a="80162181161",o=(null==Mf?void 0:Mf.isIpad)?[["a7",a,12],["a8",s,15],["a8x",s,15],["a9",s,15],["a9x",s,15],["a10",s,15],["a10x",s,15],["a12",i,15],["a12x",i,15],["a12z",i,15],["a14",i,15],["a15",i,15],["m1",i,15],["m2",i,15]]:[["a7",a,12],["a8",s,12],["a9",s,15],["a10",s,15],["a11",i,15],["a12",i,15],["a13",i,15],["a14",i,15],["a15",i,15],["a16",i,15],["a17",i,15]];let l;return"80162181255"===r?l=o.filter((([,,e])=>e>=14)):(l=o.filter((([,e])=>e===r)),l.length||(l=o)),l.map((([e])=>`apple ${e} gpu`))}(e,t,n):[t]}(e,u,l)}const m=(yield Promise.all(f.map((function(e){var t;return Sf(this,void 0,void 0,(function*(){const n=(e=>{const t=l?["adreno","apple","mali-t","mali","nvidia","powervr","samsung"]:["intel","apple","amd","radeon","nvidia","geforce","adreno"];for(const n of t)if(e.includes(n))return n})(e);if(!n)return;const r=`${l?"m":"d"}-${n}${o?"-ipad":""}.json`,i=a[r]=null!==(t=a[r])&&void 0!==t?t:h(r);let s;try{s=yield i}catch(n){if(n instanceof Rf)throw n;return}const u=function(e){var t;const n=(e=e.replace(/\([^)]+\)/,"")).match(/\d+/)||e.match(/(\W|^)([A-Za-z]{1,3})(\W|$)/g);return null!==(t=null==n?void 0:n.join("").replace(/\W|amd/g,""))&&void 0!==t?t:""}(e);let d=s.filter((([,e])=>e===u));d.length||(d=s.filter((([t])=>t.includes(e))));const f=d.length;if(0===f)return;const A=e.split(/[.,()\[\]/\s]/g).sort().filter(((e,t,n)=>0===t||e!==n[t-1])).join(" ");let m,[p,,,,g]=f>1?d.map((e=>[e,Lf(A,e[2])])).sort((([,e],[,t])=>e-t))[0][0]:d[0],v=Number.MAX_VALUE;const{devicePixelRatio:y}=window,E=c.width*y*c.height*y;for(const e of g){const[t,n]=e,r=t*n,i=Math.abs(E-r);i<v&&(v=i,m=e)}if(!m)return;const[,,x,C]=m;return[v,x,p,C]}))})))).filter(kf).sort((([e=Number.MAX_VALUE,t],[n=Number.MAX_VALUE,r])=>e===n?t-r:e-n));if(!m.length){const e=Bf.find((e=>u.includes(e)));return e?d(0,"BLOCKLISTED",e):d(1,"FALLBACK",`${u} (${A})`)}const[,p,g,v]=m[0];if(-1===p)return d(0,"BLOCKLISTED",g,p,v);const y=l?e:t;let E=0;for(let e=0;e<y.length;e++)p>=y[e]&&(E=e);return d(E,"BENCHMARK",g,p,v)})),Of=e=>(0,Cs.DY)((()=>Ff(e)),["useDetectGPU"]);function Uf({children:e,...t}){const n=Of(t);return i.createElement(i.Fragment,null,null==e?void 0:e(n))}const Qf=2,Nf=1.25,zf=32,Gf=65535,Hf=Math.pow(2,-24),qf=Symbol("SKIP_GENERATION");function Yf(e,t,n){return null===e?null:(e.point.applyMatrix4(t.matrixWorld),e.distance=e.point.distanceTo(n.ray.origin),e.object=t,e)}function jf(e){return e.index?e.index.count:e.attributes.position.count}function Vf(e){return jf(e)/3}function Kf(e,t=ArrayBuffer){return e>65535?new Uint32Array(new t(4*e)):new Uint16Array(new t(2*e))}function Wf(e,t){const n=Vf(e),r=t||e.drawRange,i=r.start/3,s=(r.start+r.count)/3,a=Math.max(0,i),o=Math.min(n,s)-a;return[{offset:Math.floor(a),count:Math.floor(o)}]}function Jf(e,t){if(!e.groups||!e.groups.length)return Wf(e,t);const n=[],r=new Set,i=t||e.drawRange,s=i.start/3,a=(i.start+i.count)/3;for(const l of e.groups){const e=l.start/3,t=(l.start+l.count)/3;r.add(Math.max(s,e)),r.add(Math.min(a,t))}const o=Array.from(r.values()).sort(((e,t)=>e-t));for(let l=0;l<o.length-1;l++){const e=o[l],t=o[l+1];n.push({offset:Math.floor(e),count:Math.floor(t-e)})}return n}function Xf(e,t,n,r,i){let s=1/0,a=1/0,o=1/0,l=-1/0,c=-1/0,h=-1/0,u=1/0,d=1/0,f=1/0,A=-1/0,m=-1/0,p=-1/0;for(let g=6*t,v=6*(t+n);g<v;g+=6){const t=e[g+0],n=e[g+1],r=t-n,i=t+n;r<s&&(s=r),i>l&&(l=i),t<u&&(u=t),t>A&&(A=t);const v=e[g+2],y=e[g+3],E=v-y,x=v+y;E<a&&(a=E),x>c&&(c=x),v<d&&(d=v),v>m&&(m=v);const C=e[g+4],w=e[g+5],I=C-w,b=C+w;I<o&&(o=I),b>h&&(h=b),C<f&&(f=C),C>p&&(p=C)}r[0]=s,r[1]=a,r[2]=o,r[3]=l,r[4]=c,r[5]=h,i[0]=u,i[1]=d,i[2]=f,i[3]=A,i[4]=m,i[5]=p}function $f(e,t,n){return n.min.x=t[e],n.min.y=t[e+1],n.min.z=t[e+2],n.max.x=t[e+3],n.max.y=t[e+4],n.max.z=t[e+5],n}function Zf(e){let t=-1,n=-1/0;for(let r=0;r<3;r++){const i=e[r+3]-e[r];i>n&&(n=i,t=r)}return t}function eA(e,t){t.set(e)}function tA(e,t,n){let r,i;for(let s=0;s<3;s++){const a=s+3;r=e[s],i=t[s],n[s]=r<i?r:i,r=e[a],i=t[a],n[a]=r>i?r:i}}function nA(e,t,n){for(let r=0;r<3;r++){const i=t[e+2*r],s=t[e+2*r+1],a=i-s,o=i+s;a<n[r]&&(n[r]=a),o>n[r+3]&&(n[r+3]=o)}}function rA(e){const t=e[3]-e[0],n=e[4]-e[1],r=e[5]-e[2];return 2*(t*n+n*r+r*t)}const iA=32,sA=(e,t)=>e.candidate-t.candidate,aA=new Array(iA).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),oA=new Float32Array(6);class lA{constructor(){this.boundingData=new Float32Array(6)}}function cA(e,t,n,r,i,s){let a=r,o=r+i-1;const l=s.pos,c=2*s.axis;for(;;){for(;a<=o&&n[6*a+c]<l;)a++;for(;a<=o&&n[6*o+c]>=l;)o--;if(!(a<o))return a;for(let e=0;e<3;e++){let n=t[3*a+e];t[3*a+e]=t[3*o+e],t[3*o+e]=n}for(let e=0;e<6;e++){let t=n[6*a+e];n[6*a+e]=n[6*o+e],n[6*o+e]=t}a++,o--}}function hA(e,t,n,r,i,s){let a=r,o=r+i-1;const l=s.pos,c=2*s.axis;for(;;){for(;a<=o&&n[6*a+c]<l;)a++;for(;a<=o&&n[6*o+c]>=l;)o--;if(!(a<o))return a;{let t=e[a];e[a]=e[o],e[o]=t;for(let e=0;e<6;e++){let t=n[6*a+e];n[6*a+e]=n[6*o+e],n[6*o+e]=t}a++,o--}}}function uA(e,t){return 65535===t[e+15]}function dA(e,t){return t[e+6]}function fA(e,t){return t[e+14]}function AA(e){return e+8}function mA(e,t){return t[e+6]}function pA(e,t){return t[e+7]}let gA,vA,yA,EA;const xA=Math.pow(2,32);function CA(e){return"count"in e?1:1+CA(e.left)+CA(e.right)}function wA(e,t,n){return gA=new Float32Array(n),vA=new Uint32Array(n),yA=new Uint16Array(n),EA=new Uint8Array(n),IA(e,t)}function IA(e,t){const n=e/4,r=e/2,i="count"in t,s=t.boundingData;for(let a=0;a<6;a++)gA[n+a]=s[a];if(i){if(t.buffer){const r=t.buffer;EA.set(new Uint8Array(r),e);for(let t=e,i=e+r.byteLength;t<i;t+=zf){uA(t/2,yA)||(vA[t/4+6]+=n)}return e+r.byteLength}{const i=t.offset,s=t.count;return vA[n+6]=i,yA[r+14]=s,yA[r+15]=Gf,e+zf}}{const r=t.left,i=t.right,s=t.splitAxis;let a;if(a=IA(e+zf,r),a/4>xA)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return vA[n+6]=a/4,a=IA(a,i),vA[n+7]=s,a}}function bA(e,t,n,r,i){const{maxDepth:s,verbose:a,maxLeafTris:o,strategy:l,onProgress:c,indirect:h}=i,u=e._indirectBuffer,d=e.geometry,f=d.index?d.index.array:null,A=h?hA:cA,m=Vf(d),p=new Float32Array(6);let g=!1;const v=new lA;return Xf(t,n,r,v.boundingData,p),function e(n,r,i,c=null,h=0){!g&&h>=s&&(g=!0,a&&(console.warn(`MeshBVH: Max depth of ${s} reached when generating BVH. Consider increasing maxDepth.`),console.warn(d)));if(i<=o||h>=s)return y(r+i),n.offset=r,n.count=i,n;const m=function(e,t,n,r,i,s){let a=-1,o=0;if(0===s)a=Zf(t),-1!==a&&(o=(t[a]+t[a+3])/2);else if(1===s)a=Zf(e),-1!==a&&(o=function(e,t,n,r){let i=0;for(let s=t,a=t+n;s<a;s++)i+=e[6*s+2*r];return i/n}(n,r,i,a));else if(s===Qf){const s=rA(e);let l=Nf*i;const c=6*r,h=6*(r+i);for(let e=0;e<3;e++){const r=t[e],u=(t[e+3]-r)/iA;if(i<8){const t=[...aA];t.length=i;let r=0;for(let i=c;i<h;i+=6,r++){const s=t[r];s.candidate=n[i+2*e],s.count=0;const{bounds:a,leftCacheBounds:o,rightCacheBounds:l}=s;for(let e=0;e<3;e++)l[e]=1/0,l[e+3]=-1/0,o[e]=1/0,o[e+3]=-1/0,a[e]=1/0,a[e+3]=-1/0;nA(i,n,a)}t.sort(sA);let u=i;for(let e=0;e<u;e++){const n=t[e];for(;e+1<u&&t[e+1].candidate===n.candidate;)t.splice(e+1,1),u--}for(let i=c;i<h;i+=6){const r=n[i+2*e];for(let e=0;e<u;e++){const s=t[e];r>=s.candidate?nA(i,n,s.rightCacheBounds):(nA(i,n,s.leftCacheBounds),s.count++)}}for(let n=0;n<u;n++){const r=t[n],c=r.count,h=i-r.count,u=r.leftCacheBounds,d=r.rightCacheBounds;let f=0;0!==c&&(f=rA(u)/s);let A=0;0!==h&&(A=rA(d)/s);const m=1+Nf*(f*c+A*h);m<l&&(a=e,l=m,o=r.candidate)}}else{for(let e=0;e<iA;e++){const t=aA[e];t.count=0,t.candidate=r+u+e*u;const n=t.bounds;for(let e=0;e<3;e++)n[e]=1/0,n[e+3]=-1/0}for(let i=c;i<h;i+=6){let t=~~((n[i+2*e]-r)/u);t>=iA&&(t=31);const s=aA[t];s.count++,nA(i,n,s.bounds)}const t=aA[31];eA(t.bounds,t.rightCacheBounds);for(let e=30;e>=0;e--){const t=aA[e],n=aA[e+1];tA(t.bounds,n.rightCacheBounds,t.rightCacheBounds)}let d=0;for(let n=0;n<31;n++){const t=aA[n],r=t.count,c=t.bounds,h=aA[n+1].rightCacheBounds;0!==r&&(0===d?eA(c,oA):tA(c,oA,oA)),d+=r;let u=0,f=0;0!==d&&(u=rA(oA)/s);const A=i-d;0!==A&&(f=rA(h)/s);const m=1+Nf*(u*d+f*A);m<l&&(a=e,l=m,o=t.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${s} used.`);return{axis:a,pos:o}}(n.boundingData,c,t,r,i,l);if(-1===m.axis)return y(r+i),n.offset=r,n.count=i,n;const v=A(u,f,t,r,i,m);if(v===r||v===r+i)y(r+i),n.offset=r,n.count=i;else{n.splitAxis=m.axis;const s=new lA,a=r,o=v-r;n.left=s,Xf(t,a,o,s.boundingData,p),e(s,a,o,p,h+1);const l=new lA,c=v,u=i-o;n.right=l,Xf(t,c,u,l.boundingData,p),e(l,c,u,p,h+1)}return n}(v,n,r,p),v;function y(e){c&&c(e/m)}}function SA(e,t){const n=e.geometry;t.indirect&&(e._indirectBuffer=function(e,t){const n=(e.index?e.index.count:e.attributes.position.count)/3,r=n>65536,i=r?4:2,s=t?new SharedArrayBuffer(n*i):new ArrayBuffer(n*i),a=r?new Uint32Array(s):new Uint16Array(s);for(let o=0,l=a.length;o<l;o++)a[o]=o;return a}(n,t.useSharedArrayBuffer),function(e,t){const n=Vf(e),r=Jf(e,t).sort(((e,t)=>e.offset-t.offset)),i=r[r.length-1];i.count=Math.min(n-i.offset,i.count);let s=0;return r.forEach((({count:e})=>s+=e)),n!==s}(n,t.range)&&!t.verbose&&console.warn('MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),e._indirectBuffer||function(e,t){if(!e.index){const n=e.attributes.position.count,r=Kf(n,t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);e.setIndex(new a.THS(r,1));for(let e=0;e<n;e++)r[e]=e}}(n,t);const r=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=function(e,t=null,n=null,r=null){const i=e.attributes.position,s=e.index?e.index.array:null,a=Vf(e),o=i.normalized;let l;null===t?(l=new Float32Array(6*a),n=0,r=a):(l=t,n=n||0,r=r||a);const c=i.array,h=i.offset||0;let u=3;i.isInterleavedBufferAttribute&&(u=i.data.stride);const d=["getX","getY","getZ"];for(let f=n;f<n+r;f++){const e=3*f,t=6*f;let n=e+0,r=e+1,a=e+2;s&&(n=s[n],r=s[r],a=s[a]),o||(n=n*u+h,r=r*u+h,a=a*u+h);for(let s=0;s<3;s++){let e,h,u;o?(e=i[d[s]](n),h=i[d[s]](r),u=i[d[s]](a)):(e=c[n+s],h=c[r+s],u=c[a+s]);let f=e;h<f&&(f=h),u<f&&(f=u);let A=e;h>A&&(A=h),u>A&&(A=u);const m=(A-f)/2,p=2*s;l[t+p+0]=f+m,l[t+p+1]=m+(Math.abs(f)+m)*Hf}}return l}(n),s=t.indirect?Wf(n,t.range):Jf(n,t.range);e._roots=s.map((n=>{const s=bA(e,i,n.offset,n.count,t),a=CA(s),o=new r(zf*a);return wA(0,s,o),o}))}class BA{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let n=1/0,r=-1/0;for(let i=0,s=e.length;i<s;i++){const s=e[i][t];n=s<n?s:n,r=s>r?s:r}this.min=n,this.max=r}setFromPoints(e,t){let n=1/0,r=-1/0;for(let i=0,s=t.length;i<s;i++){const s=t[i],a=e.dot(s);n=a<n?a:n,r=a>r?a:r}this.min=n,this.max=r}isSeparated(e){return this.min>e.max||e.min>this.max}}BA.prototype.setFromBox=function(){const e=new a.Pq0;return function(t,n){const r=n.min,i=n.max;let s=1/0,a=-1/0;for(let o=0;o<=1;o++)for(let n=0;n<=1;n++)for(let l=0;l<=1;l++){e.x=r.x*o+i.x*(1-o),e.y=r.y*n+i.y*(1-n),e.z=r.z*l+i.z*(1-l);const c=t.dot(e);s=Math.min(c,s),a=Math.max(c,a)}this.min=s,this.max=a}}();!function(){const e=new BA}();const TA=function(){const e=new a.Pq0,t=new a.Pq0,n=new a.Pq0;return function(r,i,s){const a=r.start,o=e,l=i.start,c=t;n.subVectors(a,l),e.subVectors(r.end,r.start),t.subVectors(i.end,i.start);const h=n.dot(c),u=c.dot(o),d=c.dot(c),f=n.dot(o),A=o.dot(o)*d-u*u;let m,p;m=0!==A?(h*u-f*d)/A:0,p=(h+m*u)/d,s.x=m,s.y=p}}(),_A=function(){const e=new a.I9Y,t=new a.Pq0,n=new a.Pq0;return function(r,i,s,a){TA(r,i,e);let o=e.x,l=e.y;if(o>=0&&o<=1&&l>=0&&l<=1)return r.at(o,s),void i.at(l,a);if(o>=0&&o<=1)return l<0?i.at(0,a):i.at(1,a),void r.closestPointToPoint(a,!0,s);if(l>=0&&l<=1)return o<0?r.at(0,s):r.at(1,s),void i.closestPointToPoint(s,!0,a);{let e,c;e=o<0?r.start:r.end,c=l<0?i.start:i.end;const h=t,u=n;return r.closestPointToPoint(c,!0,t),i.closestPointToPoint(e,!0,n),h.distanceToSquared(c)<=u.distanceToSquared(e)?(s.copy(h),void a.copy(c)):(s.copy(e),void a.copy(u))}}}(),MA=function(){const e=new a.Pq0,t=new a.Pq0,n=new a.Zcv,r=new a.cZY;return function(i,s){const{radius:a,center:o}=i,{a:l,b:c,c:h}=s;r.start=l,r.end=c;if(r.closestPointToPoint(o,!0,e).distanceTo(o)<=a)return!0;r.start=l,r.end=h;if(r.closestPointToPoint(o,!0,e).distanceTo(o)<=a)return!0;r.start=c,r.end=h;if(r.closestPointToPoint(o,!0,e).distanceTo(o)<=a)return!0;const u=s.getPlane(n);if(Math.abs(u.distanceToPoint(o))<=a){const e=u.projectPoint(o,t);if(s.containsPoint(e))return!0}return!1}}();function RA(e){return Math.abs(e)<1e-15}class DA extends a.lMl{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new a.Pq0)),this.satBounds=new Array(4).fill().map((()=>new BA)),this.points=[this.a,this.b,this.c],this.sphere=new a.iyt,this.plane=new a.Zcv,this.needsUpdate=!0}intersectsSphere(e){return MA(e,this)}update(){const e=this.a,t=this.b,n=this.c,r=this.points,i=this.satAxes,s=this.satBounds,a=i[0],o=s[0];this.getNormal(a),o.setFromPoints(a,r);const l=i[1],c=s[1];l.subVectors(e,t),c.setFromPoints(l,r);const h=i[2],u=s[2];h.subVectors(t,n),u.setFromPoints(h,r);const d=i[3],f=s[3];d.subVectors(n,e),f.setFromPoints(d,r),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}DA.prototype.closestPointToSegment=function(){const e=new a.Pq0,t=new a.Pq0,n=new a.cZY;return function(r,i=null,s=null){const{start:a,end:o}=r,l=this.points;let c,h=1/0;for(let u=0;u<3;u++){const a=(u+1)%3;n.start.copy(l[u]),n.end.copy(l[a]),_A(n,r,e,t),c=e.distanceToSquared(t),c<h&&(h=c,i&&i.copy(e),s&&s.copy(t))}return this.closestPointToPoint(a,e),c=a.distanceToSquared(e),c<h&&(h=c,i&&i.copy(e),s&&s.copy(a)),this.closestPointToPoint(o,e),c=o.distanceToSquared(e),c<h&&(h=c,i&&i.copy(e),s&&s.copy(o)),Math.sqrt(h)}}(),DA.prototype.intersectsTriangle=function(){const e=new DA,t=new Array(3),n=new Array(3),r=new BA,i=new BA,s=new a.Pq0,o=new a.Pq0,l=new a.Pq0,c=new a.Pq0,h=new a.Pq0,u=new a.cZY,d=new a.cZY,f=new a.cZY,A=new a.Pq0;function m(e,t,n){const r=e.points;let i=0,s=-1;for(let a=0;a<3;a++){const{start:e,end:l}=u;e.copy(r[a]),l.copy(r[(a+1)%3]),u.delta(o);const c=RA(t.distanceToPoint(e));if(RA(t.normal.dot(o))&&c){n.copy(u),i=2;break}const h=t.intersectLine(u,A);if(!h&&c&&A.copy(e),(h||c)&&!RA(A.distanceTo(l))){if(i<=1){(1===i?n.start:n.end).copy(A),c&&(s=i)}else if(i>=2){(1===s?n.start:n.end).copy(A),i=2;break}if(i++,2===i&&-1===s)break}}return i}return function(a,o=null,u=!1){this.needsUpdate&&this.update(),a.isExtendedTriangle?a.needsUpdate&&a.update():(e.copy(a),e.update(),a=e);const A=this.plane,p=a.plane;if(Math.abs(A.normal.dot(p.normal))>1-1e-10){const e=this.satBounds,l=this.satAxes;n[0]=a.a,n[1]=a.b,n[2]=a.c;for(let t=0;t<4;t++){const i=e[t],s=l[t];if(r.setFromPoints(s,n),i.isSeparated(r))return!1}const c=a.satBounds,h=a.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let n=0;n<4;n++){const e=c[n],i=h[n];if(r.setFromPoints(i,t),e.isSeparated(r))return!1}for(let a=0;a<4;a++){const e=l[a];for(let a=0;a<4;a++){const o=h[a];if(s.crossVectors(e,o),r.setFromPoints(s,t),i.setFromPoints(s,n),r.isSeparated(i))return!1}}return o&&(u||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),o.start.set(0,0,0),o.end.set(0,0,0)),!0}{const e=m(this,p,d);if(1===e&&a.containsPoint(d.end))return o&&(o.start.copy(d.end),o.end.copy(d.end)),!0;if(2!==e)return!1;const t=m(a,A,f);if(1===t&&this.containsPoint(f.end))return o&&(o.start.copy(f.end),o.end.copy(f.end)),!0;if(2!==t)return!1;if(d.delta(l),f.delta(c),l.dot(c)<0){let e=f.start;f.start=f.end,f.end=e}const n=d.start.dot(l),r=d.end.dot(l),i=f.start.dot(l),s=f.end.dot(l);return(n===s||i===r||r<i!==n<s)&&(o&&(h.subVectors(d.start,f.start),h.dot(l)>0?o.start.copy(d.start):o.start.copy(f.start),h.subVectors(d.end,f.end),h.dot(l)<0?o.end.copy(d.end):o.end.copy(f.end)),!0)}}}(),DA.prototype.distanceToPoint=function(){const e=new a.Pq0;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),DA.prototype.distanceToTriangle=function(){const e=new a.Pq0,t=new a.Pq0,n=["a","b","c"],r=new a.cZY,i=new a.cZY;return function(s,a=null,o=null){const l=a||o?r:null;if(this.intersectsTriangle(s,l))return(a||o)&&(a&&l.getCenter(a),o&&l.getCenter(o)),0;let c=1/0;for(let t=0;t<3;t++){let r;const i=n[t],l=s[i];this.closestPointToPoint(l,e),r=l.distanceToSquared(e),r<c&&(c=r,a&&a.copy(e),o&&o.copy(l));const h=this[i];s.closestPointToPoint(h,e),r=h.distanceToSquared(e),r<c&&(c=r,a&&a.copy(h),o&&o.copy(e))}for(let h=0;h<3;h++){const l=n[h],u=n[(h+1)%3];r.set(this[l],this[u]);for(let h=0;h<3;h++){const l=n[h],u=n[(h+1)%3];i.set(s[l],s[u]),_A(r,i,e,t);const d=e.distanceToSquared(t);d<c&&(c=d,a&&a.copy(e),o&&o.copy(t))}}return Math.sqrt(c)}}();class PA{constructor(e,t,n){this.isOrientedBox=!0,this.min=new a.Pq0,this.max=new a.Pq0,this.matrix=new a.kn4,this.invMatrix=new a.kn4,this.points=new Array(8).fill().map((()=>new a.Pq0)),this.satAxes=new Array(3).fill().map((()=>new a.Pq0)),this.satBounds=new Array(3).fill().map((()=>new BA)),this.alignedSatBounds=new Array(3).fill().map((()=>new BA)),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),n&&this.matrix.copy(n)}set(e,t,n){this.min.copy(e),this.max.copy(t),this.matrix.copy(n),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}PA.prototype.update=function(){const e=this.matrix,t=this.min,n=this.max,r=this.points;for(let l=0;l<=1;l++)for(let i=0;i<=1;i++)for(let s=0;s<=1;s++){const a=r[1*l|2*i|4*s];a.x=l?n.x:t.x,a.y=i?n.y:t.y,a.z=s?n.z:t.z,a.applyMatrix4(e)}const i=this.satBounds,s=this.satAxes,a=r[0];for(let l=0;l<3;l++){const e=s[l],t=i[l],n=r[1<<l];e.subVectors(a,n),t.setFromPoints(e,r)}const o=this.alignedSatBounds;o[0].setFromPointsField(r,"x"),o[1].setFromPointsField(r,"y"),o[2].setFromPointsField(r,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},PA.prototype.intersectsBox=function(){const e=new BA;return function(t){this.needsUpdate&&this.update();const n=t.min,r=t.max,i=this.satBounds,s=this.satAxes,a=this.alignedSatBounds;if(e.min=n.x,e.max=r.x,a[0].isSeparated(e))return!1;if(e.min=n.y,e.max=r.y,a[1].isSeparated(e))return!1;if(e.min=n.z,e.max=r.z,a[2].isSeparated(e))return!1;for(let o=0;o<3;o++){const n=s[o],r=i[o];if(e.setFromBox(n,t),r.isSeparated(e))return!1}return!0}}(),PA.prototype.intersectsTriangle=function(){const e=new DA,t=new Array(3),n=new BA,r=new BA,i=new a.Pq0;return function(s){this.needsUpdate&&this.update(),s.isExtendedTriangle?s.needsUpdate&&s.update():(e.copy(s),e.update(),s=e);const a=this.satBounds,o=this.satAxes;t[0]=s.a,t[1]=s.b,t[2]=s.c;for(let e=0;e<3;e++){const r=a[e],i=o[e];if(n.setFromPoints(i,t),r.isSeparated(n))return!1}const l=s.satBounds,c=s.satAxes,h=this.points;for(let e=0;e<3;e++){const t=l[e],r=c[e];if(n.setFromPoints(r,h),t.isSeparated(n))return!1}for(let e=0;e<3;e++){const s=o[e];for(let e=0;e<4;e++){const a=c[e];if(i.crossVectors(s,a),n.setFromPoints(i,t),r.setFromPoints(i,h),n.isSeparated(r))return!1}}return!0}}(),PA.prototype.closestPointToPoint=function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t},PA.prototype.distanceToPoint=function(){const e=new a.Pq0;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),PA.prototype.distanceToBox=function(){const e=["x","y","z"],t=new Array(12).fill().map((()=>new a.cZY)),n=new Array(12).fill().map((()=>new a.cZY)),r=new a.Pq0,i=new a.Pq0;return function(s,a=0,o=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(s))return(o||l)&&(s.getCenter(i),this.closestPointToPoint(i,r),s.closestPointToPoint(r,i),o&&o.copy(r),l&&l.copy(i)),0;const c=a*a,h=s.min,u=s.max,d=this.points;let f=1/0;for(let e=0;e<8;e++){const t=d[e];i.copy(t).clamp(h,u);const n=t.distanceToSquared(i);if(n<f&&(f=n,o&&o.copy(t),l&&l.copy(i),n<c))return Math.sqrt(n)}let A=0;for(let r=0;r<3;r++)for(let i=0;i<=1;i++)for(let s=0;s<=1;s++){const a=(r+1)%3,o=(r+2)%3,l=1<<r|i<<a|s<<o,c=d[i<<a|s<<o],f=d[l];t[A].set(c,f);const m=e[r],p=e[a],g=e[o],v=n[A],y=v.start,E=v.end;y[m]=h[m],y[p]=i?h[p]:u[p],y[g]=s?h[g]:u[p],E[m]=u[m],E[p]=i?h[p]:u[p],E[g]=s?h[g]:u[p],A++}for(let e=0;e<=1;e++)for(let t=0;t<=1;t++)for(let n=0;n<=1;n++){i.x=e?u.x:h.x,i.y=t?u.y:h.y,i.z=n?u.z:h.z,this.closestPointToPoint(i,r);const s=i.distanceToSquared(r);if(s<f&&(f=s,o&&o.copy(r),l&&l.copy(i),s<c))return Math.sqrt(s)}for(let e=0;e<12;e++){const s=t[e];for(let e=0;e<12;e++){const t=n[e];_A(s,t,r,i);const a=r.distanceToSquared(i);if(a<f&&(f=a,o&&o.copy(r),l&&l.copy(i),a<c))return Math.sqrt(a)}}return Math.sqrt(f)}}();class LA{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return 0===e.length?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class kA extends LA{constructor(){super((()=>new DA))}}const FA=new kA;const OA=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=n=>{t&&e.push(t),t=n,this.float32Array=new Float32Array(n),this.uint16Array=new Uint16Array(n),this.uint32Array=new Uint32Array(n)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==e.length&&this.setBuffer(e.pop())}}};let UA,QA;const NA=[],zA=new LA((()=>new a.NRn));function GA(e,t,n,r,i,s){UA=zA.getPrimitive(),QA=zA.getPrimitive(),NA.push(UA,QA),OA.setBuffer(e._roots[t]);const a=HA(0,e.geometry,n,r,i,s);OA.clearBuffer(),zA.releasePrimitive(UA),zA.releasePrimitive(QA),NA.pop(),NA.pop();const o=NA.length;return o>0&&(QA=NA[o-1],UA=NA[o-2]),a}function HA(e,t,n,r,i=null,s=0,a=0){const{float32Array:o,uint16Array:l,uint32Array:c}=OA;let h=2*e;if(uA(h,l)){const u=dA(e,c),d=fA(h,l);return $f(e,o,UA),r(u,d,!1,a,s+e,UA)}{const f=AA(e),A=mA(e,c);let m,p,g,v,y=f,E=A;if(i&&(g=UA,v=QA,$f(y,o,g),$f(E,o,v),m=i(g),p=i(v),p<m)){y=A,E=f;const B=m;m=p,p=B,g=v}g||(g=UA,$f(y,o,g));const x=n(g,uA(2*y,l),m,a+1,s+y);let C;if(2===x){const T=b(y);C=r(T,S(y)-T,!0,a+1,s+y,g)}else C=x&&HA(y,t,n,r,i,s,a+1);if(C)return!0;v=QA,$f(E,o,v);const w=n(v,uA(2*E,l),p,a+1,s+E);let I;if(2===w){const _=b(E);I=r(_,S(E)-_,!0,a+1,s+E,v)}else I=w&&HA(E,t,n,r,i,s,a+1);return!!I;function b(e){const{uint16Array:t,uint32Array:n}=OA;let r=2*e;for(;!uA(r,t);)r=2*(e=AA(e));return dA(e,n)}function S(e){const{uint16Array:t,uint32Array:n}=OA;let r=2*e;for(;!uA(r,t);)r=2*(e=mA(e,n));return dA(e,n)+fA(r,t)}}}const qA=new a.Pq0,YA=new a.Pq0;const jA=parseInt(a.sPf)>=169,VA=new a.Pq0,KA=new a.Pq0,WA=new a.Pq0,JA=new a.I9Y,XA=new a.I9Y,$A=new a.I9Y,ZA=new a.Pq0,em=new a.Pq0,tm=new a.Pq0,nm=new a.Pq0;function rm(e,t,n,r,i,s,o,l,c,h,u){VA.fromBufferAttribute(t,s),KA.fromBufferAttribute(t,o),WA.fromBufferAttribute(t,l);const d=function(e,t,n,r,i,s,o,l){let c;if(c=s===a.hsX?e.intersectTriangle(r,n,t,!0,i):e.intersectTriangle(t,n,r,s!==a.$EB,i),null===c)return null;const h=e.origin.distanceTo(i);return h<o||h>l?null:{distance:h,point:i.clone()}}(e,VA,KA,WA,nm,c,h,u);if(d){const t=new a.Pq0;a.lMl.getBarycoord(nm,VA,KA,WA,t),r&&(JA.fromBufferAttribute(r,s),XA.fromBufferAttribute(r,o),$A.fromBufferAttribute(r,l),d.uv=a.lMl.getInterpolation(nm,VA,KA,WA,JA,XA,$A,new a.I9Y)),i&&(JA.fromBufferAttribute(i,s),XA.fromBufferAttribute(i,o),$A.fromBufferAttribute(i,l),d.uv1=a.lMl.getInterpolation(nm,VA,KA,WA,JA,XA,$A,new a.I9Y)),n&&(ZA.fromBufferAttribute(n,s),em.fromBufferAttribute(n,o),tm.fromBufferAttribute(n,l),d.normal=a.lMl.getInterpolation(nm,VA,KA,WA,ZA,em,tm,new a.Pq0),d.normal.dot(e.direction)>0&&d.normal.multiplyScalar(-1));const c={a:s,b:o,c:l,normal:new a.Pq0,materialIndex:0};a.lMl.getNormal(VA,KA,WA,c.normal),d.face=c,d.faceIndex=s,jA&&(d.barycoord=t)}return d}function im(e,t,n,r,i,s,a){const o=3*r;let l=o+0,c=o+1,h=o+2;const u=e.index;e.index&&(l=u.getX(l),c=u.getX(c),h=u.getX(h));const{position:d,normal:f,uv:A,uv1:m}=e.attributes,p=rm(n,d,f,A,m,l,c,h,t,s,a);return p?(p.faceIndex=r,i&&i.push(p),p):null}function sm(e,t,n,r){const i=e.a,s=e.b,a=e.c;let o=t,l=t+1,c=t+2;n&&(o=n.getX(o),l=n.getX(l),c=n.getX(c)),i.x=r.getX(o),i.y=r.getY(o),i.z=r.getZ(o),s.x=r.getX(l),s.y=r.getY(l),s.z=r.getZ(l),a.x=r.getX(c),a.y=r.getY(c),a.z=r.getZ(c)}function am(e,t,n,r,i,s,a){const{geometry:o}=n,{index:l}=o,c=o.attributes.position;for(let h=e,u=t+e;h<u;h++){let e;if(e=h,sm(a,3*e,l,c),a.needsUpdate=!0,r(a,e,i,s))return!0}return!1}function om(e,t=null){t&&Array.isArray(t)&&(t=new Set(t));const n=e.geometry,r=n.index?n.index.array:null,i=n.attributes.position;let s,a,o,l,c=0;const h=e._roots;for(let d=0,f=h.length;d<f;d++)s=h[d],a=new Uint32Array(s),o=new Uint16Array(s),l=new Float32Array(s),u(0,c),c+=s.byteLength;function u(e,n,s=!1){const c=2*e;if(o[c+15]===Gf){const t=a[e+6];let n=1/0,s=1/0,h=1/0,u=-1/0,d=-1/0,f=-1/0;for(let e=3*t,a=3*(t+o[c+14]);e<a;e++){let t=r[e];const a=i.getX(t),o=i.getY(t),l=i.getZ(t);a<n&&(n=a),a>u&&(u=a),o<s&&(s=o),o>d&&(d=o),l<h&&(h=l),l>f&&(f=l)}return(l[e+0]!==n||l[e+1]!==s||l[e+2]!==h||l[e+3]!==u||l[e+4]!==d||l[e+5]!==f)&&(l[e+0]=n,l[e+1]=s,l[e+2]=h,l[e+3]=u,l[e+4]=d,l[e+5]=f,!0)}{const r=e+8,i=a[e+6],o=r+n,c=i+n;let h=s,d=!1,f=!1;t?h||(d=t.has(o),f=t.has(c),h=!d&&!f):(d=!0,f=!0);const A=h||f;let m=!1;(h||d)&&(m=u(r,n,h));let p=!1;A&&(p=u(i,n,h));const g=m||p;if(g)for(let t=0;t<3;t++){const n=r+t,s=i+t,a=l[n],o=l[n+3],c=l[s],h=l[s+3];l[e+t]=a<c?a:c,l[e+t+3]=o>h?o:h}return g}}}function lm(e,t,n,r,i){let s,a,o,l,c,h;const u=1/n.direction.x,d=1/n.direction.y,f=1/n.direction.z,A=n.origin.x,m=n.origin.y,p=n.origin.z;let g=t[e],v=t[e+3],y=t[e+1],E=t[e+3+1],x=t[e+2],C=t[e+3+2];return u>=0?(s=(g-A)*u,a=(v-A)*u):(s=(v-A)*u,a=(g-A)*u),d>=0?(o=(y-m)*d,l=(E-m)*d):(o=(E-m)*d,l=(y-m)*d),!(s>l||o>a)&&((o>s||isNaN(s))&&(s=o),(l<a||isNaN(a))&&(a=l),f>=0?(c=(x-p)*f,h=(C-p)*f):(c=(C-p)*f,h=(x-p)*f),!(s>h||c>a)&&((c>s||s!=s)&&(s=c),(h<a||a!=a)&&(a=h),s<=i&&a>=r))}function cm(e,t,n,r,i,s,a){OA.setBuffer(e._roots[t]),hm(0,e,n,r,i,s,a),OA.clearBuffer()}function hm(e,t,n,r,i,s,a){const{float32Array:o,uint16Array:l,uint32Array:c}=OA,h=2*e;if(uA(h,l)){!function(e,t,n,r,i,s,a,o){const{geometry:l,_indirectBuffer:c}=e;for(let h=r,u=r+i;h<u;h++)im(l,t,n,h,s,a,o)}(t,n,r,dA(e,c),fA(h,l),i,s,a)}else{const l=AA(e);lm(l,o,r,s,a)&&hm(l,t,n,r,i,s,a);const h=mA(e,c);lm(h,o,r,s,a)&&hm(h,t,n,r,i,s,a)}}const um=["x","y","z"];function dm(e,t,n,r,i,s){OA.setBuffer(e._roots[t]);const a=fm(0,e,n,r,i,s);return OA.clearBuffer(),a}function fm(e,t,n,r,i,s){const{float32Array:a,uint16Array:o,uint32Array:l}=OA;let c=2*e;if(uA(c,o)){return function(e,t,n,r,i,s,a){const{geometry:o,_indirectBuffer:l}=e;let c=1/0,h=null;for(let u=r,d=r+i;u<d;u++){let e;e=im(o,t,n,u,null,s,a),e&&e.distance<c&&(h=e,c=e.distance)}return h}(t,n,r,dA(e,l),fA(c,o),i,s)}{const o=pA(e,l),c=um[o],h=r.direction[c]>=0;let u,d;h?(u=AA(e),d=mA(e,l)):(u=mA(e,l),d=AA(e));const f=lm(u,a,r,i,s)?fm(u,t,n,r,i,s):null;if(f){const e=f.point[c];if(h?e<=a[d+o]:e>=a[d+o+3])return f}const A=lm(d,a,r,i,s)?fm(d,t,n,r,i,s):null;return f&&A?f.distance<=A.distance?f:A:f||A||null}}const Am=new a.NRn,mm=new DA,pm=new DA,gm=new a.kn4,vm=new PA,ym=new PA;function Em(e,t,n,r){OA.setBuffer(e._roots[t]);const i=xm(0,e,n,r);return OA.clearBuffer(),i}function xm(e,t,n,r,i=null){const{float32Array:s,uint16Array:a,uint32Array:o}=OA;let l=2*e;null===i&&(n.boundingBox||n.computeBoundingBox(),vm.set(n.boundingBox.min,n.boundingBox.max,r),i=vm);if(!uA(l,a)){const a=e+8,l=o[e+6];$f(a,s,Am);if(i.intersectsBox(Am)&&xm(a,t,n,r,i))return!0;$f(l,s,Am);return!!(i.intersectsBox(Am)&&xm(l,t,n,r,i))}{const i=t.geometry,c=i.index,h=i.attributes.position,u=n.index,d=n.attributes.position,f=dA(e,o),A=fA(l,a);if(gm.copy(r).invert(),n.boundsTree){$f(e,s,ym),ym.matrix.copy(gm),ym.needsUpdate=!0;const t=n.boundsTree.shapecast({intersectsBounds:e=>ym.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(r),e.b.applyMatrix4(r),e.c.applyMatrix4(r),e.needsUpdate=!0;for(let t=3*f,n=3*(A+f);t<n;t+=3)if(sm(pm,t,c,h),pm.needsUpdate=!0,e.intersectsTriangle(pm))return!0;return!1}});return t}for(let e=3*f,t=3*(A+f);e<t;e+=3){sm(mm,e,c,h),mm.a.applyMatrix4(gm),mm.b.applyMatrix4(gm),mm.c.applyMatrix4(gm),mm.needsUpdate=!0;for(let e=0,t=u.count;e<t;e+=3)if(sm(pm,e,u,d),pm.needsUpdate=!0,mm.intersectsTriangle(pm))return!0}}}const Cm=new a.kn4,wm=new PA,Im=new PA,bm=new a.Pq0,Sm=new a.Pq0,Bm=new a.Pq0,Tm=new a.Pq0;function _m(e,t,n,r={},i={},s=0,a=1/0){t.boundingBox||t.computeBoundingBox(),wm.set(t.boundingBox.min,t.boundingBox.max,n),wm.needsUpdate=!0;const o=e.geometry,l=o.attributes.position,c=o.index,h=t.attributes.position,u=t.index,d=FA.getPrimitive(),f=FA.getPrimitive();let A=bm,m=Sm,p=null,g=null;i&&(p=Bm,g=Tm);let v=1/0,y=null,E=null;return Cm.copy(n).invert(),Im.matrix.copy(Cm),e.shapecast({boundsTraverseOrder:e=>wm.distanceToBox(e),intersectsBounds:(e,t,n)=>n<v&&n<a&&(t&&(Im.min.copy(e.min),Im.max.copy(e.max),Im.needsUpdate=!0),!0),intersectsRange:(e,r)=>{if(t.boundsTree){return t.boundsTree.shapecast({boundsTraverseOrder:e=>Im.distanceToBox(e),intersectsBounds:(e,t,n)=>n<v&&n<a,intersectsRange:(t,i)=>{for(let a=t,o=t+i;a<o;a++){sm(f,3*a,u,h),f.a.applyMatrix4(n),f.b.applyMatrix4(n),f.c.applyMatrix4(n),f.needsUpdate=!0;for(let t=e,n=e+r;t<n;t++){sm(d,3*t,c,l),d.needsUpdate=!0;const e=d.distanceToTriangle(f,A,p);if(e<v&&(m.copy(A),g&&g.copy(p),v=e,y=t,E=a),e<s)return!0}}}})}for(let i=0,a=Vf(t);i<a;i++){sm(f,3*i,u,h),f.a.applyMatrix4(n),f.b.applyMatrix4(n),f.c.applyMatrix4(n),f.needsUpdate=!0;for(let t=e,n=e+r;t<n;t++){sm(d,3*t,c,l),d.needsUpdate=!0;const e=d.distanceToTriangle(f,A,p);if(e<v&&(m.copy(A),g&&g.copy(p),v=e,y=t,E=i),e<s)return!0}}}}),FA.releasePrimitive(d),FA.releasePrimitive(f),v===1/0?null:(r.point?r.point.copy(m):r.point=m.clone(),r.distance=v,r.faceIndex=y,i&&(i.point?i.point.copy(g):i.point=g.clone(),i.point.applyMatrix4(Cm),m.applyMatrix4(Cm),i.distance=m.sub(i.point).length(),i.faceIndex=E),r)}function Mm(e,t,n,r,i,s,a){const{geometry:o}=n,{index:l}=o,c=o.attributes.position;for(let h=e,u=t+e;h<u;h++){let e;if(e=n.resolveTriangleIndex(h),sm(a,3*e,l,c),a.needsUpdate=!0,r(a,e,i,s))return!0}return!1}function Rm(e,t=null){t&&Array.isArray(t)&&(t=new Set(t));const n=e.geometry,r=n.index?n.index.array:null,i=n.attributes.position;let s,a,o,l,c=0;const h=e._roots;for(let d=0,f=h.length;d<f;d++)s=h[d],a=new Uint32Array(s),o=new Uint16Array(s),l=new Float32Array(s),u(0,c),c+=s.byteLength;function u(n,s,c=!1){const h=2*n;if(o[h+15]===Gf){const t=a[n+6];let s=1/0,c=1/0,u=1/0,d=-1/0,f=-1/0,A=-1/0;for(let n=t,a=t+o[h+14];n<a;n++){const t=3*e.resolveTriangleIndex(n);for(let e=0;e<3;e++){let n=t+e;n=r?r[n]:n;const a=i.getX(n),o=i.getY(n),l=i.getZ(n);a<s&&(s=a),a>d&&(d=a),o<c&&(c=o),o>f&&(f=o),l<u&&(u=l),l>A&&(A=l)}}return(l[n+0]!==s||l[n+1]!==c||l[n+2]!==u||l[n+3]!==d||l[n+4]!==f||l[n+5]!==A)&&(l[n+0]=s,l[n+1]=c,l[n+2]=u,l[n+3]=d,l[n+4]=f,l[n+5]=A,!0)}{const e=n+8,r=a[n+6],i=e+s,o=r+s;let h=c,d=!1,f=!1;t?h||(d=t.has(i),f=t.has(o),h=!d&&!f):(d=!0,f=!0);const A=h||f;let m=!1;(h||d)&&(m=u(e,s,h));let p=!1;A&&(p=u(r,s,h));const g=m||p;if(g)for(let t=0;t<3;t++){const i=e+t,s=r+t,a=l[i],o=l[i+3],c=l[s],h=l[s+3];l[n+t]=a<c?a:c,l[n+t+3]=o>h?o:h}return g}}}function Dm(e,t,n,r,i,s,a){OA.setBuffer(e._roots[t]),Pm(0,e,n,r,i,s,a),OA.clearBuffer()}function Pm(e,t,n,r,i,s,a){const{float32Array:o,uint16Array:l,uint32Array:c}=OA,h=2*e;if(uA(h,l)){!function(e,t,n,r,i,s,a,o){const{geometry:l,_indirectBuffer:c}=e;for(let h=r,u=r+i;h<u;h++)im(l,t,n,c?c[h]:h,s,a,o)}(t,n,r,dA(e,c),fA(h,l),i,s,a)}else{const l=AA(e);lm(l,o,r,s,a)&&Pm(l,t,n,r,i,s,a);const h=mA(e,c);lm(h,o,r,s,a)&&Pm(h,t,n,r,i,s,a)}}const Lm=["x","y","z"];function km(e,t,n,r,i,s){OA.setBuffer(e._roots[t]);const a=Fm(0,e,n,r,i,s);return OA.clearBuffer(),a}function Fm(e,t,n,r,i,s){const{float32Array:a,uint16Array:o,uint32Array:l}=OA;let c=2*e;if(uA(c,o)){return function(e,t,n,r,i,s,a){const{geometry:o,_indirectBuffer:l}=e;let c=1/0,h=null;for(let u=r,d=r+i;u<d;u++){let e;e=im(o,t,n,l?l[u]:u,null,s,a),e&&e.distance<c&&(h=e,c=e.distance)}return h}(t,n,r,dA(e,l),fA(c,o),i,s)}{const o=pA(e,l),c=Lm[o],h=r.direction[c]>=0;let u,d;h?(u=AA(e),d=mA(e,l)):(u=mA(e,l),d=AA(e));const f=lm(u,a,r,i,s)?Fm(u,t,n,r,i,s):null;if(f){const e=f.point[c];if(h?e<=a[d+o]:e>=a[d+o+3])return f}const A=lm(d,a,r,i,s)?Fm(d,t,n,r,i,s):null;return f&&A?f.distance<=A.distance?f:A:f||A||null}}const Om=new a.NRn,Um=new DA,Qm=new DA,Nm=new a.kn4,zm=new PA,Gm=new PA;function Hm(e,t,n,r){OA.setBuffer(e._roots[t]);const i=qm(0,e,n,r);return OA.clearBuffer(),i}function qm(e,t,n,r,i=null){const{float32Array:s,uint16Array:a,uint32Array:o}=OA;let l=2*e;null===i&&(n.boundingBox||n.computeBoundingBox(),zm.set(n.boundingBox.min,n.boundingBox.max,r),i=zm);if(!uA(l,a)){const a=e+8,l=o[e+6];$f(a,s,Om);if(i.intersectsBox(Om)&&qm(a,t,n,r,i))return!0;$f(l,s,Om);return!!(i.intersectsBox(Om)&&qm(l,t,n,r,i))}{const i=t.geometry,c=i.index,h=i.attributes.position,u=n.index,d=n.attributes.position,f=dA(e,o),A=fA(l,a);if(Nm.copy(r).invert(),n.boundsTree){$f(e,s,Gm),Gm.matrix.copy(Nm),Gm.needsUpdate=!0;const i=n.boundsTree.shapecast({intersectsBounds:e=>Gm.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(r),e.b.applyMatrix4(r),e.c.applyMatrix4(r),e.needsUpdate=!0;for(let n=f,r=A+f;n<r;n++)if(sm(Qm,3*t.resolveTriangleIndex(n),c,h),Qm.needsUpdate=!0,e.intersectsTriangle(Qm))return!0;return!1}});return i}for(let e=f,n=A+f;e<n;e++){const n=t.resolveTriangleIndex(e);sm(Um,3*n,c,h),Um.a.applyMatrix4(Nm),Um.b.applyMatrix4(Nm),Um.c.applyMatrix4(Nm),Um.needsUpdate=!0;for(let e=0,t=u.count;e<t;e+=3)if(sm(Qm,e,u,d),Qm.needsUpdate=!0,Um.intersectsTriangle(Qm))return!0}}}const Ym=new a.kn4,jm=new PA,Vm=new PA,Km=new a.Pq0,Wm=new a.Pq0,Jm=new a.Pq0,Xm=new a.Pq0;function $m(e,t,n,r={},i={},s=0,a=1/0){t.boundingBox||t.computeBoundingBox(),jm.set(t.boundingBox.min,t.boundingBox.max,n),jm.needsUpdate=!0;const o=e.geometry,l=o.attributes.position,c=o.index,h=t.attributes.position,u=t.index,d=FA.getPrimitive(),f=FA.getPrimitive();let A=Km,m=Wm,p=null,g=null;i&&(p=Jm,g=Xm);let v=1/0,y=null,E=null;return Ym.copy(n).invert(),Vm.matrix.copy(Ym),e.shapecast({boundsTraverseOrder:e=>jm.distanceToBox(e),intersectsBounds:(e,t,n)=>n<v&&n<a&&(t&&(Vm.min.copy(e.min),Vm.max.copy(e.max),Vm.needsUpdate=!0),!0),intersectsRange:(r,i)=>{if(t.boundsTree){const o=t.boundsTree;return o.shapecast({boundsTraverseOrder:e=>Vm.distanceToBox(e),intersectsBounds:(e,t,n)=>n<v&&n<a,intersectsRange:(t,a)=>{for(let x=t,C=t+a;x<C;x++){const t=o.resolveTriangleIndex(x);sm(f,3*t,u,h),f.a.applyMatrix4(n),f.b.applyMatrix4(n),f.c.applyMatrix4(n),f.needsUpdate=!0;for(let n=r,a=r+i;n<a;n++){const t=e.resolveTriangleIndex(n);sm(d,3*t,c,l),d.needsUpdate=!0;const r=d.distanceToTriangle(f,A,p);if(r<v&&(m.copy(A),g&&g.copy(p),v=r,y=n,E=x),r<s)return!0}}}})}for(let a=0,o=Vf(t);a<o;a++){sm(f,3*a,u,h),f.a.applyMatrix4(n),f.b.applyMatrix4(n),f.c.applyMatrix4(n),f.needsUpdate=!0;for(let t=r,n=r+i;t<n;t++){const n=e.resolveTriangleIndex(t);sm(d,3*n,c,l),d.needsUpdate=!0;const r=d.distanceToTriangle(f,A,p);if(r<v&&(m.copy(A),g&&g.copy(p),v=r,y=t,E=a),r<s)return!0}}}}),FA.releasePrimitive(d),FA.releasePrimitive(f),v===1/0?null:(r.point?r.point.copy(m):r.point=m.clone(),r.distance=v,r.faceIndex=y,i&&(i.point?i.point.copy(g):i.point=g.clone(),i.point.applyMatrix4(Ym),m.applyMatrix4(Ym),i.distance=m.sub(i.point).length(),i.faceIndex=E),r)}const Zm=new OA.constructor,ep=new OA.constructor,tp=new LA((()=>new a.NRn)),np=new a.NRn,rp=new a.NRn,ip=new a.NRn,sp=new a.NRn;let ap=!1;function op(e,t,n,r,i,s=0,a=0,o=0,l=0,c=null,h=!1){let u,d;h?(u=ep,d=Zm):(u=Zm,d=ep);const f=u.float32Array,A=u.uint32Array,m=u.uint16Array,p=d.float32Array,g=d.uint32Array,v=d.uint16Array,y=2*t,E=uA(2*e,m),x=uA(y,v);let C=!1;if(x&&E)C=h?i(dA(t,g),fA(2*t,v),dA(e,A),fA(2*e,m),l,a+t,o,s+e):i(dA(e,A),fA(2*e,m),dA(t,g),fA(2*t,v),o,s+e,l,a+t);else if(x){const c=tp.getPrimitive();$f(t,p,c),c.applyMatrix4(n);const u=AA(e),d=mA(e,A);$f(u,f,np),$f(d,f,rp);const m=c.intersectsBox(np),g=c.intersectsBox(rp);C=m&&op(t,u,r,n,i,a,s,l,o+1,c,!h)||g&&op(t,d,r,n,i,a,s,l,o+1,c,!h),tp.releasePrimitive(c)}else{const u=AA(t),d=mA(t,g);$f(u,p,ip),$f(d,p,sp);const m=c.intersectsBox(ip),v=c.intersectsBox(sp);if(m&&v)C=op(e,u,n,r,i,s,a,o,l+1,c,h)||op(e,d,n,r,i,s,a,o,l+1,c,h);else if(m)if(E)C=op(e,u,n,r,i,s,a,o,l+1,c,h);else{const t=tp.getPrimitive();t.copy(ip).applyMatrix4(n);const c=AA(e),d=mA(e,A);$f(c,f,np),$f(d,f,rp);const m=t.intersectsBox(np),p=t.intersectsBox(rp);C=m&&op(u,c,r,n,i,a,s,l,o+1,t,!h)||p&&op(u,d,r,n,i,a,s,l,o+1,t,!h),tp.releasePrimitive(t)}else if(v)if(E)C=op(e,d,n,r,i,s,a,o,l+1,c,h);else{const t=tp.getPrimitive();t.copy(sp).applyMatrix4(n);const c=AA(e),u=mA(e,A);$f(c,f,np),$f(u,f,rp);const m=t.intersectsBox(np),p=t.intersectsBox(rp);C=m&&op(d,c,r,n,i,a,s,l,o+1,t,!h)||p&&op(d,u,r,n,i,a,s,l,o+1,t,!h),tp.releasePrimitive(t)}}return C}const lp=new PA,cp=new a.NRn,hp={strategy:0,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class up{static serialize(e,t={}){t={cloneBuffers:!0,...t};const n=e.geometry,r=e._roots,i=e._indirectBuffer,s=n.getIndex();let a;return a=t.cloneBuffers?{roots:r.map((e=>e.slice())),index:s?s.array.slice():null,indirectBuffer:i?i.slice():null}:{roots:r,index:s?s.array:null,indirectBuffer:i},a}static deserialize(e,t,n={}){n={setIndex:!0,indirect:Boolean(e.indirectBuffer),...n};const{index:r,roots:i,indirectBuffer:s}=e,o=new up(t,{...n,[qf]:!0});if(o._roots=i,o._indirectBuffer=s||null,n.setIndex){const n=t.getIndex();if(null===n){const n=new a.THS(e.index,1,!1);t.setIndex(n)}else n.array!==r&&(n.array.set(r),n.needsUpdate=!0)}return o}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(!e.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((t=Object.assign({...hp,[qf]:!1},t)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[qf]||(SA(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new a.NRn))),this.resolveTriangleIndex=t.indirect?e=>this._indirectBuffer[e]:e=>e}refit(e=null){return(this.indirect?Rm:om)(this,e)}traverse(e,t=0){const n=this._roots[t],r=new Uint32Array(n),i=new Uint16Array(n);!function t(s,a=0){const o=2*s,l=i[o+15]===Gf;if(l){const t=r[s+6],c=i[o+14];e(a,l,new Float32Array(n,4*s,6),t,c)}else{const i=s+8,o=r[s+6],c=r[s+7];e(a,l,new Float32Array(n,4*s,6),c)||(t(i,a+1),t(o,a+1))}}(0)}raycast(e,t=a.hB5,n=0,r=1/0){const i=this._roots,s=this.geometry,o=[],l=t.isMaterial,c=Array.isArray(t),h=s.groups,u=l?t.side:t,d=this.indirect?Dm:cm;for(let a=0,f=i.length;a<f;a++){const i=c?t[h[a].materialIndex].side:u,s=o.length;if(d(this,a,i,e,o,n,r),c){const e=h[a].materialIndex;for(let t=s,n=o.length;t<n;t++)o[t].face.materialIndex=e}}return o}raycastFirst(e,t=a.hB5,n=0,r=1/0){const i=this._roots,s=this.geometry,o=t.isMaterial,l=Array.isArray(t);let c=null;const h=s.groups,u=o?t.side:t,d=this.indirect?km:dm;for(let a=0,f=i.length;a<f;a++){const i=d(this,a,l?t[h[a].materialIndex].side:u,e,n,r);null!=i&&(null==c||i.distance<c.distance)&&(c=i,l&&(i.face.materialIndex=h[a].materialIndex))}return c}intersectsGeometry(e,t){let n=!1;const r=this._roots,i=this.indirect?Hm:Em;for(let s=0,a=r.length;s<a&&(n=i(this,s,e,t),!n);s++);return n}shapecast(e){const t=FA.getPrimitive(),n=this.indirect?Mm:am;let{boundsTraverseOrder:r,intersectsBounds:i,intersectsRange:s,intersectsTriangle:a}=e;if(s&&a){const e=s;s=(r,i,s,o,l)=>!!e(r,i,s,o,l)||n(r,i,this,a,s,o,t)}else s||(s=a?(e,r,i,s)=>n(e,r,this,a,i,s,t):(e,t,n)=>n);let o=!1,l=0;const c=this._roots;for(let h=0,u=c.length;h<u;h++){const e=c[h];if(o=GA(this,h,i,s,r,l),o)break;l+=e.byteLength}return FA.releasePrimitive(t),o}bvhcast(e,t,n){let{intersectsRanges:r,intersectsTriangles:i}=n;const s=FA.getPrimitive(),o=this.geometry.index,l=this.geometry.attributes.position,c=this.indirect?e=>{const t=this.resolveTriangleIndex(e);sm(s,3*t,o,l)}:e=>{sm(s,3*e,o,l)},h=FA.getPrimitive(),u=e.geometry.index,d=e.geometry.attributes.position,f=e.indirect?t=>{const n=e.resolveTriangleIndex(t);sm(h,3*n,u,d)}:e=>{sm(h,3*e,u,d)};if(i){const e=(e,n,r,a,o,l,u,d)=>{for(let A=r,m=r+a;A<m;A++){f(A),h.a.applyMatrix4(t),h.b.applyMatrix4(t),h.c.applyMatrix4(t),h.needsUpdate=!0;for(let t=e,r=e+n;t<r;t++)if(c(t),s.needsUpdate=!0,i(s,h,t,A,o,l,u,d))return!0}return!1};if(r){const t=r;r=function(n,r,i,s,a,o,l,c){return!!t(n,r,i,s,a,o,l,c)||e(n,r,i,s,a,o,l,c)}}else r=e}return function(e,t,n,r){if(ap)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");ap=!0;const i=e._roots,s=t._roots;let o,l=0,c=0;const h=(new a.kn4).copy(n).invert();for(let a=0,u=i.length;a<u;a++){Zm.setBuffer(i[a]),c=0;const e=tp.getPrimitive();$f(0,Zm.float32Array,e),e.applyMatrix4(h);for(let t=0,i=s.length;t<i&&(ep.setBuffer(s[t]),o=op(0,0,n,h,r,l,c,0,0,e),ep.clearBuffer(),c+=s[t].length,!o);t++);if(tp.releasePrimitive(e),Zm.clearBuffer(),l+=i[a].length,o)break}return ap=!1,o}(this,e,t,r)}intersectsBox(e,t){return lp.set(e.min,e.max,t),lp.needsUpdate=!0,this.shapecast({intersectsBounds:e=>lp.intersectsBox(e),intersectsTriangle:e=>lp.intersectsTriangle(e)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,n={},r={},i=0,s=1/0){return(this.indirect?$m:_m)(this,e,t,n,r,i,s)}closestPointToPoint(e,t={},n=0,r=1/0){return function(e,t,n={},r=0,i=1/0){const s=r*r,a=i*i;let o=1/0,l=null;if(e.shapecast({boundsTraverseOrder:e=>(qA.copy(t).clamp(e.min,e.max),qA.distanceToSquared(t)),intersectsBounds:(e,t,n)=>n<o&&n<a,intersectsTriangle:(e,n)=>{e.closestPointToPoint(t,qA);const r=t.distanceToSquared(qA);return r<o&&(YA.copy(qA),o=r,l=n),r<s}}),o===1/0)return null;const c=Math.sqrt(o);return n.point?n.point.copy(YA):n.point=YA.clone(),n.distance=c,n.faceIndex=l,n}(this,e,t,n,r)}getBoundingBox(e){e.makeEmpty();return this._roots.forEach((t=>{$f(0,new Float32Array(t),cp),e.union(cp)})),e}}parseInt(a.sPf);const dp=new a.RlV,fp=new a.Pq0,Ap=new a.kn4,mp=a.eaF.prototype.raycast,pp=a.$Ed.prototype.raycast,gp=new a.Pq0,vp=new a.eaF,yp=[];function Ep(e,t){this.isBatchedMesh?xp.call(this,e,t):Cp.call(this,e,t)}function xp(e,t){if(this.boundsTrees){const n=this.boundsTrees,r=this._drawInfo||this._instanceInfo,i=this._drawRanges||this._geometryInfo,s=this.matrixWorld;vp.material=this.material,vp.geometry=this.geometry;const o=vp.geometry.boundsTree,l=vp.geometry.drawRange;null===vp.geometry.boundingSphere&&(vp.geometry.boundingSphere=new a.iyt);for(let a=0,c=r.length;a<c;a++){if(!this.getVisibleAt(a))continue;const o=r[a].geometryIndex;if(vp.geometry.boundsTree=n[o],this.getMatrixAt(a,vp.matrixWorld).premultiply(s),!vp.geometry.boundsTree){this.getBoundingBoxAt(o,vp.geometry.boundingBox),this.getBoundingSphereAt(o,vp.geometry.boundingSphere);const e=i[o];vp.geometry.setDrawRange(e.start,e.count)}vp.raycast(e,yp);for(let e=0,n=yp.length;e<n;e++){const n=yp[e];n.object=this,n.batchId=a,t.push(n)}yp.length=0}vp.geometry.boundsTree=o,vp.geometry.drawRange=l,vp.material=null,vp.geometry=null}else pp.call(this,e,t)}function Cp(e,t){if(this.geometry.boundsTree){if(void 0===this.material)return;Ap.copy(this.matrixWorld).invert(),dp.copy(e.ray).applyMatrix4(Ap),gp.setFromMatrixScale(this.matrixWorld),fp.copy(dp.direction).multiply(gp);const n=fp.length(),r=e.near/n,i=e.far/n,s=this.geometry.boundsTree;if(!0===e.firstHitOnly){const n=Yf(s.raycastFirst(dp,this.material,r,i),this,e);n&&t.push(n)}else{const n=s.raycast(dp,this.material,r,i);for(let r=0,i=n.length;r<i;r++){const i=Yf(n[r],this,e);i&&t.push(i)}}}else mp.call(this,e,t)}function wp(e={}){return this.boundsTree=new up(this,e),this.boundsTree}function Ip(){this.boundsTree=null}const bp=e=>e.isMesh;function Sp(e,t){t={strategy:Qf,verbose:!1,setBoundingBox:!0,maxDepth:40,maxLeafTris:10,indirect:!1,...t},i.useEffect((()=>{if(e.current){e.current.raycast=Ep;const n=e.current.geometry;return n.computeBoundsTree=wp,n.disposeBoundsTree=Ip,n.computeBoundsTree(t),()=>{n.boundsTree&&n.disposeBoundsTree()}}}),[e,JSON.stringify(t)])}const Bp=i.forwardRef((({enabled:e=!0,firstHitOnly:t=!1,children:n,strategy:s=Qf,verbose:l=!1,setBoundingBox:c=!0,maxDepth:h=40,maxLeafTris:u=10,indirect:d=!1,...f},A)=>{const m=i.useRef(null),p=(0,o.A)((e=>e.raycaster));return i.useImperativeHandle(A,(()=>m.current),[]),i.useEffect((()=>{if(e){const e={strategy:s,verbose:l,setBoundingBox:c,maxDepth:h,maxLeafTris:u,indirect:d},n=m.current;return p.firstHitOnly=t,n.traverse((t=>{bp(t)&&!t.geometry.boundsTree&&t.raycast===a.eaF.prototype.raycast&&(t.raycast=Ep,t.geometry.computeBoundsTree=wp,t.geometry.disposeBoundsTree=Ip,t.geometry.computeBoundsTree(e))})),()=>{delete p.firstHitOnly,n.traverse((e=>{bp(e)&&e.geometry.boundsTree&&(e.geometry.disposeBoundsTree(),e.raycast=a.eaF.prototype.raycast)}))}}}),[]),i.createElement("group",(0,r.A)({ref:m},f),n)}));function Tp(...e){const t=i.useRef([]);return t.current=e.map((e=>i.useContext(e))),i.useMemo((()=>({children:n})=>e.reduceRight(((e,n,r)=>i.createElement(n.Provider,{value:t.current[r],children:e})),n)),[])}function _p(e,t){const n=i.useRef(null),[r]=i.useState((()=>t?t instanceof a.B69?{current:t}:t:n)),[s]=i.useState((()=>new a.Iw4(void 0)));i.useLayoutEffect((()=>{t&&(r.current=t instanceof a.B69?t:t.current),s._root=r.current}));const l=i.useRef({}),c=i.useMemo((()=>{const t={};return e.forEach((e=>Object.defineProperty(t,e.name,{enumerable:!0,get(){if(r.current)return l.current[e.name]||(l.current[e.name]=s.clipAction(e,r.current))},configurable:!0}))),{ref:r,clips:e,actions:t,names:e.map((e=>e.name)),mixer:s}}),[e]);return(0,o.C)(((e,t)=>s.update(t))),i.useEffect((()=>{const e=r.current;return()=>{l.current={},s.stopAllAction(),Object.values(c.actions).forEach((t=>{e&&s.uncacheAction(t,e)}))}}),[e]),c}function Mp(e){const t=i.useRef(null),n=i.useRef(!1),r=i.useRef(!1),s=i.useRef(e);return i.useLayoutEffect((()=>{s.current=e}),[e]),i.useEffect((()=>{const e=t.current;if(e){const t=(0,o.j)((()=>(n.current=!1,!0))),i=e.onBeforeRender;e.onBeforeRender=()=>n.current=!0;const a=(0,o.k)((()=>(n.current!==r.current&&(null==s.current||s.current(r.current=n.current)),!0)));return()=>{e.onBeforeRender=i,t(),a()}}}),[]),t}const Rp="\n#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n  vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n  #ifdef BOX_PROJECTED_ENV_MAP\n    vWorldPosition = worldPosition.xyz;\n  #endif\n#endif\n",Dp="\n#ifdef BOX_PROJECTED_ENV_MAP\n  uniform vec3 envMapSize;\n  uniform vec3 envMapPosition;\n  varying vec3 vWorldPosition;\n    \n  vec3 parallaxCorrectNormal( vec3 v, vec3 cubeSize, vec3 cubePos ) {\n    vec3 nDir = normalize( v );\n    vec3 rbmax = ( .5 * cubeSize + cubePos - vWorldPosition ) / nDir;\n    vec3 rbmin = ( -.5 * cubeSize + cubePos - vWorldPosition ) / nDir;\n    vec3 rbminmax;\n    rbminmax.x = ( nDir.x > 0. ) ? rbmax.x : rbmin.x;\n    rbminmax.y = ( nDir.y > 0. ) ? rbmax.y : rbmin.y;\n    rbminmax.z = ( nDir.z > 0. ) ? rbmax.z : rbmin.z;\n    float correction = min( min( rbminmax.x, rbminmax.y ), rbminmax.z );\n    vec3 boxIntersection = vWorldPosition + nDir * correction;    \n    return boxIntersection - cubePos;\n  }\n#endif\n",Pp="\n#ifdef BOX_PROJECTED_ENV_MAP\n  worldNormal = parallaxCorrectNormal( worldNormal, envMapSize, envMapPosition );\n#endif\n",Lp="\n#ifdef BOX_PROJECTED_ENV_MAP\n  reflectVec = parallaxCorrectNormal( reflectVec, envMapSize, envMapPosition );\n#endif\n";function kp(e=new a.Pq0,t=new a.Pq0){const[n]=i.useState((()=>({position:new a.Pq0,size:new a.Pq0})));(0,o.q)(n,{position:e,size:t});const r=i.useRef(null),s=i.useMemo((()=>({ref:r,onBeforeCompile:e=>function(e,t,n){e.defines.BOX_PROJECTED_ENV_MAP=!0,e.uniforms.envMapPosition={value:t},e.uniforms.envMapSize={value:n},e.vertexShader=`\n  varying vec3 vWorldPosition;\n  ${e.vertexShader.replace("#include <worldpos_vertex>",Rp)}`,e.fragmentShader=`\n    ${Dp}\n    ${e.fragmentShader.replace("#include <envmap_physical_pars_fragment>",br.ShaderChunk.envmap_physical_pars_fragment).replace("vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );",`vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n         ${Pp}\n         `).replace("reflectVec = inverseTransformDirection( reflectVec, viewMatrix );",`reflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n         ${Lp}\n        `)}`}(e,n.position,n.size),customProgramCacheKey:()=>JSON.stringify(n.position.toArray())+JSON.stringify(n.size.toArray())})),[...n.position.toArray(),...n.size.toArray()]);return i.useLayoutEffect((()=>{r.current.needsUpdate=!0}),[n]),s}const Fp=new a.NRn,Op=new a.Pq0,Up=({anchor:e,...t})=>{const n=i.useRef(null),s=i.useRef(null);return i.useEffect((()=>{var e;null!=(e=n.current)&&null!=(e=e.parent)&&e.parent&&(s.current=n.current.parent,n.current.parent.parent.add(n.current))}),[]),(0,o.C)((()=>{s.current&&(Fp.setFromObject(s.current),Fp.getSize(Op),n.current.position.set(s.current.position.x+Op.x*(Array.isArray(e)?e[0]:e.x)/2,s.current.position.y+Op.y*(Array.isArray(e)?e[1]:e.y)/2,s.current.position.z+Op.z*(Array.isArray(e)?e[2]:e.z)/2))})),i.createElement("group",(0,r.A)({ref:n},t))};const Qp=e=>Math.sqrt(1-Math.pow(e-1,2));class Np{constructor({size:e=256,maxAge:t=750,radius:n=.3,intensity:r=.2,interpolate:i=0,smoothing:s=0,minForce:a=.3,blend:o="screen",ease:l=Qp}={}){this.size=e,this.maxAge=t,this.radius=n,this.intensity=r,this.ease=l,this.interpolate=i,this.smoothing=s,this.minForce=a,this.blend=o,this.trail=[],this.force=0,this.initTexture()}initTexture(){this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=this.size;const e=this.canvas.getContext("2d");if(null===e)throw new Error("2D not available");this.ctx=e,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.texture=new a.gPd(this.canvas),this.canvas.id="touchTexture",this.canvas.style.width=this.canvas.style.height=`${this.canvas.width}px`}update(e){this.clear(),this.trail.forEach(((t,n)=>{t.age+=1e3*e,t.age>this.maxAge&&this.trail.splice(n,1)})),this.trail.length||(this.force=0),this.trail.forEach((e=>{this.drawTouch(e)})),this.texture.needsUpdate=!0}clear(){this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}addTouch(e){const t=this.trail[this.trail.length-1];if(t){const n=t.x-e.x,r=t.y-e.y,i=n*n+r*r,s=Math.max(this.minForce,Math.min(1e4*i,1));if(this.force=function(e,t,n=.9){return t*n+e*(1-n)}(s,this.force,this.smoothing),this.interpolate){const e=Math.ceil(i/Math.pow(.5*this.radius/this.interpolate,2));if(e>1)for(let i=1;i<e;i++)this.trail.push({x:t.x-n/e*i,y:t.y-r/e*i,age:0,force:s})}}this.trail.push({x:e.x,y:e.y,age:0,force:this.force})}drawTouch(e){const t={x:e.x*this.size,y:(1-e.y)*this.size};let n=1;n=e.age<.3*this.maxAge?this.ease(e.age/(.3*this.maxAge)):this.ease(1-(e.age-.3*this.maxAge)/(.7*this.maxAge)),n*=e.force,this.ctx.globalCompositeOperation=this.blend;const r=this.size*this.radius*n,i=this.ctx.createRadialGradient(t.x,t.y,Math.max(0,.25*r),t.x,t.y,Math.max(0,r));i.addColorStop(0,`rgba(255, 255, 255, ${this.intensity})`),i.addColorStop(1,"rgba(0, 0, 0, 0.0)"),this.ctx.beginPath(),this.ctx.fillStyle=i,this.ctx.arc(t.x,t.y,Math.max(0,r),0,2*Math.PI),this.ctx.fill()}}function zp(e={}){const{size:t,maxAge:n,radius:r,intensity:s,interpolate:a,smoothing:l,minForce:c,blend:h,ease:u}=e,d=(0,i.useMemo)((()=>new Np(e)),[t,n,r,s,a,l,c,h,u]);(0,o.C)(((e,t)=>{d.update(t)}));const f=(0,i.useCallback)((e=>d.addTouch(e.uv)),[d]);return[d.texture,f]}const Gp=({children:e,...t})=>{const n=zp(t);return i.createElement(i.Fragment,null,null==e?void 0:e(n))},Hp=i.forwardRef((function({children:e,disable:t,disableX:n,disableY:s,disableZ:o,left:l,right:c,top:h,bottom:u,front:d,back:f,onCentered:A,precise:m=!0,cacheKey:p=0,...g},v){const y=i.useRef(null),E=i.useRef(null),x=i.useRef(null);return i.useLayoutEffect((()=>{E.current.matrixWorld.identity();const e=(new a.NRn).setFromObject(x.current,m),r=new a.Pq0,i=new a.iyt,p=e.max.x-e.min.x,g=e.max.y-e.min.y,v=e.max.z-e.min.z;e.getCenter(r),e.getBoundingSphere(i);const C=h?g/2:u?-g/2:0,w=l?-p/2:c?p/2:0,I=d?v/2:f?-v/2:0;E.current.position.set(t||n?0:-r.x+w,t||s?0:-r.y+C,t||o?0:-r.z+I),void 0!==A&&A({parent:y.current.parent,container:y.current,width:p,height:g,depth:v,boundingBox:e,boundingSphere:i,center:r,verticalAlignment:C,horizontalAlignment:w,depthAlignment:I})}),[p,A,h,l,d,t,n,s,o,m,c,u,f]),i.useImperativeHandle(v,(()=>y.current),[]),i.createElement("group",(0,r.A)({ref:y},g),i.createElement("group",{ref:E},i.createElement("group",{ref:x},e)))})),qp=i.forwardRef((({font:e,color:t="#cbcbcb",bevelSize:n=.04,debug:r=!1,children:s,...a},o)=>{const[l,c]=i.useState(0),h=i.useCallback(((e=1)=>c(l+e)),[l]),u=i.useCallback(((e=1)=>c(l-e)),[l]),d=i.useMemo((()=>({incr:h,decr:u})),[h,u]);return i.useImperativeHandle(o,(()=>d),[d]),i.createElement("group",a,i.createElement(i.Suspense,{fallback:null},i.createElement(Hp,{top:!0,cacheKey:JSON.stringify({counter:l,font:e})},i.createElement(Fs,{bevelEnabled:!0,bevelSize:n,font:e},r?i.createElement("meshNormalMaterial",{wireframe:!0}):i.createElement("meshStandardMaterial",{color:t}),l))),s)})),Yp=(e,t)=>{e.updateRanges[0]=t};const jp=new a.kn4,Vp=new a.kn4,Kp=[],Wp=new a.eaF;class Jp extends a.YJl{constructor(){super(),this.color=new a.Q1f("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return null==(e=this.instance.current)?void 0:e.geometry}raycast(e,t){const n=this.instance.current;if(!n)return;if(!n.geometry||!n.material)return;Wp.geometry=n.geometry;const r=n.matrixWorld,i=n.userData.instances.indexOf(this.instanceKey);if(!(-1===i||i>n.count)){n.getMatrixAt(i,jp),Vp.multiplyMatrices(r,jp),Wp.matrixWorld=Vp,n.material instanceof a.imn?Wp.material.side=n.material.side:Wp.material.side=n.material[0].side,Wp.raycast(e,Kp);for(let e=0,n=Kp.length;e<n;e++){const n=Kp[e];n.instanceId=i,n.object=this,t.push(n)}Kp.length=0}}}const Xp=i.createContext(null),$p=new a.kn4,Zp=new a.kn4,eg=new a.kn4,tg=new a.Pq0,ng=new a.PTz,rg=new a.Pq0,ig=i.forwardRef((({context:e,children:t,...n},s)=>{i.useMemo((()=>(0,o.e)({PositionMesh:Jp})),[]);const a=i.useRef(null);i.useImperativeHandle(s,(()=>a.current),[]);const{subscribe:l,getParent:c}=i.useContext(e||Xp);return i.useLayoutEffect((()=>l(a)),[]),i.createElement("positionMesh",(0,r.A)({instance:c(),instanceKey:a,ref:a},n),t)})),sg=i.forwardRef((({context:e,children:t,range:n,limit:s=1e3,frames:l=1/0,...c},h)=>{const[{localContext:u,instance:d}]=i.useState((()=>{const e=i.createContext(null);return{localContext:e,instance:i.forwardRef(((t,n)=>i.createElement(ig,(0,r.A)({context:e},t,{ref:n}))))}})),f=i.useRef(null);i.useImperativeHandle(h,(()=>f.current),[]);const[A,m]=i.useState([]),[[p,g]]=i.useState((()=>{const e=new Float32Array(16*s);for(let t=0;t<s;t++)eg.identity().toArray(e,16*t);return[e,new Float32Array([...new Array(3*s)].map((()=>1)))]}));i.useEffect((()=>{f.current.instanceMatrix.needsUpdate=!0}));let v=0,y=0;const E=i.useRef([]);i.useLayoutEffect((()=>{E.current=Object.entries(f.current.geometry.attributes).filter((([e,t])=>t.isInstancedBufferAttribute))})),(0,o.C)((()=>{if(l===1/0||v<l){f.current.updateMatrix(),f.current.updateMatrixWorld(),$p.copy(f.current.matrixWorld).invert(),y=Math.min(s,void 0!==n?n:s,A.length),f.current.count=y,Yp(f.current.instanceMatrix,{start:0,count:16*y}),Yp(f.current.instanceColor,{start:0,count:3*y});for(let e=0;e<A.length;e++){const t=A[e].current;t.matrixWorld.decompose(tg,ng,rg),Zp.compose(tg,ng,rg).premultiply($p),Zp.toArray(p,16*e),f.current.instanceMatrix.needsUpdate=!0,t.color.toArray(g,3*e),f.current.instanceColor.needsUpdate=!0}v++}}));const x=i.useMemo((()=>({getParent:()=>f,subscribe:e=>(m((t=>[...t,e])),()=>m((t=>t.filter((t=>t.current!==e.current)))))})),[]);return i.createElement("instancedMesh",(0,r.A)({userData:{instances:A,limit:s,frames:l},matrixAutoUpdate:!1,ref:f,args:[null,null,0],raycast:()=>null},c),i.createElement("instancedBufferAttribute",{attach:"instanceMatrix",args:[p,16],usage:a.Vnu}),i.createElement("instancedBufferAttribute",{attach:"instanceColor",args:[g,3],usage:a.Vnu}),"function"==typeof t?i.createElement(u.Provider,{value:x},t(d)):e?i.createElement(e.Provider,{value:x},t):i.createElement(Xp.Provider,{value:x},t))})),ag=i.forwardRef((function({meshes:e,children:t,...n},s){const a=Array.isArray(e);if(!a)for(const r of Object.keys(e))e[r].isMesh||delete e[r];const o=(a?e:Object.values(e)).map((({geometry:e,material:t})=>i.createElement(sg,(0,r.A)({key:e.uuid,geometry:e,material:t},n))));return i.createElement("group",{ref:s},og((n=>a?t(...n):t(Object.keys(e).filter((t=>e[t].isMesh)).reduce(((e,t,r)=>({...e,[t]:n[r]})),{}))),o))}));function og(e,t,n=[]){if(!t[0])return e(n);function r(r){return og(e,t.slice(1),n.concat([r]))}return"function"==typeof t[0]?t[0]({results:n,render:r}):i.cloneElement(t[0],{children:r})}function lg(){const e=i.createContext(null);return[i.forwardRef(((t,n)=>i.createElement(sg,(0,r.A)({ref:n,context:e},t)))),i.forwardRef(((t,n)=>i.createElement(ig,(0,r.A)({ref:n,context:e},t))))]}const cg=i.forwardRef((({name:e,defaultValue:t,normalized:n,usage:r=a.Vnu},s)=>{const l=i.useRef(null);i.useImperativeHandle(s,(()=>l.current),[]),i.useLayoutEffect((()=>{const n=l.current.__r3f.parent.object;n.geometry.attributes[e]=l.current;const r=Array.isArray(t)?t:[t],i=Array.from({length:n.userData.limit},(()=>r)).flat();return l.current.array=new Float32Array(i),l.current.itemSize=r.length,l.current.count=i.length/l.current.itemSize,()=>{delete n.geometry.attributes[e]}}),[e]);let c=0;return(0,o.C)((()=>{const t=l.current.__r3f.parent.object;if(t.userData.frames===1/0||c<t.userData.frames){for(let n=0;n<t.userData.instances.length;n++){const r=t.userData.instances[n].current[e];void 0!==r&&(l.current.set(Array.isArray(r)?r:"function"==typeof r.toArray?r.toArray():[r],n*l.current.itemSize),l.current.needsUpdate=!0)}c++}})),i.createElement("instancedBufferAttribute",{ref:l,usage:r,normalized:n})})),hg=i.createContext(null);function ug(){return i.useContext(hg)}const dg=new a.bdM(1,1),fg=i.forwardRef((({startFrame:e=0,endFrame:t,fps:n=30,frameName:s="",textureDataURL:l,textureImageURL:c,loop:h=!1,numberOfFrames:u=1,autoPlay:d=!0,animationNames:f,onStart:A,onEnd:m,onLoopEnd:p,onFrame:g,play:v,pause:y=!1,flipX:E=!1,alphaTest:x=0,children:C,asSprite:w=!1,offset:I,playBackwards:b=!1,resetOnEnd:S=!1,maxItems:B=1,instanceItems:T=[[0,0,0]],spriteDataset:_,canvasRenderingContext2DSettings:M,roundFramePosition:R=!1,meshProps:D={},...P},L)=>{const k=i.useRef(new a.YJl),F=i.useRef(null),O=i.useRef(null),U=i.useRef(null),Q=i.useRef(window.performance.now()),N=i.useRef(e),z=i.useRef(s),G=n>0?1e3/n:0,[H,q]=i.useState(new a.gPd),Y=i.useRef(0),[j,V]=i.useState(new a.Pq0(1,1,1)),K=E?-1:1,W=i.useRef(y),J=i.useRef(I),X=i.useRef(!1),{spriteObj:$,loadJsonAndTexture:Z}=ff(null,null,f,u,void 0,M),ee=i.useRef(s),te=i.useCallback(((e,t)=>{if(null===t)u&&(Y.current=u,b&&(N.current=u-1),F.current=t);else{var n,r;F.current=t,F.current&&Array.isArray(F.current.frames)?Y.current=F.current.frames.length:F.current&&"object"==typeof F.current&&ee.current?Y.current=F.current.frames[ee.current].length:Y.current=0,b&&(N.current=Y.current-1);const{w:i,h:s}=uf(null!==(n=null==(r=F.current)?void 0:r.frames)&&void 0!==n?n:[],ee.current).sourceSize,a=ie(i,s);V(a),O.current&&(O.current.map=e)}q(e)}),[u,b]),ne=i.useCallback((()=>{if(!F.current)return;const{meta:{size:e},frames:t}=F.current,{w:n,h:r}=Array.isArray(t)?t[0].sourceSize:s&&t[s]?t[s][0].sourceSize:{w:0,h:0};O.current&&O.current.map&&(O.current.map.wrapS=O.current.map.wrapT=a.GJx,O.current.map.center.set(0,0),O.current.map.repeat.set(1*K/(e.w/n),1/(e.h/r)));const i=1/((e.h-1)/r);O.current&&O.current.map&&(O.current.map.offset.x=0,O.current.map.offset.y=1-i),A&&A({currentFrameName:null!=s?s:"",currentFrame:N.current})}),[K,s,A]),re=i.useMemo((()=>({current:J.current,offset:J.current,imageUrl:c,hasEnded:!1,ref:L})),[c,L]);i.useImperativeHandle(L,(()=>k.current),[]),i.useLayoutEffect((()=>{J.current=I}),[I]);const ie=(e,t)=>{var n;const r=new a.Pq0,i=t/e;return r.set(1,i,1),null==(n=U.current)||n.scale.copy(r),r};i.useEffect((()=>{var e;_?te(null==_||null==(e=_.spriteTexture)?void 0:e.clone(),_.spriteData):c&&l&&Z(c,l)}),[Z,_,l,c,te]),i.useEffect((()=>{var e;$&&te(null==$||null==(e=$.spriteTexture)?void 0:e.clone(),null==$?void 0:$.spriteData)}),[$,te]),i.useEffect((()=>{var e;(re.hasEnded=!1,F.current&&!0===b)?N.current=(null!==(e=F.current.frames.length)&&void 0!==e?e:0)-1:N.current=0}),[b,re]),i.useLayoutEffect((()=>{ne()}),[H,E,ne]),i.useEffect((()=>{d&&(W.current=!1)}),[d]),i.useLayoutEffect((()=>{if(z.current!==s&&s&&(N.current=0,z.current=s,re.hasEnded=!1,G<=0&&(N.current=t||e||0),F.current)){const{w:e,h:t}=uf(F.current.frames,s).sourceSize,n=ie(e,t);V(n)}}),[s,G,re,t,e]);const se=(e,t,n,r)=>{var i=void 0===I?re.current:I;const s=N.current;let a=0,o=0;ie(e,t);const l=R?Math.round((n.w-1)/e):(n.w-1)/e,c=R?Math.round((n.h-1)/t):(n.h-1)/t;if(!r[s])return;const{frame:{x:h,y:u},sourceSize:{w:d,h:f}}=r[s],A=1/l,m=1/c;if(O.current&&O.current.map&&(a=K>0?A*(h/d):A*(h/d)-O.current.map.repeat.x,o=Math.abs(1-m)-m*(u/f),O.current.map.offset.x=a,O.current.map.offset.y=o),null!=i){let e=Math.floor(i*r.length);e=Math.max(0,Math.min(e,r.length-1)),isNaN(e)&&(e=0),N.current=e}else b?N.current-=1:N.current+=1};return(0,o.C)(((n,r)=>{var i,a;null!=(i=F.current)&&i.frames&&null!=(a=O.current)&&a.map&&(W.current||re.hasEnded||!d&&!v||((()=>{if(null===(n=F.current)||!("meta"in n)||!("frames"in n))return;var n;const{meta:{size:r},frames:i}=F.current,{w:a,h:o}=uf(i,s).sourceSize,l=Array.isArray(i)?i:s?i[s]:[],c=t||l.length-1;var u=void 0===I?re.current:I;if(G<=0)return N.current=t||e||0,void se(a,o,r,l);const d=window.performance.now(),f=d-Q.current;if(!(f<=G)){var g=b?N.current<0:N.current>c,v=b?N.current===c:0===N.current,y=b?N.current<0:N.current>=c;if(g){if(N.current=h&&null!=e?e:0,b&&(N.current=c),h?null==p||p({currentFrameName:null!=s?s:"",currentFrame:N.current}):(null==m||m({currentFrameName:null!=s?s:"",currentFrame:N.current}),re.hasEnded=!S,S&&(W.current=!0)),!h)return}else v&&(null==A||A({currentFrameName:null!=s?s:"",currentFrame:N.current}));void 0!==u&&y?!1===X.current&&(null==m||m({currentFrameName:null!=s?s:"",currentFrame:N.current}),X.current=!0):X.current=!1,f<=G||(Q.current=d-f%G,se(a,o,r,l))}})(),null==g||g({currentFrameName:z.current,currentFrame:N.current})))})),i.createElement("group",(0,r.A)({},P,{ref:k,scale:function(e=new a.Pq0(1,1,1),t=1){return"number"==typeof t?e.multiplyScalar(t):Array.isArray(t)?e.multiply(new a.Pq0(...t)):t instanceof a.Pq0?e.multiply(t):void 0}(j,P.scale)}),i.createElement(hg.Provider,{value:re},w&&i.createElement(fr,null,i.createElement("mesh",(0,r.A)({ref:U,scale:1,geometry:dg},D),i.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:a.$EB,ref:O,map:H,transparent:!0,alphaTest:null!=x?x:0}))),!w&&i.createElement(sg,(0,r.A)({geometry:dg,limit:null!=B?B:1},D),i.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:a.$EB,ref:O,map:H,transparent:!0,alphaTest:null!=x?x:0}),(null!=T?T:[0]).map(((e,t)=>i.createElement(ig,(0,r.A)({key:t,ref:1===(null==T?void 0:T.length)?U:null,position:e,scale:1},D))))),C))}));var Ag=Object.defineProperty,mg=(e,t,n)=>(((e,t,n)=>{t in e?Ag(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const pg=1024,gg=(e,t,n,r,i,s)=>{const a=e.image,{data:o}=a,l=4096*s;o[4*t+l+0]=n,o[4*t+l+1]=r,o[4*t+l+2]=i,o[4*t+l+3]=1};class vg{constructor(e,t=1){mg(this,"curveArray"),mg(this,"curveLengthArray"),mg(this,"object3D"),mg(this,"splineTexure"),mg(this,"uniforms");const n=e.clone(),r=((e=1)=>{const t=new Float32Array(4096*e*4),n=new a.GYF(t,pg,4*e,a.GWd,a.RQf);return n.wrapS=a.GJx,n.wrapT=a.GJx,n.magFilter=a.hxR,n.needsUpdate=!0,n})(t),i={spineTexture:{value:r},pathOffset:{type:"f",value:0},pathSegment:{type:"f",value:1},spineOffset:{type:"f",value:161},spineLength:{type:"f",value:400},flow:{type:"i",value:1}};n.traverse((e=>{(e instanceof a.eaF||e instanceof a.ZLX)&&(e.material=e.material.clone(),function(e,t,n=1){e.__ok||(e.__ok=!0,e.onBeforeCompile=e=>{if(e.__modified)return;e.__modified=!0,Object.assign(e.uniforms,t);const r=`\n\t\tuniform sampler2D spineTexture;\n\t\tuniform float pathOffset;\n\t\tuniform float pathSegment;\n\t\tuniform float spineOffset;\n\t\tuniform float spineLength;\n\t\tuniform int flow;\n\n\t\tfloat textureLayers = ${4*n}.;\n\t\tfloat textureStacks = 1.;\n\n\t\t${e.vertexShader}\n\t\t`.replace("#include <beginnormal_vertex>","").replace("#include <defaultnormal_vertex>","").replace("#include <begin_vertex>","").replace(/void\s*main\s*\(\)\s*\{/,"\n        void main() {\n        #include <beginnormal_vertex>\n\n        vec4 worldPos = modelMatrix * vec4(position, 1.);\n\n        bool bend = flow > 0;\n        float xWeight = bend ? 0. : 1.;\n\n        #ifdef USE_INSTANCING\n        float pathOffsetFromInstanceMatrix = instanceMatrix[3][2];\n        float spineLengthFromInstanceMatrix = instanceMatrix[3][0];\n        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLengthFromInstanceMatrix : 0.;\n        float mt = (spinePortion * pathSegment + pathOffset + pathOffsetFromInstanceMatrix)*textureStacks;\n        #else\n        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLength : 0.;\n        float mt = (spinePortion * pathSegment + pathOffset)*textureStacks;\n        #endif\n\n        mt = mod(mt, textureStacks);\n        float rowOffset = floor(mt);\n\n        #ifdef USE_INSTANCING\n        rowOffset += instanceMatrix[3][1] * 4.;\n        #endif\n\n        vec3 spinePos = texture2D(spineTexture, vec2(mt, (0. + rowOffset + 0.5) / textureLayers)).xyz;\n        vec3 a =        texture2D(spineTexture, vec2(mt, (1. + rowOffset + 0.5) / textureLayers)).xyz;\n        vec3 b =        texture2D(spineTexture, vec2(mt, (2. + rowOffset + 0.5) / textureLayers)).xyz;\n        vec3 c =        texture2D(spineTexture, vec2(mt, (3. + rowOffset + 0.5) / textureLayers)).xyz;\n        mat3 basis = mat3(a, b, c);\n\n        vec3 transformed = basis\n          * vec3(worldPos.x * xWeight, worldPos.y * 1., worldPos.z * 1.)\n          + spinePos;\n\n        vec3 transformedNormal = normalMatrix * (basis * objectNormal);\n\t\t\t").replace("#include <project_vertex>","vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n\t\t\t\tgl_Position = projectionMatrix * mvPosition;");e.vertexShader=r})}(e.material,i,t))})),this.curveArray=new Array(t),this.curveLengthArray=new Array(t),this.object3D=n,this.splineTexure=r,this.uniforms=i}updateCurve(e,t){if(e>=this.curveArray.length)throw Error("Index out of range for Flow");const n=t.getLength();this.uniforms.spineLength.value=n,this.curveLengthArray[e]=n,this.curveArray[e]=t,((e,t,n=0)=>{const r=Math.floor(1024);t.arcLengthDivisions=r/2,t.updateArcLengths();const i=t.getSpacedPoints(r),s=t.computeFrenetFrames(r,!0);for(let a=0;a<r;a++){const t=Math.floor(a/pg),r=a%pg;let o=i[a];gg(e,r,o.x,o.y,o.z,0+t+4*n),o=s.tangents[a],gg(e,r,o.x,o.y,o.z,1+t+4*n),o=s.normals[a],gg(e,r,o.x,o.y,o.z,2+t+4*n),o=s.binormals[a],gg(e,r,o.x,o.y,o.z,3+t+4*n)}e.needsUpdate=!0})(this.splineTexure,t,e)}moveAlongCurve(e){this.uniforms.pathOffset.value+=e}}const yg=i.forwardRef((({children:e,curve:t},n)=>{const[r]=i.useState((()=>new a.Z58)),[s,l]=i.useState(),c=i.useRef(null);return i.useLayoutEffect((()=>{c.current=new vg(r.children[0]),l(c.current.object3D)}),[e]),i.useEffect((()=>{var e;t&&(null==(e=c.current)||e.updateCurve(0,t))}),[t]),i.useImperativeHandle(n,(()=>c.current)),i.createElement(i.Fragment,null,(0,o.o)(e,r),s&&i.createElement("primitive",{object:s}))}));class Eg extends a.uSd{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._distort={value:.4},this._radius={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.radius=this._radius,e.uniforms.distort=this._distort,e.vertexShader=`\n      uniform float time;\n      uniform float radius;\n      uniform float distort;\n      #define GLSLIFY 1\nvec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float snoise(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}\n      ${e.vertexShader}\n    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n        float updateTime = time / 50.0;\n        float noise = snoise(vec3(position / 2.0 + updateTime * 5.0));\n        vec3 transformed = vec3(position * (noise * pow(distort, 2.0) + radius));\n        ")}get time(){return this._time.value}set time(e){this._time.value=e}get distort(){return this._distort.value}set distort(e){this._distort.value=e}get radius(){return this._radius.value}set radius(e){this._radius.value=e}}const xg=i.forwardRef((({speed:e=1,...t},n)=>{const[s]=i.useState((()=>new Eg));return(0,o.C)((t=>s&&(s.time=t.clock.elapsedTime*e))),i.createElement("primitive",(0,r.A)({object:s,ref:n,attach:"material"},t))}));class Cg extends a._4j{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._factor={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.factor=this._factor,e.vertexShader=`\n      uniform float time;\n      uniform float factor;\n      ${e.vertexShader}\n    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","float theta = sin( time + position.y ) / 2.0 * factor;\n        float c = cos( theta );\n        float s = sin( theta );\n        mat3 m = mat3( c, 0, s, 0, 1, 0, -s, 0, c );\n        vec3 transformed = vec3( position ) * m;\n        vNormal = vNormal * m;")}get time(){return this._time.value}set time(e){this._time.value=e}get factor(){return this._factor.value}set factor(e){this._factor.value=e}}const wg=i.forwardRef((({speed:e=1,...t},n)=>{const[s]=i.useState((()=>new Cg));return(0,o.C)((t=>s&&(s.time=t.clock.elapsedTime*e))),i.createElement("primitive",(0,r.A)({object:s,ref:n,attach:"material"},t))}));class Ig extends a.BKk{constructor(e=new a.I9Y){super({uniforms:{inputBuffer:new a.nc$(null),depthBuffer:new a.nc$(null),resolution:new a.nc$(new a.I9Y),texelSize:new a.nc$(new a.I9Y),halfTexelSize:new a.nc$(new a.I9Y),kernel:new a.nc$(0),scale:new a.nc$(1),cameraNear:new a.nc$(0),cameraFar:new a.nc$(1),minDepthThreshold:new a.nc$(0),maxDepthThreshold:new a.nc$(1),depthScale:new a.nc$(0),depthToBlurRatioBias:new a.nc$(.25)},fragmentShader:`#include <common>\n        #include <dithering_pars_fragment>      \n        uniform sampler2D inputBuffer;\n        uniform sampler2D depthBuffer;\n        uniform float cameraNear;\n        uniform float cameraFar;\n        uniform float minDepthThreshold;\n        uniform float maxDepthThreshold;\n        uniform float depthScale;\n        uniform float depthToBlurRatioBias;\n        varying vec2 vUv;\n        varying vec2 vUv0;\n        varying vec2 vUv1;\n        varying vec2 vUv2;\n        varying vec2 vUv3;\n\n        void main() {\n          float depthFactor = 0.0;\n          \n          #ifdef USE_DEPTH\n            vec4 depth = texture2D(depthBuffer, vUv);\n            depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));\n            depthFactor *= depthScale;\n            depthFactor = max(0.0, min(1.0, depthFactor + 0.25));\n          #endif\n          \n          vec4 sum = texture2D(inputBuffer, mix(vUv0, vUv, depthFactor));\n          sum += texture2D(inputBuffer, mix(vUv1, vUv, depthFactor));\n          sum += texture2D(inputBuffer, mix(vUv2, vUv, depthFactor));\n          sum += texture2D(inputBuffer, mix(vUv3, vUv, depthFactor));\n          gl_FragColor = sum * 0.25 ;\n\n          #include <dithering_fragment>\n          #include <tonemapping_fragment>\n          #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n        }`,vertexShader:"uniform vec2 texelSize;\n        uniform vec2 halfTexelSize;\n        uniform float kernel;\n        uniform float scale;\n        varying vec2 vUv;\n        varying vec2 vUv0;\n        varying vec2 vUv1;\n        varying vec2 vUv2;\n        varying vec2 vUv3;\n\n        void main() {\n          vec2 uv = position.xy * 0.5 + 0.5;\n          vUv = uv;\n\n          vec2 dUv = (texelSize * vec2(kernel) + halfTexelSize) * scale;\n          vUv0 = vec2(uv.x - dUv.x, uv.y + dUv.y);\n          vUv1 = vec2(uv.x + dUv.x, uv.y + dUv.y);\n          vUv2 = vec2(uv.x + dUv.x, uv.y - dUv.y);\n          vUv3 = vec2(uv.x - dUv.x, uv.y - dUv.y);\n\n          gl_Position = vec4(position.xy, 1.0, 1.0);\n        }",blending:a.XIg,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernel=new Float32Array([0,1,2,2,3])}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}setResolution(e){this.uniforms.resolution.value.copy(e)}}class bg{constructor({gl:e,resolution:t,width:n=500,height:r=500,minDepthThreshold:i=0,maxDepthThreshold:s=1,depthScale:o=0,depthToBlurRatioBias:l=.25}){this.renderToScreen=!1,this.renderTargetA=new a.nWS(t,t,{minFilter:a.k6q,magFilter:a.k6q,stencilBuffer:!1,depthBuffer:!1,type:a.ix0}),this.renderTargetB=this.renderTargetA.clone(),this.convolutionMaterial=new Ig,this.convolutionMaterial.setTexelSize(1/n,1/r),this.convolutionMaterial.setResolution(new a.I9Y(n,r)),this.scene=new a.Z58,this.camera=new a.i7d,this.convolutionMaterial.uniforms.minDepthThreshold.value=i,this.convolutionMaterial.uniforms.maxDepthThreshold.value=s,this.convolutionMaterial.uniforms.depthScale.value=o,this.convolutionMaterial.uniforms.depthToBlurRatioBias.value=l,this.convolutionMaterial.defines.USE_DEPTH=o>0;const c=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),h=new Float32Array([0,0,2,0,0,2]),u=new a.LoY;u.setAttribute("position",new a.THS(c,3)),u.setAttribute("uv",new a.THS(h,2)),this.screen=new a.eaF(u,this.convolutionMaterial),this.screen.frustumCulled=!1,this.scene.add(this.screen)}render(e,t,n){const r=this.scene,i=this.camera,s=this.renderTargetA,a=this.renderTargetB;let o=this.convolutionMaterial,l=o.uniforms;l.depthBuffer.value=t.depthTexture;const c=o.kernel;let h,u,d,f=t;for(u=0,d=c.length-1;u<d;++u)h=1&u?a:s,l.kernel.value=c[u],l.inputBuffer.value=f.texture,e.setRenderTarget(h),e.render(r,i),f=h;l.kernel.value=c[u],l.inputBuffer.value=f.texture,e.setRenderTarget(this.renderToScreen?null:n),e.render(r,i)}}class Sg extends a._4j{constructor(e={}){super(e),this._tDepth={value:null},this._distortionMap={value:null},this._tDiffuse={value:null},this._tDiffuseBlur={value:null},this._textureMatrix={value:null},this._hasBlur={value:!1},this._mirror={value:0},this._mixBlur={value:0},this._blurStrength={value:.5},this._minDepthThreshold={value:.9},this._maxDepthThreshold={value:1},this._depthScale={value:0},this._depthToBlurRatioBias={value:.25},this._distortion={value:1},this._mixContrast={value:1},this.setValues(e)}onBeforeCompile(e){var t;null!=(t=e.defines)&&t.USE_UV||(e.defines.USE_UV=""),e.uniforms.hasBlur=this._hasBlur,e.uniforms.tDiffuse=this._tDiffuse,e.uniforms.tDepth=this._tDepth,e.uniforms.distortionMap=this._distortionMap,e.uniforms.tDiffuseBlur=this._tDiffuseBlur,e.uniforms.textureMatrix=this._textureMatrix,e.uniforms.mirror=this._mirror,e.uniforms.mixBlur=this._mixBlur,e.uniforms.mixStrength=this._blurStrength,e.uniforms.minDepthThreshold=this._minDepthThreshold,e.uniforms.maxDepthThreshold=this._maxDepthThreshold,e.uniforms.depthScale=this._depthScale,e.uniforms.depthToBlurRatioBias=this._depthToBlurRatioBias,e.uniforms.distortion=this._distortion,e.uniforms.mixContrast=this._mixContrast,e.vertexShader=`\n        uniform mat4 textureMatrix;\n        varying vec4 my_vUv;\n      ${e.vertexShader}`,e.vertexShader=e.vertexShader.replace("#include <project_vertex>","#include <project_vertex>\n        my_vUv = textureMatrix * vec4( position, 1.0 );\n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );"),e.fragmentShader=`\n        uniform sampler2D tDiffuse;\n        uniform sampler2D tDiffuseBlur;\n        uniform sampler2D tDepth;\n        uniform sampler2D distortionMap;\n        uniform float distortion;\n        uniform float cameraNear;\n\t\t\t  uniform float cameraFar;\n        uniform bool hasBlur;\n        uniform float mixBlur;\n        uniform float mirror;\n        uniform float mixStrength;\n        uniform float minDepthThreshold;\n        uniform float maxDepthThreshold;\n        uniform float mixContrast;\n        uniform float depthScale;\n        uniform float depthToBlurRatioBias;\n        varying vec4 my_vUv;\n        ${e.fragmentShader}`,e.fragmentShader=e.fragmentShader.replace("#include <emissivemap_fragment>","#include <emissivemap_fragment>\n\n      float distortionFactor = 0.0;\n      #ifdef USE_DISTORTION\n        distortionFactor = texture2D(distortionMap, vUv).r * distortion;\n      #endif\n\n      vec4 new_vUv = my_vUv;\n      new_vUv.x += distortionFactor;\n      new_vUv.y += distortionFactor;\n\n      vec4 base = texture2DProj(tDiffuse, new_vUv);\n      vec4 blur = texture2DProj(tDiffuseBlur, new_vUv);\n\n      vec4 merge = base;\n\n      #ifdef USE_NORMALMAP\n        vec2 normal_uv = vec2(0.0);\n        vec4 normalColor = texture2D(normalMap, vUv * normalScale);\n        vec3 my_normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );\n        vec3 coord = new_vUv.xyz / new_vUv.w;\n        normal_uv = coord.xy + coord.z * my_normal.xz * 0.05;\n        vec4 base_normal = texture2D(tDiffuse, normal_uv);\n        vec4 blur_normal = texture2D(tDiffuseBlur, normal_uv);\n        merge = base_normal;\n        blur = blur_normal;\n      #endif\n\n      float depthFactor = 0.0001;\n      float blurFactor = 0.0;\n\n      #ifdef USE_DEPTH\n        vec4 depth = texture2DProj(tDepth, new_vUv);\n        depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));\n        depthFactor *= depthScale;\n        depthFactor = max(0.0001, min(1.0, depthFactor));\n\n        #ifdef USE_BLUR\n          blur = blur * min(1.0, depthFactor + depthToBlurRatioBias);\n          merge = merge * min(1.0, depthFactor + 0.5);\n        #else\n          merge = merge * depthFactor;\n        #endif\n\n      #endif\n\n      float reflectorRoughnessFactor = roughness;\n      #ifdef USE_ROUGHNESSMAP\n        vec4 reflectorTexelRoughness = texture2D( roughnessMap, vUv );\n        reflectorRoughnessFactor *= reflectorTexelRoughness.g;\n      #endif\n\n      #ifdef USE_BLUR\n        blurFactor = min(1.0, mixBlur * reflectorRoughnessFactor);\n        merge = mix(merge, blur, blurFactor);\n      #endif\n\n      vec4 newMerge = vec4(0.0, 0.0, 0.0, 1.0);\n      newMerge.r = (merge.r - 0.5) * mixContrast + 0.5;\n      newMerge.g = (merge.g - 0.5) * mixContrast + 0.5;\n      newMerge.b = (merge.b - 0.5) * mixContrast + 0.5;\n\n      diffuseColor.rgb = diffuseColor.rgb * ((1.0 - min(1.0, mirror)) + newMerge.rgb * mixStrength);\n      ")}get tDiffuse(){return this._tDiffuse.value}set tDiffuse(e){this._tDiffuse.value=e}get tDepth(){return this._tDepth.value}set tDepth(e){this._tDepth.value=e}get distortionMap(){return this._distortionMap.value}set distortionMap(e){this._distortionMap.value=e}get tDiffuseBlur(){return this._tDiffuseBlur.value}set tDiffuseBlur(e){this._tDiffuseBlur.value=e}get textureMatrix(){return this._textureMatrix.value}set textureMatrix(e){this._textureMatrix.value=e}get hasBlur(){return this._hasBlur.value}set hasBlur(e){this._hasBlur.value=e}get mirror(){return this._mirror.value}set mirror(e){this._mirror.value=e}get mixBlur(){return this._mixBlur.value}set mixBlur(e){this._mixBlur.value=e}get mixStrength(){return this._blurStrength.value}set mixStrength(e){this._blurStrength.value=e}get minDepthThreshold(){return this._minDepthThreshold.value}set minDepthThreshold(e){this._minDepthThreshold.value=e}get maxDepthThreshold(){return this._maxDepthThreshold.value}set maxDepthThreshold(e){this._maxDepthThreshold.value=e}get depthScale(){return this._depthScale.value}set depthScale(e){this._depthScale.value=e}get depthToBlurRatioBias(){return this._depthToBlurRatioBias.value}set depthToBlurRatioBias(e){this._depthToBlurRatioBias.value=e}get distortion(){return this._distortion.value}set distortion(e){this._distortion.value=e}get mixContrast(){return this._mixContrast.value}set mixContrast(e){this._mixContrast.value=e}}const Bg=i.forwardRef((({mixBlur:e=0,mixStrength:t=1,resolution:n=256,blur:s=[0,0],minDepthThreshold:l=.9,maxDepthThreshold:c=1,depthScale:h=0,depthToBlurRatioBias:u=.25,mirror:d=0,distortion:f=1,mixContrast:A=1,distortionMap:m,reflectorOffset:p=0,...g},v)=>{(0,o.e)({MeshReflectorMaterialImpl:Sg});const y=(0,o.A)((({gl:e})=>e)),E=(0,o.A)((({camera:e})=>e)),x=(0,o.A)((({scene:e})=>e)),C=(s=Array.isArray(s)?s:[s,s])[0]+s[1]>0,w=i.useRef(null);i.useImperativeHandle(v,(()=>w.current),[]);const[I]=i.useState((()=>new a.Zcv)),[b]=i.useState((()=>new a.Pq0)),[S]=i.useState((()=>new a.Pq0)),[B]=i.useState((()=>new a.Pq0)),[T]=i.useState((()=>new a.kn4)),[_]=i.useState((()=>new a.Pq0(0,0,-1))),[M]=i.useState((()=>new a.IUQ)),[R]=i.useState((()=>new a.Pq0)),[D]=i.useState((()=>new a.Pq0)),[P]=i.useState((()=>new a.IUQ)),[L]=i.useState((()=>new a.kn4)),[k]=i.useState((()=>new a.ubm)),F=i.useCallback((()=>{var e;const t=w.current.parent||(null==(e=w.current)||null==(e=e.__r3f.parent)?void 0:e.object);if(!t)return;if(S.setFromMatrixPosition(t.matrixWorld),B.setFromMatrixPosition(E.matrixWorld),T.extractRotation(t.matrixWorld),b.set(0,0,1),b.applyMatrix4(T),S.addScaledVector(b,p),R.subVectors(S,B),R.dot(b)>0)return;R.reflect(b).negate(),R.add(S),T.extractRotation(E.matrixWorld),_.set(0,0,-1),_.applyMatrix4(T),_.add(B),D.subVectors(S,_),D.reflect(b).negate(),D.add(S),k.position.copy(R),k.up.set(0,1,0),k.up.applyMatrix4(T),k.up.reflect(b),k.lookAt(D),k.far=E.far,k.updateMatrixWorld(),k.projectionMatrix.copy(E.projectionMatrix),L.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),L.multiply(k.projectionMatrix),L.multiply(k.matrixWorldInverse),L.multiply(t.matrixWorld),I.setFromNormalAndCoplanarPoint(b,S),I.applyMatrix4(k.matrixWorldInverse),M.set(I.normal.x,I.normal.y,I.normal.z,I.constant);const n=k.projectionMatrix;P.x=(Math.sign(M.x)+n.elements[8])/n.elements[0],P.y=(Math.sign(M.y)+n.elements[9])/n.elements[5],P.z=-1,P.w=(1+n.elements[10])/n.elements[14],M.multiplyScalar(2/M.dot(P)),n.elements[2]=M.x,n.elements[6]=M.y,n.elements[10]=M.z+1,n.elements[14]=M.w}),[E,p]),[O,U,Q,N]=i.useMemo((()=>{const r={minFilter:a.k6q,magFilter:a.k6q,type:a.ix0},i=new a.nWS(n,n,r);i.depthBuffer=!0,i.depthTexture=new a.VCu(n,n),i.depthTexture.format=a.zdS,i.depthTexture.type=a.cHt;const o=new a.nWS(n,n,r);return[i,o,new bg({gl:y,resolution:n,width:s[0],height:s[1],minDepthThreshold:l,maxDepthThreshold:c,depthScale:h,depthToBlurRatioBias:u}),{mirror:d,textureMatrix:L,mixBlur:e,tDiffuse:i.texture,tDepth:i.depthTexture,tDiffuseBlur:o.texture,hasBlur:C,mixStrength:t,minDepthThreshold:l,maxDepthThreshold:c,depthScale:h,depthToBlurRatioBias:u,distortion:f,distortionMap:m,mixContrast:A,"defines-USE_BLUR":C?"":void 0,"defines-USE_DEPTH":h>0?"":void 0,"defines-USE_DISTORTION":m?"":void 0}]}),[y,s,L,n,d,C,e,t,l,c,h,u,f,m,A]);return(0,o.C)((()=>{var e;const t=w.current.parent||(null==(e=w.current)||null==(e=e.__r3f.parent)?void 0:e.object);if(!t)return;t.visible=!1;const n=y.xr.enabled,r=y.shadowMap.autoUpdate;F(),y.xr.enabled=!1,y.shadowMap.autoUpdate=!1,y.setRenderTarget(O),y.state.buffers.depth.setMask(!0),y.autoClear||y.clear(),y.render(x,k),C&&Q.render(y,O,U),y.xr.enabled=n,y.shadowMap.autoUpdate=r,t.visible=!0,y.setRenderTarget(null)})),i.createElement("meshReflectorMaterialImpl",(0,r.A)({attach:"material",key:"key"+N["defines-USE_BLUR"]+N["defines-USE_DEPTH"]+N["defines-USE_DISTORTION"],ref:w},N,g))}));function Tg(e){switch(e){case 1:return a.ZQM;case 2:return a.TkQ;case 3:case 4:return a.c90}}class _g extends a.GYF{constructor(){super(),this.minFilter=a.hxR,this.magFilter=a.hxR,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(e){const t=this.overrideItemSize,n=e.itemSize,r=e.count;if(null!==t){if(n*r%t!=0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");e.itemSize=t,e.count=r*n/t}const i=e.itemSize,s=e.count,o=e.normalized,l=e.array.constructor,c=l.BYTES_PER_ELEMENT;let h,u,d,f,A=this._forcedType,m=i;if(null===A)switch(l){case Float32Array:A=a.RQf;break;case Uint8Array:case Uint16Array:case Uint32Array:A=a.bkx;break;case Int8Array:case Int16Array:case Int32Array:A=a.Yuy}let p=function(e){switch(e){case 1:return"R";case 2:return"RG";case 3:case 4:return"RGBA"}throw new Error}(i);switch(A){case a.RQf:d=1,u=function(e){switch(e){case 1:return a.VT0;case 2:return a.paN;case 3:case 4:return a.GWd}}(i),o&&1===c?(f=l,p+="8",l===Uint8Array?h=a.OUM:(h=a.tJf,p+="_SNORM")):(f=Float32Array,p+="32F",h=a.RQf);break;case a.Yuy:p+=8*c+"I",d=o?Math.pow(2,8*l.BYTES_PER_ELEMENT-1):1,u=Tg(i),1===c?(f=Int8Array,h=a.tJf):2===c?(f=Int16Array,h=a.fBL):(f=Int32Array,h=a.Yuy);break;case a.bkx:p+=8*c+"UI",d=o?Math.pow(2,8*l.BYTES_PER_ELEMENT-1):1,u=Tg(i),1===c?(f=Uint8Array,h=a.OUM):2===c?(f=Uint16Array,h=a.cHt):(f=Uint32Array,h=a.bkx)}3!==m||u!==a.GWd&&u!==a.c90||(m=4);const g=Math.ceil(Math.sqrt(s))||1,v=new f(m*g*g),y=e.normalized;e.normalized=!1;for(let a=0;a<s;a++){const t=m*a;v[t]=e.getX(a)/d,i>=2&&(v[t+1]=e.getY(a)/d),i>=3&&(v[t+2]=e.getZ(a)/d,4===m&&(v[t+3]=1)),i>=4&&(v[t+3]=e.getW(a)/d)}e.normalized=y,this.internalFormat=p,this.format=u,this.type=h,this.image.width=g,this.image.height=g,this.image.data=v,this.needsUpdate=!0,this.dispose(),e.itemSize=n,e.count=r}}class Mg extends _g{constructor(){super(),this._forcedType=a.bkx}}class Rg extends _g{constructor(){super(),this._forcedType=a.RQf}}class Dg{constructor(){this.index=new Mg,this.position=new Rg,this.bvhBounds=new a.GYF,this.bvhContents=new a.GYF,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(e){const{geometry:t}=e;if(function(e,t,n){const r=e._roots;if(1!==r.length)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const i=r[0],s=new Uint16Array(i),o=new Uint32Array(i),l=new Float32Array(i),c=i.byteLength/zf,h=2*Math.ceil(Math.sqrt(c/2)),u=new Float32Array(4*h*h),d=Math.ceil(Math.sqrt(c)),f=new Uint32Array(2*d*d);for(let a=0;a<c;a++){const e=a*zf/4,t=2*e,n=e;for(let r=0;r<3;r++)u[8*a+0+r]=l[n+0+r],u[8*a+4+r]=l[n+3+r];if(uA(t,s)){const n=fA(t,s),r=dA(e,o),i=4294901760|n;f[2*a+0]=i,f[2*a+1]=r}else{const t=4*mA(e,o)/zf,n=pA(e,o);f[2*a+0]=n,f[2*a+1]=t}}t.image.data=u,t.image.width=h,t.image.height=h,t.format=a.GWd,t.type=a.RQf,t.internalFormat="RGBA32F",t.minFilter=a.hxR,t.magFilter=a.hxR,t.generateMipmaps=!1,t.needsUpdate=!0,t.dispose(),n.image.data=f,n.image.width=d,n.image.height=d,n.format=a.TkQ,n.type=a.bkx,n.internalFormat="RG32UI",n.minFilter=a.hxR,n.magFilter=a.hxR,n.generateMipmaps=!1,n.needsUpdate=!0,n.dispose()}(e,this.bvhBounds,this.bvhContents),this.position.updateFrom(t.attributes.position),e.indirect){const n=e._indirectBuffer;if(null===this._cachedIndexAttr||this._cachedIndexAttr.count!==n.length)if(t.index)this._cachedIndexAttr=t.index.clone();else{const e=Kf(jf(t));this._cachedIndexAttr=new a.THS(e,1,!1)}!function(e,t,n){const r=n.array,i=e.index?e.index.array:null;for(let s=0,a=t.length;s<a;s++){const e=3*s,n=3*t[s];for(let t=0;t<3;t++)r[e+t]=i?i[n+t]:n+t}}(t,n,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(t.index)}dispose(){const{index:e,position:t,bvhBounds:n,bvhContents:r}=this;e&&e.dispose(),t&&t.dispose(),n&&n.dispose(),r&&r.dispose()}}const Pg=aa({envMap:null,bounces:3,ior:2.4,correctMips:!0,aberrationStrength:.01,fresnel:0,bvh:new Dg,color:new a.Q1f("white"),opacity:1,resolution:new a.I9Y,viewMatrixInverse:new a.kn4,projectionMatrixInverse:new a.kn4},"\n  uniform mat4 viewMatrixInverse;\n\n  varying vec3 vWorldPosition;\n  varying vec3 vNormal;\n  varying mat4 vModelMatrixInverse;\n\n  #include <color_pars_vertex>\n\n  void main() {\n    #include <color_vertex>\n\n    vec4 transformedNormal = vec4(normal, 0.0);\n    vec4 transformedPosition = vec4(position, 1.0);\n    #ifdef USE_INSTANCING\n      transformedNormal = instanceMatrix * transformedNormal;\n      transformedPosition = instanceMatrix * transformedPosition;\n    #endif\n\n    #ifdef USE_INSTANCING\n      vModelMatrixInverse = inverse(modelMatrix * instanceMatrix);\n    #else\n      vModelMatrixInverse = inverse(modelMatrix);\n    #endif\n\n    vWorldPosition = (modelMatrix * transformedPosition).xyz;\n    vNormal = normalize((viewMatrixInverse * vec4(normalMatrix * transformedNormal.xyz, 0.0)).xyz);\n    gl_Position = projectionMatrix * viewMatrix * modelMatrix * transformedPosition;\n  }",`\n  #define ENVMAP_TYPE_CUBE_UV\n  precision highp isampler2D;\n  precision highp usampler2D;\n  varying vec3 vWorldPosition;\n  varying vec3 vNormal;\n  varying mat4 vModelMatrixInverse;\n\n  #include <color_pars_fragment>\n\n  #ifdef ENVMAP_TYPE_CUBEM\n    uniform samplerCube envMap;\n  #else\n    uniform sampler2D envMap;\n  #endif\n\n  uniform float bounces;\n  \nstruct BVH {\n\n\tusampler2D index;\n\tsampler2D position;\n\n\tsampler2D bvhBounds;\n\tusampler2D bvhContents;\n\n};\n\n  \n\t\n\n// A stack of uint32 indices can can store the indices for\n// a perfectly balanced tree with a depth up to 31. Lower stack\n// depth gets higher performance.\n//\n// However not all trees are balanced. Best value to set this to\n// is the trees max depth.\n#ifndef BVH_STACK_DEPTH\n#define BVH_STACK_DEPTH 60\n#endif\n\n#ifndef INFINITY\n#define INFINITY 1e20\n#endif\n\n// Utilities\nuvec4 uTexelFetch1D( usampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nivec4 iTexelFetch1D( isampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 texelFetch1D( sampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {\n\n\treturn\n\t\tbarycoord.x * texelFetch1D( tex, faceIndices.x ) +\n\t\tbarycoord.y * texelFetch1D( tex, faceIndices.y ) +\n\t\tbarycoord.z * texelFetch1D( tex, faceIndices.z );\n\n}\n\nvoid ndcToCameraRay(\n\tvec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,\n\tout vec3 rayOrigin, out vec3 rayDirection\n) {\n\n\t// get camera look direction and near plane for camera clipping\n\tvec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );\n\tvec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );\n\tfloat near = abs( nearVector.z / nearVector.w );\n\n\t// get the camera direction and position from camera matrices\n\tvec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );\n\tdirection /= direction.w;\n\tdirection = cameraWorld * direction - origin;\n\n\t// slide the origin along the ray until it sits at the near clip plane position\n\torigin.xyz += direction.xyz * near / dot( direction, lookDirection );\n\n\trayOrigin = origin.xyz;\n\trayDirection = direction.xyz;\n\n}\n\n\t\n\n#ifndef TRI_INTERSECT_EPSILON\n#define TRI_INTERSECT_EPSILON 1e-5\n#endif\n\n// Raycasting\nbool intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax, out float dist ) {\n\n\t// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/\n\t// https://tavianator.com/2011/ray_box.html\n\tvec3 invDir = 1.0 / rayDirection;\n\n\t// find intersection distances for each plane\n\tvec3 tMinPlane = invDir * ( boundsMin - rayOrigin );\n\tvec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );\n\n\t// get the min and max distances from each intersection\n\tvec3 tMinHit = min( tMaxPlane, tMinPlane );\n\tvec3 tMaxHit = max( tMaxPlane, tMinPlane );\n\n\t// get the furthest hit distance\n\tvec2 t = max( tMinHit.xx, tMinHit.yz );\n\tfloat t0 = max( t.x, t.y );\n\n\t// get the minimum hit distance\n\tt = min( tMaxHit.xx, tMaxHit.yz );\n\tfloat t1 = min( t.x, t.y );\n\n\t// set distance to 0.0 if the ray starts inside the box\n\tdist = max( t0, 0.0 );\n\n\treturn t1 >= dist;\n\n}\n\nbool intersectsTriangle(\n\tvec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,\n\tout vec3 barycoord, out vec3 norm, out float dist, out float side\n) {\n\n\t// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d\n\tvec3 edge1 = b - a;\n\tvec3 edge2 = c - a;\n\tnorm = cross( edge1, edge2 );\n\n\tfloat det = - dot( rayDirection, norm );\n\tfloat invdet = 1.0 / det;\n\n\tvec3 AO = rayOrigin - a;\n\tvec3 DAO = cross( AO, rayDirection );\n\n\tvec4 uvt;\n\tuvt.x = dot( edge2, DAO ) * invdet;\n\tuvt.y = - dot( edge1, DAO ) * invdet;\n\tuvt.z = dot( AO, norm ) * invdet;\n\tuvt.w = 1.0 - uvt.x - uvt.y;\n\n\t// set the hit information\n\tbarycoord = uvt.wxy; // arranged in A, B, C order\n\tdist = uvt.z;\n\tside = sign( det );\n\tnorm = side * normalize( norm );\n\n\t// add an epsilon to avoid misses between triangles\n\tuvt += vec4( TRI_INTERSECT_EPSILON );\n\n\treturn all( greaterThanEqual( uvt, vec4( 0.0 ) ) );\n\n}\n\nbool intersectTriangles(\n\t// geometry info and triangle range\n\tsampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// outputs\n\tinout float minDistance, inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\tbool found = false;\n\tvec3 localBarycoord, localNormal;\n\tfloat localDist, localSide;\n\tfor ( uint i = offset, l = offset + count; i < l; i ++ ) {\n\n\t\tuvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;\n\t\tvec3 a = texelFetch1D( positionAttr, indices.x ).rgb;\n\t\tvec3 b = texelFetch1D( positionAttr, indices.y ).rgb;\n\t\tvec3 c = texelFetch1D( positionAttr, indices.z ).rgb;\n\n\t\tif (\n\t\t\tintersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )\n\t\t\t&& localDist < minDistance\n\t\t) {\n\n\t\t\tfound = true;\n\t\t\tminDistance = localDist;\n\n\t\t\tfaceIndices = uvec4( indices.xyz, i );\n\t\t\tfaceNormal = localNormal;\n\n\t\t\tside = localSide;\n\t\t\tbarycoord = localBarycoord;\n\t\t\tdist = localDist;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n\nbool intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, sampler2D bvhBounds, uint currNodeIndex, out float dist ) {\n\n\tuint cni2 = currNodeIndex * 2u;\n\tvec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;\n\tvec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;\n\treturn intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax, dist );\n\n}\n\n// use a macro to hide the fact that we need to expand the struct into separate fields\n#define\tbvhIntersectFirstHit(\t\tbvh,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\t_bvhIntersectFirstHit(\t\tbvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\n\nbool _bvhIntersectFirstHit(\n\t// bvh info\n\tsampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// output variables split into separate variables due to output precision\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\t// stack needs to be twice as long as the deepest tree we expect because\n\t// we push both the left and right child onto the stack every traversal\n\tint ptr = 0;\n\tuint stack[ BVH_STACK_DEPTH ];\n\tstack[ 0 ] = 0u;\n\n\tfloat triangleDistance = INFINITY;\n\tbool found = false;\n\twhile ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {\n\n\t\tuint currNodeIndex = stack[ ptr ];\n\t\tptr --;\n\n\t\t// check if we intersect the current bounds\n\t\tfloat boundsHitDistance;\n\t\tif (\n\t\t\t! intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh_bvhBounds, currNodeIndex, boundsHitDistance )\n\t\t\t|| boundsHitDistance > triangleDistance\n\t\t) {\n\n\t\t\tcontinue;\n\n\t\t}\n\n\t\tuvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;\n\t\tbool isLeaf = bool( boundsInfo.x & 0xffff0000u );\n\n\t\tif ( isLeaf ) {\n\n\t\t\tuint count = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint offset = boundsInfo.y;\n\n\t\t\tfound = intersectTriangles(\n\t\t\t\tbvh_position, bvh_index, offset, count,\n\t\t\t\trayOrigin, rayDirection, triangleDistance,\n\t\t\t\tfaceIndices, faceNormal, barycoord, side, dist\n\t\t\t) || found;\n\n\t\t} else {\n\n\t\t\tuint leftIndex = currNodeIndex + 1u;\n\t\t\tuint splitAxis = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint rightIndex = boundsInfo.y;\n\n\t\t\tbool leftToRight = rayDirection[ splitAxis ] >= 0.0;\n\t\t\tuint c1 = leftToRight ? leftIndex : rightIndex;\n\t\t\tuint c2 = leftToRight ? rightIndex : leftIndex;\n\n\t\t\t// set c2 in the stack so we traverse it later. We need to keep track of a pointer in\n\t\t\t// the stack while we traverse. The second pointer added is the one that will be\n\t\t\t// traversed first\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c2;\n\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c1;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n\n\n  uniform BVH bvh;\n  uniform float ior;\n  uniform bool correctMips;\n  uniform vec2 resolution;\n  uniform float fresnel;\n  uniform mat4 modelMatrix;\n  uniform mat4 projectionMatrixInverse;\n  uniform mat4 viewMatrixInverse;\n  uniform float aberrationStrength;\n  uniform vec3 color;\n  uniform float opacity;\n\n  float fresnelFunc(vec3 viewDirection, vec3 worldNormal) {\n    return pow( 1.0 + dot( viewDirection, worldNormal), 10.0 );\n  }\n\n  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 normal, float ior, mat4 modelMatrixInverse) {\n    vec3 rayOrigin = ro;\n    vec3 rayDirection = rd;\n    rayDirection = refract(rayDirection, normal, 1.0 / ior);\n    rayOrigin = vWorldPosition + rayDirection * 0.001;\n    rayOrigin = (modelMatrixInverse * vec4(rayOrigin, 1.0)).xyz;\n    rayDirection = normalize((modelMatrixInverse * vec4(rayDirection, 0.0)).xyz);\n    for(float i = 0.0; i < bounces; i++) {\n      uvec4 faceIndices = uvec4( 0u );\n      vec3 faceNormal = vec3( 0.0, 0.0, 1.0 );\n      vec3 barycoord = vec3( 0.0 );\n      float side = 1.0;\n      float dist = 0.0;\n      bvhIntersectFirstHit( bvh, rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist );\n      vec3 hitPos = rayOrigin + rayDirection * max(dist - 0.001, 0.0);\n      vec3 tempDir = refract(rayDirection, faceNormal, ior);\n      if (length(tempDir) != 0.0) {\n        rayDirection = tempDir;\n        break;\n      }\n      rayDirection = reflect(rayDirection, faceNormal);\n      rayOrigin = hitPos + rayDirection * 0.01;\n    }\n    rayDirection = normalize((modelMatrix * vec4(rayDirection, 0.0)).xyz);\n    return rayDirection;\n  }\n\n  #include <common>\n  #include <cube_uv_reflection_fragment>\n\n  #ifdef ENVMAP_TYPE_CUBEM\n    vec4 textureGradient(samplerCube envMap, vec3 rayDirection, vec3 directionCamPerfect) {\n      return textureGrad(envMap, rayDirection, dFdx(correctMips ? directionCamPerfect: rayDirection), dFdy(correctMips ? directionCamPerfect: rayDirection));\n    }\n  #else\n    vec4 textureGradient(sampler2D envMap, vec3 rayDirection, vec3 directionCamPerfect) {\n      vec2 uvv = equirectUv( rayDirection );\n      vec2 smoothUv = equirectUv( directionCamPerfect );\n      return textureGrad(envMap, uvv, dFdx(correctMips ? smoothUv : uvv), dFdy(correctMips ? smoothUv : uvv));\n    }\n  #endif\n\n  void main() {\n    vec2 uv = gl_FragCoord.xy / resolution;\n    vec3 directionCamPerfect = (projectionMatrixInverse * vec4(uv * 2.0 - 1.0, 0.0, 1.0)).xyz;\n    directionCamPerfect = (viewMatrixInverse * vec4(directionCamPerfect, 0.0)).xyz;\n    directionCamPerfect = normalize(directionCamPerfect);\n    vec3 normal = vNormal;\n    vec3 rayOrigin = cameraPosition;\n    vec3 rayDirection = normalize(vWorldPosition - cameraPosition);\n\n    vec4 diffuseColor = vec4(color, opacity);\n    #include <color_fragment>\n\n    #ifdef CHROMATIC_ABERRATIONS\n      vec3 rayDirectionG = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);\n      #ifdef FAST_CHROMA\n        vec3 rayDirectionR = normalize(rayDirectionG + 1.0 * vec3(aberrationStrength / 2.0));\n        vec3 rayDirectionB = normalize(rayDirectionG - 1.0 * vec3(aberrationStrength / 2.0));\n      #else\n        vec3 rayDirectionR = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 - aberrationStrength), 1.0), vModelMatrixInverse);\n        vec3 rayDirectionB = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 + aberrationStrength), 1.0), vModelMatrixInverse);\n      #endif\n      float finalColorR = textureGradient(envMap, rayDirectionR, directionCamPerfect).r;\n      float finalColorG = textureGradient(envMap, rayDirectionG, directionCamPerfect).g;\n      float finalColorB = textureGradient(envMap, rayDirectionB, directionCamPerfect).b;\n      diffuseColor.rgb *= vec3(finalColorR, finalColorG, finalColorB);\n    #else\n      rayDirection = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);\n      diffuseColor.rgb *= textureGradient(envMap, rayDirection, directionCamPerfect).rgb;\n    #endif\n\n    vec3 viewDirection = normalize(vWorldPosition - cameraPosition);\n    float nFresnel = fresnelFunc(viewDirection, normal) * fresnel;\n    gl_FragColor = vec4(mix(diffuseColor.rgb, vec3(1.0), nFresnel), diffuseColor.a);\n\n    #include <tonemapping_fragment>\n    #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n  }`),Lg=e=>e&&e.isCubeTexture;function kg({aberrationStrength:e=0,fastChroma:t=!0,envMap:n,...s}){(0,o.e)({MeshRefractionMaterial:Pg});const a=(0,i.useRef)(null),{size:l}=(0,o.A)(),c=(0,i.useMemo)((()=>{var r,i;const s={},a=Lg(n),o=(null!==(r=a?null==(i=n.image[0])?void 0:i.width:n.image.width)&&void 0!==r?r:1024)/4,l=Math.floor(Math.log2(o)),c=Math.pow(2,l),h=3*Math.max(c,112),u=4*c;return a&&(s.ENVMAP_TYPE_CUBEM=""),s.CUBEUV_TEXEL_WIDTH=""+1/h,s.CUBEUV_TEXEL_HEIGHT=""+1/u,s.CUBEUV_MAX_MIP=`${l}.0`,e>0&&(s.CHROMATIC_ABERRATIONS=""),t&&(s.FAST_CHROMA=""),s}),[e,t]);return(0,i.useLayoutEffect)((()=>{var e;const t=null==(e=a.current)||null==(e=e.__r3f)||null==(e=e.parent)||null==(e=e.object)?void 0:e.geometry;t&&(a.current.bvh=new Dg,a.current.bvh.updateFrom(new up(t.clone().toNonIndexed(),{strategy:Qf})))}),[]),(0,o.C)((({camera:e})=>{a.current.viewMatrixInverse=e.matrixWorld,a.current.projectionMatrixInverse=e.projectionMatrixInverse})),i.createElement("meshRefractionMaterial",(0,r.A)({key:JSON.stringify(c),defines:c,ref:a,resolution:[l.width,l.height],aberrationStrength:e,envMap:n},s))}const Fg=aa({},"void main() { }","void main() { gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); discard;  }");class Og extends a.uSd{constructor(e=6,t=!1){super(),this.uniforms={chromaticAberration:{value:.05},transmission:{value:0},_transmission:{value:1},transmissionMap:{value:null},roughness:{value:0},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:1/0},attenuationColor:{value:new a.Q1f("white")},anisotropicBlur:{value:.1},time:{value:0},distortion:{value:0},distortionScale:{value:.5},temporalDistortion:{value:0},buffer:{value:null}},this.onBeforeCompile=n=>{n.uniforms={...n.uniforms,...this.uniforms},this.anisotropy>0&&(n.defines.USE_ANISOTROPY=""),t?n.defines.USE_SAMPLER="":n.defines.USE_TRANSMISSION="",n.fragmentShader="\n      uniform float chromaticAberration;         \n      uniform float anisotropicBlur;      \n      uniform float time;\n      uniform float distortion;\n      uniform float distortionScale;\n      uniform float temporalDistortion;\n      uniform sampler2D buffer;\n\n      vec3 random3(vec3 c) {\n        float j = 4096.0*sin(dot(c,vec3(17.0, 59.4, 15.0)));\n        vec3 r;\n        r.z = fract(512.0*j);\n        j *= .125;\n        r.x = fract(512.0*j);\n        j *= .125;\n        r.y = fract(512.0*j);\n        return r-0.5;\n      }\n\n      uint hash( uint x ) {\n        x += ( x << 10u );\n        x ^= ( x >>  6u );\n        x += ( x <<  3u );\n        x ^= ( x >> 11u );\n        x += ( x << 15u );\n        return x;\n      }\n\n      // Compound versions of the hashing algorithm I whipped together.\n      uint hash( uvec2 v ) { return hash( v.x ^ hash(v.y)                         ); }\n      uint hash( uvec3 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z)             ); }\n      uint hash( uvec4 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z) ^ hash(v.w) ); }\n\n      // Construct a float with half-open range [0:1] using low 23 bits.\n      // All zeroes yields 0.0, all ones yields the next smallest representable value below 1.0.\n      float floatConstruct( uint m ) {\n        const uint ieeeMantissa = 0x007FFFFFu; // binary32 mantissa bitmask\n        const uint ieeeOne      = 0x3F800000u; // 1.0 in IEEE binary32\n        m &= ieeeMantissa;                     // Keep only mantissa bits (fractional part)\n        m |= ieeeOne;                          // Add fractional part to 1.0\n        float  f = uintBitsToFloat( m );       // Range [1:2]\n        return f - 1.0;                        // Range [0:1]\n      }\n\n      // Pseudo-random value in half-open range [0:1].\n      float randomBase( float x ) { return floatConstruct(hash(floatBitsToUint(x))); }\n      float randomBase( vec2  v ) { return floatConstruct(hash(floatBitsToUint(v))); }\n      float randomBase( vec3  v ) { return floatConstruct(hash(floatBitsToUint(v))); }\n      float randomBase( vec4  v ) { return floatConstruct(hash(floatBitsToUint(v))); }\n      float rand(float seed) {\n        float result = randomBase(vec3(gl_FragCoord.xy, seed));\n        return result;\n      }\n\n      const float F3 =  0.3333333;\n      const float G3 =  0.1666667;\n\n      float snoise(vec3 p) {\n        vec3 s = floor(p + dot(p, vec3(F3)));\n        vec3 x = p - s + dot(s, vec3(G3));\n        vec3 e = step(vec3(0.0), x - x.yzx);\n        vec3 i1 = e*(1.0 - e.zxy);\n        vec3 i2 = 1.0 - e.zxy*(1.0 - e);\n        vec3 x1 = x - i1 + G3;\n        vec3 x2 = x - i2 + 2.0*G3;\n        vec3 x3 = x - 1.0 + 3.0*G3;\n        vec4 w, d;\n        w.x = dot(x, x);\n        w.y = dot(x1, x1);\n        w.z = dot(x2, x2);\n        w.w = dot(x3, x3);\n        w = max(0.6 - w, 0.0);\n        d.x = dot(random3(s), x);\n        d.y = dot(random3(s + i1), x1);\n        d.z = dot(random3(s + i2), x2);\n        d.w = dot(random3(s + 1.0), x3);\n        w *= w;\n        w *= w;\n        d *= w;\n        return dot(d, vec4(52.0));\n      }\n\n      float snoiseFractal(vec3 m) {\n        return 0.5333333* snoise(m)\n              +0.2666667* snoise(2.0*m)\n              +0.1333333* snoise(4.0*m)\n              +0.0666667* snoise(8.0*m);\n      }\n"+n.fragmentShader,n.fragmentShader=n.fragmentShader.replace("#include <transmission_pars_fragment>","\n        #ifdef USE_TRANSMISSION\n          // Transmission code is based on glTF-Sampler-Viewer\n          // https://github.com/KhronosGroup/glTF-Sample-Viewer\n          uniform float _transmission;\n          uniform float thickness;\n          uniform float attenuationDistance;\n          uniform vec3 attenuationColor;\n          #ifdef USE_TRANSMISSIONMAP\n            uniform sampler2D transmissionMap;\n          #endif\n          #ifdef USE_THICKNESSMAP\n            uniform sampler2D thicknessMap;\n          #endif\n          uniform vec2 transmissionSamplerSize;\n          uniform sampler2D transmissionSamplerMap;\n          uniform mat4 modelMatrix;\n          uniform mat4 projectionMatrix;\n          varying vec3 vWorldPosition;\n          vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n            // Direction of refracted light.\n            vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n            // Compute rotation-independant scaling of the model matrix.\n            vec3 modelScale;\n            modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n            modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n            modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n            // The thickness is specified in local space.\n            return normalize( refractionVector ) * thickness * modelScale;\n          }\n          float applyIorToRoughness( const in float roughness, const in float ior ) {\n            // Scale roughness with IOR so that an IOR of 1.0 results in no microfacet refraction and\n            // an IOR of 1.5 results in the default amount of microfacet refraction.\n            return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n          }\n          vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n            float framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );            \n            #ifdef USE_SAMPLER\n              #ifdef texture2DLodEXT\n                return texture2DLodEXT(transmissionSamplerMap, fragCoord.xy, framebufferLod);\n              #else\n                return texture2D(transmissionSamplerMap, fragCoord.xy, framebufferLod);\n              #endif\n            #else\n              return texture2D(buffer, fragCoord.xy);\n            #endif\n          }\n          vec3 applyVolumeAttenuation( const in vec3 radiance, const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n            if ( isinf( attenuationDistance ) ) {\n              // Attenuation distance is +\u221e, i.e. the transmitted color is not attenuated at all.\n              return radiance;\n            } else {\n              // Compute light attenuation using Beer's law.\n              vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n              vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance ); // Beer's law\n              return transmittance * radiance;\n            }\n          }\n          vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n            const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n            const in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,\n            const in vec3 attenuationColor, const in float attenuationDistance ) {\n            vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n            vec3 refractedRayExit = position + transmissionRay;\n            // Project refracted vector on the framebuffer, while mapping to normalized device coordinates.\n            vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n            vec2 refractionCoords = ndcPos.xy / ndcPos.w;\n            refractionCoords += 1.0;\n            refractionCoords /= 2.0;\n            // Sample framebuffer to get pixel the refracted ray hits.\n            vec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n            vec3 attenuatedColor = applyVolumeAttenuation( transmittedLight.rgb, length( transmissionRay ), attenuationColor, attenuationDistance );\n            // Get the specular component.\n            vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n            return vec4( ( 1.0 - F ) * attenuatedColor * diffuseColor, transmittedLight.a );\n          }\n        #endif\n"),n.fragmentShader=n.fragmentShader.replace("#include <transmission_fragment>",`  \n        // Improve the refraction to use the world pos\n        material.transmission = _transmission;\n        material.transmissionAlpha = 1.0;\n        material.thickness = thickness;\n        material.attenuationDistance = attenuationDistance;\n        material.attenuationColor = attenuationColor;\n        #ifdef USE_TRANSMISSIONMAP\n          material.transmission *= texture2D( transmissionMap, vUv ).r;\n        #endif\n        #ifdef USE_THICKNESSMAP\n          material.thickness *= texture2D( thicknessMap, vUv ).g;\n        #endif\n        \n        vec3 pos = vWorldPosition;\n        float runningSeed = 0.0;\n        vec3 v = normalize( cameraPosition - pos );\n        vec3 n = inverseTransformDirection( normal, viewMatrix );\n        vec3 transmission = vec3(0.0);\n        float transmissionR, transmissionB, transmissionG;\n        float randomCoords = rand(runningSeed++);\n        float thickness_smear = thickness * max(pow(roughnessFactor, 0.33), anisotropicBlur);\n        vec3 distortionNormal = vec3(0.0);\n        vec3 temporalOffset = vec3(time, -time, -time) * temporalDistortion;\n        if (distortion > 0.0) {\n          distortionNormal = distortion * vec3(snoiseFractal(vec3((pos * distortionScale + temporalOffset))), snoiseFractal(vec3(pos.zxy * distortionScale - temporalOffset)), snoiseFractal(vec3(pos.yxz * distortionScale + temporalOffset)));\n        }\n        for (float i = 0.0; i < ${e}.0; i ++) {\n          vec3 sampleNorm = normalize(n + roughnessFactor * roughnessFactor * 2.0 * normalize(vec3(rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5)) * pow(rand(runningSeed++), 0.33) + distortionNormal);\n          transmissionR = getIBLVolumeRefraction(\n            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness  + thickness_smear * (i + randomCoords) / float(${e}),\n            material.attenuationColor, material.attenuationDistance\n          ).r;\n          transmissionG = getIBLVolumeRefraction(\n            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior  * (1.0 + chromaticAberration * (i + randomCoords) / float(${e})) , material.thickness + thickness_smear * (i + randomCoords) / float(${e}),\n            material.attenuationColor, material.attenuationDistance\n          ).g;\n          transmissionB = getIBLVolumeRefraction(\n            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior * (1.0 + 2.0 * chromaticAberration * (i + randomCoords) / float(${e})), material.thickness + thickness_smear * (i + randomCoords) / float(${e}),\n            material.attenuationColor, material.attenuationDistance\n          ).b;\n          transmission.r += transmissionR;\n          transmission.g += transmissionG;\n          transmission.b += transmissionB;\n        }\n        transmission /= ${e}.0;\n        totalDiffuse = mix( totalDiffuse, transmission.rgb, material.transmission );\n`)},Object.keys(this.uniforms).forEach((e=>Object.defineProperty(this,e,{get:()=>this.uniforms[e].value,set:t=>this.uniforms[e].value=t})))}}const Ug=i.forwardRef((({buffer:e,transmissionSampler:t=!1,backside:n=!1,side:s=a.hB5,transmission:l=1,thickness:c=0,backsideThickness:h=0,backsideEnvMapIntensity:u=1,samples:d=10,resolution:f,backsideResolution:A,background:m,anisotropy:p,anisotropicBlur:g,...v},y)=>{(0,o.e)({MeshTransmissionMaterial:Og});const E=i.useRef(null),[x]=i.useState((()=>new Fg)),C=vl(A||f),w=vl(f);let I,b,S,B;return(0,o.C)((e=>{var r;(E.current.time=e.clock.elapsedTime,E.current.buffer!==w.texture||t)||(B=null==(r=E.current.__r3f.parent)?void 0:r.object,B&&(S=e.gl.toneMapping,I=e.scene.background,b=E.current.envMapIntensity,e.gl.toneMapping=a.y_p,m&&(e.scene.background=m),B.material=x,n&&(e.gl.setRenderTarget(C),e.gl.render(e.scene,e.camera),B.material=E.current,B.material.buffer=C.texture,B.material.thickness=h,B.material.side=a.hsX,B.material.envMapIntensity=u),e.gl.setRenderTarget(w),e.gl.render(e.scene,e.camera),B.material=E.current,B.material.thickness=c,B.material.side=s,B.material.buffer=w.texture,B.material.envMapIntensity=b,e.scene.background=I,e.gl.setRenderTarget(null),e.gl.toneMapping=S))})),i.useImperativeHandle(y,(()=>E.current),[]),i.createElement("meshTransmissionMaterial",(0,r.A)({args:[d,t],ref:E},v,{buffer:e||w.texture,_transmission:l,anisotropicBlur:null!=g?g:p,transmission:t?l:0,thickness:c,side:s}))})),Qg=i.forwardRef(((e,t)=>((0,o.e)({DiscardMaterialImpl:Fg}),i.createElement("discardMaterialImpl",(0,r.A)({ref:t},e)))));function Ng(e){const t=i.useRef(null);return i.useLayoutEffect((()=>{const e=t.current.parent,n=null==e?void 0:e.geometry;if(n){const r=e.material;e.material=t.current.__r3f.children.map((e=>e.object));const i=[...n.groups];return n.clearGroups(),e.material.forEach(((t,r)=>{r<e.material.length-1&&(t.depthWrite=!1),n.addGroup(0,1/0,r)})),()=>{e.material=r,n.groups=i}}})),i.createElement("group",(0,r.A)({ref:t},e))}const zg=ha>=154?"opaque_fragment":"output_fragment";class Gg extends a.BH${constructor(e){super(e),this.onBeforeCompile=(e,t)=>{const{isWebGL2:n}=t.capabilities;e.fragmentShader=e.fragmentShader.replace(`#include <${zg}>`,`\n        ${n?`#include <${zg}>`:`#extension GL_OES_standard_derivatives : enable\n#include <${zg}>`}\n      vec2 cxy = 2.0 * gl_PointCoord - 1.0;\n      float r = dot(cxy, cxy);\n      float delta = fwidth(r);     \n      float mask = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\n      gl_FragColor = vec4(gl_FragColor.rgb, mask * gl_FragColor.a );\n      #include <tonemapping_fragment>\n      #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n      `)}}}const Hg=i.forwardRef(((e,t)=>{const[n]=i.useState((()=>new Gg(null)));return i.createElement("primitive",(0,r.A)({},e,{object:n,ref:t,attach:"material"}))})),qg=({focus:e=0,size:t=25,samples:n=10}={})=>`\n#define PENUMBRA_FILTER_SIZE float(${t})\n#define RGB_NOISE_FUNCTION(uv) (randRGB(uv))\nvec3 randRGB(vec2 uv) {\n  return vec3(\n    fract(sin(dot(uv, vec2(12.75613, 38.12123))) * 13234.76575),\n    fract(sin(dot(uv, vec2(19.45531, 58.46547))) * 43678.23431),\n    fract(sin(dot(uv, vec2(23.67817, 78.23121))) * 93567.23423)\n  );\n}\n\nvec3 lowPassRandRGB(vec2 uv) {\n  // 3x3 convolution (average)\n  // can be implemented as separable with an extra buffer for a total of 6 samples instead of 9\n  vec3 result = vec3(0);\n  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, -1.0));\n  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0,  0.0));\n  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, +1.0));\n  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, -1.0));\n  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0,  0.0));\n  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, +1.0));\n  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, -1.0));\n  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0,  0.0));\n  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, +1.0));\n  result *= 0.111111111; // 1.0 / 9.0\n  return result;\n}\nvec3 highPassRandRGB(vec2 uv) {\n  // by subtracting the low-pass signal from the original signal, we're being left with the high-pass signal\n  // hp(x) = x - lp(x)\n  return RGB_NOISE_FUNCTION(uv) - lowPassRandRGB(uv) + 0.5;\n}\n\n\nvec2 vogelDiskSample(int sampleIndex, int sampleCount, float angle) {\n  const float goldenAngle = 2.399963f; // radians\n  float r = sqrt(float(sampleIndex) + 0.5f) / sqrt(float(sampleCount));\n  float theta = float(sampleIndex) * goldenAngle + angle;\n  float sine = sin(theta);\n  float cosine = cos(theta);\n  return vec2(cosine, sine) * r;\n}\nfloat penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation\n  return (zReceiver - zBlocker) / zBlocker;\n}\nfloat findBlocker(sampler2D shadowMap, vec2 uv, float compare, float angle) {\n  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);\n  float blockerDepthSum = float(${e});\n  float blockers = 0.0;\n\n  int j = 0;\n  vec2 offset = vec2(0.);\n  float depth = 0.;\n\n  #pragma unroll_loop_start\n  for(int i = 0; i < ${n}; i ++) {\n    offset = (vogelDiskSample(j, ${n}, angle) * texelSize) * 2.0 * PENUMBRA_FILTER_SIZE;\n    depth = unpackRGBAToDepth( texture2D( shadowMap, uv + offset));\n    if (depth < compare) {\n      blockerDepthSum += depth;\n      blockers++;\n    }\n    j++;\n  }\n  #pragma unroll_loop_end\n\n  if (blockers > 0.0) {\n    return blockerDepthSum / blockers;\n  }\n  return -1.0;\n}\n\n        \nfloat vogelFilter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius, float angle) {\n  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);\n  float shadow = 0.0f;\n  int j = 0;\n  vec2 vogelSample = vec2(0.0);\n  vec2 offset = vec2(0.0);\n  #pragma unroll_loop_start\n  for (int i = 0; i < ${n}; i++) {\n    vogelSample = vogelDiskSample(j, ${n}, angle) * texelSize;\n    offset = vogelSample * (1.0 + filterRadius * float(${t}));\n    shadow += step( zReceiver, unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) ) );\n    j++;\n  }\n  #pragma unroll_loop_end\n  return shadow * 1.0 / ${n}.0;\n}\n\nfloat PCSS (sampler2D shadowMap, vec4 coords) {\n  vec2 uv = coords.xy;\n  float zReceiver = coords.z; // Assumed to be eye-space z in this code\n  float angle = highPassRandRGB(gl_FragCoord.xy).r * PI2;\n  float avgBlockerDepth = findBlocker(shadowMap, uv, zReceiver, angle);\n  if (avgBlockerDepth == -1.0) {\n    return 1.0;\n  }\n  float penumbraRatio = penumbraSize(zReceiver, avgBlockerDepth);\n  return vogelFilter(shadowMap, uv, zReceiver, 1.25 * penumbraRatio, angle);\n}`;function Yg(e,t,n){t.traverse((t=>{t.material&&(e.properties.remove(t.material),null==t.material.dispose||t.material.dispose())})),e.info.programs.length=0,e.compile(t,n)}function jg({focus:e=0,samples:t=10,size:n=25}){const r=(0,o.A)((e=>e.gl)),s=(0,o.A)((e=>e.scene)),a=(0,o.A)((e=>e.camera));return i.useEffect((()=>{const i=br.ShaderChunk.shadowmap_pars_fragment;return br.ShaderChunk.shadowmap_pars_fragment=br.ShaderChunk.shadowmap_pars_fragment.replace("#ifdef USE_SHADOWMAP","#ifdef USE_SHADOWMAP\n"+qg({size:n,samples:t,focus:e})).replace("#if defined( SHADOWMAP_TYPE_PCF )","\nreturn PCSS(shadowMap, shadowCoord);\n#if defined( SHADOWMAP_TYPE_PCF )"),Yg(r,s,a),()=>{br.ShaderChunk.shadowmap_pars_fragment=i,Yg(r,s,a)}}),[e,n,t]),null}function Vg(e,t){const n=e+"Geometry";return i.forwardRef((({args:e,children:s,...a},o)=>{const l=i.useRef(null);return i.useImperativeHandle(o,(()=>l.current)),i.useLayoutEffect((()=>{null==t||t(l.current)})),i.createElement("mesh",(0,r.A)({ref:l},a),i.createElement(n,{attach:"geometry",args:e}),s)}))}const Kg=Vg("box"),Wg=Vg("circle"),Jg=Vg("cone"),Xg=Vg("cylinder"),$g=Vg("sphere"),Zg=Vg("plane"),ev=Vg("tube"),tv=Vg("torus"),nv=Vg("torusKnot"),rv=Vg("tetrahedron"),iv=Vg("ring"),sv=Vg("polyhedron"),av=Vg("icosahedron"),ov=Vg("octahedron"),lv=Vg("dodecahedron"),cv=Vg("extrude"),hv=Vg("lathe"),uv=Vg("capsule"),dv=Vg("shape",(({geometry:e})=>{const t=e.attributes.position,n=(new a.NRn).setFromBufferAttribute(t),r=new a.Pq0;n.getSize(r);const i=[];let s=0,o=0,l=0,c=0;for(let a=0;a<t.count;a++)s=t.getX(a),o=t.getY(a),l=(s-n.min.x)/r.x,c=(o-n.min.y)/r.y,i.push(l,c);e.setAttribute("uv",new a.qtW(i,2))})),fv=1e-5;const Av=i.forwardRef((function({args:[e=1,t=1,n=1]=[],radius:s=.05,steps:o=1,smoothness:l=4,bevelSegments:c=4,creaseAngle:h=.4,children:u,...d},f){const A=i.useMemo((()=>function(e,t,n){const r=new a.ypk,i=n-fv;return r.absarc(fv,fv,fv,-Math.PI/2,-Math.PI,!0),r.absarc(fv,t-2*i,fv,Math.PI,Math.PI/2,!0),r.absarc(e-2*i,t-2*i,fv,Math.PI/2,0,!0),r.absarc(e-2*i,fv,fv,0,-Math.PI/2,!0),r}(e,t,s)),[e,t,s]),m=i.useMemo((()=>({depth:n-2*s,bevelEnabled:!0,bevelSegments:2*c,steps:o,bevelSize:s-fv,bevelThickness:s,curveSegments:l})),[n,s,l]),p=i.useRef(null);return i.useLayoutEffect((()=>{p.current&&(p.current.center(),Ss(p.current,h))}),[A,m]),i.createElement("mesh",(0,r.A)({ref:f},d),i.createElement("extrudeGeometry",{ref:p,args:[A,m]}),u)}));function mv(){const e=new a.LoY,t=new Float32Array([-1,-1,3,-1,-1,3]);return e.boundingSphere=new a.iyt,e.boundingSphere.set(new a.Pq0,1/0),e.setAttribute("position",new a.THS(t,2)),e}const pv=i.forwardRef((function({children:e,...t},n){const s=i.useMemo(mv,[]);return i.createElement("mesh",(0,r.A)({ref:n,geometry:s,frustumCulled:!1},t),e)})),gv=i.forwardRef((({children:e,width:t,height:n,depth:s,box3:o,precise:l=!0,...c},h)=>{const u=i.useRef(null),d=i.useRef(null),f=i.useRef(null);return i.useLayoutEffect((()=>{d.current.matrixWorld.identity();let e=o||(new a.NRn).setFromObject(f.current,l);const r=e.max.x-e.min.x,i=e.max.y-e.min.y,c=e.max.z-e.min.z;let h=Math.max(r,i,c);t&&(h=r),n&&(h=i),s&&(h=c),d.current.scale.setScalar(1/h)}),[t,n,s,o,l]),i.useImperativeHandle(h,(()=>u.current),[]),i.createElement("group",(0,r.A)({ref:u},c),i.createElement("group",{ref:d},i.createElement("group",{ref:f},e)))}));var vv=function(e){return e[e.NONE=0]="NONE",e[e.START=1]="START",e[e.ACTIVE=2]="ACTIVE",e}(vv||{});const yv=e=>e&&e.isOrthographicCamera,Ev=e=>e&&e.isBox3,xv=e=>1-Math.exp(-5*e)+.007*e,Cv=i.createContext(null);function wv({children:e,maxDuration:t=1,margin:n=1.2,observe:r,fit:s,clip:l,interpolateFunc:c=xv,onFit:h}){const u=i.useRef(null),{camera:d,size:f,invalidate:A}=(0,o.A)(),m=(0,o.A)((e=>e.controls)),p=i.useRef(h);p.current=h;const g=i.useRef({camPos:new a.Pq0,camRot:new a.PTz,camZoom:1}),v=i.useRef({camPos:void 0,camRot:void 0,camZoom:void 0,camUp:void 0,target:void 0}),y=i.useRef(vv.NONE),E=i.useRef(0),[x]=i.useState((()=>new a.NRn)),C=i.useMemo((()=>{function e(){const e=x.getSize(new a.Pq0),t=x.getCenter(new a.Pq0),r=Math.max(e.x,e.y,e.z),i=yv(d)?4*r:r/(2*Math.atan(Math.PI*d.fov/360)),s=yv(d)?4*r:i/d.aspect,o=n*Math.max(i,s);return{box:x,size:e,center:t,distance:o}}return{getSize:e,refresh(e){if(Ev(e))x.copy(e);else{const t=e||u.current;if(!t)return this;t.updateWorldMatrix(!0,!0),x.setFromObject(t)}if(x.isEmpty()){const e=d.position.length()||10;x.setFromCenterAndSize(new a.Pq0,new a.Pq0(e,e,e))}return g.current.camPos.copy(d.position),g.current.camRot.copy(d.quaternion),yv(d)&&(g.current.camZoom=d.zoom),v.current.camPos=void 0,v.current.camRot=void 0,v.current.camZoom=void 0,v.current.camUp=void 0,v.current.target=void 0,this},reset(){const{center:t,distance:n}=e(),r=d.position.clone().sub(t).normalize();v.current.camPos=t.clone().addScaledVector(r,n),v.current.target=t.clone();const i=(new a.kn4).lookAt(v.current.camPos,v.current.target,d.up);return v.current.camRot=(new a.PTz).setFromRotationMatrix(i),y.current=vv.START,E.current=0,this},moveTo(e){return v.current.camPos=Array.isArray(e)?new a.Pq0(...e):e.clone(),y.current=vv.START,E.current=0,this},lookAt({target:e,up:t}){v.current.target=Array.isArray(e)?new a.Pq0(...e):e.clone(),v.current.camUp=t?Array.isArray(t)?new a.Pq0(...t):t.clone():d.up.clone();const n=(new a.kn4).lookAt(v.current.camPos||d.position,v.current.target,v.current.camUp);return v.current.camRot=(new a.PTz).setFromRotationMatrix(n),y.current=vv.START,E.current=0,this},to({position:e,target:t}){return this.moveTo(e).lookAt({target:t})},fit(){if(!yv(d))return this.reset();let e=0,t=0;const r=[new a.Pq0(x.min.x,x.min.y,x.min.z),new a.Pq0(x.min.x,x.max.y,x.min.z),new a.Pq0(x.min.x,x.min.y,x.max.z),new a.Pq0(x.min.x,x.max.y,x.max.z),new a.Pq0(x.max.x,x.max.y,x.max.z),new a.Pq0(x.max.x,x.max.y,x.min.z),new a.Pq0(x.max.x,x.min.y,x.max.z),new a.Pq0(x.max.x,x.min.y,x.min.z)],i=v.current.camPos||d.position,s=v.current.target||(null==m?void 0:m.target),o=v.current.camUp||d.up,l=s?(new a.kn4).lookAt(i,s,o).setPosition(i).invert():d.matrixWorldInverse;for(const n of r)n.applyMatrix4(l),e=Math.max(e,Math.abs(n.y)),t=Math.max(t,Math.abs(n.x));e*=2,t*=2;const c=(d.top-d.bottom)/e,h=(d.right-d.left)/t;return v.current.camZoom=Math.min(c,h)/n,y.current=vv.START,E.current=0,p.current&&p.current(this.getSize()),this},clip(){const{distance:t}=e();return d.near=t/100,d.far=100*t,d.updateProjectionMatrix(),m&&(m.maxDistance=10*t,m.update()),A(),this}}}),[x,d,m,n,A]);i.useLayoutEffect((()=>{if(m){const e=()=>{if(m&&v.current.target&&y.current!==vv.NONE){const e=(new a.Pq0).setFromMatrixColumn(d.matrix,2),t=g.current.camPos.distanceTo(m.target),n=(v.current.camPos||g.current.camPos).distanceTo(v.current.target),r=(1-E.current)*t+E.current*n;m.target.copy(d.position).addScaledVector(e,-r),m.update()}y.current=vv.NONE};return m.addEventListener("start",e),()=>m.removeEventListener("start",e)}}),[m]);const w=i.useRef(0);return i.useLayoutEffect((()=>{(r||0==w.current++)&&(C.refresh(),s&&C.reset().fit(),l&&C.clip())}),[f,l,s,r,d,m]),(0,o.C)(((e,n)=>{if(y.current===vv.START)y.current=vv.ACTIVE,A();else if(y.current===vv.ACTIVE){if(E.current+=n/t,E.current>=1)v.current.camPos&&d.position.copy(v.current.camPos),v.current.camRot&&d.quaternion.copy(v.current.camRot),v.current.camUp&&d.up.copy(v.current.camUp),v.current.camZoom&&yv(d)&&(d.zoom=v.current.camZoom),d.updateMatrixWorld(),d.updateProjectionMatrix(),m&&v.current.target&&(m.target.copy(v.current.target),m.update()),y.current=vv.NONE;else{const e=c(E.current);v.current.camPos&&d.position.lerpVectors(g.current.camPos,v.current.camPos,e),v.current.camRot&&d.quaternion.slerpQuaternions(g.current.camRot,v.current.camRot,e),v.current.camUp&&d.up.set(0,1,0).applyQuaternion(d.quaternion),v.current.camZoom&&yv(d)&&(d.zoom=(1-e)*g.current.camZoom+e*v.current.camZoom),d.updateMatrixWorld(),d.updateProjectionMatrix()}A()}})),i.createElement("group",{ref:u},i.createElement(Cv.Provider,{value:C},e))}function Iv(){return i.useContext(Cv)}var bv=Object.defineProperty,Sv=(e,t,n)=>(((e,t,n)=>{t in e?bv(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Bv{constructor(e=Math){Sv(this,"grad3",[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]]),Sv(this,"grad4",[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]]),Sv(this,"p",[]),Sv(this,"perm",[]),Sv(this,"simplex",[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]),Sv(this,"dot",((e,t,n)=>e[0]*t+e[1]*n)),Sv(this,"dot3",((e,t,n,r)=>e[0]*t+e[1]*n+e[2]*r)),Sv(this,"dot4",((e,t,n,r,i)=>e[0]*t+e[1]*n+e[2]*r+e[3]*i)),Sv(this,"noise",((e,t)=>{let n,r,i;const s=(e+t)*(.5*(Math.sqrt(3)-1)),a=Math.floor(e+s),o=Math.floor(t+s),l=(3-Math.sqrt(3))/6,c=(a+o)*l,h=e-(a-c),u=t-(o-c);let d=0,f=1;h>u&&(d=1,f=0);const A=h-d+l,m=u-f+l,p=h-1+2*l,g=u-1+2*l,v=255&a,y=255&o,E=this.perm[v+this.perm[y]]%12,x=this.perm[v+d+this.perm[y+f]]%12,C=this.perm[v+1+this.perm[y+1]]%12;let w=.5-h*h-u*u;w<0?n=0:(w*=w,n=w*w*this.dot(this.grad3[E],h,u));let I=.5-A*A-m*m;I<0?r=0:(I*=I,r=I*I*this.dot(this.grad3[x],A,m));let b=.5-p*p-g*g;return b<0?i=0:(b*=b,i=b*b*this.dot(this.grad3[C],p,g)),70*(n+r+i)})),Sv(this,"noise3d",((e,t,n)=>{let r,i,s,a;const o=(e+t+n)*(1/3),l=Math.floor(e+o),c=Math.floor(t+o),h=Math.floor(n+o),u=1/6,d=(l+c+h)*u,f=e-(l-d),A=t-(c-d),m=n-(h-d);let p,g,v,y,E,x;f>=A?A>=m?(p=1,g=0,v=0,y=1,E=1,x=0):f>=m?(p=1,g=0,v=0,y=1,E=0,x=1):(p=0,g=0,v=1,y=1,E=0,x=1):A<m?(p=0,g=0,v=1,y=0,E=1,x=1):f<m?(p=0,g=1,v=0,y=0,E=1,x=1):(p=0,g=1,v=0,y=1,E=1,x=0);const C=f-p+u,w=A-g+u,I=m-v+u,b=f-y+2*u,S=A-E+2*u,B=m-x+2*u,T=f-1+.5,_=A-1+.5,M=m-1+.5,R=255&l,D=255&c,P=255&h,L=this.perm[R+this.perm[D+this.perm[P]]]%12,k=this.perm[R+p+this.perm[D+g+this.perm[P+v]]]%12,F=this.perm[R+y+this.perm[D+E+this.perm[P+x]]]%12,O=this.perm[R+1+this.perm[D+1+this.perm[P+1]]]%12;let U=.6-f*f-A*A-m*m;U<0?r=0:(U*=U,r=U*U*this.dot3(this.grad3[L],f,A,m));let Q=.6-C*C-w*w-I*I;Q<0?i=0:(Q*=Q,i=Q*Q*this.dot3(this.grad3[k],C,w,I));let N=.6-b*b-S*S-B*B;N<0?s=0:(N*=N,s=N*N*this.dot3(this.grad3[F],b,S,B));let z=.6-T*T-_*_-M*M;return z<0?a=0:(z*=z,a=z*z*this.dot3(this.grad3[O],T,_,M)),32*(r+i+s+a)})),Sv(this,"noise4d",((e,t,n,r)=>{const i=this.grad4,s=this.simplex,a=this.perm,o=(Math.sqrt(5)-1)/4,l=(5-Math.sqrt(5))/20;let c,h,u,d,f;const A=(e+t+n+r)*o,m=Math.floor(e+A),p=Math.floor(t+A),g=Math.floor(n+A),v=Math.floor(r+A),y=(m+p+g+v)*l,E=e-(m-y),x=t-(p-y),C=n-(g-y),w=r-(v-y),I=(E>x?32:0)+(E>C?16:0)+(x>C?8:0)+(E>w?4:0)+(x>w?2:0)+(C>w?1:0);let b,S,B,T,_,M,R,D,P,L,k,F;b=s[I][0]>=3?1:0,S=s[I][1]>=3?1:0,B=s[I][2]>=3?1:0,T=s[I][3]>=3?1:0,_=s[I][0]>=2?1:0,M=s[I][1]>=2?1:0,R=s[I][2]>=2?1:0,D=s[I][3]>=2?1:0,P=s[I][0]>=1?1:0,L=s[I][1]>=1?1:0,k=s[I][2]>=1?1:0,F=s[I][3]>=1?1:0;const O=E-b+l,U=x-S+l,Q=C-B+l,N=w-T+l,z=E-_+2*l,G=x-M+2*l,H=C-R+2*l,q=w-D+2*l,Y=E-P+3*l,j=x-L+3*l,V=C-k+3*l,K=w-F+3*l,W=E-1+4*l,J=x-1+4*l,X=C-1+4*l,$=w-1+4*l,Z=255&m,ee=255&p,te=255&g,ne=255&v,re=a[Z+a[ee+a[te+a[ne]]]]%32,ie=a[Z+b+a[ee+S+a[te+B+a[ne+T]]]]%32,se=a[Z+_+a[ee+M+a[te+R+a[ne+D]]]]%32,ae=a[Z+P+a[ee+L+a[te+k+a[ne+F]]]]%32,oe=a[Z+1+a[ee+1+a[te+1+a[ne+1]]]]%32;let le=.6-E*E-x*x-C*C-w*w;le<0?c=0:(le*=le,c=le*le*this.dot4(i[re],E,x,C,w));let ce=.6-O*O-U*U-Q*Q-N*N;ce<0?h=0:(ce*=ce,h=ce*ce*this.dot4(i[ie],O,U,Q,N));let he=.6-z*z-G*G-H*H-q*q;he<0?u=0:(he*=he,u=he*he*this.dot4(i[se],z,G,H,q));let ue=.6-Y*Y-j*j-V*V-K*K;ue<0?d=0:(ue*=ue,d=ue*ue*this.dot4(i[ae],Y,j,V,K));let de=.6-W*W-J*J-X*X-$*$;return de<0?f=0:(de*=de,f=de*de*this.dot4(i[oe],W,J,X,$)),27*(c+h+u+d+f)}));for(let t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());for(let t=0;t<512;t++)this.perm[t]=this.p[255&t]}}const Tv=i.forwardRef((({intensity:e=1,decay:t,decayRate:n=.65,maxYaw:r=.1,maxPitch:s=.1,maxRoll:a=.1,yawFrequency:l=.1,pitchFrequency:c=.1,rollFrequency:h=.1},u)=>{const d=(0,o.A)((e=>e.camera)),f=(0,o.A)((e=>e.controls)),A=i.useRef(e),m=i.useRef(d.rotation.clone()),[p]=i.useState((()=>new Bv)),[g]=i.useState((()=>new Bv)),[v]=i.useState((()=>new Bv)),y=()=>{(A.current<0||A.current>1)&&(A.current=A.current<0?0:1)};return i.useImperativeHandle(u,(()=>({getIntensity:()=>A.current,setIntensity:e=>{A.current=e,y()}})),[]),i.useEffect((()=>{if(f){const e=()=>{m.current=d.rotation.clone()};return f.addEventListener("change",e),e(),()=>{f.removeEventListener("change",e)}}}),[d,f]),(0,o.C)(((e,i)=>{const o=Math.pow(A.current,2),u=r*o*p.noise(e.clock.elapsedTime*l,1),f=s*o*g.noise(e.clock.elapsedTime*c,1),E=a*o*v.noise(e.clock.elapsedTime*h,1);d.rotation.set(m.current.x+f,m.current.y+u,m.current.z+E),t&&A.current>0&&(A.current-=n*i,y())})),null})),_v=i.forwardRef((({children:e,enabled:t=!0,speed:n=1,rotationIntensity:r=1,floatIntensity:s=1,floatingRange:l=[-.1,.1],autoInvalidate:c=!1,...h},u)=>{const d=i.useRef(null);i.useImperativeHandle(u,(()=>d.current),[]);const f=i.useRef(1e4*Math.random());return(0,o.C)((e=>{var i,o;if(!t||0===n)return;c&&e.invalidate();const h=f.current+e.clock.elapsedTime;d.current.rotation.x=Math.cos(h/4*n)/8*r,d.current.rotation.y=Math.sin(h/4*n)/8*r,d.current.rotation.z=Math.sin(h/4*n)/20*r;let u=Math.sin(h/4*n)/10;u=a.cj9.mapLinear(u,-.1,.1,null!==(i=null==l?void 0:l[0])&&void 0!==i?i:-.1,null!==(o=null==l?void 0:l[1])&&void 0!==o?o:.1),d.current.position.y=u*s,d.current.updateMatrix()})),i.createElement("group",h,i.createElement("group",{ref:d,matrixAutoUpdate:!1},e))}));class Mv extends a.eaF{constructor(e,t){var n,r;const i=(s=e)&&s.isCubeTexture;var s;const o=(null!=(r=i?null==(n=e.image[0])?void 0:n.width:e.image.width)?r:1024)/4,l=Math.floor(Math.log2(o)),c=Math.pow(2,l),h=[i?"#define ENVMAP_TYPE_CUBE":"","#define CUBEUV_TEXEL_WIDTH "+1/(3*Math.max(c,112)),"#define CUBEUV_TEXEL_HEIGHT "+1/(4*c),`#define CUBEUV_MAX_MIP ${l}.0`].join("\n")+`\n        #define ENVMAP_TYPE_CUBE_UV\n        varying vec3 vWorldPosition;\n        uniform float radius;\n        uniform float height;\n        uniform float angle;\n        #ifdef ENVMAP_TYPE_CUBE\n            uniform samplerCube map;\n        #else\n            uniform sampler2D map;\n        #endif\n        // From: https://www.shadertoy.com/view/4tsBD7\n        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) \n        {\n            float d = dot ( rd, n );\n            \n            if( d > 0.0 ) { return 1e6; }\n            \n            vec3  o = ro - c;\n            float t = - dot( n, o ) / d;\n            vec3  q = o + rd * t;\n            \n            return ( dot( q, q ) < r * r ) ? t : 1e6;\n        }\n        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm\n        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) \n        {\n            vec3 oc = ro - ce;\n            float b = dot( oc, rd );\n            float c = dot( oc, oc ) - ra * ra;\n            float h = b * b - c;\n            \n            if( h < 0.0 ) { return -1.0; }\n            \n            h = sqrt( h );\n            \n            return - b + h;\n        }\n        vec3 project() \n        {\n            vec3 p = normalize( vWorldPosition );\n            vec3 camPos = cameraPosition;\n            camPos.y -= height;\n            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );\n            if( intersection > 0.0 ) {\n                \n                vec3 h = vec3( 0.0, - height, 0.0 );\n                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );\n                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;\n            } else {\n                p = vec3( 0.0, 1.0, 0.0 );\n            }\n            return p;\n        }\n        #include <common>\n        #include <cube_uv_reflection_fragment>\n        void main() \n        {\n            vec3 projectedWorldPosition = project();\n            \n            #ifdef ENVMAP_TYPE_CUBE\n                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;\n            #else\n                vec3 direction = normalize( projectedWorldPosition );\n                vec2 uv = equirectUv( direction );\n                vec3 outcolor = texture2D( map, uv ).rgb;\n            #endif\n            gl_FragColor = vec4( outcolor, 1.0 );\n            #include <tonemapping_fragment>\n            #include <${Sr>=154?"colorspace_fragment":"encodings_fragment"}>\n        }\n        `,u={map:{value:e},height:{value:(null==t?void 0:t.height)||15},radius:{value:(null==t?void 0:t.radius)||100}};super(new a.WBB(1,16),new a.BKk({uniforms:u,fragmentShader:h,vertexShader:"\n        varying vec3 vWorldPosition;\n        void main() \n        {\n            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );\n            vWorldPosition = worldPosition.xyz;\n            \n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }\n        ",side:a.$EB}))}set radius(e){this.material.uniforms.radius.value=e}get radius(){return this.material.uniforms.radius.value}set height(e){this.material.uniforms.height.value=e}get height(){return this.material.uniforms.height.value}}class Rv extends a.BRH{constructor(e){super(e),this.type=a.ix0}parse(e){const t=function(e,t){switch(e){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(t||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(t||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(t||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(t||""))}},n=function(e,t,n){t=t||1024;let r=e.pos,i=-1,s=0,a="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(r,r+128)));for(;0>(i=o.indexOf("\n"))&&s<t&&r<e.byteLength;)a+=o,s+=o.length,r+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(r,r+128)));return-1<i&&(!1!==n&&(e.pos+=s+i+1),a+o.slice(0,i))},r=function(e,t,n,r){const i=e[t+3],s=Math.pow(2,i-128)/255;n[r+0]=e[t+0]*s,n[r+1]=e[t+1]*s,n[r+2]=e[t+2]*s,n[r+3]=1},i=function(e,t,n,r){const i=e[t+3],s=Math.pow(2,i-128)/255;n[r+0]=a.GxU.toHalfFloat(Math.min(e[t+0]*s,65504)),n[r+1]=a.GxU.toHalfFloat(Math.min(e[t+1]*s,65504)),n[r+2]=a.GxU.toHalfFloat(Math.min(e[t+2]*s,65504)),n[r+3]=a.GxU.toHalfFloat(1)},s=new Uint8Array(e);s.pos=0;const o=function(e){const r=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,s=/^\s*FORMAT=(\S+)\s*$/,a=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,c;for((e.pos>=e.byteLength||!(l=n(e)))&&t(1,"no header found"),(c=l.match(/^#\?(\S+)/))||t(3,"bad initial token"),o.valid|=1,o.programtype=c[1],o.string+=l+"\n";l=n(e),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((c=l.match(r))&&(o.gamma=parseFloat(c[1])),(c=l.match(i))&&(o.exposure=parseFloat(c[1])),(c=l.match(s))&&(o.valid|=2,o.format=c[1]),(c=l.match(a))&&(o.valid|=4,o.height=parseInt(c[1],10),o.width=parseInt(c[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid||t(3,"missing format specifier"),4&o.valid||t(3,"missing image size specifier"),o}(s),l=o.width,c=o.height,h=function(e,n,r){const i=n;if(i<8||i>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);i!==(e[2]<<8|e[3])&&t(3,"wrong scanline width");const s=new Uint8Array(4*n*r);s.length||t(4,"unable to allocate buffer space");let a=0,o=0;const l=4*i,c=new Uint8Array(4),h=new Uint8Array(l);let u=r;for(;u>0&&o<e.byteLength;){o+4>e.byteLength&&t(1),c[0]=e[o++],c[1]=e[o++],c[2]=e[o++],c[3]=e[o++],2==c[0]&&2==c[1]&&(c[2]<<8|c[3])==i||t(3,"bad rgbe scanline format");let n,r=0;for(;r<l&&o<e.byteLength;){n=e[o++];const i=n>128;if(i&&(n-=128),(0===n||r+n>l)&&t(3,"bad scanline data"),i){const t=e[o++];for(let e=0;e<n;e++)h[r++]=t}else h.set(e.subarray(o,o+n),r),r+=n,o+=n}const d=i;for(let e=0;e<d;e++){let t=0;s[a]=h[e+t],t+=i,s[a+1]=h[e+t],t+=i,s[a+2]=h[e+t],t+=i,s[a+3]=h[e+t],a+=4}u--}return s}(s.subarray(s.pos),l,c);let u,d,f;switch(this.type){case a.RQf:f=h.length/4;const e=new Float32Array(4*f);for(let n=0;n<f;n++)r(h,4*n,e,4*n);u=e,d=a.RQf;break;case a.ix0:f=h.length/4;const t=new Uint16Array(4*f);for(let n=0;n<f;n++)i(h,4*n,t,4*n);u=t,d=a.ix0;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:l,height:c,data:u,header:o.string,gamma:o.gamma,exposure:o.exposure,type:d}}setDataType(e){return this.type=e,this}load(e,t,n,r){return super.load(e,(function(e,n){switch(e.type){case a.RQf:case a.ix0:"colorSpace"in e?e.colorSpace="srgb-linear":e.encoding=3e3,e.minFilter=a.k6q,e.magFilter=a.k6q,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,n)}),n,r)}}const Dv=Sr>=152;class Pv extends a.BRH{constructor(e){super(e),this.type=a.ix0}parse(e){const t=65536,n=14,r=65537,i=16384,s=Math.pow(2.7182818,2.2);const o={l:0,c:0,lc:0};function l(e,t,n,r,i){for(;n<e;)t=t<<8|G(r,i),n+=8;n-=e,o.l=t>>n&(1<<e)-1,o.c=t,o.lc=n}const c=new Array(59);function h(e,t,n,i,s,a,h){for(var u=n,d=0,f=0;s<=a;s++){if(u.value-n.value>i)return!1;l(6,d,f,e,u);var A=o.l;if(d=o.c,f=o.lc,h[s]=A,63==A){if(u.value-n.value>i)throw"Something wrong with hufUnpackEncTable";l(8,d,f,e,u);var m=o.l+6;if(d=o.c,f=o.lc,s+m>a+1)throw"Something wrong with hufUnpackEncTable";for(;m--;)h[s++]=0;s--}else if(A>=59){if(s+(m=A-59+2)>a+1)throw"Something wrong with hufUnpackEncTable";for(;m--;)h[s++]=0;s--}}!function(e){for(var t=0;t<=58;++t)c[t]=0;for(t=0;t<r;++t)c[e[t]]+=1;var n=0;for(t=58;t>0;--t){var i=n+c[t]>>1;c[t]=n,n=i}for(t=0;t<r;++t){var s=e[t];s>0&&(e[t]=s|c[s]++<<6)}}(h)}function u(e){return 63&e}function d(e){return e>>6}const f={c:0,lc:0};function A(e,t,n,r){e=e<<8|G(n,r),t+=8,f.c=e,f.lc=t}const m={c:0,lc:0};function p(e,t,n,r,i,s,a,o,l,c){if(e==t){r<8&&(A(n,r,i,a),n=f.c,r=f.lc);var h=n>>(r-=8);h=new Uint8Array([h])[0];if(l.value+h>c)return!1;for(var u=o[l.value-1];h-- >0;)o[l.value++]=u}else{if(!(l.value<c))return!1;o[l.value++]=e}m.c=n,m.lc=r}function g(e){return 65535&e}function v(e){var t=g(e);return t>32767?t-65536:t}const y={a:0,b:0};function E(e,t){var n=v(e),r=v(t),i=n+(1&r)+(r>>1),s=i,a=i-r;y.a=s,y.b=a}function x(e,t){var n=g(e),r=g(t),i=n-(r>>1)&65535,s=r+i-32768&65535;y.a=s,y.b=i}function C(e,t,n,r,i,s,a){for(var o,l=a<16384,c=n>i?i:n,h=1;h<=c;)h<<=1;for(o=h>>=1,h>>=1;h>=1;){for(var u,d,f,A,m=0,p=m+s*(i-o),g=s*h,v=s*o,C=r*h,w=r*o;m<=p;m+=v){for(var I=m,b=m+r*(n-o);I<=b;I+=w){var S=I+C,B=(T=I+g)+C;l?(E(e[I+t],e[T+t]),u=y.a,f=y.b,E(e[S+t],e[B+t]),d=y.a,A=y.b,E(u,d),e[I+t]=y.a,e[S+t]=y.b,E(f,A),e[T+t]=y.a,e[B+t]=y.b):(x(e[I+t],e[T+t]),u=y.a,f=y.b,x(e[S+t],e[B+t]),d=y.a,A=y.b,x(u,d),e[I+t]=y.a,e[S+t]=y.b,x(f,A),e[T+t]=y.a,e[B+t]=y.b)}if(n&h){var T=I+g;l?E(e[I+t],e[T+t]):x(e[I+t],e[T+t]),u=y.a,e[T+t]=y.b,e[I+t]=u}}if(i&h)for(I=m,b=m+r*(n-o);I<=b;I+=w){S=I+C;l?E(e[I+t],e[S+t]):x(e[I+t],e[S+t]),u=y.a,e[S+t]=y.b,e[I+t]=u}o=h,h>>=1}return m}function w(e,t,s,a,o,l){var c=s.value,g=z(t,s),v=z(t,s);s.value+=4;var y=z(t,s);if(s.value+=4,g<0||g>=r||v<0||v>=r)throw"Something wrong with HUF_ENCSIZE";var E=new Array(r),x=new Array(i);if(function(e){for(var t=0;t<i;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(x),h(e,0,s,a-(s.value-c),g,v,E),y>8*(a-(s.value-c)))throw"Something wrong with hufUncompress";!function(e,t,r,i){for(;t<=r;t++){var s=d(e[t]),a=u(e[t]);if(s>>a)throw"Invalid table entry";if(a>n){if((h=i[s>>a-n]).len)throw"Invalid table entry";if(h.lit++,h.p){var o=h.p;h.p=new Array(h.lit);for(var l=0;l<h.lit-1;++l)h.p[l]=o[l]}else h.p=new Array(1);h.p[h.lit-1]=t}else if(a){var c=0;for(l=1<<n-a;l>0;l--){var h;if((h=i[(s<<n-a)+c]).len||h.p)throw"Invalid table entry";h.len=a,h.lit=t,c++}}}}(E,g,v,x),function(e,t,r,i,s,a,o,l,c,h){for(var g=0,v=0,y=l,E=Math.trunc(s.value+(a+7)/8);s.value<E;)for(A(g,v,r,s),g=f.c,v=f.lc;v>=n;)if((I=t[g>>v-n&16383]).len)v-=I.len,p(I.lit,o,g,v,r,0,s,c,h,y),g=m.c,v=m.lc;else{if(!I.p)throw"hufDecode issues";var x;for(x=0;x<I.lit;x++){for(var C=u(e[I.p[x]]);v<C&&s.value<E;)A(g,v,r,s),g=f.c,v=f.lc;if(v>=C&&d(e[I.p[x]])==(g>>v-C&(1<<C)-1)){v-=C,p(I.p[x],o,g,v,r,0,s,c,h,y),g=m.c,v=m.lc;break}}if(x==I.lit)throw"hufDecode issues"}var w=8-a&7;for(g>>=w,v-=w;v>0;){var I;if(!(I=t[g<<n-v&16383]).len)throw"hufDecode issues";v-=I.len,p(I.lit,o,g,v,r,0,s,c,h,y),g=m.c,v=m.lc}}(E,x,e,0,s,y,v,l,o,{value:0})}function I(e){for(var t=1;t<e.length;t++){var n=e[t-1]+e[t]-128;e[t]=n}}function b(e,t){for(var n=0,r=Math.floor((e.length+1)/2),i=0,s=e.length-1;!(i>s||(t[i++]=e[n++],i>s));)t[i++]=e[r++]}function S(e){for(var t=e.byteLength,n=new Array,r=0,i=new DataView(e);t>0;){var s=i.getInt8(r++);if(s<0){t-=(o=-s)+1;for(var a=0;a<o;a++)n.push(i.getUint8(r++))}else{var o=s;t-=2;var l=i.getUint8(r++);for(a=0;a<o+1;a++)n.push(l)}}return n}function B(e,t,n){for(var r,i=1;i<64;)65280==(r=t[e.value])?i=64:r>>8==255?i+=255&r:(n[i]=r,i++),e.value++}function T(e,t){t[0]=V(e[0]),t[1]=V(e[1]),t[2]=V(e[5]),t[3]=V(e[6]),t[4]=V(e[14]),t[5]=V(e[15]),t[6]=V(e[27]),t[7]=V(e[28]),t[8]=V(e[2]),t[9]=V(e[4]),t[10]=V(e[7]),t[11]=V(e[13]),t[12]=V(e[16]),t[13]=V(e[26]),t[14]=V(e[29]),t[15]=V(e[42]),t[16]=V(e[3]),t[17]=V(e[8]),t[18]=V(e[12]),t[19]=V(e[17]),t[20]=V(e[25]),t[21]=V(e[30]),t[22]=V(e[41]),t[23]=V(e[43]),t[24]=V(e[9]),t[25]=V(e[11]),t[26]=V(e[18]),t[27]=V(e[24]),t[28]=V(e[31]),t[29]=V(e[40]),t[30]=V(e[44]),t[31]=V(e[53]),t[32]=V(e[10]),t[33]=V(e[19]),t[34]=V(e[23]),t[35]=V(e[32]),t[36]=V(e[39]),t[37]=V(e[45]),t[38]=V(e[52]),t[39]=V(e[54]),t[40]=V(e[20]),t[41]=V(e[22]),t[42]=V(e[33]),t[43]=V(e[38]),t[44]=V(e[46]),t[45]=V(e[51]),t[46]=V(e[55]),t[47]=V(e[60]),t[48]=V(e[21]),t[49]=V(e[34]),t[50]=V(e[37]),t[51]=V(e[47]),t[52]=V(e[50]),t[53]=V(e[56]),t[54]=V(e[59]),t[55]=V(e[61]),t[56]=V(e[35]),t[57]=V(e[36]),t[58]=V(e[48]),t[59]=V(e[49]),t[60]=V(e[57]),t[61]=V(e[58]),t[62]=V(e[62]),t[63]=V(e[63])}function _(e){const t=.5*Math.cos(.7853975),n=.5*Math.cos(3.14159/16),r=.5*Math.cos(3.14159/8),i=.5*Math.cos(3*3.14159/16),s=.5*Math.cos(.981746875),a=.5*Math.cos(3*3.14159/8),o=.5*Math.cos(1.374445625);for(var l=new Array(4),c=new Array(4),h=new Array(4),u=new Array(4),d=0;d<8;++d){var f=8*d;l[0]=r*e[f+2],l[1]=a*e[f+2],l[2]=r*e[f+6],l[3]=a*e[f+6],c[0]=n*e[f+1]+i*e[f+3]+s*e[f+5]+o*e[f+7],c[1]=i*e[f+1]-o*e[f+3]-n*e[f+5]-s*e[f+7],c[2]=s*e[f+1]-n*e[f+3]+o*e[f+5]+i*e[f+7],c[3]=o*e[f+1]-s*e[f+3]+i*e[f+5]-n*e[f+7],h[0]=t*(e[f+0]+e[f+4]),h[3]=t*(e[f+0]-e[f+4]),h[1]=l[0]+l[3],h[2]=l[1]-l[2],u[0]=h[0]+h[1],u[1]=h[3]+h[2],u[2]=h[3]-h[2],u[3]=h[0]-h[1],e[f+0]=u[0]+c[0],e[f+1]=u[1]+c[1],e[f+2]=u[2]+c[2],e[f+3]=u[3]+c[3],e[f+4]=u[3]-c[3],e[f+5]=u[2]-c[2],e[f+6]=u[1]-c[1],e[f+7]=u[0]-c[0]}for(var A=0;A<8;++A)l[0]=r*e[16+A],l[1]=a*e[16+A],l[2]=r*e[48+A],l[3]=a*e[48+A],c[0]=n*e[8+A]+i*e[24+A]+s*e[40+A]+o*e[56+A],c[1]=i*e[8+A]-o*e[24+A]-n*e[40+A]-s*e[56+A],c[2]=s*e[8+A]-n*e[24+A]+o*e[40+A]+i*e[56+A],c[3]=o*e[8+A]-s*e[24+A]+i*e[40+A]-n*e[56+A],h[0]=t*(e[A]+e[32+A]),h[3]=t*(e[A]-e[32+A]),h[1]=l[0]+l[3],h[2]=l[1]-l[2],u[0]=h[0]+h[1],u[1]=h[3]+h[2],u[2]=h[3]-h[2],u[3]=h[0]-h[1],e[0+A]=u[0]+c[0],e[8+A]=u[1]+c[1],e[16+A]=u[2]+c[2],e[24+A]=u[3]+c[3],e[32+A]=u[3]-c[3],e[40+A]=u[2]-c[2],e[48+A]=u[1]-c[1],e[56+A]=u[0]-c[0]}function M(e){for(var t=0;t<64;++t){var n=e[0][t],r=e[1][t],i=e[2][t];e[0][t]=n+1.5747*i,e[1][t]=n-.1873*r-.4682*i,e[2][t]=n+1.8556*r}}function R(e,t,n){for(var r=0;r<64;++r)t[n+r]=a.GxU.toHalfFloat(D(e[r]))}function D(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(s,Math.abs(e)-1)}function P(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function L(e){var t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),n=new Uint8Array(S(t)),r=new Uint8Array(n.length);return I(n),b(n,r),new DataView(r.buffer)}function k(e){var t=Ou(e.array.slice(e.offset.value,e.offset.value+e.size)),n=new Uint8Array(t.length);return I(t),b(t,n),new DataView(n.buffer)}function F(e){for(var n=e.viewer,r={value:e.offset.value},i=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),s=new Uint8Array(8192),a=0,o=new Array(e.channels),l=0;l<e.channels;l++)o[l]={},o[l].start=a,o[l].end=o[l].start,o[l].nx=e.width,o[l].ny=e.lines,o[l].size=e.type,a+=o[l].nx*o[l].ny*o[l].size;var c=K(n,r),h=K(n,r);if(h>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(c<=h)for(l=0;l<h-c+1;l++)s[l+c]=H(n,r);var u=new Uint16Array(t),d=function(e,n){for(var r=0,i=0;i<t;++i)(0==i||e[i>>3]&1<<(7&i))&&(n[r++]=i);for(var s=r-1;r<t;)n[r++]=0;return s}(s,u),f=z(n,r);w(e.array,n,r,f,i,a);for(l=0;l<e.channels;++l)for(var A=o[l],m=0;m<o[l].size;++m)C(i,A.start+m,A.nx,A.size,A.ny,A.nx*A.size,d);!function(e,t,n){for(var r=0;r<n;++r)t[r]=e[t[r]]}(u,i,a);for(var p=0,g=new Uint8Array(i.buffer.byteLength),v=0;v<e.lines;v++)for(var y=0;y<e.channels;y++){var E=(A=o[y]).nx*A.size,x=new Uint8Array(i.buffer,2*A.end,2*E);g.set(x,p),p+=2*E,A.end+=E}return new DataView(g.buffer)}function O(e){var t=Ou(e.array.slice(e.offset.value,e.offset.value+e.size));const n=e.lines*e.channels*e.width,r=1==e.type?new Uint16Array(n):new Uint32Array(n);let i=0,s=0;const a=new Array(4);for(let o=0;o<e.lines;o++)for(let n=0;n<e.channels;n++){let n=0;switch(e.type){case 1:a[0]=i,a[1]=a[0]+e.width,i=a[1]+e.width;for(let i=0;i<e.width;++i){n+=t[a[0]++]<<8|t[a[1]++],r[s]=n,s++}break;case 2:a[0]=i,a[1]=a[0]+e.width,a[2]=a[1]+e.width,i=a[2]+e.width;for(let i=0;i<e.width;++i){n+=t[a[0]++]<<24|t[a[1]++]<<16|t[a[2]++]<<8,r[s]=n,s++}}}return new DataView(r.buffer)}function U(e){var t=e.viewer,n={value:e.offset.value},r=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),i={version:q(t,n),unknownUncompressedSize:q(t,n),unknownCompressedSize:q(t,n),acCompressedSize:q(t,n),dcCompressedSize:q(t,n),rleCompressedSize:q(t,n),rleUncompressedSize:q(t,n),rleRawSize:q(t,n),totalAcUncompressedCount:q(t,n),totalDcUncompressedCount:q(t,n),acCompression:q(t,n)};if(i.version<2)throw"EXRLoader.parse: "+ee.compression+" version "+i.version+" is unsupported";for(var s=new Array,a=K(t,n)-2;a>0;){var o=Q(t.buffer,n),l=H(t,n),c=l>>2&3,h=new Int8Array([(l>>4)-1])[0],u=H(t,n);s.push({name:o,index:h,type:u,compression:c}),a-=o.length+3}for(var d=ee.channels,f=new Array(e.channels),A=0;A<e.channels;++A){var m=f[A]={},p=d[A];m.name=p.name,m.compression=0,m.decoded=!1,m.type=p.pixelType,m.pLinear=p.pLinear,m.width=e.width,m.height=e.lines}for(var g={idx:new Array(3)},v=0;v<e.channels;++v)for(m=f[v],A=0;A<s.length;++A){var y=s[A];m.name==y.name&&(m.compression=y.compression,y.index>=0&&(g.idx[y.index]=v),m.offset=v)}if(i.acCompressedSize>0)switch(i.acCompression){case 0:var E=new Uint16Array(i.totalAcUncompressedCount);w(e.array,t,n,i.acCompressedSize,E,i.totalAcUncompressedCount);break;case 1:var x=Ou(e.array.slice(n.value,n.value+i.totalAcUncompressedCount));E=new Uint16Array(x.buffer);n.value+=i.totalAcUncompressedCount}if(i.dcCompressedSize>0){var C={array:e.array,offset:n,size:i.dcCompressedSize},I=new Uint16Array(k(C).buffer);n.value+=i.dcCompressedSize}if(i.rleRawSize>0){var b=S((x=Ou(e.array.slice(n.value,n.value+i.rleCompressedSize))).buffer);n.value+=i.rleCompressedSize}var D=0,P=new Array(f.length);for(A=0;A<P.length;++A)P[A]=new Array;for(var L=0;L<e.lines;++L)for(var F=0;F<f.length;++F)P[F].push(D),D+=f[F].width*e.type*2;!function(e,t,n,r,i,s){var a=new DataView(s.buffer),o=n[e.idx[0]].width,l=n[e.idx[0]].height,c=Math.floor(o/8),h=Math.ceil(o/8),u=Math.ceil(l/8),d=o-8*(h-1),f=l-8*(u-1),A={value:0},m=new Array(3),p=new Array(3),g=new Array(3),v=new Array(3),y=new Array(3);for(let B=0;B<3;++B)y[B]=t[e.idx[B]],m[B]=B<1?0:m[B-1]+h*u,p[B]=new Float32Array(64),g[B]=new Uint16Array(64),v[B]=new Uint16Array(64*h);for(let D=0;D<u;++D){var E=8;D==u-1&&(E=f);var x=8;for(let e=0;e<h;++e){e==h-1&&(x=d);for(let e=0;e<3;++e)g[e].fill(0),g[e][0]=i[m[e]++],B(A,r,g[e]),T(g[e],p[e]),_(p[e]);M(p);for(let t=0;t<3;++t)R(p[t],v[t],64*e)}let t=0;for(let r=0;r<3;++r){const i=n[e.idx[r]].type;for(let e=8*D;e<8*D+E;++e){t=y[r][e];for(let n=0;n<c;++n){const s=64*n+8*(7&e);a.setUint16(t+0*i,v[r][s+0],!0),a.setUint16(t+2*i,v[r][s+1],!0),a.setUint16(t+4*i,v[r][s+2],!0),a.setUint16(t+6*i,v[r][s+3],!0),a.setUint16(t+8*i,v[r][s+4],!0),a.setUint16(t+10*i,v[r][s+5],!0),a.setUint16(t+12*i,v[r][s+6],!0),a.setUint16(t+14*i,v[r][s+7],!0),t+=16*i}}if(c!=h)for(let e=8*D;e<8*D+E;++e){const t=y[r][e]+8*c*2*i,n=64*c+8*(7&e);for(let e=0;e<x;++e)a.setUint16(t+2*e*i,v[r][n+e],!0)}}}for(var C=new Uint16Array(o),w=(a=new DataView(s.buffer),0);w<3;++w){n[e.idx[w]].decoded=!0;var I=n[e.idx[w]].type;if(2==n[w].type)for(var b=0;b<l;++b){const e=y[w][b];for(var S=0;S<o;++S)C[S]=a.getUint16(e+2*S*I,!0);for(S=0;S<o;++S)a.setFloat32(e+2*S*I,V(C[S]),!0)}}}(g,P,f,E,I,r);for(A=0;A<f.length;++A){if(!(m=f[A]).decoded){if(2!==m.compression)throw"EXRLoader.parse: unsupported channel compression";var O=0,U=0;for(L=0;L<e.lines;++L){for(var N=P[A][O],z=0;z<m.width;++z){for(var G=0;G<2*m.type;++G)r[N++]=b[U+G*m.width*m.height];U++}O++}}}return new DataView(r.buffer)}function Q(e,t){for(var n=new Uint8Array(e),r=0;0!=n[t.value+r];)r+=1;var i=(new TextDecoder).decode(n.slice(t.value,t.value+r));return t.value=t.value+r+1,i}function N(e,t){var n=e.getInt32(t.value,!0);return t.value=t.value+4,n}function z(e,t){var n=e.getUint32(t.value,!0);return t.value=t.value+4,n}function G(e,t){var n=e[t.value];return t.value=t.value+1,n}function H(e,t){var n=e.getUint8(t.value);return t.value=t.value+1,n}const q=function(e,t){let n;return n="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,n};function Y(e,t){var n=e.getFloat32(t.value,!0);return t.value+=4,n}function j(e,t){return a.GxU.toHalfFloat(Y(e,t))}function V(e){var t=(31744&e)>>10,n=1023&e;return(e>>15?-1:1)*(t?31===t?n?NaN:1/0:Math.pow(2,t-15)*(1+n/1024):n/1024*6103515625e-14)}function K(e,t){var n=e.getUint16(t.value,!0);return t.value+=2,n}function W(e,t){return V(K(e,t))}function J(e,t,n,r,i){return"string"===r||"stringvector"===r||"iccProfile"===r?function(e,t,n){var r=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+n));return t.value=t.value+n,r}(t,n,i):"chlist"===r?function(e,t,n,r){for(var i=n.value,s=[];n.value<i+r-1;){var a=Q(t,n),o=N(e,n),l=H(e,n);n.value+=3;var c=N(e,n),h=N(e,n);s.push({name:a,pixelType:o,pLinear:l,xSampling:c,ySampling:h})}return n.value+=1,s}(e,t,n,i):"chromaticities"===r?function(e,t){return{redX:Y(e,t),redY:Y(e,t),greenX:Y(e,t),greenY:Y(e,t),blueX:Y(e,t),blueY:Y(e,t),whiteX:Y(e,t),whiteY:Y(e,t)}}(e,n):"compression"===r?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][H(e,t)]}(e,n):"box2i"===r?function(e,t){return{xMin:z(e,t),yMin:z(e,t),xMax:z(e,t),yMax:z(e,t)}}(e,n):"lineOrder"===r?function(e,t){return["INCREASING_Y"][H(e,t)]}(e,n):"float"===r?Y(e,n):"v2f"===r?function(e,t){return[Y(e,t),Y(e,t)]}(e,n):"v3f"===r?function(e,t){return[Y(e,t),Y(e,t),Y(e,t)]}(e,n):"int"===r?N(e,n):"rational"===r?function(e,t){return[N(e,t),z(e,t)]}(e,n):"timecode"===r?function(e,t){return[z(e,t),z(e,t)]}(e,n):"preview"===r?(n.value+=i,"skipped"):void(n.value+=i)}const X=new DataView(e),$=new Uint8Array(e),Z={value:0},ee=function(e,t,n){const r={};if(20000630!=e.getUint32(0,!0))throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";r.version=e.getUint8(4);const i=e.getUint8(5);r.spec={singleTile:!!(2&i),longName:!!(4&i),deepFormat:!!(8&i),multiPart:!!(16&i)},n.value=8;for(var s=!0;s;){var a=Q(t,n);if(0==a)s=!1;else{var o=Q(t,n),l=J(e,t,n,o,z(e,n));void 0===l?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${o}'.`):r[a]=l}}if(-5&i)throw console.error("EXRHeader:",r),"THREE.EXRLoader: provided file is currently unsupported.";return r}(X,e,Z),te=function(e,t,n,r,i){const s={size:0,viewer:t,array:n,offset:r,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,[Dv?"colorSpace":"encoding"]:null};switch(e.compression){case"NO_COMPRESSION":s.lines=1,s.uncompress=P;break;case"RLE_COMPRESSION":s.lines=1,s.uncompress=L;break;case"ZIPS_COMPRESSION":s.lines=1,s.uncompress=k;break;case"ZIP_COMPRESSION":s.lines=16,s.uncompress=k;break;case"PIZ_COMPRESSION":s.lines=32,s.uncompress=F;break;case"PXR24_COMPRESSION":s.lines=16,s.uncompress=O;break;case"DWAA_COMPRESSION":s.lines=32,s.uncompress=U;break;case"DWAB_COMPRESSION":s.lines=256,s.uncompress=U;break;default:throw"EXRLoader.parse: "+e.compression+" is unsupported"}if(s.scanlineBlockSize=s.lines,1==s.type)switch(i){case a.RQf:s.getter=W,s.inputSize=2;break;case a.ix0:s.getter=K,s.inputSize=2}else{if(2!=s.type)throw"EXRLoader.parse: unsupported pixelType "+s.type+" for "+e.compression+".";switch(i){case a.RQf:s.getter=Y,s.inputSize=4;break;case a.ix0:s.getter=j,s.inputSize=4}}s.blockCount=(e.dataWindow.yMax+1)/s.scanlineBlockSize;for(var o=0;o<s.blockCount;o++)q(t,r);s.outputChannels=3==s.channels?4:s.channels;const l=s.width*s.height*s.outputChannels;switch(i){case a.RQf:s.byteArray=new Float32Array(l),s.channels<s.outputChannels&&s.byteArray.fill(1,0,l);break;case a.ix0:s.byteArray=new Uint16Array(l),s.channels<s.outputChannels&&s.byteArray.fill(15360,0,l);break;default:console.error("THREE.EXRLoader: unsupported type: ",i)}return s.bytesPerLine=s.width*s.inputSize*s.channels,4==s.outputChannels?s.format=a.GWd:s.format=a.VT0,Dv?s.colorSpace="srgb-linear":s.encoding=3e3,s}(ee,X,$,Z,this.type),ne={value:0},re={R:0,G:1,B:2,A:3,Y:0};for(let a=0;a<te.height/te.scanlineBlockSize;a++){const e=z(X,Z);te.size=z(X,Z),te.lines=e+te.scanlineBlockSize>te.height?te.height-e:te.scanlineBlockSize;const t=te.size<te.lines*te.bytesPerLine?te.uncompress(te):P(te);Z.value+=te.size;for(let n=0;n<te.scanlineBlockSize;n++){const e=n+a*te.scanlineBlockSize;if(e>=te.height)break;for(let r=0;r<te.channels;r++){const i=re[ee.channels[r].name];for(let s=0;s<te.width;s++){ne.value=(n*(te.channels*te.width)+r*te.width+s)*te.inputSize;const a=(te.height-1-e)*(te.width*te.outputChannels)+s*te.outputChannels+i;te.byteArray[a]=te.getter(t,ne)}}}}return{header:ee,width:te.width,height:te.height,data:te.byteArray,format:te.format,[Dv?"colorSpace":"encoding"]:te[Dv?"colorSpace":"encoding"],type:this.type}}setDataType(e){return this.type=e,this}load(e,t,n,r){return super.load(e,(function(e,n){Dv?e.colorSpace=n.colorSpace:e.encoding=n.encoding,e.minFilter=a.k6q,e.magFilter=a.k6q,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,n)}),n,r)}}const Lv=(e,t,n)=>{let r;switch(e){case a.OUM:r=new Uint8ClampedArray(t*n*4);break;case a.ix0:r=new Uint16Array(t*n*4);break;case a.bkx:r=new Uint32Array(t*n*4);break;case a.tJf:r=new Int8Array(t*n*4);break;case a.fBL:r=new Int16Array(t*n*4);break;case a.Yuy:r=new Int32Array(t*n*4);break;case a.RQf:r=new Float32Array(t*n*4);break;default:throw new Error("Unsupported data type")}return r};let kv;class Fv{constructor(e){var t,n,r,i,s,o,l,c,h,u,d,f,A,m,p,g;this._rendererIsDisposable=!1,this._supportsReadPixels=!0,this.render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(Sf){throw this._renderer.setRenderTarget(null),Sf}this._renderer.setRenderTarget(null)},this._width=e.width,this._height=e.height,this._type=e.type,this._colorSpace=e.colorSpace;const v={format:a.GWd,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:void 0!==(null===(t=e.renderTargetOptions)||void 0===t?void 0:t.anisotropy)?null===(n=e.renderTargetOptions)||void 0===n?void 0:n.anisotropy:1,generateMipmaps:void 0!==(null===(r=e.renderTargetOptions)||void 0===r?void 0:r.generateMipmaps)&&(null===(i=e.renderTargetOptions)||void 0===i?void 0:i.generateMipmaps),magFilter:void 0!==(null===(s=e.renderTargetOptions)||void 0===s?void 0:s.magFilter)?null===(o=e.renderTargetOptions)||void 0===o?void 0:o.magFilter:a.k6q,minFilter:void 0!==(null===(l=e.renderTargetOptions)||void 0===l?void 0:l.minFilter)?null===(c=e.renderTargetOptions)||void 0===c?void 0:c.minFilter:a.k6q,samples:void 0!==(null===(h=e.renderTargetOptions)||void 0===h?void 0:h.samples)?null===(u=e.renderTargetOptions)||void 0===u?void 0:u.samples:void 0,wrapS:void 0!==(null===(d=e.renderTargetOptions)||void 0===d?void 0:d.wrapS)?null===(f=e.renderTargetOptions)||void 0===f?void 0:f.wrapS:a.ghU,wrapT:void 0!==(null===(A=e.renderTargetOptions)||void 0===A?void 0:A.wrapT)?null===(m=e.renderTargetOptions)||void 0===m?void 0:m.wrapT:a.ghU};if(this._material=e.material,e.renderer?this._renderer=e.renderer:(this._renderer=Fv.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new a.Z58,this._camera=new a.qUd,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!((e,t,n,r)=>{if(void 0!==kv)return kv;const i=new a.nWS(1,1,r);t.setRenderTarget(i);const s=new a.eaF(new a.bdM,new a.V9B({color:16777215}));t.render(s,n),t.setRenderTarget(null);const o=Lv(e,i.width,i.height);return t.readRenderTargetPixels(i,0,0,i.width,i.height,o),i.dispose(),s.geometry.dispose(),s.material.dispose(),kv=0!==o[0],kv})(this._type,this._renderer,this._camera,v)){let e;if(this._type===a.ix0)e=this._renderer.extensions.has("EXT_color_buffer_float")?a.RQf:void 0;void 0!==e?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${a.RQf}`),this._type=e):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new a.eaF(new a.bdM,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new a.nWS(this.width,this.height,v),this._renderTarget.texture.mapping=void 0!==(null===(p=e.renderTargetOptions)||void 0===p?void 0:p.mapping)?null===(g=e.renderTargetOptions)||void 0===g?void 0:g.mapping:a.UTZ}static instantiateRenderer(){const e=new br.WebGLRenderer;return e.setSize(128,128),e}toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const e=Lv(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,e),e}toDataTexture(e){const t=new a.GYF(this.toArray(),this.width,this.height,a.GWd,this._type,(null==e?void 0:e.mapping)||a.UTZ,(null==e?void 0:e.wrapS)||a.ghU,(null==e?void 0:e.wrapT)||a.ghU,(null==e?void 0:e.magFilter)||a.k6q,(null==e?void 0:e.minFilter)||a.k6q,(null==e?void 0:e.anisotropy)||1,a.Zr2);return t.generateMipmaps=void 0!==(null==e?void 0:e.generateMipmaps)&&(null==e?void 0:e.generateMipmaps),t}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(e){this.disposeOnDemandRenderer(),e&&this.renderTarget.dispose(),this.material instanceof a.BKk&&Object.values(this.material.uniforms).forEach((e=>{e.value instanceof a.gPd&&e.value.dispose()})),Object.values(this.material).forEach((e=>{e instanceof a.gPd&&e.dispose()})),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(e){this._width=e,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(e){this._height=e,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(e){this._renderTarget=e,this._width=e.width,this._height=e.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}class Ov extends a.BKk{constructor({gamma:e,offsetHdr:t,offsetSdr:n,gainMapMin:r,gainMapMax:i,maxDisplayBoost:s,hdrCapacityMin:o,hdrCapacityMax:l,sdr:c,gainMap:h}){super({name:"GainMapDecoderMaterial",vertexShader:"\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",fragmentShader:"\n// min half float value\n#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )\n// max half float value\n#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )\n\nuniform sampler2D sdr;\nuniform sampler2D gainMap;\nuniform vec3 gamma;\nuniform vec3 offsetHdr;\nuniform vec3 offsetSdr;\nuniform vec3 gainMapMin;\nuniform vec3 gainMapMax;\nuniform float weightFactor;\n\nvarying vec2 vUv;\n\nvoid main() {\n  vec3 rgb = texture2D( sdr, vUv ).rgb;\n  vec3 recovery = texture2D( gainMap, vUv ).rgb;\n  vec3 logRecovery = pow( recovery, gamma );\n  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;\n  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;\n  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));\n  gl_FragColor = vec4( clampedHdrColor , 1.0 );\n}\n",uniforms:{sdr:{value:c},gainMap:{value:h},gamma:{value:new a.Pq0(1/e[0],1/e[1],1/e[2])},offsetHdr:{value:(new a.Pq0).fromArray(t)},offsetSdr:{value:(new a.Pq0).fromArray(n)},gainMapMin:{value:(new a.Pq0).fromArray(r)},gainMapMax:{value:(new a.Pq0).fromArray(i)},weightFactor:{value:(Math.log2(s)-o)/(l-o)}},blending:a.XIg,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=s,this._hdrCapacityMin=o,this._hdrCapacityMax=l,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(e){this.uniforms.sdr.value=e}get gainMap(){return this.uniforms.gainMap.value}set gainMap(e){this.uniforms.gainMap.value=e}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(e){this.uniforms.offsetHdr.value.fromArray(e)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(e){this.uniforms.offsetSdr.value.fromArray(e)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(e){this.uniforms.gainMapMin.value.fromArray(e)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(e){this.uniforms.gainMapMax.value.fromArray(e)}get gamma(){const e=this.uniforms.gamma.value;return[1/e.x,1/e.y,1/e.z]}set gamma(e){const t=this.uniforms.gamma.value;t.x=1/e[0],t.y=1/e[1],t.z=1/e[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(e){this._hdrCapacityMin=e,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(e){this._hdrCapacityMax=e,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(e){this._maxDisplayBoost=Math.max(1,Math.min(65504,e)),this.calculateWeight()}calculateWeight(){const e=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,e))}}class Uv extends Error{}class Qv extends Error{}const Nv=(e,t,n)=>{const r=new RegExp(`${t}="([^"]*)"`,"i").exec(e);if(r)return r[1];const i=new RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i").exec(e);if(i){const e=i[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return e&&3===e.length?e.map((e=>e.replace(/<\/?rdf:li>/g,""))):i[1].trim()}if(void 0!==n)return n;throw new Error(`Can't find ${t} in gainmap metadata`)};class zv{constructor(e){this.options={debug:!(!e||void 0===e.debug)&&e.debug,extractFII:!e||void 0===e.extractFII||e.extractFII,extractNonFII:!e||void 0===e.extractNonFII||e.extractNonFII}}extract(e){return new Promise(((t,n)=>{const r=this.options.debug,i=new DataView(e.buffer);if(65496!==i.getUint16(0))return void n(new Error("Not a valid jpeg"));const s=i.byteLength;let a,o=2,l=0;for(;o<s;){if(++l>250)return void n(new Error(`Found no marker after ${l} loops \ud83d\ude35`));if(255!==i.getUint8(o))return void n(new Error(`Not a valid marker at offset 0x${o.toString(16)}, found: 0x${i.getUint8(o).toString(16)}`));if(a=i.getUint8(o+1),r&&console.log(`Marker: ${a.toString(16)}`),226===a){r&&console.log("Found APP2 marker (0xffe2)");const e=o+4;if(1297106432===i.getUint32(e)){const r=e+4;let s;if(18761===i.getUint16(r))s=!1;else{if(19789!==i.getUint16(r))return void n(new Error("No valid endianness marker found in TIFF header"));s=!0}if(42!==i.getUint16(r+2,!s))return void n(new Error("Not valid TIFF data! (no 0x002A marker)"));const a=i.getUint32(r+4,!s);if(a<8)return void n(new Error("Not valid TIFF data! (First offset less than 8)"));const o=r+a,l=i.getUint16(o,!s),c=o+2;let h=0;for(let e=c;e<c+12*l;e+=12)45057===i.getUint16(e,!s)&&(h=i.getUint32(e+8,!s));const u=o+2+12*l+4,d=[];for(let e=u;e<u+16*h;e+=16){const t={MPType:i.getUint32(e,!s),size:i.getUint32(e+4,!s),dataOffset:i.getUint32(e+8,!s),dependantImages:i.getUint32(e+12,!s),start:-1,end:-1,isFII:!1};t.dataOffset?(t.start=r+t.dataOffset,t.isFII=!1):(t.start=0,t.isFII=!0),t.end=t.start+t.size,d.push(t)}if(this.options.extractNonFII&&d.length){const e=new Blob([i]),n=[];for(const t of d){if(t.isFII&&!this.options.extractFII)continue;const r=e.slice(t.start,t.end+1,"image/jpeg");n.push(r)}t(n)}}}o+=2+i.getUint16(o+2)}}))}}const Gv=async e=>{const t=(e=>{let t;t="undefined"!=typeof TextDecoder?(new TextDecoder).decode(e):e.toString();let n=t.indexOf("<x:xmpmeta");for(;-1!==n;){const e=t.indexOf("x:xmpmeta>",n),r=t.slice(n,e+10);try{const e=Nv(r,"hdrgm:GainMapMin","0"),t=Nv(r,"hdrgm:GainMapMax"),n=Nv(r,"hdrgm:Gamma","1"),i=Nv(r,"hdrgm:OffsetSDR","0.015625"),s=Nv(r,"hdrgm:OffsetHDR","0.015625"),a=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(r),o=a?a[1]:"0",l=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(r);if(!l)throw new Error("Incomplete gainmap metadata");const c=l[1];return{gainMapMin:Array.isArray(e)?e.map((e=>parseFloat(e))):[parseFloat(e),parseFloat(e),parseFloat(e)],gainMapMax:Array.isArray(t)?t.map((e=>parseFloat(e))):[parseFloat(t),parseFloat(t),parseFloat(t)],gamma:Array.isArray(n)?n.map((e=>parseFloat(e))):[parseFloat(n),parseFloat(n),parseFloat(n)],offsetSdr:Array.isArray(i)?i.map((e=>parseFloat(e))):[parseFloat(i),parseFloat(i),parseFloat(i)],offsetHdr:Array.isArray(s)?s.map((e=>parseFloat(e))):[parseFloat(s),parseFloat(s),parseFloat(s)],hdrCapacityMin:parseFloat(o),hdrCapacityMax:parseFloat(c)}}catch(Sf){}n=t.indexOf("<x:xmpmeta",e)}})(e);if(!t)throw new Qv("Gain map XMP metadata not found");const n=new zv({extractFII:!0,extractNonFII:!0}),r=await n.extract(e);if(2!==r.length)throw new Uv("Gain map recovery image not found");return{sdr:new Uint8Array(await r[0].arrayBuffer()),gainMap:new Uint8Array(await r[1].arrayBuffer()),metadata:t}},Hv=e=>new Promise(((t,n)=>{const r=document.createElement("img");r.onload=()=>{t(r)},r.onerror=e=>{n(e)},r.src=URL.createObjectURL(e)}));class qv extends a.aHM{constructor(e,t){super(t),e&&(this._renderer=e),this._internalLoadingManager=new a.KPJ}setRenderer(e){return this._renderer=e,this}setRenderTargetOptions(e){return this._renderTargetOptions=e,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: An existing WebGL Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const e=new Ov({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new a.gPd,sdr:new a.gPd});return new Fv({width:16,height:16,type:a.ix0,colorSpace:a.Zr2,material:e,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async render(e,t,n,r){const i=r?new Blob([r],{type:"image/jpeg"}):void 0,s=new Blob([n],{type:"image/jpeg"});let o,l,c=!1;if("undefined"==typeof createImageBitmap){const e=await Promise.all([i?Hv(i):Promise.resolve(void 0),Hv(s)]);l=e[0],o=e[1],c=!0}else{const e=await Promise.all([i?createImageBitmap(i,{imageOrientation:"flipY"}):Promise.resolve(void 0),createImageBitmap(s,{imageOrientation:"flipY"})]);l=e[0],o=e[1]}const h=new a.gPd(l||new ImageData(2,2),a.UTZ,a.ghU,a.ghU,a.k6q,a.NZq,a.GWd,a.OUM,1,a.Zr2);h.flipY=c,h.needsUpdate=!0;const u=new a.gPd(o,a.UTZ,a.ghU,a.ghU,a.k6q,a.NZq,a.GWd,a.OUM,1,a.er$);u.flipY=c,u.needsUpdate=!0,e.width=o.width,e.height=o.height,e.material.gainMap=h,e.material.sdr=u,e.material.gainMapMin=t.gainMapMin,e.material.gainMapMax=t.gainMapMax,e.material.offsetHdr=t.offsetHdr,e.material.offsetSdr=t.offsetSdr,e.material.gamma=t.gamma,e.material.hdrCapacityMin=t.hdrCapacityMin,e.material.hdrCapacityMax=t.hdrCapacityMax,e.material.maxDisplayBoost=Math.pow(2,t.hdrCapacityMax),e.material.needsUpdate=!0,e.render()}}class Yv extends qv{load([e,t,n],r,i,s){const o=this.prepareQuadRenderer();let l,c,h;const u=async()=>{if(l&&c&&h){try{await this.render(o,h,l,c)}catch(i){return this.manager.itemError(e),this.manager.itemError(t),this.manager.itemError(n),"function"==typeof s&&s(i),void o.disposeOnDemandRenderer()}"function"==typeof r&&r(o),this.manager.itemEnd(e),this.manager.itemEnd(t),this.manager.itemEnd(n),o.disposeOnDemandRenderer()}};let d=!0,f=0,A=0,m=!0,p=0,g=0,v=!0,y=0,E=0;const x=()=>{if("function"==typeof i){i(new ProgressEvent("progress",{lengthComputable:d&&m&&v,loaded:A+g+E,total:f+p+y}))}};this.manager.itemStart(e),this.manager.itemStart(t),this.manager.itemStart(n);const C=new a.Y9S(this._internalLoadingManager);C.setResponseType("arraybuffer"),C.setRequestHeader(this.requestHeader),C.setPath(this.path),C.setWithCredentials(this.withCredentials),C.load(e,(async e=>{if("string"==typeof e)throw new Error("Invalid sdr buffer");l=e,await u()}),(e=>{d=e.lengthComputable,A=e.loaded,f=e.total,x()}),(t=>{this.manager.itemError(e),"function"==typeof s&&s(t)}));const w=new a.Y9S(this._internalLoadingManager);w.setResponseType("arraybuffer"),w.setRequestHeader(this.requestHeader),w.setPath(this.path),w.setWithCredentials(this.withCredentials),w.load(t,(async e=>{if("string"==typeof e)throw new Error("Invalid gainmap buffer");c=e,await u()}),(e=>{m=e.lengthComputable,g=e.loaded,p=e.total,x()}),(e=>{this.manager.itemError(t),"function"==typeof s&&s(e)}));const I=new a.Y9S(this._internalLoadingManager);return I.setRequestHeader(this.requestHeader),I.setPath(this.path),I.setWithCredentials(this.withCredentials),I.load(n,(async e=>{if("string"!=typeof e)throw new Error("Invalid metadata string");h=JSON.parse(e),await u()}),(e=>{v=e.lengthComputable,E=e.loaded,y=e.total,x()}),(e=>{this.manager.itemError(n),"function"==typeof s&&s(e)})),o}}class jv extends qv{load(e,t,n,r){const i=this.prepareQuadRenderer(),s=new a.Y9S(this._internalLoadingManager);return s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setPath(this.path),s.setWithCredentials(this.withCredentials),this.manager.itemStart(e),s.load(e,(async n=>{if("string"==typeof n)throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const s=new Uint8Array(n);let a,o,l;try{const e=await Gv(s);a=e.sdr,o=e.gainMap,l=e.metadata}catch(Sf){if(!(Sf instanceof Qv||Sf instanceof Uv))throw Sf;console.warn(`Failure to reconstruct an HDR image from ${e}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),l={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},a=s}try{await this.render(i,l,a,o)}catch(c){return this.manager.itemError(e),"function"==typeof r&&r(c),void i.disposeOnDemandRenderer()}"function"==typeof t&&t(i),this.manager.itemEnd(e),i.disposeOnDemandRenderer()}),n,(t=>{this.manager.itemError(e),"function"==typeof r&&r(t)})),i}}const Vv={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},Kv="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",Wv=e=>Array.isArray(e),Jv=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function Xv({files:e=Jv,path:t="",preset:n,colorSpace:r,extensions:s}={}){n&&(ey(n),e=Vv[n],t=Kv);const l=Wv(e),{extension:c,isCubemap:h}=ty(e),u=ny(c);if(!u)throw new Error("useEnvironment: Unrecognized file extension: "+e);const d=(0,o.A)((e=>e.gl));(0,i.useLayoutEffect)((()=>{"webp"!==c&&"jpg"!==c&&"jpeg"!==c||d.domElement.addEventListener("webglcontextlost",(function(){o.F.clear(u,l?[e]:e)}),{once:!0})}),[e,d.domElement]);const f=(0,o.F)(u,l?[e]:e,(e=>{"webp"!==c&&"jpg"!==c&&"jpeg"!==c||e.setRenderer(d),null==e.setPath||e.setPath(t),s&&s(e)}));let A=l?f[0]:f;var m;"jpg"!==c&&"jpeg"!==c&&"webp"!==c||(A=null==(m=A.renderTarget)?void 0:m.texture);return A.mapping=h?a.hy7:a.wfO,A.colorSpace=null!=r?r:h?"srgb":"srgb-linear",A}const $v={files:Jv,path:"",preset:void 0,extensions:void 0};Xv.preload=e=>{const t={...$v,...e};let{files:n,path:r=""}=t;const{preset:i,extensions:s}=t;i&&(ey(i),n=Vv[i],r=Kv);const{extension:a}=ty(n);if("webp"===a||"jpg"===a||"jpeg"===a)throw new Error("useEnvironment: Preloading gainmaps is not supported");const l=ny(a);if(!l)throw new Error("useEnvironment: Unrecognized file extension: "+n);o.F.preload(l,Wv(n)?[n]:n,(e=>{null==e.setPath||e.setPath(r),s&&s(e)}))};const Zv={files:Jv,preset:void 0};function ey(e){if(!(e in Vv))throw new Error("Preset must be one of: "+Object.keys(Vv).join(", "))}function ty(e){var t;const n=Wv(e)&&6===e.length,r=Wv(e)&&3===e.length&&e.some((e=>e.endsWith("json"))),i=Wv(e)?e[0]:e;return{extension:n?"cube":r?"webp":i.startsWith("data:application/exr")?"exr":i.startsWith("data:application/hdr")?"hdr":i.startsWith("data:image/jpeg")?"jpg":null==(t=i.split(".").pop())||null==(t=t.split("?"))||null==(t=t.shift())?void 0:t.toLowerCase(),isCubemap:n,isGainmap:r}}function ny(e){return"cube"===e?a.ScU:"hdr"===e?Rv:"exr"===e?Pv:"jpg"===e||"jpeg"===e?jv:"webp"===e?Yv:null}Xv.clear=e=>{const t={...Zv,...e};let{files:n}=t;const{preset:r}=t;r&&(ey(r),n=Vv[r]);const{extension:i}=ty(n),s=ny(i);if(!s)throw new Error("useEnvironment: Unrecognized file extension: "+n);o.F.clear(s,Wv(n)?[n]:n)};const ry=e=>{return(t=e).current&&t.current.isScene?e.current:e;var t};function iy(e,t,n,r,i={}){var s,a,l,c;i={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...i};const h=ry(t||n),u=h.background,d=h.environment,f={backgroundBlurriness:h.backgroundBlurriness,backgroundIntensity:h.backgroundIntensity,backgroundRotation:null!==(s=null==(a=h.backgroundRotation)||null==a.clone?void 0:a.clone())&&void 0!==s?s:[0,0,0],environmentIntensity:h.environmentIntensity,environmentRotation:null!==(l=null==(c=h.environmentRotation)||null==c.clone?void 0:c.clone())&&void 0!==l?l:[0,0,0]};return"only"!==e&&(h.environment=r),e&&(h.background=r),(0,o.q)(h,i),()=>{"only"!==e&&(h.environment=d),e&&(h.background=u),(0,o.q)(h,f)}}function sy({scene:e,background:t=!1,map:n,...r}){const s=(0,o.A)((e=>e.scene));return i.useLayoutEffect((()=>{if(n)return iy(t,e,s,n,r)})),null}function ay({background:e=!1,scene:t,blur:n,backgroundBlurriness:r,backgroundIntensity:s,backgroundRotation:a,environmentIntensity:l,environmentRotation:c,...h}){const u=Xv(h),d=(0,o.A)((e=>e.scene));return i.useLayoutEffect((()=>iy(e,t,d,u,{backgroundBlurriness:null!=n?n:r,backgroundIntensity:s,backgroundRotation:a,environmentIntensity:l,environmentRotation:c}))),i.useEffect((()=>()=>{u.dispose()}),[u]),null}function oy({children:e,near:t=.1,far:n=1e3,resolution:r=256,frames:s=1,map:l,background:c=!1,blur:h,backgroundBlurriness:u,backgroundIntensity:d,backgroundRotation:f,environmentIntensity:A,environmentRotation:m,scene:p,files:g,path:v,preset:y,extensions:E}){const x=(0,o.A)((e=>e.gl)),C=(0,o.A)((e=>e.scene)),w=i.useRef(null),[I]=i.useState((()=>new a.Z58)),b=i.useMemo((()=>{const e=new a.o6l(r);return e.texture.type=a.ix0,e}),[r]);i.useEffect((()=>()=>{b.dispose()}),[b]),i.useLayoutEffect((()=>{if(1===s){const e=x.autoClear;x.autoClear=!0,w.current.update(x,I),x.autoClear=e}return iy(c,p,C,b.texture,{backgroundBlurriness:null!=h?h:u,backgroundIntensity:d,backgroundRotation:f,environmentIntensity:A,environmentRotation:m})}),[e,I,b.texture,p,C,c,s,x]);let S=1;return(0,o.C)((()=>{if(s===1/0||S<s){const e=x.autoClear;x.autoClear=!0,w.current.update(x,I),x.autoClear=e,S++}})),i.createElement(i.Fragment,null,(0,o.o)(i.createElement(i.Fragment,null,e,i.createElement("cubeCamera",{ref:w,args:[t,n,b]}),g||y?i.createElement(ay,{background:!0,files:g,preset:y,path:v,extensions:E}):l?i.createElement(sy,{background:!0,map:l,extensions:E}):null),I))}function ly(e){var t,n,s,a;const l=Xv(e),c=e.map||l;i.useMemo((()=>(0,o.e)({GroundProjectedEnvImpl:Mv})),[]),i.useEffect((()=>()=>{l.dispose()}),[l]);const h=i.useMemo((()=>[c]),[c]),u=null==(t=e.ground)?void 0:t.height,d=null==(n=e.ground)?void 0:n.radius,f=null!==(s=null==(a=e.ground)?void 0:a.scale)&&void 0!==s?s:1e3;return i.createElement(i.Fragment,null,i.createElement(sy,(0,r.A)({},e,{map:c})),i.createElement("groundProjectedEnvImpl",{args:h,scale:f,height:u,radius:d}))}function cy(e){return e.ground?i.createElement(ly,e):e.map?i.createElement(sy,e):e.children?i.createElement(oy,e):i.createElement(ay,e)}const hy={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:"\n      varying vec2 vUv;\n\n      void main() {\n\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n      }\n  ",fragmentShader:"\n    uniform sampler2D tDiffuse;\n    uniform float h;\n\n    varying vec2 vUv;\n\n    void main() {\n\n    \tvec4 sum = vec4( 0.0 );\n\n    \tsum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;\n    \tsum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;\n    \tsum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;\n    \tsum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;\n    \tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;\n    \tsum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;\n    \tsum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;\n    \tsum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;\n    \tsum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;\n\n    \tgl_FragColor = sum;\n\n    }\n  "},uy={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:"\n    varying vec2 vUv;\n\n    void main() {\n\n      vUv = uv;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n    }\n  ",fragmentShader:"\n\n  uniform sampler2D tDiffuse;\n  uniform float v;\n\n  varying vec2 vUv;\n\n  void main() {\n\n    vec4 sum = vec4( 0.0 );\n\n    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;\n    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;\n    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;\n    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;\n    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;\n    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;\n    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;\n    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;\n    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;\n\n    gl_FragColor = sum;\n\n  }\n  "},dy=i.forwardRef((({scale:e=10,frames:t=1/0,opacity:n=1,width:s=1,height:l=1,blur:c=1,near:h=0,far:u=10,resolution:d=512,smooth:f=!0,color:A="#000000",depthWrite:m=!1,renderOrder:p,...g},v)=>{const y=i.useRef(null),E=(0,o.A)((e=>e.scene)),x=(0,o.A)((e=>e.gl)),C=i.useRef(null);s*=Array.isArray(e)?e[0]:e||1,l*=Array.isArray(e)?e[1]:e||1;const[w,I,b,S,B,T,_]=i.useMemo((()=>{const e=new a.nWS(d,d),t=new a.nWS(d,d);t.texture.generateMipmaps=e.texture.generateMipmaps=!1;const n=new a.bdM(s,l).rotateX(Math.PI/2),r=new a.eaF(n),i=new a.CSG;i.depthTest=i.depthWrite=!1,i.onBeforeCompile=e=>{e.uniforms={...e.uniforms,ucolor:{value:new a.Q1f(A)}},e.fragmentShader=e.fragmentShader.replace("void main() {","uniform vec3 ucolor;\n           void main() {\n          "),e.fragmentShader=e.fragmentShader.replace("vec4( vec3( 1.0 - fragCoordZ ), opacity );","vec4( ucolor * fragCoordZ * 2.0, ( 1.0 - fragCoordZ ) * 1.0 );")};const o=new a.BKk(hy),c=new a.BKk(uy);return c.depthTest=o.depthTest=!1,[e,n,i,r,o,c,t]}),[d,s,l,e,A]),M=e=>{S.visible=!0,S.material=B,B.uniforms.tDiffuse.value=w.texture,B.uniforms.h.value=1*e/256,x.setRenderTarget(_),x.render(S,C.current),S.material=T,T.uniforms.tDiffuse.value=_.texture,T.uniforms.v.value=1*e/256,x.setRenderTarget(w),x.render(S,C.current),S.visible=!1};let R,D,P=0;return(0,o.C)((()=>{C.current&&(t===1/0||P<t)&&(P++,R=E.background,D=E.overrideMaterial,y.current.visible=!1,E.background=null,E.overrideMaterial=b,x.setRenderTarget(w),x.render(E,C.current),M(c),f&&M(.4*c),x.setRenderTarget(null),y.current.visible=!0,E.overrideMaterial=D,E.background=R)})),i.useImperativeHandle(v,(()=>y.current),[]),i.createElement("group",(0,r.A)({"rotation-x":Math.PI/2},g,{ref:y}),i.createElement("mesh",{renderOrder:p,geometry:I,scale:[1,-1,1],rotation:[-Math.PI/2,0,0]},i.createElement("meshBasicMaterial",{transparent:!0,map:w.texture,opacity:n,depthWrite:m})),i.createElement("orthographicCamera",{ref:C,args:[-s/2,s/2,l/2,-l/2,h,u]}))}));const fy=i.createContext(null),Ay=aa({color:new a.Q1f,blend:2,alphaTest:.75,opacity:0,map:null},"varying vec2 vUv;\n   void main() {\n     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);\n     vUv = uv;\n   }",`varying vec2 vUv;\n   uniform sampler2D map;\n   uniform vec3 color;\n   uniform float opacity;\n   uniform float alphaTest;\n   uniform float blend;\n   void main() {\n     vec4 sampledDiffuseColor = texture2D(map, vUv);\n     gl_FragColor = vec4(color * sampledDiffuseColor.r * blend, max(0.0, (1.0 - (sampledDiffuseColor.r + sampledDiffuseColor.g + sampledDiffuseColor.b) / alphaTest)) * opacity);\n     #include <tonemapping_fragment>\n     #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n   }`),my=i.forwardRef((({children:e,temporal:t,frames:n=40,limit:r=1/0,blend:s=20,scale:a=10,opacity:l=1,alphaTest:c=.75,color:h="black",colorBlend:u=2,resolution:d=1024,toneMapped:f=!0,...A},m)=>{(0,o.e)({SoftShadowMaterial:Ay});const p=(0,o.A)((e=>e.gl)),g=(0,o.A)((e=>e.scene)),v=(0,o.A)((e=>e.camera)),y=(0,o.A)((e=>e.invalidate)),E=i.useRef(null),x=i.useRef(null),[C]=i.useState((()=>new gy(p,g,d)));i.useLayoutEffect((()=>{C.configure(E.current)}),[]);const w=i.useMemo((()=>({lights:new Map,temporal:!!t,frames:Math.max(2,n),blend:Math.max(2,n===1/0?s:n),count:0,getMesh:()=>E.current,reset:()=>{C.clear();const e=E.current.material;e.opacity=0,e.alphaTest=0,w.count=0},update:(e=1)=>{const t=E.current.material;w.temporal?(t.opacity=Math.min(l,t.opacity+l/w.blend),t.alphaTest=Math.min(c,t.alphaTest+c/w.blend)):(t.opacity=l,t.alphaTest=c),x.current.visible=!0,C.prepare();for(let n=0;n<e;n++)w.lights.forEach((e=>e.update())),C.update(v,w.blend);x.current.visible=!1,C.finish()}})),[C,v,g,t,n,s,l,c]);return i.useLayoutEffect((()=>{w.reset(),w.temporal||w.frames===1/0||w.update(w.blend)})),i.useImperativeHandle(m,(()=>w),[w]),(0,o.C)((()=>{(w.temporal||w.frames===1/0)&&w.count<w.frames&&w.count<r&&(y(),w.update(),w.count++)})),i.createElement("group",A,i.createElement("group",{traverse:()=>null,ref:x},i.createElement(fy.Provider,{value:w},e)),i.createElement("mesh",{receiveShadow:!0,ref:E,scale:a,rotation:[-Math.PI/2,0,0]},i.createElement("planeGeometry",null),i.createElement("softShadowMaterial",{transparent:!0,depthWrite:!1,toneMapped:f,color:h,blend:u,map:C.progressiveLightMap2.texture})))})),py=i.forwardRef((({castShadow:e=!0,bias:t=.001,mapSize:n=512,size:s=5,near:o=.5,far:l=500,frames:c=1,position:h=[0,0,0],radius:u=1,amount:d=8,intensity:f=(ha>=155?Math.PI:1),ambient:A=.5,...m},p)=>{const g=i.useRef(null),v=new a.Pq0(...h).length(),y=i.useContext(fy),E=i.useCallback((()=>{let e;if(g.current)for(let t=0;t<g.current.children.length;t++)if(e=g.current.children[t],Math.random()>A)e.position.set(h[0]+a.cj9.randFloatSpread(u),h[1]+a.cj9.randFloatSpread(u),h[2]+a.cj9.randFloatSpread(u));else{let t=Math.acos(2*Math.random()-1)-Math.PI/2,n=2*Math.PI*Math.random();e.position.set(Math.cos(t)*Math.cos(n)*v,Math.abs(Math.cos(t)*Math.sin(n)*v),Math.sin(t)*v)}}),[u,A,v,...h]),x=i.useMemo((()=>({update:E})),[E]);return i.useImperativeHandle(p,(()=>x),[x]),i.useLayoutEffect((()=>{var e;const t=g.current;return y&&(null==(e=y.lights)||e.set(t.uuid,x)),()=>{var e;null==y||null==(e=y.lights)||e.delete(t.uuid)}}),[y,x]),i.createElement("group",(0,r.A)({ref:g},m),Array.from({length:d},((r,a)=>i.createElement("directionalLight",{key:a,castShadow:e,"shadow-bias":t,"shadow-mapSize":[n,n],intensity:f/d},i.createElement("orthographicCamera",{attach:"shadow-camera",args:[-s,s,s,-s,o,l]})))))}));class gy{constructor(e,t,n=1024){this.renderer=e,this.res=n,this.scene=t,this.buffer1Active=!1,this.lights=[],this.meshes=[],this.object=null,this.clearColor=new a.Q1f,this.clearAlpha=0;const r={type:a.ix0,magFilter:a.hxR,minFilter:a.hxR};this.progressiveLightMap1=new a.nWS(this.res,this.res,r),this.progressiveLightMap2=new a.nWS(this.res,this.res,r),this.discardMat=new Fg,this.targetMat=new a.G_z({fog:!1}),this.previousShadowMap={value:this.progressiveLightMap1.texture},this.averagingWindow={value:100},this.targetMat.onBeforeCompile=e=>{e.vertexShader="varying vec2 vUv;\n"+e.vertexShader.slice(0,-1)+"vUv = uv; gl_Position = vec4((uv - 0.5) * 2.0, 1.0, 1.0); }";const t=e.fragmentShader.indexOf("void main() {");e.fragmentShader="varying vec2 vUv;\n"+e.fragmentShader.slice(0,t)+"uniform sampler2D previousShadowMap;\n\tuniform float averagingWindow;\n"+e.fragmentShader.slice(t-1,-1)+"\nvec3 texelOld = texture2D(previousShadowMap, vUv).rgb;\n        gl_FragColor.rgb = mix(texelOld, gl_FragColor.rgb, 1.0/ averagingWindow);\n      }",e.uniforms.previousShadowMap=this.previousShadowMap,e.uniforms.averagingWindow=this.averagingWindow}}clear(){this.renderer.getClearColor(this.clearColor),this.clearAlpha=this.renderer.getClearAlpha(),this.renderer.setClearColor("black",1),this.renderer.setRenderTarget(this.progressiveLightMap1),this.renderer.clear(),this.renderer.setRenderTarget(this.progressiveLightMap2),this.renderer.clear(),this.renderer.setRenderTarget(null),this.renderer.setClearColor(this.clearColor,this.clearAlpha),this.lights=[],this.meshes=[],this.scene.traverse((e=>{!function(e){return!!e.geometry}(e)?function(e){return e.isLight}(e)&&this.lights.push({object:e,intensity:e.intensity}):this.meshes.push({object:e,material:e.material})}))}prepare(){this.lights.forEach((e=>e.object.intensity=0)),this.meshes.forEach((e=>e.object.material=this.discardMat))}finish(){this.lights.forEach((e=>e.object.intensity=e.intensity)),this.meshes.forEach((e=>e.object.material=e.material))}configure(e){this.object=e}update(e,t=100){if(!this.object)return;this.averagingWindow.value=t,this.object.material=this.targetMat;const n=this.buffer1Active?this.progressiveLightMap1:this.progressiveLightMap2,r=this.buffer1Active?this.progressiveLightMap2:this.progressiveLightMap1,i=this.scene.background;this.scene.background=null,this.renderer.setRenderTarget(n),this.previousShadowMap.value=r.texture,this.buffer1Active=!this.buffer1Active,this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.scene.background=i}}const vy={rembrandt:{main:[1,2,1],fill:[-2,-.5,-2]},portrait:{main:[-1,2,.5],fill:[-1,.5,-1.5]},upfront:{main:[0,2,1],fill:[-1,.5,-1.5]},soft:{main:[-2,4,4],fill:[-1,.5,-1.5]}};function yy({radius:e,adjustCamera:t}){const n=Iv();return i.useEffect((()=>{t&&n.refresh().clip().fit()}),[e,t]),null}function Ey({children:e,center:t,adjustCamera:n=!0,intensity:s=.5,shadows:a="contact",environment:o="city",preset:l="rembrandt",...c}){var h,u,d,f,A,m,p,g;const v="string"==typeof l?vy[l]:l,[{radius:y,height:E},x]=i.useState({radius:0,width:0,height:0,depth:0}),C=null!==(h=null==a?void 0:a.bias)&&void 0!==h?h:-1e-4,w=null!==(u=null==a?void 0:a.normalBias)&&void 0!==u?u:0,I=null!==(d=null==a?void 0:a.size)&&void 0!==d?d:1024,b=null!==(f=null==a?void 0:a.offset)&&void 0!==f?f:0,S="contact"===a||"contact"===(null==a?void 0:a.type),B="accumulative"===a||"accumulative"===(null==a?void 0:a.type),T={..."object"==typeof a?a:{}},_=o?"string"==typeof o?{preset:o}:o:null,M=i.useCallback((e=>{const{width:n,height:r,depth:i,boundingSphere:s}=e;x({radius:s.radius,width:n,height:r,depth:i}),null!=t&&t.onCentered&&t.onCentered(e)}),[]);return i.createElement(i.Fragment,null,i.createElement("ambientLight",{intensity:s/3}),i.createElement("spotLight",{penumbra:1,position:[v.main[0]*y,v.main[1]*y,v.main[2]*y],intensity:2*s,castShadow:!!a,"shadow-bias":C,"shadow-normalBias":w,"shadow-mapSize":I}),i.createElement("pointLight",{position:[v.fill[0]*y,v.fill[1]*y,v.fill[2]*y],intensity:s}),i.createElement(wv,(0,r.A)({fit:!!n,clip:!!n,margin:Number(n),observe:!0},c),i.createElement(yy,{radius:y,adjustCamera:n}),i.createElement(Hp,(0,r.A)({},t,{position:[0,b/2,0],onCentered:M}),e)),i.createElement("group",{position:[0,-E/2-b/2,0]},S&&i.createElement(dy,(0,r.A)({scale:4*y,far:y,blur:2},T)),B&&i.createElement(my,(0,r.A)({temporal:!0,frames:100,alphaTest:.9,toneMapped:!0,scale:4*y},T),i.createElement(py,{amount:null!==(A=T.amount)&&void 0!==A?A:8,radius:null!==(m=T.radius)&&void 0!==m?m:y,ambient:null!==(p=T.ambient)&&void 0!==p?p:.5,intensity:null!==(g=T.intensity)&&void 0!==g?g:1,position:[v.main[0]*y,v.main[1]*y,v.main[2]*y],size:4*y,bias:-C,mapSize:I}))),o&&i.createElement(cy,_))}const xy=e=>0===e?0:Math.pow(2,10*e-10);function Cy({children:e,floor:t=.25,segments:n=20,receiveShadow:r,...s}){const a=i.useRef(null);return i.useLayoutEffect((()=>{let e=0;const r=n/n/2,i=a.current.attributes.position;for(let s=0;s<n+1;s++)for(let a=0;a<n+1;a++)i.setXYZ(e++,s/n-r+(0===s?-t:0),a/n-r,xy(s/n));i.needsUpdate=!0,a.current.computeVertexNormals()}),[n,t]),i.createElement("group",s,i.createElement("mesh",{receiveShadow:r,rotation:[-Math.PI/2,0,Math.PI/2]},i.createElement("planeGeometry",{ref:a,args:[1,1,n,n]}),e))}const wy=i.forwardRef((({fog:e=!1,renderOrder:t,depthWrite:n=!1,colorStop:s=0,color:o="black",opacity:l=.5,...c},h)=>{const u=i.useMemo((()=>{const e=document.createElement("canvas");e.width=128,e.height=128;const t=e.getContext("2d"),n=t.createRadialGradient(e.width/2,e.height/2,0,e.width/2,e.height/2,e.width/2);return n.addColorStop(s,new a.Q1f(o).getStyle()),n.addColorStop(1,"rgba(0,0,0,0)"),t.fillStyle=n,t.fillRect(0,0,e.width,e.height),e}),[o,s]);return i.createElement("mesh",(0,r.A)({renderOrder:t,ref:h,"rotation-x":-Math.PI/2},c),i.createElement("planeGeometry",null),i.createElement("meshBasicMaterial",{transparent:!0,opacity:l,fog:e,depthWrite:n,side:a.$EB},i.createElement("canvasTexture",{attach:"map",args:[u]})))}));function Iy(e=a.hB5){const t={value:new a.kn4};return Object.assign(new a.qBx({side:e}),{viewMatrix:t,onBeforeCompile:e=>{e.uniforms.viewMatrix=t,e.fragmentShader="vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n           return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n         }\n"+e.fragmentShader.replace("#include <normal_fragment_maps>","#include <normal_fragment_maps>\n           normal = inverseTransformDirection( normal, viewMatrix );\n")}})}const by=aa({causticsTexture:null,causticsTextureB:null,color:new a.Q1f,lightProjMatrix:new a.kn4,lightViewMatrix:new a.kn4},"varying vec3 vWorldPosition;\n   void main() {\n     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);\n     vec4 worldPosition = modelMatrix * vec4(position, 1.);\n     vWorldPosition = worldPosition.xyz;\n   }",`varying vec3 vWorldPosition;\n  uniform vec3 color;\n  uniform sampler2D causticsTexture;\n  uniform sampler2D causticsTextureB;\n  uniform mat4 lightProjMatrix;\n  uniform mat4 lightViewMatrix;\n   void main() {\n    // Apply caustics\n    vec4 lightSpacePos = lightProjMatrix * lightViewMatrix * vec4(vWorldPosition, 1.0);\n    lightSpacePos.xyz /= lightSpacePos.w;\n    lightSpacePos.xyz = lightSpacePos.xyz * 0.5 + 0.5;\n    vec3 front = texture2D(causticsTexture, lightSpacePos.xy).rgb;\n    vec3 back = texture2D(causticsTextureB, lightSpacePos.xy).rgb;\n    gl_FragColor = vec4((front + back) * color, 1.0);\n    #include <tonemapping_fragment>\n    #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n   }`),Sy=aa({cameraMatrixWorld:new a.kn4,cameraProjectionMatrixInv:new a.kn4,normalTexture:null,depthTexture:null,lightDir:new a.Pq0(0,1,0),lightPlaneNormal:new a.Pq0(0,1,0),lightPlaneConstant:0,near:.1,far:100,modelMatrix:new a.kn4,worldRadius:1/40,ior:1.1,bounces:0,resolution:1024,size:10,intensity:.5},"\n  varying vec2 vUv;\n  void main() {\n      vUv = uv;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  }","\n  uniform mat4 cameraMatrixWorld;\n  uniform mat4 cameraProjectionMatrixInv;\n  uniform vec3 lightDir;\n  uniform vec3 lightPlaneNormal;\n  uniform float lightPlaneConstant;\n  uniform float near;\n  uniform float far;\n  uniform float time;\n  uniform float worldRadius;\n  uniform float resolution;\n  uniform float size;\n  uniform float intensity;\n  uniform float ior;\n  precision highp isampler2D;\n  precision highp usampler2D;\n  uniform sampler2D normalTexture;\n  uniform sampler2D depthTexture;\n  uniform float bounces;\n  varying vec2 vUv;\n  vec3 WorldPosFromDepth(float depth, vec2 coord) {\n    float z = depth * 2.0 - 1.0;\n    vec4 clipSpacePosition = vec4(coord * 2.0 - 1.0, z, 1.0);\n    vec4 viewSpacePosition = cameraProjectionMatrixInv * clipSpacePosition;\n    // Perspective division\n    viewSpacePosition /= viewSpacePosition.w;\n    vec4 worldSpacePosition = cameraMatrixWorld * viewSpacePosition;\n    return worldSpacePosition.xyz;\n  }\n  float sdPlane( vec3 p, vec3 n, float h ) {\n    // n must be normalized\n    return dot(p,n) + h;\n  }\n  float planeIntersect( vec3 ro, vec3 rd, vec4 p ) {\n    return -(dot(ro,p.xyz)+p.w)/dot(rd,p.xyz);\n  }\n  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 pos, vec3 normal, float ior, out vec3 rayOrigin, out vec3 rayDirection) {\n    rayOrigin = ro;\n    rayDirection = rd;\n    rayDirection = refract(rayDirection, normal, 1.0 / ior);\n    rayOrigin = pos + rayDirection * 0.1;\n    return rayDirection;\n  }\n  void main() {\n    // Each sample consists of random offset in the x and y direction\n    float caustic = 0.0;\n    float causticTexelSize = (1.0 / resolution) * size * 2.0;\n    float texelsNeeded = worldRadius / causticTexelSize;\n    float sampleRadius = texelsNeeded / resolution;\n    float sum = 0.0;\n    if (texture2D(depthTexture, vUv).x == 1.0) {\n      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n      return;\n    }\n    vec2 offset1 = vec2(-0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);\n    vec2 offset2 = vec2(-0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);\n    vec2 offset3 = vec2(0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);\n    vec2 offset4 = vec2(0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);\n    vec2 uv1 = vUv + offset1 * sampleRadius;\n    vec2 uv2 = vUv + offset2 * sampleRadius;\n    vec2 uv3 = vUv + offset3 * sampleRadius;\n    vec2 uv4 = vUv + offset4 * sampleRadius;\n    vec3 normal1 = texture2D(normalTexture, uv1, -10.0).rgb * 2.0 - 1.0;\n    vec3 normal2 = texture2D(normalTexture, uv2, -10.0).rgb * 2.0 - 1.0;\n    vec3 normal3 = texture2D(normalTexture, uv3, -10.0).rgb * 2.0 - 1.0;\n    vec3 normal4 = texture2D(normalTexture, uv4, -10.0).rgb * 2.0 - 1.0;\n    float depth1 = texture2D(depthTexture, uv1, -10.0).x;\n    float depth2 = texture2D(depthTexture, uv2, -10.0).x;\n    float depth3 = texture2D(depthTexture, uv3, -10.0).x;\n    float depth4 = texture2D(depthTexture, uv4, -10.0).x;\n    // Sanity check the depths\n    if (depth1 == 1.0 || depth2 == 1.0 || depth3 == 1.0 || depth4 == 1.0) {\n      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n      return;\n    }\n    vec3 pos1 = WorldPosFromDepth(depth1, uv1);\n    vec3 pos2 = WorldPosFromDepth(depth2, uv2);\n    vec3 pos3 = WorldPosFromDepth(depth3, uv3);\n    vec3 pos4 = WorldPosFromDepth(depth4, uv4);\n    vec3 originPos1 = WorldPosFromDepth(0.0, uv1);\n    vec3 originPos2 = WorldPosFromDepth(0.0, uv2);\n    vec3 originPos3 = WorldPosFromDepth(0.0, uv3);\n    vec3 originPos4 = WorldPosFromDepth(0.0, uv4);\n    vec3 endPos1, endPos2, endPos3, endPos4;\n    vec3 endDir1, endDir2, endDir3, endDir4;\n    totalInternalReflection(originPos1, lightDir, pos1, normal1, ior, endPos1, endDir1);\n    totalInternalReflection(originPos2, lightDir, pos2, normal2, ior, endPos2, endDir2);\n    totalInternalReflection(originPos3, lightDir, pos3, normal3, ior, endPos3, endDir3);\n    totalInternalReflection(originPos4, lightDir, pos4, normal4, ior, endPos4, endDir4);\n    float lightPosArea = length(cross(originPos2 - originPos1, originPos3 - originPos1)) + length(cross(originPos3 - originPos1, originPos4 - originPos1));\n    float t1 = planeIntersect(endPos1, endDir1, vec4(lightPlaneNormal, lightPlaneConstant));\n    float t2 = planeIntersect(endPos2, endDir2, vec4(lightPlaneNormal, lightPlaneConstant));\n    float t3 = planeIntersect(endPos3, endDir3, vec4(lightPlaneNormal, lightPlaneConstant));\n    float t4 = planeIntersect(endPos4, endDir4, vec4(lightPlaneNormal, lightPlaneConstant));\n    vec3 finalPos1 = endPos1 + endDir1 * t1;\n    vec3 finalPos2 = endPos2 + endDir2 * t2;\n    vec3 finalPos3 = endPos3 + endDir3 * t3;\n    vec3 finalPos4 = endPos4 + endDir4 * t4;\n    float finalArea = length(cross(finalPos2 - finalPos1, finalPos3 - finalPos1)) + length(cross(finalPos3 - finalPos1, finalPos4 - finalPos1));\n    caustic += intensity * (lightPosArea / finalArea);\n    // Calculate the area of the triangle in light spaces\n    gl_FragColor = vec4(vec3(max(caustic, 0.0)), 1.0);\n  }"),By={depth:!0,minFilter:a.k6q,magFilter:a.k6q,type:a.OUM},Ty={minFilter:a.$_I,magFilter:a.k6q,type:a.RQf,generateMipmaps:!0},_y=i.forwardRef((({debug:e,children:t,frames:n=1,ior:s=1.1,color:l="white",causticsOnly:c=!1,backside:h=!1,backsideIOR:u=1.1,worldRadius:d=.3125,intensity:f=.05,resolution:A=2024,lightSource:m=[5,5,5],...p},g)=>{(0,o.e)({CausticsProjectionMaterial:by});const v=i.useRef(null),y=i.useRef(null),E=i.useRef(null),x=i.useRef(null),C=(0,o.A)((e=>e.gl)),w=Af(e&&y,a.WTh),I=vl(A,A,By),b=vl(A,A,By),S=vl(A,A,Ty),B=vl(A,A,Ty),[T]=i.useState((()=>Iy())),[_]=i.useState((()=>Iy(a.hsX))),[M]=i.useState((()=>new Sy)),[R]=i.useState((()=>new zs(M)));i.useLayoutEffect((()=>{v.current.updateWorldMatrix(!1,!0)}));let D=0;const P=new a.Pq0,L=new a.PPD,k=new a.kn4,F=new a.Zcv,O=new a.Pq0,U=new a.Pq0,Q=new a.NRn,N=new a.Pq0,z=[],G=[],H=[],q=[],Y=new a.Pq0;for(let r=0;r<8;r++)z.push(new a.Pq0),G.push(new a.Pq0),H.push(new a.Pq0),q.push(new a.Pq0);return(0,o.C)((()=>{if(n===1/0||D++<n){var t,r;Array.isArray(m)?O.fromArray(m).normalize():O.copy(v.current.worldToLocal(m.current.getWorldPosition(P)).normalize()),U.copy(O).multiplyScalar(-1),null==(t=E.current.parent)||t.matrixWorld.identity(),Q.setFromObject(E.current,!0),z[0].set(Q.min.x,Q.min.y,Q.min.z),z[1].set(Q.min.x,Q.min.y,Q.max.z),z[2].set(Q.min.x,Q.max.y,Q.min.z),z[3].set(Q.min.x,Q.max.y,Q.max.z),z[4].set(Q.max.x,Q.min.y,Q.min.z),z[5].set(Q.max.x,Q.min.y,Q.max.z),z[6].set(Q.max.x,Q.max.y,Q.min.z),z[7].set(Q.max.x,Q.max.y,Q.max.z);for(let e=0;e<8;e++)G[e].copy(z[e]);Q.getCenter(N),z.map((e=>e.sub(N)));const n=F.set(U,0);z.map(((e,t)=>n.projectPoint(e,H[t])));const i=H.reduce(((e,t)=>e.add(t)),P.set(0,0,0)).divideScalar(H.length),a=H.map((e=>e.distanceTo(i))).reduce(((e,t)=>Math.max(e,t))),o=z.map((e=>e.dot(O))).reduce(((e,t)=>Math.max(e,t)));y.current.position.copy(Y.copy(O).multiplyScalar(o).add(N)),y.current.lookAt(E.current.localToWorld(N));const l=k.lookAt(y.current.position,N,P.set(0,1,0));y.current.left=-a,y.current.right=a,y.current.top=a,y.current.bottom=-a;const p=P.set(0,a,0).applyMatrix4(l),g=(y.current.position.y+p.y)/O.y;y.current.near=.1,y.current.far=g,y.current.updateProjectionMatrix(),y.current.updateMatrixWorld();const D=G.map(((e,t)=>e.add(q[t].copy(O).multiplyScalar(-e.y/O.y)))),j=D.reduce(((e,t)=>e.add(t)),P.set(0,0,0)).divideScalar(D.length),V=2*D.map((e=>Math.hypot(e.x-j.x,e.z-j.z))).reduce(((e,t)=>Math.max(e,t)));x.current.scale.setScalar(V),x.current.position.copy(j),e&&(null==(r=w.current)||r.update()),_.viewMatrix.value=T.viewMatrix.value=y.current.matrixWorldInverse;const K=L.setFromProjectionMatrix(k.multiplyMatrices(y.current.projectionMatrix,y.current.matrixWorldInverse)).planes[4];M.cameraMatrixWorld=y.current.matrixWorld,M.cameraProjectionMatrixInv=y.current.projectionMatrixInverse,M.lightDir=U,M.lightPlaneNormal=K.normal,M.lightPlaneConstant=K.constant,M.near=y.current.near,M.far=y.current.far,M.resolution=A,M.size=a,M.intensity=f,M.worldRadius=d,E.current.visible=!0,C.setRenderTarget(I),C.clear(),E.current.overrideMaterial=T,C.render(E.current,y.current),C.setRenderTarget(b),C.clear(),h&&(E.current.overrideMaterial=_,C.render(E.current,y.current)),E.current.overrideMaterial=null,M.ior=s,x.current.material.lightProjMatrix=y.current.projectionMatrix,x.current.material.lightViewMatrix=y.current.matrixWorldInverse,M.normalTexture=I.texture,M.depthTexture=I.depthTexture,C.setRenderTarget(S),C.clear(),R.render(C),M.ior=u,M.normalTexture=b.texture,M.depthTexture=b.depthTexture,C.setRenderTarget(B),C.clear(),h&&R.render(C),C.setRenderTarget(null),c&&(E.current.visible=!1)}})),i.useImperativeHandle(g,(()=>v.current),[]),i.createElement("group",(0,r.A)({ref:v},p),i.createElement("scene",{ref:E},i.createElement("orthographicCamera",{ref:y,up:[0,1,0]}),t),i.createElement("mesh",{renderOrder:2,ref:x,"rotation-x":-Math.PI/2},i.createElement("planeGeometry",null),i.createElement("causticsProjectionMaterial",{transparent:!0,color:l,causticsTexture:S.texture,causticsTextureB:B.texture,blending:a.bCz,blendSrc:a.qad,blendDst:a.ie2,depthWrite:!1}),e&&i.createElement(pa,null,i.createElement("lineBasicMaterial",{color:"#ffff00",toneMapped:!1}))))}));class My extends a.BKk{constructor(){super({uniforms:{depth:{value:null},opacity:{value:1},attenuation:{value:2.5},anglePower:{value:12},spotPosition:{value:new a.Pq0(0,0,0)},lightColor:{value:new a.Q1f("white")},cameraNear:{value:0},cameraFar:{value:1},resolution:{value:new a.I9Y(0,0)}},transparent:!0,depthWrite:!1,vertexShader:"\n        varying vec3 vNormal;\n        varying float vViewZ;\n        varying float vIntensity;\n        uniform vec3 spotPosition;\n        uniform float attenuation;\n\n        #include <common>\n        #include <logdepthbuf_pars_vertex>\n\n        void main() {\n          // compute intensity\n          vNormal = normalize(normalMatrix * normal);\n          vec4 worldPosition = modelMatrix * vec4(position, 1);\n          vec4 viewPosition = viewMatrix * worldPosition;\n          vViewZ = viewPosition.z;\n\n          vIntensity = 1.0 - saturate(distance(worldPosition.xyz, spotPosition) / attenuation);\n\n          gl_Position = projectionMatrix * viewPosition;\n\n          #include <logdepthbuf_vertex>\n        }\n      ",fragmentShader:`\n        varying vec3 vNormal;\n        varying float vViewZ;\n        varying float vIntensity;\n\n        uniform vec3 lightColor;\n        uniform float anglePower;\n        uniform sampler2D depth;\n        uniform vec2 resolution;\n        uniform float cameraNear;\n        uniform float cameraFar;\n        uniform float opacity;\n\n        #include <packing>\n        #include <logdepthbuf_pars_fragment>\n\n        float readDepth(sampler2D depthSampler, vec2 uv) {\n          float fragCoordZ = texture(depthSampler, uv).r;\n\n          // https://github.com/mrdoob/three.js/issues/23072\n          #ifdef USE_LOGDEPTHBUF\n            float viewZ = 1.0 - exp2(fragCoordZ * log(cameraFar + 1.0) / log(2.0));\n          #else\n            float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);\n          #endif\n\n          return viewZ;\n        }\n\n        void main() {\n          #include <logdepthbuf_fragment>\n\n          vec3 normal = vec3(vNormal.x, vNormal.y, abs(vNormal.z));\n          float angleIntensity = pow(dot(normal, vec3(0, 0, 1)), anglePower);\n          float intensity = vIntensity * angleIntensity;\n\n          // fades when z is close to sampled depth, meaning the cone is intersecting existing geometry\n          bool isSoft = resolution[0] > 0.0 && resolution[1] > 0.0;\n          if (isSoft) {\n            vec2 uv = gl_FragCoord.xy / resolution;\n            intensity *= smoothstep(0.0, 1.0, vViewZ - readDepth(depth, uv));\n          }\n\n          gl_FragColor = vec4(lightColor, intensity * opacity);\n\n          #include <tonemapping_fragment>\n          #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n        }\n      `})}}var Ry="#define GLSLIFY 1\nvarying vec2 vUv;uniform sampler2D uShadowMap;uniform float uTime;void main(){vec3 color=texture2D(uShadowMap,vUv).xyz;gl_FragColor=vec4(color,1.);}";const Dy=e=>null==e?void 0:e.isSpotLight;function Py({opacity:e=1,radiusTop:t,radiusBottom:n,depthBuffer:r,color:s="white",distance:l=5,angle:c=.15,attenuation:h=5,anglePower:u=5}){const d=i.useRef(null),f=(0,o.A)((e=>e.size)),A=(0,o.A)((e=>e.camera)),m=(0,o.A)((e=>e.viewport.dpr)),[p]=i.useState((()=>new My)),[g]=i.useState((()=>new a.Pq0));t=void 0===t?.1:t,n=void 0===n?7*c:n,(0,o.C)((()=>{p.uniforms.spotPosition.value.copy(d.current.getWorldPosition(g)),d.current.lookAt(d.current.parent.target.getWorldPosition(g))}));const v=i.useMemo((()=>{const e=new a.Ho_(t,n,l,128,64,!0);return e.applyMatrix4((new a.kn4).makeTranslation(0,-l/2,0)),e.applyMatrix4((new a.kn4).makeRotationX(-Math.PI/2)),e}),[l,t,n]);return i.createElement(i.Fragment,null,i.createElement("mesh",{ref:d,geometry:v,raycast:()=>null},i.createElement("primitive",{object:p,attach:"material","uniforms-opacity-value":e,"uniforms-lightColor-value":s,"uniforms-attenuation-value":h,"uniforms-anglePower-value":u,"uniforms-depth-value":r,"uniforms-cameraNear-value":A.near,"uniforms-cameraFar-value":A.far,"uniforms-resolution-value":r?[f.width*m,f.height*m]:[0,0]})))}function Ly(e,t,n,r,s){const[[l,c]]=i.useState((()=>[new a.Pq0,new a.Pq0]));i.useLayoutEffect((()=>{if(!Dy(e.current))throw new Error("SpotlightShadow must be a child of a SpotLight");e.current.shadow.mapSize.set(n,r),e.current.shadow.needsUpdate=!0}),[e,n,r]),(0,o.C)((()=>{if(!e.current)return;const n=e.current.position,r=e.current.target.position;c.copy(r).sub(n);var i=c.length();c.normalize().multiplyScalar(i*s),l.copy(n).add(c),t.current.position.copy(l),t.current.lookAt(e.current.target.position)}))}function ky({distance:e=.4,alphaTest:t=.5,map:n,shader:r=Ry,width:s=512,height:l=512,scale:c=1,children:h,...u}){const d=i.useRef(null),f=u.spotlightRef,A=u.debug;Ly(f,d,s,l,e);const m=i.useMemo((()=>new a.nWS(s,l,{format:a.GWd,stencilBuffer:!1})),[s,l]),p=i.useRef({uShadowMap:{value:n},uTime:{value:0}});i.useEffect((()=>{p.current.uShadowMap.value=n}),[n]);const g=i.useMemo((()=>new zs(new a.BKk({uniforms:p.current,vertexShader:"\n          varying vec2 vUv;\n\n          void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          }\n          ",fragmentShader:r}))),[r]);return i.useEffect((()=>()=>{g.material.dispose(),g.dispose()}),[g]),i.useEffect((()=>()=>m.dispose()),[m]),(0,o.C)((({gl:e},t)=>{p.current.uTime.value+=t,e.setRenderTarget(m),g.render(e),e.setRenderTarget(null)})),i.createElement(i.Fragment,null,i.createElement("mesh",{ref:d,scale:c,castShadow:!0},i.createElement("planeGeometry",null),i.createElement("meshBasicMaterial",{transparent:!0,side:a.$EB,alphaTest:t,alphaMap:m.texture,"alphaMap-wrapS":a.GJx,"alphaMap-wrapT":a.GJx,opacity:A?1:0},h)))}function Fy({distance:e=.4,alphaTest:t=.5,map:n,width:r=512,height:s=512,scale:o,children:l,...c}){const h=i.useRef(null),u=c.spotlightRef,d=c.debug;return Ly(u,h,r,s,e),i.createElement(i.Fragment,null,i.createElement("mesh",{ref:h,scale:o,castShadow:!0},i.createElement("planeGeometry",null),i.createElement("meshBasicMaterial",{transparent:!0,side:a.$EB,alphaTest:t,alphaMap:n,"alphaMap-wrapS":a.GJx,"alphaMap-wrapT":a.GJx,opacity:d?1:0},l)))}function Oy(e){return e.shader?i.createElement(ky,e):i.createElement(Fy,e)}const Uy=i.forwardRef((({opacity:e=1,radiusTop:t,radiusBottom:n,depthBuffer:s,color:a="white",distance:o=5,angle:l=.15,attenuation:c=5,anglePower:h=5,volumetric:u=!0,debug:d=!1,children:f,...A},m)=>{const p=i.useRef(null);return i.useImperativeHandle(m,(()=>p.current),[]),i.createElement("group",null,d&&p.current&&i.createElement("spotLightHelper",{args:[p.current]}),i.createElement("spotLight",(0,r.A)({ref:p,angle:l,color:a,distance:o,castShadow:!0},A),u&&i.createElement(Py,{debug:d,opacity:e,radiusTop:t,radiusBottom:n,depthBuffer:s,color:a,distance:o,angle:l,attenuation:c,anglePower:h})),f&&i.cloneElement(f,{spotlightRef:p,debug:d}))})),Qy=i.forwardRef((({light:e,args:t,map:n,toneMapped:s=!1,color:l="white",form:c="rect",intensity:h=1,scale:u=1,target:d=[0,0,0],children:f,...A},m)=>{const p=i.useRef(null);return i.useImperativeHandle(m,(()=>p.current),[]),i.useLayoutEffect((()=>{f||A.material||((0,o.q)(p.current.material,{color:l}),p.current.material.color.multiplyScalar(h))}),[l,h,f,A.material]),i.useLayoutEffect((()=>{A.rotation||p.current.quaternion.identity(),d&&!A.rotation&&("boolean"==typeof d?p.current.lookAt(0,0,0):p.current.lookAt(Array.isArray(d)?new a.Pq0(...d):d))}),[d,A.rotation]),u=Array.isArray(u)&&2===u.length?[u[0],u[1],1]:u,i.createElement("mesh",(0,r.A)({ref:p,scale:u},A),"circle"===c?i.createElement("ringGeometry",{args:t||[0,.5,64]}):"ring"===c?i.createElement("ringGeometry",{args:t||[.25,.5,64]}):"rect"===c||"plane"===c?i.createElement("planeGeometry",{args:t||[1,1]}):"box"===c?i.createElement("boxGeometry",{args:t||[1,1,1]}):i.createElement(c,{args:t}),f||i.createElement("meshBasicMaterial",{toneMapped:s,map:n,side:a.$EB}),e&&i.createElement("pointLight",(0,r.A)({castShadow:!0},e)))}));var Ny=Object.defineProperty,zy=(e,t,n)=>(((e,t,n)=>{t in e?Ny(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Gy=(()=>{const e={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new a.Pq0},up:{value:new a.Pq0(0,1,0)}},vertexShader:"\n      uniform vec3 sunPosition;\n      uniform float rayleigh;\n      uniform float turbidity;\n      uniform float mieCoefficient;\n      uniform vec3 up;\n\n      varying vec3 vWorldPosition;\n      varying vec3 vSunDirection;\n      varying float vSunfade;\n      varying vec3 vBetaR;\n      varying vec3 vBetaM;\n      varying float vSunE;\n\n      // constants for atmospheric scattering\n      const float e = 2.71828182845904523536028747135266249775724709369995957;\n      const float pi = 3.141592653589793238462643383279502884197169;\n\n      // wavelength of used primaries, according to preetham\n      const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );\n      // this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:\n      // (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))\n      const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );\n\n      // mie stuff\n      // K coefficient for the primaries\n      const float v = 4.0;\n      const vec3 K = vec3( 0.686, 0.678, 0.666 );\n      // MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K\n      const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );\n\n      // earth shadow hack\n      // cutoffAngle = pi / 1.95;\n      const float cutoffAngle = 1.6110731556870734;\n      const float steepness = 1.5;\n      const float EE = 1000.0;\n\n      float sunIntensity( float zenithAngleCos ) {\n        zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );\n        return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );\n      }\n\n      vec3 totalMie( float T ) {\n        float c = ( 0.2 * T ) * 10E-18;\n        return 0.434 * c * MieConst;\n      }\n\n      void main() {\n\n        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n        vWorldPosition = worldPosition.xyz;\n\n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        gl_Position.z = gl_Position.w; // set z to camera.far\n\n        vSunDirection = normalize( sunPosition );\n\n        vSunE = sunIntensity( dot( vSunDirection, up ) );\n\n        vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );\n\n        float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );\n\n      // extinction (absorbtion + out scattering)\n      // rayleigh coefficients\n        vBetaR = totalRayleigh * rayleighCoefficient;\n\n      // mie coefficients\n        vBetaM = totalMie( turbidity ) * mieCoefficient;\n\n      }\n    ",fragmentShader:`\n      varying vec3 vWorldPosition;\n      varying vec3 vSunDirection;\n      varying float vSunfade;\n      varying vec3 vBetaR;\n      varying vec3 vBetaM;\n      varying float vSunE;\n\n      uniform float mieDirectionalG;\n      uniform vec3 up;\n\n      const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );\n\n      // constants for atmospheric scattering\n      const float pi = 3.141592653589793238462643383279502884197169;\n\n      const float n = 1.0003; // refractive index of air\n      const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)\n\n      // optical length at zenith for molecules\n      const float rayleighZenithLength = 8.4E3;\n      const float mieZenithLength = 1.25E3;\n      // 66 arc seconds -> degrees, and the cosine of that\n      const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;\n\n      // 3.0 / ( 16.0 * pi )\n      const float THREE_OVER_SIXTEENPI = 0.05968310365946075;\n      // 1.0 / ( 4.0 * pi )\n      const float ONE_OVER_FOURPI = 0.07957747154594767;\n\n      float rayleighPhase( float cosTheta ) {\n        return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );\n      }\n\n      float hgPhase( float cosTheta, float g ) {\n        float g2 = pow( g, 2.0 );\n        float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );\n        return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );\n      }\n\n      void main() {\n\n        vec3 direction = normalize( vWorldPosition - cameraPos );\n\n      // optical length\n      // cutoff angle at 90 to avoid singularity in next formula.\n        float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );\n        float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );\n        float sR = rayleighZenithLength * inverse;\n        float sM = mieZenithLength * inverse;\n\n      // combined extinction factor\n        vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );\n\n      // in scattering\n        float cosTheta = dot( direction, vSunDirection );\n\n        float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );\n        vec3 betaRTheta = vBetaR * rPhase;\n\n        float mPhase = hgPhase( cosTheta, mieDirectionalG );\n        vec3 betaMTheta = vBetaM * mPhase;\n\n        vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );\n        Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );\n\n      // nightsky\n        float theta = acos( direction.y ); // elevation --\x3e y-axis, [-pi/2, pi/2]\n        float phi = atan( direction.z, direction.x ); // azimuth --\x3e x-axis [-pi/2, pi/2]\n        vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );\n        vec3 L0 = vec3( 0.1 ) * Fex;\n\n      // composition + solar disc\n        float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );\n        L0 += ( vSunE * 19000.0 * Fex ) * sundisk;\n\n        vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );\n\n        vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );\n\n        gl_FragColor = vec4( retColor, 1.0 );\n\n      #include <tonemapping_fragment>\n      #include <${Sr>=154?"colorspace_fragment":"encodings_fragment"}>\n\n      }\n    `},t=new a.BKk({name:"SkyShader",fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:a.LlO.clone(e.uniforms),side:a.hsX,depthWrite:!1});class n extends a.eaF{constructor(){super(new a.iNn(1,1,1),t)}}return zy(n,"SkyShader",e),zy(n,"material",t),n})();function Hy(e,t,n=new a.Pq0){const r=Math.PI*(e-.5),i=2*Math.PI*(t-.5);return n.x=Math.cos(i),n.y=Math.sin(r),n.z=Math.sin(i),n}const qy=i.forwardRef((({inclination:e=.6,azimuth:t=.1,distance:n=1e3,mieCoefficient:s=.005,mieDirectionalG:o=.8,rayleigh:l=.5,turbidity:c=10,sunPosition:h=Hy(e,t),...u},d)=>{const f=i.useMemo((()=>(new a.Pq0).setScalar(n)),[n]),[A]=i.useState((()=>new Gy));return i.createElement("primitive",(0,r.A)({object:A,ref:d,"material-uniforms-mieCoefficient-value":s,"material-uniforms-mieDirectionalG-value":o,"material-uniforms-rayleigh-value":l,"material-uniforms-sunPosition-value":h,"material-uniforms-turbidity-value":c,scale:f},u))}));class Yy extends a.BKk{constructor(){super({uniforms:{time:{value:0},fade:{value:1}},vertexShader:"\n      uniform float time;\n      attribute float size;\n      varying vec3 vColor;\n      void main() {\n        vColor = color;\n        vec4 mvPosition = modelViewMatrix * vec4(position, 0.5);\n        gl_PointSize = size * (30.0 / -mvPosition.z) * (3.0 + sin(time + 100.0));\n        gl_Position = projectionMatrix * mvPosition;\n      }",fragmentShader:`\n      uniform sampler2D pointTexture;\n      uniform float fade;\n      varying vec3 vColor;\n      void main() {\n        float opacity = 1.0;\n        if (fade == 1.0) {\n          float d = distance(gl_PointCoord, vec2(0.5, 0.5));\n          opacity = 1.0 / (1.0 + exp(16.0 * (d - 0.25)));\n        }\n        gl_FragColor = vec4(vColor, opacity);\n\n        #include <tonemapping_fragment>\n\t      #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n      }`})}}const jy=e=>(new a.Pq0).setFromSpherical(new a.YHV(e,Math.acos(1-2*Math.random()),2*Math.random()*Math.PI)),Vy=i.forwardRef((({radius:e=100,depth:t=50,count:n=5e3,saturation:r=0,factor:s=4,fade:l=!1,speed:c=1},h)=>{const u=i.useRef(null),[d,f,A]=i.useMemo((()=>{const i=[],o=[],l=Array.from({length:n},(()=>(.5+.5*Math.random())*s)),c=new a.Q1f;let h=e+t;const u=t/n;for(let e=0;e<n;e++)h-=u*Math.random(),i.push(...jy(h).toArray()),c.setHSL(e/n,r,.9),o.push(c.r,c.g,c.b);return[new Float32Array(i),new Float32Array(o),new Float32Array(l)]}),[n,t,s,e,r]);(0,o.C)((e=>u.current&&(u.current.uniforms.time.value=e.clock.elapsedTime*c)));const[m]=i.useState((()=>new Yy));return i.createElement("points",{ref:h},i.createElement("bufferGeometry",null,i.createElement("bufferAttribute",{attach:"attributes-position",args:[d,3]}),i.createElement("bufferAttribute",{attach:"attributes-color",args:[f,3]}),i.createElement("bufferAttribute",{attach:"attributes-size",args:[A,1]})),i.createElement("primitive",{ref:u,object:m,attach:"material",blending:a.EZo,"uniforms-fade-value":l,depthWrite:!1,transparent:!0,vertexColors:!0}))})),Ky=new a.kn4,Wy=new a.Pq0,Jy=new a.PTz,Xy=new a.Pq0,$y=new a.PTz,Zy=new a.Pq0,eE=i.createContext(null),tE=i.forwardRef((({children:e,material:t=a.G_z,texture:n="https://rawcdn.githack.com/pmndrs/drei-assets/9225a9f1fbd449d9411125c2f419b843d0308c9f/cloud.png",range:s,limit:l=200,frustumCulled:c,...h},u)=>{var d,f;const A=i.useMemo((()=>class extends t{constructor(){super();const e=parseInt(a.sPf.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=t=>{t.vertexShader="attribute float cloudOpacity;\n               varying float vOpacity;\n              "+t.vertexShader.replace("#include <fog_vertex>","#include <fog_vertex>\n                 vOpacity = cloudOpacity;\n                "),t.fragmentShader="varying float vOpacity;\n              "+t.fragmentShader.replace(`#include <${e}>`,`#include <${e}>\n                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);\n                `)}}}),[t]);(0,o.e)({CloudMaterial:A});const m=i.useRef(null),p=i.useRef([]),g=i.useMemo((()=>new Float32Array(Array.from({length:l},(()=>1)))),[l]),v=i.useMemo((()=>new Float32Array(Array.from({length:l},(()=>[1,1,1])).flat())),[l]),y=la(n);let E,x=0,C=0;const w=new a.PTz,I=new a.Pq0(0,0,1),b=new a.Pq0;(0,o.C)(((e,t)=>{for(x=e.clock.elapsedTime,Ky.copy(m.current.matrixWorld).invert(),e.camera.matrixWorld.decompose(Xy,$y,Zy),C=0;C<p.current.length;C++)E=p.current[C],E.ref.current.matrixWorld.decompose(Wy,Jy,Zy),Wy.add(b.copy(E.position).applyQuaternion(Jy).multiply(Zy)),Jy.copy($y).multiply(w.setFromAxisAngle(I,E.rotation+=t*E.rotationFactor)),Zy.multiplyScalar(E.volume+(1+Math.sin(x*E.density*E.speed))/2*E.growth),E.matrix.compose(Wy,Jy,Zy).premultiply(Ky),E.dist=Wy.distanceTo(Xy);for(p.current.sort(((e,t)=>t.dist-e.dist)),C=0;C<p.current.length;C++)E=p.current[C],g[C]=E.opacity*(E.dist<E.fade-1?E.dist/E.fade:1),m.current.setMatrixAt(C,E.matrix),m.current.setColorAt(C,E.color);m.current.geometry.attributes.cloudOpacity.needsUpdate=!0,m.current.instanceMatrix.needsUpdate=!0,m.current.instanceColor&&(m.current.instanceColor.needsUpdate=!0)})),i.useLayoutEffect((()=>{const e=Math.min(l,void 0!==s?s:l,p.current.length);m.current.count=e,Yp(m.current.instanceMatrix,{start:0,count:16*e}),m.current.instanceColor&&Yp(m.current.instanceColor,{start:0,count:3*e}),Yp(m.current.geometry.attributes.cloudOpacity,{start:0,count:e})}));let S=[null!==(d=y.image.width)&&void 0!==d?d:1,null!==(f=y.image.height)&&void 0!==f?f:1];const B=Math.max(S[0],S[1]);return S=[S[0]/B,S[1]/B],i.createElement("group",(0,r.A)({ref:u},h),i.createElement(eE.Provider,{value:p},e,i.createElement("instancedMesh",{matrixAutoUpdate:!1,ref:m,args:[null,null,l],frustumCulled:c},i.createElement("instancedBufferAttribute",{usage:a.Vnu,attach:"instanceColor",args:[v,3]}),i.createElement("planeGeometry",{args:[...S]},i.createElement("instancedBufferAttribute",{usage:a.Vnu,attach:"attributes-cloudOpacity",args:[g,1]})),i.createElement("cloudMaterial",{key:t.name,map:y,transparent:!0,depthWrite:!1}))))})),nE=i.forwardRef((({opacity:e=1,speed:t=0,bounds:n=[5,1,1],segments:s=20,color:l="#ffffff",fade:c=10,volume:h=6,smallestVolume:u=.25,distribute:d=null,growth:f=4,concentrate:A="inside",seed:m=Math.random(),...p},g)=>{function v(){const e=1e4*Math.sin(m++);return e-Math.floor(e)}const y=i.useContext(eE),E=i.useRef(null),x=i.useId(),C=i.useMemo((()=>[...new Array(s)].map(((e,t)=>({segments:s,bounds:new a.Pq0(1,1,1),position:new a.Pq0,uuid:x,index:t,ref:E,dist:0,matrix:new a.kn4,color:new a.Q1f,rotation:t*(Math.PI/s)})))),[s,x]);return i.useLayoutEffect((()=>{C.forEach(((r,i)=>{(0,o.q)(r,{volume:h,color:l,speed:t,growth:f,opacity:e,fade:c,bounds:n,density:Math.max(.5,v()),rotationFactor:Math.max(.2,.5*v())*t});const a=null==d?void 0:d(r,i);var m;(a||s>1)&&r.position.copy(r.bounds).multiply(null!==(m=null==a?void 0:a.point)&&void 0!==m?m:{x:2*v()-1,y:2*v()-1,z:2*v()-1});const p=Math.abs(r.position.x),g=Math.abs(r.position.y),y=Math.abs(r.position.z),E=Math.max(p,g,y);r.length=1,p===E&&(r.length-=p/r.bounds.x),g===E&&(r.length-=g/r.bounds.y),y===E&&(r.length-=y/r.bounds.z),r.volume=(void 0!==(null==a?void 0:a.volume)?a.volume:Math.max(Math.max(0,u),"random"===A?v():"inside"===A?r.length:1-r.length))*h}))}),[A,n,c,l,e,f,h,m,s,t]),i.useLayoutEffect((()=>{const e=C;return y.current=[...y.current,...e],()=>{y.current=y.current.filter((e=>e.uuid!==x))}}),[C]),i.useImperativeHandle(g,(()=>E.current),[]),i.createElement("group",(0,r.A)({ref:E},p))})),rE=i.forwardRef(((e,t)=>i.useContext(eE)?i.createElement(nE,(0,r.A)({ref:t},e)):i.createElement(tE,null,i.createElement(nE,(0,r.A)({ref:t},e)))));class iE extends a.BKk{constructor(){super({uniforms:{time:{value:0},pixelRatio:{value:1}},vertexShader:"\n        uniform float pixelRatio;\n        uniform float time;\n        attribute float size;  \n        attribute float speed;  \n        attribute float opacity;\n        attribute vec3 noise;\n        attribute vec3 color;\n        varying vec3 vColor;\n        varying float vOpacity;\n\n        void main() {\n          vec4 modelPosition = modelMatrix * vec4(position, 1.0);\n          modelPosition.y += sin(time * speed + modelPosition.x * noise.x * 100.0) * 0.2;\n          modelPosition.z += cos(time * speed + modelPosition.x * noise.y * 100.0) * 0.2;\n          modelPosition.x += cos(time * speed + modelPosition.x * noise.z * 100.0) * 0.2;\n          vec4 viewPosition = viewMatrix * modelPosition;\n          vec4 projectionPostion = projectionMatrix * viewPosition;\n          gl_Position = projectionPostion;\n          gl_PointSize = size * 25. * pixelRatio;\n          gl_PointSize *= (1.0 / - viewPosition.z);\n          vColor = color;\n          vOpacity = opacity;\n        }\n      ",fragmentShader:`\n        varying vec3 vColor;\n        varying float vOpacity;\n        void main() {\n          float distanceToCenter = distance(gl_PointCoord, vec2(0.5));\n          float strength = 0.05 / distanceToCenter - 0.1;\n          gl_FragColor = vec4(vColor, strength * vOpacity);\n          #include <tonemapping_fragment>\n          #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n        }\n      `})}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}get pixelRatio(){return this.uniforms.pixelRatio.value}set pixelRatio(e){this.uniforms.pixelRatio.value=e}}const sE=e=>e&&e.constructor===Float32Array,aE=e=>e instanceof a.I9Y||e instanceof a.Pq0||e instanceof a.IUQ,oE=e=>Array.isArray(e)?e:aE(e)?e.toArray():[e,e,e];function lE(e,t,n){return i.useMemo((()=>{if(void 0!==t){if(sE(t))return t;if(t instanceof a.Q1f){const n=Array.from({length:3*e},(()=>(e=>[e.r,e.g,e.b])(t))).flat();return Float32Array.from(n)}if(aE(t)||Array.isArray(t)){const n=Array.from({length:3*e},(()=>oE(t))).flat();return Float32Array.from(n)}return Float32Array.from({length:e},(()=>t))}return Float32Array.from({length:e},n)}),[t])}const cE=i.forwardRef((({noise:e=1,count:t=100,speed:n=1,opacity:s=1,scale:l=1,size:c,color:h,children:u,...d},f)=>{i.useMemo((()=>(0,o.e)({SparklesImplMaterial:iE})),[]);const A=i.useRef(null),m=(0,o.A)((e=>e.viewport.dpr)),p=oE(l),g=i.useMemo((()=>Float32Array.from(Array.from({length:t},(()=>p.map(a.cj9.randFloatSpread))).flat())),[t,...p]),v=lE(t,c,Math.random),y=lE(t,s),E=lE(t,n),x=lE(3*t,e),C=lE(void 0===h?3*t:t,sE(h)?h:new a.Q1f(h),(()=>1));return(0,o.C)((e=>{A.current&&A.current.material&&(A.current.material.time=e.clock.elapsedTime)})),i.useImperativeHandle(f,(()=>A.current),[]),i.createElement("points",(0,r.A)({key:`particle-${t}-${JSON.stringify(l)}`},d,{ref:A}),i.createElement("bufferGeometry",null,i.createElement("bufferAttribute",{attach:"attributes-position",args:[g,3]}),i.createElement("bufferAttribute",{attach:"attributes-size",args:[v,1]}),i.createElement("bufferAttribute",{attach:"attributes-opacity",args:[y,1]}),i.createElement("bufferAttribute",{attach:"attributes-speed",args:[E,1]}),i.createElement("bufferAttribute",{attach:"attributes-color",args:[C,3]}),i.createElement("bufferAttribute",{attach:"attributes-noise",args:[x,3]})),u||i.createElement("sparklesImplMaterial",{transparent:!0,pixelRatio:m,depthWrite:!1}))}));const hE="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/matcaps.json",uE="https://rawcdn.githack.com/emmelleppi/matcaps/9b36ccaaf0a24881a39062d05566c9e92be4aa0d";function dE(e=0,t=1024,n){const r=(0,Cs.DY)((()=>fetch(hE).then((e=>e.json()))),["matcapList"]),s=r[0],a=i.useMemo((()=>Object.keys(r).length),[]),o=`${i.useMemo((()=>"string"==typeof e?e:"number"==typeof e?r[e]:null),[e])||s}${function(e){switch(e){case 64:return"-64px";case 128:return"-128px";case 256:return"-256px";case 512:return"-512px";default:return""}}(t)}.png`,l=`${uE}/${t}/${o}`;return[la(l,n),l,a]}const fE=({children:e,id:t,format:n,onLoad:r})=>{const s=dE(t,n,r);return i.createElement(i.Fragment,null,null==e?void 0:e(s))},AE="https://rawcdn.githack.com/pmndrs/drei-assets/7a3104997e1576f83472829815b00880d88b32fb",mE="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/normals/normals.json";function pE(e=0,t={},n){const{repeat:r=[1,1],anisotropy:s=1,offset:o=[0,0]}=t,l=(0,Cs.DY)((()=>fetch(mE).then((e=>e.json()))),["normalsList"]),c=i.useMemo((()=>Object.keys(l).length),[]),h=l[0],u=l[e]||h,d=`${AE}/normals/${u}`,f=la(d,n);return i.useLayoutEffect((()=>{f&&(f.wrapS=f.wrapT=a.GJx,f.repeat=new a.I9Y(r[0],r[1]),f.offset=new a.I9Y(o[0],o[1]),f.anisotropy=s)}),[f,s,r,o]),[f,d,c]}const gE=({children:e,id:t,onLoad:n,...r})=>{const s=pE(t,r,n);return i.createElement(i.Fragment,null,null==e?void 0:e(s))},vE={uniforms:{strokeOpacity:1,fillOpacity:.25,fillMix:0,thickness:.05,colorBackfaces:!1,dashInvert:!0,dash:!1,dashRepeats:4,dashLength:.5,squeeze:!1,squeezeMin:.2,squeezeMax:1,stroke:new a.Q1f("#ff0000"),backfaceStroke:new a.Q1f("#0000ff"),fill:new a.Q1f("#00ff00")},vertex:"\n\t  attribute vec3 barycentric;\n\t\n\t\tvarying vec3 v_edges_Barycentric;\n\t\tvarying vec3 v_edges_Position;\n\n\t\tvoid initWireframe() {\n\t\t\tv_edges_Barycentric = barycentric;\n\t\t\tv_edges_Position = position.xyz;\n\t\t}\n\t  ",fragment:"\n\t\t#ifndef PI\n\t  \t#define PI 3.1415926535897932384626433832795\n\t\t#endif\n  \n\t  varying vec3 v_edges_Barycentric;\n\t  varying vec3 v_edges_Position;\n  \n\t  uniform float strokeOpacity;\n\t  uniform float fillOpacity;\n\t  uniform float fillMix;\n\t  uniform float thickness;\n\t  uniform bool colorBackfaces;\n  \n\t  // Dash\n\t  uniform bool dashInvert;\n\t  uniform bool dash;\n\t  uniform bool dashOnly;\n\t  uniform float dashRepeats;\n\t  uniform float dashLength;\n  \n\t  // Squeeze\n\t  uniform bool squeeze;\n\t  uniform float squeezeMin;\n\t  uniform float squeezeMax;\n  \n\t  // Colors\n\t  uniform vec3 stroke;\n\t  uniform vec3 backfaceStroke;\n\t  uniform vec3 fill;\n  \n\t  // This is like\n\t  float wireframe_aastep(float threshold, float dist) {\n\t\t  float afwidth = fwidth(dist) * 0.5;\n\t\t  return smoothstep(threshold - afwidth, threshold + afwidth, dist);\n\t  }\n  \n\t  float wireframe_map(float value, float min1, float max1, float min2, float max2) {\n\t\t  return min2 + (value - min1) * (max2 - min2) / (max1 - min1);\n\t  }\n  \n\t  float getWireframe() {\n\t\t\tvec3 barycentric = v_edges_Barycentric;\n\t\t\n\t\t\t// Distance from center of each triangle to its edges.\n\t\t\tfloat d = min(min(barycentric.x, barycentric.y), barycentric.z);\n\n\t\t\t// for dashed rendering, we can use this to get the 0 .. 1 value of the line length\n\t\t\tfloat positionAlong = max(barycentric.x, barycentric.y);\n\t\t\tif (barycentric.y < barycentric.x && barycentric.y < barycentric.z) {\n\t\t\t\tpositionAlong = 1.0 - positionAlong;\n\t\t\t}\n\n\t\t\t// the thickness of the stroke\n\t\t\tfloat computedThickness = wireframe_map(thickness, 0.0, 1.0, 0.0, 0.34);\n\n\t\t\t// if we want to shrink the thickness toward the center of the line segment\n\t\t\tif (squeeze) {\n\t\t\t\tcomputedThickness *= mix(squeezeMin, squeezeMax, (1.0 - sin(positionAlong * PI)));\n\t\t\t}\n\n\t\t\t// Create dash pattern\n\t\t\tif (dash) {\n\t\t\t\t// here we offset the stroke position depending on whether it\n\t\t\t\t// should overlap or not\n\t\t\t\tfloat offset = 1.0 / dashRepeats * dashLength / 2.0;\n\t\t\t\tif (!dashInvert) {\n\t\t\t\t\toffset += 1.0 / dashRepeats / 2.0;\n\t\t\t\t}\n\n\t\t\t\t// if we should animate the dash or not\n\t\t\t\t// if (dashAnimate) {\n\t\t\t\t// \toffset += time * 0.22;\n\t\t\t\t// }\n\n\t\t\t\t// create the repeating dash pattern\n\t\t\t\tfloat pattern = fract((positionAlong + offset) * dashRepeats);\n\t\t\t\tcomputedThickness *= 1.0 - wireframe_aastep(dashLength, pattern);\n\t\t\t}\n\n\t\t\t// compute the anti-aliased stroke edge  \n\t\t\tfloat edge = 1.0 - wireframe_aastep(computedThickness, d);\n\n\t\t\treturn edge;\n\t  }\n\t  "},yE=aa(vE.uniforms,vE.vertex+"\n  \tvoid main() {\n\t\tinitWireframe();\n\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t}\n  ",vE.fragment+"\n  void main () {\n\t\t// Compute color\n\n\t\tfloat edge = getWireframe();\n\t\tvec4 colorStroke = vec4(stroke, edge);\n\n\t\t#ifdef FLIP_SIDED\n\t\t\tcolorStroke.rgb = backfaceStroke;\n\t\t#endif\n    \n\t\tvec4 colorFill = vec4(fill, fillOpacity);\n\t\tvec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);\n\n\t\tgl_FragColor = outColor;\n\t}\n  ");function EE(e){return void 0!==(null==e?void 0:e.current)}function xE(e){return"WireframeGeometry"===e.type}function CE(e){const t=null!=(n=e)&&n.current?e.current:e;var n;if(function(e){return!(null==e||!e.isBufferGeometry)}(t))return t;{if(xE(t))throw new Error("Wireframe: WireframeGeometry is not supported.");const e=t.parent;if(function(e){return!(null==e||!e.geometry)}(e)){if(xE(e.geometry))throw new Error("Wireframe: WireframeGeometry is not supported.");return e.geometry}}}function wE(e,t){if(e.index){console.warn("Wireframe: Requires non-indexed geometry, converting to non-indexed geometry.");const t=e.toNonIndexed();e.copy(t),e.setIndex(null)}const n=function(e,t){const n=e.getAttribute("position").count,r=[];for(let i=0;i<n;i++){const e=t?1:0;i%2==0?r.push(0,0,1,0,1,0,1,0,e):r.push(0,1,0,0,0,1,1,0,e)}return new a.THS(Float32Array.from(r),3)}(e,t);e.setAttribute("barycentric",n)}function IE({geometry:e,simplify:t=!1,...n}){(0,o.e)({MeshWireframeMaterial:yE});const[s,l]=i.useState(null);i.useLayoutEffect((()=>{const n=CE(e);if(!n)throw new Error("Wireframe: geometry prop must be a BufferGeometry or a ref to a BufferGeometry.");wE(n,t),EE(e)&&l(n)}),[t,e]);const c=EE(e)?s:e;return i.createElement(i.Fragment,null,c&&i.createElement("mesh",{geometry:c},i.createElement("meshWireframeMaterial",(0,r.A)({attach:"material",transparent:!0,side:a.$EB,polygonOffset:!0,polygonOffsetFactor:-4},n,{extensions:{derivatives:!0,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1}}))))}function bE({simplify:e=!1,...t}){const n=i.useRef(null),r=i.useMemo((()=>function(){const e={};for(const t in vE.uniforms)e[t]={value:vE.uniforms[t]};return e}()),[vE.uniforms]);return function(e,t){i.useEffect((()=>{var n;e.fillOpacity.value=null!==(n=t.fillOpacity)&&void 0!==n?n:e.fillOpacity.value}),[t.fillOpacity]),i.useEffect((()=>{var n;e.fillMix.value=null!==(n=t.fillMix)&&void 0!==n?n:e.fillMix.value}),[t.fillMix]),i.useEffect((()=>{var n;e.strokeOpacity.value=null!==(n=t.strokeOpacity)&&void 0!==n?n:e.strokeOpacity.value}),[t.strokeOpacity]),i.useEffect((()=>{var n;e.thickness.value=null!==(n=t.thickness)&&void 0!==n?n:e.thickness.value}),[t.thickness]),i.useEffect((()=>{e.colorBackfaces.value=!!t.colorBackfaces}),[t.colorBackfaces]),i.useEffect((()=>{e.dash.value=!!t.dash}),[t.dash]),i.useEffect((()=>{e.dashInvert.value=!!t.dashInvert}),[t.dashInvert]),i.useEffect((()=>{var n;e.dashRepeats.value=null!==(n=t.dashRepeats)&&void 0!==n?n:e.dashRepeats.value}),[t.dashRepeats]),i.useEffect((()=>{var n;e.dashLength.value=null!==(n=t.dashLength)&&void 0!==n?n:e.dashLength.value}),[t.dashLength]),i.useEffect((()=>{e.squeeze.value=!!t.squeeze}),[t.squeeze]),i.useEffect((()=>{var n;e.squeezeMin.value=null!==(n=t.squeezeMin)&&void 0!==n?n:e.squeezeMin.value}),[t.squeezeMin]),i.useEffect((()=>{var n;e.squeezeMax.value=null!==(n=t.squeezeMax)&&void 0!==n?n:e.squeezeMax.value}),[t.squeezeMax]),i.useEffect((()=>{e.stroke.value=t.stroke?new a.Q1f(t.stroke):e.stroke.value}),[t.stroke]),i.useEffect((()=>{e.fill.value=t.fill?new a.Q1f(t.fill):e.fill.value}),[t.fill]),i.useEffect((()=>{e.backfaceStroke.value=t.backfaceStroke?new a.Q1f(t.backfaceStroke):e.backfaceStroke.value}),[t.backfaceStroke])}(r,t),i.useLayoutEffect((()=>{const t=CE(n);if(!t)throw new Error("Wireframe: Must be a child of a Mesh, Line or Points object or specify a geometry prop.");const r=t.clone();return wE(t,e),()=>{t.copy(r),r.dispose()}}),[e]),i.useLayoutEffect((()=>{const e=n.current.parent,t=e.material.clone();return function(e,t){e.onBeforeCompile=e=>{e.uniforms={...e.uniforms,...t},e.vertexShader=e.vertexShader.replace("void main() {",`\n\t\t  ${vE.vertex}\n\t\t  void main() {\n\t\t\tinitWireframe();\n\t\t`),e.fragmentShader=e.fragmentShader.replace("void main() {",`\n\t\t  ${vE.fragment}\n\t\t  void main() {\n\t\t`),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n\t\t  #include <color_fragment>\n\t\t\t  float edge = getWireframe();\n\t\t  vec4 colorStroke = vec4(stroke, edge);\n\t\t  #ifdef FLIP_SIDED\n\t\t\tcolorStroke.rgb = backfaceStroke;\n\t\t  #endif\n\t\t  vec4 colorFill = vec4(mix(diffuseColor.rgb, fill, fillMix), mix(diffuseColor.a, fillOpacity, fillMix));\n\t\t  vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);\n\n\t\t  diffuseColor.rgb = outColor.rgb;\n\t\t  diffuseColor.a *= outColor.a;\n\t\t")},e.side=a.$EB,e.transparent=!0}(e.material,r),()=>{e.material.dispose(),e.material=t}}),[]),i.createElement("object3D",{ref:n})}function SE({geometry:e,...t}){return e?i.createElement(IE,(0,r.A)({geometry:e},t)):i.createElement(bE,t)}function BE({opacity:e,alphaMap:t}){const n=i.useRef(null),r=i.useRef(null),s=i.useRef({value:1}),l=i.useRef({value:null}),c=i.useRef({value:!1});return i.useLayoutEffect((()=>{n.current.onBeforeCompile=r.current.onBeforeCompile=e=>{const t=e.fragmentShader.indexOf("void main");let n,r="",i=t;for(;"\n"!==n&&i<t+100;)n=e.fragmentShader.charAt(i),r+=n,i++;r=r.trim(),e.vertexShader=e.vertexShader.replace("void main() {","\n        varying vec2 custom_vUv;\n\n        void main() {\n          custom_vUv = uv;\n          \n        "),e.fragmentShader=e.fragmentShader.replace(r,"\n          uniform float uShadowOpacity;\n          uniform sampler2D uAlphaMap;\n          uniform bool uHasAlphaMap;\n\n          varying vec2 custom_vUv;\n  \n          float bayerDither2x2( vec2 v ) {\n            return mod( 3.0 * v.y + 2.0 * v.x, 4.0 );\n          }\n    \n          float bayerDither4x4( vec2 v ) {\n            vec2 P1 = mod( v, 2.0 );\n            vec2 P2 = mod( floor( 0.5  * v ), 2.0 );\n            return 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );\n          }\n  \n          void main() {\n            float alpha = \n              uHasAlphaMap ? \n                uShadowOpacity * texture2D(uAlphaMap, custom_vUv).x\n              : uShadowOpacity;\n\n            if( ( bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) ) ) / 16.0 >= alpha ) discard;\n            \n          "),e.uniforms.uShadowOpacity=s.current,e.uniforms.uAlphaMap=l.current,e.uniforms.uHasAlphaMap=c.current}}),[]),(0,o.C)((()=>{var r;const i=null==(r=n.current.__r3f)||null==(r=r.parent)?void 0:r.object;if(i){const n=i.material;n&&(s.current.value=null!=e?e:n.opacity,!1===t?(l.current.value=null,c.current.value=!1):(l.current.value=t||n.alphaMap,c.current.value=!!l.current.value))}})),i.createElement(i.Fragment,null,i.createElement("meshDepthMaterial",{ref:n,attach:"customDepthMaterial",depthPacking:a.N5j}),i.createElement("meshDistanceMaterial",{ref:r,attach:"customDistanceMaterial"}))}const TE=new a.kn4,_E=new a.RlV,ME=new a.iyt,RE=new a.Pq0;class DE extends a.YJl{constructor(){super(),this.size=0,this.color=new a.Q1f("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return null==(e=this.instance.current)?void 0:e.geometry}raycast(e,t){var n,r;const i=this.instance.current;if(!i||!i.geometry)return;const s=i.userData.instances.indexOf(this.instanceKey);if(-1===s||s>i.geometry.drawRange.count)return;const o=null!==(n=null==(r=e.params.Points)?void 0:r.threshold)&&void 0!==n?n:1;if(ME.set(this.getWorldPosition(RE),o),!1===e.ray.intersectsSphere(ME))return;TE.copy(i.matrixWorld).invert(),_E.copy(e.ray).applyMatrix4(TE);const l=o/((this.scale.x+this.scale.y+this.scale.z)/3),c=l*l,h=_E.distanceSqToPoint(this.position);if(h<c){const n=new a.Pq0;_E.closestPointToPoint(this.position,n),n.applyMatrix4(this.matrixWorld);const r=e.ray.origin.distanceTo(n);if(r<e.near||r>e.far)return;t.push({distance:r,distanceToRay:Math.sqrt(h),point:n,index:s,face:null,object:this})}}}let PE,LE;const kE=i.createContext(null),FE=new a.kn4,OE=new a.Pq0,UE=i.forwardRef((({children:e,range:t,limit:n=1e3,...s},l)=>{const c=i.useRef(null);i.useImperativeHandle(l,(()=>c.current),[]);const[h,u]=i.useState([]),[[d,f,A]]=i.useState((()=>[new Float32Array(3*n),Float32Array.from({length:3*n},(()=>1)),Float32Array.from({length:n},(()=>1))]));i.useEffect((()=>{c.current.geometry.attributes.position.needsUpdate=!0})),(0,o.C)((()=>{for(c.current.updateMatrix(),c.current.updateMatrixWorld(),FE.copy(c.current.matrixWorld).invert(),c.current.geometry.drawRange.count=Math.min(n,void 0!==t?t:n,h.length),PE=0;PE<h.length;PE++)LE=h[PE].current,LE.getWorldPosition(OE).applyMatrix4(FE),OE.toArray(d,3*PE),c.current.geometry.attributes.position.needsUpdate=!0,LE.matrixWorldNeedsUpdate=!0,LE.color.toArray(f,3*PE),c.current.geometry.attributes.color.needsUpdate=!0,A.set([LE.size],PE),c.current.geometry.attributes.size.needsUpdate=!0}));const m=i.useMemo((()=>({getParent:()=>c,subscribe:e=>(u((t=>[...t,e])),()=>u((t=>t.filter((t=>t.current!==e.current)))))})),[]);return i.createElement("points",(0,r.A)({userData:{instances:h},matrixAutoUpdate:!1,ref:c,raycast:()=>null},s),i.createElement("bufferGeometry",null,i.createElement("bufferAttribute",{attach:"attributes-position",args:[d,3],usage:a.Vnu}),i.createElement("bufferAttribute",{attach:"attributes-color",args:[f,3],usage:a.Vnu}),i.createElement("bufferAttribute",{attach:"attributes-size",args:[A,1],usage:a.Vnu})),i.createElement(kE.Provider,{value:m},e))})),QE=i.forwardRef((({children:e,...t},n)=>{i.useMemo((()=>(0,o.e)({PositionPoint:DE})),[]);const s=i.useRef(null);i.useImperativeHandle(n,(()=>s.current),[]);const{subscribe:a,getParent:l}=i.useContext(kE);return i.useLayoutEffect((()=>a(s)),[]),i.createElement("positionPoint",(0,r.A)({instance:l(),instanceKey:s,ref:s},t),e)})),NE=i.forwardRef((({children:e,positions:t,colors:n,sizes:s,stride:l=3,...c},h)=>{const u=i.useRef(null);return i.useImperativeHandle(h,(()=>u.current),[]),(0,o.C)((()=>{const e=u.current.geometry.attributes;e.position.needsUpdate=!0,n&&(e.color.needsUpdate=!0),s&&(e.size.needsUpdate=!0)})),i.createElement("points",(0,r.A)({ref:u},c),i.createElement("bufferGeometry",null,i.createElement("bufferAttribute",{attach:"attributes-position",args:[t,l],usage:a.Vnu}),n&&i.createElement("bufferAttribute",{attach:"attributes-color",args:[n,l],count:n.length/l,usage:a.Vnu}),s&&i.createElement("bufferAttribute",{attach:"attributes-size",args:[s,1],count:s.length/l,usage:a.Vnu})),e)})),zE=i.forwardRef(((e,t)=>e.positions instanceof Float32Array?i.createElement(NE,(0,r.A)({},e,{ref:t})):i.createElement(UE,(0,r.A)({},e,{ref:t})))),GE=i.createContext(null),HE=i.forwardRef(((e,t)=>{i.useMemo((()=>(0,o.e)({SegmentObject:qE})),[]);const{limit:n=1e3,lineWidth:s=1,children:l,...c}=e,[h,u]=i.useState([]),[d]=i.useState((()=>new Vr)),[f]=i.useState((()=>new Br)),[A]=i.useState((()=>new Ir)),[m]=i.useState((()=>new a.I9Y(512,512))),[p]=i.useState((()=>Array(6*n).fill(0))),[g]=i.useState((()=>Array(6*n).fill(0))),v=i.useMemo((()=>({subscribe:e=>(u((t=>[...t,e])),()=>u((t=>t.filter((t=>t.current!==e.current)))))})),[]);return(0,o.C)((()=>{for(let t=0;t<n;t++){var e;const n=null==(e=h[t])?void 0:e.current;n&&(p[6*t+0]=n.start.x,p[6*t+1]=n.start.y,p[6*t+2]=n.start.z,p[6*t+3]=n.end.x,p[6*t+4]=n.end.y,p[6*t+5]=n.end.z,g[6*t+0]=n.color.r,g[6*t+1]=n.color.g,g[6*t+2]=n.color.b,g[6*t+3]=n.color.r,g[6*t+4]=n.color.g,g[6*t+5]=n.color.b)}A.setColors(g),A.setPositions(p),d.computeLineDistances()})),i.createElement("primitive",{object:d,ref:t},i.createElement("primitive",{object:A,attach:"geometry"}),i.createElement("primitive",(0,r.A)({object:f,attach:"material",vertexColors:!0,resolution:m,linewidth:s},c)),i.createElement(GE.Provider,{value:v},l))}));class qE{constructor(){this.color=new a.Q1f("white"),this.start=new a.Pq0(0,0,0),this.end=new a.Pq0(0,0,0)}}const YE=e=>e instanceof a.Pq0?e:new a.Pq0(..."number"==typeof e?[e,e,e]:e),jE=i.forwardRef((({color:e,start:t,end:n},r)=>{const s=i.useContext(GE);if(!s)throw"Segment must used inside Segments component.";const a=i.useRef(null);return i.useImperativeHandle(r,(()=>a.current),[]),i.useLayoutEffect((()=>s.subscribe(a)),[]),i.createElement("segmentObject",{ref:a,color:e,start:YE(t),end:YE(n)})})),VE=i.forwardRef((({children:e,hysteresis:t=0,distances:n,...s},a)=>{const l=i.useRef(null);return i.useImperativeHandle(a,(()=>l.current),[]),i.useLayoutEffect((()=>{const{current:e}=l;e.levels.length=0,e.children.forEach(((r,i)=>e.levels.push({object:r,hysteresis:t,distance:n[i]})))})),(0,o.C)((e=>{var t;return null==(t=l.current)?void 0:t.update(e.camera)})),i.createElement("lOD",(0,r.A)({ref:l},s),e)}));function KE({all:e,scene:t,camera:n}){const r=(0,o.A)((({gl:e})=>e)),s=(0,o.A)((({camera:e})=>e)),l=(0,o.A)((({scene:e})=>e));return i.useLayoutEffect((()=>{const i=[];e&&(t||l).traverse((e=>{!1===e.visible&&(i.push(e),e.visible=!0)})),r.compile(t||l,n||s);const o=new a.o6l(128);new a.F1T(.01,1e5,o).update(r,t||l),o.dispose(),i.forEach((e=>e.visible=!1))}),[]),null}function WE(){const e=(0,o.A)((e=>e.gl));return(0,i.useEffect)((()=>(e.shadowMap.autoUpdate=!1,e.shadowMap.needsUpdate=!0,()=>{e.shadowMap.autoUpdate=e.shadowMap.needsUpdate=!0})),[e.shadowMap]),null}const JE=new a.kn4,XE=new a.RlV,$E=new a.iyt,ZE=new a.Pq0;function ex(e,t){const n=this.geometry,r=this.material,i=this.matrixWorld;void 0!==r&&(null===n.boundingSphere&&n.computeBoundingSphere(),$E.copy(n.boundingSphere),$E.applyMatrix4(i),!1!==e.ray.intersectsSphere($E)&&(JE.copy(i).invert(),XE.copy(e.ray).applyMatrix4(JE),null!==n.boundingBox&&null===XE.intersectBox(n.boundingBox,ZE)||t.push({distance:ZE.distanceTo(e.ray.origin),point:ZE.clone(),object:this})))}function tx({pixelated:e}){const t=(0,o.A)((e=>e.gl)),n=(0,o.A)((e=>e.internal.active)),r=(0,o.A)((e=>e.performance.current)),s=(0,o.A)((e=>e.viewport.initialDpr)),a=(0,o.A)((e=>e.setDpr));return i.useEffect((()=>{const r=t.domElement;return()=>{n&&a(s),e&&r&&(r.style.imageRendering="auto")}}),[]),i.useEffect((()=>{a(r*s),e&&t.domElement&&(t.domElement.style.imageRendering=1===r?"auto":"pixelated")}),[r]),null}function nx(){const e=(0,o.A)((e=>e.get)),t=(0,o.A)((e=>e.setEvents)),n=(0,o.A)((e=>e.performance.current));return i.useEffect((()=>{const n=e().events.enabled;return()=>t({enabled:n})}),[]),i.useEffect((()=>t({enabled:1===n})),[n]),null}const rx=(0,i.createContext)(null);function ix({iterations:e=10,ms:t=250,threshold:n=.75,step:r=.1,factor:s=.5,flipflops:a=1/0,bounds:l=e=>e>100?[60,100]:[40,60],onIncline:c,onDecline:h,onChange:u,onFallback:d,children:f}){const A=Math.pow(10,0),[m,p]=(0,i.useState)((()=>({fps:0,index:0,factor:s,flipped:0,refreshrate:0,fallback:!1,frames:[],averages:[],subscriptions:new Map,subscribe:e=>{const t=Symbol();return m.subscriptions.set(t,e.current),()=>{m.subscriptions.delete(t)}}})));let g=0;return(0,o.C)((()=>{const{frames:i,averages:s}=m;if(!m.fallback&&s.length<e){i.push(performance.now());const o=i[i.length-1]-i[0];if(o>=t){if(m.fps=Math.round(i.length/o*1e3*A)/A,m.refreshrate=Math.max(m.refreshrate,m.fps),s[m.index++%e]=m.fps,s.length===e){const[t,i]=l(m.refreshrate),o=s.filter((e=>e>=i)),f=s.filter((e=>e<t));o.length>e*n&&(m.factor=Math.min(1,m.factor+r),m.flipped++,c&&c(m),m.subscriptions.forEach((e=>e.onIncline&&e.onIncline(m)))),f.length>e*n&&(m.factor=Math.max(0,m.factor-r),m.flipped++,h&&h(m),m.subscriptions.forEach((e=>e.onDecline&&e.onDecline(m)))),g!==m.factor&&(g=m.factor,u&&u(m),m.subscriptions.forEach((e=>e.onChange&&e.onChange(m)))),m.flipped>a&&!m.fallback&&(m.fallback=!0,d&&d(m),m.subscriptions.forEach((e=>e.onFallback&&e.onFallback(m)))),m.averages=[]}m.frames=[]}}})),i.createElement(rx.Provider,{value:m},f)}function sx({onIncline:e,onDecline:t,onChange:n,onFallback:r}){const s=(0,i.useContext)(rx),a=(0,i.useRef)({onIncline:e,onDecline:t,onChange:n,onFallback:r});(0,i.useLayoutEffect)((()=>{a.current.onIncline=e,a.current.onDecline=t,a.current.onChange=n,a.current.onFallback=r}),[e,t,n,r]),(0,i.useLayoutEffect)((()=>s.subscribe(a)),[s])}const ax=i.forwardRef((({children:e,compute:t,width:n,height:s,samples:l=8,renderPriority:c=0,eventPriority:h=0,frames:u=1/0,stencilBuffer:d=!1,depthBuffer:f=!0,generateMipmaps:A=!1,...m},p)=>{const{size:g,viewport:v}=(0,o.A)(),y=vl((n||g.width)*v.dpr,(s||g.height)*v.dpr,{samples:l,stencilBuffer:d,depthBuffer:f,generateMipmaps:A}),[E]=i.useState((()=>new a.Z58)),x=i.useCallback(((e,t,n)=>{var r,i;let s=null==(r=y.texture)||null==(r=r.__r3f.parent)?void 0:r.object;for(;s&&!(s instanceof a.B69);){var o;s=null==(o=s.__r3f.parent)?void 0:o.object}if(!s)return!1;n.raycaster.camera||n.events.compute(e,n,null==(i=n.previousRoot)?void 0:i.getState());const[l]=n.raycaster.intersectObject(s);if(!l)return!1;const c=l.uv;if(!c)return!1;t.raycaster.setFromCamera(t.pointer.set(2*c.x-1,2*c.y-1),t.camera)}),[]);return i.useImperativeHandle(p,(()=>y.texture),[y]),i.createElement(i.Fragment,null,(0,o.o)(i.createElement(ox,{renderPriority:c,frames:u,fbo:y},e,i.createElement("group",{onPointerOver:()=>null})),E,{events:{compute:t||x,priority:h}}),i.createElement("primitive",(0,r.A)({object:y.texture},m)))}));function ox({frames:e,renderPriority:t,children:n,fbo:r}){let s,a,l,c,h=0;return(0,o.C)((t=>{(e===1/0||h<e)&&(s=t.gl.autoClear,a=t.gl.xr.enabled,l=t.gl.getRenderTarget(),c=t.gl.xr.isPresenting,t.gl.autoClear=!0,t.gl.xr.enabled=!1,t.gl.xr.isPresenting=!1,t.gl.setRenderTarget(r),t.gl.render(t.scene,t.camera),t.gl.setRenderTarget(l),t.gl.autoClear=s,t.gl.xr.enabled=a,t.gl.xr.isPresenting=c,h++)}),t),i.createElement(i.Fragment,null,n)}const lx=i.forwardRef((({children:e,compute:t,renderPriority:n=-1,eventPriority:s=0,frames:l=1/0,stencilBuffer:c=!1,depthBuffer:h=!0,generateMipmaps:u=!1,resolution:d=896,near:f=.1,far:A=1e3,flip:m=!1,position:p,rotation:g,scale:v,quaternion:y,matrix:E,matrixAutoUpdate:x,...C},w)=>{const{size:I,viewport:b}=(0,o.A)(),S=i.useRef(null),B=i.useMemo((()=>{const e=new a.o6l(Math.max((d||I.width)*b.dpr,(d||I.height)*b.dpr),{stencilBuffer:c,depthBuffer:h,generateMipmaps:u});return e.texture.isRenderTargetTexture=!m,e.texture.flipY=!0,e.texture.type=a.ix0,e}),[d,m]);i.useEffect((()=>()=>B.dispose()),[B]);const[T]=i.useState((()=>new a.Z58));return i.useImperativeHandle(w,(()=>({scene:T,fbo:B,camera:S.current})),[B]),i.createElement(i.Fragment,null,(0,o.o)(i.createElement(cx,{renderPriority:n,frames:l,camera:S},e,i.createElement("group",{onPointerOver:()=>null})),T,{events:{compute:t,priority:s}}),i.createElement("primitive",(0,r.A)({object:B.texture},C)),i.createElement("cubeCamera",{ref:S,args:[f,A,B],position:p,rotation:g,scale:v,quaternion:y,matrix:E,matrixAutoUpdate:x}))}));function cx({frames:e,renderPriority:t,children:n,camera:r}){let s=0;return(0,o.C)((t=>{(e===1/0||s<e)&&(r.current.update(t.gl,t.scene),s++)}),t),i.createElement(i.Fragment,null,n)}const hx=i.forwardRef((({id:e=1,colorWrite:t=!1,depthWrite:n=!1,...s},o)=>{const l=i.useRef(null),c=i.useMemo((()=>({colorWrite:t,depthWrite:n,stencilWrite:!0,stencilRef:e,stencilFunc:a.sKt,stencilFail:a.kG0,stencilZFail:a.kG0,stencilZPass:a.kG0})),[e,t,n]);return i.useLayoutEffect((()=>{Object.assign(l.current.material,c)})),i.useImperativeHandle(o,(()=>l.current),[]),i.createElement("mesh",(0,r.A)({ref:l,renderOrder:-e},s))}));function ux(e,t=!1){return{stencilWrite:!0,stencilRef:e,stencilFunc:t?a.klZ:a.jsO,stencilFail:a.VVr,stencilZFail:a.VVr,stencilZPass:a.VVr}}function dx({renderPriority:e=1,zoom:t=0,segments:n=64,children:s,resolution:l=896,...c}){const h=i.useRef(null),u=i.useRef(null),{width:d,height:f}=(0,o.A)((e=>e.size)),[A]=i.useState((()=>new a.qUd));i.useLayoutEffect((()=>{A.position.set(0,0,100),A.zoom=100,A.left=d/-2,A.right=d/2,A.top=f/2,A.bottom=f/-2,A.updateProjectionMatrix()}),[d,f]);const m=Math.sqrt(d*d+f*f)/100*(.5+t/2),p=new a.Pq0,g=new a.iyt(new a.Pq0,m),v=new a.dwI,y=i.useCallback(((e,t,n)=>{t.pointer.set(e.offsetX/t.size.width*2-1,-e.offsetY/t.size.height*2+1),t.raycaster.setFromCamera(t.pointer,A),t.raycaster.ray.intersectSphere(g,p)&&(p.normalize(),v.getNormalMatrix(u.current.camera.matrixWorld),u.current.camera.getWorldPosition(t.raycaster.ray.origin),t.raycaster.ray.direction.set(0,0,1).reflect(p),t.raycaster.ray.direction.x*=-1,t.raycaster.ray.direction.applyNormalMatrix(v).multiplyScalar(-1))}),[]);return(0,o.C)((t=>{e&&t.gl.render(h.current,A)}),e),i.createElement(i.Fragment,null,i.createElement("mesh",(0,r.A)({ref:h},c,{scale:m}),i.createElement("sphereGeometry",{args:[1,n,n]}),i.createElement("meshBasicMaterial",null,i.createElement(lx,{compute:y,attach:"envMap",flip:!0,resolution:l,ref:u},s,i.createElement(fx,{api:u})))))}function fx({api:e}){const t=new a.Pq0,n=new a.PTz,r=new a.Pq0,i=new a.O9p(0,Math.PI,0);return(0,o.C)((s=>{s.camera.matrixWorld.decompose(t,n,r),e.current.camera.position.copy(t),e.current.camera.quaternion.setFromEuler(i).premultiply(n)})),null}const Ax=aa({blur:0,map:null,sdf:null,blend:0,size:0,resolution:new a.I9Y},"varying vec2 vUv;\n   void main() {\n     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n     vUv = uv;\n   }",`uniform sampler2D sdf;\n   uniform sampler2D map;\n   uniform float blur;\n   uniform float size;\n   uniform float time;\n   uniform vec2 resolution;\n   varying vec2 vUv;\n   #include <packing>\n   void main() {\n     vec2 uv = gl_FragCoord.xy / resolution.xy;\n     vec4 t = texture2D(map, uv);\n     float k = blur;\n     float d = texture2D(sdf, vUv).r/size;\n     float alpha = 1.0 - smoothstep(0.0, 1.0, clamp(d/k + 1.0, 0.0, 1.0));\n     gl_FragColor = vec4(t.rgb, blur == 0.0 ? t.a : t.a * alpha);\n     #include <tonemapping_fragment>\n     #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n   }`),mx=i.forwardRef((({children:e,events:t,blur:n=0,eventPriority:s=0,renderPriority:l=0,worldUnits:c=!1,resolution:h=512,...u},d)=>{(0,o.e)({PortalMaterialImpl:Ax});const f=i.useRef(null),{scene:A,gl:m,size:p,viewport:g,setEvents:v}=(0,o.A)(),y=vl(h,h),[E,x]=i.useState(0);(0,o.C)((()=>{const e=f.current.blend>0?Math.max(1,l):0;E!==e&&x(e)})),i.useEffect((()=>{void 0!==t&&v({enabled:!t})}),[t]);const[C,w]=i.useState(!0),I=Mp(w);i.useLayoutEffect((()=>{var e;I.current=null==(e=f.current)||null==(e=e.__r3f.parent)?void 0:e.object}),[]),i.useLayoutEffect((()=>{if(I.current&&n&&null===f.current.sdf){const e=new a.eaF(I.current.geometry,new a.V9B),t=(new a.NRn).setFromBufferAttribute(e.geometry.attributes.position),n=new a.qUd(t.min.x*(1+2/h),t.max.x*(1+2/h),t.max.y*(1+2/h),t.min.y*(1+2/h),.1,1e3);n.position.set(0,0,1),n.lookAt(0,0,0),m.setRenderTarget(y),m.render(e,n);const r=gx(h,h,m)(y.texture),i=new Float32Array(h*h);m.readRenderTargetPixels(r,0,0,h,h,i);let s=1/0;for(let a=0;a<i.length;a++)i[a]<s&&(s=i[a]);s=-s,f.current.size=s,f.current.sdf=r.texture,m.setRenderTarget(null)}}),[h,n]),i.useImperativeHandle(d,(()=>f.current));const b=i.useCallback(((e,t,n)=>{var r;if(!I.current)return!1;if(t.pointer.set(e.offsetX/t.size.width*2-1,-e.offsetY/t.size.height*2+1),t.raycaster.setFromCamera(t.pointer,t.camera),0===(null==(r=f.current)?void 0:r.blend)){const[e]=t.raycaster.intersectObject(I.current);if(!e)return t.raycaster.camera=void 0,!1}}),[]);return i.createElement("portalMaterialImpl",(0,r.A)({ref:f,blur:n,blend:0,resolution:[p.width*g.dpr,p.height*g.dpr],attach:"material"},u),i.createElement(ax,{attach:"map",frames:C?1/0:0,eventPriority:s,renderPriority:l,compute:b},e,i.createElement(px,{events:t,rootScene:A,priority:E,material:f,worldUnits:c})))}));function px({events:e,rootScene:t,material:n,priority:r,worldUnits:s}){const l=(0,o.A)((e=>e.scene)),c=(0,o.A)((e=>e.setEvents)),h=vl(),u=vl();i.useLayoutEffect((()=>{l.matrixAutoUpdate=!1}),[]),i.useEffect((()=>{void 0!==e&&c({enabled:e})}),[e]);const[d,f]=i.useMemo((()=>{const e={value:0};return[new zs(new a.BKk({uniforms:{a:{value:h.texture},b:{value:u.texture},blend:e},vertexShader:"\n          varying vec2 vUv;\n          void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n          }",fragmentShader:`\n          uniform sampler2D a;\n          uniform sampler2D b;\n          uniform float blend;\n          varying vec2 vUv;\n          #include <packing>\n          void main() {\n            vec4 ta = texture2D(a, vUv);\n            vec4 tb = texture2D(b, vUv);\n            gl_FragColor = mix(tb, ta, blend);\n            #include <tonemapping_fragment>\n            #include <${ha>=154?"colorspace_fragment":"encodings_fragment"}>\n          }`})),e]}),[]);return(0,o.C)((e=>{var i;let a=null==n||null==(i=n.current)||null==(i=i.__r3f.parent)?void 0:i.object;if(a){var o,c,A,m;if(s)l.matrixWorld.identity();else r&&1===(null==(o=n.current)?void 0:o.blend)&&a.updateWorldMatrix(!0,!1),l.matrixWorld.copy(a.matrixWorld);if(r)(null==(c=n.current)?void 0:c.blend)>0&&(null==(A=n.current)?void 0:A.blend)<1?(f.value=n.current.blend,e.gl.setRenderTarget(h),e.gl.render(l,e.camera),e.gl.setRenderTarget(u),e.gl.render(t,e.camera),e.gl.setRenderTarget(null),d.render(e.gl)):1===(null==(m=n.current)?void 0:m.blend)&&e.gl.render(l,e.camera)}}),r),i.createElement(i.Fragment,null)}const gx=(e,t,n)=>{let r=new a.nWS(e,t,{minFilter:a.$_I,magFilter:a.k6q,type:a.RQf,format:a.VT0,generateMipmaps:!0}),i=new a.nWS(e,t,{minFilter:a.hxR,magFilter:a.hxR}),s=new a.nWS(e,t,{minFilter:a.hxR,magFilter:a.hxR}),o=new a.nWS(e,t,{minFilter:a.hxR,magFilter:a.hxR}),l=new a.nWS(e,t,{minFilter:a.hxR,magFilter:a.hxR}),c=new a.nWS(e,t,{minFilter:a.hxR,magFilter:a.hxR,type:a.RQf,format:a.VT0}),h=new a.nWS(e,t,{minFilter:a.hxR,magFilter:a.hxR,type:a.RQf,format:a.VT0});const u=new zs(new a.BKk({uniforms:{tex:{value:null}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D tex;\n        varying vec2 vUv;\n        #include <packing>\n        void main() {\n          gl_FragColor = pack2HalfToRGBA(vUv * (round(texture2D(tex, vUv).x)));\n        }"})),d=new zs(new a.BKk({uniforms:{tex:{value:null}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D tex;\n        varying vec2 vUv;\n        #include <packing>\n        void main() {\n          gl_FragColor = pack2HalfToRGBA(vUv * (1.0 - round(texture2D(tex, vUv).x)));\n        }"})),f=new zs(new a.BKk({uniforms:{tex:{value:null},offset:{value:0},level:{value:0},maxSteps:{value:0}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:`\n        varying vec2 vUv;\n        uniform sampler2D tex;\n        uniform float offset;\n        uniform float level;\n        uniform float maxSteps;\n        #include <packing>\n        void main() {\n          float closestDist = 9999999.9;\n          vec2 closestPos = vec2(0.0);\n          for (float x = -1.0; x <= 1.0; x += 1.0) {\n            for (float y = -1.0; y <= 1.0; y += 1.0) {\n              vec2 voffset = vUv;\n              voffset += vec2(x, y) * vec2(${1/e}, ${1/t}) * offset;\n              vec2 pos = unpackRGBATo2Half(texture2D(tex, voffset));\n              float dist = distance(pos.xy, vUv);\n              if(pos.x != 0.0 && pos.y != 0.0 && dist < closestDist) {\n                closestDist = dist;\n                closestPos = pos;\n              }\n            }\n          }\n          gl_FragColor = pack2HalfToRGBA(closestPos);\n        }`})),A=new zs(new a.BKk({uniforms:{tex:{value:null},size:{value:new a.I9Y(e,t)}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        varying vec2 vUv;\n        uniform sampler2D tex;\n        uniform vec2 size;\n        #include <packing>\n        void main() {\n          gl_FragColor = vec4(distance(size * unpackRGBATo2Half(texture2D(tex, vUv)), size * vUv), 0.0, 0.0, 0.0);\n        }"})),m=new zs(new a.BKk({uniforms:{inside:{value:h.texture},outside:{value:c.texture},tex:{value:null}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        varying vec2 vUv;\n        uniform sampler2D inside;\n        uniform sampler2D outside;\n        uniform sampler2D tex;\n        #include <packing>\n        void main() {\n          float i = texture2D(inside, vUv).x;\n          float o =texture2D(outside, vUv).x;\n          if (texture2D(tex, vUv).x == 0.0) {\n            gl_FragColor = vec4(o, 0.0, 0.0, 0.0);\n          } else {\n            gl_FragColor = vec4(-i, 0.0, 0.0, 0.0);\n          }\n        }"}));return p=>{let g=r;p.minFilter=a.hxR,p.magFilter=a.hxR,u.material.uniforms.tex.value=p,n.setRenderTarget(i),u.render(n);const v=Math.ceil(Math.log(Math.max(e,t))/Math.log(2));let y=i,E=null;for(let e=0;e<v;e++){const t=Math.pow(2,v-e-1);E=y===i?o:i,f.material.uniforms.level.value=e,f.material.uniforms.maxSteps.value=v,f.material.uniforms.offset.value=t,f.material.uniforms.tex.value=y.texture,n.setRenderTarget(E),f.render(n),y=E}n.setRenderTarget(c),A.material.uniforms.tex.value=E.texture,A.render(n),d.material.uniforms.tex.value=p,n.setRenderTarget(s),d.render(n),y=s;for(let e=0;e<v;e++){const t=Math.pow(2,v-e-1);E=y===s?l:s,f.material.uniforms.level.value=e,f.material.uniforms.maxSteps.value=v,f.material.uniforms.offset.value=t,f.material.uniforms.tex.value=y.texture,n.setRenderTarget(E),f.render(n),y=E}return n.setRenderTarget(h),A.material.uniforms.tex.value=E.texture,A.render(n),n.setRenderTarget(g),m.material.uniforms.tex.value=p,m.render(n),n.setRenderTarget(null),g}},vx=e=>{let t;const n=new Set,r=(e,r)=>{const i="function"==typeof e?e(t):e;if(!Object.is(i,t)){const e=t;t=(null!=r?r:"object"!=typeof i||null===i)?i:Object.assign({},t,i),n.forEach((n=>n(t,e)))}},i=()=>t,s={setState:r,getState:i,getInitialState:()=>a,subscribe:e=>(n.add(e),()=>n.delete(e)),destroy:()=>{console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},a=t=e(r,i,s);return s},yx=e=>e?vx(e):vx;var Ex=n(9242);const{useDebugValue:xx}=i,{useSyncExternalStoreWithSelector:Cx}=Ex;let wx=!1;const Ix=e=>e;const bx=e=>{"function"!=typeof e&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t="function"==typeof e?yx(e):e,n=(e,n)=>function(e,t=Ix,n){n&&!wx&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),wx=!0);const r=Cx(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,n);return xx(r),r}(t,e,n);return Object.assign(n,t),n},Sx=e=>e?bx(e):bx;var Bx,Tx;const _x="undefined"!=typeof window&&(null!=(Bx=window.document)&&Bx.createElement||"ReactNative"===(null==(Tx=window.navigator)?void 0:Tx.product))?i.useLayoutEffect:i.useEffect;function Mx(){const e=Sx((e=>({current:new Array,version:0,set:e})));return{In:({children:t})=>{const n=e((e=>e.set)),r=e((e=>e.version));return _x((()=>{n((e=>({version:e.version+1})))}),[]),_x((()=>(n((({current:e})=>({current:[...e,t]}))),()=>n((({current:e})=>({current:e.filter((e=>e!==t))}))))),[t,r]),null},Out:()=>{const t=e((e=>e.current));return i.createElement(i.Fragment,null,t)}}}const Rx=new a.Q1f,Dx=Mx();function Px(e,t){const{right:n,top:r,left:i,bottom:s,width:a,height:o}=t,l=t.bottom<0||r>e.height||n<0||t.left>e.width,c=e.top+e.height-s;return{position:{width:a,height:o,left:i-e.left,top:r,bottom:c,right:n},isOffscreen:l}}function Lx(e,{left:t,bottom:n,width:r,height:i}){let s;const a=r/i;var o;return(o=e.camera)&&o.isOrthographicCamera?e.camera.manual?e.camera.updateProjectionMatrix():e.camera.left===r/-2&&e.camera.right===r/2&&e.camera.top===i/2&&e.camera.bottom===i/-2||(Object.assign(e.camera,{left:r/-2,right:r/2,top:i/2,bottom:i/-2}),e.camera.updateProjectionMatrix()):e.camera.aspect!==a&&(e.camera.aspect=a,e.camera.updateProjectionMatrix()),s=e.gl.autoClear,e.gl.autoClear=!1,e.gl.setViewport(t,n,r,i),e.gl.setScissor(t,n,r,i),e.gl.setScissorTest(!0),s}function kx(e,t){e.gl.setScissorTest(!1),e.gl.autoClear=t}function Fx(e){e.gl.getClearColor(Rx),e.gl.setClearColor(Rx,e.gl.getClearAlpha()),e.gl.clear(!0,!0)}function Ox({visible:e=!0,canvasSize:t,scene:n,index:r,children:s,frames:a,rect:l,track:c}){const h=(0,o.A)(),[u,d]=i.useState(!1);let f=0;return(0,o.C)((r=>{var i;(a===1/0||f<=a)&&(c&&(l.current=null==(i=c.current)?void 0:i.getBoundingClientRect()),f++);if(l.current){const{position:i,isOffscreen:a}=Px(t,l.current);if(u!==a&&d(a),e&&!u&&l.current){const e=Lx(r,i);r.gl.render(s?r.scene:n,r.camera),kx(r,e)}}}),r),i.useLayoutEffect((()=>{const n=l.current;if(n&&(!e||!u)){const{position:e}=Px(t,n),r=Lx(h,e);Fx(h),kx(h,r)}}),[e,u]),i.useEffect((()=>{if(!c)return;const e=l.current,n=h.get().events.connected;return h.setEvents({connected:c.current}),()=>{if(e){const{position:n}=Px(t,e),r=Lx(h,n);Fx(h),kx(h,r)}h.setEvents({connected:n})}}),[c]),i.createElement(i.Fragment,null,s,i.createElement("group",{onPointerOver:()=>null}))}const Ux=i.forwardRef((({track:e,visible:t=!0,index:n=1,id:s,style:l,className:c,frames:h=1/0,children:u,...d},f)=>{var A,m,p,g;const v=i.useRef(null),{size:y,scene:E}=(0,o.A)(),[x]=i.useState((()=>new a.Z58)),[C,w]=i.useReducer((()=>!0),!1),I=i.useCallback(((t,n)=>{if(v.current&&e&&e.current&&t.target===e.current){const{width:e,height:r,left:i,top:s}=v.current,a=t.clientX-i,o=t.clientY-s;n.pointer.set(a/e*2-1,-o/r*2+1),n.raycaster.setFromCamera(n.pointer,n.camera)}}),[v,e]);return i.useEffect((()=>{var t;e&&(v.current=null==(t=e.current)?void 0:t.getBoundingClientRect()),w()}),[e]),i.createElement("group",(0,r.A)({ref:f},d),C&&(0,o.o)(i.createElement(Ox,{visible:t,canvasSize:y,frames:h,scene:E,track:e,rect:v,index:n},u),x,{events:{compute:I,priority:n},size:{width:null==(A=v.current)?void 0:A.width,height:null==(m=v.current)?void 0:m.height,top:null==(p=v.current)?void 0:p.top,left:null==(g=v.current)?void 0:g.left}}))})),Qx=i.forwardRef((({as:e="div",id:t,visible:n,className:s,style:a,index:o=1,track:l,frames:c=1/0,children:h,...u},d)=>{const f=i.useId(),A=i.useRef(null);return i.useImperativeHandle(d,(()=>A.current)),i.createElement(i.Fragment,null,i.createElement(e,(0,r.A)({ref:A,id:t,className:s,style:a},u)),i.createElement(Dx.In,null,i.createElement(Ux,{visible:n,key:f,track:A,frames:c,index:o},h)))})),Nx=(()=>{const e=i.forwardRef(((e,t)=>i.useContext(o.p)?i.createElement(Ux,(0,r.A)({ref:t},e)):i.createElement(Qx,(0,r.A)({ref:t},e))));return e.Port=()=>i.createElement(Dx.Out,null),e})(),zx=i.createContext(null),Gx=new a.Pq0,Hx=new a.Pq0,qx=new a.Pq0(0,1,0),Yx=new a.kn4,jx=({direction:e,axis:t})=>{const{translation:n,translationLimits:r,annotations:s,annotationsClass:l,depthTest:c,scale:h,lineWidth:u,fixed:d,axisColors:f,hoveredColor:A,opacity:m,onDragStart:p,onDrag:g,onDragEnd:y,userData:E}=i.useContext(zx),x=(0,o.A)((e=>e.controls)),C=i.useRef(null),w=i.useRef(null),I=i.useRef(null),b=i.useRef(0),[S,B]=i.useState(!1),T=i.useCallback((r=>{s&&(C.current.innerText=`${n.current[t].toFixed(2)}`,C.current.style.display="block"),r.stopPropagation();const i=(new a.kn4).extractRotation(w.current.matrixWorld),o=r.point.clone(),l=(new a.Pq0).setFromMatrixPosition(w.current.matrixWorld),c=e.clone().applyMatrix4(i).normalize();I.current={clickPoint:o,dir:c},b.current=n.current[t],p({component:"Arrow",axis:t,origin:l,directions:[c]}),x&&(x.enabled=!1),r.target.setPointerCapture(r.pointerId)}),[s,e,x,p,n,t]),_=i.useCallback((e=>{if(e.stopPropagation(),S||B(!0),I.current){const{clickPoint:i,dir:a}=I.current,[o,l]=(null==r?void 0:r[t])||[void 0,void 0];let c=((e,t,n,r)=>{const i=t.dot(t),s=t.dot(e)-t.dot(n),a=t.dot(r);return 0===a?-s/i:(Gx.copy(r).multiplyScalar(i/a).sub(t),Hx.copy(r).multiplyScalar(s/a).add(n).sub(e),-Gx.dot(Hx)/Gx.dot(Gx))})(i,a,e.ray.origin,e.ray.direction);void 0!==o&&(c=Math.max(c,o-b.current)),void 0!==l&&(c=Math.min(c,l-b.current)),n.current[t]=b.current+c,s&&(C.current.innerText=`${n.current[t].toFixed(2)}`),Yx.makeTranslation(a.x*c,a.y*c,a.z*c),g(Yx)}}),[s,g,S,n,r,t]),M=i.useCallback((e=>{s&&(C.current.style.display="none"),e.stopPropagation(),I.current=null,y(),x&&(x.enabled=!0),e.target.releasePointerCapture(e.pointerId)}),[s,x,y]),R=i.useCallback((e=>{e.stopPropagation(),B(!1)}),[]),{cylinderLength:D,coneWidth:P,coneLength:L,matrixL:k}=i.useMemo((()=>{const t=d?u/h*1.6:h/20,n=d?.2:h/5,r=d?1-n:h-n,i=(new a.PTz).setFromUnitVectors(qx,e.clone().normalize());return{cylinderLength:r,coneWidth:t,coneLength:n,matrixL:(new a.kn4).makeRotationFromQuaternion(i)}}),[e,h,u,d]),F=S?A:f[t];return i.createElement("group",{ref:w},i.createElement("group",{matrix:k,matrixAutoUpdate:!1,onPointerDown:T,onPointerMove:_,onPointerUp:M,onPointerOut:R},s&&i.createElement(v,{position:[0,-L,0]},i.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:l,ref:C})),i.createElement("mesh",{visible:!1,position:[0,(D+L)/2,0],userData:E},i.createElement("cylinderGeometry",{args:[1.4*P,1.4*P,D+L,8,1]})),i.createElement(Kr,{transparent:!0,raycast:()=>null,depthTest:c,points:[0,0,0,0,D,0],lineWidth:u,side:a.$EB,color:F,opacity:m,polygonOffset:!0,renderOrder:1,polygonOffsetFactor:-10,fog:!1}),i.createElement("mesh",{raycast:()=>null,position:[0,D+L/2,0],renderOrder:500},i.createElement("coneGeometry",{args:[P,L,24,1]}),i.createElement("meshBasicMaterial",{transparent:!0,depthTest:c,color:F,opacity:m,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))))},Vx=new a.Pq0,Kx=new a.Pq0,Wx=e=>180*e/Math.PI,Jx=e=>{let t=((e,t)=>{let n=Math.floor(e/t);return n=n<0?n+1:n,e-n*t})(e,2*Math.PI);return Math.abs(t)<1e-6?0:(t<0&&(t+=2*Math.PI),t)},Xx=new a.kn4,$x=new a.Pq0,Zx=new a.RlV,eC=new a.Pq0,tC=({dir1:e,dir2:t,axis:n})=>{const{rotationLimits:r,annotations:s,annotationsClass:l,depthTest:c,scale:h,lineWidth:u,fixed:d,axisColors:f,hoveredColor:A,opacity:m,onDragStart:p,onDrag:g,onDragEnd:y,userData:E}=i.useContext(zx),x=(0,o.A)((e=>e.controls)),C=i.useRef(null),w=i.useRef(null),I=i.useRef(0),b=i.useRef(0),S=i.useRef(null),[B,T]=i.useState(!1),_=i.useCallback((e=>{s&&(C.current.innerText=`${Wx(b.current).toFixed(0)}\xba`,C.current.style.display="block"),e.stopPropagation();const t=e.point.clone(),r=(new a.Pq0).setFromMatrixPosition(w.current.matrixWorld),i=(new a.Pq0).setFromMatrixColumn(w.current.matrixWorld,0).normalize(),o=(new a.Pq0).setFromMatrixColumn(w.current.matrixWorld,1).normalize(),l=(new a.Pq0).setFromMatrixColumn(w.current.matrixWorld,2).normalize(),c=(new a.Zcv).setFromNormalAndCoplanarPoint(l,r);S.current={clickPoint:t,origin:r,e1:i,e2:o,normal:l,plane:c},p({component:"Rotator",axis:n,origin:r,directions:[i,o,l]}),x&&(x.enabled=!1),e.target.setPointerCapture(e.pointerId)}),[s,x,p,n]),M=i.useCallback((e=>{if(e.stopPropagation(),B||T(!0),S.current){const{clickPoint:t,origin:i,e1:o,e2:l,normal:c,plane:h}=S.current,[u,d]=(null==r?void 0:r[n])||[void 0,void 0];Zx.copy(e.ray),Zx.intersectPlane(h,eC),Zx.direction.negate(),Zx.intersectPlane(h,eC);let f=((e,t,n,r,i)=>{Vx.copy(e).sub(n),Kx.copy(t).sub(n);const s=r.dot(r),a=i.dot(i),o=Vx.dot(r)/s,l=Vx.dot(i)/a,c=Kx.dot(r)/s,h=Kx.dot(i)/a,u=Math.atan2(l,o);return Math.atan2(h,c)-u})(t,eC,i,o,l),A=Wx(f);e.shiftKey&&(A=10*Math.round(A/10),f=(e=>e*Math.PI/180)(A)),void 0!==u&&void 0!==d&&d-u<2*Math.PI?(f=Jx(f),f=f>Math.PI?f-2*Math.PI:f,f=a.cj9.clamp(f,u-I.current,d-I.current),b.current=I.current+f):(b.current=Jx(I.current+f),b.current=b.current>Math.PI?b.current-2*Math.PI:b.current),s&&(A=Wx(b.current),C.current.innerText=`${A.toFixed(0)}\xba`),Xx.makeRotationAxis(c,f),$x.copy(i).applyMatrix4(Xx).sub(i).negate(),Xx.setPosition($x),g(Xx)}}),[s,g,B,r,n]),R=i.useCallback((e=>{s&&(C.current.style.display="none"),e.stopPropagation(),I.current=b.current,S.current=null,y(),x&&(x.enabled=!0),e.target.releasePointerCapture(e.pointerId)}),[s,x,y]),D=i.useCallback((e=>{e.stopPropagation(),T(!1)}),[]),P=i.useMemo((()=>{const n=e.clone().normalize(),r=t.clone().normalize();return(new a.kn4).makeBasis(n,r,n.clone().cross(r))}),[e,t]),L=d?.65:.65*h,k=i.useMemo((()=>{const e=[];for(let t=0;t<=32;t++){const n=t*(Math.PI/2)/32;e.push(new a.Pq0(Math.cos(n)*L,Math.sin(n)*L,0))}return e}),[L]);return i.createElement("group",{ref:w,onPointerDown:_,onPointerMove:M,onPointerUp:R,onPointerOut:D,matrix:P,matrixAutoUpdate:!1},s&&i.createElement(v,{position:[L,L,0]},i.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:l,ref:C})),i.createElement(Kr,{points:k,lineWidth:4*u,visible:!1,userData:E}),i.createElement(Kr,{transparent:!0,raycast:()=>null,depthTest:c,points:k,lineWidth:u,side:a.$EB,color:B?A:f[n],opacity:m,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))},nC=new a.RlV,rC=new a.Pq0,iC=new a.kn4,sC=({dir1:e,dir2:t,axis:n})=>{const{translation:r,translationLimits:s,annotations:l,annotationsClass:c,depthTest:h,scale:u,lineWidth:d,fixed:f,axisColors:A,hoveredColor:m,opacity:p,onDragStart:g,onDrag:y,onDragEnd:E,userData:x}=i.useContext(zx),C=(0,o.A)((e=>e.controls)),w=i.useRef(null),I=i.useRef(null),b=i.useRef(null),S=i.useRef(0),B=i.useRef(0),[T,_]=i.useState(!1),M=i.useCallback((e=>{l&&(w.current.innerText=`${r.current[(n+1)%3].toFixed(2)}, ${r.current[(n+2)%3].toFixed(2)}`,w.current.style.display="block"),e.stopPropagation();const t=e.point.clone(),i=(new a.Pq0).setFromMatrixPosition(I.current.matrixWorld),s=(new a.Pq0).setFromMatrixColumn(I.current.matrixWorld,0).normalize(),o=(new a.Pq0).setFromMatrixColumn(I.current.matrixWorld,1).normalize(),c=(new a.Pq0).setFromMatrixColumn(I.current.matrixWorld,2).normalize(),h=(new a.Zcv).setFromNormalAndCoplanarPoint(c,i);b.current={clickPoint:t,e1:s,e2:o,plane:h},S.current=r.current[(n+1)%3],B.current=r.current[(n+2)%3],g({component:"Slider",axis:n,origin:i,directions:[s,o,c]}),C&&(C.enabled=!1),e.target.setPointerCapture(e.pointerId)}),[l,C,g,n]),R=i.useCallback((e=>{if(e.stopPropagation(),T||_(!0),b.current){const{clickPoint:t,e1:i,e2:a,plane:o}=b.current,[c,h]=(null==s?void 0:s[(n+1)%3])||[void 0,void 0],[u,d]=(null==s?void 0:s[(n+2)%3])||[void 0,void 0];nC.copy(e.ray),nC.intersectPlane(o,rC),nC.direction.negate(),nC.intersectPlane(o,rC),rC.sub(t);let[f,A]=((e,t,n)=>{const r=Math.abs(e.x)>=Math.abs(e.y)&&Math.abs(e.x)>=Math.abs(e.z)?0:Math.abs(e.y)>=Math.abs(e.x)&&Math.abs(e.y)>=Math.abs(e.z)?1:2,i=[0,1,2].sort(((e,n)=>Math.abs(t.getComponent(n))-Math.abs(t.getComponent(e)))),s=r===i[0]?i[1]:i[0],a=e.getComponent(r),o=e.getComponent(s),l=t.getComponent(r),c=t.getComponent(s),h=n.getComponent(r),u=(n.getComponent(s)-h*(o/a))/(c-l*(o/a));return[(h-u*l)/a,u]})(i,a,rC);void 0!==c&&(f=Math.max(f,c-S.current)),void 0!==h&&(f=Math.min(f,h-S.current)),void 0!==u&&(A=Math.max(A,u-B.current)),void 0!==d&&(A=Math.min(A,d-B.current)),r.current[(n+1)%3]=S.current+f,r.current[(n+2)%3]=B.current+A,l&&(w.current.innerText=`${r.current[(n+1)%3].toFixed(2)}, ${r.current[(n+2)%3].toFixed(2)}`),iC.makeTranslation(f*i.x+A*a.x,f*i.y+A*a.y,f*i.z+A*a.z),y(iC)}}),[l,y,T,r,s,n]),D=i.useCallback((e=>{l&&(w.current.style.display="none"),e.stopPropagation(),b.current=null,E(),C&&(C.enabled=!0),e.target.releasePointerCapture(e.pointerId)}),[l,C,E]),P=i.useCallback((e=>{e.stopPropagation(),_(!1)}),[]),L=i.useMemo((()=>{const n=e.clone().normalize(),r=t.clone().normalize();return(new a.kn4).makeBasis(n,r,n.clone().cross(r))}),[e,t]),k=f?1/7:u/7,F=f?.225:.225*u,O=T?m:A[n],U=i.useMemo((()=>[new a.Pq0(0,0,0),new a.Pq0(0,F,0),new a.Pq0(F,F,0),new a.Pq0(F,0,0),new a.Pq0(0,0,0)]),[F]);return i.createElement("group",{ref:I,matrix:L,matrixAutoUpdate:!1},l&&i.createElement(v,{position:[0,0,0]},i.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:c,ref:w})),i.createElement("group",{position:[1.7*k,1.7*k,0]},i.createElement("mesh",{visible:!0,onPointerDown:M,onPointerMove:R,onPointerUp:D,onPointerOut:P,scale:F,userData:x},i.createElement("planeGeometry",null),i.createElement("meshBasicMaterial",{transparent:!0,depthTest:h,color:O,polygonOffset:!0,polygonOffsetFactor:-10,side:a.$EB,fog:!1})),i.createElement(Kr,{position:[-F/2,-F/2,0],transparent:!0,depthTest:h,points:U,lineWidth:d,color:O,opacity:p,polygonOffset:!0,polygonOffsetFactor:-10,userData:x,fog:!1})))},aC=new a.Pq0,oC=new a.Pq0,lC=new a.Pq0(0,1,0),cC=new a.Pq0,hC=new a.kn4,uC=({direction:e,axis:t})=>{const{scaleLimits:n,annotations:r,annotationsClass:s,depthTest:l,scale:c,lineWidth:h,fixed:u,axisColors:d,hoveredColor:f,opacity:A,onDragStart:m,onDrag:p,onDragEnd:g,userData:y}=i.useContext(zx),E=(0,o.A)((e=>e.size)),x=(0,o.A)((e=>e.controls)),C=i.useRef(null),w=i.useRef(null),I=i.useRef(null),b=i.useRef(1),S=i.useRef(1),B=i.useRef(null),[T,_]=i.useState(!1),M=u?1.2:1.2*c,R=i.useCallback((n=>{r&&(C.current.innerText=`${S.current.toFixed(2)}`,C.current.style.display="block"),n.stopPropagation();const i=(new a.kn4).extractRotation(w.current.matrixWorld),s=n.point.clone(),o=(new a.Pq0).setFromMatrixPosition(w.current.matrixWorld),l=e.clone().applyMatrix4(i).normalize(),h=w.current.matrixWorld.clone(),d=h.clone().invert(),f=u?1/yr(w.current.getWorldPosition(aC),c,n.camera,E):1;B.current={clickPoint:s,dir:l,mPLG:h,mPLGInv:d,offsetMultiplier:f},m({component:"Sphere",axis:t,origin:o,directions:[l]}),x&&(x.enabled=!1),n.target.setPointerCapture(n.pointerId)}),[r,x,e,m,t,u,c,E]),D=i.useCallback((e=>{if(e.stopPropagation(),T||_(!0),B.current){const{clickPoint:i,dir:s,mPLG:a,mPLGInv:o,offsetMultiplier:l}=B.current,[h,d]=(null==n?void 0:n[t])||[1e-5,void 0],f=((e,t,n,r)=>{const i=t.dot(t),s=t.dot(e)-t.dot(n),a=t.dot(r);return 0===a?-s/i:(aC.copy(r).multiplyScalar(i/a).sub(t),oC.copy(r).multiplyScalar(s/a).add(n).sub(e),-aC.dot(oC)/aC.dot(aC))})(i,s,e.ray.origin,e.ray.direction),A=f*l,m=u?A:A/c;let g=Math.pow(2,.2*m);e.shiftKey&&(g=Math.round(10*g)/10),g=Math.max(g,h/b.current),void 0!==d&&(g=Math.min(g,d/b.current)),S.current=b.current*g,I.current.position.set(0,M+A,0),r&&(C.current.innerText=`${S.current.toFixed(2)}`),cC.set(1,1,1),cC.setComponent(t,g),hC.makeScale(cC.x,cC.y,cC.z).premultiply(a).multiply(o),p(hC)}}),[r,M,p,T,n,t]),P=i.useCallback((e=>{r&&(C.current.style.display="none"),e.stopPropagation(),b.current=S.current,B.current=null,I.current.position.set(0,M,0),g(),x&&(x.enabled=!0),e.target.releasePointerCapture(e.pointerId)}),[r,x,g,M]),L=i.useCallback((e=>{e.stopPropagation(),_(!1)}),[]),{radius:k,matrixL:F}=i.useMemo((()=>{const t=u?h/c*1.8:c/22.5,n=(new a.PTz).setFromUnitVectors(lC,e.clone().normalize());return{radius:t,matrixL:(new a.kn4).makeRotationFromQuaternion(n)}}),[e,c,h,u]),O=T?f:d[t];return i.createElement("group",{ref:w},i.createElement("group",{matrix:F,matrixAutoUpdate:!1,onPointerDown:R,onPointerMove:D,onPointerUp:P,onPointerOut:L},r&&i.createElement(v,{position:[0,M/2,0]},i.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:s,ref:C})),i.createElement("mesh",{ref:I,position:[0,M,0],renderOrder:500,userData:y},i.createElement("sphereGeometry",{args:[k,12,12]}),i.createElement("meshBasicMaterial",{transparent:!0,depthTest:l,color:O,opacity:A,polygonOffset:!0,polygonOffsetFactor:-10}))))},dC=new a.kn4,fC=new a.kn4,AC=new a.kn4,mC=new a.kn4,pC=new a.kn4,gC=new a.kn4,vC=new a.kn4,yC=new a.kn4,EC=new a.kn4,xC=new a.NRn,CC=new a.NRn,wC=new a.Pq0,IC=new a.Pq0,bC=new a.Pq0,SC=new a.Pq0,BC=new a.Pq0,TC=new a.Pq0(1,0,0),_C=new a.Pq0(0,1,0),MC=new a.Pq0(0,0,1),RC=i.forwardRef((({enabled:e=!0,matrix:t,onDragStart:n,onDrag:s,onDragEnd:l,autoTransform:c=!0,anchor:h,disableAxes:u=!1,disableSliders:d=!1,disableRotations:f=!1,disableScaling:A=!1,activeAxes:m=[!0,!0,!0],offset:p=[0,0,0],rotation:g=[0,0,0],scale:v=1,lineWidth:y=4,fixed:E=!1,translationLimits:x,rotationLimits:C,scaleLimits:w,depthTest:I=!0,axisColors:b=["#ff2060","#20df80","#2080ff"],hoveredColor:S="#ffff40",annotations:B=!1,annotationsClass:T,opacity:_=1,visible:M=!0,userData:R,children:D,...P},L)=>{const k=(0,o.A)((e=>e.invalidate)),F=i.useRef(null),O=i.useRef(null),U=i.useRef(null),Q=i.useRef(null),N=i.useRef([0,0,0]),z=i.useRef(new a.Pq0(1,1,1)),G=i.useRef(new a.Pq0(1,1,1));i.useLayoutEffect((()=>{h&&(Q.current.updateWorldMatrix(!0,!0),mC.copy(Q.current.matrixWorld).invert(),xC.makeEmpty(),Q.current.traverse((e=>{e.geometry&&(e.geometry.boundingBox||e.geometry.computeBoundingBox(),gC.copy(e.matrixWorld).premultiply(mC),CC.copy(e.geometry.boundingBox),CC.applyMatrix4(gC),xC.union(CC))})),wC.copy(xC.max).add(xC.min).multiplyScalar(.5),IC.copy(xC.max).sub(xC.min).multiplyScalar(.5),bC.copy(IC).multiply(new a.Pq0(...h)).add(wC),SC.set(...p).add(bC),U.current.position.copy(SC),k())}));const H=i.useMemo((()=>({onDragStart:e=>{dC.copy(O.current.matrix),fC.copy(O.current.matrixWorld),n&&n(e),k()},onDrag:e=>{AC.copy(F.current.matrixWorld),mC.copy(AC).invert(),pC.copy(fC).premultiply(e),gC.copy(pC).premultiply(mC),vC.copy(dC).invert(),yC.copy(gC).multiply(vC),c&&O.current.matrix.copy(gC),s&&s(gC,yC,pC,e),k()},onDragEnd:()=>{l&&l(),k()},translation:N,translationLimits:x,rotationLimits:C,axisColors:b,hoveredColor:S,opacity:_,scale:v,lineWidth:y,fixed:E,depthTest:I,userData:R,annotations:B,annotationsClass:T})),[n,s,l,N,x,C,w,I,v,y,E,...b,S,_,R,c,B,T]),q=new a.Pq0;return(0,o.C)((e=>{if(E){const t=yr(U.current.getWorldPosition(q),v,e.camera,e.size);z.current.setScalar(t)}t&&t instanceof a.kn4&&(O.current.matrix=t),O.current.updateWorldMatrix(!0,!0),EC.makeRotationFromEuler(U.current.rotation).setPosition(U.current.position).premultiply(O.current.matrixWorld),G.current.setFromMatrixScale(EC),BC.copy(z.current).divide(G.current),(Math.abs(U.current.scale.x-BC.x)>1e-4||Math.abs(U.current.scale.y-BC.y)>1e-4||Math.abs(U.current.scale.z-BC.z)>1e-4)&&(U.current.scale.copy(BC),e.invalidate())})),i.useImperativeHandle(L,(()=>O.current),[]),i.createElement(zx.Provider,{value:H},i.createElement("group",{ref:F},i.createElement("group",(0,r.A)({ref:O,matrix:t,matrixAutoUpdate:!1},P),i.createElement("group",{visible:M,ref:U,position:p,rotation:g},e&&i.createElement(i.Fragment,null,!u&&m[0]&&i.createElement(jx,{axis:0,direction:TC}),!u&&m[1]&&i.createElement(jx,{axis:1,direction:_C}),!u&&m[2]&&i.createElement(jx,{axis:2,direction:MC}),!d&&m[0]&&m[1]&&i.createElement(sC,{axis:2,dir1:TC,dir2:_C}),!d&&m[0]&&m[2]&&i.createElement(sC,{axis:1,dir1:MC,dir2:TC}),!d&&m[2]&&m[1]&&i.createElement(sC,{axis:0,dir1:_C,dir2:MC}),!f&&m[0]&&m[1]&&i.createElement(tC,{axis:2,dir1:TC,dir2:_C}),!f&&m[0]&&m[2]&&i.createElement(tC,{axis:1,dir1:MC,dir2:TC}),!f&&m[2]&&m[1]&&i.createElement(tC,{axis:0,dir1:_C,dir2:MC}),!A&&m[0]&&i.createElement(uC,{axis:0,direction:TC}),!A&&m[1]&&i.createElement(uC,{axis:1,direction:_C}),!A&&m[2]&&i.createElement(uC,{axis:2,direction:MC}))),i.createElement("group",{ref:Q},D))))})),DC=(0,i.forwardRef)((({options:e={video:!0},...t},n)=>{const s=(0,Cs.DY)((()=>navigator.mediaDevices.getDisplayMedia(e)),[]);return(0,i.useEffect)((()=>()=>{null==s||s.getTracks().forEach((e=>e.stop())),(0,Cs.IU)([])}),[s]),i.createElement(cf,(0,r.A)({ref:n},t,{src:s}))})),PC=(0,i.forwardRef)((({constraints:e={audio:!1,video:{facingMode:"user"}},...t},n)=>{const s=(0,Cs.DY)((()=>navigator.mediaDevices.getUserMedia(e)),[]);return(0,i.useEffect)((()=>()=>{null==s||s.getTracks().forEach((e=>e.stop())),(0,Cs.IU)([])}),[s]),i.createElement(cf,(0,r.A)({ref:n},t,{src:s}))})),LC=new a.Pq0(0,0,-1),kC=function(){const e=new a.Pq0,t=new a.Pq0,n=new a.Pq0,r=new a.Pq0,i=new a.Pq0;return function(s,a,o,l){return e.copy(s),t.copy(a),n.copy(o),r.copy(t).sub(e),i.copy(n).sub(e),l.crossVectors(i,r).normalize()}}();const FC=i.forwardRef((({points:e=QC.SAMPLE_FACELANDMARKER_RESULT.faceLandmarks[0],face:t,facialTransformationMatrix:n,faceBlendshapes:r,offset:s,offsetScalar:l=80,width:c,height:h,depth:u=1,verticalTri:d=[159,386,152],origin:f,eyes:A=!0,eyesAsOrigin:m=!1,debug:p=!1,children:g,...v},y)=>{var E;t&&(e=t.keypoints,console.warn("Facemesh `face` prop is deprecated: use `points` instead"));const x=i.useRef(null),C=i.useRef(null),w=i.useRef(null),I=i.useRef(null),b=i.useRef(null),S=i.useRef(null),B=i.useRef(null),[T]=i.useState((()=>new a.Pq0)),[_]=i.useState((()=>new a.B69)),[M]=i.useState((()=>new a.PTz)),[R]=i.useState((()=>new a.Pq0)),{invalidate:D}=(0,o.A)();i.useEffect((()=>{var e;null==(e=b.current)||e.geometry.setIndex(QC.TRIANGULATION)}),[]);const[P]=i.useState((()=>new a.Pq0));i.useEffect((()=>{var t,i;const a=null==(t=b.current)?void 0:t.geometry;if(!a)return;var o,g;(a.setFromPoints(e),a.setDrawRange(0,QC.TRIANGULATION.length),n)?(_.matrix.fromArray(n.data),_.matrix.decompose(_.position,_.quaternion,_.scale),_.rotation.y*=-1,_.rotation.z*=-1,M.setFromEuler(_.rotation),s?(_.position.y*=-1,_.position.z*=-1,null==(o=x.current)||o.position.copy(_.position.divideScalar(l))):null==(g=x.current)||g.position.set(0,0,0)):(kC(e[d[0]],e[d[1]],e[d[2]],T),M.setFromUnitVectors(LC,T));const v=M.clone().invert();if(a.computeBoundingBox(),p&&D(),a.center(),a.applyQuaternion(v),null==(i=I.current)||i.setRotationFromQuaternion(M),A)if(r){if(S.current&&B.current&&w.current)if(m){const e=S.current._computeSphere(a),t=B.current._computeSphere(a),n=function(e,t){return e.clone().add(t).multiplyScalar(.5)}(e.center,t.center);f=n.negate(),S.current._update(a,r,e),B.current._update(a,r,t)}else S.current._update(a,r),B.current._update(a,r)}else console.warn("Facemesh `eyes` option only works if `faceBlendshapes` is provided: skipping.");if(w.current){if(void 0!==f)if("number"==typeof f){const e=a.getAttribute("position");R.set(-e.getX(f),-e.getY(f),-e.getZ(f))}else f.isVector3&&R.copy(f);else R.setScalar(0);w.current.position.copy(R)}if(C.current){let e=1;(c||h||u)&&(a.boundingBox.getSize(P),c&&(e=c/P.x),h&&(e=h/P.y),u&&(e=u/P.z)),C.current.scale.setScalar(1!==e?e:1)}a.computeVertexNormals(),a.attributes.position.needsUpdate=!0}),[e,n,r,_,s,l,c,h,u,d,f,A,p,D,T,M,P,R]);const L=i.useMemo((()=>({outerRef:I,meshRef:b,eyeRightRef:S,eyeLeftRef:B})),[]);i.useImperativeHandle(y,(()=>L),[L]);const[k]=i.useState((()=>new a.Pq0)),F=null==(E=b.current)?void 0:E.geometry.boundingBox,O=(null==F?void 0:F.getSize(k).z)||1;return i.createElement("group",v,i.createElement("group",{ref:x},i.createElement("group",{ref:I},i.createElement("group",{ref:C},p?i.createElement(i.Fragment,null,i.createElement("axesHelper",{args:[O]}),i.createElement(Kr,{points:[[0,0,0],[0,0,-O]],color:65535})):null,i.createElement("group",{ref:w},A&&r&&i.createElement("group",{name:"eyes"},i.createElement(UC,{side:"left",ref:S,debug:p}),i.createElement(UC,{side:"right",ref:B,debug:p})),i.createElement("mesh",{ref:b,name:"face"},g,p?i.createElement(i.Fragment,null,F&&i.createElement("box3Helper",{args:[F]})):null))))))})),OC={contourLandmarks:{right:[33,133,159,145,153],left:[263,362,386,374,380]},blendshapes:{right:[14,16,18,12],left:[13,15,17,11]},color:{right:"red",left:"#00ff00"},fov:{horizontal:100,vertical:90}},UC=i.forwardRef((({side:e,debug:t=!0},n)=>{const r=i.useRef(null),s=i.useRef(null),[o]=i.useState((()=>new a.iyt)),l=i.useCallback((t=>{const n=t.getAttribute("position"),r=OC.contourLandmarks[e].map((e=>new a.Pq0(n.getX(e),n.getY(e),n.getZ(e))));return o.center.set(0,0,0),r.forEach((e=>o.center.add(e))),o.center.divideScalar(r.length),o.radius=r[0].sub(r[1]).length()/2,o}),[o,e]),[c]=i.useState((()=>new a.O9p)),h=i.useCallback(((t,n,i)=>{var o;r.current&&(null!==(o=i)&&void 0!==o||(i=l(t)),r.current.position.copy(i.center),r.current.scale.setScalar(i.radius));if(n&&s.current){const t=OC.blendshapes[e],r=n.categories[t[0]].score,i=n.categories[t[1]].score,o=n.categories[t[2]].score,l=n.categories[t[3]].score,h=.5*(OC.fov.horizontal*a.cj9.DEG2RAD)*(l-o),u=.5*(OC.fov.vertical*a.cj9.DEG2RAD)*(r-i)*("left"===e?1:-1);c.set(h,u,0),s.current.setRotationFromEuler(c)}}),[l,e,c]),u=i.useMemo((()=>({eyeMeshRef:r,irisDirRef:s,_computeSphere:l,_update:h})),[l,h]);i.useImperativeHandle(n,(()=>u),[u]);const d=OC.color[e];return i.createElement("group",null,i.createElement("group",{ref:r},t&&i.createElement("axesHelper",null),i.createElement("group",{ref:s},i.createElement(i.Fragment,null,t&&i.createElement(Kr,{points:[[0,0,0],[0,0,-2]],lineWidth:1,color:d})))))})),QC={TRIANGULATION:[127,34,139,11,0,37,232,231,120,72,37,39,128,121,47,232,121,128,104,69,67,175,171,148,157,154,155,118,50,101,73,39,40,9,151,108,48,115,131,194,204,211,74,40,185,80,42,183,40,92,186,230,229,118,202,212,214,83,18,17,76,61,146,160,29,30,56,157,173,106,204,194,135,214,192,203,165,98,21,71,68,51,45,4,144,24,23,77,146,91,205,50,187,201,200,18,91,106,182,90,91,181,85,84,17,206,203,36,148,171,140,92,40,39,193,189,244,159,158,28,247,246,161,236,3,196,54,68,104,193,168,8,117,228,31,189,193,55,98,97,99,126,47,100,166,79,218,155,154,26,209,49,131,135,136,150,47,126,217,223,52,53,45,51,134,211,170,140,67,69,108,43,106,91,230,119,120,226,130,247,63,53,52,238,20,242,46,70,156,78,62,96,46,53,63,143,34,227,173,155,133,123,117,111,44,125,19,236,134,51,216,206,205,154,153,22,39,37,167,200,201,208,36,142,100,57,212,202,20,60,99,28,158,157,35,226,113,160,159,27,204,202,210,113,225,46,43,202,204,62,76,77,137,123,116,41,38,72,203,129,142,64,98,240,49,102,64,41,73,74,212,216,207,42,74,184,169,170,211,170,149,176,105,66,69,122,6,168,123,147,187,96,77,90,65,55,107,89,90,180,101,100,120,63,105,104,93,137,227,15,86,85,129,102,49,14,87,86,55,8,9,100,47,121,145,23,22,88,89,179,6,122,196,88,95,96,138,172,136,215,58,172,115,48,219,42,80,81,195,3,51,43,146,61,171,175,199,81,82,38,53,46,225,144,163,110,246,33,7,52,65,66,229,228,117,34,127,234,107,108,69,109,108,151,48,64,235,62,78,191,129,209,126,111,35,143,163,161,246,117,123,50,222,65,52,19,125,141,221,55,65,3,195,197,25,7,33,220,237,44,70,71,139,122,193,245,247,130,33,71,21,162,153,158,159,170,169,150,188,174,196,216,186,92,144,160,161,2,97,167,141,125,241,164,167,37,72,38,12,145,159,160,38,82,13,63,68,71,226,35,111,158,153,154,101,50,205,206,92,165,209,198,217,165,167,97,220,115,218,133,112,243,239,238,241,214,135,169,190,173,133,171,208,32,125,44,237,86,87,178,85,86,179,84,85,180,83,84,181,201,83,182,137,93,132,76,62,183,61,76,184,57,61,185,212,57,186,214,207,187,34,143,156,79,239,237,123,137,177,44,1,4,201,194,32,64,102,129,213,215,138,59,166,219,242,99,97,2,94,141,75,59,235,24,110,228,25,130,226,23,24,229,22,23,230,26,22,231,112,26,232,189,190,243,221,56,190,28,56,221,27,28,222,29,27,223,30,29,224,247,30,225,238,79,20,166,59,75,60,75,240,147,177,215,20,79,166,187,147,213,112,233,244,233,128,245,128,114,188,114,217,174,131,115,220,217,198,236,198,131,134,177,132,58,143,35,124,110,163,7,228,110,25,356,389,368,11,302,267,452,350,349,302,303,269,357,343,277,452,453,357,333,332,297,175,152,377,384,398,382,347,348,330,303,304,270,9,336,337,278,279,360,418,262,431,304,408,409,310,415,407,270,409,410,450,348,347,422,430,434,313,314,17,306,307,375,387,388,260,286,414,398,335,406,418,364,367,416,423,358,327,251,284,298,281,5,4,373,374,253,307,320,321,425,427,411,421,313,18,321,405,406,320,404,405,315,16,17,426,425,266,377,400,369,322,391,269,417,465,464,386,257,258,466,260,388,456,399,419,284,332,333,417,285,8,346,340,261,413,441,285,327,460,328,355,371,329,392,439,438,382,341,256,429,420,360,364,394,379,277,343,437,443,444,283,275,440,363,431,262,369,297,338,337,273,375,321,450,451,349,446,342,467,293,334,282,458,461,462,276,353,383,308,324,325,276,300,293,372,345,447,382,398,362,352,345,340,274,1,19,456,248,281,436,427,425,381,256,252,269,391,393,200,199,428,266,330,329,287,273,422,250,462,328,258,286,384,265,353,342,387,259,257,424,431,430,342,353,276,273,335,424,292,325,307,366,447,345,271,303,302,423,266,371,294,455,460,279,278,294,271,272,304,432,434,427,272,407,408,394,430,431,395,369,400,334,333,299,351,417,168,352,280,411,325,319,320,295,296,336,319,403,404,330,348,349,293,298,333,323,454,447,15,16,315,358,429,279,14,15,316,285,336,9,329,349,350,374,380,252,318,402,403,6,197,419,318,319,325,367,364,365,435,367,397,344,438,439,272,271,311,195,5,281,273,287,291,396,428,199,311,271,268,283,444,445,373,254,339,263,466,249,282,334,296,449,347,346,264,447,454,336,296,299,338,10,151,278,439,455,292,407,415,358,371,355,340,345,372,390,249,466,346,347,280,442,443,282,19,94,370,441,442,295,248,419,197,263,255,359,440,275,274,300,383,368,351,412,465,263,467,466,301,368,389,380,374,386,395,378,379,412,351,419,436,426,322,373,390,388,2,164,393,370,462,461,164,0,267,302,11,12,374,373,387,268,12,13,293,300,301,446,261,340,385,384,381,330,266,425,426,423,391,429,355,437,391,327,326,440,457,438,341,382,362,459,457,461,434,430,394,414,463,362,396,369,262,354,461,457,316,403,402,315,404,403,314,405,404,313,406,405,421,418,406,366,401,361,306,408,407,291,409,408,287,410,409,432,436,410,434,416,411,264,368,383,309,438,457,352,376,401,274,275,4,421,428,262,294,327,358,433,416,367,289,455,439,462,370,326,2,326,370,305,460,455,254,449,448,255,261,446,253,450,449,252,451,450,256,452,451,341,453,452,413,464,463,441,413,414,258,442,441,257,443,442,259,444,443,260,445,444,467,342,445,459,458,250,289,392,290,290,328,460,376,433,435,250,290,392,411,416,433,341,463,464,453,464,465,357,465,412,343,412,399,360,363,440,437,399,456,420,456,363,401,435,288,372,383,353,339,255,249,448,261,255,133,243,190,133,155,112,33,246,247,33,130,25,398,384,286,362,398,414,362,463,341,263,359,467,263,249,255,466,467,260,75,60,166,238,239,79,162,127,139,72,11,37,121,232,120,73,72,39,114,128,47,233,232,128,103,104,67,152,175,148,173,157,155,119,118,101,74,73,40,107,9,108,49,48,131,32,194,211,184,74,185,191,80,183,185,40,186,119,230,118,210,202,214,84,83,17,77,76,146,161,160,30,190,56,173,182,106,194,138,135,192,129,203,98,54,21,68,5,51,4,145,144,23,90,77,91,207,205,187,83,201,18,181,91,182,180,90,181,16,85,17,205,206,36,176,148,140,165,92,39,245,193,244,27,159,28,30,247,161,174,236,196,103,54,104,55,193,8,111,117,31,221,189,55,240,98,99,142,126,100,219,166,218,112,155,26,198,209,131,169,135,150,114,47,217,224,223,53,220,45,134,32,211,140,109,67,108,146,43,91,231,230,120,113,226,247,105,63,52,241,238,242,124,46,156,95,78,96,70,46,63,116,143,227,116,123,111,1,44,19,3,236,51,207,216,205,26,154,22,165,39,167,199,200,208,101,36,100,43,57,202,242,20,99,56,28,157,124,35,113,29,160,27,211,204,210,124,113,46,106,43,204,96,62,77,227,137,116,73,41,72,36,203,142,235,64,240,48,49,64,42,41,74,214,212,207,183,42,184,210,169,211,140,170,176,104,105,69,193,122,168,50,123,187,89,96,90,66,65,107,179,89,180,119,101,120,68,63,104,234,93,227,16,15,85,209,129,49,15,14,86,107,55,9,120,100,121,153,145,22,178,88,179,197,6,196,89,88,96,135,138,136,138,215,172,218,115,219,41,42,81,5,195,51,57,43,61,208,171,199,41,81,38,224,53,225,24,144,110,105,52,66,118,229,117,227,34,234,66,107,69,10,109,151,219,48,235,183,62,191,142,129,126,116,111,143,7,163,246,118,117,50,223,222,52,94,19,141,222,221,65,196,3,197,45,220,44,156,70,139,188,122,245,139,71,162,145,153,159,149,170,150,122,188,196,206,216,92,163,144,161,164,2,167,242,141,241,0,164,37,11,72,12,144,145,160,12,38,13,70,63,71,31,226,111,157,158,154,36,101,205,203,206,165,126,209,217,98,165,97,237,220,218,237,239,241,210,214,169,140,171,32,241,125,237,179,86,178,180,85,179,181,84,180,182,83,181,194,201,182,177,137,132,184,76,183,185,61,184,186,57,185,216,212,186,192,214,187,139,34,156,218,79,237,147,123,177,45,44,4,208,201,32,98,64,129,192,213,138,235,59,219,141,242,97,97,2,141,240,75,235,229,24,228,31,25,226,230,23,229,231,22,230,232,26,231,233,112,232,244,189,243,189,221,190,222,28,221,223,27,222,224,29,223,225,30,224,113,247,225,99,60,240,213,147,215,60,20,166,192,187,213,243,112,244,244,233,245,245,128,188,188,114,174,134,131,220,174,217,236,236,198,134,215,177,58,156,143,124,25,110,7,31,228,25,264,356,368,0,11,267,451,452,349,267,302,269,350,357,277,350,452,357,299,333,297,396,175,377,381,384,382,280,347,330,269,303,270,151,9,337,344,278,360,424,418,431,270,304,409,272,310,407,322,270,410,449,450,347,432,422,434,18,313,17,291,306,375,259,387,260,424,335,418,434,364,416,391,423,327,301,251,298,275,281,4,254,373,253,375,307,321,280,425,411,200,421,18,335,321,406,321,320,405,314,315,17,423,426,266,396,377,369,270,322,269,413,417,464,385,386,258,248,456,419,298,284,333,168,417,8,448,346,261,417,413,285,326,327,328,277,355,329,309,392,438,381,382,256,279,429,360,365,364,379,355,277,437,282,443,283,281,275,363,395,431,369,299,297,337,335,273,321,348,450,349,359,446,467,283,293,282,250,458,462,300,276,383,292,308,325,283,276,293,264,372,447,346,352,340,354,274,19,363,456,281,426,436,425,380,381,252,267,269,393,421,200,428,371,266,329,432,287,422,290,250,328,385,258,384,446,265,342,386,387,257,422,424,430,445,342,276,422,273,424,306,292,307,352,366,345,268,271,302,358,423,371,327,294,460,331,279,294,303,271,304,436,432,427,304,272,408,395,394,431,378,395,400,296,334,299,6,351,168,376,352,411,307,325,320,285,295,336,320,319,404,329,330,349,334,293,333,366,323,447,316,15,315,331,358,279,317,14,316,8,285,9,277,329,350,253,374,252,319,318,403,351,6,419,324,318,325,397,367,365,288,435,397,278,344,439,310,272,311,248,195,281,375,273,291,175,396,199,312,311,268,276,283,445,390,373,339,295,282,296,448,449,346,356,264,454,337,336,299,337,338,151,294,278,455,308,292,415,429,358,355,265,340,372,388,390,466,352,346,280,295,442,282,354,19,370,285,441,295,195,248,197,457,440,274,301,300,368,417,351,465,251,301,389,385,380,386,394,395,379,399,412,419,410,436,322,387,373,388,326,2,393,354,370,461,393,164,267,268,302,12,386,374,387,312,268,13,298,293,301,265,446,340,380,385,381,280,330,425,322,426,391,420,429,437,393,391,326,344,440,438,458,459,461,364,434,394,428,396,262,274,354,457,317,316,402,316,315,403,315,314,404,314,313,405,313,421,406,323,366,361,292,306,407,306,291,408,291,287,409,287,432,410,427,434,411,372,264,383,459,309,457,366,352,401,1,274,4,418,421,262,331,294,358,435,433,367,392,289,439,328,462,326,94,2,370,289,305,455,339,254,448,359,255,446,254,253,449,253,252,450,252,256,451,256,341,452,414,413,463,286,441,414,286,258,441,258,257,442,257,259,443,259,260,444,260,467,445,309,459,250,305,289,290,305,290,460,401,376,435,309,250,392,376,411,433,453,341,464,357,453,465,343,357,412,437,343,399,344,360,440,420,437,456,360,420,363,361,401,288,265,372,353,390,339,249,339,448,255],SAMPLE_FACE:{keypoints:[{x:356.2804412841797,y:295.1960563659668,z:-23.786449432373047,name:"lips"},{x:354.8859405517578,y:264.69520568847656,z:-36.718435287475586},{x:355.2180862426758,y:275.3360366821289,z:-21.183712482452393},{x:347.349853515625,y:242.4400234222412,z:-25.093655586242676},{x:354.40135955810547,y:256.67933464050293,z:-38.23572635650635},{x:353.7689971923828,y:247.54886627197266,z:-34.5475435256958},{x:352.1288299560547,y:227.34312057495117,z:-13.095386028289795},{x:303.5013198852539,y:234.67002868652344,z:12.500141859054565,name:"rightEye"},{x:351.09378814697266,y:211.87547206878662,z:-6.413471698760986},{x:350.7115936279297,y:202.1251630783081,z:-6.413471698760986},{x:348.33667755126953,y:168.7741756439209,z:6.483500003814697,name:"faceOval"},{x:356.4806365966797,y:299.2995357513428,z:-23.144519329071045},{x:356.5511703491211,y:302.66146659851074,z:-21.020312309265137},{x:356.6239547729492,y:304.1536331176758,z:-18.137459754943848,name:"lips"},{x:356.5807342529297,y:305.1840591430664,z:-18.767719268798828,name:"lips"},{x:356.8241500854492,y:308.25711250305176,z:-20.16829490661621},{x:357.113037109375,y:312.26277351379395,z:-22.10575819015503},{x:357.34962463378906,y:317.1123218536377,z:-21.837315559387207,name:"lips"},{x:357.6658630371094,y:325.51036834716797,z:-16.27002477645874},{x:355.0201416015625,y:269.36279296875,z:-33.73054027557373},{x:348.5237503051758,y:270.33411026000977,z:-24.93025302886963},{x:279.97331619262695,y:213.24176788330078,z:47.759642601013184,name:"faceOval"},{x:322.66529083251953,y:238.5027265548706,z:5.535193085670471},{x:316.0983657836914,y:239.94489669799805,z:5.777376294136047},{x:309.9431610107422,y:240.24518966674805,z:7.510589361190796},{x:301.31994247436523,y:237.86138534545898,z:13.118728399276733},{x:328.14266204833984,y:235.80496788024902,z:6.646900177001953},{x:313.7326431274414,y:222.11161136627197,z:3.9887237548828125},{x:320.45196533203125,y:221.87729358673096,z:4.601476192474365},{x:307.35679626464844,y:223.63793849945068,z:5.932023525238037},{x:303.0031204223633,y:226.3743782043457,z:8.479321002960205},{x:296.80023193359375,y:242.94299125671387,z:15.931552648544312},{x:332.2352981567383,y:340.77341079711914,z:-10.165848731994629},{x:301.38587951660156,y:233.46447944641113,z:14.764405488967896,name:"rightEye"},{x:279.0147018432617,y:244.37155723571777,z:45.77549457550049},{x:289.60548400878906,y:239.1807460784912,z:23.191204071044922},{x:320.32257080078125,y:267.1292781829834,z:-4.954537749290466},{x:347.64583587646484,y:294.4955062866211,z:-23.062820434570312,name:"lips"},{x:349.28138732910156,y:303.1095886230469,z:-20.238323211669922},{x:338.9453125,y:298.19186210632324,z:-19.456336498260498,name:"lips"},{x:333.36788177490234,y:302.6706790924072,z:-14.776077270507812,name:"lips"},{x:342.89188385009766,y:304.3561363220215,z:-17.752301692962646},{x:337.7375030517578,y:306.0098361968994,z:-13.410515785217285},{x:325.6159210205078,y:316.22995376586914,z:-6.681914925575256},{x:349.0104675292969,y:264.9818515777588,z:-36.274919509887695},{x:347.7138900756836,y:257.5664806365967,z:-37.67549514770508},{x:291.79357528686523,y:218.88171672821045,z:11.578094959259033,name:"rightEyebrow"},{x:332.2689437866211,y:247.56946563720703,z:-3.3730539679527283},{x:332.0074462890625,y:267.1201229095459,z:-19.969879388809204},{x:331.27952575683594,y:263.6967658996582,z:-17.47218608856201},{x:301.04373931884766,y:269.56552505493164,z:3.61815482378006},{x:347.4863815307617,y:249.0706443786621,z:-32.633421421051025},{x:307.26118087768555,y:208.2646894454956,z:1.1591226607561111,name:"rightEyebrow"},{x:297.91919708251953,y:212.22604751586914,z:5.914516448974609,name:"rightEyebrow"},{x:285.1651382446289,y:197.98450469970703,z:36.391637325286865,name:"faceOval"},{x:337.04097747802734,y:211.25229835510254,z:-4.548954665660858},{x:326.5912628173828,y:223.16698551177979,z:6.670243740081787},{x:320.05664825439453,y:309.5834255218506,z:-4.055835008621216},{x:289.6866226196289,y:314.617395401001,z:53.875489234924316,name:"faceOval"},{x:337.4256896972656,y:270.8755302429199,z:-17.67060160636902},{x:343.69922637939453,y:273.0000400543213,z:-18.756048679351807},{x:327.4242401123047,y:309.22399520874023,z:-4.703601002693176,name:"lips"},{x:330.37220001220703,y:308.3323001861572,z:-6.442649960517883},{x:293.87027740478516,y:207.7961826324463,z:9.821539521217346,name:"rightEyebrow"},{x:332.11437225341797,y:271.22812271118164,z:-16.64351224899292},{x:320.1197814941406,y:207.40366458892822,z:-2.48164564371109,name:"rightEyebrow"},{x:318.59575271606445,y:201.07443809509277,z:-3.110446035861969,name:"rightEyebrow"},{x:310.72303771972656,y:175.75075149536133,z:13.328815698623657,name:"faceOval"},{x:289.67578887939453,y:202.29835510253906,z:21.370456218719482},{x:315.30879974365234,y:187.35260009765625,z:5.0304025411605835},{x:287.8936767578125,y:216.54793739318848,z:17.81065821647644,name:"rightEyebrow"},{x:283.9391899108887,y:215.01142501831055,z:32.04984903335571},{x:348.35330963134766,y:299.4155788421631,z:-22.47924566268921},{x:341.1790466308594,y:301.8221855163574,z:-18.977805376052856},{x:335.69713592529297,y:304.4266891479492,z:-14.682706594467163},{x:339.4615173339844,y:272.3654365539551,z:-16.38674020767212},{x:328.99600982666016,y:308.86685371398926,z:-5.616893768310547},{x:332.00313568115234,y:309.1875743865967,z:-10.335084199905396},{x:331.0068130493164,y:307.9274368286133,z:-6.681914925575256,name:"lips"},{x:341.13792419433594,y:266.4876937866211,z:-26.56425952911377},{x:339.02950286865234,y:305.6663703918457,z:-12.33674168586731,name:"lips"},{x:344.22935485839844,y:304.9452781677246,z:-15.161235332489014,name:"lips"},{x:350.1844024658203,y:304.374303817749,z:-17.5305438041687,name:"lips"},{x:348.52630615234375,y:325.9562301635742,z:-16.164982318878174},{x:348.6581802368164,y:317.1624183654785,z:-21.510512828826904,name:"lips"},{x:348.9766311645508,y:312.1923065185547,z:-21.708929538726807},{x:349.2427444458008,y:308.0660820007324,z:-19.643079042434692},{x:349.67491149902344,y:305.42747497558594,z:-18.16080331802368,name:"lips"},{x:337.95589447021484,y:306.6535949707031,z:-12.803598642349243,name:"lips"},{x:337.06878662109375,y:307.63169288635254,z:-14.274203777313232},{x:335.77449798583984,y:309.8449516296387,z:-15.698124170303345},{x:334.6099090576172,y:312.7997016906738,z:-14.764405488967896,name:"lips"},{x:327.2330856323242,y:293.80866050720215,z:-11.864047050476074},{x:280.97679138183594,y:279.79928970336914,z:68.90834331512451,name:"faceOval"},{x:355.13843536376953,y:271.7875671386719,z:-25.350427627563477},{x:334.7235870361328,y:307.4656391143799,z:-9.302158951759338,name:"lips"},{x:333.5293960571289,y:307.89782524108887,z:-10.200862884521484},{x:346.29688262939453,y:276.4256286621094,z:-19.748122692108154},{x:335.16246795654297,y:276.22097969055176,z:-12.313398122787476},{x:345.09132385253906,y:274.7082996368408,z:-19.304605722427368},{x:325.4267883300781,y:252.95130729675293,z:-1.6661019623279572},{x:315.347843170166,y:259.05200958251953,z:-.25604281574487686},{x:330.44933319091797,y:267.7570152282715,z:-14.017432928085327},{x:294.96768951416016,y:185.26001930236816,z:23.903164863586426,name:"faceOval"},{x:299.63531494140625,y:192.7913761138916,z:12.640198469161987},{x:304.5452117919922,y:202.4142837524414,z:3.244667649269104,name:"rightEyebrow"},{x:331.6915512084961,y:320.0467872619629,z:-10.632705688476562},{x:334.5911407470703,y:201.27566814422607,z:-6.133356094360352,name:"rightEyebrow"},{x:331.4815902709961,y:185.44180870056152,z:.6627205014228821},{x:328.05816650390625,y:170.8385467529297,z:7.358860373497009,name:"faceOval"},{x:304.49764251708984,y:239.76297855377197,z:10.387605428695679},{x:290.6382179260254,y:248.85257720947266,z:19.03616428375244},{x:331.5682601928711,y:233.20727348327637,z:7.837390303611755},{x:295.5115509033203,y:228.9834451675415,z:14.41426157951355},{x:336.94332122802734,y:241.8259334564209,z:-5.27842104434967},{x:336.2792205810547,y:262.7049922943115,z:-26.12074375152588},{x:284.4102478027344,y:255.3262710571289,z:25.467140674591064},{x:295.1420593261719,y:253.02655220031738,z:12.430112361907959},{x:303.5196113586426,y:254.20703887939453,z:6.139191389083862},{x:315.73450088500977,y:251.64799690246582,z:3.3788898587226868},{x:324.69661712646484,y:247.56494522094727,z:2.3328344523906708},{x:331.57970428466797,y:243.02241325378418,z:1.1423448473215103},{x:345.6210708618164,y:229.9976634979248,z:-10.825285911560059},{x:286.26644134521484,y:270.37991523742676,z:21.708929538726807},{x:290.2525520324707,y:228.4921360015869,z:17.71728754043579},{x:351.65367126464844,y:269.3400764465332,z:-33.450424671173096},{x:333.1378936767578,y:253.88388633728027,z:-7.230473756790161},{x:277.8318977355957,y:246.95331573486328,z:68.20805549621582,name:"faceOval"},{x:336.6680908203125,y:238.10003757476807,z:.7688578963279724},{x:329.95800018310547,y:269.18323516845703,z:-7.207130789756775},{x:299.17491912841797,y:234.13324356079102,z:15.95489501953125},{x:335.61729431152344,y:258.71752738952637,z:-23.016133308410645},{x:284.1079330444336,y:297.0343494415283,z:63.25934886932373,name:"faceOval"},{x:331.44542694091797,y:230.6892442703247,z:9.92658257484436,name:"rightEye"},{x:341.41536712646484,y:253.01264762878418,z:-29.038610458374023},{x:303.5472869873047,y:327.5896739959717,z:16.725212335586548},{x:304.7756576538086,y:337.4389457702637,z:27.38126277923584,name:"faceOval"},{x:280.80501556396484,y:275.32050132751465,z:45.0752067565918},{x:295.43582916259766,y:318.4501647949219,z:26.2608003616333},{x:281.4303207397461,y:228.7355661392212,z:40.94350814819336},{x:331.2549591064453,y:349.4216537475586,z:-7.376367449760437},{x:352.4247741699219,y:271.7330074310303,z:-24.953596591949463},{x:327.5672912597656,y:260.41900634765625,z:-5.456410646438599},{x:284.5432472229004,y:241.7647933959961,z:29.668869972229004},{x:310,y:235.66174507141113,z:8.502663969993591,name:"rightEye"},{x:315.7071113586426,y:235.7572603225708,z:6.938687562942505,name:"rightEye"},{x:330.41088104248047,y:311.04143142700195,z:-9.325502514839172,name:"lips"},{x:288.5377502441406,y:285.31983375549316,z:21.837315559387207},{x:344.55039978027344,y:359.4300842285156,z:-6.705257892608643,name:"faceOval"},{x:323.41880798339844,y:351.67362213134766,z:7.802375555038452,name:"faceOval"},{x:314.64088439941406,y:346.11894607543945,z:16.36339783668518,name:"faceOval"},{x:349.4945526123047,y:184.8434829711914,z:-.21847527474164963},{x:359.24694061279297,y:359.8348903656006,z:-8.403456211090088,name:"faceOval"},{x:321.26182556152344,y:234.64492321014404,z:6.90950870513916,name:"rightEye"},{x:326.318359375,y:232.90250301361084,z:8.029969334602356,name:"rightEye"},{x:329.6211624145508,y:231.6195774078369,z:9.722331762313843,name:"rightEye"},{x:285.9398078918457,y:228.2351303100586,z:24.650139808654785},{x:325.79288482666016,y:227.88007736206055,z:7.469738721847534,name:"rightEye"},{x:320.1699447631836,y:227.5934886932373,z:6.168370842933655,name:"rightEye"},{x:314.85408782958984,y:227.85282611846924,z:6.2675780057907104,name:"rightEye"},{x:309.3084907531738,y:229.1516876220703,z:7.7031683921813965,name:"rightEye"},{x:305.5621337890625,y:230.92366218566895,z:9.722331762313843,name:"rightEye"},{x:277.8681945800781,y:228.5354232788086,z:59.71122741699219,name:"faceOval"},{x:306.1444664001465,y:235.1954698562622,z:10.603528022766113,name:"rightEye"},{x:355.4478454589844,y:281.96210861206055,z:-20.565123558044434},{x:333.02661895751953,y:288.0105400085449,z:-14.72939133644104},{x:337.15728759765625,y:269.2059516906738,z:-19.8414945602417},{x:345.9898376464844,y:283.5453128814697,z:-20.4834246635437},{x:351.48963928222656,y:219.98916149139404,z:-7.0378947257995605},{x:312.39574432373047,y:336.50628089904785,z:8.671900033950806},{x:321.32152557373047,y:343.1755256652832,z:.9067271649837494},{x:343.78379821777344,y:353.2975959777832,z:-14.355905055999756},{x:296.8791389465332,y:327.91497230529785,z:41.01353645324707,name:"faceOval"},{x:329.6939468383789,y:229.27897453308105,z:8.934508562088013,name:"rightEye"},{x:341.6905212402344,y:241.4073657989502,z:-14.589333534240723},{x:359.03079986572266,y:353.48859786987305,z:-15.803166627883911},{x:333.1861877441406,y:356.43213272094727,z:-1.0234417766332626,name:"faceOval"},{x:283.97483825683594,y:291.4318656921387,z:41.94725513458252},{x:343.33770751953125,y:305.830135345459,z:-15.756480693817139,name:"lips"},{x:342.40283966064453,y:307.7453899383545,z:-17.4021577835083},{x:341.53621673583984,y:311.0595703125,z:-19.047834873199463},{x:340.9107208251953,y:315.4837703704834,z:-18.5576331615448,name:"lips"},{x:339.1478729248047,y:323.42233657836914,z:-14.367576837539673},{x:333.3201599121094,y:307.4406337738037,z:-9.617288708686829},{x:331.2411117553711,y:306.9811820983887,z:-9.669809937477112},{x:329.23255920410156,y:306.0508346557617,z:-9.582273960113525,name:"lips"},{x:322.4586486816406,y:301.33323669433594,z:-7.720675468444824},{x:297.1712112426758,y:286.9552803039551,z:8.240055441856384},{x:341.3060760498047,y:235.4432201385498,z:-7.504753470420837},{x:336.9318389892578,y:224.3451976776123,z:5.829898118972778},{x:332.65323638916016,y:226.70403957366943,z:8.105834126472473},{x:334.67357635498047,y:306.4397621154785,z:-8.981193900108337,name:"lips"},{x:297.4601936340332,y:306.29210472106934,z:15.476365089416504},{x:342.9119110107422,y:222.37077713012695,z:-2.754466235637665},{x:335.4629898071289,y:332.20250129699707,z:-11.823196411132812},{x:353.2412338256836,y:240.56339263916016,z:-27.147831916809082},{x:346.3080596923828,y:236.41446590423584,z:-18.452589511871338},{x:352.6475143432617,y:234.1420555114746,z:-19.748122692108154},{x:337.3209762573242,y:253.39937210083008,z:-16.024924516677856},{x:358.6122131347656,y:344.90861892700195,z:-18.592647314071655},{x:358.1117248535156,y:334.64990615844727,z:-17.49552845954895},{x:346.4450454711914,y:335.0321102142334,z:-16.32838249206543},{x:319.17640686035156,y:320.2833938598633,z:-3.276764452457428},{x:325.2540588378906,y:276.2369728088379,z:-6.460157036781311},{x:326.7214584350586,y:327.3939514160156,z:-7.417217493057251},{x:310.7190132141113,y:277.2265148162842,z:-3.5452082753181458},{x:319.78355407714844,y:284.8238182067871,z:-6.4543211460113525},{x:305.773983001709,y:290.83580017089844,z:.06907138042151928},{x:344.4001770019531,y:344.85408782958984,z:-16.946970224380493},{x:333.1879425048828,y:258.74256134033203,z:-11.90489649772644},{x:313.80598068237305,y:327.08919525146484,z:2.2277912497520447},{x:322.9637908935547,y:334.6819496154785,z:-3.3643004298210144},{x:313.4055519104004,y:311.2166690826416,z:-1.1175429821014404},{x:291.0865783691406,y:298.2831001281738,z:22.467575073242188},{x:305.6580924987793,y:313.3707904815674,z:5.561453700065613},{x:288.23760986328125,y:305.9941864013672,z:36.765122413635254},{x:315.10692596435547,y:296.26991271972656,z:-4.604393839836121},{x:337.50518798828125,y:247.5944423675537,z:-10.597691535949707},{x:338.8450622558594,y:265.47778129577637,z:-27.778091430664062},{x:334.25254821777344,y:269.0671920776367,z:-20.938611030578613},{x:341.64512634277344,y:259.6387195587158,z:-32.189905643463135},{x:331.44081115722656,y:219.0976095199585,z:4.207563698291779},{x:320.56339263916016,y:216.49658203125,z:2.930997312068939},{x:311.21912002563477,y:216.57853603363037,z:2.9674705862998962},{x:303.46256256103516,y:218.54614734649658,z:5.357203483581543},{x:297.99999237060547,y:222.505202293396,z:9.325502514839172},{x:294.93839263916016,y:236.39654159545898,z:18.534289598464966},{x:278.87489318847656,y:259.7095584869385,z:45.68212032318115},{x:300.3782653808594,y:245.38593292236328,z:12.278382778167725},{x:307.06348419189453,y:246.36857986450195,z:8.164191246032715},{x:315.5229187011719,y:245.3949737548828,z:5.503097176551819},{x:323.71395111083984,y:242.75178909301758,z:4.6335723996162415},{x:330.2785873413086,y:239.34658527374268,z:4.937030673027039},{x:334.6982192993164,y:236.0460376739502,z:4.823233783245087},{x:279.3412208557129,y:263.5196113586426,z:70.91583728790283,name:"faceOval"},{x:334.65972900390625,y:271.6648578643799,z:-17.775644063949585},{x:342.05677032470703,y:246.99846267700195,z:-20.84523916244507},{x:344.0357971191406,y:264.5701503753662,z:-32.936880588531494},{x:348.25531005859375,y:268.6645030975342,z:-30.695960521697998},{x:344.12227630615234,y:266.34212493896484,z:-29.808926582336426},{x:337.12318420410156,y:274.2556858062744,z:-15.768152475357056},{x:349.49047088623047,y:269.071683883667,z:-32.51670837402344},{x:350.1683044433594,y:271.4691352844238,z:-24.93025302886963},{x:333.9634704589844,y:230.56639194488525,z:8.89949381351471},{x:338.2147979736328,y:231.4807891845703,z:4.6715047955513},{x:340.4712677001953,y:231.74463272094727,z:-.34996166825294495},{x:303.28975677490234,y:232.24980354309082,z:11.916568279266357,name:"rightEye"},{x:299.4649124145508,y:229.53842639923096,z:12.325069904327393},{x:359.09618377685547,y:241.77349090576172,z:-24.650139808654785},{x:399.46216583251953,y:229.89503860473633,z:15.919880867004395,name:"leftEye"},{x:361.38919830322266,y:269.6129894256592,z:-24.510080814361572},{x:416.9973373413086,y:206.0895538330078,z:53.26857566833496,name:"faceOval"},{x:381.32179260253906,y:235.5476474761963,z:7.6214683055877686},{x:387.8068542480469,y:236.25958442687988,z:8.345099091529846},{x:393.95751953125,y:235.8660364151001,z:10.475142002105713},{x:401.84600830078125,y:232.77019500732422,z:16.760226488113403},{x:375.70568084716797,y:233.48456382751465,z:8.234220147132874},{x:388.17752838134766,y:218.94717693328857,z:6.810300946235657},{x:381.64928436279297,y:219.2656660079956,z:6.711093783378601},{x:394.4760513305664,y:219.66821193695068,z:9.173773527145386},{x:398.8843536376953,y:221.8837022781372,z:12.03328251838684},{x:406.5454864501953,y:237.12156772613525,z:19.7131085395813},{x:383.87447357177734,y:337.6932907104492,z:-8.631049990653992},{x:401.2682342529297,y:228.5916566848755,z:18.359217643737793,name:"leftEye"},{x:422.0449447631836,y:236.73934936523438,z:51.16771221160889},{x:412.69153594970703,y:232.80198097229004,z:27.52131938934326},{x:387.3497772216797,y:263.298397064209,z:-2.8609684109687805},{x:364.5124053955078,y:293.39221000671387,z:-22.397546768188477,name:"lips"},{x:363.62987518310547,y:302.1291446685791,z:-19.643079042434692},{x:373.2334518432617,y:295.8647060394287,z:-18.125789165496826,name:"lips"},{x:378.83365631103516,y:299.5177745819092,z:-13.153743743896484,name:"lips"},{x:369.91477966308594,y:302.5704002380371,z:-16.65518283843994},{x:374.9167251586914,y:303.5416603088379,z:-11.963253021240234},{x:387.58888244628906,y:312.2716999053955,z:-4.680258631706238},{x:360.6635284423828,y:264.31986808776855,z:-35.94811677932739},{x:361.04564666748047,y:256.8225860595703,z:-37.278664112091064},{x:408.3855438232422,y:213.52088928222656,z:15.756480693817139,name:"leftEyebrow"},{x:373.2946014404297,y:245.38101196289062,z:-1.9316278398036957},{x:376.83860778808594,y:264.3721103668213,z:-18.510947227478027},{x:376.9546127319336,y:261.0010528564453,z:-15.989909172058105},{x:406.1498260498047,y:263.5030174255371,z:7.072908878326416},{x:360.07205963134766,y:248.3631706237793,z:-32.16656446456909},{x:393.11119079589844,y:205.10473251342773,z:3.7786373496055603,name:"leftEyebrow"},{x:402.12791442871094,y:207.89000988006592,z:9.383859634399414,name:"leftEyebrow"},{x:410.8693313598633,y:191.6182279586792,z:41.27030849456787,name:"faceOval"},{x:364.9509811401367,y:210.40483474731445,z:-3.758212625980377},{x:375.94444274902344,y:221.1331844329834,z:8.368442058563232},{x:392.1904754638672,y:305.0360298156738,z:-1.752179116010666},{x:419.50225830078125,y:307.25592613220215,z:58.96425247192383,name:"faceOval"},{x:372.0027160644531,y:268.7212657928467,z:-16.631840467453003},{x:366.1614227294922,y:271.6237449645996,z:-18.219159841537476},{x:385.00938415527344,y:305.3863334655762,z:-2.567722797393799},{x:381.99771881103516,y:304.9723720550537,z:-4.575215280056},{x:405.078125,y:203.21216583251953,z:13.713973760604858,name:"leftEyebrow"},{x:377.13207244873047,y:268.4710121154785,z:-15.266278982162476},{x:380.9713363647461,y:205.36980628967285,z:-.7250899076461792,name:"leftEyebrow"},{x:381.7788314819336,y:198.9268398284912,z:-1.184653863310814,name:"leftEyebrow"},{x:385.5204772949219,y:172.1484375,z:16.04826807975769,name:"faceOval"},{x:407.94189453125,y:196.76236152648926,z:25.723915100097656},{x:383.03890228271484,y:184.5157527923584,z:7.393874526023865},{x:411.61781311035156,y:210.79241752624512,z:22.315845489501953,name:"leftEyebrow"},{x:414.30870056152344,y:208.4643030166626,z:37.021894454956055},{x:364.28722381591797,y:298.35777282714844,z:-21.86065673828125},{x:371.3682556152344,y:299.78848457336426,z:-17.834001779556274},{x:376.88201904296875,y:301.6696071624756,z:-13.153743743896484},{x:370.2193832397461,y:270.49095153808594,z:-15.569736957550049},{x:383.5081100463867,y:305.2726364135742,z:-3.673594295978546},{x:380.73760986328125,y:305.96869468688965,z:-8.660228252410889},{x:381.2334442138672,y:304.63574409484863,z:-4.820316135883331,name:"lips"},{x:368.1698989868164,y:264.8884963989258,z:-25.653886795043945},{x:373.5087203979492,y:303.4233856201172,z:-10.95950722694397,name:"lips"},{x:368.4544372558594,y:303.29601287841797,z:-14.169161319732666,name:"lips"},{x:362.76554107666016,y:303.5735607147217,z:-16.911956071853638,name:"lips"},{x:366.60980224609375,y:324.8870658874512,z:-15.616422891616821},{x:365.7067108154297,y:315.95678329467773,z:-20.903596878051758,name:"lips"},{x:365.0083923339844,y:311.2232208251953,z:-21.066999435424805},{x:364.1508102416992,y:307.0583438873291,z:-18.907777070999146},{x:363.37512969970703,y:304.5721435546875,z:-17.42550015449524,name:"lips"},{x:374.580078125,y:304.3059539794922,z:-11.40302300453186,name:"lips"},{x:375.55362701416016,y:305.0998020172119,z:-12.861957550048828},{x:377.2437286376953,y:307.1674346923828,z:-14.215847253799438},{x:378.68587493896484,y:309.9015712738037,z:-13.223772048950195,name:"lips"},{x:383.8992691040039,y:290.29629707336426,z:-9.97326910495758},{x:423.3871841430664,y:271.91688537597656,z:74.37058925628662,name:"faceOval"},{x:377.68043518066406,y:304.62209701538086,z:-7.603961229324341,name:"lips"},{x:379.00428771972656,y:304.9314594268799,z:-8.57852816581726},{x:364.00279998779297,y:275.2813911437988,z:-19.25792098045349},{x:374.68231201171875,y:273.82555961608887,z:-11.28047227859497},{x:365.0354766845703,y:273.4548568725586,z:-18.791062831878662},{x:380.61901092529297,y:249.8848056793213,z:.15501167625188828},{x:391.14158630371094,y:254.7934627532959,z:2.0906515419483185},{x:378.1761169433594,y:264.9612236022949,z:-12.605184316635132},{x:400.9540557861328,y:179.99592304229736,z:27.82477855682373,name:"faceOval"},{x:398.0038833618164,y:188.50656509399414,z:16.094952821731567},{x:394.8717498779297,y:199.0359592437744,z:6.226727366447449,name:"leftEyebrow"},{x:382.10926055908203,y:316.83926582336426,z:-8.946179747581482},{x:366.51588439941406,y:200.32583713531494,z:-5.24632453918457,name:"leftEyebrow"},{x:367.4893569946289,y:183.87210845947266,z:1.9039081037044525},{x:368.6243438720703,y:168.8127565383911,z:8.736093044281006,name:"faceOval"},{x:398.96175384521484,y:234.9675178527832,z:13.713973760604858},{x:412.9645538330078,y:242.23042488098145,z:23.272905349731445},{x:372.05257415771484,y:231.41919136047363,z:9.226294755935669},{x:406.0722351074219,y:223.58965873718262,z:18.370890617370605},{x:368.27442169189453,y:240.2039337158203,z:-4.166713654994965},{x:372.3575210571289,y:260.66442489624023,z:-24.976940155029297},{x:419.2244338989258,y:247.9079246520996,z:30.299127101898193},{x:409.43885803222656,y:246.60913467407227,z:16.398411989212036},{x:401.69139862060547,y:248.76328468322754,z:9.395531415939331},{x:389.7608184814453,y:247.56915092468262,z:5.841569304466248},{x:380.5461883544922,y:244.55984115600586,z:4.263003468513489},{x:373.25817108154297,y:240.80214500427246,z:2.5356262922286987},{x:358.77086639404297,y:229.35615062713623,z:-10.387605428695679},{x:419.5793914794922,y:262.8478717803955,z:26.5175724029541},{x:410.8808898925781,y:222.51372814178467,z:22.199130058288574},{x:358.45714569091797,y:268.91467094421387,z:-33.17030906677246},{x:373.4129333496094,y:251.6385841369629,z:-5.771540403366089},{x:422.5408172607422,y:239.23919677734375,z:74.04378890991211,name:"faceOval"},{x:367.8171920776367,y:236.58040523529053,z:1.820748895406723},{x:378.51959228515625,y:266.2532329559326,z:-5.74819803237915},{x:403.3472442626953,y:229.05112266540527,z:19.689764976501465},{x:372.34840393066406,y:256.6451168060303,z:-21.872329711914062},{x:422.54566192626953,y:289.1587829589844,z:68.67491245269775,name:"faceOval"},{x:371.9297409057617,y:228.90116214752197,z:11.432201862335205,name:"leftEye"},{x:366.21360778808594,y:251.6158962249756,z:-28.19826364517212},{x:409.1571807861328,y:321.3156223297119,z:20.2266526222229},{x:408.52943420410156,y:331.44238471984863,z:31.09278917312622,name:"faceOval"},{x:424.2788314819336,y:267.1992301940918,z:50.467424392700195},{x:415.60352325439453,y:311.6528606414795,z:30.579242706298828},{x:418.12793731689453,y:221.59927368164062,z:46.26569747924805},{x:385.68286895751953,y:346.0184955596924,z:-5.70151150226593},{x:357.82936096191406,y:271.3758373260498,z:-24.836881160736084},{x:379.588623046875,y:257.5071716308594,z:-3.755294680595398},{x:417.4592590332031,y:234.71948146820068,z:34.5475435256958},{x:393.4684371948242,y:231.58967971801758,z:11.408859491348267,name:"leftEye"},{x:387.8864288330078,y:232.14245796203613,z:9.51808214187622,name:"leftEye"},{x:382.4981689453125,y:307.5654888153076,z:-7.522260546684265,name:"lips"},{x:419.00169372558594,y:277.8332805633545,z:26.424202919006348},{x:373.62953186035156,y:357.6375102996826,z:-5.75986921787262,name:"faceOval"},{x:392.8708267211914,y:347.72446632385254,z:10.154176950454712,name:"faceOval"},{x:400.3953552246094,y:341.0005187988281,z:19.39797878265381,name:"faceOval"},{x:382.25440979003906,y:231.66935920715332,z:8.998700976371765,name:"leftEye"},{x:377.14550018310547,y:230.4228687286377,z:9.804032444953918,name:"leftEye"},{x:373.8358688354492,y:229.64950561523438,z:11.292144060134888,name:"leftEye"},{x:414.5794677734375,y:221.67891025543213,z:29.412097930908203},{x:377.00672149658203,y:225.66201210021973,z:9.360517263412476,name:"leftEye"},{x:382.29530334472656,y:224.8431158065796,z:8.32175612449646,name:"leftEye"},{x:387.5133514404297,y:224.49507236480713,z:8.917000889778137,name:"leftEye"},{x:393.15906524658203,y:225.24795055389404,z:10.737749338150024,name:"leftEye"},{x:397.05554962158203,y:226.55359268188477,z:13.002015352249146,name:"leftEye"},{x:420.5299377441406,y:221.014666557312,z:65.40690422058105,name:"faceOval"},{x:397.06920623779297,y:230.6661558151245,z:13.807345628738403,name:"leftEye"},{x:377.94647216796875,y:285.1647090911865,z:-13.305472135543823},{x:372.1118927001953,y:267.1267318725586,z:-18.83774757385254},{x:364.9968719482422,y:282.24411964416504,z:-19.818150997161865},{x:401.973876953125,y:331.20131492614746,z:11.566424369812012},{x:394.3083190917969,y:338.86693954467773,z:3.142542541027069},{x:373.9820861816406,y:351.4504623413086,z:-13.50388765335083},{x:414.3888854980469,y:321.24735832214355,z:45.51872253417969,name:"faceOval"},{x:373.44234466552734,y:227.33163356781006,z:10.626870393753052,name:"leftEye"},{x:364.0731430053711,y:240.31539916992188,z:-13.807345628738403},{x:384.2658233642578,y:353.3793067932129,z:.7385850697755814,name:"faceOval"},{x:423.20526123046875,y:283.5176181793213,z:47.152724266052246},{x:369.42798614501953,y:304.0898895263672,z:-14.647691249847412,name:"lips"},{x:370.63812255859375,y:305.90051651000977,z:-16.211668252944946},{x:371.91192626953125,y:309.0167713165283,z:-17.84567356109619},{x:373.0583953857422,y:313.3545398712158,z:-17.378815412521362,name:"lips"},{x:375.39905548095703,y:321.09289169311523,z:-13.118728399276733},{x:379.2567825317383,y:304.3582534790039,z:-7.924926280975342},{x:381.18797302246094,y:303.7031364440918,z:-7.843226194381714},{x:383.0918502807617,y:302.4884605407715,z:-7.6506465673446655,name:"lips"},{x:389.09461975097656,y:297.1475315093994,z:-5.5497825145721436},{x:411.6408920288086,y:280.24898529052734,z:12.02161192893982},{x:363.3110809326172,y:234.27620887756348,z:-6.775286793708801},{x:366.0474395751953,y:223.29872131347656,z:6.827808618545532},{x:370.34427642822266,y:225.1457118988037,z:9.558931589126587},{x:377.5371551513672,y:303.60079765319824,z:-7.358860373497009,name:"lips"},{x:412.9557800292969,y:299.53579902648926,z:19.39797878265381},{x:360.0810241699219,y:221.72012329101562,z:-2.153385728597641},{x:379.82784271240234,y:329.47723388671875,z:-10.48097848892212},{x:359.08477783203125,y:235.7911491394043,z:-18.079102039337158},{x:369.6688461303711,y:251.5407943725586,z:-14.962821006774902},{x:369.5555114746094,y:333.5307312011719,z:-15.67478060722351},{x:394.0193176269531,y:315.6973171234131,z:-.9920747578144073},{x:383.78997802734375,y:272.7268695831299,z:-4.689012169837952},{x:387.67765045166016,y:323.6722755432129,z:-5.640236139297485},{x:397.8769302368164,y:272.1331214904785,z:-.9395531564950943},{x:389.87476348876953,y:280.5630111694336,z:-4.29218202829361},{x:403.83888244628906,y:285.1167869567871,z:3.0229100584983826},{x:372.5467300415039,y:343.1070327758789,z:-16.153310537338257},{x:374.1112518310547,y:256.3721466064453,z:-10.574349164962769},{x:399.73785400390625,y:321.77515983581543,z:4.849494695663452},{x:392.03365325927734,y:330.56447982788086,z:-1.3407598435878754},{x:398.59134674072266,y:305.93902587890625,z:1.517290621995926},{x:417.95997619628906,y:290.9716987609863,z:26.89105987548828},{x:406.04541778564453,y:307.35154151916504,z:8.666064143180847},{x:420.75328826904297,y:298.40752601623535,z:41.78385257720947},{x:395.4522705078125,y:291.4153575897217,z:-2.1752697229385376},{x:368.6452102661133,y:245.8882999420166,z:-9.453888535499573},{x:370.34900665283203,y:263.56690406799316,z:-26.75100326538086},{x:374.98477935791016,y:266.6126346588135,z:-19.77146625518799},{x:366.99840545654297,y:258.12140464782715,z:-31.372904777526855},{x:371.00616455078125,y:217.63479709625244,z:5.60522198677063},{x:381.30577087402344,y:214.14087295532227,z:4.983716309070587},{x:390.1496124267578,y:213.38221549987793,z:5.593550801277161},{x:397.7696990966797,y:214.3659782409668,z:8.57852816581726},{x:403.1652069091797,y:217.65509605407715,z:13.013685941696167},{x:407.3551940917969,y:230.72525024414062,z:22.444231510162354},{x:424.0876770019531,y:251.7839241027832,z:51.16771221160889},{x:403.50196838378906,y:239.88757610321045,z:15.803166627883911},{x:397.31719970703125,y:241.49806022644043,z:11.233787536621094},{x:388.99425506591797,y:241.4366912841797,z:7.948269248008728},{x:380.7804489135742,y:239.78078842163086,z:6.600214838981628},{x:374.01336669921875,y:237.11946487426758,z:6.349278092384338},{x:369.39125061035156,y:234.35351371765137,z:5.987462401390076},{x:422.9730987548828,y:255.76455116271973,z:76.61150932312012,name:"faceOval"},{x:374.73915100097656,y:269.24214363098145,z:-16.608498096466064},{x:364.61681365966797,y:245.71088790893555,z:-20.02823829650879},{x:365.3834533691406,y:263.34174156188965,z:-32.32996463775635},{x:361.58252716064453,y:267.8273677825928,z:-30.345816612243652},{x:365.37208557128906,y:265.0249671936035,z:-29.178667068481445},{x:372.72605895996094,y:272.05135345458984,z:-14.834434986114502},{x:360.48614501953125,y:268.34827423095703,z:-32.189905643463135},{x:359.9516296386719,y:270.8049201965332,z:-24.650139808654785},{x:369.5049285888672,y:229.01945114135742,z:10.107489824295044},{x:365.5447769165039,y:230.24096488952637,z:5.593550801277161},{x:363.50669860839844,y:230.6208372116089,z:.43622106313705444},{x:399.3529510498047,y:227.65677452087402,z:15.35965085029602,name:"leftEye"},{x:402.5693130493164,y:224.60190296173096,z:15.931552648544312}],box:{xMin:277.8318977355957,yMin:168.7741756439209,xMax:424.2788314819336,yMax:359.8348903656006,width:146.4469337463379,height:191.0607147216797}},SAMPLE_FACELANDMARKER_RESULT:{faceLandmarks:[[{x:.5760777592658997,y:.8639070391654968,z:-.030997956171631813},{x:.572094738483429,y:.7886289358139038,z:-.07189624011516571},{x:.5723551511764526,y:.8075382709503174,z:-.03578168898820877},{x:.5548420548439026,y:.7188365459442139,z:-.057787876576185226},{x:.5706077814102173,y:.7674974799156189,z:-.07740399986505508},{x:.5681378245353699,y:.7387768030166626,z:-.07356284558773041},{x:.5621535181999207,y:.6681165099143982,z:-.04189874976873398},{x:.46613582968711853,y:.6679812073707581,z:.011289681307971478},{x:.5579932928085327,y:.6174106597900391,z:-.03502821549773216},{x:.5563451647758484,y:.5905600190162659,z:-.03928658738732338},{x:.5487832427024841,y:.4900572597980499,z:-.029898937791585922},{x:.5765544176101685,y:.8692144751548767,z:-.02831427752971649},{x:.5771114230155945,y:.873644232749939,z:-.02345779910683632},{x:.5771905779838562,y:.877016007900238,z:-.016658689826726913},{x:.5778058767318726,y:.8770116567611694,z:-.014505492523312569},{x:.5783766508102417,y:.8835000991821289,z:-.015996402129530907},{x:.5792440176010132,y:.8913810849189758,z:-.01924579218029976},{x:.5796768069267273,y:.8996334671974182,z:-.018261712044477463},{x:.5817288160324097,y:.9255813956260681,z:-.007126849144697189},{x:.5726592540740967,y:.7992473244667053,z:-.0643521398305893},{x:.5579419136047363,y:.7996989488601685,z:-.04566684365272522},{x:.4216199815273285,y:.5958762764930725,z:.06776496022939682},{x:.5052269697189331,y:.6796539425849915,z:-.0010737782577052712},{x:.49243026971817017,y:.6838865876197815,z:-.0005227324436418712},{x:.4796970784664154,y:.6856290102005005,z:.002684245817363262},{x:.4618356227874756,y:.6764569878578186,z:.013439622707664967},{x:.5160380601882935,y:.6737282276153564,z:-17607348127057776e-21},{x:.48070961236953735,y:.6255870461463928,z:-.008339674212038517},{x:.49719780683517456,y:.6256808042526245,z:-.008027955889701843},{x:.46674346923828125,y:.6317623853683472,z:-.004460199736058712},{x:.4582492709159851,y:.641118049621582,z:.0011905613355338573},{x:.45408669114112854,y:.6911458969116211,z:.020514748990535736},{x:.535312294960022,y:.9619986414909363,z:.012499462813138962},{x:.4608460068702698,y:.6628725528717041,z:.01517564244568348},{x:.4206731915473938,y:.6828458309173584,z:.07848648726940155},{x:.4390624463558197,y:.6796106696128845,z:.03283142298460007},{x:.5029968619346619,y:.7701570391654968,z:-.009734481573104858},{x:.5595027208328247,y:.8607323169708252,z:-.030043255537748337},{x:.5621269941329956,y:.8738374710083008,z:-.021709579974412918},{x:.5451499819755554,y:.865527331829071,z:-.022014077752828598},{x:.5351184010505676,y:.8705098032951355,z:-.011602800339460373},{x:.5495014190673828,y:.8744956254959106,z:-.016490943729877472},{x:.5395170450210571,y:.8759440779685974,z:-.007333362940698862},{x:.5183624029159546,y:.8959754705429077,z:.010520773939788342},{x:.5604349374771118,y:.7895449995994568,z:-.07082037627696991},{x:.557381272315979,y:.7687489986419678,z:-.07590588927268982},{x:.4432901442050934,y:.6308897733688354,z:.0027153254486620426},{x:.5258325338363647,y:.7151225805282593,z:-.014676518738269806},{x:.5271827578544617,y:.7833116054534912,z:-.037643320858478546},{x:.5257382988929749,y:.7717816233634949,z:-.03401920944452286},{x:.46516409516334534,y:.7705106735229492,z:.0065747760236263275},{x:.5558893084526062,y:.7420997619628906,z:-.0694495290517807},{x:.4720408320426941,y:.6066038608551025,z:-.021204356104135513},{x:.45432573556900024,y:.6158540844917297,z:-.011054684408009052},{x:.4305151402950287,y:.5608053803443909,z:.0396830290555954},{x:.5310865640640259,y:.6157484650611877,z:-.03081176057457924},{x:.5114666223526001,y:.6329749226570129,z:-.00335998204536736},{x:.506435751914978,y:.8786543607711792,z:.012980876490473747},{x:.4480472207069397,y:.8640613555908203,z:.12569651007652283},{x:.5372058153152466,y:.7942581176757812,z:-.03168361634016037},{x:.5488379597663879,y:.8001630306243896,z:-.03280917927622795},{x:.5213388204574585,y:.8794381618499756,z:.011892606504261494},{x:.5242055654525757,y:.8789222240447998,z:.008370225317776203},{x:.4477175176143646,y:.6039950251579285,z:-.0050799972377717495},{x:.526964008808136,y:.7916748523712158,z:-.02968614175915718},{x:.4971255660057068,y:.6050706505775452,z:-.028175678104162216},{x:.4938119053840637,y:.5882453918457031,z:-.03210941329598427},{x:.4757143557071686,y:.5094879865646362,z:-.01300730835646391},{x:.43947282433509827,y:.5816648006439209,z:.01415177434682846},{x:.485664039850235,y:.5477864146232605,z:-.023685332387685776},{x:.43635931611061096,y:.6226438283920288,z:.013606148771941662},{x:.42910251021385193,y:.6102726459503174,z:.03926564007997513},{x:.5605402588844299,y:.8680099248886108,z:-.027318159118294716},{x:.5474816560745239,y:.8702861070632935,z:-.019686367362737656},{x:.5373021364212036,y:.8728838562965393,z:-.010484928265213966},{x:.540735125541687,y:.7979167103767395,z:-.029073253273963928},{x:.5228585004806519,y:.87913578748703,z:.009915109723806381},{x:.530497670173645,y:.8815253973007202,z:.0020524784922599792},{x:.5259912610054016,y:.8790552616119385,z:.007895970717072487},{x:.5433906316757202,y:.7882310748100281,z:-.05121905356645584},{x:.541388213634491,y:.8777219653129578,z:-.00466804439201951},{x:.5515822172164917,y:.8767023086547852,z:-.010475946590304375},{x:.5637003779411316,y:.877059817314148,z:-.015273625031113625},{x:.5640299320220947,y:.9263423085212708,z:-.00658724969252944},{x:.5642300248146057,y:.8993074893951416,z:-.017653480172157288},{x:.5637336373329163,y:.8910360932350159,z:-.01852807030081749},{x:.5637134313583374,y:.8837276697158813,z:-.01482592523097992},{x:.564205527305603,y:.8768964409828186,z:-.01331155002117157},{x:.5419867634773254,y:.8778373599052429,z:-.0037720394320786},{x:.5404468774795532,y:.880696177482605,z:-.005610354244709015},{x:.5392338633537292,y:.8845721483230591,z:-.007352025713771582},{x:.538469672203064,y:.8891173601150513,z:-.005154991988092661},{x:.5189250111579895,y:.8452741503715515,z:-.009755070321261883},{x:.4258975088596344,y:.7662280797958374,z:.1387351155281067},{x:.5725725293159485,y:.8041572570800781,z:-.04583907872438431},{x:.5342061519622803,y:.8785833120346069,z:.002659974154084921},{x:.5324031114578247,y:.8804071545600891,z:.0017832003068178892},{x:.5538818836212158,y:.8078407645225525,z:-.03254539892077446},{x:.5325431823730469,y:.8026832938194275,z:-.019140373915433884},{x:.5514076948165894,y:.8043903112411499,z:-.03313535451889038},{x:.5131856203079224,y:.7284771800041199,z:-.009399853646755219},{x:.49331504106521606,y:.7443980574607849,z:-.005225230939686298},{x:.5239617824554443,y:.7807451486587524,z:-.025881027802824974},{x:.4473606050014496,y:.5315827131271362,z:.011164786294102669},{x:.45718759298324585,y:.5604941248893738,z:-.005943301599472761},{x:.4670005738735199,y:.5909327268600464,z:-.019681761041283607},{x:.5311570167541504,y:.9076261520385742,z:.00389476353302598},{x:.5249923467636108,y:.5893563628196716,z:-.037981919944286346},{x:.5166932344436646,y:.5429551005363464,z:-.03319704160094261},{x:.5085030198097229,y:.49676206707954407,z:-.02691275253891945},{x:.4687720239162445,y:.6834565997123718,z:.008113506250083447},{x:.4426414966583252,y:.7069531679153442,z:.028577271848917007},{x:.5230373740196228,y:.6675713658332825,z:.001773772411979735},{x:.4481240212917328,y:.6527872085571289,z:.012414850294589996},{x:.5339856743812561,y:.7012367844581604,z:-.020220188423991203},{x:.5347223281860352,y:.7761190533638,z:-.05141595005989075},{x:.4315067231655121,y:.7211957573890686,z:.04381405934691429},{x:.45203351974487305,y:.7206180095672607,z:.017288070172071457},{x:.46892452239990234,y:.7265436053276062,z:.005602988880127668},{x:.49314674735069275,y:.7202282547950745,z:-.0006408205372281373},{x:.5104925632476807,y:.7091827392578125,z:-.00362918758764863},{x:.5232142210006714,y:.698553740978241,z:-.00787867046892643},{x:.5497883558273315,y:.6743605136871338,z:-.036349106580019},{x:.43658503890037537,y:.7627100348472595,z:.042555369436740875},{x:.4397648870944977,y:.6528646349906921,z:.017956094816327095},{x:.5653332471847534,y:.7992802858352661,z:-.06365057826042175},{x:.5285563468933105,y:.736810564994812,z:-.018836988136172295},{x:.4180678725242615,y:.6792560815811157,z:.12284679710865021},{x:.5328429937362671,y:.6865872144699097,z:-.010484723374247551},{x:.5230283141136169,y:.7809416055679321,z:-.011922398582100868},{x:.4551771283149719,y:.6650775074958801,z:.01774493046104908},{x:.5337203741073608,y:.7618928551673889,z:-.04697106033563614},{x:.43463975191116333,y:.8133478164672852,z:.1354849934577942},{x:.5225707292556763,y:.6605283617973328,z:.004980515688657761},{x:.5441933870315552,y:.7497199773788452,z:-.06091512367129326},{x:.4774007797241211,y:.9159183502197266,z:.059622734785079956},{x:.48068761825561523,y:.9364941716194153,z:.08404944837093353},{x:.4268292486667633,y:.7657528519630432,z:.09051097184419632},{x:.46051913499832153,y:.8880485892295837,z:.0738474428653717},{x:.4243420660495758,y:.6434382200241089,z:.06230505183339119},{x:.5342157483100891,y:.9835634231567383,z:.021662971004843712},{x:.5668109655380249,y:.8042187094688416,z:-.044937074184417725},{x:.5176341533660889,y:.7530587315559387,z:-.012967454269528389},{x:.430206298828125,y:.6835605502128601,z:.04612284153699875},{x:.4794231951236725,y:.6732114553451538,z:.003970044665038586},{x:.49073347449302673,y:.6722435355186462,z:.0008692514384165406},{x:.5294116139411926,y:.884677529335022,z:.004413890186697245},{x:.4430122375488281,y:.80235356092453,z:.04987282305955887},{x:.5603825449943542,y:1.0092442035675049,z:.026417359709739685},{x:.5186598300933838,y:.9828659892082214,z:.0513598807156086},{x:.5010536909103394,y:.9640932679176331,z:.06591596454381943},{x:.5524769425392151,y:.539441704750061,z:-.035816047340631485},{x:.5879997611045837,y:1.0091472864151,z:.02285068854689598},{x:.5016193985939026,y:.6684437990188599,z:.00028415941051207483},{x:.511952817440033,y:.6642197370529175,z:.0021144719794392586},{x:.5194343328475952,y:.6623469591140747,z:.004674181342124939},{x:.4321230351924896,y:.6496355533599854,z:.03124697133898735},{x:.508686363697052,y:.6479565501213074,z:-.00044765998609364033},{x:.4963986277580261,y:.6431032419204712,z:-.0032507688738405704},{x:.4845542013645172,y:.6430778503417969,z:-.002903624437749386},{x:.4733612537384033,y:.647506833076477,z:.00023347247042693198},{x:.4668654501438141,y:.653346598148346,z:.004762572236359119},{x:.41815051436424255,y:.633708119392395,z:.09809435904026031},{x:.47159942984580994,y:.6711485385894775,z:.007849935442209244},{x:.5734396576881409,y:.8256140351295471,z:-.03155219927430153},{x:.5306524038314819,y:.8337990641593933,z:-.018351426348090172},{x:.5371729135513306,y:.7910830974578857,z:-.037286680191755295},{x:.5549534559249878,y:.8275275826454163,z:-.030664825811982155},{x:.5597432255744934,y:.6418541669845581,z:-.03318847343325615},{x:.4958484172821045,y:.9429569244384766,z:.048340678215026855},{x:.5140507817268372,y:.9634028077125549,z:.03589847311377525},{x:.5587693452835083,y:.9951097369194031,z:.00908728688955307},{x:.46411189436912537,y:.9051855206489563,z:.10601935535669327},{x:.5181609392166138,y:.6554316878318787,z:.002546071307733655},{x:.5436590909957886,y:.7085841298103333,z:-.03844436630606651},{x:.5872187614440918,y:.9960382580757141,z:.0063423276878893375},{x:.5379653573036194,y:.9989125728607178,z:.03636329993605614},{x:.4350326955318451,y:.8088565468788147,z:.09147704392671585},{x:.5523084998130798,y:.8773422837257385,z:-.009068487212061882},{x:.5510149598121643,y:.8816931843757629,z:-.011043853126466274},{x:.5503793954849243,y:.88776695728302,z:-.01348799467086792},{x:.5501549243927002,y:.8954370617866516,z:-.012142189778387547},{x:.546072781085968,y:.9192524552345276,z:-.003157563041895628},{x:.5314661860466003,y:.8771666884422302,z:.0005075141089037061},{x:.5293324589729309,y:.8762547969818115,z:.00039177737198770046},{x:.5275698900222778,y:.8750609755516052,z:47732755774632096e-21},{x:.5104271173477173,y:.8607332110404968,z:.0012934643309563398},{x:.45938700437545776,y:.8134918212890625,z:.023569690063595772},{x:.5418947339057922,y:.6864100694656372,z:-.027333909645676613},{x:.531914234161377,y:.6456130743026733,z:-.005434140563011169},{x:.523697018623352,y:.647885262966156,z:-.0002466466394253075},{x:.5338191390037537,y:.8783687353134155,z:.002268768846988678},{x:.46226605772972107,y:.8610277771949768,z:.04718952998518944},{x:.5434442758560181,y:.6456181406974792,z:-.02327350154519081},{x:.5399754643440247,y:.940219521522522,z:.005075343884527683},{x:.5661457777023315,y:.71457839012146,z:-.06242101639509201},{x:.5523148775100708,y:.6974870562553406,z:-.04863070324063301},{x:.5639959573745728,y:.6923378109931946,z:-.05180761218070984},{x:.5367592573165894,y:.7423217296600342,z:-.03623027727007866},{x:.5853689908981323,y:.9752064943313599,z:-.002361974213272333},{x:.5835235118865967,y:.9493685960769653,z:-.003941743168979883},{x:.5615018606185913,y:.949194610118866,z:-.0015953965485095978},{x:.5068561434745789,y:.9048219323158264,z:.01862684078514576},{x:.5134067535400391,y:.7971825003623962,z:-.008485661819577217},{x:.5223897099494934,y:.925589919090271,z:.01249657291918993},{x:.48500555753707886,y:.7959478497505188,z:-.0032065745908766985},{x:.5037734508514404,y:.8184596300125122,z:-.004932103678584099},{x:.4766361117362976,y:.828806459903717,z:.01027688942849636},{x:.5589827299118042,y:.974656343460083,z:.0009666886180639267},{x:.5294582843780518,y:.7541216611862183,z:-.025603046640753746},{x:.4973002076148987,y:.9208990931510925,z:.031931452453136444},{x:.5163551568984985,y:.9432790875434875,z:.024321340024471283},{x:.49399662017822266,y:.8814862370491028,z:.018687399104237556},{x:.44948166608810425,y:.836137592792511,z:.05702034756541252},{x:.47898444533348083,y:.8836610913276672,z:.03150695189833641},{x:.4454479217529297,y:.8499438166618347,z:.08868525922298431},{x:.49572959542274475,y:.8452823758125305,z:.0036111653316766024},{x:.5362502336502075,y:.7222585678100586,z:-.027912352234125137},{x:.5393770337104797,y:.7850722074508667,z:-.05415399745106697},{x:.531399667263031,y:.7898418307304382,z:-.03883346915245056},{x:.5451627373695374,y:.7717036604881287,z:-.06480253487825394},{x:.5206395983695984,y:.6287745833396912,z:-.010521138086915016},{x:.4974782466888428,y:.6191938519477844,z:-.014098240062594414},{x:.4774145185947418,y:.6193130612373352,z:-.013643337413668633},{x:.4616098403930664,y:.6259890198707581,z:-.008448202162981033},{x:.4516478478908539,y:.6368461847305298,z:9050309745362028e-20},{x:.4485096037387848,y:.6719120740890503,z:.022984720766544342},{x:.42177659273147583,y:.7240667343139648,z:.08511673659086227},{x:.4616215229034424,y:.6988231539726257,z:.014238474890589714},{x:.4755798876285553,y:.7034608721733093,z:.00625590980052948},{x:.4924992024898529,y:.7005885243415833,z:.0009391739731654525},{x:.5082254409790039,y:.693384051322937,z:-.0009464038303121924},{x:.5203112959861755,y:.6849707961082458,z:-.0022114769089967012},{x:.52867591381073,y:.6779075860977173,z:-.002962538506835699},{x:.4213953912258148,y:.7219811677932739,z:.1350894570350647},{x:.5320829749107361,y:.794858992099762,z:-.03181503340601921},{x:.5452795028686523,y:.7286570072174072,z:-.04771539941430092},{x:.5496407747268677,y:.7866933345794678,z:-.06452003121376038},{x:.557040274143219,y:.7962084412574768,z:-.05837344378232956},{x:.549176812171936,y:.7895247936248779,z:-.057761140167713165},{x:.5362890362739563,y:.8005836606025696,z:-.026903774589300156},{x:.560200035572052,y:.7983731031417847,z:-.06172555685043335},{x:.5616944432258606,y:.8022753596305847,z:-.045200999826192856},{x:.5273328423500061,y:.6611284017562866,z:.0029021520167589188},{x:.534850537776947,y:.6660012006759644,z:-.005215510260313749},{x:.5394860506057739,y:.6701375246047974,z:-.014931917190551758},{x:.4634307324886322,y:.658291757106781,z:.009295716881752014},{x:.4538393020629883,y:.6519932150840759,z:.00930330716073513},{x:.5776031613349915,y:.7159298658370972,z:-.057365912944078445},{x:.6504855155944824,y:.6461779475212097,z:.014184834435582161},{x:.5860154032707214,y:.7962266206741333,z:-.04522843658924103},{x:.6842049360275269,y:.5631637573242188,z:.07207967340946198},{x:.6152560710906982,y:.6674962639808655,z:.0007529259892180562},{x:.6280948519706726,y:.6684326529502869,z:.0016892586136236787},{x:.6408625245094299,y:.6663892269134521,z:.005331226624548435},{x:.6557814478874207,y:.6534678936004639,z:.01646413467824459},{x:.6035663485527039,y:.6639701724052429,z:.0013799630105495453},{x:.6329053044319153,y:.608010470867157,z:-.006195899099111557},{x:.6167260408401489,y:.6117533445358276,z:-.006319951266050339},{x:.6471013426780701,y:.6112449765205383,z:-.0017843559617176652},{x:.6560901999473572,y:.6185776591300964,z:.004047257360070944},{x:.6666946411132812,y:.6651176810264587,z:.023647578433156013},{x:.6311345100402832,y:.9495396018028259,z:.014004078693687916},{x:.6544655561447144,y:.6397901773452759,z:.01809609681367874},{x:.6965808868408203,y:.6482675075531006,z:.08304904401302338},{x:.679817259311676,y:.650188148021698,z:.03632688894867897},{x:.6336516737937927,y:.7541458010673523,z:-.007742783520370722},{x:.5921701192855835,y:.8567668199539185,z:-.029399123042821884},{x:.591663658618927,y:.870215654373169,z:-.02103729173541069},{x:.6068367958068848,y:.8584195375442505,z:-.020668085664510727},{x:.6176617741584778,y:.860965371131897,z:-.009790095500648022},{x:.6040634512901306,y:.8686612844467163,z:-.015289564616978168},{x:.6143736839294434,y:.8671170473098755,z:-.005712216719985008},{x:.6373105049133301,y:.8815656900405884,z:.012672550976276398},{x:.5832505822181702,y:.7866312861442566,z:-.07051534950733185},{x:.5836675763130188,y:.7658692598342896,z:-.07566110789775848},{x:.6709531545639038,y:.604898989200592,z:.005951565690338612},{x:.6029891967773438,y:.705652117729187,z:-.013388276100158691},{x:.6131622195243835,y:.7728396058082581,z:-.036248479038476944},{x:.6123163104057312,y:.7612020373344421,z:-.03264721855521202},{x:.6696187853813171,y:.744706928730011,z:.009673702530562878},{x:.5803102254867554,y:.7385968565940857,z:-.0689152330160141},{x:.6404349207878113,y:.5877999663352966,z:-.01929756999015808},{x:.6588467955589294,y:.5929454565048218,z:-.008487257175147533},{x:.6720337867736816,y:.530631422996521,z:.043437421321868896},{x:.584305465221405,y:.6099005341529846,z:-.030301367864012718},{x:.6034283638000488,y:.6217452883720398,z:-.001970183802768588},{x:.6460927724838257,y:.8608663082122803,z:.015541625209152699},{x:.6957815289497375,y:.8326103091239929,z:.13015234470367432},{x:.6043362617492676,y:.7861682772636414,z:-.030476901680231094},{x:.594293475151062,y:.7942103147506714,z:-.032218821346759796},{x:.6324057579040527,y:.8665139675140381,z:.014255806803703308},{x:.6296147704124451,y:.8667733669281006,z:.010388285852968693},{x:.663644552230835,y:.5798642635345459,z:-.0022301070857793093},{x:.6140630841255188,y:.7809288501739502,z:-.02835679054260254},{x:.615908145904541,y:.5921698212623596,z:-.026804860681295395},{x:.617181122303009,y:.5748661756515503,z:-.03060605563223362},{x:.6222207546234131,y:.49137672781944275,z:-.011151673272252083},{x:.6669357419013977,y:.5541607141494751,z:.017466170713305473},{x:.6182981729507446,y:.5320425629615784,z:-.021793590858578682},{x:.6760554313659668,y:.595052182674408,z:.017115700989961624},{x:.6801463961601257,y:.5800720453262329,z:.043127160519361496},{x:.5922210812568665,y:.8644017577171326,z:-.02662893570959568},{x:.6054555177688599,y:.8637874722480774,z:-.018363753333687782},{x:.6161889433860779,y:.8641164898872375,z:-.008808949030935764},{x:.6017249822616577,y:.7901403307914734,z:-.028126630932092667},{x:.631446123123169,y:.8664817810058594,z:.012112865224480629},{x:.6249198913574219,y:.8716511130332947,z:.003882825840264559},{x:.6281915903091431,y:.867301881313324,z:.009891441091895103},{x:.5986843109130859,y:.7813931703567505,z:-.050227612257003784},{x:.6126407384872437,y:.869275689125061,z:-.0031255714129656553},{x:.6027271151542664,y:.8711842894554138,z:-.009324162267148495},{x:.59088134765625,y:.8742044568061829,z:-.014608660712838173},{x:.5984604358673096,y:.9216185212135315,z:-.005981989670544863},{x:.5950398445129395,y:.8964707255363464,z:-.01703473925590515},{x:.5941568613052368,y:.8882410526275635,z:-.017784785479307175},{x:.5928806662559509,y:.8803883194923401,z:-.014153128489851952},{x:.5909661054611206,y:.8748103976249695,z:-.012609979137778282},{x:.6128016710281372,y:.8702545762062073,z:-.0022550546564161777},{x:.6150846481323242,y:.8726804256439209,z:-.00414019962772727},{x:.6173093914985657,y:.8770190477371216,z:-.005970994010567665},{x:.619335412979126,y:.8814800977706909,z:-.0036864024586975574},{x:.6292637586593628,y:.8314558267593384,z:-.007714875973761082},{x:.702275276184082,y:.7320667505264282,z:.1433621346950531},{x:.6204835176467896,y:.8689177632331848,z:.0044869170524179935},{x:.6223508715629578,y:.8704851269721985,z:.00352082890458405},{x:.590448260307312,y:.8029727935791016,z:-.03200828656554222},{x:.6097423434257507,y:.7933741211891174,z:-.018042555078864098},{x:.59229576587677,y:.7993767261505127,z:-.032564569264650345},{x:.6171364188194275,y:.7153720259666443,z:-.007672437466681004},{x:.6389747858047485,y:.726390540599823,z:-.002999067772179842},{x:.6151940226554871,y:.769412100315094,z:-.024427521973848343},{x:.6526776552200317,y:.505868136882782,z:.01412637997418642},{x:.6475822329521179,y:.5375454425811768,z:-.0033899128902703524},{x:.6433356404304504,y:.5714520215988159,z:-.017428796738386154},{x:.626949667930603,y:.8962116837501526,z:.005602736957371235},{x:.5868416428565979,y:.5829002261161804,z:-.03727729618549347},{x:.5877229571342468,y:.5345035791397095,z:-.032396964728832245},{x:.5887066125869751,y:.48655083775520325,z:-.025856535881757736},{x:.6507197618484497,y:.6612282991409302,z:.011114613153040409},{x:.6803066730499268,y:.677992045879364,z:.032125361263751984},{x:.5963194370269775,y:.6598632335662842,z:.002976928371936083},{x:.667536199092865,y:.6274255514144897,z:.015618261881172657},{x:.5930740833282471,y:.6940041780471802,z:-.019217798486351967},{x:.6053346395492554,y:.7676517963409424,z:-.050308309495449066},{x:.6934473514556885,y:.6884298920631409,z:.04794462397694588},{x:.6738007664680481,y:.6934011578559875,z:.020697161555290222},{x:.6588084697723389,y:.7033141851425171,z:.008462334051728249},{x:.6346072554588318,y:.7029502391815186,z:.001542167621664703},{x:.6157816648483276,y:.6966525912284851,z:-.002009218093007803},{x:.6015574336051941,y:.688928484916687,z:-.006588225718587637},{x:.5746836066246033,y:.6711069345474243,z:-.03597589209675789},{x:.6947521567344666,y:.7309479117393494,z:.046707939356565475},{x:.6759101152420044,y:.6249120831489563,z:.021654341369867325},{x:.5794773101806641,y:.7971615195274353,z:-.06339326500892639},{x:.6041849851608276,y:.727514922618866,z:-.017512541264295578},{x:.6968844532966614,y:.6440950036048889,z:.12727996706962585},{x:.5910853147506714,y:.679325520992279,z:-.009497715160250664},{x:.6157375574111938,y:.7695677280426025,z:-.010624290443956852},{x:.6606494784355164,y:.6410489678382874,z:.0208158977329731},{x:.6040687561035156,y:.7531470656394958,z:-.045887019485235214},{x:.7012156248092651,y:.780247151851654,z:.14028730988502502},{x:.595149576663971,y:.6527782678604126,z:.006308757700026035},{x:.5925500392913818,y:.7436665892601013,z:-.060151755809783936},{x:.6780198812484741,y:.8905693888664246,z:.0626060739159584},{x:.676746666431427,y:.9113880395889282,z:.08726003766059875},{x:.7030686140060425,y:.7312687635421753,z:.09529774636030197},{x:.688987135887146,y:.8588417172431946,z:.07752864807844162},{x:.6883691549301147,y:.6109960675239563,z:.06669612973928452},{x:.6358906030654907,y:.9702065587043762,z:.023120900616049767},{x:.5781539678573608,y:.8023634552955627,z:-.044763918966054916},{x:.6170316934585571,y:.7408350706100464,z:-.011375460773706436},{x:.688542366027832,y:.6516284346580505,z:.050206027925014496},{x:.6385149359703064,y:.6540714502334595,z:.006462941411882639},{x:.6279382109642029,y:.6563615798950195,z:.003062846139073372},{x:.6268895268440247,y:.8736732006072998,z:.00627936702221632},{x:.6944946050643921,y:.7709181308746338,z:.053824134171009064},{x:.614617109298706,y:1.0022112131118774,z:.02719894051551819},{x:.6493719220161438,y:.9665167927742004,z:.053563784807920456},{x:.6624587178230286,y:.943530797958374,z:.068605437874794},{x:.6162528991699219,y:.6558693051338196,z:.002187855076044798},{x:.6058168411254883,y:.654328465461731,z:.0036193584091961384},{x:.5987918972969055,y:.6536934971809387,z:.006134530063718557},{x:.6831037402153015,y:.6195642948150635,z:.03511790186166763},{x:.6062582731246948,y:.6356398463249207,z:.001280312892049551},{x:.6174948811531067,y:.62776118516922,z:-.0013642468256875873},{x:.6297246217727661,y:.6253792643547058,z:-.0007034156005829573},{x:.6407091617584229,y:.627578616142273,z:.0028144705574959517},{x:.6479622721672058,y:.6322650909423828,z:.00750273372977972},{x:.6915091276168823,y:.5990704298019409,z:.10270945727825165},{x:.6457163095474243,y:.6504453420639038,z:.010696077719330788},{x:.6164222955703735,y:.8231936097145081,z:-.016772059723734856},{x:.6042401194572449,y:.7830976843833923,z:-.03630910441279411},{x:.5922216773033142,y:.8228387236595154,z:-.029992375522851944},{x:.6646111011505127,y:.92097008228302,z:.050967294722795486},{x:.651232898235321,y:.9460107088088989,z:.038000158965587616},{x:.6140977144241333,y:.9882472157478333,z:.009882091544568539},{x:.6870781183242798,y:.8768675327301025,z:.10980932414531708},{x:.5986856818199158,y:.6456438899040222,z:.003999010659754276},{x:.585981547832489,y:.7034481763839722,z:-.0377722829580307},{x:.6342031359672546,y:.9867448806762695,z:.03786521404981613},{x:.7013950943946838,y:.776049017906189,z:.09598205983638763},{x:.6030206680297852,y:.8719133138656616,z:-.007931148633360863},{x:.6050592064857483,y:.8767156004905701,z:-.009791925549507141},{x:.6073468923568726,y:.8831382393836975,z:-.012361008673906326},{x:.6087977290153503,y:.890143632888794,z:-.01098148338496685},{x:.6147705316543579,y:.9110084772109985,z:-.0018823575228452682},{x:.622577965259552,y:.8670604825019836,z:.002609190298244357},{x:.6241236329078674,y:.8651344180107117,z:.0025534380692988634},{x:.6257084608078003,y:.8638408184051514,z:.0023300074972212315},{x:.639931321144104,y:.8449671268463135,z:.0038123116828501225},{x:.6810906529426575,y:.7856625318527222,z:.02717764675617218},{x:.583532452583313,y:.6811994910240173,z:-.026588857173919678},{x:.5855660438537598,y:.6393819451332092,z:-.004512844607234001},{x:.5932201743125916,y:.6398029327392578,z:.0008020466193556786},{x:.6200879812240601,y:.8683351874351501,z:.00417016725987196},{x:.6842559576034546,y:.8330534100532532,z:.050836317241191864},{x:.5754412412643433,y:.6418221592903137,z:-.022838059812784195},{x:.6232790350914001,y:.9295297265052795,z:.006339520215988159},{x:.5764067769050598,y:.694546639919281,z:-.04825803264975548},{x:.59778892993927,y:.7343927621841431,z:-.035004377365112305},{x:.6042810678482056,y:.9441440105438232,z:-.0010970570147037506},{x:.6496372222900391,y:.8869078159332275,z:.021036235615611076},{x:.6274012327194214,y:.7830310463905334,z:-.006658440921455622},{x:.637792706489563,y:.9104999899864197,z:.014290250837802887},{x:.6549934148788452,y:.7748609185218811,z:-.0006672973395325243},{x:.6404005289077759,y:.801220715045929,z:-.0026642554439604282},{x:.6671456694602966,y:.8045546412467957,z:.013180811889469624},{x:.6107483506202698,y:.9680658578872681,z:.001778992242179811},{x:.6060343980789185,y:.744587242603302,z:-.024382334202528},{x:.6602751612663269,y:.8998945355415344,z:.0344940721988678},{x:.6463775038719177,y:.9262562394142151,z:.02617623284459114},{x:.6579852104187012,y:.8602304458618164,z:.021586716175079346},{x:.6926165223121643,y:.8053340315818787,z:.061075080186128616},{x:.6724731922149658,y:.8594399690628052,z:.03457934781908989},{x:.6975721716880798,y:.8183245062828064,z:.09300774335861206},{x:.6512877941131592,y:.8258221745491028,z:.006324059329926968},{x:.594887375831604,y:.7148372530937195,z:-.026898479089140892},{x:.6017440557479858,y:.7773507833480835,z:-.05312420800328255},{x:.6096571683883667,y:.7806998491287231,z:-.037646256387233734},{x:.5952993035316467,y:.7654367685317993,z:-.06398405134677887},{x:.5950021147727966,y:.6201304793357849,z:-.009297547861933708},{x:.6165438890457153,y:.6052900552749634,z:-.012455573305487633},{x:.6362661719322205,y:.6015968918800354,z:-.011649220250546932},{x:.6522727608680725,y:.6046400666236877,z:-.005903332494199276},{x:.6625409722328186,y:.6128141283988953,z:.0030042496509850025},{x:.6688099503517151,y:.6457712054252625,z:.026322703808546066},{x:.7013440728187561,y:.6893666386604309,z:.08984331786632538},{x:.6608623266220093,y:.6749406456947327,z:.0172116681933403},{x:.6482325196266174,y:.6823726296424866,z:.008881398476660252},{x:.6313265562057495,y:.6842025518417358,z:.0031308617908507586},{x:.6147016286849976,y:.6809731721878052,z:.0007630771724507213},{x:.6018834114074707,y:.6755372285842896,z:-.0008834321051836014},{x:.5925027132034302,y:.670681357383728,z:-.001968748401850462},{x:.700127363204956,y:.6871103644371033,z:.13980500400066376},{x:.6095665693283081,y:.7853189706802368,z:-.03074747882783413},{x:.5880423784255981,y:.7229287028312683,z:-.04691500961780548},{x:.5930182337760925,y:.7811514139175415,z:-.06398335844278336},{x:.5867722034454346,y:.7922660112380981,z:-.05794971063733101},{x:.5933279991149902,y:.7842848896980286,z:-.05714067071676254},{x:.6063535809516907,y:.7920218706130981,z:-.02590685710310936},{x:.5839452743530273,y:.794978141784668,z:-.0615212507545948},{x:.5828126072883606,y:.8000800013542175,z:-.0449722595512867},{x:.5909603834152222,y:.6541213393211365,z:.003991890233010054},{x:.5852181911468506,y:.6602938771247864,z:-.004428438376635313},{x:.5825737714767456,y:.6651063561439514,z:-.014345290139317513},{x:.6517343521118164,y:.6362385153770447,z:.012151890434324741},{x:.6615052819252014,y:.6281577944755554,z:.0123682152479887},{x:.4856873154640198,y:.6568945646286011,z:.000720038078725338},{x:.49988406896591187,y:.6547410488128662,z:.0006949726957827806},{x:.48438939452171326,y:.6392973065376282,z:.000705525919329375},{x:.47143134474754333,y:.6589511632919312,z:.0006980331381782889},{x:.48704618215560913,y:.6752797961235046,z:.0006921177846379578},{x:.6243702173233032,y:.640461802482605,z:-6592126737814397e-20},{x:.6390967965126038,y:.6385173797607422,z:-.00016105435497593135},{x:.6230536699295044,y:.6224825382232666,z:-.00016136496560648084},{x:.6095397472381592,y:.641917884349823,z:-.0001803556369850412},{x:.6250996589660645,y:.6586247682571411,z:-.0001785515050869435}]],faceBlendshapes:[{categories:[{index:0,score:5187174338061595e-21,categoryName:"_neutral",displayName:""},{index:1,score:.24521504342556,categoryName:"browDownLeft",displayName:""},{index:2,score:.1987743377685547,categoryName:"browDownRight",displayName:""},{index:3,score:.013400448486208916,categoryName:"browInnerUp",displayName:""},{index:4,score:.012361560948193073,categoryName:"browOuterUpLeft",displayName:""},{index:5,score:.019305096939206123,categoryName:"browOuterUpRight",displayName:""},{index:6,score:28426356948330067e-21,categoryName:"cheekPuff",displayName:""},{index:7,score:3.4500112633395474e-7,categoryName:"cheekSquintLeft",displayName:""},{index:8,score:4.83789051486383e-7,categoryName:"cheekSquintRight",displayName:""},{index:9,score:.07650448381900787,categoryName:"eyeBlinkLeft",displayName:""},{index:10,score:.05070012807846069,categoryName:"eyeBlinkRight",displayName:""},{index:11,score:.13978900015354156,categoryName:"eyeLookDownLeft",displayName:""},{index:12,score:.14198613166809082,categoryName:"eyeLookDownRight",displayName:""},{index:13,score:.2177766114473343,categoryName:"eyeLookInLeft",displayName:""},{index:14,score:.014739357866346836,categoryName:"eyeLookInRight",displayName:""},{index:15,score:.02361512929201126,categoryName:"eyeLookOutLeft",displayName:""},{index:16,score:.19679604470729828,categoryName:"eyeLookOutRight",displayName:""},{index:17,score:.04874616861343384,categoryName:"eyeLookUpLeft",displayName:""},{index:18,score:.049392376095056534,categoryName:"eyeLookUpRight",displayName:""},{index:19,score:.34944331645965576,categoryName:"eyeSquintLeft",displayName:""},{index:20,score:.2939716875553131,categoryName:"eyeSquintRight",displayName:""},{index:21,score:.005955042317509651,categoryName:"eyeWideLeft",displayName:""},{index:22,score:.006776117719709873,categoryName:"eyeWideRight",displayName:""},{index:23,score:16942436559475027e-21,categoryName:"jawForward",displayName:""},{index:24,score:.0045165494084358215,categoryName:"jawLeft",displayName:""},{index:25,score:.07803940027952194,categoryName:"jawOpen",displayName:""},{index:26,score:2090057751047425e-20,categoryName:"jawRight",displayName:""},{index:27,score:.06032035872340202,categoryName:"mouthClose",displayName:""},{index:28,score:.00228882092051208,categoryName:"mouthDimpleLeft",displayName:""},{index:29,score:.00781762320548296,categoryName:"mouthDimpleRight",displayName:""},{index:30,score:.0017093931091949344,categoryName:"mouthFrownLeft",displayName:""},{index:31,score:.0019319106359034777,categoryName:"mouthFrownRight",displayName:""},{index:32,score:8485237776767462e-20,categoryName:"mouthFunnel",displayName:""},{index:33,score:.0009051355300471187,categoryName:"mouthLeft",displayName:""},{index:34,score:.0003630454302765429,categoryName:"mouthLowerDownLeft",displayName:""},{index:35,score:.00017601238505449146,categoryName:"mouthLowerDownRight",displayName:""},{index:36,score:.12865161895751953,categoryName:"mouthPressLeft",displayName:""},{index:37,score:.20137207210063934,categoryName:"mouthPressRight",displayName:""},{index:38,score:.0022203284315764904,categoryName:"mouthPucker",displayName:""},{index:39,score:.0009096377179957926,categoryName:"mouthRight",displayName:""},{index:40,score:.34189721941947937,categoryName:"mouthRollLower",displayName:""},{index:41,score:.11409689486026764,categoryName:"mouthRollUpper",displayName:""},{index:42,score:.17172536253929138,categoryName:"mouthShrugLower",displayName:""},{index:43,score:.004038424696773291,categoryName:"mouthShrugUpper",displayName:""},{index:44,score:.00023205230536404997,categoryName:"mouthSmileLeft",displayName:""},{index:45,score:.00019313619122840464,categoryName:"mouthSmileRight",displayName:""},{index:46,score:.0018571305554360151,categoryName:"mouthStretchLeft",displayName:""},{index:47,score:.0023813238367438316,categoryName:"mouthStretchRight",displayName:""},{index:48,score:24323100660694763e-21,categoryName:"mouthUpperUpLeft",displayName:""},{index:49,score:3161552012898028e-20,categoryName:"mouthUpperUpRight",displayName:""},{index:50,score:1.08198406678639e-7,categoryName:"noseSneerLeft",displayName:""},{index:51,score:12652527630052646e-22,categoryName:"noseSneerRight",displayName:""}],headIndex:-1,headName:""}],facialTransformationMatrixes:[{rows:4,columns:4,data:[.9947517514228821,.10230544209480286,.0013679931871592999,0,-.10230997204780579,.9947447776794434,.003816320328041911,0,-.000970348424743861,-.0039362297393381596,.9999914169311523,0,2.8888821601867676,-7.808934211730957,-30.52109146118164,1]}]}},NC=(0,i.createContext)({}),zC={basePath:"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.17/wasm",options:{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",delegate:"GPU"},runningMode:"VIDEO",outputFaceBlendshapes:!0,outputFacialTransformationMatrixes:!0}},GC=(0,i.forwardRef)((({basePath:e=zC.basePath,options:t=zC.options,children:r},s)=>{const a=JSON.stringify(t),o=(0,Cs.DY)((async()=>{const{FilesetResolver:r,FaceLandmarker:i}=await n.e(3260).then(n.bind(n,3260)),s=await r.forVisionTasks(e);return i.createFromOptions(s,t)}),[e,a]);return(0,i.useEffect)((()=>()=>{null==o||o.close(),(0,Cs.IU)([e,a])}),[o,e,a]),(0,i.useImperativeHandle)(s,(()=>o),[o]),i.createElement(NC.Provider,{value:o},r)}));function HC(){return(0,i.useContext)(NC)}function qC(e,t){return e.clone().add(t).multiplyScalar(.5)}function YC(e,t,n){const r=e.localToWorld(t);return n.worldToLocal(r)}const jC=(0,i.createContext)({}),VC=(0,i.forwardRef)((({camera:e,videoTexture:t={start:!0},manualDetect:n=!1,faceLandmarkerResult:s,manualUpdate:l=!1,makeDefault:c,smoothTime:h=.25,offset:u=!0,offsetScalar:d=80,eyes:f=!1,eyesAsOrigin:A=!0,depth:m=.15,debug:p=!1,facemesh:g},v)=>{var y,E;const x=(0,o.A)((e=>e.scene)),C=(0,o.A)((e=>e.camera)),w=(0,o.A)((e=>e.set)),I=(0,o.A)((e=>e.get)),b=e||C,S=(0,i.useRef)(null),[B]=(0,i.useState)((()=>new a.B69)),[T]=(0,i.useState)((()=>new a.Pq0)),[_]=(0,i.useState)((()=>new a.Pq0)),[M]=(0,i.useState)((()=>new a.Pq0)),[R]=(0,i.useState)((()=>new a.Pq0)),D=(0,i.useCallback)((()=>{B.parent=b.parent;const e=S.current;if(e){const{outerRef:t,eyeRightRef:n,eyeLeftRef:r}=e;if(n.current&&r.current){const{irisDirRef:e}=n.current,{irisDirRef:i}=r.current;e.current&&i.current&&t.current&&(T.copy(YC(e.current,new a.Pq0(0,0,0),t.current)),_.copy(YC(i.current,new a.Pq0(0,0,0),t.current)),B.position.copy(YC(t.current,qC(T,_),b.parent||x)),M.copy(YC(e.current,new a.Pq0(0,0,1),t.current)),R.copy(YC(i.current,new a.Pq0(0,0,1),t.current)),B.lookAt(t.current.localToWorld(qC(M,R))))}else t.current&&(B.position.copy(YC(t.current,new a.Pq0(0,0,0),b.parent||x)),B.lookAt(t.current.localToWorld(new a.Pq0(0,0,1))))}return B}),[b,_,R,T,M,x,B]),[P]=(0,i.useState)((()=>new a.B69)),L=(0,i.useCallback)((function(e,t){if(b){var n;if(null!==(n=t)&&void 0!==n||(t=D()),h>0){const n=1e-9;Mn.damp3(P.position,t.position,h,e,void 0,void 0,n),Mn.dampE(P.rotation,t.rotation,h,e,void 0,void 0,n)}else P.position.copy(t.position),P.rotation.copy(t.rotation);b.position.copy(P.position),b.rotation.copy(P.rotation)}}),[b,D,h,P.position,P.rotation]);(0,o.C)(((e,t)=>{l||L(t)}));const k=(0,i.useRef)(null),[F,O]=(0,i.useState)(),U=HC(),Q=(0,i.useCallback)(((e,t)=>{const n=k.current;if(!n)return;const r=n.source.data,i=null==U?void 0:U.detectForVideo(r,e);O(i)}),[U]),N=(0,i.useMemo)((()=>Object.assign(Object.create(a.Qev.prototype),{computeTarget:D,update:L,facemeshApiRef:S})),[D,L]);(0,i.useImperativeHandle)(v,(()=>N),[N]),(0,i.useEffect)((()=>{if(c){const e=I().controls;return w({controls:N}),()=>w({controls:e})}}),[c,N,I,w]);const z=null!=s?s:F,G=null==z?void 0:z.faceLandmarks[0],H=null==z||null==(y=z.facialTransformationMatrixes)?void 0:y[0],q=null==z||null==(E=z.faceBlendshapes)?void 0:E[0],Y={onVideoFrame:Q,...t};return i.createElement(jC.Provider,{value:N},!n&&i.createElement(i.Suspense,{fallback:null},"src"in Y?i.createElement(cf,(0,r.A)({ref:k},Y)):i.createElement(PC,(0,r.A)({ref:k},Y))),i.createElement(FC,(0,r.A)({ref:S,children:i.createElement("meshNormalMaterial",{side:a.$EB})},g,{points:G,depth:m,facialTransformationMatrix:H,faceBlendshapes:q,eyes:f,eyesAsOrigin:A,offset:u,offsetScalar:d,debug:p,"rotation-z":Math.PI,visible:p})))})),KC=()=>(0,i.useContext)(jC)},6571:function(e){var t;e.exports=((t=function(){function e(e){return i.appendChild(e.dom),e}function n(e){for(var t=0;t<i.children.length;t++)i.children[t].style.display=t===e?"block":"none";r=e}var r=0,i=document.createElement("div");i.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",i.addEventListener("click",(function(e){e.preventDefault(),n(++r%i.children.length)}),!1);var s=(performance||Date).now(),a=s,o=0,l=e(new t.Panel("FPS","#0ff","#002")),c=e(new t.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=e(new t.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:i,addPanel:e,showPanel:n,begin:function(){s=(performance||Date).now()},end:function(){o++;var e=(performance||Date).now();if(c.update(e-s,200),e>a+1e3&&(l.update(1e3*o/(e-a),100),a=e,o=0,h)){var t=performance.memory;h.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e},update:function(){s=this.end()},domElement:i,setMode:n}}).Panel=function(e,t,n){var r=1/0,i=0,s=Math.round,a=s(window.devicePixelRatio||1),o=80*a,l=48*a,c=3*a,h=2*a,u=3*a,d=15*a,f=74*a,A=30*a,m=document.createElement("canvas");m.width=o,m.height=l,m.style.cssText="width:80px;height:48px";var p=m.getContext("2d");return p.font="bold "+9*a+"px Helvetica,Arial,sans-serif",p.textBaseline="top",p.fillStyle=n,p.fillRect(0,0,o,l),p.fillStyle=t,p.fillText(e,c,h),p.fillRect(u,d,f,A),p.fillStyle=n,p.globalAlpha=.9,p.fillRect(u,d,f,A),{dom:m,update:function(l,g){r=Math.min(r,l),i=Math.max(i,l),p.fillStyle=n,p.globalAlpha=1,p.fillRect(0,0,o,d),p.fillStyle=t,p.fillText(s(l)+" "+e+" ("+s(r)+"-"+s(i)+")",c,h),p.drawImage(m,u+a,d,f-a,A,u,d,f-a,A),p.fillRect(u+f-a,d,a,A),p.fillStyle=n,p.globalAlpha=.9,p.fillRect(u+f-a,d,a,s((1-l/g)*A))}}},t)}}]);
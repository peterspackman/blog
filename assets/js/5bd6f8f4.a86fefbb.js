"use strict";(globalThis.webpackChunkblog=globalThis.webpackChunkblog||[]).push([[6092],{706:(e,t,n)=>{n.d(t,{A:()=>a});var o=n(6540),r=n(2130),i=n(4848);const a=({math:e,inline:t=!0})=>{const n=(0,o.useRef)(null);return(0,o.useEffect)(()=>{n.current&&r.Ay.render(e,n.current,{throwOnError:!1,displayMode:!t})},[e,t]),(0,i.jsx)("span",{ref:n})}},5949:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Te});var o=n(6540),r=n(1656),i=n(5293),a=n(8478);const s="container_gymj",l="title__8gm",c="mainGrid_f6kP",u="realSpacePanel_yZQz",d="reciprocalPanel_mXBL",m="settingsPanel_FviN",f="panelHeader_M5eB",h="panelTitle_MhUp",p="viewTabs_aR01",x="viewTab_hmmS",g="viewTabActive_Apby",b="panelContent_at6S",y="viewerContainer_ksrQ",v="sliceControls_B3D2",C="sliceLabel_AJ1I",M="sliceSlider_Kj4O",S="sliceValue_xLec",w="sliceButtons_tzoH",k="sliceButton_UfQN",R="sliceButtonActive_tfz4",T="displayModeToggle_zBpt",_="explanationContainer_eg_k",j="explanationTitle_TnyA",D="explanationText_hCCT",F="explanationList_eLg1",A="explanationListItem_jqAq",E="explanationNote_t8Tt";var P=n(5098);const N=1.5406,z=.7107,I={Na:[4.7626,3.285,3.1736,8.8422,1.2674,.3136,1.1128,129.424,.676],Cl:[11.4604,.0104,7.1964,1.1662,6.2556,18.5194,1.6455,47.7784,-9.5574],C:[2.31,20.8439,1.02,10.2075,1.5886,.5687,.865,51.6512,.2156],O:[3.0485,13.2771,2.2868,5.7011,1.5463,.3239,.867,32.9089,.2508],Fe:[11.7695,4.7611,7.3573,.3072,3.5222,15.3535,2.3045,76.8805,1.0369],Si:[6.2915,2.4386,3.0353,32.3337,1.9891,.6785,1.541,81.6937,1.1407],Ca:[8.6266,10.4421,7.3873,.6599,1.5899,85.7484,1.0211,178.437,1.3751],K:[8.2186,12.7949,7.4398,.7748,1.0519,213.187,.8659,41.6841,1.4228],Cs:[20.3892,3.569,19.1062,.3107,10.662,24.3879,1.4953,213.904,3.3352],I:[20.1472,4.347,18.9949,.3814,7.5138,27.766,2.2735,66.8776,4.0712],Ba:[20.1807,3.21,19.1136,.2855,10.9054,20.0558,.7763,51.746,3.029],Ti:[9.7595,7.8508,7.3558,.5,1.6991,35.6338,1.9021,116.105,1.2807],O_minus2:[4.758,7.8313,3.637,30.0505,0,0,0,0,1.594]},L=[3,15,2,5,1.5,.5,1,40,.5];function B(e,t){const n=I[e]||L,o=t*t;let r=n[8];for(let i=0;i<4;i++){const e=n[2*i],t=n[2*i+1];r+=e*Math.exp(-t*o)}return r}function $(e,t,n,o){const r=e*e+t*t+n*n;if(0===r)return 1/0;const{a:i,b:a,c:s,latticeType:l}=o;switch(l){case"cubic":case"fcc":case"bcc":default:return i/Math.sqrt(r);case"tetragonal":const o=s||i;return 1/Math.sqrt((e*e+t*t)/(i*i)+n*n/(o*o));case"orthorhombic":const l=a||i,c=s||i;return 1/Math.sqrt(e*e/(i*i)+t*t/(l*l)+n*n/(c*c))}}function W(e,t){if(e===1/0||0===e)return NaN;const n=t/(2*e);return Math.abs(n)>1?NaN:2*Math.asin(n)*180/Math.PI}function U(e,t){return{re:e.re+t.re,im:e.im+t.im}}function G(e){return e.re*e.re+e.im*e.im}function O(e,t,n,o,r,i=0){const a=W($(e,t,n,o),r),s=isNaN(a)?0:Math.sin(a*Math.PI/360)/r,l=i>0?Math.exp(-i*s*s):1;let c={re:0,im:0};for(const u of o.atoms){const[o,r,i]=u.position,a=2*Math.PI*(e*o+t*r+n*i),d=B(u.element,s)*l,m={re:Math.cos(a),im:Math.sin(a)};c=U(c,{re:d*m.re,im:d*m.im})}return c}function H(e,t,n,o){return!function(e,t,n,o){const{latticeType:r,spaceGroup:i}=o;if("fcc"===r||i.includes("F")){const o=t%2;if(e%2!==o||o!==n%2)return!0}if(("bcc"===r||i.includes("I"))&&(e+t+n)%2!=0)return!0;if("Pbca"===i){if(0===e&&t%2!=0)return!0;if(0===t&&n%2!=0)return!0;if(0===n&&e%2!=0)return!0}return!1}(e,t,n,o)}function X(e,t,n){const o=[Math.abs(e),Math.abs(t),Math.abs(n)].sort((e,t)=>t-e),[r,i,a]=o;return 0===r&&0===i&&0===a?1:r===i&&i===a?8:r===i||i===a?24:0!==r&&0!==i&&0!==a?48:0===a&&r===i?12:24}function q(e,t,n){return`(${e}${t}${n})`}var K=n(4848);const V=({width:e,height:t,reflections:n,wavelength:r,peakWidth:i,showLabels:a,twoThetaRange:s,selectedReflection:l,onSelectReflection:c,theme:u})=>{const d=(0,o.useRef)(null);return(0,o.useEffect)(()=>{if(!d.current)return;const e=P.Ts(d.current),t=u.text.startsWith("#e")||u.text.startsWith("#f"),o=function(e,t,n,o=500){const[r,i]=n,a=(i-r)/o,s=[];for(let l=0;l<=o;l++){const n=r+l*a;let o=0;for(const a of e)if(a.twoTheta>=r&&a.twoTheta<=i){const e=n-a.twoTheta,r=t/2.355;o+=a.intensity*Math.exp(-e*e/(2*r*r))}s.push([n,o])}return s}(n,i,s),m=Math.max(...n.map(e=>e.intensity),...o.map(e=>e[1]),1),f=[];f.push({name:"Pattern",type:"line",data:o,smooth:!1,lineStyle:{width:1.5,color:t?"#6b9eff":"#2563eb"},areaStyle:{color:t?"rgba(107, 158, 255, 0.2)":"rgba(37, 99, 235, 0.15)"},symbol:"none",animation:!1});const h=n.filter(e=>e.twoTheta>=s[0]&&e.twoTheta<=s[1]).map(e=>({xAxis:e.twoTheta,lineStyle:{color:l&&e.h===l[0]&&e.k===l[1]&&e.l===l[2]?t?"#fbbf24":"#d97706":t?"rgba(255,255,255,0.3)":"rgba(0,0,0,0.2)",width:l&&e.h===l[0]&&e.k===l[1]&&e.l===l[2]?2:1,type:"solid"},label:{show:a&&e.intensity>5,formatter:q(e.h,e.k,e.l),position:"end",color:u.textMuted,fontSize:9,rotate:90,offset:[0,-5]}}));f.push({name:"Peaks",type:"line",data:[],markLine:{silent:!1,symbol:"none",data:h,animation:!1}});const p=n.filter(e=>e.twoTheta>=s[0]&&e.twoTheta<=s[1]).map(e=>({value:[e.twoTheta,e.intensity],itemStyle:{color:l&&e.h===l[0]&&e.k===l[1]&&e.l===l[2]?t?"#fbbf24":"#d97706":t?"#6b9eff":"#2563eb"},data:{h:e.h,k:e.k,l:e.l}}));f.push({name:"Peak positions",type:"scatter",data:p,symbolSize:8,animation:!1});const x={animation:!1,grid:{left:50,right:20,top:30,bottom:45},title:{text:`Powder Pattern (\u03bb = ${r.toFixed(4)} \xc5)`,left:"center",top:5,textStyle:{color:u.text,fontSize:12,fontWeight:"bold"}},tooltip:{trigger:"item",formatter:e=>{if("markLine"===e.componentType)return"";if("Peak positions"===e.seriesName){const t=e.value[0],o=(e.value[1],n.find(e=>Math.abs(e.twoTheta-t)<.01));if(o)return`\n                                <strong>${q(o.h,o.k,o.l)}</strong><br/>\n                                2\u03b8 = ${o.twoTheta.toFixed(2)}\xb0<br/>\n                                d = ${o.dSpacing.toFixed(3)} \xc5<br/>\n                                I = ${o.intensity.toFixed(1)}\n                            `}return`2\u03b8 = ${e.value[0].toFixed(2)}\xb0<br/>I = ${e.value[1].toFixed(1)}`}},xAxis:{type:"value",name:"2\u03b8 (degrees)",nameLocation:"middle",nameGap:30,min:s[0],max:s[1],axisLabel:{color:u.textMuted,fontSize:10},axisLine:{lineStyle:{color:u.textMuted}},splitLine:{show:!0,lineStyle:{color:t?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}},nameTextStyle:{color:u.text,fontSize:11}},yAxis:{type:"value",name:"Intensity",nameLocation:"middle",nameGap:35,min:0,max:1.1*m,axisLabel:{color:u.textMuted,fontSize:10,formatter:e=>e.toFixed(0)},axisLine:{lineStyle:{color:u.textMuted}},splitLine:{show:!0,lineStyle:{color:t?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}},nameTextStyle:{color:u.text,fontSize:11}},series:f};e.setOption(x),e.on("click",e=>{if("Peak positions"===e.seriesName&&c){const t=e.value[0],o=n.find(e=>Math.abs(e.twoTheta-t)<.01);o&&c([o.h,o.k,o.l])}});const g=()=>e.resize();return window.addEventListener("resize",g),()=>{window.removeEventListener("resize",g),e.off("click"),e.dispose()}},[e,t,n,r,i,a,s,l,c,u]),(0,K.jsx)("div",{ref:d,style:{width:e,height:t,borderRadius:"4px",border:`1px solid ${u.border}`,backgroundColor:u.surface||u.inputBg}})},Y=({width:e,height:t,structure:n,reflections:r,plane:i,maxIndex:a,showAbsences:s,selectedReflection:l,onSelectReflection:c,theme:u,viewMode:d="reciprocal",wavelength:m=1.5406,detectorDistance:f=100,oscillationRange:h=2,twoThetaMax:p=120,bFactor:x=0})=>{const g=(0,o.useRef)(null),b=(0,o.useRef)(null),y=(0,o.useRef)(null),v=(0,o.useRef)(null),C=(0,o.useRef)([]),[M,S]=(0,o.useState)(1),[w,k]=(0,o.useState)({x:0,y:0}),R=(0,o.useRef)(!1),T=(0,o.useRef)({x:0,y:0}),[_,j]=(0,o.useState)(0),[D,F]=(0,o.useState)(!1),A=(0,o.useRef)(0),E=u.text.startsWith("#e")||u.text.startsWith("#f"),P=(0,o.useCallback)(()=>{switch(i){case"hk0":return{xLabel:"h",yLabel:"k",fixedIndex:2,fixedLabel:"l=0"};case"h0l":return{xLabel:"h",yLabel:"l",fixedIndex:1,fixedLabel:"k=0"};case"0kl":return{xLabel:"k",yLabel:"l",fixedIndex:0,fixedLabel:"h=0"}}},[i]),N=(0,o.useCallback)((e,t)=>{switch(i){case"hk0":return[e,t,0];case"h0l":return[e,0,t];case"0kl":return[0,e,t]}},[i]),z=(0,o.useMemo)(()=>{const e=new Map;for(const t of r){const n=[Math.abs(t.h),Math.abs(t.k),Math.abs(t.l)].sort((e,t)=>t-e),o=`${n[0]},${n[1]},${n[2]}`;e.has(o)||e.set(o,t.intensity)}return e},[r]),I=(0,o.useCallback)((e,t,n)=>{const o=[Math.abs(e),Math.abs(t),Math.abs(n)].sort((e,t)=>t-e),r=`${o[0]},${o[1]},${o[2]}`,i=z.get(r);return void 0!==i?i:0},[z]),L=(0,o.useMemo)(()=>{if("detector"!==d)return[];const o=[],r=1/m,s=1/n.a,l=h*Math.PI/180,c=(Math.min(e,t)-80)/2;for(let e=-a;e<=a;e++)for(let t=-a;t<=a;t++){if(0===e&&0===t)continue;const[a,u,d]=N(e,t),h=H(Math.abs(a),Math.abs(u),Math.abs(d),n),p=a*s,x=u*s,g=d*s,b=Math.sqrt(p*p+x*x+g*g),y=m/(2*(1/b));if(Math.abs(y)>1)continue;const v=Math.asin(y),C=2*v,M=Math.sqrt(("0kl"===i?0:a*a)*s*s+("h0l"===i?0:u*u)*s*s+("hk0"===i?0:d*d)*s*s),S=2*r*Math.sin(v),w=l*r*2,k=Math.abs(M-S)<w;if(!h||!k)continue;const R=Math.tan(C),T=Math.atan2(t,e),_=Math.PI/3,j=100/f,D=.85*c/Math.tan(_),F=R*Math.cos(T)*D*j,A=-R*Math.sin(T)*D*j,E=I(a,u,d),P=2.5,z=1+.15*C;o.push({x:F,y:A,radius:P,elongation:z,intensity:E,angle:T,h:a,k:u,l:d})}return o},[d,m,n,a,i,N,I,f,h,e,t]);(0,o.useEffect)(()=>{if("detector"!==d)return;const e=b.current;if(!e)return;const t=e.getContext("webgl");if(!t)return;const n=t.createShader(t.VERTEX_SHADER);t.shaderSource(n,"\n    attribute vec2 a_position;\n    varying vec2 v_uv;\n    void main() {\n        gl_Position = vec4(a_position, 0.0, 1.0);\n        v_uv = (a_position + 1.0) / 2.0;\n    }\n"),t.compileShader(n);const o=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(o,"\n    precision highp float;\n    varying vec2 v_uv;\n\n    uniform vec2 u_resolution;\n    uniform float u_zoom;\n    uniform vec2 u_pan;\n    uniform int u_numSpots;\n    uniform sampler2D u_spotData;\n    uniform float u_dataSize;\n    uniform float u_maxIntensity;\n    uniform int u_isDark;\n    uniform float u_beamStopRadius;\n    uniform float u_powderSmear; // 0 = single crystal, 1 = full powder rings\n\n    #define PI 3.14159265359\n\n    // Draw a Gaussian spot, optionally smeared into an arc/ring\n    float gaussianSpot(vec2 pos, vec2 center, vec2 spotCenter, float radius, float elongation, float angle, float smear) {\n        float spotDistFromCenter = length(spotCenter - center);\n        float posDistFromCenter = length(pos - center);\n\n        if (smear < 0.01) {\n            // Normal spot rendering - sharp Gaussian\n            vec2 delta = pos - spotCenter;\n            float c = cos(angle);\n            float s = sin(angle);\n            vec2 rotated = vec2(c * delta.x + s * delta.y, -s * delta.x + c * delta.y);\n            rotated.x /= elongation;\n            float dist = length(rotated);\n            // Sharp falloff - spots are tight points\n            return exp(-dist * dist / (radius * radius * 0.15));\n        } else {\n            // Smear into arc/ring - keep ring width tight\n            float radialDiff = abs(posDistFromCenter - spotDistFromCenter);\n            // Thin ring\n            float ringWidth = radius * 0.6;\n            float radialContrib = exp(-radialDiff * radialDiff / (ringWidth * ringWidth * 0.15));\n\n            // Angular component - spot spreads around the ring\n            float spotAngle = atan(spotCenter.y - center.y, spotCenter.x - center.x);\n            float posAngle = atan(pos.y - center.y, pos.x - center.x);\n            float angleDiff = abs(mod(posAngle - spotAngle + PI, 2.0 * PI) - PI);\n\n            // Angular spread increases with smear\n            float angularSpread = smear * PI * 0.8;\n            float angularContrib;\n            if (smear > 0.95) {\n                // Full ring - uniform around circumference\n                angularContrib = 1.0;\n            } else {\n                angularContrib = exp(-angleDiff * angleDiff / (angularSpread * angularSpread * 0.5));\n            }\n\n            // Scale by circumference to conserve total intensity\n            // As ring spreads, intensity per unit arc decreases\n            float circumScale = 1.0 / (1.0 + smear * spotDistFromCenter * 0.02);\n\n            return radialContrib * angularContrib * circumScale;\n        }\n    }\n\n    void main() {\n        vec2 center = u_resolution / 2.0;\n\n        // Apply zoom and pan\n        vec2 pos = (v_uv - 0.5) * u_resolution;\n        pos = pos / u_zoom + u_pan;\n        pos = pos + center;\n\n        // Distance from center\n        float distFromCenter = length(pos - center);\n        float maxRadius = min(u_resolution.x, u_resolution.y) * 0.45;\n\n        // Theme-aware colors: light mode = white bg, black spots; dark mode = black bg, white spots\n        vec3 bgColor = u_isDark == 1 ? vec3(0.02, 0.02, 0.04) : vec3(0.98, 0.98, 0.97);\n        vec3 spotColor = u_isDark == 1 ? vec3(1.0, 1.0, 1.0) : vec3(0.0, 0.0, 0.0);\n        vec3 borderColor = u_isDark == 1 ? vec3(0.15) : vec3(0.85);\n        vec3 edgeColor = u_isDark == 1 ? vec3(0.3) : vec3(0.7);\n        vec3 color = bgColor;\n\n        // Only render within detector circle\n        if (distFromCenter < maxRadius) {\n            // Beam stop - contrasting color\n            if (distFromCenter < u_beamStopRadius) {\n                color = u_isDark == 1 ? vec3(0.0) : vec3(0.5);\n            } else {\n                // Accumulate spot contributions (counts)\n                float totalCounts = 0.0;\n\n                for (int i = 0; i < 1000; i++) {\n                    if (i >= u_numSpots) break;\n\n                    float idx = float(i * 2);\n                    vec4 posData = texture2D(u_spotData, vec2((idx + 0.5) / u_dataSize, 0.5));\n                    vec4 intensityData = texture2D(u_spotData, vec2((idx + 1.5) / u_dataSize, 0.5));\n\n                    vec2 spotCenter = center + posData.xy;\n                    float spotRadius = posData.z;\n                    float elongation = posData.w;\n                    float intensity = intensityData.x;\n                    float angle = intensityData.y;\n\n                    if (intensity > 0.001) {\n                        float contribution = gaussianSpot(pos, center, spotCenter, spotRadius * u_zoom, elongation, angle, u_powderSmear);\n                        totalCounts += contribution * intensity;\n                    }\n                }\n\n                // Apply log scaling for better dynamic range\n                float scaleFactor = 5.0 + u_powderSmear * 20.0;\n                float logCounts = log(1.0 + totalCounts * scaleFactor) / log(1.0 + u_maxIntensity * 2.0);\n                logCounts = clamp(logCounts, 0.0, 1.0);\n\n                // Mix background with spot color based on intensity\n                color = mix(bgColor, spotColor, logCounts);\n\n                // Add slight noise for realism (detector noise)\n                float noise = fract(sin(dot(pos, vec2(12.9898, 78.233))) * 43758.5453);\n                float noiseAmount = u_isDark == 1 ? 0.015 : -0.01;\n                color += vec3(noise * noiseAmount);\n            }\n        } else {\n            // Outside detector - border color\n            color = borderColor;\n        }\n\n        // Detector edge highlight\n        float edgeDist = abs(distFromCenter - maxRadius);\n        if (edgeDist < 2.0) {\n            color = edgeColor;\n        }\n\n        gl_FragColor = vec4(color, 1.0);\n    }\n"),t.compileShader(o);const r=t.createProgram();t.attachShader(r,n),t.attachShader(r,o),t.linkProgram(r);const i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),t.STATIC_DRAW);const a=t.getAttribLocation(r,"a_position");t.enableVertexAttribArray(a),t.vertexAttribPointer(a,2,t.FLOAT,!1,0,0);const s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),v.current={gl:t,program:r,texture:s,uniforms:{resolution:t.getUniformLocation(r,"u_resolution"),zoom:t.getUniformLocation(r,"u_zoom"),pan:t.getUniformLocation(r,"u_pan"),numSpots:t.getUniformLocation(r,"u_numSpots"),dataSize:t.getUniformLocation(r,"u_dataSize"),maxIntensity:t.getUniformLocation(r,"u_maxIntensity"),isDark:t.getUniformLocation(r,"u_isDark"),beamStopRadius:t.getUniformLocation(r,"u_beamStopRadius"),powderSmear:t.getUniformLocation(r,"u_powderSmear")}},()=>{t.deleteProgram(r),t.deleteTexture(s),v.current=null}},[d]),(0,o.useEffect)(()=>{if("detector"!==d)return;const e=v.current;if(!e)return;const{gl:t,texture:n}=e,o=Math.max(4,2*L.length),r=new Float32Array(4*o);let i=1;for(const a of L)i=Math.max(i,a.intensity);for(let a=0;a<L.length;a++){const e=L[a],t=8*a;r[t]=e.x,r[t+1]=e.y,r[t+2]=e.radius,r[t+3]=e.elongation,r[t+4]=e.intensity,r[t+5]=e.angle}t.bindTexture(t.TEXTURE_2D,n);t.getExtension("OES_texture_float")&&t.texImage2D(t.TEXTURE_2D,0,t.RGBA,o,1,0,t.RGBA,t.FLOAT,r),C.current=L},[L,d]),(0,o.useEffect)(()=>{if("detector"!==d)return;const n=v.current,o=b.current,r=y.current;if(!n||!o||!r)return;const{gl:i,program:a,texture:s,uniforms:c}=n;o.width===e&&o.height===t||(o.width=e,o.height=t);let h=1;for(const e of L)h=Math.max(h,e.intensity);i.viewport(0,0,e,t),i.useProgram(a),i.uniform2f(c.resolution,e,t),i.uniform1f(c.zoom,M),i.uniform2f(c.pan,w.x,w.y),i.uniform1i(c.numSpots,L.length),i.uniform1f(c.dataSize,Math.max(4,2*L.length)),i.uniform1f(c.maxIntensity,.3*h),i.uniform1i(c.isDark,E?1:0),i.uniform1f(c.beamStopRadius,0),i.uniform1f(c.powderSmear,_),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,s),i.drawArrays(i.TRIANGLE_STRIP,0,4);const x=r.getContext("2d");if(!x)return;r.width===e&&r.height===t||(r.width=e,r.height=t),x.clearRect(0,0,e,t);const{fixedLabel:g}=P(),C=e/2,S=t/2,k=(Math.min(e,t)-80)/2,R=Math.PI/3,T=100/f,j=.85*k/Math.tan(R),D=p*Math.PI/180,F=Math.tan(D)*j*T*M;if(F>10&&F<2*k){x.strokeStyle=E?"rgba(147, 197, 253, 0.6)":"rgba(37, 99, 235, 0.5)",x.lineWidth=1.5,x.setLineDash([6,4]),x.beginPath(),x.arc(C-w.x*M,S+w.y*M,F,0,2*Math.PI),x.stroke(),x.setLineDash([]),x.fillStyle=E?"rgba(147, 197, 253, 0.9)":"rgba(37, 99, 235, 0.8)",x.font='9px "Segoe UI", system-ui, sans-serif',x.textAlign="left";const n=C-w.x*M+.707*F+4,o=S+w.y*M-.707*F-4;n>20&&n<e-40&&o>20&&o<t-20&&x.fillText(`2\u03b8=${p}\xb0`,n,o)}x.fillStyle=u.text,x.font='bold 11px "Segoe UI", system-ui, sans-serif',x.textAlign="left",x.fillText(`Detector Pattern (${g})`,10,15),x.font='10px "Segoe UI", system-ui, sans-serif',x.fillStyle=u.textMuted,x.textAlign="right";const A=_>.01?` | Smear: ${(100*_).toFixed(0)}%`:"";if(x.fillText(`Zoom: ${M.toFixed(1)}x | \u03bb=${m.toFixed(3)}\xc5${A}`,e-10,t-10),l){const n=L.find(e=>e.h===l[0]&&e.k===l[1]&&e.l===l[2]);if(n){const o=t/2,r=e/2+(n.x-w.x)*M,i=o+(n.y-w.y)*M;x.strokeStyle=E?"#fbbf24":"#d97706",x.lineWidth=2,x.beginPath(),x.arc(r,i,n.radius*M+6,0,2*Math.PI),x.stroke(),x.fillStyle=E?"#fbbf24":"#d97706",x.font='bold 10px "Segoe UI", system-ui, sans-serif',x.textAlign="left",x.fillText(`(${n.h},${n.k},${n.l})`,r+n.radius*M+8,i+4)}}x.fillStyle=u.textMuted,x.font='9px "Segoe UI", system-ui, sans-serif',x.textAlign="left",x.fillText("Scroll to zoom, drag to pan",10,t-10)},[d,L,M,w,e,t,E,u,l,m,P,_,p,f]),(0,o.useEffect)(()=>{if("reciprocal"!==d)return;const o=g.current;if(!o)return;const r=o.getContext("2d");if(!r)return;const i=40,c=Math.min(e,t)-80,m=e/2,f=t/2,h=c/(2*a+1),{xLabel:p,yLabel:x,fixedLabel:b}=P();r.fillStyle=u.surface||u.inputBg,r.fillRect(0,0,e,t),r.strokeStyle=E?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",r.lineWidth=1;for(let n=-a;n<=a;n++){const o=m+n*h;r.beginPath(),r.moveTo(o,i),r.lineTo(o,t-i),r.stroke();const a=f-n*h;r.beginPath(),r.moveTo(i,a),r.lineTo(e-i,a),r.stroke()}r.strokeStyle=u.textMuted,r.lineWidth=1.5,r.beginPath(),r.moveTo(i,f),r.lineTo(e-i,f),r.stroke(),r.beginPath(),r.moveTo(m,i),r.lineTo(m,t-i),r.stroke();let y=1;for(let e=-a;e<=a;e++)for(let t=-a;t<=a;t++){if(0===e&&0===t)continue;const[o,r,i]=N(e,t);if(H(Math.abs(o),Math.abs(r),Math.abs(i),n)){const e=I(o,r,i);y=Math.max(y,e)}}for(let e=-a;e<=a;e++)for(let t=-a;t<=a;t++){const o=m+e*h,i=f-t*h,[a,c,u]=N(e,t),d=0===e&&0===t,p=H(Math.abs(a),Math.abs(c),Math.abs(u),n),x=l&&a===l[0]&&c===l[1]&&u===l[2];if(d)r.fillStyle=E?"#888":"#666",r.beginPath(),r.arc(o,i,3,0,2*Math.PI),r.fill();else if(p){const e=3+12*(I(a,c,u)/y);x&&(r.fillStyle=E?"#fbbf24":"#d97706",r.strokeStyle=E?"#fbbf24":"#d97706",r.lineWidth=2,r.beginPath(),r.arc(o,i,e+3,0,2*Math.PI),r.stroke()),r.fillStyle=E?"#6b9eff":"#2563eb",r.beginPath(),r.arc(o,i,e,0,2*Math.PI),r.fill()}else s&&(r.fillStyle=E?"rgba(180, 180, 180, 0.25)":"rgba(100, 100, 100, 0.25)",r.beginPath(),r.arc(o,i,2.5,0,2*Math.PI),r.fill())}r.fillStyle=u.text,r.font='bold 12px "Segoe UI", system-ui, sans-serif',r.textAlign="center",r.fillText(p,e-i+15,f+4),r.fillText(x,m,30),r.font='bold 11px "Segoe UI", system-ui, sans-serif',r.textAlign="left",r.fillText(`Reciprocal Space (${b})`,10,15),r.font='10px "Segoe UI", system-ui, sans-serif',r.fillStyle=u.textMuted,r.textAlign="right",r.fillText(`Max: ${a}`,e-10,t-10)},[d,e,t,n,r,i,a,s,l,u,E,P,N,I]);const B=(0,o.useCallback)(e=>{if("detector"!==d)return;e.preventDefault();const t=e.deltaY>0?.9:1.1;S(e=>Math.max(.5,Math.min(10,e*t)))},[d]),$=(0,o.useCallback)(e=>{"detector"===d&&(R.current=!0,T.current={x:e.clientX,y:e.clientY})},[d]),W=(0,o.useCallback)(e=>{if("detector"!==d||!R.current)return;const t=e.clientX-T.current.x,n=e.clientY-T.current.y;T.current={x:e.clientX,y:e.clientY},k(e=>({x:e.x-t/M,y:e.y+n/M}))},[d,M]),U=(0,o.useCallback)(()=>{R.current=!1},[]),G=(0,o.useCallback)(()=>{"detector"===d&&(S(1),k({x:0,y:0}))},[d]),O=(0,o.useCallback)(o=>{if(!c||R.current)return;const r="detector"===d?b.current:g.current;if(!r)return;const i=r.getBoundingClientRect(),s=r.width/i.width,l=r.height/i.height,u=(o.clientX-i.left)*s,m=(o.clientY-i.top)*l,f=e/2,h=t/2;if("detector"===d){const e=(u-f)/M+w.x,t=(m-h)/M+w.y;let n=1/0,o=null;for(const r of C.current){const i=Math.sqrt((e-r.x)**2+(t-r.y)**2);i<n&&i<20/M&&(n=i,o=r)}o&&c([o.h,o.k,o.l])}else{const o=(Math.min(e,t)-80)/(2*a+1),r=Math.round((u-f)/o),i=Math.round((h-m)/o);if(Math.abs(r)<=a&&Math.abs(i)<=a&&(0!==r||0!==i)){const[e,t,o]=N(r,i);H(Math.abs(e),Math.abs(t),Math.abs(o),n)&&c([e,t,o])}}},[e,t,a,i,n,c,d,M,w,N]);(0,o.useEffect)(()=>{S(1),k({x:0,y:0}),j(0),F(!1),A.current&&cancelAnimationFrame(A.current)},[d,n]),(0,o.useEffect)(()=>{if(!D)return void(A.current&&cancelAnimationFrame(A.current));let e=null;const t=n=>{e||(e=n);const o=n-e,r=Math.min(o/3e3,1),i=1-Math.pow(1-r,3);j(i),r<1?A.current=requestAnimationFrame(t):F(!1)};return A.current=requestAnimationFrame(t),()=>{A.current&&cancelAnimationFrame(A.current)}},[D]);const X=(0,o.useCallback)(()=>{_>.5?(j(0),F(!1)):F(!0)},[_]);return"detector"===d?(0,K.jsxs)("div",{style:{position:"relative",width:e,height:t,borderRadius:"4px",border:`1px solid ${u.border}`,overflow:"hidden",cursor:R.current?"grabbing":"grab"},onWheel:B,onMouseDown:$,onMouseMove:W,onMouseUp:U,onMouseLeave:U,onDoubleClick:G,onClick:O,children:[(0,K.jsx)("canvas",{ref:b,width:e,height:t,style:{position:"absolute",left:0,top:0}}),(0,K.jsx)("canvas",{ref:y,width:e,height:t,style:{position:"absolute",left:0,top:0,pointerEvents:"none"}}),(0,K.jsx)("button",{onClick:e=>{e.stopPropagation(),X()},style:{position:"absolute",top:8,right:8,padding:"4px 8px",fontSize:"10px",fontWeight:"bold",border:`1px solid ${u.border}`,borderRadius:"4px",backgroundColor:_>.5?u.accent||"#2563eb":E?"rgba(60,60,60,0.9)":"rgba(255,255,255,0.9)",color:_>.5?"#fff":u.text,cursor:"pointer",transition:"all 0.2s",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"},title:_>.5?"Reset to single crystal":"Animate to powder pattern",children:D?"Smearing...":_>.5?"Reset":"Powder"})]}):(0,K.jsx)("canvas",{ref:g,width:e,height:t,onClick:O,style:{cursor:"pointer",borderRadius:"4px",border:`1px solid ${u.border}`}})},Q={H:[.489918,20.6593,.262003,7.74039,.196767,49.5519,.049879,2.20159,.001305],C:[2.31,20.8439,1.02,10.2075,1.5886,.5687,.865,51.6512,.2156],N:[12.2126,.0057,3.1322,9.8933,2.0125,28.9975,1.1663,.5826,-11.529],O:[3.0485,13.2771,2.2868,5.7011,1.5463,.3239,.867,32.9089,.2508],Na:[4.7626,3.285,3.1736,8.8422,1.2674,.3136,1.1128,129.424,.676],Cl:[11.4604,.0104,7.1964,1.1662,6.2556,18.5194,1.6455,47.7784,-9.5574],Si:[6.2915,2.4386,3.0353,32.3337,1.9891,.6785,1.541,81.6937,1.1407],Fe:[11.7695,4.7611,7.3573,.3072,3.5222,15.3535,2.3045,76.8805,1.0369],Ca:[8.6266,10.4421,7.3873,.6599,1.5899,85.7484,1.0211,178.437,1.3751],K:[8.2186,12.7949,7.4398,.7748,1.0519,213.187,.8659,41.6841,1.4228],Ti:[9.7595,7.8508,7.3558,.5,1.6991,35.6338,1.9021,116.105,1.2807],Cs:[20.3892,3.569,19.1062,.3107,10.662,24.3879,1.4953,213.904,3.3352],Ba:[20.1807,3.21,19.1136,.2855,10.9054,20.0558,.7763,51.746,3.029],I:[20.1472,4.347,18.9949,.3814,7.5138,27.766,2.2735,66.8776,4.0712]},Z={H:"#888888",C:"#909090",N:"#3050f8",O:"#ff0d0d",Na:"#ab5cf2",Cl:"#1ff01f",Si:"#f0c8a0",Fe:"#e06633",Ca:"#3dff00",K:"#8f40d4",Ti:"#bfc2c7",Cs:"#57178f",Ba:"#00c900",I:"#940094"};function J(e,t){const n=t*t;let o=e[8];for(let r=0;r<4;r++)o+=e[2*r]*Math.exp(-e[2*r+1]*n);return o}function ee(e,t){if(e.length<2)return e[0]?.f??0;if(t<=e[0].s)return e[0].f;if(t>=e[e.length-1].s)return e[e.length-1].f;let n=0;for(;n<e.length-1&&!(t<=e[n+1].s);n++);const o=e[Math.max(0,n-1)],r=e[n],i=e[Math.min(e.length-1,n+1)],a=e[Math.min(e.length-1,n+2)],s=(t-r.s)/(i.s-r.s),l=s*s,c=l*s,u=.5*(2*r.f+(-o.f+i.f)*s+(2*o.f-5*r.f+4*i.f-a.f)*l+(-o.f+3*r.f-3*i.f+a.f)*c);return Math.max(0,u)}const te=({width:e,height:t,elements:n,theme:r,formFactors:i,onFormFactorsChange:a})=>{const s=(0,o.useRef)(null),[l,c]=(0,o.useState)(n[0]||"C"),[u,d]=(0,o.useState)(null),[m,f]=(0,o.useState)(null),h=(0,o.useMemo)(()=>[...new Set(n)],[n]);(0,o.useEffect)(()=>{!h.includes(l)&&h.length>0&&c(h[0])},[h,l]);const p=i[l]||[],x=30,g=45,b=e-g-15,y=t-x-35,v=1.5,C=(0,o.useMemo)(()=>{let e=10;for(const t of Object.values(i))for(const n of t)e=Math.max(e,n.f);return 5*Math.ceil(e/5)},[i]),M=(0,o.useCallback)(e=>g+e/v*b,[b]),S=(0,o.useCallback)(e=>x+y-e/C*y,[y,C]),w=((0,o.useCallback)(e=>(e-g)/b*v,[b]),(0,o.useCallback)(e=>(x+y-e)/y*C,[y,C])),k=(0,o.useCallback)(()=>{const e=function(e,t=8){const n=Q[e]||Q.C,o=[];for(let r=0;r<t;r++){const e=r/(t-1)*1.5,i=J(n,e);o.push({s:e,f:i})}return o}(l);a({...i,[l]:e})},[l,i,a]),R=(0,o.useCallback)(e=>{const t=s.current;if(!t)return;const n=t.getBoundingClientRect(),o=e.clientX-n.left,r=e.clientY-n.top;for(let i=0;i<p.length;i++){const e=M(p[i].s),t=S(p[i].f);if(Math.sqrt((o-e)**2+(r-t)**2)<10)return void d(i)}},[p,M,S]),T=(0,o.useCallback)(e=>{const t=s.current;if(!t)return;const n=t.getBoundingClientRect(),o=e.clientX-n.left,r=e.clientY-n.top;if(null!==u){const e=Math.max(0,Math.min(C,w(r))),t=[...p];t[u]={...t[u],f:e},a({...i,[l]:t})}else{let e=null;for(let t=0;t<p.length;t++){const n=M(p[t].s),i=S(p[t].f);if(Math.sqrt((o-n)**2+(r-i)**2)<10){e=t;break}}f(e)}},[u,p,M,S,w,C,i,l,a]),_=(0,o.useCallback)(()=>{d(null)},[]),j=(0,o.useCallback)(()=>{d(null),f(null)},[]);return(0,o.useEffect)(()=>{const n=s.current;if(!n)return;const o=n.getContext("2d");if(!o)return;const i=window.devicePixelRatio||1;n.width=e*i,n.height=t*i,o.scale(i,i),o.fillStyle=r.surface||r.background,o.fillRect(0,0,e,t),o.strokeStyle=r.border,o.lineWidth=.5;for(let e=0;e<=v;e+=.5){const t=M(e);o.beginPath(),o.moveTo(t,x),o.lineTo(t,x+y),o.stroke()}const a=C>20?10:5;for(let e=0;e<=C;e+=a){const t=S(e);o.beginPath(),o.moveTo(g,t),o.lineTo(g+b,t),o.stroke()}o.strokeStyle=r.text,o.lineWidth=1,o.beginPath(),o.moveTo(g,x),o.lineTo(g,x+y),o.lineTo(g+b,x+y),o.stroke(),o.fillStyle=r.textMuted,o.font="9px sans-serif",o.textAlign="center";for(let e=0;e<=v;e+=.5)o.fillText(e.toFixed(1),M(e),t-8);o.fillText("sin(\u03b8)/\u03bb (\xc5\u207b\xb9)",g+b/2,t-2),o.textAlign="right";for(let e=0;e<=C;e+=a)o.fillText(e.toString(),g-5,S(e)+3);if(o.save(),o.translate(12,x+y/2),o.rotate(-Math.PI/2),o.textAlign="center",o.fillText("f (electrons)",0,0),o.restore(),p.length>0){o.strokeStyle=Z[l]||r.accent,o.lineWidth=2,o.beginPath();for(let e=0;e<=100;e++){const t=e/100*v,n=ee(p,t),r=M(t),i=S(n);0===e?o.moveTo(r,i):o.lineTo(r,i)}o.stroke();for(let e=0;e<p.length;e++){const t=M(p[e].s),n=S(p[e].f);o.beginPath(),o.arc(t,n,m===e||u===e?7:5,0,2*Math.PI),o.fillStyle=u===e?"#ff6b6b":m===e?"#ffd93d":Z[l]||r.accent,o.fill(),o.strokeStyle=r.text,o.lineWidth=1,o.stroke()}}o.fillStyle=r.text,o.font="bold 11px sans-serif",o.textAlign="left",o.fillText(`Form Factor Editor: ${l}`,g,14),o.font="9px sans-serif",o.fillStyle=r.textMuted,o.textAlign="right",o.fillText("Drag points to edit",e-10,14)},[e,t,p,l,r,M,S,C,m,u]),(0,K.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:[(0,K.jsxs)("div",{style:{display:"flex",gap:"0.25rem",flexWrap:"wrap"},children:[h.map(e=>(0,K.jsx)("button",{onClick:()=>c(e),style:{padding:"0.2rem 0.5rem",fontSize:"0.7rem",border:`1px solid ${r.border}`,borderRadius:"4px",backgroundColor:l===e?Z[e]||r.accent:r.inputBg,color:l===e?"#fff":r.text,cursor:"pointer",fontWeight:l===e?"bold":"normal"},children:e},e)),(0,K.jsx)("button",{onClick:k,style:{padding:"0.2rem 0.5rem",fontSize:"0.7rem",border:`1px solid ${r.border}`,borderRadius:"4px",backgroundColor:r.inputBg,color:r.text,cursor:"pointer",marginLeft:"auto"},children:"Reset"})]}),(0,K.jsx)("div",{style:{borderRadius:"4px",border:`1px solid ${r.border}`,overflow:"hidden",cursor:null!==m?"grab":"default"},children:(0,K.jsx)("canvas",{ref:s,style:{width:e,height:t,display:"block"},onMouseDown:R,onMouseMove:T,onMouseUp:_,onMouseLeave:j})})]})};function ne(e,t,n,o,r,i,a=1.5){const s=$(e,t,n,o);if(s<r/2)return null;const l=W(s,r);if(isNaN(l))return null;const c=Math.sin(l*Math.PI/360)/r,u=Math.exp(-a*c*c);let d={re:0,im:0};for(const m of o.atoms){const[o,r,a]=m.position,s=2*Math.PI*(e*o+t*r+n*a);let l;l=i&&i[m.element]&&i[m.element].length>0?ee(i[m.element],c):B(m.element,c),l*=u,d.re+=l*Math.cos(s),d.im+=l*Math.sin(s)}return d}const oe={H:"#FFFFFF",C:"#909090",N:"#3050F8",O:"#FF0D0D",Na:"#AB5CF2",Cl:"#1FF01F",Si:"#F0C8A0",Fe:"#E06633",Ca:"#3DFF00",Ti:"#BFC2C7",Cs:"#57178F",Ba:"#00C900",K:"#8F40D4",I:"#940094",S:"#FFFF30",P:"#FF8000",Mg:"#8AFF00",Al:"#BFA6A6",Zn:"#7D80B0",Cu:"#C88033"},re=o.memo(({width:e,height:t,structure:n,wavelength:r,slicePosition:i,sliceAxis:a="z",resolution:s,showContours:l,maxHKL:c,theme:u,formFactors:d,bFactor:m=1.5,noise:f=0,displayMode:h="magnitude",showAtoms:p=!0})=>{const x=(0,o.useRef)(null),g=(0,o.useRef)(null),b=(0,o.useRef)(null),y=(0,o.useRef)(null),v=(0,o.useRef)(0),C=40,M=e-80,S=t-80,w=(0,o.useMemo)(()=>{const e=e=>{const t=43758.5453*Math.sin(12.9898*e+78.233);return t-Math.floor(t)},t=[];let o=0;for(let i=-c;i<=c;i++)for(let a=-c;a<=c;a++)for(let s=-c;s<=c;s++){if(0===i&&0===a&&0===s)continue;if(!H(Math.abs(i),Math.abs(a),Math.abs(s),n))continue;const l=ne(i,a,s,n,r,d,m);if(l&&(Math.abs(l.re)>.01||Math.abs(l.im)>.01)){let n=l.re,r=l.im;if(f>0){const t=Math.sqrt(n*n+r*r),i=Math.atan2(r,n),a=t*f*.3,s=2*(e(1e3*o+1e4*f)-.5),l=Math.max(0,t+s*a);n=l*Math.cos(i),r=l*Math.sin(i)}t.push({h:i,k:a,l:s,fRe:n,fIm:r}),o++}}return t},[n,c,r,d,m,f]);return(0,o.useEffect)(()=>{const e=g.current;if(!e)return;const t=e.getContext("webgl");if(!t)return;const n=t.createShader(t.VERTEX_SHADER);t.shaderSource(n,"\n    attribute vec2 a_position;\n    varying vec2 v_texCoord;\n    void main() {\n        gl_Position = vec4(a_position, 0.0, 1.0);\n        v_texCoord = (a_position + 1.0) / 2.0;\n    }\n"),t.compileShader(n);const o=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(o,"\n    precision highp float;\n    varying vec2 v_texCoord;\n    uniform float u_slicePos;\n    uniform int u_sliceAxis; // 0=x, 1=y, 2=z\n    uniform int u_numReflections;\n    uniform sampler2D u_reflectionData;\n    uniform float u_dataSize;\n    uniform float u_sigma; // Gaussian damping parameter\n    uniform int u_displayMode; // 0=magnitude, 1=signed\n    uniform float u_normScale; // Dynamic normalization scale based on structure\n\n    // Viridis colormap for magnitude mode (sequential, perceptually uniform)\n    vec3 viridis(float t) {\n        t = clamp(t, 0.0, 1.0);\n        vec3 c0 = vec3(0.267, 0.004, 0.329);\n        vec3 c1 = vec3(0.282, 0.140, 0.458);\n        vec3 c2 = vec3(0.254, 0.265, 0.530);\n        vec3 c3 = vec3(0.206, 0.372, 0.553);\n        vec3 c4 = vec3(0.163, 0.471, 0.558);\n        vec3 c5 = vec3(0.128, 0.567, 0.551);\n        vec3 c6 = vec3(0.135, 0.659, 0.518);\n        vec3 c7 = vec3(0.267, 0.749, 0.441);\n        vec3 c8 = vec3(0.478, 0.821, 0.318);\n        vec3 c9 = vec3(0.741, 0.873, 0.150);\n        vec3 c10 = vec3(0.993, 0.906, 0.144);\n\n        float idx = t * 10.0;\n        int i = int(idx);\n        float f = fract(idx);\n\n        if (i >= 10) return c10;\n        if (i == 0) return mix(c0, c1, f);\n        if (i == 1) return mix(c1, c2, f);\n        if (i == 2) return mix(c2, c3, f);\n        if (i == 3) return mix(c3, c4, f);\n        if (i == 4) return mix(c4, c5, f);\n        if (i == 5) return mix(c5, c6, f);\n        if (i == 6) return mix(c6, c7, f);\n        if (i == 7) return mix(c7, c8, f);\n        if (i == 8) return mix(c8, c9, f);\n        return mix(c9, c10, f);\n    }\n\n    // Blue-White-Red diverging colormap for signed mode\n    vec3 blueWhiteRed(float t) {\n        t = clamp(t, 0.0, 1.0);\n        if (t < 0.5) {\n            // Red to White (negative to zero)\n            float f = t * 2.0;\n            return vec3(1.0, f, f);\n        } else {\n            // White to Blue (zero to positive)\n            float f = (t - 0.5) * 2.0;\n            return vec3(1.0 - f, 1.0 - f, 1.0);\n        }\n    }\n\n    void main() {\n        // Map texture coords to crystal coords based on slice axis\n        // u_sliceAxis: 0=x (slice shows yz), 1=y (slice shows xz), 2=z (slice shows xy)\n        float coord1 = v_texCoord.x;\n        float coord2 = v_texCoord.y;\n\n        float densityRe = 0.0;\n        float densityIm = 0.0;\n        float TWO_PI = 6.28318530718;\n        float sigma2 = u_sigma * u_sigma * 2.0;\n\n        for (int i = 0; i < 2000; i++) {\n            if (i >= u_numReflections) break;\n            float idx = float(i * 2);\n            vec4 hklData = texture2D(u_reflectionData, vec2((idx + 0.5) / u_dataSize, 0.5));\n            vec4 fData = texture2D(u_reflectionData, vec2((idx + 1.5) / u_dataSize, 0.5));\n\n            // Gaussian damping to reduce Gibbs ringing\n            float s2 = hklData.r * hklData.r + hklData.g * hklData.g + hklData.b * hklData.b;\n            float damping = exp(-s2 / sigma2);\n\n            // Calculate phase based on slice axis\n            float phase;\n            if (u_sliceAxis == 0) {\n                // x-slice: fixed x=slicePos, show (y, z) plane\n                phase = -TWO_PI * (hklData.r * u_slicePos + hklData.g * coord1 + hklData.b * coord2);\n            } else if (u_sliceAxis == 1) {\n                // y-slice: fixed y=slicePos, show (x, z) plane\n                phase = -TWO_PI * (hklData.r * coord1 + hklData.g * u_slicePos + hklData.b * coord2);\n            } else {\n                // z-slice: fixed z=slicePos, show (x, y) plane\n                phase = -TWO_PI * (hklData.r * coord1 + hklData.g * coord2 + hklData.b * u_slicePos);\n            }\n            // Complex multiplication: F * exp(-i*phase)\n            float c = cos(phase);\n            float s = sin(phase);\n            densityRe += damping * (fData.r * c - fData.g * s);\n            densityIm += damping * (fData.r * s + fData.g * c);\n        }\n\n        vec3 color;\n        if (u_displayMode == 0) {\n            // Magnitude mode: |rho| = sqrt(re^2 + im^2)\n            float mag = sqrt(densityRe * densityRe + densityIm * densityIm);\n            float normalized = clamp(mag / u_normScale, 0.0, 1.0);\n            color = viridis(normalized);\n        } else {\n            // Signed mode: show real part with diverging colormap\n            float normalized = clamp((densityRe + u_normScale) / (2.0 * u_normScale), 0.0, 1.0);\n            color = blueWhiteRed(normalized);\n        }\n\n        gl_FragColor = vec4(color, 1.0);\n    }\n"),t.compileShader(o);const r=t.createProgram();t.attachShader(r,n),t.attachShader(r,o),t.linkProgram(r);const i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),t.STATIC_DRAW);const a=t.getAttribLocation(r,"a_position");t.enableVertexAttribArray(a),t.vertexAttribPointer(a,2,t.FLOAT,!1,0,0);const s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),y.current={gl:t,program:r,texture:s,slicePosLoc:t.getUniformLocation(r,"u_slicePos"),sliceAxisLoc:t.getUniformLocation(r,"u_sliceAxis"),displayModeLoc:t.getUniformLocation(r,"u_displayMode"),numReflectionsLoc:t.getUniformLocation(r,"u_numReflections"),dataSizeLoc:t.getUniformLocation(r,"u_dataSize"),sigmaLoc:t.getUniformLocation(r,"u_sigma"),normScaleLoc:t.getUniformLocation(r,"u_normScale")},()=>{t.deleteProgram(r),t.deleteTexture(s),y.current=null}},[]),(0,o.useEffect)(()=>{const e=y.current;if(!e)return;const{gl:t,texture:n}=e,o=Math.max(4,2*w.length),r=new Float32Array(4*o);for(let i=0;i<w.length;i++){const e=w[i],t=8*i;r[t]=e.h,r[t+1]=e.k,r[t+2]=e.l,r[t+4]=e.fRe,r[t+5]=e.fIm}t.bindTexture(t.TEXTURE_2D,n);t.getExtension("OES_texture_float")&&t.texImage2D(t.TEXTURE_2D,0,t.RGBA,o,1,0,t.RGBA,t.FLOAT,r)},[w]),(0,o.useEffect)(()=>{const o=y.current,r=g.current,s=b.current;if(o&&r&&s)return v.current&&cancelAnimationFrame(v.current),v.current=requestAnimationFrame(()=>{const{gl:l,program:d,texture:m,slicePosLoc:f,sliceAxisLoc:x,displayModeLoc:g,numReflectionsLoc:b,dataSizeLoc:y,sigmaLoc:v,normScaleLoc:k}=o;r.width===M&&r.height===S||(r.width=M,r.height=S);const R="x"===a?0:"y"===a?1:2,T="magnitude"===h?0:1;let _=0;for(const e of w)_+=Math.sqrt(e.fRe*e.fRe+e.fIm*e.fIm);l.viewport(0,0,M,S),l.useProgram(d),l.uniform1f(f,i),l.uniform1i(x,R),l.uniform1i(g,T),l.uniform1i(b,w.length),l.uniform1f(y,Math.max(4,2*w.length)),l.uniform1f(v,.8*c),l.uniform1f(k,1e3),l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,m),l.drawArrays(l.TRIANGLE_STRIP,0,4);const j=s.getContext("2d");if(!j)return;s.width===e&&s.height===t||(s.width=e,s.height=t),j.clearRect(0,0,e,t);const D=u.text.startsWith("#e")||u.text.startsWith("#f");if(j.fillStyle=u.surface||u.inputBg,j.fillRect(0,0,e,C),j.fillRect(0,t-C,e,C),j.fillRect(0,0,C,t),j.fillRect(e-C,0,C,t),j.strokeStyle=u.border,j.lineWidth=1,j.strokeRect(C,C,M,S),p)for(const e of n.atoms){const[t,n,o]=e.position;let r,s,l;"x"===a?(r=t,s=n,l=o):"y"===a?(r=n,s=t,l=o):(r=o,s=t,l=n);const c=Math.abs(r-i);if(c<.15){const t=C+s*M,n=C+(1-l)*S,o=1-c/.15,r=12-30*c,i=oe[e.element]||"#808080";j.beginPath(),j.arc(t,n,r,0,2*Math.PI),j.fillStyle=i,j.globalAlpha=.85*o,j.fill(),j.globalAlpha=o,j.strokeStyle=D?"#fff":"#000",j.lineWidth=2,j.stroke(),j.globalAlpha=o,j.fillStyle=D?"#fff":"#000",j.font="bold 11px sans-serif",j.textAlign="center",j.textBaseline="middle",j.fillText(e.element,t,n),j.globalAlpha=1}}j.fillStyle=u.text,j.font="bold 11px sans-serif",j.textAlign="left",j.fillText(`Electron Density (${a} = ${i.toFixed(2)})`,10,15);const F="x"===a?["y/b","z/c"]:"y"===a?["x/a","z/c"]:["x/a","y/b"];j.font="10px sans-serif",j.fillStyle=u.textMuted,j.textAlign="center",j.fillText(F[0],e/2,t-10),j.save(),j.translate(15,t/2),j.rotate(-Math.PI/2),j.fillText(F[1],0,0),j.restore();const A=15,E=.6*S,P=e-C+10,N=C+(S-E)/2,z="magnitude"===h?e=>{const t=[[.267,.004,.329],[.282,.14,.458],[.254,.265,.53],[.206,.372,.553],[.163,.471,.558],[.128,.567,.551],[.135,.659,.518],[.267,.749,.441],[.478,.821,.318],[.741,.873,.15],[.993,.906,.144]],n=10*(e=Math.max(0,Math.min(1,e))),o=Math.min(9,Math.floor(n)),r=n-o,i=t[o],a=t[o+1];return[Math.round(255*(i[0]+(a[0]-i[0])*r)),Math.round(255*(i[1]+(a[1]-i[1])*r)),Math.round(255*(i[2]+(a[2]-i[2])*r))]}:e=>{if((e=Math.max(0,Math.min(1,e)))<.5){const t=2*e;return[255,Math.round(255*t),Math.round(255*t)]}{const t=2*(e-.5);return[Math.round(255*(1-t)),Math.round(255*(1-t)),255]}};for(let e=0;e<E;e++){const t=1-e/E,[n,o,r]=z(t);j.fillStyle=`rgb(${n},${o},${r})`,j.fillRect(P,N+e,A,1)}j.strokeStyle=u.border,j.strokeRect(P,N,A,E),j.fillStyle=u.textMuted,j.font="9px sans-serif",j.textAlign="left","magnitude"===h?(j.fillText("high",P+A+3,N+8),j.fillText("low",P+A+3,N+E)):(j.fillText("+",P+A+3,N+8),j.fillText("0",P+A+3,N+E/2+3),j.fillText("\u2212",P+A+3,N+E))}),()=>{v.current&&cancelAnimationFrame(v.current)}},[i,a,h,p,e,t,M,S,n,w,u,c]),(0,K.jsxs)("div",{ref:x,style:{position:"relative",width:e,height:t,borderRadius:"4px",border:`1px solid ${u.border}`,overflow:"hidden",backgroundColor:u.surface||u.inputBg},children:[(0,K.jsx)("canvas",{ref:g,style:{position:"absolute",left:C,top:C,width:M,height:S}}),(0,K.jsx)("canvas",{ref:b,style:{position:"absolute",left:0,top:0,pointerEvents:"none"}})]})});re.displayName="ElectronDensity";var ie=n(8371);function ae(e,t,n){return[[0,0,0],[.5,.5,0],[.5,0,.5],[0,.5,.5]].map(o=>({element:e,position:[(n[0]+o[0])%1,(n[1]+o[1])%1,(n[2]+o[2])%1],atomicNumber:t}))}function se(e){const t=e%1;return t<0?t+1:t}const le={NaCl:{name:"Sodium Chloride (NaCl)",spaceGroup:"Fm-3m",latticeType:"fcc",a:5.64,atoms:[...ae("Na",11,[0,0,0]),...ae("Cl",17,[.5,.5,.5])]},CsCl:{name:"Cesium Chloride (CsCl)",spaceGroup:"Pm-3m",latticeType:"cubic",a:4.11,atoms:[{element:"Cs",position:[0,0,0],atomicNumber:55},{element:"Cl",position:[.5,.5,.5],atomicNumber:17}]},Diamond:{name:"Diamond (C)",spaceGroup:"Fd-3m",latticeType:"fcc",a:3.567,atoms:[...ae("C",6,[0,0,0]),...ae("C",6,[.25,.25,.25])]},Benzene:{name:"Benzene (C\u2086H\u2086)",spaceGroup:"Pbca",latticeType:"orthorhombic",a:7.39,b:9.42,c:6.81,atoms:[{element:"C",position:[se(-.0607),.1393,se(-.0069)],atomicNumber:6},{element:"C",position:[se(-.1377),.0447,.126],atomicNumber:6},{element:"C",position:[.077,.0958,se(-.1325)],atomicNumber:6},{element:"C",position:[se(-.077),se(-.0958),.1325],atomicNumber:6},{element:"C",position:[.1377,se(-.0447),se(-.126)],atomicNumber:6},{element:"C",position:[.0607,se(-.1393),.0069],atomicNumber:6},{element:"H",position:[se(-.1046),.2502,se(-.0123)],atomicNumber:1},{element:"H",position:[se(-.2458),.0781,.2241],atomicNumber:1},{element:"H",position:[.1371,.1681,se(-.236)],atomicNumber:1},{element:"H",position:[se(-.1371),se(-.1681),.236],atomicNumber:1},{element:"H",position:[.2458,se(-.0781),se(-.2241)],atomicNumber:1},{element:"H",position:[.1046,se(-.2502),.0123],atomicNumber:1},{element:"C",position:[.0607,.6393,.5069],atomicNumber:6},{element:"C",position:[.1377,.5447,.374],atomicNumber:6},{element:"C",position:[se(-.077),.5958,.6325],atomicNumber:6},{element:"C",position:[.077,.4042,.3675],atomicNumber:6},{element:"C",position:[se(-.1377),.4553,.626],atomicNumber:6},{element:"C",position:[se(-.0607),.3607,.4931],atomicNumber:6},{element:"H",position:[.1046,.7502,.5123],atomicNumber:1},{element:"H",position:[.2458,.5781,.2759],atomicNumber:1},{element:"H",position:[se(-.1371),.6681,.736],atomicNumber:1},{element:"H",position:[.1371,.3319,.264],atomicNumber:1},{element:"H",position:[se(-.2458),.4219,.7241],atomicNumber:1},{element:"H",position:[se(-.1046),.2498,.4877],atomicNumber:1},{element:"C",position:[.5607,se(-.1393),.4931],atomicNumber:6},{element:"C",position:[.6377,se(-.0447),.626],atomicNumber:6},{element:"C",position:[.423,se(-.0958),.3675],atomicNumber:6},{element:"C",position:[.577,.0958,.6325],atomicNumber:6},{element:"C",position:[.3623,.0447,.374],atomicNumber:6},{element:"C",position:[.4393,.1393,.5069],atomicNumber:6},{element:"H",position:[.6046,se(-.2502),.4877],atomicNumber:1},{element:"H",position:[.7458,se(-.0781),.7241],atomicNumber:1},{element:"H",position:[.3629,se(-.1681),.264],atomicNumber:1},{element:"H",position:[.6371,.1681,.736],atomicNumber:1},{element:"H",position:[.2542,.0781,.2759],atomicNumber:1},{element:"H",position:[.3954,.2502,.5123],atomicNumber:1},{element:"C",position:[.5607,.6393,se(-.0069)],atomicNumber:6},{element:"C",position:[.6377,.5447,.126],atomicNumber:6},{element:"C",position:[.423,.5958,se(-.1325)],atomicNumber:6},{element:"C",position:[.577,.4042,.1325],atomicNumber:6},{element:"C",position:[.3623,.4553,se(-.126)],atomicNumber:6},{element:"C",position:[.4393,.3607,.0069],atomicNumber:6},{element:"H",position:[.6046,.7502,se(-.0123)],atomicNumber:1},{element:"H",position:[.7458,.5781,.2241],atomicNumber:1},{element:"H",position:[.3629,.6681,se(-.236)],atomicNumber:1},{element:"H",position:[.6371,.3319,.236],atomicNumber:1},{element:"H",position:[.2542,.4219,se(-.2241)],atomicNumber:1},{element:"H",position:[.3954,.2498,.0123],atomicNumber:1}]}},ce=Object.entries(le).map(([e,t])=>({id:e,name:t.name})),ue=({structureId:e,onStructureChange:t,structure:n,wavelength:o,onWavelengthChange:r,twoThetaMax:i,onTwoThetaMaxChange:a,peakWidth:s,onPeakWidthChange:l,showPeakLabels:c,onShowPeakLabelsChange:u,reciprocalPlane:d,onReciprocalPlaneChange:m,maxIndex:f,onMaxIndexChange:h,showAbsences:p,onShowAbsencesChange:x,reciprocalView:g,oscillationRange:b,onOscillationRangeChange:y,detectorDistance:v,onDetectorDistanceChange:C,slicePosition:M,onSlicePositionChange:S,sliceAxis:w,onSliceAxisChange:k,densityResolution:R,onDensityResolutionChange:T,showContours:_,onShowContoursChange:j,noise:D,onNoiseChange:F,bFactor:A,onBFactorChange:E,showBonds:P,onShowBondsChange:I,showLabels:L,onShowLabelsChange:B,supercell:$,onSupercellChange:W,formFactors:U,onFormFactorsChange:G,theme:O})=>(0,K.jsxs)("div",{style:{backgroundColor:O.surface||O.inputBg,padding:"1rem",borderRadius:"8px",border:`1px solid ${O.border}`,color:O.text},children:[(0,K.jsxs)(ie.iV,{title:"Crystal Structure",defaultExpanded:!0,theme:O,children:[(0,K.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,K.jsx)("label",{style:{display:"block",fontSize:"0.75rem",color:O.textMuted,marginBottom:"0.25rem"},children:"Structure"}),(0,K.jsx)("select",{value:e,onChange:e=>t(e.target.value),style:{width:"100%",padding:"0.4rem",fontSize:"0.8rem",border:`1px solid ${O.border}`,borderRadius:"4px",backgroundColor:O.inputBg,color:O.text,cursor:"pointer"},children:ce.map(e=>(0,K.jsx)("option",{value:e.id,children:e.name},e.id))})]}),(0,K.jsxs)("div",{style:{fontSize:"0.7rem",color:O.textMuted,marginTop:"0.5rem"},children:[(0,K.jsxs)("div",{children:["Space group: ",n.spaceGroup]}),(0,K.jsxs)("div",{children:["a = ",n.a.toFixed(3)," \xc5"]}),(0,K.jsxs)("div",{children:["Atoms: ",n.atoms.length]})]})]}),(0,K.jsxs)(ie.iV,{title:"X-ray Source",defaultExpanded:!0,theme:O,children:[(0,K.jsx)(ie.GK,{label:"Wavelength (\u03bb)",value:o,onChange:r,min:.5,max:2.5,step:.001,decimals:4,unit:"\xc5",theme:O}),(0,K.jsxs)("div",{style:{display:"flex",gap:"0.4rem",marginBottom:"0.5rem"},children:[(0,K.jsx)("button",{onClick:()=>r(N),style:{flex:1,padding:"0.25rem",fontSize:"0.65rem",border:`1px solid ${O.border}`,borderRadius:"4px",backgroundColor:Math.abs(o-N)<.001?O.accent||"#2563eb":O.inputBg,color:Math.abs(o-N)<.001?"#fff":O.text,cursor:"pointer"},children:"Cu K\u03b1"}),(0,K.jsx)("button",{onClick:()=>r(z),style:{flex:1,padding:"0.25rem",fontSize:"0.65rem",border:`1px solid ${O.border}`,borderRadius:"4px",backgroundColor:Math.abs(o-z)<.001?O.accent||"#2563eb":O.inputBg,color:Math.abs(o-z)<.001?"#fff":O.text,cursor:"pointer"},children:"Mo K\u03b1"})]}),(0,K.jsx)(ie.GK,{label:"2\u03b8 max",value:i,onChange:a,min:30,max:180,step:5,decimals:0,unit:"\xb0",theme:O})]}),(0,K.jsxs)(ie.iV,{title:"Atomic Form Factors",defaultExpanded:!1,theme:O,children:[(0,K.jsx)(te,{width:220,height:160,elements:n.atoms.map(e=>e.element),theme:O,formFactors:U,onFormFactorsChange:G}),(0,K.jsxs)("div",{style:{marginTop:"0.5rem",padding:"0.4rem",backgroundColor:O.inputBg,borderRadius:"4px",fontSize:"0.65rem",color:O.textMuted},children:[(0,K.jsx)("div",{style:{fontWeight:"bold",marginBottom:"0.2rem",color:O.text},children:"f(s) = atomic scattering factor"}),(0,K.jsx)("div",{children:"Drag points to customize. Click element to select."})]})]}),(0,K.jsxs)(ie.iV,{title:"Powder Pattern",defaultExpanded:!1,theme:O,children:[(0,K.jsx)(ie.GK,{label:"Peak width",value:s,onChange:l,min:.1,max:3,step:.1,decimals:1,unit:"\xb0",theme:O}),(0,K.jsx)(ie.jF,{label:"Show (hkl) labels",checked:c,onChange:u,theme:O})]}),(0,K.jsxs)(ie.iV,{title:"Reciprocal Space",defaultExpanded:!1,theme:O,children:[(0,K.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,K.jsx)("label",{style:{display:"block",fontSize:"0.75rem",color:O.textMuted,marginBottom:"0.25rem"},children:"Plane"}),(0,K.jsxs)("select",{value:d,onChange:e=>m(e.target.value),style:{width:"100%",padding:"0.4rem",fontSize:"0.8rem",border:`1px solid ${O.border}`,borderRadius:"4px",backgroundColor:O.inputBg,color:O.text,cursor:"pointer"},children:[(0,K.jsx)("option",{value:"hk0",children:"hk0 (l = 0)"}),(0,K.jsx)("option",{value:"h0l",children:"h0l (k = 0)"}),(0,K.jsx)("option",{value:"0kl",children:"0kl (h = 0)"})]})]}),(0,K.jsx)(ie.GK,{label:"Max index",value:f,onChange:e=>h(Math.round(e)),min:3,max:15,step:1,decimals:0,unit:"",theme:O}),"detector"===g&&(0,K.jsxs)(K.Fragment,{children:[(0,K.jsx)(ie.GK,{label:"Oscillation",value:b,onChange:y,min:.5,max:30,step:.5,decimals:1,unit:"\xb0",theme:O}),(0,K.jsx)(ie.GK,{label:"Detector dist.",value:v,onChange:C,min:50,max:300,step:10,decimals:0,unit:"mm",theme:O})]}),(0,K.jsx)(ie.jF,{label:"Show absences",checked:p,onChange:x,theme:O})]}),(0,K.jsxs)(ie.iV,{title:"Electron Density",defaultExpanded:!1,theme:O,children:[(0,K.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,K.jsx)("label",{style:{display:"block",fontSize:"0.75rem",color:O.textMuted,marginBottom:"0.25rem"},children:"Slice Axis"}),(0,K.jsx)("div",{style:{display:"flex",gap:"0.4rem"},children:["x","y","z"].map(e=>(0,K.jsx)("button",{onClick:()=>k(e),style:{flex:1,padding:"0.25rem",fontSize:"0.65rem",border:`1px solid ${O.border}`,borderRadius:"4px",backgroundColor:w===e?O.accent||"#2563eb":O.inputBg,color:w===e?"#fff":O.text,cursor:"pointer"},children:e},e))})]}),(0,K.jsx)(ie.GK,{label:`${w}-slice`,value:M,onChange:S,min:0,max:1,step:.01,decimals:2,unit:"",theme:O}),(0,K.jsxs)("div",{style:{display:"flex",gap:"0.4rem",marginBottom:"0.5rem"},children:[(0,K.jsx)("button",{onClick:()=>S(0),style:{flex:1,padding:"0.25rem",fontSize:"0.65rem",border:`1px solid ${O.border}`,borderRadius:"4px",backgroundColor:0===M?O.accent||"#2563eb":O.inputBg,color:0===M?"#fff":O.text,cursor:"pointer"},children:"0"}),(0,K.jsx)("button",{onClick:()=>S(.25),style:{flex:1,padding:"0.25rem",fontSize:"0.65rem",border:`1px solid ${O.border}`,borderRadius:"4px",backgroundColor:Math.abs(M-.25)<.01?O.accent||"#2563eb":O.inputBg,color:Math.abs(M-.25)<.01?"#fff":O.text,cursor:"pointer"},children:"\xbc"}),(0,K.jsx)("button",{onClick:()=>S(.5),style:{flex:1,padding:"0.25rem",fontSize:"0.65rem",border:`1px solid ${O.border}`,borderRadius:"4px",backgroundColor:Math.abs(M-.5)<.01?O.accent||"#2563eb":O.inputBg,color:Math.abs(M-.5)<.01?"#fff":O.text,cursor:"pointer"},children:"\xbd"})]}),(0,K.jsx)(ie.GK,{label:"Max HKL",value:R,onChange:e=>T(Math.round(e)),min:4,max:16,step:1,decimals:0,unit:"",theme:O}),(0,K.jsx)(ie.GK,{label:"Noise",value:D,onChange:F,min:0,max:1,step:.05,decimals:2,unit:"",theme:O}),(0,K.jsx)(ie.GK,{label:"B-factor",value:A,onChange:E,min:0,max:10,step:.5,decimals:1,unit:"\u0172",theme:O}),(0,K.jsxs)("div",{style:{marginTop:"0.5rem",padding:"0.4rem",backgroundColor:O.inputBg,borderRadius:"4px",fontSize:"0.65rem",color:O.textMuted},children:[(0,K.jsxs)("div",{children:[(0,K.jsx)("strong",{children:"Noise:"})," Adds random error to reflection intensities"]}),(0,K.jsxs)("div",{children:[(0,K.jsx)("strong",{children:"B-factor:"})," Thermal motion damping (Debye-Waller)"]})]})]}),(0,K.jsxs)(ie.iV,{title:"Display Options",defaultExpanded:!1,theme:O,children:[(0,K.jsx)(ie.jF,{label:"Show bonds",checked:P,onChange:I,theme:O}),(0,K.jsx)(ie.jF,{label:"Show axis labels",checked:L,onChange:B,theme:O}),(0,K.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,K.jsx)("label",{style:{display:"block",fontSize:"0.75rem",color:O.textMuted,marginBottom:"0.25rem"},children:"Supercell"}),(0,K.jsx)("div",{style:{display:"flex",gap:"0.4rem"},children:[1,2,3].map(e=>(0,K.jsxs)("button",{onClick:()=>W([e,e,e]),style:{flex:1,padding:"0.25rem",fontSize:"0.65rem",border:`1px solid ${O.border}`,borderRadius:"4px",backgroundColor:$[0]===e?O.accent||"#2563eb":O.inputBg,color:$[0]===e?"#fff":O.text,cursor:"pointer"},children:[e,"\xd7",e,"\xd7",e]},e))})]})]}),(0,K.jsxs)("div",{style:{marginTop:"1rem",padding:"0.5rem",backgroundColor:O.inputBg,borderRadius:"4px",fontSize:"0.7rem",color:O.textMuted},children:[(0,K.jsx)("strong",{children:"Tips:"}),(0,K.jsxs)("ul",{style:{margin:"0.3rem 0 0 1rem",padding:0},children:[(0,K.jsx)("li",{children:"Use tabs to switch between 3D/Density views"}),(0,K.jsx)("li",{children:"Click peaks in PXRD to highlight reflections"}),(0,K.jsx)("li",{children:"Empty circles show systematic absences"}),(0,K.jsx)("li",{children:"Adjust z-slice to scan electron density"})]})]})]});var de=n(7851),me=n(4922);function fe(e){const t=[[.267,.004,.329],[.282,.14,.457],[.254,.265,.529],[.206,.371,.553],[.163,.471,.558],[.128,.566,.55],[.135,.659,.517],[.267,.749,.44],[.478,.821,.318],[.741,.873,.15],[.993,.906,.144]],n=Math.min(Math.floor(10*e),9),o=10*e-n;return[t[n][0]+o*(t[n+1][0]-t[n][0]),t[n][1]+o*(t[n+1][1]-t[n][1]),t[n][2]+o*(t[n+1][2]-t[n][2])]}const he=(0,o.forwardRef)(({width:e,height:t,structure:n,pdbData:r,pdbUrl:i,xyzData:a,representation:s="ball+stick",colorScheme:l="element",showHydrogens:c=!0,showUnitCell:u=!0,showAxes:d=!1,supercell:m=[1,1,1],slicePlane:f,volumeGrid:h,autoRotate:p=!0,isDark:x,onCameraChange:g},b)=>{const y=(0,o.useRef)(null),v=(0,o.useRef)(null),C=(0,o.useRef)(null),M=(0,o.useRef)(null),S=(0,o.useRef)(null),w=(0,o.useRef)(null),k=(0,o.useRef)(null),R=(0,o.useRef)(null);(0,o.useImperativeHandle)(b,()=>({stage:v.current,getCameraState:()=>{const e=v.current;if(!e)return null;const t=e.viewer,n=t.camera,o=t.controls?.target||{x:0,y:0,z:0};return{position:[n.position.x,n.position.y,n.position.z],target:[o.x,o.y,o.z],up:[n.up.x,n.up.y,n.up.z],zoom:n.zoom}},setCameraState:e=>{const t=v.current;if(!t)return;const n=t.viewer;n.camera.position.set(...e.position),n.camera.up.set(...e.up),n.controls?.target&&n.controls.target.set(...e.target),n.camera.zoom=e.zoom,n.requestRender()}}));const T=(0,o.useCallback)(()=>x?"#2d2d2d":"#f8f9fa",[x]),_=(0,o.useCallback)(e=>{if(M.current&&(e.removeComponent(M.current),M.current=null),!u||!n)return;const{a:t,b:o=t,c:r=t}=n,[i,a,s]=m,l=t*i,c=o*a,d=r*s,f=new de.yp("unitcell"),h=x?[.5,.5,.5]:[.3,.3,.3],p=x?[.3,.3,.3]:[.6,.6,.6],g=[[0,0,0],[l,0,0],[l,c,0],[0,c,0],[0,0,d],[l,0,d],[l,c,d],[0,c,d]],b=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];for(const[n,u]of b)f.addWideline(g[n],g[u],h);if(i>1||a>1||s>1){for(let e=1;e<i;e++){const n=e*t;f.addWideline([n,0,0],[n,c,0],p),f.addWideline([n,0,d],[n,c,d],p),f.addWideline([n,0,0],[n,0,d],p),f.addWideline([n,c,0],[n,c,d],p)}for(let e=1;e<a;e++){const t=e*o;f.addWideline([0,t,0],[l,t,0],p),f.addWideline([0,t,d],[l,t,d],p),f.addWideline([0,t,0],[0,t,d],p),f.addWideline([l,t,0],[l,t,d],p)}for(let e=1;e<s;e++){const t=e*r;f.addWideline([0,0,t],[l,0,t],p),f.addWideline([0,c,t],[l,c,t],p),f.addWideline([0,0,t],[0,c,t],p),f.addWideline([l,0,t],[l,c,t],p)}}const y=e.addComponentFromObject(f);y&&(y.addRepresentation("buffer",{linewidth:3}),M.current=y)},[n,u,x,m]),j=(0,o.useCallback)(e=>{if(S.current&&(e.removeComponent(S.current),S.current=null),!d||!n)return;const{a:t,b:o=t,c:r=t}=n,i=new de.yp("axes"),a=-.5,s=.25*Math.max(t,o,r);i.addWideline([a,a,a],[a+s,a,a],[1,.3,.3]),i.addArrow([a+.8*s,a,a],[a+s,a,a],[1,.3,.3],.1),i.addWideline([a,a,a],[a,a+s,a],[.3,1,.3]),i.addArrow([a,a+.8*s,a],[a,a+s,a],[.3,1,.3],.1),i.addWideline([a,a,a],[a,a,a+s],[.3,.3,1]),i.addArrow([a,a,a+.8*s],[a,a,a+s],[.3,.3,1],.1);const l=e.addComponentFromObject(i);l&&(l.addRepresentation("buffer",{linewidth:4}),S.current=l)},[d,n]),D=(0,o.useCallback)(e=>{if(w.current&&(e.removeComponent(w.current),w.current=null),!f||!n)return;const{a:t,b:o=t,c:r=t}=n,i=new de.yp("sliceplane"),a=x?[.42,.62,1]:[.15,.39,.92];let s;switch(f.axis){case"x":{const e=f.position*t;s=[[e,0,0],[e,o,0],[e,o,r],[e,0,r]];break}case"y":{const e=f.position*o;s=[[0,e,0],[t,e,0],[t,e,r],[0,e,r]];break}default:{const e=f.position*r;s=[[0,0,e],[t,0,e],[t,o,e],[0,o,e]];break}}for(let n=0;n<4;n++){const e=(n+1)%4;i.addWideline(s[n],s[e],a)}for(const n of s)i.addSphere(n,a,.1);const l=e.addComponentFromObject(i);l&&(l.addRepresentation("buffer",{linewidth:5}),w.current=l)},[f,n,x]),F=(0,o.useCallback)(e=>{const t=e.viewer,o=t.scene;if(k.current&&(o.remove(k.current),k.current.geometry.dispose(),k.current.material.dispose(),k.current=null),R.current&&(R.current.dispose(),R.current=null),!f?.showTexture||!h||!n)return;const{a:r,b:i=r,c:a=r}=n,{data:s,dimensions:l}=h,[c,u,d]=l,{axis:m,position:p}=f;let x,g,b;if("z"===m){g=c,b=u;const e=Math.min(d-1,Math.max(0,Math.floor(p*d)));x=new Float32Array(c*u);for(let t=0;t<u;t++)for(let n=0;n<c;n++)x[t*c+n]=s[n+t*c+e*c*u]}else if("y"===m){g=c,b=d;const e=Math.min(u-1,Math.max(0,Math.floor(p*u)));x=new Float32Array(c*d);for(let t=0;t<d;t++)for(let n=0;n<c;n++)x[t*c+n]=s[n+e*c+t*c*u]}else{g=u,b=d;const e=Math.min(c-1,Math.max(0,Math.floor(p*c)));x=new Float32Array(u*d);for(let t=0;t<d;t++)for(let n=0;n<u;n++)x[t*u+n]=s[e+n*c+t*c*u]}let y=1/0,v=-1/0;for(let n=0;n<x.length;n++)y=Math.min(y,x[n]),v=Math.max(v,x[n]);const C=v-y||1,M=new Uint8Array(g*b*4);for(let n=0;n<x.length;n++){const e=(x[n]-y)/C,[t,o,r]=fe(e);M[4*n]=Math.floor(255*t),M[4*n+1]=Math.floor(255*o),M[4*n+2]=Math.floor(255*r),M[4*n+3]=200}const S=new me.GYF(M,g,b);let w,T;S.format=me.GWd,S.type=me.OUM,S.magFilter=me.k6q,S.minFilter=me.k6q,S.needsUpdate=!0,R.current=S,"z"===m?(w=r,T=i):"y"===m?(w=r,T=a):(w=i,T=a);const _=new me.bdM(w,T),j=new me.V9B({map:S,transparent:!0,side:me.$EB,depthWrite:!1}),D=new me.eaF(_,j);"z"===m?(D.rotation.x=-Math.PI/2,D.position.set(r/2,p*a,i/2)):"y"===m?(D.rotation.x=-Math.PI/2,D.rotation.z=-Math.PI/2,D.rotation.set(0,0,0),D.rotation.x=Math.PI/2,D.position.set(r/2,p*i,a/2)):(D.rotation.y=Math.PI/2,D.position.set(p*r,i/2,a/2)),o.add(D),k.current=D,t.requestRender()},[f,h,n]),A=(0,o.useCallback)(async e=>{const t=[];let o;e.eachComponent(e=>{"structure.pdb"!==e.name&&"structure"!==e.name||t.push(e)}),t.forEach(t=>{try{e.removeComponent(t)}catch(n){}}),C.current=null;let u={defaultRepresentation:!1,name:"structure"};if(i)o=i;else if(r){const e=new Blob([r],{type:"text/plain"});o=new File([e],"structure.pdb"),u.name="structure.pdb"}else if(a){const e=new Blob([a],{type:"text/plain"});o=new File([e],"structure.xyz"),u.ext="xyz"}else if(n){const e=function(e,t=[1,1,1]){const{a:n,b:o=n,c:r=n,atoms:i}=e,[a,s,l]=t,c=[],u=n*a,d=o*s,m=r*l;c.push(`CRYST1${u.toFixed(3).padStart(9)}${d.toFixed(3).padStart(9)}${m.toFixed(3).padStart(9)}  90.00  90.00  90.00 P 1           1`);let f=1;const h=[0,1];for(let p=0;p<a;p++)for(let e=0;e<s;e++)for(let t=0;t<l;t++)for(const u of i){const[i,d,m]=u.position;for(const x of h)for(const g of h)for(const b of h){const h=i+x,y=d+g,v=m+b;if(h>=0&&h<=1.001&&y>=0&&y<=1.001&&v>=0&&v<=1.001){const i=(p+h)*n,d=(e+y)*o,m=(t+v)*r,x=p<a-1&&Math.abs(h-1)<.001,g=e<s-1&&Math.abs(y-1)<.001,b=t<l-1&&Math.abs(v-1)<.001;if(x||g||b)continue;const C=u.element,M=1===C.length?` ${C}  `:`${C}  `.slice(0,4),S="ATOM  "+f.toString().padStart(5)+" "+M+" MOL A   1    "+i.toFixed(3).padStart(8)+d.toFixed(3).padStart(8)+m.toFixed(3).padStart(8)+"  1.00  0.00          "+C.padStart(2);c.push(S),f++}}}return c.push("END"),c.join("\n")}(n,m),t=new Blob([e],{type:"text/plain"});o=new File([t],"structure.pdb"),u.name="structure.pdb"}if(o)try{const t=await e.loadFile(o,u);C.current=t;const n={colorScheme:l};switch(c||(n.sele="not hydrogen"),s){case"spacefill":t.addRepresentation("spacefill",{...n,radiusScale:.4});break;case"licorice":t.addRepresentation("licorice",{...n,radiusScale:.3});break;case"line":t.addRepresentation("line",n);break;case"cartoon":t.addRepresentation("cartoon",n);break;default:t.addRepresentation("ball+stick",{...n,aspectRatio:2.5,bondScale:.3,radiusScale:.4})}e.autoView()}catch(d){console.error("Error loading structure:",d)}},[n,r,i,a,s,l,c,m]);return(0,o.useEffect)(()=>{if(!y.current)return;const e=new de.BI(y.current,{backgroundColor:T(),quality:"medium"});return v.current=e,e.setSpin(p),A(e),_(e),j(e),D(e),F(e),()=>{if(k.current){const t=e.viewer,n=t?.scene;n&&n.remove(k.current),k.current.geometry.dispose(),k.current.material.dispose(),k.current=null}R.current&&(R.current.dispose(),R.current=null),e.dispose(),v.current=null}},[]),(0,o.useEffect)(()=>{v.current&&(A(v.current),_(v.current))},[n,r,i,a,s,l,c,m,A,_]),(0,o.useEffect)(()=>{v.current&&_(v.current)},[u,_]),(0,o.useEffect)(()=>{v.current&&j(v.current)},[d,j]),(0,o.useEffect)(()=>{v.current&&D(v.current)},[f,D]),(0,o.useEffect)(()=>{v.current&&F(v.current)},[f,h,F]),(0,o.useEffect)(()=>{v.current&&(v.current.setParameters({backgroundColor:T()}),_(v.current),j(v.current),D(v.current))},[x,T,_,j,D]),(0,o.useEffect)(()=>{v.current&&v.current.setSpin(p)},[p]),(0,o.useEffect)(()=>{v.current&&v.current.handleResize()},[e,t]),(0,K.jsx)("div",{ref:y,style:{width:e,height:t,position:"absolute",top:0,left:0}})});he.displayName="NGLRenderer";var pe=n(9437);const xe=[];for(let _e=0;_e<256;_e++)xe.push([-1]);function ge(e){const t=[[.267,.004,.329],[.282,.14,.457],[.254,.265,.529],[.206,.371,.553],[.163,.471,.558],[.128,.566,.55],[.135,.659,.517],[.267,.749,.44],[.478,.821,.318],[.741,.873,.15],[.993,.906,.144]],n=Math.min(Math.floor(10*e),9),o=10*e-n;return[t[n][0]+o*(t[n+1][0]-t[n][0]),t[n][1]+o*(t[n+1][1]-t[n][1]),t[n][2]+o*(t[n+1][2]-t[n][2])]}const be=(0,o.forwardRef)(({width:e,height:t,volumeGrid:n,slicePlane:r,isosurface:i,renderMode:a="raymarching",isDark:s,latticeParams:l,onCameraChange:c},u)=>{const d=(0,o.useRef)(null),m=(0,o.useRef)(null),f=(0,o.useRef)(null),h=(0,o.useRef)(null),p=(0,o.useRef)(null),x=(0,o.useRef)(null),g=(0,o.useRef)(null),b=(0,o.useRef)(null),y=(0,o.useRef)(null),v=(0,o.useRef)(0),C=(0,o.useRef)(null);return(0,o.useImperativeHandle)(u,()=>({scene:f.current,camera:h.current,getCameraState:()=>{const e=h.current;return e?{position:[e.position.x,e.position.y,e.position.z],target:[0,0,0],up:[e.up.x,e.up.y,e.up.z],zoom:e.zoom}:null},setCameraState:e=>{C.current=e}})),(0,o.useEffect)(()=>{if(!d.current)return;const n=d.current,o=new pe.WebGLRenderer({antialias:!0,alpha:!0,premultipliedAlpha:!1});o.setSize(e,t),o.setPixelRatio(Math.min(window.devicePixelRatio,2)),o.setClearColor(0,0),n.appendChild(o.domElement),m.current=o;const r=new me.Z58;f.current=r;const i=new me.$p8(16777215,.4);r.add(i);const a=new me.ZyN(16777215,.8);a.position.set(5,5,5),r.add(a);const s=new me.ubm(45,e/t,.1,100);s.position.set(3,2,3),s.lookAt(0,0,0),h.current=s;const l=()=>{if(v.current=requestAnimationFrame(l),C.current){const e=C.current;s.position.set(...e.position),s.up.set(...e.up),s.lookAt(...e.target),s.zoom=e.zoom,s.updateProjectionMatrix()}o.render(r,s)};return l(),()=>{cancelAnimationFrame(v.current),o.dispose(),n.contains(o.domElement)&&n.removeChild(o.domElement)}},[e,t]),(0,o.useEffect)(()=>{if(!f.current||!n)return;const e=f.current;x.current&&(e.remove(x.current),x.current.geometry&&x.current.geometry.dispose(),x.current=null),p.current&&(p.current.dispose(),p.current=null),g.current&&(g.current.dispose(),g.current=null);const{data:t,dimensions:o}=n,[r,l,c]=o,u=new me.Q1f(s?"#6b9eff":"#2563eb");if("raymarching"===a){const n=new me.dYF(t,r,l,c);n.format=me.VT0,n.type=me.RQf,n.minFilter=me.k6q,n.magFilter=me.k6q,n.wrapS=me.ghU,n.wrapT=me.ghU,n.wrapR=me.ghU,n.needsUpdate=!0,g.current=n;let o=1/0,a=-1/0;for(let e=0;e<t.length;e++)o=Math.min(o,t[e]),a=Math.max(a,t[e]);const s=i?.value??.5,d=new me.BKk({uniforms:{uVolume:{value:n},uIsoLevel:{value:s},uMinDensity:{value:o},uMaxDensity:{value:a},uColor:{value:u},uOpacity:{value:i?.opacity??.9}},vertexShader:"\nvarying vec3 vOrigin;\nvarying vec3 vDirection;\n\nvoid main() {\n    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n    vOrigin = cameraPosition;\n    vDirection = position - cameraPosition;\n    gl_Position = projectionMatrix * mvPosition;\n}\n",fragmentShader:"\nprecision highp float;\nprecision highp sampler3D;\n\nuniform sampler3D uVolume;\nuniform float uIsoLevel;\nuniform float uMinDensity;\nuniform float uMaxDensity;\nuniform vec3 uColor;\nuniform float uOpacity;\n\nvarying vec3 vOrigin;\nvarying vec3 vDirection;\n\nvec2 hitBox(vec3 orig, vec3 dir) {\n    vec3 boxMin = vec3(-1.0);\n    vec3 boxMax = vec3(1.0);\n    vec3 invDir = 1.0 / dir;\n    vec3 tmin0 = (boxMin - orig) * invDir;\n    vec3 tmax0 = (boxMax - orig) * invDir;\n    vec3 tmin = min(tmin0, tmax0);\n    vec3 tmax = max(tmin0, tmax0);\n    float t0 = max(max(tmin.x, tmin.y), tmin.z);\n    float t1 = min(min(tmax.x, tmax.y), tmax.z);\n    return vec2(t0, t1);\n}\n\nfloat sampleDensity(vec3 p) {\n    vec3 uv = p * 0.5 + 0.5;\n    return texture(uVolume, uv).r;\n}\n\nvec3 calcNormal(vec3 p) {\n    float eps = 0.01;\n    float d = sampleDensity(p);\n    return normalize(vec3(\n        sampleDensity(p + vec3(eps, 0, 0)) - d,\n        sampleDensity(p + vec3(0, eps, 0)) - d,\n        sampleDensity(p + vec3(0, 0, eps)) - d\n    ));\n}\n\nvoid main() {\n    vec3 rayDir = normalize(vDirection);\n    vec2 bounds = hitBox(vOrigin, rayDir);\n\n    if (bounds.x > bounds.y) {\n        discard;\n    }\n\n    bounds.x = max(bounds.x, 0.0);\n    float isoThreshold = uIsoLevel;\n\n    float t = bounds.x;\n    float dt = 0.02;\n    vec3 hitPos = vec3(0.0);\n    bool hit = false;\n    float prevDensity = 0.0;\n\n    for (int i = 0; i < 200; i++) {\n        if (t > bounds.y) break;\n\n        vec3 p = vOrigin + rayDir * t;\n        float density = sampleDensity(p);\n\n        if (i > 0 && ((prevDensity < isoThreshold && density >= isoThreshold) ||\n                      (prevDensity > isoThreshold && density <= isoThreshold))) {\n            float tPrev = t - dt;\n            for (int j = 0; j < 4; j++) {\n                float tMid = (tPrev + t) * 0.5;\n                vec3 pMid = vOrigin + rayDir * tMid;\n                float dMid = sampleDensity(pMid);\n                if ((prevDensity < isoThreshold) == (dMid < isoThreshold)) {\n                    tPrev = tMid;\n                    prevDensity = dMid;\n                } else {\n                    t = tMid;\n                    density = dMid;\n                }\n            }\n            hitPos = vOrigin + rayDir * t;\n            hit = true;\n            break;\n        }\n\n        prevDensity = density;\n        t += dt;\n    }\n\n    if (!hit) {\n        discard;\n    }\n\n    vec3 normal = calcNormal(hitPos);\n    vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));\n    float diff = max(dot(normal, lightDir), 0.0) * 0.6 + 0.4;\n    float rim = 1.0 - abs(dot(normal, -rayDir));\n    rim = pow(rim, 2.0) * 0.3;\n\n    vec3 color = uColor * diff + vec3(1.0) * rim;\n    gl_FragColor = vec4(color, uOpacity);\n}\n",side:me.hsX,transparent:!0,depthWrite:!1});p.current=d;const m=new me.iNn(2,2,2),f=new me.eaF(m,d);e.add(f),x.current=f}},[n,a,i,s]),(0,o.useEffect)(()=>{p.current&&"uniforms"in p.current&&i&&(p.current.uniforms.uIsoLevel.value=i.value)},[i?.value]),(0,o.useEffect)(()=>{if(!f.current)return;const e=f.current;if(b.current&&(e.remove(b.current),b.current.geometry&&b.current.geometry.dispose(),b.current.material&&b.current.material.dispose(),b.current=null),y.current&&(y.current.dispose(),y.current=null),!r||!n||!r.showTexture)return;const{data:t,dimensions:o}=n,[i,a,s]=o,{axis:c,position:u,colorScale:d="viridis"}=r;let m,h,p;if("z"===c){h=i,p=a;const e=Math.floor(u*(s-1));m=new Float32Array(i*a);for(let n=0;n<a;n++)for(let o=0;o<i;o++)m[n*i+o]=t[o+n*i+e*i*a]}else if("y"===c){h=i,p=s;const e=Math.floor(u*(a-1));m=new Float32Array(i*s);for(let n=0;n<s;n++)for(let o=0;o<i;o++)m[n*i+o]=t[o+e*i+n*i*a]}else{h=a,p=s;const e=Math.floor(u*(i-1));m=new Float32Array(a*s);for(let n=0;n<s;n++)for(let o=0;o<a;o++)m[n*a+o]=t[e+o*i+n*i*a]}let x=1/0,g=-1/0;for(let n=0;n<m.length;n++)x=Math.min(x,m[n]),g=Math.max(g,m[n]);const v=g-x||1,C=new Uint8Array(h*p*4);for(let n=0;n<m.length;n++){const e=(m[n]-x)/v,[t,o,r]=ge(e);C[4*n]=Math.floor(255*t),C[4*n+1]=Math.floor(255*o),C[4*n+2]=Math.floor(255*r),C[4*n+3]=220}const M=new me.GYF(C,h,p);M.format=me.GWd,M.type=me.OUM,M.needsUpdate=!0,y.current=M;const S=l?.a??1,w=l?.b??S,k=l?.c??S;let R,T;"z"===c?(R=S,T=w):"y"===c?(R=S,T=k):(R=w,T=k);const _=new me.bdM(R,T),j=new me.V9B({map:M,transparent:!0,side:me.$EB,depthWrite:!1}),D=new me.eaF(_,j);"z"===c?(D.rotation.x=-Math.PI/2,D.position.set(S/2,w/2,u*k)):"y"===c?D.position.set(S/2,u*w,k/2):(D.rotation.y=Math.PI/2,D.position.set(u*S,w/2,k/2)),e.add(D),b.current=D},[r,n,l]),(0,o.useEffect)(()=>{m.current&&h.current&&(m.current.setSize(e,t),h.current.aspect=e/t,h.current.updateProjectionMatrix())},[e,t]),(0,K.jsx)("div",{ref:d,style:{width:e,height:t,position:"absolute",top:0,left:0,pointerEvents:"none"}})});be.displayName="VolumeRenderer";const ye=({width:e,height:t,pdbUrl:n,pdbData:r,structure:i,xyzData:a,cubeUrl:s,cubeData:l,volumeGrid:c,representation:u="ball+stick",colorScheme:d="element",showHydrogens:m=!0,opacity:f,showUnitCell:h=!0,showAxes:p=!1,supercell:x,isosurface:g,slicePlane:b,trajectory:y,autoRotate:v=!0,onAtomClick:C,onAtomHover:M,theme:S})=>{const w=(0,o.useRef)(null),k=(0,o.useRef)(null),R=(0,o.useRef)(null),T=(0,o.useRef)(null),_=S.text.startsWith("#e")||S.text.startsWith("#f"),j=!!(n||r||i||a),D=!!(s||l||c),F=(0,o.useCallback)(()=>{if(!k.current||!R.current)return;const e=k.current.getCameraState();e&&R.current.setCameraState(e)},[]);return(0,o.useEffect)(()=>(j&&D&&(T.current=window.setInterval(F,16)),()=>{T.current&&(clearInterval(T.current),T.current=null)}),[j,D,F]),(0,K.jsxs)("div",{ref:w,style:{width:e,height:t,position:"relative",borderRadius:"4px",border:`1px solid ${S.border}`,overflow:"hidden",background:_?"#2d2d2d":"#f8f9fa"},children:[j&&(0,K.jsx)(he,{ref:k,width:e,height:t,structure:i,pdbData:r,pdbUrl:n,xyzData:a,representation:u,colorScheme:d,showHydrogens:m,showUnitCell:h,showAxes:p,supercell:x,slicePlane:b,volumeGrid:c,autoRotate:v,isDark:_}),D&&(0,K.jsx)(be,{ref:R,width:e,height:t,volumeGrid:c,slicePlane:b,isosurface:g,isDark:_,latticeParams:i?{a:i.a,b:i.b??i.a,c:i.c??i.a}:void 0}),i&&(0,K.jsx)("div",{style:{position:"absolute",top:6,left:8,color:S.text,fontSize:"10px",fontWeight:"bold",pointerEvents:"none",zIndex:10},children:i.name}),b&&(0,K.jsxs)("div",{style:{position:"absolute",bottom:6,left:8,color:_?"#6b9eff":"#2563eb",fontSize:"9px",pointerEvents:"none",zIndex:10},children:[b.axis," = ",b.position.toFixed(2)]}),(0,K.jsx)("div",{style:{position:"absolute",bottom:6,right:8,color:S.textMuted,fontSize:"9px",pointerEvents:"none",zIndex:10},children:"Drag to rotate"})]})};var ve=n(706);const Ce={H:[.489918,20.6593,.262003,7.74039,.196767,49.5519,.049879,2.20159,.001305],C:[2.31,20.8439,1.02,10.2075,1.5886,.5687,.865,51.6512,.2156],N:[12.2126,.0057,3.1322,9.8933,2.0125,28.9975,1.1663,.5826,-11.529],O:[3.0485,13.2771,2.2868,5.7011,1.5463,.3239,.867,32.9089,.2508],Na:[4.7626,3.285,3.1736,8.8422,1.2674,.3136,1.1128,129.424,.676],Cl:[11.4604,.0104,7.1964,1.1662,6.2556,18.5194,1.6455,47.7784,-9.5574],Si:[6.2915,2.4386,3.0353,32.3337,1.9891,.6785,1.541,81.6937,1.1407],Fe:[11.7695,4.7611,7.3573,.3072,3.5222,15.3535,2.3045,76.8805,1.0369],Ca:[8.6266,10.4421,7.3873,.6599,1.5899,85.7484,1.0211,178.437,1.3751],Ti:[9.7595,7.8508,7.3558,.5,1.6991,35.6338,1.9021,116.105,1.2807],Cs:[20.3892,3.569,19.1062,.3107,10.662,24.3879,1.4953,213.904,3.3352],Ba:[20.1807,3.21,19.1136,.2855,10.9054,20.0558,.7763,51.746,3.029],K:[8.2186,12.7949,7.4398,.7748,1.0519,213.187,.8659,41.6841,1.4228],I:[20.1472,4.347,18.9949,.3814,7.5138,27.766,2.2735,66.8776,4.0712]};function Me(e,t=8){const n=Ce[e]||Ce.C,o=[];for(let r=0;r<t;r++){const e=r/(t-1)*1.5,i=e*e;let a=n[8];for(let t=0;t<4;t++)a+=n[2*t]*Math.exp(-n[2*t+1]*i);o.push({s:e,f:a})}return o}function Se(e){const[t,n]=(0,o.useState)({width:400,height:400});return(0,o.useLayoutEffect)(()=>{const t=()=>{if(e.current){const t=e.current.getBoundingClientRect();n({width:Math.max(200,Math.floor(t.width)),height:Math.max(200,Math.floor(t.height))})}};t();const o=new ResizeObserver(t);return e.current&&o.observe(e.current),()=>o.disconnect()},[e]),t}const we=({className:e})=>{const{colorMode:t}=(0,i.G)(),n="dark"===t,r=(0,o.useMemo)(()=>({background:n?"#2d2d2d":"#f8f9fa",surface:n?"#3d3d3d":"#ffffff",border:n?"#555":"#e0e0e0",text:n?"#e0e0e0":"#333",textMuted:n?"#999":"#666",accent:n?"#6b9eff":"#2563eb",inputBg:n?"#4a4a4a":"#f3f4f6"}),[n]),[a,P]=(0,o.useState)("NaCl"),[z,I]=(0,o.useState)(N),[L,B]=(0,o.useState)(140),[U,q]=(0,o.useState)(.8),[Q,Z]=(0,o.useState)(!0),[J,ee]=(0,o.useState)("hk0"),[te,ne]=(0,o.useState)(8),[oe,ie]=(0,o.useState)(!0),[ae,se]=(0,o.useState)(5),[ce,de]=(0,o.useState)(100),[me,fe]=(0,o.useState)(0),[he,pe]=(0,o.useState)("z"),[xe,ge]=(0,o.useState)(64),[be,Ce]=(0,o.useState)(!0),[we,ke]=(0,o.useState)(0),[Re,Te]=(0,o.useState)(1.5),[_e,je]=(0,o.useState)("magnitude"),[De,Fe]=(0,o.useState)(!0),[Ae,Ee]=(0,o.useState)(!0),[Pe,Ne]=(0,o.useState)(!0),[ze,Ie]=(0,o.useState)([1,1,1]),[Le,Be]=(0,o.useState)(null),[$e,We]=(0,o.useState)({}),[Ue,Ge]=(0,o.useState)("density"),[Oe,He]=(0,o.useState)("lattice"),Xe=(0,o.useRef)(null),qe=(0,o.useRef)(null),Ke=Se(Xe),Ve=Se(qe),Ye=(0,o.useMemo)(()=>le[a]||le.NaCl,[a]);(0,o.useEffect)(()=>{const e=[...new Set(Ye.atoms.map(e=>e.element))];We(t=>{const n={...t};for(const o of e)n[o]||(n[o]=Me(o));return n})},[Ye]);const Qe=(0,o.useMemo)(()=>function(e){const{wavelength:t,structure:n,maxHKL:o,twoThetaMax:r=180,bFactor:i=0}=e,a=[],s=new Set;for(let c=0;c<=o;c++)for(let e=0;e<=c;e++)for(let o=0;o<=e;o++){if(0===c&&0===e&&0===o)continue;if(!H(c,e,o,n))continue;const l=$(c,e,o,n),u=W(l,t);if(isNaN(u)||u>r)continue;const d=l.toFixed(6);if(s.has(d))continue;s.add(d);const m=O(c,e,o,n,t,i),f=G(m);if(f<.001)continue;const h=X(c,e,o);a.push({h:c,k:e,l:o,dSpacing:l,twoTheta:u,intensity:f*h,structureFactor:m,multiplicity:h})}a.sort((e,t)=>e.twoTheta-t.twoTheta);const l=Math.max(...a.map(e=>e.intensity));if(l>0)for(const c of a)c.intensity=c.intensity/l*100;return a}({wavelength:z,structure:Ye,maxHKL:te,twoThetaMax:L,bFactor:Re}),[z,Ye,te,L,Re]),Ze=(0,o.useMemo)(()=>{if(0===we)return Qe;return Qe.map((e,t)=>{const n=Math.sqrt(e.intensity)*we*.5,o=2*((e=>{const t=43758.5453*Math.sin(12.9898*e+78.233);return t-Math.floor(t)})(1e3*t+1e4*we)-.5),r=Math.max(0,e.intensity+o*n);return{...e,intensity:r}})},[Qe,we]),Je=Math.min(Ke.width-16,Ke.height-16),et=Math.min(Ke.width-16,Ke.height-16),tt=Ve.width-16,nt=Ve.height-16;return(0,K.jsxs)("div",{className:`${s} ${e||""}`,children:[(0,K.jsx)("h2",{className:l,children:"X-ray Diffraction Simulator"}),(0,K.jsxs)("div",{className:c,children:[(0,K.jsxs)("div",{className:u,children:[(0,K.jsxs)("div",{className:f,children:[(0,K.jsx)("h3",{className:h,children:"Real Space"}),(0,K.jsxs)("div",{className:p,children:[(0,K.jsx)("button",{className:`${x} ${"3d"===Ue?g:""}`,onClick:()=>Ge("3d"),children:"3D"}),(0,K.jsx)("button",{className:`${x} ${"density"===Ue?g:""}`,onClick:()=>Ge("density"),children:"Density"})]})]}),(0,K.jsx)("div",{className:b,ref:Xe,children:(0,K.jsx)("div",{className:y,children:"3d"===Ue?Je>100&&(0,K.jsx)(ye,{width:Je,height:Je,structure:Ye,representation:Ae?"ball+stick":"spacefill",showUnitCell:!0,showAxes:Pe,supercell:ze,autoRotate:!0,theme:r}):et>100&&(0,K.jsx)(re,{width:et,height:et,structure:Ye,wavelength:z,slicePosition:me,sliceAxis:he,resolution:xe,showContours:be,maxHKL:te,theme:r,formFactors:$e,bFactor:Re,noise:we,displayMode:_e,showAtoms:De})})}),"density"===Ue&&(0,K.jsxs)("div",{className:v,children:[(0,K.jsxs)("span",{className:C,children:[he,"-slice:"]}),(0,K.jsx)("input",{type:"range",className:M,min:0,max:1,step:.01,value:me,onChange:e=>fe(parseFloat(e.target.value))}),(0,K.jsx)("span",{className:S,children:me.toFixed(2)}),(0,K.jsxs)("div",{className:w,children:[(0,K.jsx)("button",{className:`${k} ${0===me?R:""}`,onClick:()=>fe(0),children:"0"}),(0,K.jsx)("button",{className:`${k} ${Math.abs(me-.25)<.01?R:""}`,onClick:()=>fe(.25),children:"1/4"}),(0,K.jsx)("button",{className:`${k} ${Math.abs(me-.5)<.01?R:""}`,onClick:()=>fe(.5),children:"1/2"})]}),(0,K.jsxs)("div",{className:T,children:[(0,K.jsx)("button",{className:`${k} ${"magnitude"===_e?R:""}`,onClick:()=>je("magnitude"),title:"Show |\u03c1|",children:"|\u03c1|"}),(0,K.jsx)("button",{className:`${k} ${"signed"===_e?R:""}`,onClick:()=>je("signed"),title:"Show \u03c1 (signed)",children:"\xb1\u03c1"})]}),(0,K.jsx)("div",{className:T,children:(0,K.jsx)("button",{className:`${k} ${De?R:""}`,onClick:()=>Fe(!De),title:"Show atom positions",children:"Atoms"})})]})]}),(0,K.jsxs)("div",{className:d,children:[(0,K.jsxs)("div",{className:f,children:[(0,K.jsx)("h3",{className:h,children:"Reciprocal Space"}),(0,K.jsxs)("div",{className:p,children:[(0,K.jsx)("button",{className:`${x} ${"lattice"===Oe?g:""}`,onClick:()=>He("lattice"),children:"Lattice"}),(0,K.jsx)("button",{className:`${x} ${"detector"===Oe?g:""}`,onClick:()=>He("detector"),children:"Detector"}),(0,K.jsx)("button",{className:`${x} ${"pxrd"===Oe?g:""}`,onClick:()=>He("pxrd"),children:"PXRD"})]})]}),(0,K.jsx)("div",{className:b,ref:qe,children:"pxrd"===Oe?(0,K.jsx)(V,{width:tt,height:nt,reflections:Ze,wavelength:z,peakWidth:U,showLabels:Q,twoThetaRange:[5,L],selectedReflection:Le,onSelectReflection:Be,theme:r}):(0,K.jsx)(Y,{width:tt,height:nt,structure:Ye,reflections:Ze,plane:J,maxIndex:te,showAbsences:oe,selectedReflection:Le,onSelectReflection:Be,theme:r,viewMode:"detector"===Oe?"detector":"reciprocal",wavelength:z,oscillationRange:ae,detectorDistance:ce,twoThetaMax:L,bFactor:Re})})]}),(0,K.jsx)("div",{className:m,children:(0,K.jsx)(ue,{structureId:a,onStructureChange:P,structure:Ye,wavelength:z,onWavelengthChange:I,twoThetaMax:L,onTwoThetaMaxChange:B,peakWidth:U,onPeakWidthChange:q,showPeakLabels:Q,onShowPeakLabelsChange:Z,reciprocalPlane:J,onReciprocalPlaneChange:ee,maxIndex:te,onMaxIndexChange:ne,showAbsences:oe,onShowAbsencesChange:ie,reciprocalView:Oe,oscillationRange:ae,onOscillationRangeChange:se,detectorDistance:ce,onDetectorDistanceChange:de,slicePosition:me,onSlicePositionChange:fe,sliceAxis:he,onSliceAxisChange:pe,densityResolution:xe,onDensityResolutionChange:ge,showContours:be,onShowContoursChange:Ce,noise:we,onNoiseChange:ke,bFactor:Re,onBFactorChange:Te,showBonds:Ae,onShowBondsChange:Ee,showLabels:Pe,onShowLabelsChange:Ne,supercell:ze,onSupercellChange:Ie,formFactors:$e,onFormFactorsChange:We,theme:r})})]}),(0,K.jsxs)("div",{className:_,children:[(0,K.jsx)("h3",{className:j,children:"X-ray Diffraction and Crystal Structure"}),(0,K.jsx)("p",{className:D,children:"X-ray diffraction reveals the atomic arrangement in crystals through the interference of scattered X-rays. This simulation shows the relationship between real-space structure, reciprocal space, and the resulting diffraction pattern."}),(0,K.jsx)("h4",{children:"Key equations:"}),(0,K.jsxs)("ul",{className:F,children:[(0,K.jsxs)("li",{className:A,children:[(0,K.jsx)("strong",{children:"Bragg's Law:"})," ",(0,K.jsx)(ve.A,{math:"n\\lambda = 2d\\sin\\theta",inline:!0})," "," determines which angles produce diffraction peaks"]}),(0,K.jsxs)("li",{className:A,children:[(0,K.jsx)("strong",{children:"d-spacing (cubic):"})," ",(0,K.jsx)(ve.A,{math:"d_{hkl} = \\frac{a}{\\sqrt{h^2 + k^2 + l^2}}",inline:!0})]}),(0,K.jsxs)("li",{className:A,children:[(0,K.jsx)("strong",{children:"Structure factor:"})," ",(0,K.jsx)(ve.A,{math:"F_{hkl} = \\sum_j f_j \\exp[2\\pi i(hx_j + ky_j + lz_j)]",inline:!0})]})]}),(0,K.jsx)("h4",{children:"Systematic absences:"}),(0,K.jsxs)("p",{className:D,children:["Some reflections are forbidden due to crystal symmetry. For FCC lattices (like NaCl), reflections are only allowed when h, k, l are all odd or all even. These ",(0,K.jsx)("em",{children:"systematic absences"})," are shown as crossed circles in the reciprocal lattice view."]}),(0,K.jsxs)("div",{className:E,children:[(0,K.jsx)("strong",{children:"Try it:"})," Compare NaCl (FCC) with CsCl (simple cubic) to see different systematic absence patterns. Use the Density tab to see electron density at different z-planes through the unit cell."]})]})]})},ke=e=>(0,K.jsx)(a.A,{fallback:(0,K.jsx)("div",{children:"Loading visualization..."}),children:()=>(0,K.jsx)(we,{...e})});var Re=n(9256);function Te(){return(0,K.jsx)(r.A,{title:"X-ray Diffraction Simulator",description:"Interactive visualization of X-ray diffraction patterns and crystal structures",children:(0,K.jsx)("main",{className:Re.A.mainContainerWide,children:(0,K.jsx)("div",{className:Re.A.visualizationContainerFull,children:(0,K.jsx)(ke,{})})})})}},8371:(e,t,n)=>{n.d(t,{iV:()=>a,GK:()=>i,jF:()=>s});var o=n(6540),r=n(4848);const i=({label:e,value:t,onChange:n,min:i,max:a,step:s,unit:l="",decimals:c=2,theme:u,disabled:d=!1})=>{const[m,f]=(0,o.useState)(t.toFixed(c)),[h,p]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{h||f(t.toFixed(c))},[t,c,h]),(0,r.jsxs)("div",{style:{marginBottom:"0.6rem",opacity:d?.5:1},children:[(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.25rem"},children:[(0,r.jsx)("span",{style:{fontSize:"0.8rem",color:u.text},children:e}),(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.25rem"},children:[(0,r.jsx)("input",{type:"text",value:h?m:t.toFixed(c),onChange:e=>{f(e.target.value)},onFocus:()=>p(!0),onBlur:()=>{p(!1);const e=parseFloat(m);if(isNaN(e))f(t.toFixed(c));else{const t=Math.max(i,Math.min(a,e));n(t),f(t.toFixed(c))}},onKeyDown:e=>{"Enter"===e.key&&e.target.blur()},disabled:d,style:{width:"4rem",padding:"0.15rem 0.3rem",fontSize:"0.75rem",fontFamily:"monospace",textAlign:"right",border:`1px solid ${u.border}`,borderRadius:"3px",backgroundColor:u.inputBg,color:u.text}}),l&&(0,r.jsx)("span",{style:{fontSize:"0.7rem",color:u.textMuted,minWidth:"1.5rem"},children:l})]})]}),(0,r.jsx)("input",{type:"range",min:i,max:a,step:s,value:t,onChange:e=>{const t=parseFloat(e.target.value);n(t),f(t.toFixed(c))},disabled:d,style:{width:"100%",height:"4px",borderRadius:"2px",cursor:d?"not-allowed":"pointer"}})]})},a=({title:e,children:t,defaultExpanded:n=!1,theme:i})=>{const[a,s]=(0,o.useState)(n);return(0,r.jsxs)("div",{style:{marginBottom:"0.75rem"},children:[(0,r.jsxs)("button",{onClick:()=>s(!a),style:{width:"100%",padding:"0.5rem 0.6rem",border:`1px solid ${i.border}`,borderRadius:"4px",backgroundColor:i.surface||i.inputBg,color:i.text,fontSize:"0.8rem",fontWeight:500,cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center",textAlign:"left"},children:[(0,r.jsx)("span",{children:e}),(0,r.jsx)("span",{style:{transform:a?"rotate(180deg)":"none",transition:"transform 0.2s ease",fontSize:"0.7rem"},children:"\u25bc"})]}),(0,r.jsx)("div",{style:{maxHeight:a?"500px":"0",overflow:"hidden",transition:"max-height 0.2s ease-out"},children:(0,r.jsx)("div",{style:{marginTop:"0.5rem",padding:"0.6rem",backgroundColor:i.surface||i.inputBg,borderRadius:"4px",border:`1px solid ${i.border}`},children:t})})]})},s=({label:e,checked:t,onChange:n,theme:o,disabled:i=!1})=>(0,r.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:i?"not-allowed":"pointer",fontSize:"0.8rem",color:o.text,marginBottom:"0.4rem",opacity:i?.5:1},children:[(0,r.jsxs)("div",{style:{position:"relative",width:"36px",height:"20px",backgroundColor:t?o.accent||"#2563eb":o.border,borderRadius:"10px",transition:"background-color 0.2s ease"},children:[(0,r.jsx)("div",{style:{position:"absolute",top:"2px",left:t?"18px":"2px",width:"16px",height:"16px",backgroundColor:"#fff",borderRadius:"50%",transition:"left 0.2s ease",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}}),(0,r.jsx)("input",{type:"checkbox",checked:t,onChange:e=>n(e.target.checked),disabled:i,style:{position:"absolute",opacity:0,width:"100%",height:"100%",cursor:i?"not-allowed":"pointer",margin:0}})]}),(0,r.jsx)("span",{children:e})]})},8478:(e,t,n)=>{n.d(t,{A:()=>i});n(6540);var o=n(2303),r=n(4848);function i({children:e,fallback:t}){return(0,o.A)()?(0,r.jsx)(r.Fragment,{children:e?.()}):t??null}},9256:(e,t,n)=>{n.d(t,{A:()=>o});const o={mainContainer:"mainContainer_ToYM",mainContainerWide:"mainContainerWide_qCJt",header:"header_Crl1",toggleButtons:"toggleButtons_HfWQ",toggleButton:"toggleButton_XP4b",activeButton:"activeButton_U0kg",visualizationContainer:"visualizationContainer_EYJL",visualizationContainerFull:"visualizationContainerFull_udEd",visualization:"visualization_ziEY",visualizationWide:"visualizationWide_uXaJ",centeredVisualization:"centeredVisualization_l8sE",explanation:"explanation_RvX9"}}}]);